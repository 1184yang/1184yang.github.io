<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.9.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=EB Garamond:300,300italic,400,400italic,700,700italic|Cinzel Decorative:300,300italic,400,400italic,700,700italic|Noto Serif TC:300,300italic,400,400italic,700,700italic|Source Code Pro:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"1184yang.github.io","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12,"onmobile":true},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content=".NET Core 支援依賴注入(Dependency Injection, DI)的設計模式，這是一種用於在類(Class)及其依賴項之間實現控制反轉（IoC）的技術。 依賴項注入允許從類的外部注入依賴項，因此注入依賴項的類只需要知道一個協定(通常是 C# 介面，Interface)。這個類可以遵守這個介面的協議而獨立於其物件的創建。 依賴注入並不一定需要依賴注入容器(Dependency In">
<meta property="og:type" content="article">
<meta property="og:title" content="C# 教育訓練 .NET core 依賴注入 (Dependency Injection)">
<meta property="og:url" content="https://1184yang.github.io/2020/04/24/Dotnet-core-DI/index.html">
<meta property="og:site_name">
<meta property="og:description" content=".NET Core 支援依賴注入(Dependency Injection, DI)的設計模式，這是一種用於在類(Class)及其依賴項之間實現控制反轉（IoC）的技術。 依賴項注入允許從類的外部注入依賴項，因此注入依賴項的類只需要知道一個協定(通常是 C# 介面，Interface)。這個類可以遵守這個介面的協議而獨立於其物件的創建。 依賴注入並不一定需要依賴注入容器(Dependency In">
<meta property="og:locale" content="zh-TW">
<meta property="og:image" content="https://1184yang.github.io/2020/04/24/Dotnet-core-DI/dotnet-di-113328.png">
<meta property="og:updated_time" content="2020-07-17T08:46:15.956Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="C# 教育訓練 .NET core 依賴注入 (Dependency Injection)">
<meta name="twitter:description" content=".NET Core 支援依賴注入(Dependency Injection, DI)的設計模式，這是一種用於在類(Class)及其依賴項之間實現控制反轉（IoC）的技術。 依賴項注入允許從類的外部注入依賴項，因此注入依賴項的類只需要知道一個協定(通常是 C# 介面，Interface)。這個類可以遵守這個介面的協議而獨立於其物件的創建。 依賴注入並不一定需要依賴注入容器(Dependency In">
<meta name="twitter:image" content="https://1184yang.github.io/2020/04/24/Dotnet-core-DI/dotnet-di-113328.png">

<link rel="canonical" href="https://1184yang.github.io/2020/04/24/Dotnet-core-DI/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-TW'
  };
</script>

  <title>C# 教育訓練 .NET core 依賴注入 (Dependency Injection) | </title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切換導航欄">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title"></h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首頁</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>歸檔</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分類</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜尋
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜尋..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

  <a href="https://github.com/1184yang?tab=repositories" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://1184yang.github.io/2020/04/24/Dotnet-core-DI/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/1184yang.jpg">
      <meta itemprop="name" content="J.Y. Yang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          C# 教育訓練 .NET core 依賴注入 (Dependency Injection)
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2020-04-24 10:37:37" itemprop="dateCreated datePublished" datetime="2020-04-24T10:37:37+08:00">2020-04-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2020-07-17 16:46:15" itemprop="dateModified" datetime="2020-07-17T16:46:15+08:00">2020-07-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/C/" itemprop="url" rel="index"><span itemprop="name">C#</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>.NET Core 支援依賴注入(Dependency Injection, DI)的設計模式，這是一種用於在類(Class)及其依賴項之間實現控制反轉（IoC）的技術。</p>
<p>依賴項注入允許從類的外部注入依賴項，因此注入依賴項的類只需要知道一個協定(通常是 C# 介面，Interface)。這個類可以遵守這個介面的協議而獨立於其物件的創建。</p>
<p>依賴注入並不一定需要依賴注入容器(Dependency Injection Container)，但使用容器有助於管理依賴項。當依賴注入容器管理的服務列表越來越長時，就可以看到容器的優點。ASP.NET Core 和 Entity Framework Core 使用 Microsoft.Extensions.DependencyInjection 作為容器來管理所有的依賴項，以此管理數百個服務。所以王智民老師才會特別講解依賴注入。</p>
<p>儘管依賴注入和依賴注入容器在非常小的應用程序中會增加複雜性，但是一旦應用程序變得更大，需要多個服務，依賴注入就會顯示它的效益，降低應用程序的複雜性，並促進非緊密綁定的實現(鬆散耦合)。</p>
<p>到此，觀念還是很抽象，這裡就從一個<strong>不使用依賴注入</strong>的小應用程式開始；隨後將它轉換為使用依賴注入並使用注入依賴容器的應用程序。</p>
<h3 id="使用沒有依賴注入的服務"><a href="#使用沒有依賴注入的服務" class="headerlink" title="使用沒有依賴注入的服務"></a>使用沒有依賴注入的服務</h3><p>開啟 VS Code，首先建立一個 .NET Core Console 專案</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ dotnet new console --name MyDI</span><br></pre></td></tr></table></figure>

<p>使用 VS Code 切換到新建立的 .NET Core 專案目錄 MyDI。開啟一個終端螢幕輸入 <strong>dotnet run</strong> 測試一下。我們就可以開始了。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ dotnet run</span><br><span class="line">Hello World!</span><br></pre></td></tr></table></figure>

<p>先在專案目錄下開兩個子目錄 Services 與 Controllers 分別擺放不同功能型態的程式碼。在 Services 下建立 GreetingService.cs，在 Controllers 下是 HomeController.cs。 程式碼都很短，不要用複製貼上，自己 Coding，享受一下 Coding 的樂趣。</p>
<img src="/2020/04/24/Dotnet-core-DI/dotnet-di-113328.png" title="MyDI 專案目錄">

<p>這個 GreetingService 類定義了返回字符串的 Greet 方法。</p>
<figure class="highlight csharp"><figcaption><span>Services/GreetingService.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">MyDI.Services</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">GreetingService</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">string</span> <span class="title">Greet</span>(<span class="params"><span class="keyword">string</span> name</span>)</span> =&gt; <span class="string">$"Hello Tainan, 哈囉，<span class="subst">&#123;name&#125;</span>"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>HomeController 類使用了這個 GreetingService 服務。</p>
<figure class="highlight csharp"><figcaption><span>Controllers/HomeController.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> MyDI.Services;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">MyDI.Controllers</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">HomeController</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">string</span> <span class="title">Hello</span>(<span class="params"><span class="keyword">string</span> name</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">var</span> service = <span class="keyword">new</span> GreetingService();</span><br><span class="line">            <span class="keyword">return</span> service.Greet(name); </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>現在看看 Program 類的 Main( ) 方法。</p>
<figure class="highlight csharp"><figcaption><span>Program.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> MyDI.Controllers;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">MyDI</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="keyword">string</span>[] args</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">var</span> controller = <span class="keyword">new</span> HomeController();</span><br><span class="line">            <span class="keyword">string</span> result = controller.Hello(<span class="string">"Emily"</span>);</span><br><span class="line">            Console.WriteLine(result);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>現在跑跑看。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ dotnet run</span><br><span class="line"></span><br><span class="line">Hello Tainan, 哈囉，Emily</span><br></pre></td></tr></table></figure>

<p>這有甚麼問題嗎? HomeController 與 GreetingService 是緊密耦合的。要用不同的實現取代 HomeController 中的 GreetingService 並不容易。</p>
<p>現在用另一個 SayHelloService 服務來取代原先的 GreetingService 看看會需要動到哪些程式碼。</p>
<p>在目錄 Services 下建立 SayHelloService 類，這裡用 SayHello 方法返回一個字符串。</p>
<figure class="highlight csharp"><figcaption><span>Services/SayHelloService.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">MyDI.Services</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SayHelloService</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">string</span> <span class="title">SayHello</span>(<span class="params"><span class="keyword">string</span> name</span>)</span> =&gt; <span class="string">$"Say 哈囉，<span class="subst">&#123;name&#125;</span>, Hello Tainan!"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>要用 SayHelloService 取代 GreetingService 現在必需要直接修改 HomeController。</p>
<figure class="highlight csharp"><figcaption><span>Controllers/HomeController.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> MyDI.Services;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">MyDI.Controllers</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">HomeController</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">string</span> <span class="title">Hello</span>(<span class="params"><span class="keyword">string</span> name</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">var</span> service = <span class="keyword">new</span> SayHelloService();</span><br><span class="line">            <span class="keyword">return</span> service.SayHello(name); </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>這裡修改了第 9 與 10 行，改使用 SayHelloService 服務。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ dotnet run</span><br><span class="line"></span><br><span class="line">Say 哈囉，Emily, Hello Tainan!</span><br></pre></td></tr></table></figure>

<p>在這個簡單的例子中看起來也還好，並不是很複雜。 但這裡的服務都只是返回字符串的簡單服務，一般的應用程序通常更複雜，要修改的也更多，有些還會有一些相互的牽扯，最怕的是有些還不知道藏在哪裡，要等到出問題才會知道。現在改用依賴注入，看看會有甚麼不同。</p>
<h3 id="使用依賴注入"><a href="#使用依賴注入" class="headerlink" title="使用依賴注入"></a>使用依賴注入</h3><p>現在要讓 HomeController 獨立於 GreetingService 與 SayHelloService 的實現，當要變更服務時，不用再直接修改 HomeController 類。為此，我們必須訂立一個協定，讓這些服務遵守，這裡要用一個 IGreetingService 介面(Interface)來定義 HomeController 所需要的功能，IGreetingService 介面就是一個協定。在專案目錄下建一個子目錄 Interfaces 擺放介面程式碼 IGreetingService.cs  </p>
<figure class="highlight csharp"><figcaption><span>Interfaces/IGreetingService.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">MyDI.Interfaces</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IGreetingService</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">string</span> <span class="title">Greet</span>(<span class="params"><span class="keyword">string</span> name</span>)</span>; </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在這個 IGreetingService 介面中，目前只有一個協議 Greet 方法。現在 GreetingService 與 SayHelloService 都必須遵守這個協定，也就是都要實現這個 Greet 方法。</p>
<figure class="highlight csharp"><figcaption><span>Services/GreetingService.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> MyDI.Interfaces;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">MyDI.Services</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">GreetingService</span> : <span class="title">IGreetingService</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">string</span> <span class="title">Greet</span>(<span class="params"><span class="keyword">string</span> name</span>)</span> =&gt; <span class="string">$"Hello Tainan, 哈囉，<span class="subst">&#123;name&#125;</span>"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight csharp"><figcaption><span>Services/SayHelloService.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> MyDI.Interfaces;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">MyDI.Services</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SayHelloService</span> : <span class="title">IGreetingService</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">string</span> <span class="title">Greet</span>(<span class="params"><span class="keyword">string</span> name</span>)</span> =&gt; <span class="string">$"Say 哈囉，<span class="subst">&#123;name&#125;</span>, Hello Tainan!"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">string</span> <span class="title">SayHello</span>(<span class="params"><span class="keyword">string</span> name</span>)</span> =&gt; <span class="string">$"Say 哈囉，<span class="subst">&#123;name&#125;</span>, Hello Tainan!"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>SayHelloService 原先並沒有 Greet 方法，因此必須實作，這裡將舊的 SayHello( ) 方法留著，萬一有人使用了緊密耦合。</p>
<p>HomeController 現在只需要對一個物件的引用，該物件會實現介面 IGreetingService 中的所有協議。這個物件會用 HomeController 的建構式函式(Constructor)注入，分配給私有字段(private filed)，通過方法 Hello 來使用。</p>
<figure class="highlight csharp"><figcaption><span>Controllers/HomeController.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> MyDI.Interfaces;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">MyDI.Controllers</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">HomeController</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> IGreetingService _greetingService;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">HomeController</span>(<span class="params">IGreetingService greetingService</span>)</span> &#123;</span><br><span class="line">            _greetingService = greetingService ?? <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(greetingService));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">string</span> <span class="title">Hello</span>(<span class="params"><span class="keyword">string</span> name</span>)</span> =&gt; _greetingService.Greet(name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第 10 行是 HomeController 的建構函式，參數型態是 IGreetingService 介面，因此只要能實現 IGreetingService 介面的物件都可以由此注入。HomeController 則透過 Hello 方法來使用這個注入物件的 Greet 方法。　</p>
<p>在這個實現中，HomeController 類利用了控制反轉(Inversion of Control, IoC)的設計原理。HomeController 並沒有像以前那樣直接實例化 GreetingService 或 SayHelloService。相反的，定義由 HomeController 使用具體類的控件從外部注入，也就是透過 HomeController 的建構函式從外部注入。換句話說，控制是反轉的。HomeController 不能直接決定自己要用哪個服務，而是由外界決定 HomeController 該用哪個服務。反轉控制也被稱為好萊塢原則：不要給我們打電話，我們會給你打電話(don’t call us, we’ll call you)。</p>
<p>HomeController 類並沒有依賴 IGreetingService 介面的具體實作，而是可以使用實現了介面 IGreetingService 的任何類。所以這裡可以使用 GreetingService 與 SayHelloService 類，因這兩個類都具體實作了 IGreetingService 介面。</p>
<p>現在，需要從外部注入依賴項，將具體的實現傳遞給 HomeController 類的建構函式。</p>
<figure class="highlight csharp"><figcaption><span>Program.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> MyDI.Controllers;</span><br><span class="line"><span class="keyword">using</span> MyDI.Services;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">MyDI</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="keyword">string</span>[] args</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">var</span> controller = <span class="keyword">new</span> HomeController(<span class="keyword">new</span> GreetingService());</span><br><span class="line">            <span class="keyword">string</span> result = controller.Hello(<span class="string">"Emily"</span>);</span><br><span class="line">            Console.WriteLine(result);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>第 11 行使用建構函式注入的依賴注入模式實現了控制反轉的設計原則。這稱為建構函式注入，因為介面是在建構函式中注入的。所以這裡需要注入一個依賴項物件來創建一個 HomeController 實例。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ dotnet run</span><br><span class="line"></span><br><span class="line">Hello Tainan, 哈囉，Emily</span><br></pre></td></tr></table></figure>

<p>現在注入不同的服務，更改第 11 行注入不同的依賴項:</p>
<figure class="highlight csharp"><figcaption><span>Program.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">            <span class="keyword">var</span> controller = <span class="keyword">new</span> HomeController(<span class="keyword">new</span> SayHelloService());</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ dotnet run</span><br><span class="line"></span><br><span class="line">Say 哈囉，Emily, Hello Tainan!</span><br></pre></td></tr></table></figure>

<p>到此，我們已完成了依賴注入的改寫。這個範例程序非常小，唯一需要注入的是一個實現協定 IGreetingService 介面的類。 這個類在實例化的同時實例化了 HomeController。</p>
<p>到目前為止我們已經實現了依賴注入，但還沒有使用容器來管理這些依賴項。在實際應用程序中，需要處理許多介面與實現，還需要共享實例，最好的方法還是使用依賴注入容器來管理所有的依賴項。</p>
<h3 id="使用-NET-Core-DI-容器"><a href="#使用-NET-Core-DI-容器" class="headerlink" title="使用 .NET Core DI 容器"></a>使用 .NET Core DI 容器</h3><p>依賴注入不一定需要使用依賴注入容器，但容器有助於管理依賴項，這裡要使用 Microsoft.Extensions.DependencyInjection 作為容器來管理所有依賴項。</p>
<p>首先需要安裝 Microsoft.Extensions.DependencyInjection。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ dotnet add package Microsoft.Extensions.DependencyInjection</span><br></pre></td></tr></table></figure>

<p>在依賴注入容器中，可以在應用程式中有一個位置，在其中定義甚麼協定(介面 Interface)映射到哪個特定的實現(具體的類 Class)上。還可以指定是應該將服務作為一個單例(Singleton)來使用，還是應該在每次使用時創建一個新實例(Transient)。</p>
<p>首先在 Program 類中定義 RegisterService 方法。在這裡，實例化一個新的 ServiceCollection 物件，ServiceCollection 就在 Microsoft.Extensions.DependencyInjection 名稱空間中，使用 ServiceCollection 的擴展方法 AddSingleton 與 AddTransient 來註冊 DI 容器需要知道的類型，範例中我們將 GreetingService 與 HomeController 都註冊在容器中，這樣允許從容器中檢索 HomeController。</p>
<p>當請求 IGreetingService 介面時，會實例化 GreetingService 類。HomeController 本身沒有實現介面。通過這個 DI 容器配置，當請求 HomeController 時，DI 容器會時例化 HomeController。</p>
<p>DI 容器配置還定義了服務的生命週期，使用 AddSingleton 與 AddTransient 方法指定服務的生命週期信息。對於 GreetingService，使用 AddSingleton 註冊，因此請求 IGreetingService 時總是返回相同的實例。這和 HomeController 不同， HomeControler，使用 AddTransient 註冊，每次請求檢索 HomeController 時，則都會創建一個新的實例。</p>
<figure class="highlight csharp"><figcaption><span>Program.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Extensions.DependencyInjection;</span><br><span class="line"><span class="keyword">using</span> MyDI.Controllers;</span><br><span class="line"><span class="keyword">using</span> MyDI.Services;</span><br><span class="line"><span class="keyword">using</span> MyDI.Interfaces;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">MyDI</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="keyword">string</span>[] args</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">using</span> (ServiceProvider container = RegisterServices())</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> controller = container.GetRequiredService&lt;HomeController&gt;();</span><br><span class="line">                <span class="keyword">string</span> result = controller.Hello(<span class="string">"Emily"</span>);</span><br><span class="line">                Console.WriteLine(result);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">static</span> ServiceProvider <span class="title">RegisterServices</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">            <span class="keyword">var</span> services = <span class="keyword">new</span> ServiceCollection();</span><br><span class="line">            services.AddSingleton&lt;IGreetingService, GreetingService&gt;();</span><br><span class="line">            services.AddTransient&lt;HomeController&gt;();</span><br><span class="line">            <span class="keyword">return</span> services.BuildServiceProvider();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第 21 行新增靜態方法 RegisterService( )。<br>第 23、24 行註冊 GreetingService 與 HomeController。<br>第 25 行調用 BuildServiceProvider，這會返回一個 ServiceProvider 物件，該物件可以用來訪問已註冊的服務。</p>
<p>再來要修改 Main 方法來調用 RegisterService 方法以便在容器中註冊。</p>
<p>第 13 行允許直接訪問 ServiceProvider 的 Dispose 方法，所以這裡使用 using 語句。<br>第 15 行調用 ServiceProvider 的 GetRequiredService 方法來取得對 HomeController 實例的引用。</p>
<p>啟動應用程序時，在 GetRequiredService 方法的請求下，DI 容器將創建 HomeController 類的實例。HomeController 的建構函式需要一個實現 IGreetingService 的物件。這個介面 IGreetingService 也有在容器中註冊，在此它會返回 GreetingService 物件。GreetingService 類有一個預設的建構函式，因此容器可以創建一個實例，並將該實例傳遞給 HomeController 的建構函式。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ dotnet run</span><br><span class="line"></span><br><span class="line">Hello Tainan, 哈囉，Emily</span><br></pre></td></tr></table></figure>

<p>現在改註冊另外一個 SayHelloService 服務。</p>
<figure class="highlight csharp"><figcaption><span>Program.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> ...</span><br><span class="line"> <span class="function"><span class="keyword">static</span> ServiceProvider <span class="title">RegisterServices</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">     <span class="keyword">var</span> services = <span class="keyword">new</span> ServiceCollection();</span><br><span class="line">     <span class="comment">// services.AddSingleton&lt;IGreetingService, GreetingService&gt;();</span></span><br><span class="line">     services.AddSingleton&lt;IGreetingService, SayHelloService&gt;();</span><br><span class="line">     services.AddTransient&lt;HomeController&gt;();</span><br><span class="line">     <span class="keyword">return</span> services.BuildServiceProvider();</span><br><span class="line"> &#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ dotnet run</span><br><span class="line"></span><br><span class="line">Say 哈囉，Emily, Hello Tainan!</span><br></pre></td></tr></table></figure>

<p>如果同時註冊 GreetingService 與 SayHelloService 那又會如何? 如果多次將相同的介面協議添加到服務集合(ServiceCollection)中，最後一個註冊的介面協議就會從容器中獲得介面。</p>
<h3 id="ASP-NET-Core-Startup"><a href="#ASP-NET-Core-Startup" class="headerlink" title="ASP.NET Core Startup"></a>ASP.NET Core Startup</h3><p>ASP.NET Core 提供內建服務容器 IServiceProvider。服務會在應用程式的 Startup.ConfigureServices 方法中註冊。</p>
<p>ASP.NET Core 的應用程式啟動使用 Startup 類別，其依慣例命名為 Startup。 Startup 類別可設定服務和應用程式的要求管線。</p>
<p>Startup 類別選擇性地包含 ConfigureServices 方法來設定應用程式的服務，服務透過依賴項注入 (DI)，在應用中使用 ConfigureServices 來註冊和使用。 </p>
<p>另外 Startup 類也包含 Configure 方法來建立應用程式的要求處理管線(Pipeline，Middlewares)。</p>
<p>瞭解了依賴注入 (Dependency Injection) 與依賴注入容器，應該可以更理解王智民老師的教育訓練課程中的有關 MVC 控制器內依賴注入。</p>
<p>祝，Coding 快樂!</p>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/04/17/Train0416-with-C/" rel="prev" title="C# 教育訓練 using Visual Studio Code">
      <i class="fa fa-chevron-left"></i> C# 教育訓練 using Visual Studio Code
    </a></div>
      <div class="post-nav-item">
    <a href="/2020/05/08/Electron-React-Quickstart/" rel="next" title="桌面應用 Electron React Quickstart">
      桌面應用 Electron React Quickstart <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目錄
        </li>
        <li class="sidebar-nav-overview">
          本站概要
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#使用沒有依賴注入的服務"><span class="nav-number">1.</span> <span class="nav-text">使用沒有依賴注入的服務</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用依賴注入"><span class="nav-number">2.</span> <span class="nav-text">使用依賴注入</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用-NET-Core-DI-容器"><span class="nav-number">3.</span> <span class="nav-text">使用 .NET Core DI 容器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ASP-NET-Core-Startup"><span class="nav-number">4.</span> <span class="nav-text">ASP.NET Core Startup</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="J.Y. Yang"
      src="/images/1184yang.jpg">
  <p class="site-author-name" itemprop="name">J.Y. Yang</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">63</span>
          <span class="site-state-item-name">文章</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">分類</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/1184yang" title="GitHub → https://github.com/1184yang" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:1184yang@gmail.com" title="E-Mail → mailto:1184yang@gmail.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/1184yang" title="Twitter → https://twitter.com/1184yang" rel="noopener" target="_blank"><i class="fa fa-fw fa-twitter"></i>Twitter</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">J.Y. Yang</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/muse.js"></script>
<script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script>



  




  <script src="/js/local-search.js"></script>












  

  

</body>
</html>
