<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  

  
  <title></title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title">
<meta property="og:url" content="https://1184yang.github.io/page/2/index.html">
<meta property="og:site_name">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title">
  
    <link rel="alternate" href="/atom.xml" title type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo"></a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://1184yang.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-GraphQL-API-7" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/12/05/GraphQL-API-7/" class="article-date">
  <time datetime="2019-12-04T23:02:29.000Z" itemprop="datePublished">2019-12-05</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/GraphQL/">GraphQL</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/12/05/GraphQL-API-7/">建立 GraphQL API (7)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="分頁-Pagination"><a href="#分頁-Pagination" class="headerlink" title="分頁 Pagination"></a>分頁 Pagination</h3><p>使用 GraphQL，幾乎可以肯定會遇到一個含有項目列表 (lists of items) 的應用程序，稱為分頁 (Pagination) 功能。 </p>
<p>在應用程序中存儲的用戶照片會變成很長的列表，並且當用戶端應用程序請求顯示照片時，立即從資料庫中檢索所有照片可能會導致嚴重的性能瓶頸。分頁允許您將項目列表拆分為多個列表，稱為頁面 (pages)。 通常用限制 (limit) 和偏移量 (offset) 定義頁面。 這樣，您可以以項目頁面 (one page of items) 進行請求，而當用戶希望查看更多項目時，可以請求另一頁項目。</p>
<p>有兩種不同的分頁方法可在 GraphQL 中實現分頁。 第一種方法是較簡單的方法，稱為 Offset/Limit-based Pagination 的分頁方法。 另一種進階的方法是 Cursor-based pagination 的分頁方法，這是在應用程序中允許分頁比較複雜的方法之一。</p>
<h4 id="Offset-Limit-Pagination"><a href="#Offset-Limit-Pagination" class="headerlink" title="Offset/Limit Pagination"></a>Offset/Limit Pagination</h4><p>Offset/Limit-based pagination 並不是很難實現。 <em>limit</em> 說明您要從整個列表中檢索多少個項目，<em>offset</em> 則說明要從整個列表中開始的位置。 使用不同的偏移量 (offset) ，可以在整個項目列表中移動並檢索具有限制 (limit) 數量的子列表（頁面）。</p>
<p>看起來似乎很簡單，但這也需要資料庫端的實作，以下是 PostgreSQL SQL:</p>
<figure class="highlight sql"><figcaption><span>PostgreSQL</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">db01=&gt; select empno, ename from emp</span><br><span class="line">db01-&gt; order by empno;</span><br><span class="line"> empno | ename</span><br><span class="line"><span class="comment">-------+--------</span></span><br><span class="line">  7369 | SMITH</span><br><span class="line">  7499 | ALLEN</span><br><span class="line">  7566 | 楊瑞珉</span><br><span class="line">  7607 | バック</span><br><span class="line">  7608 | 馬小九</span><br><span class="line">  7609 | 蔡大一</span><br><span class="line">  7654 | 葉習堃</span><br><span class="line">  7698 | BLAKE</span><br><span class="line">  7782 | 楊瑞</span><br><span class="line">  7788 | SCOTT</span><br><span class="line">  7839 | KING</span><br><span class="line">  7844 | 하찮고</span><br><span class="line">  7876 | ADAMS</span><br><span class="line">  7900 | JAMES</span><br><span class="line">  7902 | FORD</span><br><span class="line">  7934 | 楊喆</span><br><span class="line">  8907 | 牸祢</span><br><span class="line">  9006 | 林羿君</span><br><span class="line">  9011 | 文英蔡</span><br></pre></td></tr></table></figure>

<p>加上 offset 與 limit，注意這裡的 order by 是必須的。offset 是從哪個位置開始，limit 則是限制筆數。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">db01=&gt; select empno, ename from emp</span><br><span class="line">db01-&gt; order by empno</span><br><span class="line">db01-&gt; offset 5 limit 5;</span><br><span class="line"> empno | ename</span><br><span class="line">-------+--------</span><br><span class="line">  7609 | 蔡大一</span><br><span class="line">  7654 | 葉習堃</span><br><span class="line">  7698 | BLAKE</span><br><span class="line">  7782 | 楊瑞</span><br><span class="line">  7788 | SCOTT</span><br><span class="line">(5 rows)</span><br></pre></td></tr></table></figure>

<p>PostgreSQL 一直都有支援 SQL 分頁功能，Oracle 則直到 Oracle 12c 才有支援，在 12c 之前則需使用一些技巧。如果未來是以 Web App 為策略，則 Oracle Database 升級要盡早規畫。以下在 YK11 的 SQL: </p>
<figure class="highlight sql"><figcaption><span>Oracle</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">YK11&gt; select empno, ename from apexdemo.emp</span><br><span class="line">  2  order by empno;</span><br><span class="line"></span><br><span class="line">     EMPNO ENAME</span><br><span class="line"><span class="comment">---------- ------------------------------</span></span><br><span class="line">      7369 史密斯</span><br><span class="line">      7499 ALLEN</span><br><span class="line">      7521 WARD</span><br><span class="line">      7566 JONES</span><br><span class="line">      7654 馬丁</span><br><span class="line">      7698 布萊克</span><br><span class="line">      7782 楊瑞</span><br><span class="line">      7788 SCOTT</span><br><span class="line">      7839 KING</span><br><span class="line">      7844 TURNER</span><br><span class="line">      7876 ADAMS</span><br><span class="line">      7900 楊瑞</span><br><span class="line">      7902 福特</span><br><span class="line">      7934 米勒</span><br><span class="line"></span><br><span class="line">14 rows selected.</span><br></pre></td></tr></table></figure>

<p>Oracle 的 limit 有一些不同:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">YK11&gt; select empno, ename from apexdemo.emp</span><br><span class="line">  2  order by empno</span><br><span class="line">  3  offset 5 rows fetch next 5 rows only;</span><br><span class="line"></span><br><span class="line">     EMPNO ENAME</span><br><span class="line">---------- ------------------------------</span><br><span class="line">      7698 布萊克</span><br><span class="line">      7782 楊瑞</span><br><span class="line">      7788 SCOTT</span><br><span class="line">      7839 KING</span><br><span class="line">      7844 TURNER</span><br></pre></td></tr></table></figure>

<p>有了資料庫端的配合，GraphQL 就可以加入分頁的功能，例如:</p>
<figure class="highlight javascript"><figcaption><span>Pagination Example</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="built_in">module</span>.exports = gql<span class="string">`</span></span><br><span class="line"><span class="string">  extend type Query &#123;</span></span><br><span class="line"><span class="string">    totalPhotos: Int!</span></span><br><span class="line"><span class="string">    allPhotos(offset: Int, limit: Int): [Photo!]!</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">  ...</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure>

<p>即使這種方法比較簡單，它也有一些缺點。當偏移量變得很大時，資料庫查詢將花費更長的時間，這可能會導致 UI 等待下一頁數據時客戶端性能下降。 另外，Offset/Limit-based pagination 無法處理兩次查詢之間的已刪除項目。例如，如果您查詢某一頁並且有其他人刪除了你已查詢過的某個項目，則下一頁上的偏移量將是錯誤的，因為該項目的數量減少了一個。 使用 Offset/Limit-based pagination 無法輕鬆克服此問題，這就是為什麼可能需要 Cursor-based pagination 的原因。</p>
<h4 id="Cursor-based-Pagination"><a href="#Cursor-based-Pagination" class="headerlink" title="Cursor-based Pagination"></a>Cursor-based Pagination</h4><p>在 Cursor-based pagination 分頁中，offset 被一個稱為 <strong>cursor</strong> 的標識符所取代，而不像 Offset/Limit pagination 的項目進行計數。Cursor 可以用來表示 “從 Cursor Y 開始給我 limit 個項目的列表”。 所以 cursor 儲存的是一個欄位的值，用來取代 offset，當要求下一個分頁時使用 cursor 當為起使值，你可以使用 Primary Key，或使用日期（例如，資料庫中某個項目的創建日期）來標識列表中項目，這都是常用的方法。這裡要注意，資料庫 SQL 返回的資料不能保證其順序，所以 <strong>order by</strong> 通常都是必須的。</p>
<p>在我們的例子，照片的 ID 是按時間建立的，所以就使用它當成 cursor 的值。如果你的 ID 是使用 uuid 亂碼產生的，你則需要新增一個例如 createdAt 的時間欄位當作是 cursor 的值。在資料庫中記得加個 index 在 createdAt 欄位上。</p>
<p>這裡不管使用 ID 或 createdAt，有一個重要的特性，<strong>兩個欄位的值都不會改變</strong>，所以 cursor 具有穩定的位置，不像 offset 的不定性，有可能會有不同的起始值。</p>
<p>GraphQL 伺服器以標準化的方式公開它的連接 (Connections)。 在查詢中，連接模型 (connection model) 提供了用於對結果集進行切片和分頁的標準機制。 在響應回應中，連接模型提供了一種提供 cursor 的標準方法，以及一種在出現更多結果時告訴客戶端的方法。</p>
<p>連接模型有一些規範讓我們可以遵循，細節可以參考 <a href="https://facebook.github.io/relay/graphql/connections.htm" target="_blank" rel="noopener">Relay Cursor Connections Specification</a>，裡面有詳盡的介紹。</p>
<p>這裡我們要來新增一個可以有分頁功能的照片清單。首先我們看一下資料庫模組抽象層程式，如何用來支援前端的分頁功能。</p>
<figure class="highlight javascript"><figcaption><span>models/database.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">Database.prototype.findAll = <span class="function"><span class="keyword">function</span>(<span class="params"> opts = &#123;&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> options = &#123; ...opts &#125;;</span><br><span class="line">    <span class="keyword">let</span> _this = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">let</span> results = [];</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      _this._db</span><br><span class="line">        .createValueStream( options )</span><br><span class="line">        .on(<span class="string">"data"</span>, value =&gt; results.push(value))</span><br><span class="line">        .on(<span class="string">"end"</span>, () =&gt; resolve(results))</span><br><span class="line">        .on(<span class="string">"error"</span>, err =&gt; reject(err));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">      reject(err);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>findAll( ) 函式我們預留了可選擇性參數的物件 opts，在第 9 行呼叫時會使用到此選擇性參數物件，這個選擇性參數物件可以包含以下的特性:</p>
<blockquote>
<ul>
<li>gt（大於），gte（大於或等於）：定義資料流傳輸範圍的下限。 此範圍內僅包含鍵 (Key) 大於（或等於）此選項的項目。 當 reverse = true 時，順序將顛倒，但 stream 傳輸的項目將相同。</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>lt（小於），lte（小於或等於）：定義資料流傳輸範圍的上限。 該範圍內僅包含鍵小於（或等於）此選項的項目。 當 reverse = true 時，順序將顛倒，但資料流傳輸的項目將相同。</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>reverse (boolean, default: false)：以相反的順序讀取資料流項目。 注意，由於像 LevelDB 這樣的存儲方式，反向搜索可能比正向搜索要慢。</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>limit（number，default：-1）：限制此資料流的項目數。 此數字代表最大項目數，如果您先到達範圍末尾，則返回的項目可能少於 limit 數。 值 -1 表示沒有限制。 當 reverse = true 時，將返回具有最高鍵的項目，而不是最低鍵。</li>
</ul>
</blockquote>
<p>我們可修改原來的 Query Schema 的 allPhotos，但是我們先保留它，以免這裡出了問題無法回復，尤其如果是線上系統，可能會造成問題。所以我們要新增一個新的 Query Schema，這樣可以較無壓力的轉換。在 schema 子目錄下新增 photoConnection.js :</p>
<figure class="highlight javascript"><figcaption><span>schema/photoConnection.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; gql &#125; = <span class="built_in">require</span>(<span class="string">"apollo-server-express"</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = gql<span class="string">`</span></span><br><span class="line"><span class="string">  extend type Query &#123;</span></span><br><span class="line"><span class="string">    allPhotosWithPagination(</span></span><br><span class="line"><span class="string">      after: String</span></span><br><span class="line"><span class="string">      first: Int</span></span><br><span class="line"><span class="string">      before: String</span></span><br><span class="line"><span class="string">      last: Int</span></span><br><span class="line"><span class="string">    ): PhotoConnection!</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  type PhotoConnection &#123;</span></span><br><span class="line"><span class="string">    pageInfo: PageInfo!</span></span><br><span class="line"><span class="string">    edges: [PhotoEdge!]!</span></span><br><span class="line"><span class="string">    totalCount: Int</span></span><br><span class="line"><span class="string">    photos: [Photo!]!</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  type PageInfo &#123;</span></span><br><span class="line"><span class="string">    hasNextPage: Boolean!</span></span><br><span class="line"><span class="string">    hasPreviousPage: Boolean!</span></span><br><span class="line"><span class="string">    startCursor: String</span></span><br><span class="line"><span class="string">    endCursor: String</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  type PhotoEdge &#123;</span></span><br><span class="line"><span class="string">    node: Photo!</span></span><br><span class="line"><span class="string">    cursor: String!</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">`</span>;</span><br></pre></td></tr></table></figure>

<p>這裡的 Query allPhotosWithPagination 提供了 4 個參數 after、first、before 與 last。</p>
<ul>
<li>after 與 first 是一對的，支援下一頁的功能。</li>
<li>before 與 last 是一對的，支援上一頁的功能。</li>
</ul>
<p>因此 first 與 last 不能同時用。而它會返回一個 Connection 模型物件 PhotoConnection。</p>
<p>Connection 模型中一個分頁稱為一個 Connection，對於 Connection 返回的資料有一些規範，一定要包含某些特性，需要包含:</p>
<ul>
<li>pageInfo: <ul>
<li>startCursor</li>
<li>endCursor</li>
<li>hasPreviousPage</li>
<li>hasNextPage</li>
</ul>
</li>
<li>edges : 這是一個陣列，包含所返回的項目，也就是目前這一頁(Connection)的項目。<ul>
<li>node : 實際返回的資料項目，這裡就是實際照片的資料。</li>
<li>cursor : cursor 的值，在這個例子就是照片的 ID key 值，通常會做 base64 編譯，這樣對資料隱匿性比較好，也比較不容易讓前端誤會資料的用途。</li>
</ul>
</li>
</ul>
<p>除了規範的特性，你也可加入任何的資訊，這裡我們加入了 totalCount 與 photos。totalCount 是資料庫中照片的總數，photos 的資料與 edges 中的 node 相同，如果你不需要分頁功能則可以直接使用這個 photos 即可。</p>
<p>將它併接到 schema/index.js</p>
<figure class="highlight javascript"><figcaption><span>schema/index.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">const</span> photoConnectionSchema = <span class="built_in">require</span>(<span class="string">'./photoConnection'</span>);</span><br><span class="line">...</span><br><span class="line"><span class="built_in">module</span>.exports = [linkSchema, userSchema, photoSchema, photoConnectionSchema, subscriptionSchema];</span><br></pre></td></tr></table></figure>

<p>再來我們要實作 allPhotosWithPagination 的解析函式，這是分頁功能複雜的地方:</p>
<figure class="highlight javascript"><figcaption><span>resolvers/photoConnection.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> toCursorHash = <span class="function"><span class="params">string</span> =&gt;</span> Buffer.from(string).toString(<span class="string">'base64'</span>);</span><br><span class="line"><span class="keyword">const</span> fromCursorHash = <span class="function"><span class="params">string</span> =&gt;</span> Buffer.from(string, <span class="string">'base64'</span>).toString(<span class="string">'ascii'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  Query: &#123;</span><br><span class="line">    allPhotosWithPagination: <span class="keyword">async</span> (parent, &#123; after, first, before, last &#125;, &#123; <span class="attr">db</span>: &#123; photos &#125; &#125;) =&gt; &#123;</span><br><span class="line">      <span class="keyword">let</span> result, allCount, unlimitedCount;</span><br><span class="line">      <span class="keyword">const</span> opts = &#123;&#125;;</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> after === <span class="string">'string'</span> &amp;&amp; <span class="keyword">typeof</span> before === <span class="string">'string'</span> ) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'after and before cannot use same time'</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> first === <span class="string">'number'</span> &amp;&amp; <span class="keyword">typeof</span> last === <span class="string">'number'</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'first and last cannot use same time'</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> after === <span class="string">'string'</span> &amp;&amp; <span class="keyword">typeof</span> last === <span class="string">'number'</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'after must be with first'</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> before === <span class="string">'string'</span> &amp;&amp; <span class="keyword">typeof</span> first === <span class="string">'number'</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'before must be with last'</span>);</span><br><span class="line">      &#125;   </span><br><span class="line">      </span><br><span class="line">      <span class="comment">// Forward pagination</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> first === <span class="string">'number'</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (first &lt; <span class="number">0</span> ) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'first cannot be less than 0'</span>);</span><br><span class="line">        opts.limit = first</span><br><span class="line">      &#125;;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> after === <span class="string">'string'</span>) opts.gt = fromCursorHash(after);</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// Backward pagination</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> last === <span class="string">'number'</span>) &#123; </span><br><span class="line">        <span class="keyword">if</span> (last &lt; <span class="number">0</span> ) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'last cannot be less than 0'</span>);</span><br><span class="line">        opts.limit = last;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> before === <span class="string">'string'</span>) opts.lt = fromCursorHash(before);</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> last === <span class="string">'number'</span> || <span class="keyword">typeof</span> before === <span class="string">'string'</span>) opts.reverse = <span class="literal">true</span>;  </span><br><span class="line">      </span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        allCount = <span class="keyword">await</span> photos.allCount();</span><br><span class="line">        unlimitedCount = <span class="keyword">await</span> photos.allCount(&#123; ...opts, <span class="attr">limit</span>: <span class="literal">undefined</span> &#125;);</span><br><span class="line">        result = <span class="keyword">await</span> photos.findAll( opts );</span><br><span class="line">      &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="keyword">throw</span> error;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (opts &amp;&amp; opts.reverse) result.reverse();</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">const</span> edges = result.map(<span class="function"><span class="params">value</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">          node: &#123; ...value &#125;,</span><br><span class="line">          cursor: toCursorHash( value.id )</span><br><span class="line">        &#125;;</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        pageInfo: &#123;</span><br><span class="line">          startCursor: edges.length &gt; <span class="number">0</span> ? edges[<span class="number">0</span>].cursor : <span class="literal">undefined</span>,</span><br><span class="line">          endCursor: edges.length &gt; <span class="number">0</span> ? edges[edges.length - <span class="number">1</span>].cursor : <span class="literal">undefined</span>,</span><br><span class="line">          hasPreviousPage:</span><br><span class="line">            <span class="keyword">typeof</span> last === <span class="string">'number'</span> </span><br><span class="line">              ? last &lt; unlimitedCount </span><br><span class="line">              : ( <span class="keyword">typeof</span> before === <span class="string">'string'</span> ? <span class="literal">false</span> : allCount &gt; unlimitedCount),</span><br><span class="line">          hasNextPage: </span><br><span class="line">            <span class="keyword">typeof</span> first === <span class="string">'number'</span> </span><br><span class="line">              ? first &lt; unlimitedCount </span><br><span class="line">              : ( <span class="keyword">typeof</span> after === <span class="string">'string'</span> ? <span class="literal">false</span> : allCount &gt; unlimitedCount)</span><br><span class="line">        &#125;,</span><br><span class="line">        edges,</span><br><span class="line">        totalCount: allCount,</span><br><span class="line">        photos: result</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<blockquote>
<ul>
<li>第 1、2 行是 base64 編譯與解意函式。</li>
<li>第 6 行傳入了 4 個參數 after、first、before 與 last。after 與 first 是一對的，支援下一頁的功能，before 與 last 是一對的，支援上一頁的功能，因此 first 與 last 不能同時用。 第 10 到 21 行就是在檢查這些關聯。 </li>
<li>第 24 到 28 行設定下一頁的資料庫執行參數。</li>
<li>第 30 到 36 行設定上一頁的資料庫執行參數。注意 36 行的 opts.reverse 設定為 true。所以會以相反的順序讀取資料流項目</li>
<li>第 39 行是資料庫中所有照片的筆數。</li>
<li>第 40 行可以知道還剩多少筆數，可讓我們知道是不是還有下一頁或上一頁。</li>
<li>第 41 行是實際返回的資料項目。</li>
<li>第 46 行如果使用 last，它是相反方向搜尋的，返回的順序也是相反的，將它迴轉，以免客戶端顯示的順序一團亂。</li>
<li>第 55 行返回 PhotoConnection 型態的物件。</li>
</ul>
</blockquote>
<p>將解析函式併接到 resolvers/index.js</p>
<figure class="highlight javascript"><figcaption><span>resolvers/index.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">const</span> photoConnectionResolvers = <span class="built_in">require</span>(<span class="string">'./photoConnection'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = [userResolvers, photoResolvers, subscriptionResolvers, photoConnectionResolvers];</span><br></pre></td></tr></table></figure>

<p>現在可以由 GraphQL Playground 測試一下，仔細觀察一下返回的資料:</p>
<figure class="highlight plain"><figcaption><span>Playground</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">query allPhotos &#123;</span><br><span class="line">  allPhotosWithPagination (</span><br><span class="line">    first: 5</span><br><span class="line">  ) &#123;</span><br><span class="line">    totalCount,</span><br><span class="line">    pageInfo &#123;</span><br><span class="line">      startCursor</span><br><span class="line">      endCursor</span><br><span class="line">      hasNextPage</span><br><span class="line">      hasPreviousPage</span><br><span class="line">    &#125;</span><br><span class="line">    edges &#123;</span><br><span class="line">      node &#123;</span><br><span class="line">        id</span><br><span class="line">        created</span><br><span class="line">        postedBy &#123;</span><br><span class="line">          appLogin</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      cursor</span><br><span class="line">    &#125;</span><br><span class="line">    photos &#123;</span><br><span class="line">      id</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>這個查詢我們只用了一個引數 first: 5，所以會返回第一筆到第 5 筆的資料，資料就類似如下:</p>
<figure class="highlight json"><figcaption><span>GraphQL Query result</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"data"</span>: &#123;</span><br><span class="line">    <span class="attr">"allPhotosWithPagination"</span>: &#123;</span><br><span class="line">      <span class="attr">"totalCount"</span>: <span class="number">16</span>,</span><br><span class="line">      <span class="attr">"pageInfo"</span>: &#123;</span><br><span class="line">        <span class="attr">"startCursor"</span>: <span class="string">"MQ=="</span>,</span><br><span class="line">        <span class="attr">"endCursor"</span>: <span class="string">"MTU3NjEwOTIxNTk3Nw=="</span>,</span><br><span class="line">        <span class="attr">"hasNextPage"</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">"hasPreviousPage"</span>: <span class="literal">false</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"edges"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">"node"</span>: &#123;</span><br><span class="line">            <span class="attr">"id"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"created"</span>: <span class="string">"2018-03-27T16:00:00.000Z"</span>,</span><br><span class="line">            <span class="attr">"postedBy"</span>: &#123;</span><br><span class="line">              <span class="attr">"appLogin"</span>: <span class="string">"blake"</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">"cursor"</span>: <span class="string">"MQ=="</span></span><br><span class="line">        &#125;,</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>如果需要下一頁的資料就必須加入 after 引數，它的值則是上一個查詢中 pageInfo.endCursor 的值。hasNextPage 與 hasPreviousPage 則可讓你控制應用程式的上一頁與下一頁的按鈕。</p>
<figure class="highlight plain"><figcaption><span>Playground</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">query allPhotos &#123;</span><br><span class="line">  allPhotosWithPagination (</span><br><span class="line">    first: 5</span><br><span class="line">    after: &quot;MTU3NjEwOTIxNTk3Nw==&quot;</span><br><span class="line">  ) &#123;</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure>

<p>使用分頁功能時一定會有一些效能上的損失，這不只會出現在客戶端，資料庫端的效能耗損也需注意，使用上須衡量一下。</p>
<p style="text-align: right;">接續下一篇 <a href="/2019/12/09/GraphQL-API-8/" title="建立 GraphQL API (8)">建立 GraphQL API (8)</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://1184yang.github.io/2019/12/05/GraphQL-API-7/" data-id="ckcpzj95t000q80vzectdldcf" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-GraphQL-Client-3" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/11/28/GraphQL-Client-3/" class="article-date">
  <time datetime="2019-11-28T03:39:11.000Z" itemprop="datePublished">2019-11-28</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/GraphQL/">GraphQL</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/11/28/GraphQL-Client-3/">GraphQL 用戶端 (3)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="訂閱-Subscription"><a href="#訂閱-Subscription" class="headerlink" title="訂閱 Subscription"></a>訂閱 Subscription</h3><p>即時更新是現代 web 與行動 app 不可或缺的功能。目前可在網路與行動 app 之間即時傳送資料的技術是 WebSocket。你可以使用 WebSocket 協定在 TCP 通訊端開啟雙向通訊通道。這意味著網頁與 app 可以透過一個連結來傳送與接收資料。這項技術可讓你即時且直接從伺服器推送更新到網頁上。</p>
<p>到目前為止，我們都用 HTTP 協定來實作 GraphQL 查詢與 mutation。HTTP 提供了在用戶端與伺服器之間傳送與接收資料的手段，但它無法協助我們連接伺服器與監聽狀態的改變。在 WebSocket 出現前，監聽伺服器上的狀態改變唯一的方式就是不斷的傳送 HTTP 請求給伺服器來確定是不是有所改變。</p>
<p>但是如果我們想要充分利用新的網路技術，除了 HTTP 請求之外， GraphQL 也必須能夠支援 WebSocket 上的即時資料傳輸。GraphQL 的解決方案就是<strong>訂閱 (subscription)</strong>。</p>
<h4 id="加入-WebSocketLink"><a href="#加入-WebSocketLink" class="headerlink" title="加入 WebSocketLink"></a>加入 WebSocketLink</h4><p>之前我們已經實作了伺服端支援 Photos 的訂閱了，這裡我們要從客戶端訂閱 newPhoto。訂閱要透過 WebSocket 來運行，為了在客戶端啟用 WebSocket，我們需要再安裝一些套件:</p>
<figure class="highlight powershell"><figcaption><span>npm install</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install apollo<span class="literal">-link</span><span class="literal">-ws</span> apollo<span class="literal">-utilities</span> subscriptions<span class="literal">-transport</span><span class="literal">-ws</span> -<span class="literal">-save</span></span><br></pre></td></tr></table></figure>

<p>我們要在 Apollo Client 組太中加入 WebSocket 連結，我們要修改起始的檔案 main.js:</p>
<figure class="highlight javascript"><figcaption><span>src/main.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">'vue'</span></span><br><span class="line"><span class="keyword">import</span> App <span class="keyword">from</span> <span class="string">'./App.vue'</span></span><br><span class="line"><span class="keyword">import</span> VueApollo <span class="keyword">from</span> <span class="string">'vue-apollo'</span></span><br><span class="line"><span class="keyword">import</span> &#123;ApolloClient, InMemoryCache, split, HttpLink, ApolloLink &#125; <span class="keyword">from</span> <span class="string">'apollo-boost'</span></span><br><span class="line"><span class="keyword">import</span> &#123; persistCache &#125; <span class="keyword">from</span> <span class="string">'apollo-cache-persist'</span></span><br><span class="line"><span class="keyword">import</span> &#123; WebSocketLink &#125; <span class="keyword">from</span> <span class="string">'apollo-link-ws'</span></span><br><span class="line"><span class="keyword">import</span> &#123; getMainDefinition &#125; <span class="keyword">from</span> <span class="string">'apollo-utilities'</span></span><br><span class="line"></span><br><span class="line">Vue.config.productionTip = <span class="literal">false</span></span><br><span class="line">Vue.use(VueApollo);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> cache = <span class="keyword">new</span> InMemoryCache();</span><br><span class="line">persistCache(&#123;</span><br><span class="line">  cache,</span><br><span class="line">  storage: localStorage</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (localStorage[<span class="string">'apollo-cache-persist'</span>]) &#123;</span><br><span class="line">  <span class="keyword">let</span> cacheData = <span class="built_in">JSON</span>.parse(localStorage[<span class="string">'apollo-cache-persist'</span>]);</span><br><span class="line">  cache.restore(cacheData);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> httpLink = <span class="keyword">new</span> HttpLink(&#123;</span><br><span class="line">  uri: <span class="string">'http://localhost:4000/graphql'</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> wsLink = <span class="keyword">new</span> WebSocketLink(&#123;</span><br><span class="line">  uri: <span class="string">'ws://localhost:4000/graphql'</span>,</span><br><span class="line">  options: &#123;</span><br><span class="line">    reconnect: <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> authLink = <span class="keyword">new</span> ApolloLink(<span class="function">(<span class="params">operation, forward</span>) =&gt;</span> &#123;</span><br><span class="line">  operation.setContext(<span class="function"><span class="params">context</span> =&gt;</span> (&#123;</span><br><span class="line">    headers: &#123;</span><br><span class="line">      ...context.headers,</span><br><span class="line">      Authorization: <span class="string">'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhcHBMb2dpbiI6InNjb3R0IiwibmFtZSI6IuiAgeiZjiBTY290dCIsImlhdCI6MTU3NDkwMzA5MSwiZXhwIjoxNTc0OTQ2MjkxfQ.AssjGPY21khE5Xl7K2ZmTVeSerQzrXyOvXKMbEpPL0k'</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;));</span><br><span class="line">  <span class="keyword">return</span> forward(operation);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> httpAuthLink = authLink.concat(httpLink);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> link = split(</span><br><span class="line">  (&#123; query &#125;) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; kind, operation &#125; = getMainDefinition(query);</span><br><span class="line">    <span class="keyword">return</span> kind === <span class="string">"OperationDefinition"</span> &amp;&amp; operation === <span class="string">"subscription"</span>;</span><br><span class="line">  &#125;,</span><br><span class="line">  wsLink,</span><br><span class="line">  httpAuthLink</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> client = <span class="keyword">new</span> ApolloClient(&#123; cache, link &#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> apolloProvider = <span class="keyword">new</span> VueApollo(&#123;</span><br><span class="line">  defaultClient: client</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> Vue(&#123;</span><br><span class="line">  apolloProvider,</span><br><span class="line">  render: <span class="function"><span class="params">h</span> =&gt;</span> h(App),</span><br><span class="line">&#125;).$mount(<span class="string">'#app'</span>)</span><br></pre></td></tr></table></figure>

<p>因修改的蠻多的，所以列出整個 main.js。</p>
<p>第 4 行從 apollo-boost 匯入 split，我們要用它來分開 HTTP 請求與 WebSocket 的 GraphQL 操作。如果操作是 mutation 或 query，Apollo Client 會送出 HTTP 請求。如果操作是 subscription，用戶端會連接 WebSocket。</p>
<p>在 Apollo Client 底層，網路請求是用 ApolloLink 來管理的。在目前 app 中，它負責傳送 HTTP 請求給 GraphQL 伺服器。每當我們用 Apollo Client 傳送操作時，那個操作就會被送到一個 Apollo Link 來處理網路請求。我們也可以使用 Apollo Link 來處理 WebSocket 上的網路。</p>
<p>在第 23 與 27 行，我們需要設定兩種連結來支援 WebSocket: HttpLink 與 WebSocketLink。httpLink 可透過網路傳送 HTTP 請求給 <a href="http://localhost:4000/graphql，而" target="_blank" rel="noopener">http://localhost:4000/graphql，而</a> wsLink 可連接 ws://localhost:4000/graphql 以及透過 WebSocket 接收資料。</p>
<p>連結是可組合的，也就是說，你可以將它們接在一起以建立自訂的管道來處理 GraphQL 操作。除了傳送一個操作給一個 ApolloLink 之外，我們也可以透過可重複使用的連結鏈來傳送一個操作，在操作到達連結鏈的最後一個節點之前，每一個節點都可以處理它，最後一個節點則負責處理請求並回傳結果。</p>
<p>在第 34 到 44 行我們加入了一個自訂的 Apollo Link，以 httpLink 建立一個連結鏈，它的工作是為操作加上一個授權標頭。</p>
<p>我們將 httpLink 接到 authLink 來處理 HTTP 請求的使用者授權。請留意，這個 .contact 函式與你在 JavaScript 串接陣列中看到的函式不同。這是個串接 Apollo Link 的特殊函式。串接之後，我們幫這個連結取一個比較好辨識的名稱 httpAuthLink，來更清楚的描述它的行為。當操作被送到這個連結時，它會先被傳給 authLink，在那裡加上授權標頭，再傳給 httpLink 來處理網路請求。如果你熟悉 Express 的中介軟體 (middleware)，它們都有類似的模式。</p>
<p>第 46 行，實作了一個 split 連結，它會檢查我們的操作是不是 subscription，如果它是 subscription，就用 wsLink 來處理網路，否則使用 httpLink。第 1 個引數是條件式，它使用 getMainDefinition 函式來檢查操作的 query AST，如果這個操作是個 subscription，條件式會回傳 true。當條件式回傳 true 時，link 會回傳 wsLink。當條件式回傳 false 時，link 會回傳 httpAuthLink。</p>
<p>最後，第 55 行我們更改了 Apollo Client 組態，透過將 link 與 cache 傳給它來使用自訂的連結。</p>
<p>現在用戶端可以開始處裡訂閱了，我們將要用 Apollo Client 送出第一個訂閱操作。</p>
<h4 id="監聽新照片"><a href="#監聽新照片" class="headerlink" title="監聽新照片"></a>監聽新照片</h4><p>我們要在 Vue 元件中建立一個 subscribe </p>
<figure class="highlight javascript"><figcaption><span>src/components/HelloWorld.vue</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">  mounted() &#123;</span><br><span class="line">    <span class="keyword">const</span> observer = <span class="keyword">this</span>.$apollo.subscribe(&#123;</span><br><span class="line">      query: gql<span class="string">`subscription newPhoto &#123;</span></span><br><span class="line"><span class="string">        newPhoto &#123;</span></span><br><span class="line"><span class="string">          id</span></span><br><span class="line"><span class="string">          name</span></span><br><span class="line"><span class="string">          description</span></span><br><span class="line"><span class="string">          category</span></span><br><span class="line"><span class="string">          postedBy &#123;</span></span><br><span class="line"><span class="string">            name</span></span><br><span class="line"><span class="string">          &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">      &#125;`</span>,</span><br><span class="line">      variables: &#123;&#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    observer.subscribe(&#123;</span><br><span class="line">      next (data) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(data)</span><br><span class="line">      &#125;,</span><br><span class="line">      error (error) &#123;</span><br><span class="line">        <span class="built_in">console</span>.error(error)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>這裡使用標準的 $apollo.subscribe( ) 方法來訂閱 GraphQL subscripton，該訂閱將在銷毀組件時會自動終止。目前我們只將它顯示在瀏覽器的 console，現在將收到的新照片直接更新客戶端的快取，vue-apollo 則會連動 Vue 屬性的綁定，重新喧染 UI。</p>
<figure class="highlight javascript"><figcaption><span>src/components/HelloWorld.vue</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">mounted() &#123;</span><br><span class="line">  <span class="keyword">const</span> client = <span class="keyword">this</span>.$apollo.getClient();</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> LISTEN_FOR_PHOTOS = gql<span class="string">`subscription newPhoto &#123;</span></span><br><span class="line"><span class="string">    newPhoto &#123;</span></span><br><span class="line"><span class="string">      id</span></span><br><span class="line"><span class="string">      name</span></span><br><span class="line"><span class="string">      description</span></span><br><span class="line"><span class="string">      category</span></span><br><span class="line"><span class="string">      postedBy &#123;</span></span><br><span class="line"><span class="string">        name</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;`</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> LISTPHOTOS_QUERY = gql<span class="string">`query listPhotos &#123;</span></span><br><span class="line"><span class="string">    totalPhotos</span></span><br><span class="line"><span class="string">    allPhotos &#123;</span></span><br><span class="line"><span class="string">      id</span></span><br><span class="line"><span class="string">      name</span></span><br><span class="line"><span class="string">      description</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;`</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> observer = <span class="keyword">this</span>.$apollo.subscribe(&#123;</span><br><span class="line">    query: LISTEN_FOR_PHOTOS,</span><br><span class="line">    variables: &#123;&#125;</span><br><span class="line">  &#125;);</span><br><span class="line">  </span><br><span class="line">  observer.subscribe(&#123;</span><br><span class="line">    next ( &#123;<span class="attr">data</span>: &#123; newPhoto &#125;&#125; ) &#123;        </span><br><span class="line">      <span class="keyword">const</span> cacheData = client.readQuery(&#123;</span><br><span class="line">        query: LISTPHOTOS_QUERY</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      cacheData.totalPhotos += <span class="number">1</span>;</span><br><span class="line">      cacheData.allPhotos.push(&#123;</span><br><span class="line">        id: newPhoto.id,</span><br><span class="line">        name: newPhoto.name,</span><br><span class="line">        description: newPhoto.description,</span><br><span class="line">        __typename: newPhoto.__typename</span><br><span class="line">      &#125;);</span><br><span class="line">        </span><br><span class="line">      client.writeQuery(&#123;</span><br><span class="line">        query: LISTPHOTOS_QUERY,</span><br><span class="line">        data: cacheData</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;,</span><br><span class="line">    error (error) &#123;</span><br><span class="line">      <span class="built_in">console</span>.error(error)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;,</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>第 3 行取得 Apollo Client 實例。</p>
<p>第 5 行定義 GraphQL subscription。當在使用 Apollo Client 時，習慣上會將 query 定義在一個常數上，如果有許多不同的元件共用，也可將它模組化，集中在一個檔案中。</p>
<p>第 17 行定義 GraphQL query，與 subscription 一樣將它定義在一個常數上。</p>
<p>第 33 行抓取 GraphQL query listPhotos 的快取資料。</p>
<p>第 37、38 行更改從快取抓出來的資料。</p>
<p>第 45 行寫回快取。</p>
<p>除了使用 Apollo subscribe 的標準模式外，也可以使用 Vue Apollo 的另一種簡易模式:</p>
<figure class="highlight plain"><figcaption><span>src/components/HelloWorld.vue</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">  apollo: &#123;</span><br><span class="line">    ...</span><br><span class="line">    $subscribe: &#123;</span><br><span class="line">      newPhoto: &#123;</span><br><span class="line">        query: LISTEN_FOR_PHOTOS,</span><br><span class="line">        result(result, key) &#123;</span><br><span class="line">          console.log(result);</span><br><span class="line">          console.log(key);</span><br><span class="line">        &#125;,</span><br><span class="line">        error(err) &#123;</span><br><span class="line">          console.lot(err.message);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>這是最後 src/components/HelloWorld.vue 最後的樣子，僅供參考。你如果在這個元件介面中按下新增照片，你的照片數量會增加兩個，這當然是錯的，但為什麼，自己想想吧!</p>
<figure class="highlight javascript"><figcaption><span>src/components/HelloWorld.vue</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"hello"</span>&gt;</span><br><span class="line">    &lt;h1&gt;&#123;&#123; msg &#125;&#125;&lt;<span class="regexp">/h1&gt;</span></span><br><span class="line"><span class="regexp">    &lt;h1&gt;&#123;&#123; helloTainan &#125;&#125;&lt;/</span>h1&gt;</span><br><span class="line">    &lt;button @click=<span class="string">"addPhoto"</span>&gt;Click to add <span class="keyword">new</span> photo&lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">    &lt;p /</span>&gt;</span><br><span class="line">    &lt;button @click=<span class="string">"clearUsers"</span>&gt;Click to clear users&lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">    &lt;h1&gt;Total Users: &#123;&#123; totalUsers &#125;&#125; Total Photos: &#123;&#123; totalPhotos &#125;&#125;&lt;/</span>h1&gt;</span><br><span class="line">    &lt;ul&gt;</span><br><span class="line">      &lt;li v-<span class="keyword">for</span>=<span class="string">"user in allUsers"</span> :key=<span class="string">"user.appLogin"</span>&gt;</span><br><span class="line">        &#123;&#123; user.appLogin &#125;&#125; &#123;&#123; user.name &#125;&#125;</span><br><span class="line">      &lt;<span class="regexp">/li&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/u</span>l&gt;</span><br><span class="line">  &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line"><span class="keyword">import</span> &#123; gql &#125; <span class="keyword">from</span> <span class="string">'apollo-boost'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> LISTEN_FOR_PHOTOS = gql<span class="string">`subscription newPhoto &#123;</span></span><br><span class="line"><span class="string">  newPhoto &#123;</span></span><br><span class="line"><span class="string">    id</span></span><br><span class="line"><span class="string">    name</span></span><br><span class="line"><span class="string">    description</span></span><br><span class="line"><span class="string">    category</span></span><br><span class="line"><span class="string">    postedBy &#123;</span></span><br><span class="line"><span class="string">      name</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;`</span>;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">const</span> LISTPHOTOS_QUERY = gql<span class="string">`query listPhotos &#123;</span></span><br><span class="line"><span class="string">  totalPhotos</span></span><br><span class="line"><span class="string">  allPhotos &#123;</span></span><br><span class="line"><span class="string">    id</span></span><br><span class="line"><span class="string">    name</span></span><br><span class="line"><span class="string">    description</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;`</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  name: <span class="string">'HelloWorld'</span>,</span><br><span class="line">  props: &#123;</span><br><span class="line">    msg: <span class="built_in">String</span></span><br><span class="line">  &#125;,</span><br><span class="line">  data() &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      helloTainan: <span class="literal">undefined</span>,</span><br><span class="line">      totalUsers: <span class="literal">undefined</span>,</span><br><span class="line">      totalPhotos: <span class="literal">undefined</span>,</span><br><span class="line">      loading: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  apollo: &#123;</span><br><span class="line">    helloTainan: &#123;</span><br><span class="line">      query: gql<span class="string">`query hello &#123;</span></span><br><span class="line"><span class="string">        helloTainan: sayHello</span></span><br><span class="line"><span class="string">      &#125;`</span></span><br><span class="line">    &#125;,</span><br><span class="line">    allUsers: &#123;</span><br><span class="line">      query: gql<span class="string">`query listUsers &#123;</span></span><br><span class="line"><span class="string">        totalUsers</span></span><br><span class="line"><span class="string">        allUsers &#123;</span></span><br><span class="line"><span class="string">          appLogin</span></span><br><span class="line"><span class="string">          name</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">      &#125;`</span>,</span><br><span class="line">      result (&#123; data, loading &#125;) &#123;   </span><br><span class="line">        <span class="keyword">this</span>.totalUsers = data &amp;&amp; data.totalUsers;</span><br><span class="line">        <span class="keyword">this</span>.loading = loading;</span><br><span class="line">      &#125;,</span><br><span class="line">      fetchPolicy: <span class="string">'cache-and-network'</span></span><br><span class="line">    &#125;,</span><br><span class="line">    allPhotos: &#123;</span><br><span class="line">      query: LISTPHOTOS_QUERY,</span><br><span class="line">      result(&#123; data, loading &#125;) &#123;</span><br><span class="line">        <span class="keyword">this</span>.totalPhotos = data.totalPhotos;</span><br><span class="line">        <span class="keyword">this</span>.loading = loading;</span><br><span class="line">      &#125;,</span><br><span class="line">      fetchPolicy: <span class="string">'cache-and-network'</span></span><br><span class="line">    &#125;,</span><br><span class="line">    $subscribe: &#123;</span><br><span class="line">      newPhoto: &#123;</span><br><span class="line">        query: LISTEN_FOR_PHOTOS,</span><br><span class="line">        result(result, key) &#123;</span><br><span class="line">          <span class="built_in">console</span>.log(result);</span><br><span class="line">          <span class="built_in">console</span>.log(key);</span><br><span class="line">        &#125;,</span><br><span class="line">        error(err) &#123;</span><br><span class="line">          <span class="built_in">console</span>.lot(err.message);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  methods: &#123;</span><br><span class="line">    addPhoto() &#123;</span><br><span class="line">      <span class="keyword">const</span> newPhoto = &#123;</span><br><span class="line">        name: <span class="string">"範例照片 from Vue mutation !"</span>,</span><br><span class="line">        description: <span class="string">`我們資料庫的範例照片 <span class="subst">$&#123;<span class="keyword">new</span> <span class="built_in">Date</span>().toISOString()&#125;</span>`</span></span><br><span class="line">      &#125;;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">this</span>.$apollo.mutate(&#123;</span><br><span class="line">        mutation: gql<span class="string">`mutation addPhoto($input: PostPhotoInput!) &#123;</span></span><br><span class="line"><span class="string">          postPhoto(input: $input) &#123;</span></span><br><span class="line"><span class="string">            id</span></span><br><span class="line"><span class="string">            name</span></span><br><span class="line"><span class="string">            description</span></span><br><span class="line"><span class="string">          &#125;</span></span><br><span class="line"><span class="string">        &#125;`</span>,</span><br><span class="line">        variables: &#123;</span><br><span class="line">          input: newPhoto,</span><br><span class="line">        &#125;,</span><br><span class="line">        update: <span class="function">(<span class="params">store, &#123; data: &#123; postPhoto &#125;&#125;</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">const</span> LISTPHOTOS_QUERY = gql<span class="string">`query listPhotos &#123;</span></span><br><span class="line"><span class="string">            totalPhotos</span></span><br><span class="line"><span class="string">            allPhotos &#123;</span></span><br><span class="line"><span class="string">              id</span></span><br><span class="line"><span class="string">              name</span></span><br><span class="line"><span class="string">              description</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">          &#125;`</span>;</span><br><span class="line">          <span class="keyword">const</span> cacheData = store.readQuery(&#123;</span><br><span class="line">            query: LISTPHOTOS_QUERY</span><br><span class="line">          &#125;);</span><br><span class="line"></span><br><span class="line">          cacheData.totalPhotos += <span class="number">1</span>;</span><br><span class="line">          cacheData.allPhotos.push(postPhoto);</span><br><span class="line">          </span><br><span class="line">          store.writeQuery(&#123;</span><br><span class="line">            query: LISTPHOTOS_QUERY,</span><br><span class="line">            data: cacheData</span><br><span class="line">          &#125;);</span><br><span class="line">          </span><br><span class="line">          <span class="built_in">console</span>.log(postPhoto);</span><br><span class="line">          <span class="built_in">console</span>.log(cacheData);</span><br><span class="line">        &#125;,</span><br><span class="line">        optimisticResponse: &#123;</span><br><span class="line">          __typename: <span class="string">'Mutation'</span>,</span><br><span class="line">          postPhoto: &#123;</span><br><span class="line">            __typename: <span class="string">'Photo'</span>,</span><br><span class="line">            id: <span class="number">-1</span>,</span><br><span class="line">            ...newPhoto</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;).then(<span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(data);</span><br><span class="line">        <span class="comment">//this.$apollo.queries.allPhotos.refetch();</span></span><br><span class="line">      &#125;).catch(<span class="function">(<span class="params">error</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.error(error);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;,</span><br><span class="line">    clearUsers() &#123;</span><br><span class="line">      <span class="keyword">const</span> client = <span class="keyword">this</span>.$apollo.getClient();</span><br><span class="line">      client.writeQuery(&#123;</span><br><span class="line">        query: gql<span class="string">`query listUsers &#123;</span></span><br><span class="line"><span class="string">          totalUsers</span></span><br><span class="line"><span class="string">          allUsers &#123;</span></span><br><span class="line"><span class="string">            appLogin</span></span><br><span class="line"><span class="string">            name</span></span><br><span class="line"><span class="string">          &#125;</span></span><br><span class="line"><span class="string">        &#125;`</span>,</span><br><span class="line">        data: &#123;</span><br><span class="line">          totalUsers: <span class="number">0</span>,</span><br><span class="line">          allUsers: []</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;  </span><br><span class="line">  &#125;,</span><br><span class="line">  mounted() &#123;</span><br><span class="line">    <span class="keyword">const</span> client = <span class="keyword">this</span>.$apollo.getClient();   </span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> observer = <span class="keyword">this</span>.$apollo.subscribe(&#123;</span><br><span class="line">      query: LISTEN_FOR_PHOTOS,</span><br><span class="line">      variables: &#123;&#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    observer.subscribe(&#123;</span><br><span class="line">      next ( &#123;<span class="attr">data</span>: &#123; newPhoto &#125;&#125; ) &#123;        </span><br><span class="line">        <span class="keyword">const</span> cacheData = client.readQuery(&#123;</span><br><span class="line">          query: LISTPHOTOS_QUERY</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        cacheData.totalPhotos += <span class="number">1</span>;</span><br><span class="line">        cacheData.allPhotos.push(&#123;</span><br><span class="line">          id: newPhoto.id,</span><br><span class="line">          name: newPhoto.name,</span><br><span class="line">          description: newPhoto.description,</span><br><span class="line">          __typename: newPhoto.__typename</span><br><span class="line">        &#125;);</span><br><span class="line">          </span><br><span class="line">        client.writeQuery(&#123;</span><br><span class="line">          query: LISTPHOTOS_QUERY,</span><br><span class="line">          data: cacheData</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;,</span><br><span class="line">      error (error) &#123;</span><br><span class="line">        <span class="built_in">console</span>.error(error)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line">  created() &#123;</span><br><span class="line">    <span class="keyword">const</span> client = <span class="keyword">this</span>.$apollo.getClient();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> data = client.readQuery(&#123;</span><br><span class="line">      query: LISTPHOTOS_QUERY</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="built_in">console</span>.log(data);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure>

<p>事實上，這個元件並不需要 subscription，我們先前實作 mutation 時有實作 Optimistic UI，快取中已加入了新增的照片。這裡的 subscription 又加了一次。</p>
<p>除了標準的 Apollo subscription 與簡易的 subscription 之外，如果需要從訂閱更新智能查詢 (Smart Query) 結果，最好的方法是使用 subscribeToMore 智能查詢 (Smart Subscriptions) 方法。我們可以將 query allPhotos 與 subscription newPhoto 結合:</p>
<figure class="highlight javascript"><figcaption><span>src/components/HelloWorld.vue</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">allPhotos: &#123;</span><br><span class="line">  query: LISTPHOTOS_QUERY,</span><br><span class="line">  result(&#123; data, loading &#125;) &#123;</span><br><span class="line">    <span class="keyword">this</span>.totalPhotos = data.totalPhotos;</span><br><span class="line">    <span class="keyword">this</span>.loading = loading;</span><br><span class="line">  &#125;,</span><br><span class="line">  fetchPolicy: <span class="string">'cache-and-network'</span>,</span><br><span class="line">  subscribeToMore: &#123;</span><br><span class="line">    <span class="built_in">document</span>: LISTEN_FOR_PHOTOS,</span><br><span class="line">    variables: &#123; &#125;,</span><br><span class="line">    updateQuery: <span class="function">(<span class="params">previousResult, &#123; subscriptionData &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> newPhoto = &#123;</span><br><span class="line">        id: subscriptionData.data.newPhoto.id,</span><br><span class="line">        name: subscriptionData.data.newPhoto.name,</span><br><span class="line">        description: subscriptionData.data.newPhoto.description,</span><br><span class="line">        __typename: subscriptionData.data.newPhoto.__typename,</span><br><span class="line">      &#125;;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        totalPhotos: previousResult.totalPhotos + <span class="number">1</span>,</span><br><span class="line">        allPhotos: [</span><br><span class="line">          ...previousResult.allPhotos,</span><br><span class="line">          newPhoto</span><br><span class="line">        ]</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;,</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>或是另外一種寫法:</p>
<figure class="highlight javascript"><figcaption><span>src/component/WorldHello.vue</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="comment">// Smart Subscriptions</span></span><br><span class="line"><span class="keyword">this</span>.$apollo.queries.allPhotos.subscribeToMore(&#123;</span><br><span class="line">  <span class="built_in">document</span>: LISTEN_FOR_PHOTOS,</span><br><span class="line">  variables: &#123; &#125;,</span><br><span class="line">  updateQuery: <span class="function">(<span class="params">&#123; totalPhotos, allPhotos &#125;, &#123; subscriptionData: &#123; data: &#123; newPhoto &#125; &#125; &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; id, name, description, __typename &#125; = newPhoto;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      totalPhotos: totalPhotos + <span class="number">1</span>,</span><br><span class="line">      allPhotos: [</span><br><span class="line">        ...allPhotos,</span><br><span class="line">        &#123; id, name, description, __typename &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>改變一下第 6 行 updateQuery 引數的寫法，讓程式碼看起來清爽些。使用 JavaScript 的解構賦值 (Destructuring assignment) 語法。</p>
<p>在這個例子，我們將新增照片所需授權的權杖寫死在 main.js 中，我們可以加個認證按鈕，認證成功後可將權杖儲存到 localStorege 中:</p>
<figure class="highlight plain"><figcaption><span>src/components/HelloWorld.vue</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">methods: &#123;</span><br><span class="line">  ...</span><br><span class="line">  authentication() &#123;</span><br><span class="line">    this.$apollo.mutate(&#123;</span><br><span class="line">      mutation: gql`mutation login($login: String! $password: String) &#123;</span><br><span class="line">        appAuth(login: $login password: $password) &#123;</span><br><span class="line">          user &#123;</span><br><span class="line">            appLogin</span><br><span class="line">            name</span><br><span class="line">          &#125;</span><br><span class="line">          token</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;`,</span><br><span class="line">      variables: &#123;</span><br><span class="line">        login: &quot;scott&quot;,</span><br><span class="line">        password: &quot;tiger&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;).then( (&#123; data &#125;) =&gt; &#123;</span><br><span class="line">      console.log(&apos;Authentication successful&apos;);</span><br><span class="line">      localStorage.setItem(&apos;token&apos;, data.appAuth.token);</span><br><span class="line">    &#125;).catch (err =&gt; &#123;</span><br><span class="line">      console.log(err.message);</span><br><span class="line">      localStorage.removeItem(&apos;token&apos;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;  </span><br><span class="line">&#125;,</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>在 template 中加個按鈕。 這裡的 login 與 password 寫死在程式碼中，你應該實作一個 HTML Form Input 來讓使用者輸入。</p>
<figure class="highlight html"><figcaption><span>src/components/HelloWorld.vue</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">"authentication"</span>&gt;</span>Click to authentication<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>最後修改 main.js，從 localStorege 種抓取權杖。</p>
<figure class="highlight javascript"><figcaption><span>src/main.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">const</span> authLink = <span class="keyword">new</span> ApolloLink(<span class="function">(<span class="params">operation, forward</span>) =&gt;</span> &#123;</span><br><span class="line">  operation.setContext(<span class="function"><span class="params">context</span> =&gt;</span> (&#123;</span><br><span class="line">    headers: &#123;</span><br><span class="line">      ...context.headers,</span><br><span class="line">      Authorization: <span class="string">`Bearer <span class="subst">$&#123;localStorage.getItem(<span class="string">'token'</span>)&#125;</span>`</span> </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;));</span><br><span class="line">  <span class="keyword">return</span> forward(operation);</span><br><span class="line">&#125;);</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>祝有個美好的一天與體驗!</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://1184yang.github.io/2019/11/28/GraphQL-Client-3/" data-id="ckcpzj960001180vzc7rfvcrb" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-GraphQL-Client-2" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/11/27/GraphQL-Client-2/" class="article-date">
  <time datetime="2019-11-26T23:20:18.000Z" itemprop="datePublished">2019-11-27</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/GraphQL/">GraphQL</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/11/27/GraphQL-Client-2/">GraphQL 用戶端 (2)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="Mutation"><a href="#Mutation" class="headerlink" title="Mutation"></a>Mutation</h3><p>Mutation 會更改 Apollo 伺服器服務的數據狀態。基本的運作方式與 query 沒甚麼不同:</p>
<p>在實作 mutation 之前，我們先新加入一個 query 來顯示照片的變化:</p>
<figure class="highlight javascript"><figcaption><span>src/component/HelloWorld.vue</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">    allPhotos: &#123;</span><br><span class="line">      query: gql<span class="string">`query listPhotos &#123;</span></span><br><span class="line"><span class="string">        totalPhotos</span></span><br><span class="line"><span class="string">        allPhotos &#123;</span></span><br><span class="line"><span class="string">          id</span></span><br><span class="line"><span class="string">          name</span></span><br><span class="line"><span class="string">          description</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">      &#125;`</span>,</span><br><span class="line">      result(&#123; data, loading &#125;) &#123;</span><br><span class="line">        <span class="keyword">this</span>.totalPhotos = data.totalPhotos;</span><br><span class="line">        <span class="keyword">this</span>.loading = loading;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>現在我們在 Vue 的 methods 增加一個 addPhoto 的操作方法:</p>
<figure class="highlight javascript"><figcaption><span>src/components/HelloWorld.vue</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">  methods: &#123;</span><br><span class="line">    addPhoto() &#123;</span><br><span class="line">      <span class="keyword">const</span> newPhoto = &#123;</span><br><span class="line">        name: <span class="string">"範例照片 from Vue mutation !"</span>,</span><br><span class="line">        description: <span class="string">`我們資料庫的範例照片 <span class="subst">$&#123;<span class="keyword">new</span> <span class="built_in">Date</span>().toISOString()&#125;</span>`</span></span><br><span class="line">      &#125;;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">this</span>.$apollo.mutate(&#123;</span><br><span class="line">        mutation: gql<span class="string">`mutation addPhoto($input: PostPhotoInput!) &#123;</span></span><br><span class="line"><span class="string">          postPhoto(input: $input) &#123;</span></span><br><span class="line"><span class="string">            id</span></span><br><span class="line"><span class="string">            name</span></span><br><span class="line"><span class="string">            description</span></span><br><span class="line"><span class="string">          &#125;</span></span><br><span class="line"><span class="string">        &#125;`</span>,</span><br><span class="line">        variables: &#123;</span><br><span class="line">          input: newPhoto,</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;).then(<span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(data);</span><br><span class="line">        <span class="keyword">this</span>.$apollo.queries.allPhotos.refetch();</span><br><span class="line">      &#125;).catch(<span class="function">(<span class="params">error</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.error(error);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;,  </span><br><span class="line">  &#125;,</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<ul>
<li>第 4 行的新照片，在實際運作上應該是要由用戶輸入的，這裡讓他單純化，避免失焦。</li>
<li>第 9 行用 this.$apollo.mutate( ) 方法送出 GraphQL mutation，語法與 query 差不多，這裡我們使用一個變數 $input。this.$apollo.mutate( ) 會返回一個 Promise，他返回的值就是你在第 11 行 postPhoto 時所定義的，這裡就是 Photo 的三個屬性 id、name 與 description。</li>
<li>第 22 行我們並重新抓取 allPhotos 的資料，Vue 則會同時更新畫面。 </li>
</ul>
<p>接下來我們要在使用者介面上新增一個按鈕來觸發這個 mutation，並新增一個訊息顯示照片的總數量:</p>
<figure class="highlight html"><figcaption><span>src/components/HelloWorld.vue</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">"addPhoto"</span>&gt;</span>Click to add new photo<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Total Users: &#123;&#123; totalUsers &#125;&#125; Total Photos: &#123;&#123; totalPhotos &#125;&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>現在可以測試看看了。</p>
<p>先前談過 Apollo Client 支援積極 UI 更新 (optimistic UI update)，因此 mutation 也提供了一些 Hook，主要的就是 update 與 optimisticResponse Hook。我們不一定要用積極 UI 更新，但了解它可讓我們了解使用者 UI 的技術。</p>
<blockquote>
<blockquote>
<h6 id="Optimistic-UI-update"><a href="#Optimistic-UI-update" class="headerlink" title="Optimistic UI update"></a>Optimistic UI update</h6><p>當我們新增或更新資料成功後，伺服器都會返回一個結果，以便我們更新使用者的介面 (UI)，但我們為了讓使用者感覺反應快速，就會使用送出的數據，樂觀的當成伺服器更新成功後返回的數據來更新使用者介面，並在伺服器真正返回結果時，再來更新錯誤。</p>
</blockquote>
</blockquote>
<p>現在修改一下 mutation，加入 update 與 optimisticResponse Hook:</p>
<figure class="highlight javascript"><figcaption><span>src/components/HelloWorld.vue</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">      <span class="keyword">this</span>.$apollo.mutate(&#123;</span><br><span class="line">        mutation: gql<span class="string">`mutation addPhoto($input: PostPhotoInput!) &#123;</span></span><br><span class="line"><span class="string">          postPhoto(input: $input) &#123;</span></span><br><span class="line"><span class="string">            id</span></span><br><span class="line"><span class="string">            name</span></span><br><span class="line"><span class="string">            description</span></span><br><span class="line"><span class="string">          &#125;</span></span><br><span class="line"><span class="string">        &#125;`</span>,</span><br><span class="line">        variables: &#123;</span><br><span class="line">          input: newPhoto,</span><br><span class="line">        &#125;,</span><br><span class="line">        update: <span class="function">(<span class="params">store, &#123; data &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="built_in">console</span>.log(<span class="string">'mutation update begin'</span>);</span><br><span class="line">          <span class="built_in">console</span>.log(data);</span><br><span class="line">          <span class="built_in">console</span>.log(<span class="string">'mutation update end'</span>);</span><br><span class="line">        &#125;,</span><br><span class="line">        optimisticResponse: &#123;</span><br><span class="line">          __typename: <span class="string">'Mutation'</span>,</span><br><span class="line">          postPhoto: &#123;</span><br><span class="line">            __typename: <span class="string">'Photo'</span>,</span><br><span class="line">            id: <span class="number">-1</span>,</span><br><span class="line">            ...newPhoto</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;).then(<span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(data);</span><br><span class="line">        <span class="keyword">this</span>.$apollo.queries.allPhotos.refetch();</span><br><span class="line">      &#125;).catch(<span class="function">(<span class="params">error</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.error(error);</span><br><span class="line">      &#125;);</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<ul>
<li>第 13 行加入了 update Hook，update( ) 函式這裡接受兩個引數 store 與儲存資料的物件，每一個 mutation 它總是會被調用兩次，第一次使用 optimisticResponse 返回的樂觀資料，第二次調用則會是實際返回的資料。這裡我們只是把它顯示出來，沒有做其他的處裡。store 實際上是 Apollo Client 的 cache，因此可以用這調用的時機更新 cache 的資料，可以在第二次調用時回滾 (Rollback) 第一次的樂觀資料用實際返回的資料取代。因此這個功能也必須與 Apollo Client 的快取一起使用。我們將在稍後談到 Apollo Client Cache。 </li>
<li>第 18 行 optimisticResponse 在設定樂觀的資料，此時 id 還沒有產生，暫時用 -1。如果這裡沒有設定 optimisticResponse 屬性，則 update( ) 只會被調用一次。</li>
</ul>
<img src="/2019/11/27/GraphQL-Client-2/apollo-mutation.png" title="Apollo Client mutation">

<p>如果你只想在完成 mutation 後執行一些操作，也不需要積極 UI 更新，使用 Promise then 就可以了。</p>
<h3 id="使用快取-Cache"><a href="#使用快取-Cache" class="headerlink" title="使用快取 Cache"></a>使用快取 Cache</h3><p>身為開發者，我們應該盡量減少網路請求。我們不希望讓使用者被迫發出無關的請求。為了盡量減少 app 送出的網路請求數量，Apollo Client 提供了 Cache 機制。</p>
<h4 id="抓取策略-Fetch-Policy"><a href="#抓取策略-Fetch-Policy" class="headerlink" title="抓取策略 Fetch Policy"></a>抓取策略 Fetch Policy</h4><p>在預設情況下，Apollo Client 會在一個本地的 JavaScript 變數中儲存資料。每當我們建立用戶端時，Apollo Client 就會為我們建立一個快取。每當我們傳送操作時，回應就會被存到本地快取。fetchPolicy 可告訴 Apollo Client 該去哪裡尋找解析操作所需要的資料，究竟是本地快取還是網路請求。預設的 fetchPolicy 是 cache-first。這代表用戶端會在本地的快取尋找資料來解析操作。如果用戶端可以在不傳送網路請求的情況下解析操作，它就會這樣做。但是，如果解析 query 所需的資料不在快取裡面，用戶端會傳送網路請求給 GraphQL 服務。</p>
<p>另一種類型的 fetchPolicy 是 cache-only。這種作法要求用戶端只在快取中尋找資料，永遠不要傳送網路請求。如果快取裡面沒有滿足 query 的所有資料，就丟出錯誤。</p>
<p>我們修改一下程式，來改變各個 query 的抓取策略:</p>
<figure class="highlight javascript"><figcaption><span>src/components/HelloWorld.vue</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">    allUsers: &#123;</span><br><span class="line">      query: gql<span class="string">`query listUsers &#123;</span></span><br><span class="line"><span class="string">        totalUsers</span></span><br><span class="line"><span class="string">        allUsers &#123;</span></span><br><span class="line"><span class="string">          appLogin</span></span><br><span class="line"><span class="string">          name</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">      &#125;`</span>,</span><br><span class="line">      result (&#123; data, loading &#125;) &#123;       </span><br><span class="line">        <span class="keyword">this</span>.totalUsers = data.totalUsers;</span><br><span class="line">        <span class="keyword">this</span>.loading = loading;</span><br><span class="line">      &#125;,</span><br><span class="line">      fetchPolicy: <span class="string">'cache-only'</span></span><br><span class="line">    &#125;,</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>第 14 行加入了 fetchPolicy，並設定為 cache-only，當你重新整理瀏覽器時應該會看不到 Users 的資料，因為 Apollo Client 只會在快取裡面尋找資料來解析 query，但是 app 啟動時，那些資料並不存在。為了清除這個錯誤，我們將抓取策略改成 cache-and-network。</p>
<figure class="highlight javascript"><figcaption><span>src/components/HelloWorld.vue</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">    allUsers: &#123;</span><br><span class="line">      query: gql<span class="string">`query listUsers &#123;</span></span><br><span class="line"><span class="string">        totalUsers</span></span><br><span class="line"><span class="string">        allUsers &#123;</span></span><br><span class="line"><span class="string">          appLogin</span></span><br><span class="line"><span class="string">          name</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">      &#125;`</span>,</span><br><span class="line">      result (&#123; data, loading &#125;) &#123;   </span><br><span class="line">        <span class="keyword">this</span>.totalUsers = data &amp;&amp; data.totalUsers;</span><br><span class="line">        <span class="keyword">this</span>.loading = loading;</span><br><span class="line">      &#125;,</span><br><span class="line">      fetchPolicy: <span class="string">'cache-and-network'</span></span><br><span class="line">    &#125;,</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>這個 app 又可以正常運作了。 cache-and-network 策略一定會立刻用快取來解析查詢，同時也會傳送網路請求以取得最新的資料。如果本地快取不存在，例如當 app 啟動時，這個策略只會從網路接收資料。在第 11 行我們也做了一些變更，否則當抓不到快取資料時，data 值會是 undefined，瀏覽器的 console 總是會出現錯誤。這也是一個良好的習慣，當要抓取某個物件中屬性的值時，先檢查這個物件是否存在。</p>
<p>其他的策略包括:</p>
<ul>
<li><p>network-only  一定會傳送網路請求來解析 query</p>
</li>
<li><p>no-cache 一定會傳送網路請求來解析 query，不會將回應結果存放在快取內。</p>
</li>
</ul>
<h4 id="保存快取"><a href="#保存快取" class="headerlink" title="保存快取"></a>保存快取</h4><p>在預設情況下，Apollo Client 會在一個本地的 JavaScript 變數中儲存資料。每當我們建立用戶端時，Apollo Client 就會為我們建立一個快取。但我們可以在用戶端儲存快取，這可以完全發揮 cache-first 策略的威力，因為當使用者回到 app 時，永遠都會有快取。在這裡，cache-first 策略會立刻解析既有本地快取的資料，而且完全不會用網路傳送請求。</p>
<p>為了在本地除存快取資料，我們要安裝一個 npm 套件:</p>
<figure class="highlight shell"><figcaption><span>npm install</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install apollo-cache-persist --save</span><br></pre></td></tr></table></figure>

<p>apollo-cache-persist 套件有一個函式可以改善快取，它的做法是當快取改變時，就將它存放在本地端。為了實作快取保存，我們要建立自己的 cache 物件，並且在設置 app 時將他加入 client。</p>
<figure class="highlight javascript"><figcaption><span>src/main.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">import</span> ApolloClient, &#123; InMemoryCache &#125; <span class="keyword">from</span> <span class="string">'apollo-boost'</span></span><br><span class="line"><span class="keyword">import</span> &#123; persistCache &#125; <span class="keyword">from</span> <span class="string">'apollo-cache-persist'</span></span><br><span class="line">...</span><br><span class="line"><span class="keyword">const</span> cache = <span class="keyword">new</span> InMemoryCache();</span><br><span class="line">persistCache(&#123;</span><br><span class="line">  cache,</span><br><span class="line">  storage: localStorage</span><br><span class="line">&#125;);</span><br><span class="line">...</span><br><span class="line"><span class="keyword">const</span> client = <span class="keyword">new</span> ApolloClient(&#123;</span><br><span class="line">  cache,</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">&#125;);</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>第 5 行我們用 apollo-boost 提供的 InMemoryCache 建構式來建立自己的快取實例，並連同 storage 位置一起將它傳給 persistCache 方法。第 12 行將 cache 加入 ApolloClient。</p>
<p>我們選擇將快取存放在瀏覽器的 localStorage，啟動 app 後，你可以從瀏覽器 console 中檢查它:</p>
<img src="/2019/11/27/GraphQL-Client-2/apollo-cache-1.png" title="Apollo Client cache">

<p>或者直接檢查 localStorege:</p>
<img src="/2019/11/27/GraphQL-Client-2/apollo-cache-2.png" title="Apollo Client cache">

<p>下一步是在啟動時檢查 localStorege，看看快取是否已經被儲存了。如果有，在建立用戶端之前，我們要用那些資料來初始化本地的 cache:</p>
<figure class="highlight javascript"><figcaption><span>src/main.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">const</span> cache = <span class="keyword">new</span> InMemoryCache();</span><br><span class="line">persistCache(&#123;</span><br><span class="line">  cache,</span><br><span class="line">  storage: localStorage</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (localStorage[<span class="string">'apollo-cache-persist'</span>]) &#123;</span><br><span class="line">  <span class="keyword">let</span> cacheData = <span class="built_in">JSON</span>.parse(localStorage[<span class="string">'apollo-cache-persist'</span>]);</span><br><span class="line">  cache.restore(cacheData);</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>現在我們的 app 會在啟動前載入任何已被快取的資料。如果我們有資料存放在 Key apollo-cache-persist 之下，就要使用 cache.restore(cacheData) 方法來將它加入 cache 實例。</p>
<p>我們已經用 Apollo Client 的快取成功的將送到 GraphQL 服務的網路請求減到最少了。再來，我們將看看如何將資料直接寫入快取。</p>
<h4 id="更新快取"><a href="#更新快取" class="headerlink" title="更新快取"></a>更新快取</h4><p>可以直接從快取讀出資料，這是讓 cache-only 這類的策略得以執行的要素。我們也能夠與 Apollo Cache 直接互動。我們可以從快取讀出目前的資料，或將資料直接寫入快取。每當我們改變快取內的資料時，vue-apollo 就會發現那項改變，並重新喧染所有被影響的元件。我們只要修改快取，UI 就會隨著改變，自動更新。</p>
<p>Apollo Cache 的資料是用 GraphQL query 寫入的，所以也必須用 GraphQL query 讀取，我們來看先前 allUsers 的 GraphQL query:</p>
<figure class="highlight javascript"><figcaption><span>src/components/HolloWorld.vue</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">    allUsers: &#123;</span><br><span class="line">      query: gql<span class="string">`query listUsers &#123;</span></span><br><span class="line"><span class="string">        totalUsers</span></span><br><span class="line"><span class="string">        allUsers &#123;</span></span><br><span class="line"><span class="string">          appLogin</span></span><br><span class="line"><span class="string">          name</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">      &#125;`</span>,</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>這是 allUsers 的 GraphQL query，因此目前 Apollo Cache 的資料就是用這段 GraphQL query 寫入的，我們必須用相同的 GraphQL query 從 cache 讀取。</p>
<figure class="highlight javascript"><figcaption><span>src/components/HelloWorld.vue</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">created() &#123; </span><br><span class="line">  <span class="keyword">const</span> client = <span class="keyword">this</span>.$apollo.getClient();</span><br><span class="line">  <span class="keyword">const</span> &#123; totalUsers, allUsers &#125; = client.readQuery(&#123; </span><br><span class="line">    query: gql<span class="string">`query listUsers &#123;</span></span><br><span class="line"><span class="string">      totalUsers</span></span><br><span class="line"><span class="string">      allUsers &#123;</span></span><br><span class="line"><span class="string">        appLogin</span></span><br><span class="line"><span class="string">        name</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;`</span></span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">console</span>.log(totalUsers ? totalUsers : <span class="number">0</span>);</span><br><span class="line">  <span class="built_in">console</span>.log(allUsers ? allUsers: []);</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>第 3 行我們取得 Apollo Client 實例。<br>第 4 行用 client.readQuery( ) 讀取資料。</p>
<p>這樣我們就取得存放在快取裡面的 totalUsers 與 allUsers 的值。</p>
<p>我們也可以使用 cache.writeQuery 方法來將資料直接寫入這個 GraphQL query 的 totalUsers 與 allUsers 欄位:</p>
<figure class="highlight javascript"><figcaption><span>src/components/HelloWorld.vue</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">methods: &#123;</span><br><span class="line">  ...</span><br><span class="line">  clearUsers() &#123;</span><br><span class="line">      <span class="keyword">const</span> client = <span class="keyword">this</span>.$apollo.getClient();</span><br><span class="line">      client.writeQuery(&#123;</span><br><span class="line">        query: gql<span class="string">`query listUsers &#123;</span></span><br><span class="line"><span class="string">          totalUsers</span></span><br><span class="line"><span class="string">          allUsers &#123;</span></span><br><span class="line"><span class="string">            appLogin</span></span><br><span class="line"><span class="string">            name</span></span><br><span class="line"><span class="string">          &#125;</span></span><br><span class="line"><span class="string">        &#125;`</span>,</span><br><span class="line">        data: &#123;</span><br><span class="line">          totalUsers: <span class="number">0</span>,</span><br><span class="line">          allUsers: []</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;  </span><br><span class="line">  &#125;,</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure>

<p>第 6 行使用 client.writeQuery( ) 方法直接更改快取，這裡清除 totalUsers 與 allUsers 欄位。</p>
<p>現在在使用者介面增加一個按鈕來觸發 clearUsers( ):</p>
<figure class="highlight html"><figcaption><span>src/components/HelloWorld.vue</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">"clearUsers"</span>&gt;</span>Click to clear users<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>觸發按鈕修改快取，UI 就會隨著改變，自動更新。</p>
<p>但是這裡要注意的是，因為我們有將 cache 存入 localStorage，當下次重新啟動 app 時，我們之前有在啟動 app 時，將 localStorege 的資料 restore 回 Apollo Cache，所以如果你使用的是預設的 fetchPolicy cache-first 資料將不會更新，會保持在被清除的狀態。所以必須將 fetchPolicy 設定為 cache-and-network。</p>
<figure class="highlight javascript"><figcaption><span>src/components/HelloTainan.vue</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"> ...</span><br><span class="line"> allUsers: &#123;</span><br><span class="line">   query: gql<span class="string">`query listUsers &#123;</span></span><br><span class="line"><span class="string">     totalUsers</span></span><br><span class="line"><span class="string">     allUsers &#123;</span></span><br><span class="line"><span class="string">       appLogin</span></span><br><span class="line"><span class="string">       name</span></span><br><span class="line"><span class="string">     &#125;</span></span><br><span class="line"><span class="string">   &#125;`</span>,</span><br><span class="line">   result (&#123; data, loading &#125;) &#123;   </span><br><span class="line">     <span class="keyword">this</span>.totalUsers = data &amp;&amp; data.totalUsers;</span><br><span class="line">     <span class="keyword">this</span>.loading = loading;</span><br><span class="line">   &#125;,</span><br><span class="line">   fetchPolicy: <span class="string">'cache-and-network'</span></span><br><span class="line"> &#125;,</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>以下是有效的 fetchPolicy 值:</p>
<ul>
<li><p>cache-first：這是預設值，始終嘗試先從快取中讀取數據。如果滿足查詢所需的所有數據都在快取中，則返回該數據。**僅當沒有快取結果時，Apollo 才會從網絡獲取。 此抓取策略旨在最大程度地減少渲染組件時發送的網絡請求的數量。</p>
</li>
<li><p>cache-and-network：此抓取策略將使 Apollo 首先嘗試從快取中讀取數據。如果滿足查詢所需的所有數據都在快取中，則返回該數據。<strong>但是，無論快取中是否有完整數據，該 fetchPolicy 始終會通過網絡執行查詢，這與 cache-first 不同，後者僅在查詢數據不在快取中時才執行查詢</strong>。 此抓取策略優化了用戶的響應速度，同時還嘗試使快取的數據與服務伺服器器數據保持一致，但以額外的網絡請求為代價。</p>
</li>
<li><p>network-only：此抓取策略將永遠不會從快取中返回初始數據。 相反，它將始終使用網絡向服務器發出請求。這種抓取策略可優化與服務器的數據一致性，但是會以對用戶的即時響應為代價。 </p>
</li>
<li><p>cache-only：此抓取策略將永遠不會使用網絡執行查詢。 相反，它將始終嘗試從快取中讀取。如果用於查詢的數據在=快取中不存在，則將引發錯誤。此抓取策略僅允許與本地客戶端快取中的數據進行交互，而不會發出任何的網絡請求，以保持客戶端的組件保持快速的運行，但是這意味著本地數據可能與服務器上的數據不一致。如果只對與 ApolloClient 快取中的數據進行交互感興趣，可使用 ApolloClient 實例的 readQuery( )和 writeQuery( ) 方法。</p>
</li>
<li><p>no-cache：此抓取策略將永遠不會從快取中返回初始數據。相反，它將始終使用網絡向服務器發出請求。<strong>network-only 策略不同，查詢完成後，它也不會將任何數據寫入快取</strong>。</p>
</li>
</ul>
<p>之前我們實作 mutation 時談到了 Optimistic UI update，現在我們可以搭配快取來實作，看看如何改善客戶端的響應。</p>
<figure class="highlight javascript"><figcaption><span>src/components/HelloWorld.vue</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">  methods: &#123;</span><br><span class="line">    addPhoto() &#123;</span><br><span class="line">      <span class="keyword">const</span> newPhoto = &#123;</span><br><span class="line">        name: <span class="string">"範例照片 from Vue mutation !"</span>,</span><br><span class="line">        description: <span class="string">`我們資料庫的範例照片 <span class="subst">$&#123;<span class="keyword">new</span> <span class="built_in">Date</span>().toISOString()&#125;</span>`</span></span><br><span class="line">      &#125;;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">this</span>.$apollo.mutate(&#123;</span><br><span class="line">        mutation: gql<span class="string">`mutation addPhoto($input: PostPhotoInput!) &#123;</span></span><br><span class="line"><span class="string">          postPhoto(input: $input) &#123;</span></span><br><span class="line"><span class="string">            id</span></span><br><span class="line"><span class="string">            name</span></span><br><span class="line"><span class="string">            description</span></span><br><span class="line"><span class="string">          &#125;</span></span><br><span class="line"><span class="string">        &#125;`</span>,</span><br><span class="line">        variables: &#123;</span><br><span class="line">          input: newPhoto,</span><br><span class="line">        &#125;,</span><br><span class="line">        update: <span class="function">(<span class="params">store, &#123; data: &#123; postPhoto &#125;&#125;</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">const</span> LISTPHOTOS_QUERY = gql<span class="string">`query listPhotos &#123;</span></span><br><span class="line"><span class="string">              totalPhotos</span></span><br><span class="line"><span class="string">              allPhotos &#123;</span></span><br><span class="line"><span class="string">                id</span></span><br><span class="line"><span class="string">                name</span></span><br><span class="line"><span class="string">                description</span></span><br><span class="line"><span class="string">              &#125;</span></span><br><span class="line"><span class="string">            &#125;`</span>;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">const</span> cacheData = store.readQuery(&#123;</span><br><span class="line">            query: LISTPHOTOS_QUERY</span><br><span class="line">          &#125;);</span><br><span class="line"></span><br><span class="line">          cacheData.totalPhotos += <span class="number">1</span>;</span><br><span class="line">          cacheData.allPhotos.push(postPhoto);</span><br><span class="line">          </span><br><span class="line">          store.writeQuery(&#123;</span><br><span class="line">            query: LISTPHOTOS_QUERY,</span><br><span class="line">            data: cacheData</span><br><span class="line">          &#125;);</span><br><span class="line">          </span><br><span class="line">          <span class="built_in">console</span>.log(postPhoto);</span><br><span class="line">          <span class="built_in">console</span>.log(cacheData);</span><br><span class="line">        &#125;,</span><br><span class="line">        optimisticResponse: &#123;</span><br><span class="line">          __typename: <span class="string">'Mutation'</span>,</span><br><span class="line">          postPhoto: &#123;</span><br><span class="line">            __typename: <span class="string">'Photo'</span>,</span><br><span class="line">            id: <span class="number">-1</span>,</span><br><span class="line">            ...newPhoto</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;).then(<span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(data);</span><br><span class="line">        <span class="comment">//this.$apollo.queries.allPhotos.refetch();</span></span><br><span class="line">      &#125;).catch(<span class="function">(<span class="params">error</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.error(error);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;,</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>這裡需要花一些時間理解。我們在  this.$apollo.mutate( ) 方法中加入了兩個 hook，分別是 update 與 optimisticResponse。</p>
<p>第 20 行 update 是一個函式，第一個引數 store 就是 Apollo Cache 實例，第二個引數則是執行 mutation 時被回傳的資料。<br>第 30 行從快取中讀取資料，34、35 直接修改讀出來的資料。<br>第 37 行把修改後的資料寫回 Apollo Cache 快取中。<br>第 42、43 把它顯示在 console，我們可以來觀察它們的操作。<br>第 45 行 optimisticResponse 用來提供樂觀的資料。<br>第 55 行我們不再需要從伺服器抓取資料來刷新。</p>
<p>現在可以新增一張新照片，然後從瀏覽器的 console 觀察看看:</p>
<img src="/2019/11/27/GraphQL-Client-2/apollo-mutation-1.png" title="Opitimistic UI">

<p>之前談過，如果 update 與 optimisticResponse 一起用，則 update 會被調用兩次，但是再第二次調用時，第一次調用的資料會被回滾 (rollback)，這裡我們做了兩次 cache 的變動，但第一次的資料自動被回滾了!</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://1184yang.github.io/2019/11/27/GraphQL-Client-2/" data-id="ckcpzj95x000w80vzeeu6of3q" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-GraphQL-Client-1" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/11/13/GraphQL-Client-1/" class="article-date">
  <time datetime="2019-11-13T02:12:01.000Z" itemprop="datePublished">2019-11-13</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/GraphQL/">GraphQL</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/11/13/GraphQL-Client-1/">GraphQL 用戶端 (1)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>完成 GraphQL 伺服器後，接下來要在用戶端設定 GraphQL。基本上，用戶端只是一個與伺服器溝通的 app。因為 GraphQL 的靈活性，你或許會幫網路瀏覽器建構 app、也可能會幫手機建構原生 app，你可以在用戶端用任何一種語言編寫 GraphQL 服務。</p>
<h3 id="使用-GraphQL-API"><a href="#使用-GraphQL-API" class="headerlink" title="使用 GraphQL API"></a>使用 GraphQL API</h3><p>最簡單的起步方式就是直接發一個 HTTP 請求給 GraphQL 端點。</p>
<h4 id="抓取請求"><a href="#抓取請求" class="headerlink" title="抓取請求"></a>抓取請求</h4><p>我們可以用 cURL 來傳送請求給 GraphQL 服務，很多的硬體都有內建 cURL 程式，這意味著，我們可能可以幫冰箱的螢幕建構 GraphQL 服務。你只要設定一些不同的值即可:</p>
<ul>
<li>query: {totalPhotos, totalUsers}</li>
<li>GraphQL 端點: <a href="http://localhost:4000/graphql" target="_blank" rel="noopener">http://localhost:4000/graphql</a></li>
<li>內容型態: Content-Type: application/json</li>
</ul>
<figure class="highlight shell"><figcaption><span>cURL request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST \</span><br><span class="line">     -H "Content-Type: application/json" \</span><br><span class="line">     --data '&#123; "query": "&#123;totalUsers, totalPhotos&#125;" &#125;' \</span><br><span class="line">     http://10.11.100.30:4000/graphql</span><br></pre></td></tr></table></figure>

<p>傳送這個請求後，你應該會在終端機裡面看到正確的 JSON 資料結果:</p>
<figure class="highlight json"><figcaption><span>cURL request result</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">"data"</span>:&#123;<span class="attr">"totalUsers"</span>:<span class="number">3</span>,<span class="attr">"totalPhotos"</span>:<span class="number">45</span>&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>因為我們使用 cURL，所以可以使用 “可傳送 HTTP 請求” 的任何東西。我們改用 fetch 來建立一個在瀏覽器內運作的用戶端:</p>
<figure class="highlight javascript"><figcaption><span>Browser fetch</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> query = <span class="string">`&#123;totalUsers, totalPhotos&#125;`</span>;</span><br><span class="line"><span class="keyword">const</span> url = <span class="string">'http://localhost:4000/graphql'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> opts = &#123;</span><br><span class="line">  method: <span class="string">'POST'</span>,</span><br><span class="line">  headers: &#123; <span class="string">'Content-Type'</span> : <span class="string">'application/json'</span> &#125;,</span><br><span class="line">  body: <span class="built_in">JSON</span>.stringify(&#123; query &#125;)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">fetch(url, opts)</span><br><span class="line">  .then(<span class="function"><span class="params">res</span> =&gt;</span> res.json())</span><br><span class="line">  .then(<span class="built_in">console</span>.log)</span><br><span class="line">  .catch(<span class="built_in">console</span>.error);</span><br></pre></td></tr></table></figure>

<p>抓取資料後，我們可以從流覽器的主控台看到預期的結果:</p>
<figure class="highlight json"><figcaption><span>Browser fetch result</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"data"</span>: &#123;</span><br><span class="line">    <span class="attr">"totalPhotos"</span>: <span class="number">45</span>,</span><br><span class="line">    <span class="attr">"totalUsers"</span>: <span class="number">3</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我們可以使用結果資料來建立 app，直接更改 DOM 列出 totalUsers 與 totalPhotos:</p>
<figure class="highlight javascript"><figcaption><span>GraphQL request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">fetch(url, opts)</span><br><span class="line">  .then(<span class="function"><span class="params">res</span> =&gt;</span> res.json())</span><br><span class="line">  .then(<span class="function">(<span class="params">&#123;data&#125;</span>) =&gt;</span> <span class="string">`</span></span><br><span class="line"><span class="string">    &lt;h1&gt;photos: <span class="subst">$&#123;data.totalPhotos&#125;</span>&lt;/h1&gt;</span></span><br><span class="line"><span class="string">    &lt;h1&gt;users: <span class="subst">$&#123;data.totalUsers&#125;</span>&lt;/h1&gt;</span></span><br><span class="line"><span class="string">  `</span>)</span><br><span class="line">  .then(<span class="function"><span class="params">text</span> =&gt;</span> <span class="built_in">document</span>.body.innerHTML = text)</span><br><span class="line">  .catch(<span class="built_in">console</span>.error);</span><br></pre></td></tr></table></figure>

<p>請小心，當請求完成後，這會覆寫原本在內文中的任何東西。</p>
<p>當你知道如何用你最喜歡的用戶端來傳送 HTTP 請求時，你就擁有一項工具可建立 “可與任何 GraphQL API 溝通的用戶端 app” 了。 但是我們有更強大的 GraphQL 用戶端可用。</p>
<h3 id="Apollo-Client"><a href="#Apollo-Client" class="headerlink" title="Apollo Client"></a>Apollo Client</h3><p>使用 REST 有一個很大的好處在於它可以方便我們處裡快取。使用 REST 時，你可以將請求回應的資料存放在之前用來使用該請求的 URL 底下的快取，這沒甚麼問題。但是在 GraphQL 使用快取有點麻煩。一個 GraphQL API 沒有多個路由，每一個請求都是用單一的端點來傳送與接收的，所以我們無法將路由回傳的資料放在用來請求它的 URL 底下。</p>
<p>為了建立穩健、高性能的 app，我們必須設法將 query 與它們產生的物件存入快取。當我們想要建立快速、高效的 app 時，使用本地化的快取解決方案是必要的做法。我們可以自行建立這類的機制，也可以信賴一些已經經過嚴格審查的用戶端套件。</p>
<p>目前最引人注目的 GraphQL 用戶端解決方案是 Relay 與 Apollo Client。Relay 只與 Facebook 的 React 和 React Native 相容，所以我們選擇使用更廣泛的 Apollo Client。</p>
<p>Apollo Client 是 Meteor Development Group 開發的，它是一種社群驅動的專案，目的是建立靈活的 GraphQL 用戶端解決方案來處理諸如快取、積極 UI 更新 (optimistic UI update) 等工作。這個團隊建立了支援綁定 (binding) 的套件供 React、Angular、Ember、Vue、iOS 與 Android 使用。</p>
<p>我們已經在伺服器用了一些 Apollo 團隊創造的工具了，但 Apollo Client 特別關注請求碼在用戶端與伺服器之間的傳送與接收。它使用 Apollo Link 來處理網路請求，用 Apollo Cache 來處理所有快取。接下來 Apollo Client 會將連結 (Apollo Link) 與快取 (Apollo Cache) 包起來，並高效的管理與 GraphQL 服務的所有互動。</p>
<h3 id="Apollo-Client-和-Vue"><a href="#Apollo-Client-和-Vue" class="headerlink" title="Apollo Client 和 Vue"></a>Apollo Client 和 Vue</h3><p>Apollo Client 是一個 NPM 套件，要在 Web 瀏覽器或移動應用程序中使用此 Apollo Client 客戶端，您需要一個能夠在客戶端上加載 NPM 套件的構建系統。 一些常見的選擇包括 Browserify，Webpack 和 Meteor 1.3+。這理我們選擇使用 Vue 來作為使用者介面程式庫，所以將使用 <a href="https://cli.vuejs.org/" target="_blank" rel="noopener">Vue CLI</a> 來建立 Vue 專案，Vue CLI 使用 WebPack 來做編譯與打包，產生瀏覽器看得懂的部署檔案。</p>
<h4 id="設定專案"><a href="#設定專案" class="headerlink" title="設定專案"></a>設定專案</h4><p>首先使用 Vue CLI 建立一個專案:</p>
<figure class="highlight shell"><figcaption><span>create Vue Project</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vue create vue-apollo-sample</span><br></pre></td></tr></table></figure>

<p>接著切換捯 vue-apollo-sample 資料夾並執行 npm run serve 來啟動 app，現在打開流覽器 <a href="http://localhost:8080/。" target="_blank" rel="noopener">http://localhost:8080/。</a> Vue app 已可以運作。</p>
<h4 id="設置-Apollo-Client"><a href="#設置-Apollo-Client" class="headerlink" title="設置 Apollo Client"></a>設置 Apollo Client</h4><p>為了使用 Apollo 工具來建立 GraphQL 用戶端，你必須安裝一些套件。首先，你需要 graphql 套件，它裡面有 GraphQL 語言解析函式。接著需要一個稱為 apollo-boost 的套件。Apollo Boost 包含建立 Apollo Client 以及傳送操作 (operation) 給伺服器所需的 Apollo 套件。最後需要 vue-apollo。Vue Apollo 是一個 NPM 程式庫，可以整合到 Vue 實例中。我們要利用其中的 Vue 元件與 Apollo 來建構使用者介面。</p>
<figure class="highlight shell"><figcaption><span>npm install</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install graphql apollo-boost vue-apollo</span><br></pre></td></tr></table></figure>

<p>現在可以開始建立用戶端了。apollo-boost 裡面的 ApolloClient 建構式可以用來建立第一個用戶端。打開 HelloWorld.vue，我們就用 Vue CLI 產生的頁面來測試，刪除一些不需要的訊息，然後加入一些程式碼，首先先使用 ApolloClient，稍後再加入 vue-apollo 套件:</p>
<figure class="highlight html"><figcaption><span>src/components/HelloWorld.vue</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"hello"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>&#123;&#123; msg &#125;&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript"><span class="keyword">import</span> ApolloClient, &#123; gql &#125; <span class="keyword">from</span> <span class="string">'apollo-boost'</span></span></span><br><span class="line"></span><br><span class="line"><span class="javascript"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="javascript">  name: <span class="string">'HelloWorld'</span>,</span></span><br><span class="line">  props: &#123;</span><br><span class="line"><span class="javascript">    msg: <span class="built_in">String</span></span></span><br><span class="line">  &#125;,</span><br><span class="line">  created() &#123;</span><br><span class="line"><span class="javascript">    <span class="keyword">const</span> client = <span class="keyword">new</span> ApolloClient(&#123;<span class="attr">uri</span>: <span class="string">'http://localhost:4000/graphql'</span>&#125;);</span></span><br><span class="line"></span><br><span class="line"><span class="javascript">    <span class="keyword">const</span> query = gql<span class="string">`</span></span></span><br><span class="line">      &#123;</span><br><span class="line">        totalUsers</span><br><span class="line">        totalPhotos</span><br><span class="line">      &#125;</span><br><span class="line">    `;</span><br><span class="line"></span><br><span class="line">    client.query(&#123; query &#125;)</span><br><span class="line"><span class="javascript">      .then(<span class="function">(<span class="params">&#123; data &#125;</span>) =&gt;</span> <span class="built_in">console</span>.log(data))</span></span><br><span class="line"><span class="javascript">      .catch(<span class="built_in">console</span>.error);</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>第 16 行我們使用 ApolloClient 建構式建立一個新的 client 實例。這個 client 已經可以處裡和 <a href="http://localhost:4000/graphql" target="_blank" rel="noopener">http://localhost:4000/graphql</a> 上的 GraphQL 服務之間的所有網路通訊了。這裡使用 client 傳送 query 來查詢使用者與照片的總數量。gql 函式屬於 graphql-tag 套件，它會隨著 apollo-boost 套件一起被加入，它的用途是將 query 解析成 AST 或抽象語法樹。第 26 行，我們只是將結果顯示在瀏覽器的 console。</p>
<blockquote>
<p>如果你的瀏覽器出現如下的錯誤，那是因為 Vue CLI 建立的專案 ESLint 預設禁止使用 console.log</p>
</blockquote>
<blockquote>
<pre><code>Failed to compile.

./src/components/HelloWorld.vue
  Module Error (from ./node_modules/eslint-loader/index.js):
  error: Unexpected console statement (no-console) at src\components\HelloWorld.vue:26:27:
    24 | 
    25 |     client.query({ query })
  &gt; 26 |       .then(({ data }) =&gt; console.log(data))
       |                           ^
    27 |       .catch(console.error);
    28 |   }
    29 | }</code></pre></blockquote>
<blockquote>
<p>可修改 package.json eslintConfig:</p>
</blockquote>
<blockquote>
<pre><code>&quot;eslintConfig&quot;: {
    ...
    &quot;rules&quot;: {
      &quot;no-console&quot;: &quot;off&quot;
    },
    ...
  }</code></pre></blockquote>
<p>client.query({ query }) 會用 HTTP 請求 (request) 將 query 送給 GraphQL 服務伺服器，以及解析服務回傳的資料。我們在瀏覽器的主控台應該會有如下的回應:</p>
<figure class="highlight javascript"><figcaption><span>Chrome console</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">totalUsers</span>: <span class="number">3</span>, <span class="attr">totalPhotos</span>: <span class="number">45</span>&#125;</span><br></pre></td></tr></table></figure>

<p>也可以在 HTTP Headers 加入權杖 (token):</p>
<figure class="highlight javascript"><figcaption><span>ApolloClient</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> client = <span class="keyword">new</span> ApolloClient(&#123;</span><br><span class="line">  uri: <span class="string">'http://localhost:4000/graphql'</span>,</span><br><span class="line">  request: <span class="function"><span class="params">operation</span> =&gt;</span> &#123;</span><br><span class="line">    operation.setContext(&#123;</span><br><span class="line">      headers: &#123;</span><br><span class="line">        Authorization: <span class="string">'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhcHBMb2dpbiI6InNjb3R0IiwibmFtZSI6IuiAgeiZjiBTY290dCIsImlhdCI6MTU3MzYwNDUwOSwiZXhwIjoxNTczNjQ3NzA5fQ.3PEtLsXVZqoamXbIO10KTLgwaYBQAGKB4AH0kJXQ4bg'</span></span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>除了處裡送到 GraphQL 服務的網路請求之外，用戶端也會將回應存到本地記憶體快取中。無論何時，我們都可以藉由呼叫 client.extract( ) 來查看快取:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'cache'</span>, client.extract());</span><br><span class="line"></span><br><span class="line">    client.query(&#123;query&#125;)</span><br><span class="line">      .then(<span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">'cache'</span>, client.extract()))</span><br><span class="line">      .catch(<span class="built_in">console</span>.error);</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>第 2 行我們在送出之前查看快取，並且在第 5 行 query 被解析之後再度查看快取，你可以看到，現在結果已經被存在一個由用戶端管理的本地物件裡面了:</p>
<figure class="highlight javascript"><figcaption><span>Client cache</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  ROOT_QUERY: &#123;</span><br><span class="line">    totalUsers: <span class="number">3</span>, </span><br><span class="line">    totalPhotos: <span class="number">45</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下一次我們傳送 query 給用戶端來索取這筆資料時，它會從快取讀出資料，而不是向 GraphQL 服務傳送另一個網路請求。 Apollo Client 可讓我們指定何時以及每隔多久透過網路傳送 HTTP 請求。稍後會討論這些選項。</p>
<p>上面的例子我們只用到 apollo-boost 套件，而且是直接在 Vue 的元件中送出 GraphQL 請求，但是如果你在大部分的 Vue 元件都會使用到 GraphQL 服務，你必須重複產生 ApolloClient 實例，這顯然不是好的方式，你可把 ApolloClient 實例加入 Vue 的全域範圍，但是我們現在要使用一個更強大的套件 <a href="https://vue-apollo.netlify.com/" target="_blank" rel="noopener">Vue Apollo</a> 套件。</p>
<p>這裡我們會建立一個用戶端，並且用一個稱為 apolloProvider 的實例將它加到 Vue 使用者介面。因為我們要將它加入 Vue 的全域範圍，所以要從修改 main.js 開始:</p>
<figure class="highlight javascript"><figcaption><span>src/main.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">'vue'</span></span><br><span class="line"><span class="keyword">import</span> App <span class="keyword">from</span> <span class="string">'./App.vue'</span></span><br><span class="line"><span class="keyword">import</span> VueApollo <span class="keyword">from</span> <span class="string">"vue-apollo"</span></span><br><span class="line"><span class="keyword">import</span> ApolloClient <span class="keyword">from</span> <span class="string">"apollo-boost"</span></span><br><span class="line"></span><br><span class="line">Vue.config.productionTip = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">Vue.use(VueApollo);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> client = <span class="keyword">new</span> ApolloClient(&#123;</span><br><span class="line">  uri: <span class="string">"http://localhost:4000/graphql"</span>,</span><br><span class="line">  request: <span class="function"><span class="params">operation</span> =&gt;</span> &#123;</span><br><span class="line">    operation.setContext(&#123;</span><br><span class="line">      headers: &#123;</span><br><span class="line">        Authorization:</span><br><span class="line">          <span class="string">"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhcHBMb2dpbiI6InNjb3R0IiwibmFtZSI6IuiAgeiZjiBTY290dCIsImlhdCI6MTU3MzYwNDUwOSwiZXhwIjoxNTczNjQ3NzA5fQ.3PEtLsXVZqoamXbIO10KTLgwaYBQAGKB4AH0kJXQ4bg"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> apolloProvider = <span class="keyword">new</span> VueApollo(&#123;</span><br><span class="line">  defaultClient: client</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> Vue(&#123;</span><br><span class="line">  apolloProvider,</span><br><span class="line">  render: <span class="function"><span class="params">h</span> =&gt;</span> h(App),</span><br><span class="line">&#125;).$mount(<span class="string">'#app'</span>)</span><br></pre></td></tr></table></figure>

<p>第 8 行我們調用 Vue.use( ) 全局方法來使用 VueApollo 插件 (Plugin)。第 10 行建立一個客戶端，這與先前的範例沒甚麼不同，接著第  22 行使用 VueApollo 建構式產生一個 apolloProvider 實例，並在第 27 行將它加入 Vue 的全域範圍內，這樣在所有的 Vue 子元件都可以使用這個用戶端，也就是都可以透過 Apollo Client 從 GraphQL 服務接收資料了。</p>
<p>接著我們來看如何從子元件中使用 apolloProvider，我們修改一下 HelloWorld.vue 元件:</p>
<figure class="highlight js"><figcaption><span>src/components/HelloWorld.vue</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; gql &#125; <span class="keyword">from</span> <span class="string">'apollo-boost'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  name: <span class="string">'HelloWorld'</span>,</span><br><span class="line">  props: &#123;</span><br><span class="line">    msg: <span class="built_in">String</span></span><br><span class="line">  &#125;,</span><br><span class="line">  created() &#123;</span><br><span class="line">    <span class="keyword">const</span> query = gql<span class="string">`</span></span><br><span class="line"><span class="string">      &#123;</span></span><br><span class="line"><span class="string">        totalUsers</span></span><br><span class="line"><span class="string">        totalPhotos</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    `</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.$apollo.query(&#123; query &#125;)</span><br><span class="line">      .then(<span class="function">(<span class="params">&#123; data &#125;</span>) =&gt;</span> <span class="built_in">console</span>.log(data))</span><br><span class="line">      .catch(<span class="built_in">console</span>.error);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.$apollo.provider.defaultClient.query(&#123; query &#125;)</span><br><span class="line">      .then(<span class="function">(<span class="params">&#123; data &#125;</span>) =&gt;</span> <span class="built_in">console</span>.log(data))</span><br><span class="line">      .catch(<span class="built_in">console</span>.error);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.$apollo.getClient().query(&#123; query &#125;)</span><br><span class="line">      .then(<span class="function">(<span class="params">&#123; data &#125;</span>) =&gt;</span> <span class="built_in">console</span>.log(data))</span><br><span class="line">      .catch(<span class="built_in">console</span>.error);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>這裡我們不再需要產生 ApolloClient 實例，第 16 行我們直接調用 Vue 全域範圍中的 ApolloClient，你也可以使用第 20 行的  this.$apollo.provider.defaultClient 或第 24 行的  this.$apollo.getClient( ) 方法取得 ApolloClient 實例，現在你可以在所有的 Vue 元件中共用這個 ApolloClient 元件。</p>
<p>這裡我們直接在 Vue 元件的 Created( ) Hook 中送出 GraphQL 請求。但它還有更強大的功能，能與 Vue 結合得更緊密:</p>
<figure class="highlight javascript"><figcaption><span>src/components/HelloWorld.vue</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"hello"</span>&gt;</span><br><span class="line">    &lt;h1&gt;&#123;&#123; msg &#125;&#125;&lt;<span class="regexp">/h1&gt;</span></span><br><span class="line"><span class="regexp">    &lt;h1&gt;&#123;&#123; sayHello &#125;&#125;&lt;/</span>h1&gt;</span><br><span class="line">  &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line"><span class="keyword">import</span> &#123; gql &#125; <span class="keyword">from</span> <span class="string">'apollo-boost'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  name: <span class="string">'HelloWorld'</span>,</span><br><span class="line">  props: &#123;</span><br><span class="line">    msg: <span class="built_in">String</span></span><br><span class="line">  &#125;,</span><br><span class="line">  apollo: &#123;</span><br><span class="line">    sayHello: &#123;</span><br><span class="line">      query: gql<span class="string">`query hello &#123;</span></span><br><span class="line"><span class="string">        sayHello</span></span><br><span class="line"><span class="string">      &#125;`</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure>

<p>第 16 行我們直接在 Vue 元件中加入 apollo 屬性，然後在第 17 行中再加入一個 GraphQL query sayHello 物件，接下來在第 4 行，就可以在 Template 中綁定這個值，這就像使用 Vue 的計算屬性 (computed) 一樣，可以直接把它當成 data 物件的屬性來存取。</p>
<p>但如果 sayHello 屬性需要初始值，也可以明確的定義在 data 物件中:</p>
<figure class="highlight javascript"><figcaption><span>src/components/HelloWorld.vue</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">  props: &#123;</span><br><span class="line">    msg: <span class="built_in">String</span></span><br><span class="line">  &#125;,</span><br><span class="line">  data() &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      sayHello: <span class="literal">undefined</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  apollo: &#123;</span><br><span class="line">    sayHello: &#123;</span><br><span class="line">      query: gql<span class="string">`query hello &#123;</span></span><br><span class="line"><span class="string">        sayHello</span></span><br><span class="line"><span class="string">      &#125;`</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>這裡要注意的是 Vue 的屬性名稱 sayHello 要與 GraphQL 的 Query 同名稱，但如果需要也可以變換名稱，這裡我們將 Vue 的屬性改成 helloTainan:</p>
<figure class="highlight javascript"><figcaption><span>src/components/HelloWorld.vue</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">data() &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      helloTainan: <span class="literal">undefined</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  apollo: &#123;</span><br><span class="line">    helloTainan: &#123;</span><br><span class="line">      query: gql<span class="string">`query hello &#123;</span></span><br><span class="line"><span class="string">        helloTainan: sayHello</span></span><br><span class="line"><span class="string">      &#125;`</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>重點在於第 10 行，不要忘記也要修改 Template 的綁定。</p>
<p>使用 GraphQL 的其中一個好處是你可以使用一個 HTTP 請求建構 UI 所需的每一個東西，並且用一個回應來接收所有的資料，現在我們來加一個同時請求多個 GraphQL 的請求:</p>
<figure class="highlight javascript"><figcaption><span>src/components/HelloWorld.vue</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">  apollo: &#123;</span><br><span class="line">    helloTainan: &#123;</span><br><span class="line">      query: gql<span class="string">`query hello &#123;</span></span><br><span class="line"><span class="string">        helloTainan: sayHello</span></span><br><span class="line"><span class="string">      &#125;`</span></span><br><span class="line">    &#125;,</span><br><span class="line">    allUsers: &#123;</span><br><span class="line">      query: gql<span class="string">`query listUsers &#123;</span></span><br><span class="line"><span class="string">        totalUsers</span></span><br><span class="line"><span class="string">        allUsers &#123;</span></span><br><span class="line"><span class="string">          appLogin</span></span><br><span class="line"><span class="string">          name</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">      &#125;`</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>在 apollo 中新增一個屬性 allUsers，對應到 GraphQL 的一個 query 請求，這個請求同時包含有兩個 GraphQL Query，totalUsers 與 allUsers，這裡要注意，只有 allUsers Query 名稱對應到 Vue 的屬性 allUsers，所以 Vue allUsers 的值會自動對應到 GraphQL Query allUsers 的返回值，那如何取得 totalUsers 的值? Apollo 提供了一個 result Hook:</p>
<figure class="highlight javascript"><figcaption><span>src/components/HelloWorld.vue</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">data() &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    helloTainan: <span class="literal">undefined</span>,</span><br><span class="line">    totalUsers: <span class="literal">undefined</span>,</span><br><span class="line">    loading: <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;,</span><br><span class="line">apollo: &#123;</span><br><span class="line">  ...</span><br><span class="line">  allUsers: &#123;</span><br><span class="line">    query: gql<span class="string">`query listUsers &#123;</span></span><br><span class="line"><span class="string">      totalUsers</span></span><br><span class="line"><span class="string">      allUsers &#123;</span></span><br><span class="line"><span class="string">        appLogin</span></span><br><span class="line"><span class="string">        name</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;`</span>,</span><br><span class="line">    result (&#123; data, loading &#125;) &#123;</span><br><span class="line">      <span class="keyword">this</span>.totalUsers = data.totalUsers;</span><br><span class="line">      <span class="keyword">this</span>.loading = loading;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure>

<p>這裡我們在第 19 行加入了一個 result Hook，他會接受一個物件當引數，其中 data 屬性就包含所有 GraphQL query 的回應資料，這裡會包含兩個 GraphQL Query totalUsers 與 allUsers 的回應資料，而 loading 屬性則告訴我們操作是否正在載入。 </p>
<p>定義在 Vue apollo 屬性中的每個查詢都會被創建成一個智能查詢物件 (SmartQuery)，它包含了一些屬性與方法，例如上面的 loading 就是這個物件的一個屬性，還有包含一些方法可被調用:</p>
<figure class="highlight javascript"><figcaption><span>SmartQuery</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.$apollo.queries.helloTainan.refetch();</span><br></pre></td></tr></table></figure>

<p>你可以加入一個按鈕調用它，會將另一個請求送到 GraphQL 端點來重新抓取資料。</p>
<p>輪詢 (polling) 也是 SmartQuery 物件提供的另一個選擇，當我們在 SmartQuery 物件加入輪詢時，就可以自動每隔一段指定的時間自動重複抓取資料:</p>
<figure class="highlight javascript"><figcaption><span>startPolling and stopPolling</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.$apollo.queries.helloTainan.startPolling(<span class="number">1000</span>); <span class="comment">//ms</span></span><br><span class="line"></span><br><span class="line">setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">this</span>.$apollo.queries.helloTainan.stopPolling();</span><br><span class="line">&#125;, <span class="number">5000</span>);</span><br></pre></td></tr></table></figure>

<p>這裡每秒輪詢一次，5 秒鐘後會停止輪詢。</p>
<p>另外你的 GraphQL 服務如果有提供分頁功能，則可以使用 fetchMore( ) 抓取下一頁的資料。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://1184yang.github.io/2019/11/13/GraphQL-Client-1/" data-id="ckcpzj95y000z80vz0wgmoscn" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-GraphQL-API-6" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/11/11/GraphQL-API-6/" class="article-date">
  <time datetime="2019-11-11T05:06:03.000Z" itemprop="datePublished">2019-11-11</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/GraphQL/">GraphQL</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/11/11/GraphQL-API-6/">建立 GraphQL API (6)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="訂閱-Subscription"><a href="#訂閱-Subscription" class="headerlink" title="訂閱 Subscription"></a>訂閱 Subscription</h3><p>即時更新是現代 web 與行動 app 不可或缺的功能。目前可在網路與行動 app 之間即時傳送資料的技術是 WebSocket。</p>
<p>你可以使用 WebSocket 協定在 TCP 通訊端開啟雙向通訊通道。這意味著網頁與 app 可以透過一個連結(connection)來傳送與接收資料。這項技術可讓你即時且直接從伺服器推送更新到客戶端網頁上。</p>
<p>到目前為止，我們都用 HTTP 協定來實作 GraphQL 查詢與 mutation。HTTP 提供了在用戶端與伺服器之間傳送與接收資料的手法，但它無法協助我們連接伺服器與監聽狀態的改變。在 WebSocket 出現前，監聽伺服器上的狀態改變唯一的方式就是不斷傳送 HTTP 請求給伺服器來確定是不是有所改變，也就是所謂的輪詢 (Long Polling)。</p>
<h4 id="使用訂閱"><a href="#使用訂閱" class="headerlink" title="使用訂閱"></a>使用訂閱</h4><p>在 GraphQL，我們要使用訂閱來監聽 API 以得知特定資料的改變。Apollo Server 已經支援訂閱了。它包裝了一些 npm 套件，可用來設定 GraphQL app 的 WebSocket: <em>graphql-subscriptions</em> 與 <em>subscriptions-transport-ws</em>。</p>
<p>graphql-subscriptions 套件是一種 npm 套件，它提供了一種發佈者/訂閱者 (publisher / subscriber) 設計模式的實作，PubSub。PubSub 是發佈資料變動好讓訂閱的用戶端接收的工具。subscriptions-transport-ws 是一種 WebSocket 伺服端與用戶端，可讓你在 WebSocket 上傳送訂閱。Apollo Server 在一開始就會自動加入這兩個套件來支援訂閱。</p>
<p>在預設情況下，Apollo Server 會在 ws://localhost:4000 設定 WebSocket，所以如果你使用簡單的 Apollo Server 組態，那它已經是個支援 WebSocket 組態了。</p>
<p>因為我們使用 apollo-server-express，所以必須執行一些步驟來讓訂閱開始運作。我們必須修改專案根目錄下的 index.js。 首先從 Node.js 原生的 http 模組匯入 createServer 函式:</p>
<figure class="highlight javascript"><figcaption><span>index.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; createServer &#125; = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br></pre></td></tr></table></figure>

<p>Apollo Server 會自動設定訂閱的支援，但為了執行這項工作，它需要一個 HTTP 伺服器。我們將使用 createServer 來建立一個。在最下端將程式碼改為:</p>
<figure class="highlight javascript"><figcaption><span>index.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> httpServer = createServer(app);</span><br><span class="line">server.installSubscriptionHandlers(httpServer);</span><br><span class="line"></span><br><span class="line">httpServer.listen(&#123; <span class="attr">port</span>: <span class="number">4000</span> &#125;, () =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`GraphQL Server running @ http://localhost:4000<span class="subst">$&#123;server.graphqlPath&#125;</span>`</span>);</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`GraphQL Subscriptions running @ ws://localhost:4000<span class="subst">$&#123;server.subscriptionsPath&#125;</span>`</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>首先，我們用 Express app 實例來建立一個新的 httpServer。依照目前的 Express 組態，這個 httpServer 已經可以處裡收到的所有 HTTP 請求了。我們也有一個伺服器實例，可以在裡面加入 WebSocket 支援。</p>
<p><em>server.installSubscriptionHandlers(httpServer)</em> 是讓 WebSocket 運作的程式。這是 Apollo Server 加入必要的處裡程式來支援使用 WebSocket 的所有訂閱的地方。除了 HTTP 伺服器之外，我們的後端現在已經可以接收 ws://localhost:4000/graphql 的請求了。</p>
<p>讓伺服器支援訂閱之後，接下來我們要實作訂閱。</p>
<h4 id="實作訂閱"><a href="#實作訂閱" class="headerlink" title="實作訂閱"></a>實作訂閱</h4><p>我們想要知道使用者何時張貼照片，這是一個很好的訂閱使用案例。如同 GraphQL 的其它型態，為了實作訂閱，我們必須從 schema 開始著手。我們要在 schema 子目錄下新增一個程式檔 subscription.js 專們來擺放訂閱，這裡要加入一個 subscription 型態:</p>
<figure class="highlight javascript"><figcaption><span>schema/subscription.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; gql &#125; = <span class="built_in">require</span>(<span class="string">"apollo-server-express"</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = gql<span class="string">`</span></span><br><span class="line"><span class="string">  extend type Subscription &#123;</span></span><br><span class="line"><span class="string">    newPhoto: Photo!</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">`</span>;</span><br></pre></td></tr></table></figure>

<p>有了新的 schema 定義，我們也需要修改 schema 目錄下的 index.js 將 subscription.js 匯入，並併接起來 :</p>
<figure class="highlight javascript"><figcaption><span>schema/index.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">const</span> subscriptionSchema = <span class="built_in">require</span>(<span class="string">'./subscription'</span>);</span><br><span class="line">...</span><br><span class="line"><span class="built_in">module</span>.exports = [linkSchema, userSchema, photoSchema, subscriptionSchema];</span><br></pre></td></tr></table></figure>

<p>我們會在照片被加入時使用 newPhoto subscription 來將資料推送到客戶端。我們可以在客戶端用下列的 GraphQL 查詢語言來傳送訂閱操作:</p>
<figure class="highlight plain"><figcaption><span>GraphQL Playground newPhoto subscription</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">subscription &#123;</span><br><span class="line">  newPhoto &#123;</span><br><span class="line">    name</span><br><span class="line">    url</span><br><span class="line">    category</span><br><span class="line">    postedBy &#123;</span><br><span class="line">      appLogin</span><br><span class="line">      name</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>這個 subscription 會將新照片的資料推送到用戶端。如同 Query 與 Mutation，GraphQL 可讓我們用選擇組來請求關於特定欄位的資料。</p>
<p>當客戶端的 subscription 訂閱被送到伺服器時，連結會保持開啟，它會監聽資料的改變，每當照片被加入時，就會將資料傳給訂閱者。當你用 GraphQL Playground 設置訂閱時，會看到 Play 按鈕變成紅色的 Stop 按鈕。</p>
<img src="/2019/11/11/GraphQL-API-6/subscription.png" title="GraphQL Playground subscription">

<p>Stop 按鈕代表訂閱目前是開啟的，並且正在監聽資料。當你按下 Stop 按鈕時，訂閱就會被取消，它會停止監聽資料的改變。</p>
<p>再來我們需要修改 postPhoto mutation，目前這個 mutation 是將新照片加入資料庫。我們想要在這同時將新照片的資料發佈給 subscription:</p>
<figure class="highlight javascript"><figcaption><span>resolvers/photo.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">  Mutation: &#123;</span><br><span class="line">    <span class="keyword">async</span> postPhoto(parent, args, &#123; <span class="attr">db</span> : &#123; photos &#125;, currentUser, pubsub &#125;) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!currentUser) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"only an authorized user can post a photo"</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">let</span> newPhoto = &#123;</span><br><span class="line">        ...args.input,</span><br><span class="line">        appUser: currentUser.appLogin,</span><br><span class="line">        created: <span class="keyword">new</span> <span class="built_in">Date</span>()</span><br><span class="line">      &#125;;</span><br><span class="line">      <span class="keyword">const</span> insertedPhoto = <span class="keyword">await</span> photos.insert(<span class="string">""</span>, newPhoto);</span><br><span class="line">      </span><br><span class="line">      pubsub.publish(<span class="string">'photo-added'</span>, &#123; <span class="attr">newPhoto</span>: insertedPhoto&#125;);</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">return</span> insertedPhoto;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>這個解析函式第 3 行我們在傳入的 context 中多了一個 pubsub 實例，我們會在稍後來作這件事。pubsub 是一種可以發佈事件並傳送資料給訂閱解析函式的機制。它就像 Node.js EventEmitter。你可以用它來發佈事件，並將資料傳給每一個訂閱某個事件的處裡程式。</p>
<p>在這裡第 15 行，我們在將新照片加入資料庫之後發佈一個 photo-added 事件，並將 insertedPhoto 資料傳給訂閱 photo-added 事件的每一個處裡程式。</p>
<p>接下來加入 Subscription 解析函式，它的用途是訂閱 photo-added 事件。與 schema 一樣，我們在 resolvers 子目錄下新建立一個 subscription.js 程式檔:</p>
<figure class="highlight javascript"><figcaption><span>resolvers/subscription.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  Subscription: &#123;</span><br><span class="line">    newPhoto: &#123;</span><br><span class="line">      subscribe: <span class="function">(<span class="params">parent, args, &#123; pubsub &#125;</span>) =&gt;</span></span><br><span class="line">        pubsub.asyncIterator(<span class="string">"photo-added"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>一樣要將它匯入 resolvers 目錄下的 index.js:</p>
<figure class="highlight javascript"><figcaption><span>resolvers/index.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">const</span> subscriptionResolvers = <span class="built_in">require</span>(<span class="string">'./subscription'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = [userResolvers, photoResolvers, subscriptionResolvers];</span><br></pre></td></tr></table></figure>

<p>Subscription 解析函式是根解析函式。你要將它直接加到 Query 與 Mutation 解析函式一樣的物件中。在 Subscription 解析函式中，我們要定義每個欄位的解析函式。因為我們在 schema 裡面定義了 newPhoto 欄位，所以必須確保解析函式裡面有 newPhoto。</p>
<p>與 Query 和 Mutation 不同的是，Subscription 解析函式有一個 subscribe 訂閱方法，與任何其它解析函式一樣，這個 subscribe 方法可接收 parent、args 與 context，我們在這個 subscribe 方法裡面訂閱特定的事件。在本例中，我們使用 pubsub.asyncIterator 來訂閱 photo-added 事件。每當 pubsub 發出 photo-added 事件時，它就會被傳給這個 newPhoto subscription。</p>
<p>postPhoto mutation 解析函式與 newPhoto subscription 解析函式都期望收到 context 中的 pubsub 實例，我們要修改 context 來加入 pubsub 實例。我們要修改專案根目錄下的 index.js，修改後會如下:</p>
<figure class="highlight javascript"><figcaption><span>index.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; createServer &#125; = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; ApolloServer, PubSub &#125; = <span class="built_in">require</span>(<span class="string">'apollo-server-express'</span>);</span><br><span class="line"><span class="keyword">const</span> cors = <span class="built_in">require</span>(<span class="string">'cors'</span>);</span><br><span class="line"><span class="keyword">const</span> db = <span class="built_in">require</span>(<span class="string">'./models/dbs'</span>);</span><br><span class="line"><span class="keyword">const</span> typeDefs = <span class="built_in">require</span>(<span class="string">'./schema'</span>);</span><br><span class="line"><span class="keyword">const</span> resolvers = <span class="built_in">require</span>(<span class="string">'./resolvers'</span>);</span><br><span class="line"><span class="keyword">const</span> userService = <span class="built_in">require</span>(<span class="string">'./services/user.service'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = express();</span><br><span class="line">app.use(cors());</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> context = <span class="keyword">async</span> (&#123; req, connection &#125;) =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> currentUser = <span class="literal">null</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> token = req</span><br><span class="line">      ? req.headers.authorization.split(<span class="string">" "</span>)[<span class="number">1</span>]</span><br><span class="line">      : connection.context.Authorization.split(<span class="string">" "</span>)[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> payload = token &amp;&amp; userService.jwtVerify(token);</span><br><span class="line">    currentUser = payload &amp;&amp; (<span class="keyword">await</span> db.users.findOne(payload.appLogin));</span><br><span class="line">  &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">    currentUser = <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    db,</span><br><span class="line">    userService,</span><br><span class="line">    currentUser,</span><br><span class="line">    pubsub</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> pubsub = <span class="keyword">new</span> PubSub();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> server = <span class="keyword">new</span> ApolloServer(&#123;</span><br><span class="line">  typeDefs,</span><br><span class="line">  resolvers,</span><br><span class="line">  context</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">server.applyMiddleware(&#123; app &#125;);</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/'</span>, (req, res) =&gt; res.end(<span class="string">"Welcome to the GraphQL Sample API"</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> httpServer = createServer(app);</span><br><span class="line">server.installSubscriptionHandlers(httpServer);</span><br><span class="line"></span><br><span class="line">httpServer.listen(&#123; <span class="attr">port</span>: <span class="number">4000</span> &#125;, () =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`GraphQL Server running @ http://localhost:4000<span class="subst">$&#123;server.graphqlPath&#125;</span>`</span>);</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`GraphQL Subscriptions running @ ws://localhost:4000<span class="subst">$&#123;server.subscriptionsPath&#125;</span>`</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>首先在第 3 行從 apollo-server-express 套件匯入 PubSub 建構式，在第 35 行我們使用這個建構式建立一個 pubsub 實例，再來就要修改 context 函式將 pubsub 加入 context。</p>
<p>在第 13 行我們加入了一個 connection 引數，query 與 mutation 仍然使用 HTTP 協定，當我們傳送這些操作 (operation) 給 GraphQL 伺服器時，HTTP 請求會帶有兩個引數物件 req 與 res，這裡 req 會被送到 context 函式；但是當操作是 Subscription 時沒有 HTTP 請求，所以 req 引數會是 null，在此會改用 WebSocket connection 物件當成引數傳給 context 函式。所以當我們有訂閱時，必須透過 connection 的 context 來傳送授權 (token) 資料，而不是透過 HTTP 請求標頭 (HTTP headers) 的 Authorization。所以同時得修改第 17 行的 token 設定值。</p>
<p>現在可以使用 GraphQL Playground 來試一下訂閱功能了。</p>
<figure class="highlight plain"><figcaption><span>GraphQL Playground newPhoto subscription</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">subscription &#123;</span><br><span class="line">  newPhoto &#123;</span><br><span class="line">    name</span><br><span class="line">    url</span><br><span class="line">    category</span><br><span class="line">    created</span><br><span class="line">    postedBy &#123;</span><br><span class="line">      appLogin</span><br><span class="line">      name</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>開啟另外一個 GraphQL Playground 頁籤執行 postPhoto mutation:</p>
<figure class="highlight plain"><figcaption><span>GraphQL Playground postPhoto mutation</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mutation newPhoto($input: PostPhotoInput!) &#123;</span><br><span class="line">  postPhoto(input: $input) &#123;</span><br><span class="line">    id</span><br><span class="line">    name</span><br><span class="line">    url</span><br><span class="line">    description</span><br><span class="line">    category</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>記得在 QUERY VARIABLES 加入 JSON 資料:</p>
<figure class="highlight json"><figcaption><span>GraphQL Playground QUERY VARIABLES:</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"input"</span>: &#123;</span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"範例照片 ABCD EFG"</span>,</span><br><span class="line">    <span class="attr">"description"</span>: <span class="string">"我們資料庫的範例照片"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>每當你執行這個 mutation 時，就會看到新的照片資料被送到訂閱。</p>
<p style="text-align: right;">接續下一篇 <a href="/2019/12/05/GraphQL-API-7/" title="建立 GraphQL API (7)">建立 GraphQL API (7)</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://1184yang.github.io/2019/11/11/GraphQL-API-6/" data-id="ckcpzj95r000l80vz03wqmtlg" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-GraphQL-API-5" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/11/07/GraphQL-API-5/" class="article-date">
  <time datetime="2019-11-07T00:55:56.000Z" itemprop="datePublished">2019-11-07</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/GraphQL/">GraphQL</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/11/07/GraphQL-API-5/">建立 GraphQL API (5)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="認證-Authentication"><a href="#認證-Authentication" class="headerlink" title="認證 Authentication"></a>認證 Authentication</h3><p>GraphQL 中的身份驗證是一個熱門話題。沒有固定的做法，但許多應用程序都有這樣的需求。GraphQL 本身並不反對認證，因為它只是一種查詢語言。如果您想在 GraphQL 中進行身份驗證，請考慮使用 GraphQL mutations。</p>
<p>接下來，我們要使用簡約方法向 GraphQL 伺服務器添加身份驗證，這可以讓使用者登錄 (sign in) 到您的應用程序。</p>
<p>首先我們要新增一個使用者認證服務，並在原來的使用者資料庫中新增一個 password 欄位用來做認證用與一個 roles 欄位做授權。</p>
<p>新增一個子目錄 services 並新增一個程式檔案 user.service.js。這裡須要使用兩個 Node.js 套件，分別用來做密碼與權杖的加密與驗證:</p>
<figure class="highlight bash"><figcaption><span>npm install</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install bcryptjs --save</span><br><span class="line">npm install jsonwebtoken --save</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><figcaption><span>services/user.service.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> bcrypt = <span class="built_in">require</span>(<span class="string">"bcryptjs"</span>);</span><br><span class="line"><span class="keyword">const</span> jwt = <span class="built_in">require</span>(<span class="string">"jsonwebtoken"</span>);</span><br><span class="line"><span class="keyword">const</span> jwtSecretKey = <span class="string">"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9"</span>;</span><br><span class="line"><span class="keyword">const</span> &#123; users &#125; = <span class="built_in">require</span>(<span class="string">"../models/dbs"</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">authenticate</span>(<span class="params">username, password</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> username !== <span class="string">"string"</span> || <span class="keyword">typeof</span> password !== <span class="string">"string"</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Promise</span>.reject(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"Username or password is incorrect"</span>));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> users.findOne(username)</span><br><span class="line">    .then(<span class="function"><span class="params">result</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (result.appLogin === username) &#123;</span><br><span class="line">        <span class="keyword">return</span> passwordVerify(result, password)</span><br><span class="line">          .then(<span class="function"><span class="params">result</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> token = jwt.sign(</span><br><span class="line">              &#123;</span><br><span class="line">                appLogin: result.appLogin,</span><br><span class="line">                name: result.name</span><br><span class="line">              &#125;,</span><br><span class="line">              jwtSecretKey,</span><br><span class="line">              &#123; <span class="attr">expiresIn</span>: <span class="string">"12h"</span> &#125;</span><br><span class="line">            );</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">              user: &#123;</span><br><span class="line">                appLogin: result.appLogin,</span><br><span class="line">                name: result.name,</span><br><span class="line">                roles: result.roles</span><br><span class="line">              &#125;,</span><br><span class="line">              token: token</span><br><span class="line">            &#125;;</span><br><span class="line">          &#125;)</span><br><span class="line">          .catch(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"Username or password is incorrect"</span>);</span><br><span class="line">          &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    .catch(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"Username or password is incorrect"</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">passwordVerify</span>(<span class="params">user, password</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!user) &#123;</span><br><span class="line">      <span class="keyword">return</span> reject(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"Parameters error"</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> password !== <span class="string">"string"</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">Promise</span>.reject(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"Parameters error"</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (validPassword(password, user.password)) &#123;</span><br><span class="line">      <span class="keyword">return</span> resolve(user);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> reject(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"Username or password is incorrect"</span>));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">validPassword</span>(<span class="params">password, hash</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> bcrypt.compareSync(password, hash);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">jwtVerify</span>(<span class="params">token</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> payload;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!token) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"Authentication failed"</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    payload = jwt.verify(token, jwtSecretKey);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    <span class="keyword">if</span> (err.name === <span class="string">"TokenExpiredError"</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"Token Expired"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"Authentication failed"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> payload;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">resetPassword</span>(<span class="params">id, password</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!id || !password) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Promise</span>.reject(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"Parameters error"</span>));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> users.findOne(id)</span><br><span class="line">    .then(<span class="function"><span class="params">result</span> =&gt;</span> &#123;</span><br><span class="line">      result[<span class="string">"password"</span>] = setPassword(password);</span><br><span class="line">      <span class="keyword">return</span> users.update(result.appLogin, result);</span><br><span class="line">    &#125;)</span><br><span class="line">    .then(<span class="function"><span class="params">()</span> =&gt;</span> <span class="string">"Password changed"</span>)</span><br><span class="line">    .catch(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">throw</span> err;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setPassword</span>(<span class="params">password</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> bcrypt.hashSync(password, <span class="number">10</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  authenticate,</span><br><span class="line">  jwtVerify,</span><br><span class="line">  setPassword,</span><br><span class="line">  resetPassword</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>現在可以使用這個服務來將資料庫中的使用者新增一個 password 欄位與 roles 欄位。</p>
<p>因為我們的 LevelDB 是崁入式的資料庫，不能同時由兩個 Node.js 行程開啟資料庫，所以必須先停下 Apollo Server，再執行下面程式碼更新資料庫 users 資料庫:</p>
<figure class="highlight javascript"><figcaption><span>models/useful/dbs-update-users.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; users &#125; = <span class="built_in">require</span>(<span class="string">'../dbs'</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; setPassword &#125; = <span class="built_in">require</span>(<span class="string">'../../services/user.service'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> data = &#123;</span><br><span class="line">  blake: &#123; <span class="attr">password</span>: <span class="string">'changeonlogin'</span>, <span class="attr">roles</span>: [<span class="string">'developer'</span>, <span class="string">'demo'</span>]&#125;,</span><br><span class="line">  james: &#123; <span class="attr">password</span>: <span class="string">'changeonlogin'</span>, <span class="attr">roles</span>: [<span class="string">'user'</span>, <span class="string">'demo'</span>]&#125;,</span><br><span class="line">  scott: &#123; <span class="attr">password</span>: <span class="string">'tiger'</span>, <span class="attr">roles</span>: [<span class="string">'admin'</span>]&#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">users.findAll().then(<span class="function"><span class="params">result</span> =&gt;</span> &#123;</span><br><span class="line">  result.map(<span class="function"><span class="params">value</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> user = &#123;</span><br><span class="line">      ...value,</span><br><span class="line">      password: setPassword(data[value.appLogin].password),</span><br><span class="line">      roles: data[value.appLogin].roles </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> user;</span><br><span class="line">  &#125;)</span><br><span class="line">  .forEach(<span class="function"><span class="params">value</span> =&gt;</span> &#123;</span><br><span class="line">    users.update(value.appLogin, value)</span><br><span class="line">      .then(<span class="built_in">console</span>.log)</span><br><span class="line">      .catch(<span class="built_in">console</span>.log);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>第 7 行，新增一個 password 欄位，預設值設為 “changeonlogin”，加密儲存回資料庫。 </p>
<p>現在資料庫裡的資料應該如下:</p>
<figure class="highlight javascript"><figcaption><span>LevelDB usersDb </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    id: <span class="string">'blake'</span>,</span><br><span class="line">    appLogin: <span class="string">'blake'</span>,</span><br><span class="line">    name: <span class="string">'葛蘭特 Blake'</span>,</span><br><span class="line">    password: <span class="string">'$2a$10$OqyTUxbgA.qds4Cn8tUXa.xgK2OtYUTuombk/Mu.bEXti3LkTG3bu'</span>,</span><br><span class="line">    roles: [ <span class="string">'developer'</span>, <span class="string">'demo'</span> ]</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    id: <span class="string">'james'</span>,</span><br><span class="line">    appLogin: <span class="string">'james'</span>,</span><br><span class="line">    name: <span class="string">'麥克 James'</span>,</span><br><span class="line">    password: <span class="string">'$2a$10$v8ee6guXTOgMWkz6oy0Nr.F1G8Io4o0vk1V2BB5WEDka/nudj31nK'</span>,</span><br><span class="line">    roles: [ <span class="string">'user'</span>, <span class="string">'demo'</span> ]</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    id: <span class="string">'scott'</span>,</span><br><span class="line">    appLogin: <span class="string">'scott'</span>,</span><br><span class="line">    name: <span class="string">'老虎 Scott'</span>,</span><br><span class="line">    password: <span class="string">'$2a$10$o1cpCMZJvNyeO63hFqGvC.plFrNUA9pigbWmOTdijVOLN4z2DC5p6'</span>,</span><br><span class="line">    roles: [ <span class="string">'admin'</span> ]</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>因為我們在資料庫中加入了 roles 欄位，因此也需要修改 User 使用者型態將 roles 欄位加入，roles 欄位是一個內涵 String 的陣列，而我們就用他預設的解析函式就可以了:</p>
<figure class="highlight javascript"><figcaption><span>schema/user.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">  type User &#123;</span><br><span class="line">    appLogin: ID!</span><br><span class="line">    name: <span class="built_in">String</span></span><br><span class="line">    avatar: <span class="built_in">String</span></span><br><span class="line">    roles: [<span class="built_in">String</span>!]!</span><br><span class="line">    postedPhotos: [Photo!]!</span><br><span class="line">    inPhotos: [Photo!]!</span><br><span class="line">  &#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>現在我們可以來加入認證的機制，首先將認證服務 userService 加入 context 中，這要修改專案根目錄下的 index.js:</p>
<figure class="highlight javascript"><figcaption><span>index.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">const</span> userService = <span class="built_in">require</span>(<span class="string">'./services/user.service'</span>);</span><br><span class="line">...</span><br><span class="line"><span class="keyword">const</span> context = &#123;</span><br><span class="line">  db,</span><br><span class="line">  userService</span><br><span class="line">&#125;;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>我們要用 mutation 來處裡使用者認證，在 User schema 中設計一個自訂的承載類型 (payload type) AuthPayload 與 appAuth mutation:</p>
<figure class="highlight javascript"><figcaption><span>schema/user.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"></span><br><span class="line">extend type Mutation &#123;</span><br><span class="line">  appAuth(login: <span class="built_in">String</span>! password: <span class="built_in">String</span>): AuthPayload!</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">type AuthPayload &#123;</span><br><span class="line">  user: User!</span><br><span class="line">  token: <span class="built_in">String</span>!</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>在對應的解析函式加入實際的執行碼:</p>
<figure class="highlight javascript"><figcaption><span>resolves/user.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">Mutation: &#123;</span><br><span class="line">  appAuth(parent, &#123; <span class="attr">login</span>: username, password &#125;, &#123; userService &#125;) &#123;</span><br><span class="line">    <span class="keyword">return</span> userService.authenticate(username, password)</span><br><span class="line">      .then(<span class="function"><span class="params">results</span> =&gt;</span> results);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;,</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>現在可從 GraphQL Playground 客戶端測試看看:</p>
<figure class="highlight javascript"><figcaption><span>GraphQL Playground appAuth mutation</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mutation authentication &#123;</span><br><span class="line">  appAuth(login: <span class="string">"blake"</span> password: <span class="string">"changeonlogin"</span>) &#123;</span><br><span class="line">    user &#123;</span><br><span class="line">      appLogin</span><br><span class="line">      name</span><br><span class="line">    &#125;</span><br><span class="line">    token</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><figcaption><span>GraphQL Playground results</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"data"</span>: &#123;</span><br><span class="line">    <span class="attr">"appAuth"</span>: &#123;</span><br><span class="line">      <span class="attr">"user"</span>: &#123;</span><br><span class="line">        <span class="attr">"appLogin"</span>: <span class="string">"blake"</span>,</span><br><span class="line">        <span class="attr">"name"</span>: <span class="string">"葛蘭特 Blake"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"token"</span>: <span class="string">"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhcHBMb2dpbiI6ImJsYWtlIiwibmFtZSI6IuiRm-iYreeJuSBCbGFrZSIsImlhdCI6MTU3MzE3MDgwMSwiZXhwIjoxNTczMjE0MDAxfQ.eqrwtifdL-ZdOLL8deS547HhirWK59UbDOTOYUshgTc"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我們將使用認證成功後返回的資料中所含的權杖 <strong>token</strong> 來做驗證與授權。</p>
<p>在未來的請求中證明自己的身分，你必須在每個請求的 HTTP Headers 的 Authorization 中傳送你自己的權杖，這個權杖會被用來查看使用者的資料庫紀錄來辨識與授權。</p>
<p>GraphQL Playground 有個地方可讓你為每個請求加入標頭 (HTTP Headers)。在左下方角落的 “QUERY VARIABLES” 旁邊有個 “HTTP HEADERS” 標籤，你可以使用這個標籤在請求中加入 HTTP Headers。用 JSON 來傳送標頭:</p>
<figure class="highlight json"><figcaption><span>HTTP Headers</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"Authorization"</span>: <span class="string">"Bearer &lt;YOUR_TOKEN&gt;"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>請將 &lt;YOUR_TOKEN&gt; 換成 appAuth mutation 回傳的權杖。現在你可以連同每一個 GraphQL 請求一起來識別你。GraphQL 伺服器會使用權杖的資料從資料庫中找到你的帳號並將它加入 GraphQL 的 context 中，解析函式就可以用來判斷使用者的授權權限。</p>
<p>接下來，我們要建立一個參考我們自己的使用者資訊的 query: <em>me</em> query。這個 query 會根據 HTTP 標頭傳送的權杖來回傳當前登入的使用者。如果目前沒有使用者登入，這個 query 會回傳 null。這將會是代表經過身份驗證的用戶。</p>
<p>在這個程序一開始，用戶端同時傳送 GraphQL query me 和保護使用者資訊的 Authorization: token。接下來 API 會捕捉 Authorization 標頭，並使用權杖在資料庫中查看當前使用者的紀錄資料，也會將當前使用者帳號加入 context。帳號被加入 context 後，所有的解析函式就可以讀取當前的使用者了。</p>
<p>我們要改變 context 物件的建構方式，使用<strong>函式</strong>來處理 context，而不是直接使用物件。</p>
<figure class="highlight javascript"><figcaption><span>index.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">const</span> context = <span class="keyword">async</span> (&#123; req &#125;) =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> currentUser = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">let</span> token = req.headers.authorization.split(<span class="string">" "</span>)[<span class="number">1</span>];</span><br><span class="line">      <span class="keyword">let</span> payload = token &amp;&amp; userService.jwtVerify(token);</span><br><span class="line">      currentUser = payload &amp;&amp; (<span class="keyword">await</span> db.users.findOne(payload.appLogin));</span><br><span class="line">  &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">    currentUser = <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    db,</span><br><span class="line">    userService,</span><br><span class="line">    currentUser</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> server = <span class="keyword">new</span> ApolloServer(&#123;</span><br><span class="line">  typeDefs,</span><br><span class="line">  resolvers,</span><br><span class="line">  context</span><br><span class="line">&#125;);</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>context 可以是物件或函式，它會在每一次有請求時設定 context。當 context 是函式時，每當有 GraphQL 請求時，它都會被呼叫。這個函式回傳的物件是被送給解析函式的 context。</p>
<p>context 設定好之後，就可加入 me query 與對映的解析函式:</p>
<figure class="highlight javascript"><figcaption><span>schema/user.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">extend type Query &#123;</span><br><span class="line">    me: User</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>me 的解析函式:</p>
<figure class="highlight js"><figcaption><span>resolvers/user.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">  Query: &#123;</span><br><span class="line">    me: <span class="function">(<span class="params">parent, args, &#123; currentUser &#125;</span>) =&gt;</span> currentUser,</span><br><span class="line">    ...</span><br><span class="line">  &#125;,</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>現在可來使用 me query 傳送一個請求來取得關於你自己的資料，記得 HTTP Headers 裡面要有正確的權杖，使用錯誤的權杖或沒有授權標頭時，你會看到 me query 是 null。</p>
<figure class="highlight javascript"><figcaption><span>GraphQL Playground query me</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">query currentUser &#123;</span><br><span class="line">  me &#123;</span><br><span class="line">    appLogin</span><br><span class="line">    name</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><figcaption><span>GraphQL Playground HTTP HEADERS</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"Authorization"</span>: <span class="string">"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhcHBMb2dpbiI6ImJsYWtlIiwibmFtZSI6IuiRm-iYreeJuSBCbGFrZSIsImlhdCI6MTU3MzE4Mzg3MSwiZXhwIjoxNTczMjI3MDcxfQ.n8msSCdRNlj9lM99Iqw7Mey-wec_zroqBEUKYojC8-A"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><figcaption><span>GraphQL Playground query me result</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"data"</span>: &#123;</span><br><span class="line">    <span class="attr">"me"</span>: &#123;</span><br><span class="line">      <span class="attr">"appLogin"</span>: <span class="string">"blake"</span>,</span><br><span class="line">      <span class="attr">"name"</span>: <span class="string">"葛蘭特 Blake"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>你甚至可以查你自己其它的資料:</p>
<figure class="highlight"><figcaption><span>GraphQL Playground query me</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">query currentUser &#123;</span><br><span class="line">  me &#123;</span><br><span class="line">    appLogin</span><br><span class="line">    name</span><br><span class="line">    postedPhotos &#123;</span><br><span class="line">      name</span><br><span class="line">    &#125;</span><br><span class="line">    inPhotos &#123;</span><br><span class="line">      name</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><figcaption><span>GraphQL Playground query me result</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"data"</span>: &#123;</span><br><span class="line">    <span class="attr">"me"</span>: &#123;</span><br><span class="line">      <span class="attr">"appLogin"</span>: <span class="string">"blake"</span>,</span><br><span class="line">      <span class="attr">"name"</span>: <span class="string">"葛蘭特 Blake"</span>,</span><br><span class="line">      <span class="attr">"postedPhotos"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">"name"</span>: <span class="string">"Dropping the Heart Chute"</span></span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">"inPhotos"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">"name"</span>: <span class="string">"Dropping the Heart Chute"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">"name"</span>: <span class="string">"Enjoying the sunshine"</span></span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="postPhoto-mutation"><a href="#postPhoto-mutation" class="headerlink" title="postPhoto mutation"></a>postPhoto mutation</h3><p>使用者必須先登入才能將照片貼到我們的 app，postPhoto mutation 可以藉由檢查 context 來確定登入的是誰。我們來修改 postPhoto mutation:</p>
<figure class="highlight javascript"><figcaption><span>resolvers/photo.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">  Mutation: &#123;</span><br><span class="line">    <span class="keyword">async</span> postPhoto(parent, args, &#123; <span class="attr">db</span> : &#123; photos &#125;, currentUser &#125;) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!currentUser) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"only an authorized user can post a photo"</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">let</span> newPhoto = &#123;</span><br><span class="line">        ...args.input,</span><br><span class="line">        appUser: currentUser.appLogin,</span><br><span class="line">        created: <span class="keyword">new</span> <span class="built_in">Date</span>()</span><br><span class="line">      &#125;;</span><br><span class="line">      <span class="keyword">const</span> insertedPhoto = <span class="keyword">await</span> photos.insert(<span class="string">""</span>, newPhoto);</span><br><span class="line">      <span class="keyword">return</span> insertedPhoto;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>第 4 行我們判斷是不是有效的使用者，如果不是，拋出一個錯誤，程序即會中斷執行，這是最簡單的授權驗證，可加入角色 (roles) 做更細微的控管。</p>
<p>最後的 resolvers/photo.js 如下:</p>
<figure class="highlight javascript"><figcaption><span>resolvers/photo.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; GraphQLScalarType &#125; = <span class="built_in">require</span>(<span class="string">"graphql"</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  Query: &#123;</span><br><span class="line">    totalPhotos: <span class="function">(<span class="params">parent, args, &#123; db: &#123; photos &#125; &#125;</span>) =&gt;</span> photos.allCount().then(<span class="function"><span class="params">value</span> =&gt;</span> value),</span><br><span class="line">    allPhotos: <span class="function">(<span class="params">parent, args, &#123; db: &#123; photos &#125; &#125;</span>) =&gt;</span> photos.findAll()</span><br><span class="line">  &#125;,</span><br><span class="line">  Mutation: &#123;</span><br><span class="line">    <span class="keyword">async</span> postPhoto(parent, args, &#123; <span class="attr">db</span> : &#123; photos &#125;, currentUser &#125;) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!currentUser) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"only an authorized user can post a photo"</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">let</span> newPhoto = &#123;</span><br><span class="line">        ...args.input,</span><br><span class="line">        appUser: currentUser.appLogin,</span><br><span class="line">        created: <span class="keyword">new</span> <span class="built_in">Date</span>()</span><br><span class="line">      &#125;;</span><br><span class="line">      <span class="keyword">const</span> insertedPhoto = <span class="keyword">await</span> photos.insert(<span class="string">""</span>, newPhoto);</span><br><span class="line">      <span class="keyword">return</span> insertedPhoto;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  Photo: &#123;</span><br><span class="line">    url: <span class="function"><span class="params">parent</span> =&gt;</span> <span class="string">`https://fakeimg.pl/120x160/?text=<span class="subst">$&#123;parent.id&#125;</span>`</span>,</span><br><span class="line">    postedBy: <span class="function">(<span class="params">parent, args, &#123; db: &#123; users &#125; &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> users.findOne(parent.appUser).then(<span class="function"><span class="params">value</span> =&gt;</span> value);</span><br><span class="line">    &#125;,</span><br><span class="line">    taggedUsers: <span class="function">(<span class="params">parent, args, &#123; db: &#123; users, tags &#125; &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> tags.findAll().then(<span class="function"><span class="params">result</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line">          .filter( <span class="function"><span class="params">tag</span> =&gt;</span> tag.photoID === parent.id)</span><br><span class="line">          .map(<span class="function"><span class="params">tag</span> =&gt;</span> tag.userID)</span><br><span class="line">          .map(<span class="function"><span class="params">userID</span> =&gt;</span> users.findOne(userID));</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  DateTime: <span class="keyword">new</span> GraphQLScalarType(&#123;</span><br><span class="line">    name: <span class="string">"DateTime"</span>,</span><br><span class="line">    description: <span class="string">"有效的日期時間值"</span>,</span><br><span class="line">    parseValue: <span class="function"><span class="params">value</span> =&gt;</span> <span class="keyword">new</span> <span class="built_in">Date</span>(value),</span><br><span class="line">    serialize: <span class="function"><span class="params">value</span> =&gt;</span> <span class="keyword">new</span> <span class="built_in">Date</span>(value).toISOString(),</span><br><span class="line">    parseLiteral: <span class="function"><span class="params">ast</span> =&gt;</span> ast.value</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>現在可以將新照片貼到 GraphQL 服務了。</p>
<figure class="highlight plain"><figcaption><span>GraphQL Playground mutation newPhoto</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mutation newPhoto($input: PostPhotoInput!) &#123;</span><br><span class="line">  postPhoto(input: $input) &#123;</span><br><span class="line">    id</span><br><span class="line">    name</span><br><span class="line">    url</span><br><span class="line">    description</span><br><span class="line">    category</span><br><span class="line">    created</span><br><span class="line">    postedBy &#123;</span><br><span class="line">      name</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我們也必須在 Query Variables 面板中傳送對應的 PostPhotoInput JSON:</p>
<figure class="highlight json"><figcaption><span>GraphQL Playground VARIABLES mutation newPhoto input</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"input"</span>: &#123;</span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"範例照片 ABC"</span>,</span><br><span class="line">    <span class="attr">"description"</span>: <span class="string">"我們資料庫的範例照片"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="從客戶端使用-GraphQL-API"><a href="#從客戶端使用-GraphQL-API" class="headerlink" title="從客戶端使用 GraphQL API"></a>從客戶端使用 GraphQL API</h4><p>到目前為止我們都是從 GraphQL Playground 測試 GraphQL 伺服器，現在看看如何從 Web app 將新照片貼到 GraphQL 服務。</p>
<p>首先需要認證，這是一段認證的範例函式:</p>
<figure class="highlight javascript"><figcaption><span>authentication function appAuth  </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">appAuth</span>(<span class="params">username, password</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> query = <span class="string">`mutation login &#123;</span></span><br><span class="line"><span class="string">    appAuth(login: "<span class="subst">$&#123;username&#125;</span>" password: "<span class="subst">$&#123;password&#125;</span>") &#123;</span></span><br><span class="line"><span class="string">      user &#123;</span></span><br><span class="line"><span class="string">        name</span></span><br><span class="line"><span class="string">        appLogin</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">      token</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;`</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> endpoint = <span class="string">"http://localhost:4000/graphql"</span>;</span><br><span class="line">  <span class="keyword">const</span> opts = &#123;</span><br><span class="line">    method: <span class="string">"POST"</span>,</span><br><span class="line">    headers: &#123;</span><br><span class="line">      <span class="string">"Content-Type"</span>: <span class="string">"application/json"</span>,</span><br><span class="line">      <span class="string">"Accept"</span>: <span class="string">"application/json"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    body: <span class="built_in">JSON</span>.stringify(&#123; query &#125;)</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  fetch(endpoint, opts)</span><br><span class="line">    .then(<span class="function"><span class="params">res</span> =&gt;</span> res.json())</span><br><span class="line">    .then(<span class="function">(<span class="params">&#123; data: &#123; appAuth &#125; &#125;</span>) =&gt;</span> localStorage.setItem(<span class="string">'token'</span>, appAuth.token))</span><br><span class="line">    .catch(<span class="built_in">console</span>.error);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果認證成功，會將權杖存到 localStorage。然後就可以使用此權杖執行 mutation postPhoto 貼上新照片。</p>
<p>以下則是一段貼上新照片的範例函式:</p>
<figure class="highlight javascript"><figcaption><span>post new Photo function </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">postPhoto</span> (<span class="params">newPhoto</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> query = <span class="string">`mutation newPhoto($input: PostPhotoInput!) &#123;</span></span><br><span class="line"><span class="string">    postPhoto(input: $input) &#123;</span></span><br><span class="line"><span class="string">      id</span></span><br><span class="line"><span class="string">      name</span></span><br><span class="line"><span class="string">      url</span></span><br><span class="line"><span class="string">      description</span></span><br><span class="line"><span class="string">      category</span></span><br><span class="line"><span class="string">      created</span></span><br><span class="line"><span class="string">      postedBy &#123;</span></span><br><span class="line"><span class="string">        name</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;`</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> url = <span class="string">"http://localhost:4000/graphql"</span>;</span><br><span class="line">  <span class="keyword">const</span> opts = &#123;</span><br><span class="line">    method: <span class="string">"POST"</span>,</span><br><span class="line">    headers: &#123;</span><br><span class="line">      <span class="string">"Content-Type"</span>: <span class="string">"application/json"</span>,</span><br><span class="line">      <span class="string">"Accept"</span>: <span class="string">"application/json"</span>,</span><br><span class="line">      <span class="string">"Authorization"</span>: <span class="string">`Bearer <span class="subst">$&#123;localStorage.getItem(<span class="string">'token'</span>)&#125;</span>`</span></span><br><span class="line">    &#125;,</span><br><span class="line">    body: <span class="built_in">JSON</span>.stringify(&#123;</span><br><span class="line">      query: query,</span><br><span class="line">      variables: &#123; <span class="attr">input</span>: newPhoto &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  fetch(url, opts)</span><br><span class="line">    .then(<span class="function"><span class="params">res</span> =&gt;</span> res.json())</span><br><span class="line">    .then(<span class="built_in">console</span>.log)</span><br><span class="line">    .catch(<span class="built_in">console</span>.error);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>現在可以執行這兩段函式:</p>
<figure class="highlight javascript"><figcaption><span>post photo</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// authentication</span></span><br><span class="line">appAuth(<span class="string">'blake'</span>, <span class="string">'changeonlogin'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// post new photo</span></span><br><span class="line"><span class="keyword">const</span> newPhoto = &#123;</span><br><span class="line">  name: <span class="string">"範例照片從瀏覽器使用 ajax"</span>,</span><br><span class="line">  description: <span class="string">"我們資料庫的範例照片 from browser using ajax"</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">postPhoto(newPhoto);</span><br></pre></td></tr></table></figure>

<p>你已經建立一個 GraphQL 伺服器了! Go! GraphQL! </p>
<p style="text-align: right;">接續下一篇 <a href="/2019/11/11/GraphQL-API-6/" title="建立 GraphQL API (6)">建立 GraphQL API (6)</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://1184yang.github.io/2019/11/07/GraphQL-API-5/" data-id="ckcpzj95s000o80vzmjzzxc7y" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-GraphQL-API-4" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/11/07/GraphQL-API-4/" class="article-date">
  <time datetime="2019-11-07T00:55:21.000Z" itemprop="datePublished">2019-11-07</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/GraphQL/">GraphQL</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/11/07/GraphQL-API-4/">建立 GraphQL API (4)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="context"><a href="#context" class="headerlink" title="context"></a>context</h3><p>context 是存儲 GraphQL 伺服器全域值以供所有解析函式讀取的地方。context 很適合儲存身分驗證、資料庫細節、本地資料快取，以及任何其他需要解析 GraphQL 操作的物件。</p>
<p>你可以直接在解析函式裡面呼叫 REST API 與資料庫，但是我們通常會將這個邏輯放在 context 裡面的物件內，來分開關注點，以及方便稍後的重構。</p>
<p>你也可以使用 context 從 Apollo Data Source 讀取 REST 資料。不過就這個範例的目的而言，我們要結合 context 來處理應用程序的一些限制。首先，我們目前將資料放在記憶體內，這種做法的擴展性不好。接下來要讓資料庫來處理資料儲存，我們的解析函式將會從 context 存取這個資料庫。</p>
<h3 id="安裝資料庫-LevelDB"><a href="#安裝資料庫-LevelDB" class="headerlink" title="安裝資料庫 LevelDB"></a>安裝資料庫 LevelDB</h3><p>為了讓這個範例可以獨立運作，這裡將使用鍵-值存儲嵌入式資料庫 LevelDB，重要的是理解 context 的用法。稍後會有使用 Oracle 資料庫的範例。</p>
<p>這裡須要使用兩個 Node.js 套件，level-sublevel 可以讓我們在同一個 LevelDB 中存儲兩組以上的資料集，你也可以將不同的資料集存入各自的 LevelDB 中。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install level --save</span><br><span class="line">npm install level-sublevel --save</span><br></pre></td></tr></table></figure>

<p>首先將 levelDB 的 CRUD 操作包裝一個抽象層，在專案子目錄 models 下建立 database.js 文件:</p>
<figure class="highlight javascript"><figcaption><span>models/database.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> timestamp = <span class="built_in">require</span>(<span class="string">'monotonic-timestamp'</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Database</span>(<span class="params">db</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>._db = db;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Database.prototype.findAll = <span class="function"><span class="keyword">function</span>(<span class="params"> opts = &#123;&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> options = &#123; ...opts &#125;;</span><br><span class="line">    <span class="keyword">let</span> _this = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">let</span> results = [];</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      _this._db</span><br><span class="line">        .createValueStream( options )</span><br><span class="line">        .on(<span class="string">"data"</span>, value =&gt; results.push(value))</span><br><span class="line">        .on(<span class="string">"end"</span>, () =&gt; resolve(results))</span><br><span class="line">        .on(<span class="string">"error"</span>, err =&gt; reject(err));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">      reject(err);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Database.prototype.findAllwithKey = <span class="function"><span class="keyword">function</span>(<span class="params"> opts = &#123;&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> options = &#123; ...opts &#125;;</span><br><span class="line">    <span class="keyword">let</span> _this = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">let</span> results = [];</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      _this._db</span><br><span class="line">        .createReadStream( options )</span><br><span class="line">        .on(<span class="string">"data"</span>, data =&gt; results.push(data))</span><br><span class="line">        .on(<span class="string">"end"</span>, () =&gt; resolve(results))</span><br><span class="line">        .on(<span class="string">"error"</span>, err =&gt; reject(err));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">      reject(err);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Database.prototype.findOne = <span class="function"><span class="keyword">function</span>(<span class="params">id</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> id === <span class="string">"undefined"</span>) <span class="keyword">return</span> reject(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"Invalid ID."</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> _this = <span class="keyword">this</span>;</span><br><span class="line">    _this._db.get(id, (err, value) =&gt; &#123;</span><br><span class="line">      <span class="keyword">if</span> (err) <span class="keyword">return</span> reject(err);</span><br><span class="line">      resolve(value);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Database.prototype.insert = <span class="function"><span class="keyword">function</span>(<span class="params">id, newValue</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> id === <span class="string">"undefined"</span>) <span class="keyword">return</span> reject(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"Invalid ID"</span>));</span><br><span class="line">    <span class="keyword">if</span> (!newValue) <span class="keyword">return</span> reject(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"Invalid input"</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 當 id 是空字串，自動產生 id</span></span><br><span class="line">    id = id.toString().length !== <span class="number">0</span> ? id : timestamp().toString();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> _this = <span class="keyword">this</span>;</span><br><span class="line">    _this._db.get(id, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!err.notFound) <span class="keyword">return</span> reject(err);</span><br><span class="line"></span><br><span class="line">        _this._db.put(id, &#123; id, ...newValue &#125;, err =&gt; &#123;</span><br><span class="line">          <span class="keyword">if</span> (err) <span class="keyword">return</span> reject(err);</span><br><span class="line">          _this._db.get(id, (err, value) =&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (err) <span class="keyword">return</span> reject(err);</span><br><span class="line">            <span class="keyword">return</span> resolve(value);</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        reject(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"Data already exists"</span>));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Database.prototype.update = <span class="function"><span class="keyword">function</span>(<span class="params">id, newValue</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> id === <span class="string">"undefined"</span>) <span class="keyword">return</span> reject(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"Invalid ID"</span>));</span><br><span class="line">    <span class="keyword">if</span> (!newValue) <span class="keyword">return</span> reject(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"Invalid input"</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> _this = <span class="keyword">this</span>;</span><br><span class="line"></span><br><span class="line">    _this._db.get(id, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        <span class="keyword">if</span> (err.notFound) <span class="keyword">return</span> reject(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"Data not found"</span>));</span><br><span class="line">        <span class="keyword">return</span> reject(err);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      _this._db.put(id, newValue, err =&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (err) <span class="keyword">return</span> reject(err);</span><br><span class="line">        _this._db.get(id, (err, value) =&gt; &#123;</span><br><span class="line">          <span class="keyword">if</span> (err) <span class="keyword">return</span> reject(err);</span><br><span class="line">          <span class="keyword">return</span> resolve(value);</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Database.prototype.delete = <span class="function"><span class="keyword">function</span>(<span class="params">id</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> id === <span class="string">"undefined"</span>) <span class="keyword">return</span> reject(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"Invalid ID"</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> _this = <span class="keyword">this</span>;</span><br><span class="line"></span><br><span class="line">    _this._db.get(id, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        <span class="keyword">if</span> (err.notFound) <span class="keyword">return</span> reject(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"Data not found"</span>));</span><br><span class="line">        <span class="keyword">return</span> reject(err);</span><br><span class="line">      &#125;</span><br><span class="line">      _this._db.del(id, err =&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (err) <span class="keyword">return</span> reject(err);</span><br><span class="line">        resolve(<span class="string">"Data deleted"</span>);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Database.prototype.allCount = <span class="function"><span class="keyword">function</span>(<span class="params"> opts = &#123;&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> options = &#123; ...opts &#125;;</span><br><span class="line">    <span class="keyword">let</span> _this = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">let</span> count = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      _this._db</span><br><span class="line">        .createValueStream( options )</span><br><span class="line">        .on(<span class="string">"data"</span>, value =&gt; count += <span class="number">1</span>)</span><br><span class="line">        .on(<span class="string">"end"</span>, () =&gt; resolve(count))</span><br><span class="line">        .on(<span class="string">"error"</span>, err =&gt; reject(err));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">      reject(err);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = Database;</span><br></pre></td></tr></table></figure>

<p>這裡將 level 原始的 API 包裝成一般的資料庫操作，包含查詢、新增、更新與刪除，你可以用其它的資料庫 API 取代。 再來就產生實際的資料庫。在 models 目錄產生另一個檔案 dbs.js</p>
<figure class="highlight javascript"><figcaption><span>models/dbs.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">"path"</span>);</span><br><span class="line"><span class="keyword">const</span> level = <span class="built_in">require</span>(<span class="string">"level"</span>);</span><br><span class="line"><span class="keyword">const</span> sublevel = <span class="built_in">require</span>(<span class="string">"level-sublevel"</span>);</span><br><span class="line"><span class="keyword">const</span> db = sublevel(level(path.resolve(__dirname, <span class="string">"example-db"</span>)), &#123;</span><br><span class="line">  valueEncoding: <span class="string">"json"</span></span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">const</span> Database = <span class="built_in">require</span>(<span class="string">'./database'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> usersDb = db.sublevel(<span class="string">"users"</span>);</span><br><span class="line"><span class="keyword">const</span> photosDb = db.sublevel(<span class="string">"photos"</span>);</span><br><span class="line"><span class="keyword">const</span> tagsDb = db.sublevel(<span class="string">"tags"</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  users: <span class="keyword">new</span> Database(usersDb),</span><br><span class="line">  photos: <span class="keyword">new</span> Database(photosDb),</span><br><span class="line">  tags: <span class="keyword">new</span> Database(tagsDb)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>現在我們可以使用這個資料庫抽象層程式將原先放在記憶體的資料移入資料庫。產生一段臨時的程式碼來初始化這些資料，將程式碼放在 models 目錄下的 useful 目錄:</p>
<figure class="highlight javascript"><figcaption><span>models/useful/dbs-init.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> db = <span class="built_in">require</span>(<span class="string">'../dbs'</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; users, photos, tags &#125; = <span class="built_in">require</span>(<span class="string">"../data"</span>);</span><br><span class="line"></span><br><span class="line">users.forEach(<span class="function"><span class="params">value</span> =&gt;</span> &#123;</span><br><span class="line">  db.users.insert(value.appLogin, value);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">photos.forEach(<span class="function"><span class="params">value</span> =&gt;</span> &#123;</span><br><span class="line">  db.photos.insert(value.id, value);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">tags.forEach(<span class="function"><span class="params">value</span> =&gt;</span> &#123;</span><br><span class="line">  db.tags.insert(<span class="string">`<span class="subst">$&#123;value.photoID&#125;</span>-<span class="subst">$&#123;value.userID&#125;</span>`</span>, value);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>Database.insert 的第一個引數將被設為 Key, User 我們使用 appLogin 當 Key, 這裡要注意 tags 的 key 值設定，避免資料重複，這是多對多資料 Intersection Table 的要件，Primary Key 要包含所有的欄位。寫入資料庫後可以查詢看看資料庫內的資料。</p>
<p>執行完 dbs-init.js 後，models 目錄下會產生一個 example-db 目錄，這就是 LevelDB 資料庫的實體位置。</p>
<p>現在可以來看看資料庫內的資料內容:</p>
<figure class="highlight javascript"><figcaption><span>models/useful/dbs-test.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> db = <span class="built_in">require</span>(<span class="string">"../dbs"</span>);</span><br><span class="line"></span><br><span class="line">db.users.findAll().then(<span class="function"><span class="params">value</span> =&gt;</span> <span class="built_in">console</span>.log(value));</span><br><span class="line"></span><br><span class="line">db.photos.findAll().then(<span class="function"><span class="params">value</span> =&gt;</span> <span class="built_in">console</span>.log(value));</span><br><span class="line"></span><br><span class="line">db.tags.findAllwithKey().then(<span class="function"><span class="params">value</span> =&gt;</span> <span class="built_in">console</span>.log(value));</span><br></pre></td></tr></table></figure>

<h4 id="將資料庫加入-context"><a href="#將資料庫加入-context" class="headerlink" title="將資料庫加入 context"></a>將資料庫加入 context</h4><p>接下來要將 GraphQL 連接資料庫，首先建立一個 context 物件，這需要修改專案目錄的 index.js，再重新啟動 GraphQL API 伺服器:</p>
<figure class="highlight javascript"><figcaption><span>index.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; ApolloServer &#125; = <span class="built_in">require</span>(<span class="string">'apollo-server-express'</span>);</span><br><span class="line"><span class="keyword">const</span> cors = <span class="built_in">require</span>(<span class="string">'cors'</span>);</span><br><span class="line"><span class="keyword">const</span> typeDefs = <span class="built_in">require</span>(<span class="string">'./schema'</span>);</span><br><span class="line"><span class="keyword">const</span> resolvers = <span class="built_in">require</span>(<span class="string">'./resolvers'</span>);</span><br><span class="line"><span class="keyword">const</span> db = <span class="built_in">require</span>(<span class="string">'./models/dbs'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = express();</span><br><span class="line"></span><br><span class="line">app.use(cors());</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> context = &#123; db &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> server = <span class="keyword">new</span> ApolloServer(&#123;</span><br><span class="line">  typeDefs,</span><br><span class="line">  resolvers,</span><br><span class="line">  context</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">server.applyMiddleware(&#123; app &#125;);</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/'</span>, (req, res) =&gt; res.end(<span class="string">"Welcome to the GraphQL Sample API"</span>));</span><br><span class="line"></span><br><span class="line">app.listen(&#123; <span class="attr">port</span>: <span class="number">4000</span> &#125;, () =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`GraphQL Server running @ http://localhost:4000<span class="subst">$&#123;server.graphqlPath&#125;</span>`</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<blockquote>
<ul>
<li>第 6  行將資料庫加進來</li>
<li>第 12 行產生 context 物件</li>
<li>第 17 行將 context 物件加入 ApolloServer</li>
</ul>
</blockquote>
<p>接著我們要修改 query 解析函式，從 schema/user.js User 類型開始新增兩個 Query 欄位 totalUsers 與 allUsers。</p>
<figure class="highlight javascript"><figcaption><span>schema/user.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">extend type Query &#123;</span><br><span class="line">  sayHello: <span class="built_in">String</span>!</span><br><span class="line">  totalUsers: Int!</span><br><span class="line">  allUsers: [User!]!</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接著修改解析函式 resolvers/user.js:</p>
<figure class="highlight javascript"><figcaption><span>resolvers/user.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Query: &#123;</span><br><span class="line">  sayHello: <span class="function"><span class="params">()</span> =&gt;</span> <span class="string">"哈囉，台南! 就從這裡開始。"</span>,</span><br><span class="line">  totalUsers: <span class="function">(<span class="params">parent, args, &#123; db &#125;</span>) =&gt;</span> db.users.allCount().then(<span class="function"><span class="params">value</span> =&gt;</span> value),</span><br><span class="line">  allUsers: <span class="function">(<span class="params">parent, args, &#123; db &#125;</span>) =&gt;</span> db.users.findAll()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意這裡解析函式引入 context 物件的方式，它是解析函式的<strong>第三個參數</strong>。GraphQL 解析函式的簽章可以是:</p>
<figure class="highlight javascript"><figcaption><span>GraphQL resolver function signature</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(parent, args, context, info) =&gt; &#123; ... &#125;</span><br></pre></td></tr></table></figure>

<p>還要注意解析函式使用 Promise 的方式。 你也可以在這裡使用 async / await。</p>
<figure class="highlight javascript"><figcaption><span>resolvers/user.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">allUsers: <span class="keyword">async</span> (parent, args, &#123; <span class="attr">db</span>: &#123; users &#125; &#125;) =&gt; <span class="keyword">await</span> users.findAll()</span><br></pre></td></tr></table></figure>

<p>我們使用 context 物件階層式的解構賦值方式，這裡我們只需要 users 資料庫</p>
<p>接下來修改 postedPhotos 與 inPhotos:</p>
<figure class="highlight javascript"><figcaption><span>resolvers/user.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">User: &#123;</span><br><span class="line">  postedPhotos: <span class="function">(<span class="params">parent, args, &#123; db: &#123; photos &#125; &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> photos.findAll().then(<span class="function"><span class="params">results</span> =&gt;</span> results.filter(<span class="function"><span class="params">value</span> =&gt;</span> value.appUser === parent.appLogin));</span><br><span class="line">  &#125;,</span><br><span class="line">  inPhotos: <span class="function">(<span class="params">parent, args, &#123; db: &#123; photos, tags &#125; &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> tags.findAll().then(<span class="function"><span class="params">tags</span> =&gt;</span> tags</span><br><span class="line">      .filter(<span class="function"><span class="params">tag</span> =&gt;</span> tag.userID === parent.appLogin)</span><br><span class="line">      .map(<span class="function"><span class="params">tag</span> =&gt;</span> photos.findOne(tag.photoID))</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>現在可以從 GraphQL Playground 客戶端送出一個查詢:</p>
<figure class="highlight plain"><figcaption><span>query</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">query listUsers &#123;</span><br><span class="line">  allUsers &#123;</span><br><span class="line">    appLogin</span><br><span class="line">    name</span><br><span class="line">    postedPhotos &#123;</span><br><span class="line">      name</span><br><span class="line">      description</span><br><span class="line">    &#125;</span><br><span class="line">    inPhotos &#123;</span><br><span class="line">      name</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我們也需要修改 Photo 的解析函式 totalPhotos、allPhotos、postedBy 與 taggedUsers:</p>
<figure class="highlight javascript"><figcaption><span>resolvers/photo.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">Query: &#123;</span><br><span class="line">  totalPhotos: <span class="function">(<span class="params">parent, args, &#123; db: &#123; photos &#125; &#125;</span>) =&gt;</span> photos.allCount().then(<span class="function"><span class="params">value</span> =&gt;</span> value),</span><br><span class="line">  allPhotos: <span class="function">(<span class="params">parent, args, &#123; db: &#123; photos &#125; &#125;</span>) =&gt;</span> photos.findAll()</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">Photo: &#123;</span><br><span class="line">  url: <span class="function"><span class="params">parent</span> =&gt;</span> <span class="string">`https://fakeimg.pl/120x160/?text=<span class="subst">$&#123;parent.id&#125;</span>`</span>,</span><br><span class="line">  postedBy: <span class="function">(<span class="params">parent, args, &#123; db: &#123; users &#125; &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> users.findOne(parent.appUser).then(<span class="function"><span class="params">value</span> =&gt;</span> value);</span><br><span class="line">  &#125;,</span><br><span class="line">  taggedUsers: <span class="function">(<span class="params">parent, args, &#123; db: &#123; users, tags &#125; &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> tags.findAll().then(<span class="function"><span class="params">result</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> result</span><br><span class="line">        .filter( <span class="function"><span class="params">tag</span> =&gt;</span> tag.photoID === parent.id)</span><br><span class="line">        .map(<span class="function"><span class="params">tag</span> =&gt;</span> tag.userID)</span><br><span class="line">        .map(<span class="function"><span class="params">userID</span> =&gt;</span> users.findOne(userID));</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>到此 User 使用者型態與 Photo 照片型態的部分都只是查詢，致於要將照片加入資料庫，使用者必須先登入才能將照片加入，所以要先加入認證與授權。</p>
<p style="text-align: right;">接續下一篇 <a href="/2019/11/07/GraphQL-API-5/" title="建立 GraphQL API (5)">建立 GraphQL API (5)</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://1184yang.github.io/2019/11/07/GraphQL-API-4/" data-id="ckcpzj95q000j80vzib58rap0" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-GraplQL-API-3" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/11/06/GraplQL-API-3/" class="article-date">
  <time datetime="2019-11-06T06:38:32.000Z" itemprop="datePublished">2019-11-06</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/GraphQL/">GraphQL</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/11/06/GraplQL-API-3/">建立 GraphQL API (3)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="自訂純量-Custom-Scalars"><a href="#自訂純量-Custom-Scalars" class="headerlink" title="自訂純量 Custom Scalars"></a>自訂純量 Custom Scalars</h3><p>GraphQL 有一群預設的純量型態可以在任何欄位中使用。Int、Float、String、Boolean 與 ID 之類的純量可以在大部分的情況下使用，但有時你可能需要建立自訂的純量型態來滿足資料的需求。</p>
<p>當我們實作自訂純量時，必須建立一些關於如何序列化和驗證型態的規則。例如，當我們建立 DateTime 型態時，也要定義怎樣的 DateTime 才可以視為有效的。</p>
<p>接下來要在 typeDefs 裡面加入這個自訂的 DateTime 純量型態，並且在 Photo 型態的 created 欄位使用它。我們用 created 欄位來存儲照片被貼出的日期與時間。</p>
<figure class="highlight js"><figcaption><span>index.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> typeDefs = <span class="string">`</span></span><br><span class="line"><span class="string">  ...</span></span><br><span class="line"><span class="string">  scalar DateTime</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  type Photo &#123;</span></span><br><span class="line"><span class="string">    ...</span></span><br><span class="line"><span class="string">    created: DateTime!</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">  ...</span></span><br><span class="line"><span class="string">`</span></span><br></pre></td></tr></table></figure>

<p>schema 的每一個欄位都要對應一個解析函式。created 欄位要對應一個 DateTime 型態的解析函式。為 DataTime 建立自訂純量型態的原因是我們想要將任何使用這個純量的欄位解析為 JavaScript Date 型態並加以驗證。</p>
<p>考慮各種用字串來表示日期與時間的方式，以下的字串都代表有效的日期:</p>
<blockquote>
<ul>
<li>“7/30/2019”</li>
<li>“7/30/2019 1:08:23 PM”</li>
<li>“Tue Jul 30 2019 13:08:23 GMT+0800 (Taipei Standard Time)”</li>
<li>“2019-07-30T05:08:23.960Z”</li>
</ul>
</blockquote>
<p>我們可以用 JavaScript 將上面的任何字串做成 datetime 物件:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> d = <span class="keyword">new</span> <span class="built_in">Date</span>(<span class="string">"7/30/2019"</span>);</span><br><span class="line"><span class="built_in">console</span>.log(d.toISOString());</span><br><span class="line"><span class="comment">// 2019-07-29T16:00:00.000Z 這是 ISO 格式，注意它的日期</span></span><br></pre></td></tr></table></figure>

<p>上面的程式用一種格式建立一個新的日期物件，接著將那個 datetime 字串轉換成 ISO 格式的日期字串。</p>
<p>這個 JavaScript Date 不瞭解的東西都是無效的。你可以試著解析下面的資料:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> d = <span class="keyword">new</span> <span class="built_in">Date</span>(<span class="string">"Tuesday July"</span>);</span><br><span class="line"><span class="built_in">console</span>.log(d);</span><br><span class="line"><span class="comment">// Invalid Date</span></span><br></pre></td></tr></table></figure>

<p>我們想要在查詢照片的 created 欄位時，確定這個欄位回傳的值含有 ISO 日期時間格式的字串。當欄位回傳日期值時，我們會將那個值 serialize (序列化) 為 ISO 格式的字串:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> serialize = <span class="function"><span class="params">value</span> =&gt;</span> <span class="keyword">new</span> <span class="built_in">Date</span>(value).toISOString();</span><br></pre></td></tr></table></figure>

<p>序列化函式會從物件取出欄位值，只要那個欄位含有 JavaScript 物件格式的日期，或任何有效的 datetime 字串<br>，GraphQL 就會用 ISO datetime 格式回傳它。</p>
<p>當你在 schema 實作自訂的純量之後，就可以在 query 中將它當成引數來使用。假設我們為 allPhotos query 建立一種過濾器。這個 query 可以回傳在指定的日期之後拍攝的照片串列:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">type Query &#123;</span><br><span class="line">  ...</span><br><span class="line">  allPhotos(after: DateTime): [Photo!]!</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有這個欄位時，用戶端就可以傳送一個含有 DateTime 值的 query:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">query recentPhotos($after: DateTime) &#123;</span><br><span class="line">  allPhotos(after: $after) &#123;</span><br><span class="line">    name</span><br><span class="line">    url</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>這可以使用查詢變數來傳送 $after 引數:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"after"</span>: <span class="string">"7/30/2018"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我們想要在 after 引數被傳送到解析函式之前確保它已經被解析成 JavaScript Date 物件了:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> parseValue = <span class="function"><span class="params">value</span> =&gt;</span> <span class="keyword">new</span> <span class="built_in">Date</span>(value);</span><br></pre></td></tr></table></figure>

<p>我們可以使用 parseValue 函式來解析與 query 一起送來的字串的值。 parseValue 函式回傳的值都會被傳給解析函式的引數 args:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> resolvers = &#123;</span><br><span class="line">  Query: &#123;</span><br><span class="line">    allPhotos: <span class="function">(<span class="params">parent, args</span>) =&gt;</span> &#123;</span><br><span class="line">      args.after <span class="comment">// JavaScript Date 物件</span></span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>自訂純量必須能夠序列化與解析日期。</p>
<p>我們還有一個地方需要處理日期字串: <strong>當用戶端直接在 query 本身加入日期字串時</strong>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">query &#123;</span><br><span class="line">  allPhotos(after: &quot;7/30/2018&quot;) &#123;</span><br><span class="line">    name</span><br><span class="line">    url</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果 after 引數<strong>不是用查詢變數來傳遞的</strong>，它已經被<strong>直接加入查詢文件</strong>了。我們必須在這個值被解析成抽象語法<br>樹 (AST) 之後，從 query 取出它才能解析它。在解析這些值之前，我們使用 parseLiteral 函式從查詢文件中取出它們:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> parseLiteral = <span class="function"><span class="params">ast</span> =&gt;</span> ast.value;</span><br></pre></td></tr></table></figure>

<p>我們用 parseLiteral 函式來取得被直接加入查詢文件的日期值。在本例中，我們只要回傳那個值即可，但在必要時，我們也可以在這個函式內執行額外的解析步驟。</p>
<p>當我們建立自訂純量時，需要使用為了處理 DateTime 值而設計的三個函式。我們加入自訂純量 DateTime 的解析函式:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; GraphQLScalarType &#125; = <span class="built_in">require</span>(<span class="string">'graphql'</span>);</span><br><span class="line">...</span><br><span class="line"><span class="keyword">const</span> resolvers = &#123;</span><br><span class="line">  Query: &#123; ... &#125;,</span><br><span class="line">  Mutation: &#123; ... &#125;,</span><br><span class="line">  Photo: &#123; ... &#125;,</span><br><span class="line">  User: &#123; ... &#125;,</span><br><span class="line">  DateTime: <span class="keyword">new</span> GraphQLScalarType(&#123;</span><br><span class="line">    name: <span class="string">"DateTime"</span>,</span><br><span class="line">    description: <span class="string">"有效的日期時間值"</span>,</span><br><span class="line">    parseValue: <span class="function"><span class="params">value</span> =&gt;</span> <span class="keyword">new</span> <span class="built_in">Date</span>(value),</span><br><span class="line">    serialize: <span class="function"><span class="params">value</span> =&gt;</span> <span class="keyword">new</span> <span class="built_in">Date</span>(value).toISOString(),</span><br><span class="line">    parseLiteral: <span class="function"><span class="params">ast</span> =&gt;</span> ast.value</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我們使用 GraphQLScalarType 建構式來建立 “自訂純量” 的解析函式。我們將 DateTime 解析函式放在解析函式清單中。當我們建立純量型態時，必須加入三個函式: <em>serialize<em>、</em>parseValue</em> 與 <em>parseLiteral</em>，它們會處理任何實作 DateTime 純量的欄位或引數。</p>
<p>我們也要在樣本資料中加入 created 鍵與日期值，使用任何一個有效的日期字串或物件都可以，因為我們建立的欄位會先被<em>序列化</em>再回傳:</p>
<figure class="highlight javascript"><figcaption><span>models/data.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">exports.photos = [</span><br><span class="line">  &#123;</span><br><span class="line">    ...</span><br><span class="line">    created : <span class="string">"3-28-2018"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    ...</span><br><span class="line">    created : <span class="string">"1-2-2015"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    ...</span><br><span class="line">    created : <span class="string">"2019-07-30T05:08:23.960Z"</span></span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>現在，當我們在選擇組加入 created 欄位時，可以看到這些日期與型態都被格式化成 ISO 日期字串了:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">query listPhotos &#123;</span><br><span class="line">  allPhotos &#123;</span><br><span class="line">    name</span><br><span class="line">    created</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下來的工作只剩下在每張照片被貼出時為它們加上時戳。我們在每張照片加入一個 created 欄位，並且用 JavaScript Date 物件與自訂型態 DateTime 來加上及驗證時戳。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">postPhoto(parent, args) &#123;</span><br><span class="line">  <span class="keyword">let</span> newPhoto = &#123;</span><br><span class="line">    id: _id++,</span><br><span class="line">    ...args.input,</span><br><span class="line">    created: <span class="keyword">new</span> <span class="built_in">Date</span>()</span><br><span class="line">  &#125;;</span><br><span class="line">  photos.push(newPhoto);</span><br><span class="line">  <span class="keyword">return</span> newPhoto;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>現在當新照片被貼出時，就會被加上它們的建立日期與時間時戳了。</p>
<figure class="highlight plain"><figcaption><span>postPhoto</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mutation newPhoto &#123;</span><br><span class="line">  postPhoto(input: &#123;</span><br><span class="line">    name: &quot;範例照片 haha&quot;,</span><br><span class="line">    description: &quot;這是範例照片 after custom scalar&quot;</span><br><span class="line">  &#125;) &#123;</span><br><span class="line">    id</span><br><span class="line">    name</span><br><span class="line">    description</span><br><span class="line">    url</span><br><span class="line">    created</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><figcaption><span>results</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"data"</span>: &#123;</span><br><span class="line">    <span class="attr">"postPhoto"</span>: &#123;</span><br><span class="line">      <span class="attr">"id"</span>: <span class="string">"5"</span>,</span><br><span class="line">      <span class="attr">"name"</span>: <span class="string">"範例照片 haha"</span>,</span><br><span class="line">      <span class="attr">"description"</span>: <span class="string">"這是範例照片 after custom scalar"</span>,</span><br><span class="line">      <span class="attr">"url"</span>: <span class="string">"https://fakeimg.pl/120x160/?text=5"</span>,</span><br><span class="line">      <span class="attr">"created"</span>: <span class="string">"2019-07-30T08:04:57.022Z"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<blockquote>
<h4 id="抽象語法樹-abstract-syntax-tree-AST"><a href="#抽象語法樹-abstract-syntax-tree-AST" class="headerlink" title="抽象語法樹 (abstract syntax tree, AST)"></a><em>抽象語法樹 (abstract syntax tree, AST)</em></h4></blockquote>
</blockquote>
<blockquote>
<blockquote>
<blockquote>
<p>GraphQL query 文件是個字串。當我們傳送 query 給 GraphQL API 時，字串會被解析成<strong>抽象語法樹</strong>，並且在操作執行之前進行驗證。抽象語法樹 (AST) 是一種代表 query 的階層式物件。AST 是個含有內嵌欄位的物件，裡面的欄位代表 GraphQL query 的細節。</p>
</blockquote>
</blockquote>
</blockquote>
<blockquote>
<blockquote>
<blockquote>
<p>解析程序的第一個步驟是將字串解析成一堆較小的片段，這個步驟包括將關鍵字、引數，甚至括號與冒號解析成單獨的標記，這個程序稱為<strong>詞法分析</strong> (lexing 或 lexical analysis)。接下來將詞法分析後的 query 解析成 AST。使用 AST 可讓動態修改與驗證 query 的工作輕鬆許多。</p>
</blockquote>
</blockquote>
</blockquote>
<blockquote>
<blockquote>
<blockquote>
<p>GraphQL query 是一種 GraphQL 文件。文件至少要有一個<strong>定義</strong>(Definition)，也可能有一串定義。</p>
</blockquote>
</blockquote>
</blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<ul>
<li>定義只有可能是兩種型態: OperationDefinition 或 FragementDefinition。</li>
<li>一個 OperationDefinition 只能含有三種操作型態: mutation、query 或 subscription。</li>
<li>每一個操作定義都有 OperationType 與 SelectionSet。</li>
</ul>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
<blockquote>
<blockquote>
<blockquote>
<p>在每一個操作後面的大括號 { } 內都有該操作的 SelectionSet，它們就是我們查詢的欄位。</p>
</blockquote>
</blockquote>
</blockquote>
<blockquote>
<blockquote>
<blockquote>
<p>GraphQL 可以遍歷這個 AST 並且用 GraphQL 語言與目前的 schema 來驗證它的細節。如果查詢語言的語法是正確的，且 schema 含有我們請求的欄位與型態，該操作就會執行。如果情況不是如此，就會回傳特定的錯誤。</p>
</blockquote>
</blockquote>
</blockquote>
<blockquote>
<blockquote>
<blockquote>
<p>此外，AST 物件比字串容易修改。如果我們想要在 query 附加另外的欄位資料，可直接修改 AST。我們只要為特定的操作加入一個額外的 SelectionSet 就可以了。AST 是 GraphQL 很重要的成分。每一項操作都會被解析成 AST，以便對它進行驗證並最終執行它。</p>
</blockquote>
</blockquote>
</blockquote>
<h4 id="模塊化的-GraphQL-架構"><a href="#模塊化的-GraphQL-架構" class="headerlink" title="模塊化的 GraphQL 架構"></a>模塊化的 GraphQL 架構</h4><p>到此我們會發覺 index.js 文件隨著 schema 與 resolvers 而不斷的增長，我們不能繼續都將程式碼定義在一個單一的文件中，我們必須模組化。</p>
<p>模式拼接 (Schema stitching) 是 GraphQL 中的一個強大功能。它是將多個 GraphQL 模式合併到一個模式中。目前，我們應用程序中的模式尚屬單純，但將來可能需要使用多個模式和模式拼接更複雜的操作。其中每個模式都匹配一種類型 (例如 User 使用者類型，Photo 照片類型)，該操作需要合併兩個 GraphQL 模式，以便能使用 GraphQL 伺服器的 API 訪問整個 GraphQL 模式。這是架構拼接背後的基本動機之一。</p>
<p>甚至可以更進一步，最終可能會出現微服務或第三方平台，這些平台各有其專用的 GraphQL API，然後可以將它們合併到一個 GraphQL 架構中，併接成為單一的事實來源。最後，客戶端可以使用整個模式，而該模式由多個應用領域驅動的微服務組成。</p>
<p>在我們的例子中，讓我們從 GraphQL schema 和 resolvers 的技術問題開始分離。之後，您將按使用者(User)和照片(Photo)的應用域(domain)分隔。</p>
<p>首先在我們的專案目錄下建立兩個子目錄: schema 與 resolvers，我們要將原先定義在 index.js 的 typeDefs 與 resolvers 的程式碼分離出來，並放入這子目錄中。</p>
<figure class="highlight javascript"><figcaption><span>schema/index.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; gql &#125; = <span class="built_in">require</span>(<span class="string">"apollo-server-express"</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = gql<span class="string">`</span></span><br><span class="line"><span class="string">  type Query &#123;</span></span><br><span class="line"><span class="string">    sayHello: String!</span></span><br><span class="line"><span class="string">    totalPhotos: Int!</span></span><br><span class="line"><span class="string">    allPhotos: [Photo!]!</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  input PostPhotoInput &#123;</span></span><br><span class="line"><span class="string">    name: String!</span></span><br><span class="line"><span class="string">    category: PhotoCategory = PORTRAIT</span></span><br><span class="line"><span class="string">    description: String</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  type Mutation &#123;</span></span><br><span class="line"><span class="string">    postPhoto(input: PostPhotoInput!): Photo!</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  enum PhotoCategory &#123;</span></span><br><span class="line"><span class="string">    SELFIE</span></span><br><span class="line"><span class="string">    PORTRAIT</span></span><br><span class="line"><span class="string">    ACTION</span></span><br><span class="line"><span class="string">    LANDSCAPE</span></span><br><span class="line"><span class="string">    GRAPHIC</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  scalar DateTime</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  type Photo &#123;</span></span><br><span class="line"><span class="string">    id: ID!</span></span><br><span class="line"><span class="string">    url: String!</span></span><br><span class="line"><span class="string">    name: String!</span></span><br><span class="line"><span class="string">    description: String</span></span><br><span class="line"><span class="string">    category: PhotoCategory!</span></span><br><span class="line"><span class="string">    postedBy: User!</span></span><br><span class="line"><span class="string">    taggedUsers: [User!]!</span></span><br><span class="line"><span class="string">    created: DateTime!</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  type User &#123;</span></span><br><span class="line"><span class="string">    appLogin: ID!</span></span><br><span class="line"><span class="string">    name: String</span></span><br><span class="line"><span class="string">    avatar: String</span></span><br><span class="line"><span class="string">    postedPhotos: [Photo!]!</span></span><br><span class="line"><span class="string">    inPhotos: [Photo!]!</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">`</span>;</span><br></pre></td></tr></table></figure>

<p>GraphQL schema 的定義是一個字符串，原先我們使用 JavaScript 的模板文字 (template literals) 編寫。這裡改用 gql，gql 是一種 JavaScript 模板文字標記，用於將 GraphQL 查詢字符串解析為標準 GraphQL AST或抽象語法樹。</p>
<p>原先使用字符串編寫並沒甚麼錯， 但是，如果您嘗試添加額外的欄位，或要將多個 GraphQL 文件或查詢合併在一起，則一般的字符串操作起來不怎麼方便。</p>
<p>再來就是 resolvers 子目錄下的 index.js:</p>
<figure class="highlight javascript"><figcaption><span>resolvers/index.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; users, photos, tags &#125; = <span class="built_in">require</span>(<span class="string">"../models/data"</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; GraphQLScalarType &#125; = <span class="built_in">require</span>(<span class="string">"graphql"</span>);</span><br><span class="line"><span class="keyword">const</span> timestamp = <span class="built_in">require</span>(<span class="string">'monotonic-timestamp'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  Query: &#123;</span><br><span class="line">    sayHello: <span class="function"><span class="params">()</span> =&gt;</span> <span class="string">"哈囉，台南! 就從這裡開始。"</span>,</span><br><span class="line">    totalPhotos: <span class="function"><span class="params">()</span> =&gt;</span> photos.length,</span><br><span class="line">    allPhotos: <span class="function"><span class="params">()</span> =&gt;</span> photos</span><br><span class="line">  &#125;,</span><br><span class="line">  Mutation: &#123;</span><br><span class="line">    postPhoto(parent, args) &#123;</span><br><span class="line">      <span class="keyword">let</span> newPhoto = &#123;</span><br><span class="line">        id: timestamp().toString(),</span><br><span class="line">        ...args.input,</span><br><span class="line">        created: <span class="keyword">new</span> <span class="built_in">Date</span>()</span><br><span class="line">      &#125;;</span><br><span class="line">      photos.push(newPhoto);</span><br><span class="line">      <span class="keyword">return</span> newPhoto;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  Photo: &#123;</span><br><span class="line">    url: <span class="function"><span class="params">parent</span> =&gt;</span> <span class="string">`https://fakeimg.pl/120x160/?text=<span class="subst">$&#123;parent.id&#125;</span>`</span>,</span><br><span class="line">    postedBy: <span class="function"><span class="params">parent</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> users.find(<span class="function"><span class="params">u</span> =&gt;</span> u.appLogin === parent.appUser);</span><br><span class="line">    &#125;,</span><br><span class="line">    taggedUsers: <span class="function"><span class="params">parent</span> =&gt;</span></span><br><span class="line">      tags</span><br><span class="line">        <span class="comment">// 回傳一個只含當前照片的 tag 陣列</span></span><br><span class="line">        .filter(<span class="function"><span class="params">tag</span> =&gt;</span> tag.photoID === parent.id)</span><br><span class="line">        <span class="comment">// 將 tag 陣列轉換成 userID 陣列</span></span><br><span class="line">        .map(<span class="function"><span class="params">tag</span> =&gt;</span> tag.userID)</span><br><span class="line">        <span class="comment">// 將 userID 陣列轉換成使用者物件陣列</span></span><br><span class="line">        .map(<span class="function"><span class="params">userID</span> =&gt;</span> users.find(<span class="function"><span class="params">u</span> =&gt;</span> u.appLogin === userID))</span><br><span class="line">  &#125;,</span><br><span class="line">  User: &#123;</span><br><span class="line">    postedPhotos: <span class="function"><span class="params">parent</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> photos.filter(<span class="function"><span class="params">p</span> =&gt;</span> p.appUser === parent.appLogin);</span><br><span class="line">    &#125;,</span><br><span class="line">    inPhotos: <span class="function"><span class="params">parent</span> =&gt;</span></span><br><span class="line">      tags</span><br><span class="line">        <span class="comment">// 回傳一個只含有當前使用者的 tag 陣列</span></span><br><span class="line">        .filter(<span class="function"><span class="params">tag</span> =&gt;</span> tag.userID === parent.appLogin)</span><br><span class="line">        <span class="comment">// 將 tag 陣列轉換成 PhotoID 陣列</span></span><br><span class="line">        .map(<span class="function"><span class="params">tag</span> =&gt;</span> tag.photoID)</span><br><span class="line">        <span class="comment">// 將 photoID 陣列轉換成照片物件陣列</span></span><br><span class="line">        .map(<span class="function"><span class="params">photoID</span> =&gt;</span> photos.find(<span class="function"><span class="params">p</span> =&gt;</span> p.id === photoID))</span><br><span class="line">  &#125;,</span><br><span class="line">  DateTime: <span class="keyword">new</span> GraphQLScalarType(&#123;</span><br><span class="line">    name: <span class="string">"DateTime"</span>,</span><br><span class="line">    description: <span class="string">"有效的日期時間值"</span>,</span><br><span class="line">    parseValue: <span class="function"><span class="params">value</span> =&gt;</span> <span class="keyword">new</span> <span class="built_in">Date</span>(value),</span><br><span class="line">    serialize: <span class="function"><span class="params">value</span> =&gt;</span> <span class="keyword">new</span> <span class="built_in">Date</span>(value).toISOString(),</span><br><span class="line">    parseLiteral: <span class="function"><span class="params">ast</span> =&gt;</span> ast.value</span><br><span class="line">  &#125;),</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>注意這裡的 models/data 路徑不一樣了。也改用 monotonic-timestamp 套件來產生照片的 id，可以使用 npm 安裝此套件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install monotonic-timestamp --save</span><br></pre></td></tr></table></figure>

<p>最後就要修改專案目錄下的 index.js</p>
<figure class="highlight javascript"><figcaption><span>index.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; ApolloServer &#125; = <span class="built_in">require</span>(<span class="string">'apollo-server-express'</span>);</span><br><span class="line"><span class="keyword">const</span> typeDefs = <span class="built_in">require</span>(<span class="string">'./schema'</span>);</span><br><span class="line"><span class="keyword">const</span> resolvers = <span class="built_in">require</span>(<span class="string">'./resolvers'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = express();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> server = <span class="keyword">new</span> ApolloServer(&#123;</span><br><span class="line">  typeDefs,</span><br><span class="line">  resolvers</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">server.applyMiddleware(&#123; app &#125;);</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/'</span>, (req, res) =&gt; res.end(<span class="string">"Welcome to the GraphQL Sample API"</span>));</span><br><span class="line"></span><br><span class="line">app.listen(&#123; <span class="attr">port</span>: <span class="number">4000</span> &#125;, () =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`GraphQL Server running @ http://localhost:4000<span class="subst">$&#123;server.graphqlPath&#125;</span>`</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>把 schema 與 resolvers 加進來，現在整個專案的入口點變的清爽多了。但故事還沒完，如果 schema 與 resolvers 越來越多，是不是也可以再以應用域 (domain) 模組化?</p>
<p>回到 schema 目錄下，我們還需要再改造 schema/index.js。建立兩個新檔案 user.js 與 photo.js 我們要將<br> User 與 Photo 分開定義。</p>
 <figure class="highlight javascript"><figcaption><span>schema/user.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; gql &#125; = <span class="built_in">require</span>(<span class="string">"apollo-server-express"</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = gql<span class="string">`</span></span><br><span class="line"><span class="string">  extend type Query &#123;</span></span><br><span class="line"><span class="string">    sayHello: String!</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  type User &#123;</span></span><br><span class="line"><span class="string">    appLogin: ID!</span></span><br><span class="line"><span class="string">    name: String</span></span><br><span class="line"><span class="string">    avatar: String</span></span><br><span class="line"><span class="string">    postedPhotos: [Photo!]!</span></span><br><span class="line"><span class="string">    inPhotos: [Photo!]!</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">`</span>;</span><br></pre></td></tr></table></figure>

 <figure class="highlight javascript"><figcaption><span>schema/photo.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; gql &#125; = <span class="built_in">require</span>(<span class="string">"apollo-server-express"</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = gql<span class="string">`</span></span><br><span class="line"><span class="string">  extend type Query &#123;</span></span><br><span class="line"><span class="string">    totalPhotos: Int!</span></span><br><span class="line"><span class="string">    allPhotos: [Photo!]!</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  extend type Mutation &#123;</span></span><br><span class="line"><span class="string">    postPhoto(input: PostPhotoInput!): Photo!</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  input PostPhotoInput &#123;</span></span><br><span class="line"><span class="string">    name: String!</span></span><br><span class="line"><span class="string">    category: PhotoCategory = PORTRAIT</span></span><br><span class="line"><span class="string">    description: String</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  enum PhotoCategory &#123;</span></span><br><span class="line"><span class="string">    SELFIE</span></span><br><span class="line"><span class="string">    PORTRAIT</span></span><br><span class="line"><span class="string">    ACTION</span></span><br><span class="line"><span class="string">    LANDSCAPE</span></span><br><span class="line"><span class="string">    GRAPHIC</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  scalar DateTime</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  type Photo &#123;</span></span><br><span class="line"><span class="string">    id: ID!</span></span><br><span class="line"><span class="string">    url: String!</span></span><br><span class="line"><span class="string">    name: String!</span></span><br><span class="line"><span class="string">    description: String</span></span><br><span class="line"><span class="string">    category: PhotoCategory!</span></span><br><span class="line"><span class="string">    postedBy: User!</span></span><br><span class="line"><span class="string">    taggedUsers: [User!]!</span></span><br><span class="line"><span class="string">    created: DateTime!</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">`</span>;</span><br></pre></td></tr></table></figure>

<p>注意這理 Query 和 Mutation 類型的 <strong>extend</strong> 語句。每個文件只描述自己的實體，包含類型及其關係。 關係可以是來自不同文件的類型，例如，與 User 使用者類型關係的 Photo 照片類型，即使類型是定義在不同的文件。由於現在有多種類型，因此需要擴展類型 (extend)。 </p>
<p>接下來，在 schema/index.js 中為它們定義共享基類型：</p>
<figure class="highlight javascript"><figcaption><span>schema/index.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; gql &#125; = <span class="built_in">require</span>(<span class="string">"apollo-server-express"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> userSchema = <span class="built_in">require</span>(<span class="string">'./user'</span>);</span><br><span class="line"><span class="keyword">const</span> photoSchema = <span class="built_in">require</span>(<span class="string">'./photo'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> linkSchema = gql<span class="string">`</span></span><br><span class="line"><span class="string">  type Query &#123;</span></span><br><span class="line"><span class="string">    _: Boolean</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  type Mutation &#123;</span></span><br><span class="line"><span class="string">    _: Boolean</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  type Subscription &#123;</span></span><br><span class="line"><span class="string">    _: Boolean</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">`</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = [linkSchema, userSchema, photoSchema];</span><br></pre></td></tr></table></figure>

<p>在此我們定義一個 linkSchema 共享基類型，它會使用其他特定於應用域 schema 中的 extend 語句進行擴展，它使用的是一種併接模式(Schema Stitching)。</p>
<p>現在我們也要分離解析器的映射，resolvers/user.js 與 resolvers/photo.js:</p>
<figure class="highlight javascript"><figcaption><span>resolvers/user.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; photos, tags &#125; = <span class="built_in">require</span>(<span class="string">"../models/data"</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  Query: &#123;</span><br><span class="line">    sayHello: <span class="function"><span class="params">()</span> =&gt;</span> <span class="string">"哈囉，台南! 就從這裡開始。"</span></span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  User: &#123;</span><br><span class="line">    postedPhotos: <span class="function"><span class="params">parent</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> photos.filter(<span class="function"><span class="params">p</span> =&gt;</span> p.appUser === parent.appLogin);</span><br><span class="line">    &#125;,</span><br><span class="line">    inPhotos: <span class="function"><span class="params">parent</span> =&gt;</span></span><br><span class="line">      tags</span><br><span class="line">        <span class="comment">// 回傳一個只含有當前使用者的 tag 陣列</span></span><br><span class="line">        .filter(<span class="function"><span class="params">tag</span> =&gt;</span> tag.userID === parent.appLogin)</span><br><span class="line">        <span class="comment">// 將 tag 陣列轉換成 PhotoID 陣列</span></span><br><span class="line">        .map(<span class="function"><span class="params">tag</span> =&gt;</span> tag.photoID)</span><br><span class="line">        <span class="comment">// 將 photoID 陣列轉換成照片物件陣列</span></span><br><span class="line">        .map(<span class="function"><span class="params">photoID</span> =&gt;</span> photos.find(<span class="function"><span class="params">p</span> =&gt;</span> p.id === photoID))</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><figcaption><span>resolvers/photo.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; users, photos, tags &#125; = <span class="built_in">require</span>(<span class="string">"../models/data"</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; GraphQLScalarType &#125; = <span class="built_in">require</span>(<span class="string">"graphql"</span>);</span><br><span class="line"><span class="keyword">const</span> timestamp = <span class="built_in">require</span>(<span class="string">'monotonic-timestamp'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  Query: &#123;</span><br><span class="line">    totalPhotos: <span class="function"><span class="params">()</span> =&gt;</span> photos.length,</span><br><span class="line">    allPhotos: <span class="function"><span class="params">()</span> =&gt;</span> photos</span><br><span class="line">  &#125;,</span><br><span class="line">  Mutation: &#123;</span><br><span class="line">    postPhoto(parent, args) &#123;</span><br><span class="line">      <span class="keyword">let</span> newPhoto = &#123;</span><br><span class="line">        id: timestamp().toString(),</span><br><span class="line">        ...args.input,</span><br><span class="line">        created: <span class="keyword">new</span> <span class="built_in">Date</span>()</span><br><span class="line">      &#125;;</span><br><span class="line">      photos.push(newPhoto);</span><br><span class="line">      <span class="keyword">return</span> newPhoto;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  Photo: &#123;</span><br><span class="line">    url: <span class="function"><span class="params">parent</span> =&gt;</span> <span class="string">`https://fakeimg.pl/120x160/?text=<span class="subst">$&#123;parent.id&#125;</span>`</span>,</span><br><span class="line">    postedBy: <span class="function"><span class="params">parent</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> users.find(<span class="function"><span class="params">u</span> =&gt;</span> u.appLogin === parent.appUser);</span><br><span class="line">    &#125;,</span><br><span class="line">    taggedUsers: <span class="function"><span class="params">parent</span> =&gt;</span></span><br><span class="line">      tags</span><br><span class="line">        <span class="comment">// 回傳一個只含當前照片的 tag 陣列</span></span><br><span class="line">        .filter(<span class="function"><span class="params">tag</span> =&gt;</span> tag.photoID === parent.id)</span><br><span class="line">        <span class="comment">// 將 tag 陣列轉換成 userID 陣列</span></span><br><span class="line">        .map(<span class="function"><span class="params">tag</span> =&gt;</span> tag.userID)</span><br><span class="line">        <span class="comment">// 將 userID 陣列轉換成使用者物件陣列</span></span><br><span class="line">        .map(<span class="function"><span class="params">userID</span> =&gt;</span> users.find(<span class="function"><span class="params">u</span> =&gt;</span> u.appLogin === userID))</span><br><span class="line">  &#125;,</span><br><span class="line">  DateTime: <span class="keyword">new</span> GraphQLScalarType(&#123;</span><br><span class="line">    name: <span class="string">"DateTime"</span>,</span><br><span class="line">    description: <span class="string">"有效的日期時間值"</span>,</span><br><span class="line">    parseValue: <span class="function"><span class="params">value</span> =&gt;</span> <span class="keyword">new</span> <span class="built_in">Date</span>(value),</span><br><span class="line">    serialize: <span class="function"><span class="params">value</span> =&gt;</span> <span class="keyword">new</span> <span class="built_in">Date</span>(value).toISOString(),</span><br><span class="line">    parseLiteral: <span class="function"><span class="params">ast</span> =&gt;</span> ast.value</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><figcaption><span>resolvers/index.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> userResolvers = <span class="built_in">require</span>(<span class="string">'./user'</span>);</span><br><span class="line"><span class="keyword">const</span> photoResolvers = <span class="built_in">require</span>(<span class="string">'./photo'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = [userResolvers, photoResolvers];</span><br></pre></td></tr></table></figure>

<p>由於 Apollo Server 也接受一個解析器映射陣列，resolvers/index.js 文件中導入所有解析器映射，並將它們 export 為解析器映射列表。現在的模組化好多了。</p>
<p>接下來我們需要把資料移往資料庫了。</p><p style="text-align: right;">接續下一篇 <a href="/2019/11/07/GraphQL-API-4/" title="建立 GraphQL API (4)">建立 GraphQL API (4)</a></p><p></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://1184yang.github.io/2019/11/06/GraplQL-API-3/" data-id="ckcpzj966001b80vzl312mh2g" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-GraphQL-API-2" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/11/06/GraphQL-API-2/" class="article-date">
  <time datetime="2019-11-06T03:46:51.000Z" itemprop="datePublished">2019-11-06</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/GraphQL/">GraphQL</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/11/06/GraphQL-API-2/">建立 GraphQL API (2)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="邊與連結"><a href="#邊與連結" class="headerlink" title="邊與連結"></a>邊與連結</h3><p>GraphQL 的威力來自於邊 (edge)，也就是資料點之間的連結。當你建構 GraphQL 伺服器時，型態 (type) 通常對應模型 (model)。你可以想像這些型態就像資料被存放在資料庫的資料表 (table) 內，我們可以在那裡用連結 (connections) 來連結型態。接下來我們要來探討可以使用哪種連結來定義型態之間的相互關係。</p>
<h4 id="一對多連結"><a href="#一對多連結" class="headerlink" title="一對多連結"></a>一對多連結</h4><p>使用者必須能夠讀取貼過的照片。我們要在一個名為 postedPhotos 的欄位讀取這種資料，它會被解析成使用者貼過的照片清單，而且這些照片會被過濾。</p>
<p>因為一位 User 可貼出多張 Photos，我們將它稱為一對多關係。我們將 User 加入 typeDefs:</p>
<figure class="highlight js"><figcaption><span>typeDefs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">type User &#123;</span><br><span class="line">  appLogin: ID!</span><br><span class="line">  name: <span class="built_in">String</span></span><br><span class="line">  avatar: <span class="built_in">String</span></span><br><span class="line">  postedPhotos: [Photo!]!</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此時，我們已經建立一個有向圖了。我們可以從 User 型態走到 Photo 型態。要產生無向圖，我們必須提供一條從 Photo 型態走回 User 型態的連結。我們在 Photo 型態加入 postedBy 欄位:</p>
<figure class="highlight js"><figcaption><span>typeDefs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">type Photo &#123;</span><br><span class="line">  id: ID!</span><br><span class="line">  url: <span class="built_in">String</span>!</span><br><span class="line">  name: <span class="built_in">String</span>!</span><br><span class="line">  description: <span class="built_in">String</span></span><br><span class="line">  category: PhotoCategory!</span><br><span class="line">  postedBy: User!</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>藉由加入 postedBy 欄位，我們建立一條可返回貼出 Photo 的 User 的連結，建立一個無向圖。這是一對一連結，因為一張照片只能由一位 User 貼出。</p>
<p>為了測試伺服器，我們需要一些樣本資料，往後我們會將資料移到資料庫。先移除 index.js 中設定的空陣列 photos 變數。在專案的根目錄下建立一個子目錄 models 來放我們的樣本資料 data.js:</p>
<figure class="highlight js"><figcaption><span>models/data.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">exports.users = [</span><br><span class="line">  &#123; <span class="attr">appLogin</span>: <span class="string">"scott"</span>, <span class="attr">name</span>: <span class="string">"老虎 Scott"</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">appLogin</span>: <span class="string">"blake"</span>, <span class="attr">name</span>: <span class="string">"葛蘭特 Blake"</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">appLogin</span>: <span class="string">"james"</span>, <span class="attr">name</span>: <span class="string">"麥克 James"</span> &#125;</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">exports.photos = [</span><br><span class="line">  &#123;</span><br><span class="line">    id: <span class="string">"1"</span>,</span><br><span class="line">    name: <span class="string">"Dropping the Heart Chute"</span>,</span><br><span class="line">    description: <span class="string">"是我最喜歡的 Chute"</span>,</span><br><span class="line">    category: <span class="string">"ACTION"</span>,</span><br><span class="line">    appUser: <span class="string">"blake"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    id: <span class="string">"2"</span>,</span><br><span class="line">    name: <span class="string">"Enjoying the sunshine"</span>,</span><br><span class="line">    category: <span class="string">"SELFIE"</span>,</span><br><span class="line">    appUser: <span class="string">"james"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    id: <span class="string">"3"</span>,</span><br><span class="line">    name: <span class="string">"Gunbarrel 25"</span>,</span><br><span class="line">    description: <span class="string">"25 laps on gunbarrel today"</span>,</span><br><span class="line">    category: <span class="string">"LANDSCAPE"</span>,</span><br><span class="line">    appUser: <span class="string">"james"</span></span><br><span class="line">  &#125;</span><br><span class="line">];</span><br></pre></td></tr></table></figure>

<p>然後將它加入 index.js 中:</p>
<figure class="highlight js"><figcaption><span>index.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; users, photos &#125; = <span class="built_in">require</span>(<span class="string">'./models/data'</span>);</span><br></pre></td></tr></table></figure>

<p>因為連結是用物件型態的欄位建立的，所以它們可以對應解析函式。在這些函式中，我們可以使用父物件的資料來協助找到有關的資料並回傳。</p>
<p>我們將 postedPhotos 與 postedBy 解析函式加入服務:</p>
<figure class="highlight js"><figcaption><span>resolvers</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> resolvers = &#123;</span><br><span class="line">  ...</span><br><span class="line">  Photo: &#123;</span><br><span class="line">    url: <span class="function"><span class="params">parent</span> =&gt;</span> <span class="string">`https://fakeimg.pl/120x160/?text=<span class="subst">$&#123;parent.id&#125;</span>`</span>,</span><br><span class="line">    postedBy: <span class="function"><span class="params">parent</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> users.find(<span class="function"><span class="params">u</span> =&gt;</span> u.appLogin === parent.appUser)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  User: &#123;</span><br><span class="line">    postedPhotos: <span class="function"><span class="params">parent</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> photos.filter(<span class="function"><span class="params">p</span> =&gt;</span> p.appUser === parent.appLogin)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>我們必須在 Photo postedBy 欄位加入一個解析函式。我們可以自行決定如何在這個解析函式裡找到連結的資料。這裡我們使用陣列的 find( ) 方法取得 appLogin 符合每張照片的 appUser 值的使用者。</p>
<p>我們在 User 解析函式裡面使用陣列的 filter( ) 方法來取得該位使用者貼過的照片。這個 filter( ) 方法會回傳一個照片陣列。</p>
<p>接著我們試著傳送 allPhotos query:</p>
<figure class="highlight plain"><figcaption><span>query</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">query photos &#123;</span><br><span class="line">  allPhotos &#123;</span><br><span class="line">    name</span><br><span class="line">    url</span><br><span class="line">    postedBy &#123;</span><br><span class="line">      name</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><figcaption><span>result</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;data&quot;: &#123;</span><br><span class="line">    &quot;allPhotos&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;name&quot;: &quot;Dropping the Heart Chute&quot;,</span><br><span class="line">        &quot;url&quot;: &quot;https://fakeimg.pl/120x160/?text=1&quot;,</span><br><span class="line">        &quot;postedBy&quot;: &#123;</span><br><span class="line">          &quot;name&quot;: &quot;葛蘭特 Blake&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;name&quot;: &quot;Enjoying the sunshine&quot;,</span><br><span class="line">        &quot;url&quot;: &quot;https://fakeimg.pl/120x160/?text=2&quot;,</span><br><span class="line">        &quot;postedBy&quot;: &#123;</span><br><span class="line">          &quot;name&quot;: &quot;麥克 James&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;name&quot;: &quot;Gunbarrel 25&quot;,</span><br><span class="line">        &quot;url&quot;: &quot;https://fakeimg.pl/120x160/?text=3&quot;,</span><br><span class="line">        &quot;postedBy&quot;: &#123;</span><br><span class="line">          &quot;name&quot;: &quot;麥克 James&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我們要自行連接資料與解析函式，但是一旦我們能夠回傳那個連接的資料，用戶端就可以開始編寫功能強大的 query。你可以在 allPhotos query 的 postedBy 下載加入 postedPhotos 看看:</p>
<figure class="highlight plain"><figcaption><span>query</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">query photos &#123;</span><br><span class="line">  allPhotos &#123;</span><br><span class="line">    name</span><br><span class="line">    url</span><br><span class="line">    postedBy &#123;</span><br><span class="line">      name</span><br><span class="line">      postedPhotos &#123;</span><br><span class="line">        name</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="多對多"><a href="#多對多" class="headerlink" title="多對多"></a>多對多</h4><p>接下來要在服務中加入 “在照片中標記使用者” 的功能。這意味著一位 User 可被標記 (tag) 在許多不同的照片中，而一張照片裡面可以標記許多不同的使用者。使用者與照片透過標記建立的關係稱為<strong>多對多</strong>，多位使用者對多張照片。</p>
<p>為了建立多對多關係，我們在 Photo 加入 taggedUsers 欄位，在 User 加入 inPhotos 欄位。</p>
<figure class="highlight js"><figcaption><span>typeDefa</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">type User &#123;</span><br><span class="line">  ...</span><br><span class="line">  inPhotos: [Photo!]!</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">type Photo &#123;</span><br><span class="line">  ...</span><br><span class="line">  taggedUsers: [User!]!</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>taggedUsers 欄位會回傳一串使用者，而 inPhotos 欄位會回傳內含某位使用者的照片串列。</p>
<p>為了實作這個多對多連結，我們要在樣本資料中加入一個標記 (tags) 陣列，這是一個定義多對多關係的資料，它提供了兩組資料之間的交集。在關連式資料庫中稱為 intersection table，它定義兩個多對多資料表之間的關係。</p>
<figure class="highlight js"><figcaption><span>models/data.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">exports.tags = [</span><br><span class="line">  &#123; <span class="attr">photoID</span>: <span class="string">"1"</span>, <span class="attr">userID</span>: <span class="string">"blake"</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">photoID</span>: <span class="string">"2"</span>, <span class="attr">userID</span>: <span class="string">"james"</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">photoID</span>: <span class="string">"2"</span>, <span class="attr">userID</span>: <span class="string">"scott"</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">photoID</span>: <span class="string">"2"</span>, <span class="attr">userID</span>: <span class="string">"blake"</span> &#125;</span><br><span class="line">];</span><br></pre></td></tr></table></figure>

<p>然後 import 到 index.js 中:</p>
<figure class="highlight js"><figcaption><span>index.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; users, photos, tags &#125; = <span class="built_in">require</span>(<span class="string">'./models/data'</span>);</span><br></pre></td></tr></table></figure>

<p>當我們有張照片時，必須搜尋 tags 資料集來找出在照片中被標記的使用者。當我們有一位使用者時，就可以找到內含該使用者的照片串列。因為目前的資料放在 JavaScript 陣列裡面，所以我們在解析函式裡面使用陣列方法來尋找資料</p>
<figure class="highlight js"><figcaption><span>resolvers</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Photo: &#123;</span><br><span class="line">  ...</span><br><span class="line">  taggedUsers: <span class="function"><span class="params">parent</span> =&gt;</span> tags</span><br><span class="line">    <span class="comment">// 回傳一個只含當前照片的 tag 陣列</span></span><br><span class="line">    .filter(<span class="function"><span class="params">tag</span> =&gt;</span> tag.photoID === parent.id)</span><br><span class="line">    <span class="comment">// 將 tag 陣列轉換成 userID 陣列，我們只需要 userID 屬性</span></span><br><span class="line">    .map(<span class="function"><span class="params">tag</span> =&gt;</span> tag.userID)</span><br><span class="line">    <span class="comment">// 將 userID 陣列轉換成使用者物件陣列</span></span><br><span class="line">    .map(<span class="function"><span class="params">userID</span> =&gt;</span> users.find(<span class="function"><span class="params">u</span> =&gt;</span> u.appLogin === userID))</span><br><span class="line">&#125;,</span><br><span class="line">User: &#123;</span><br><span class="line">  ...</span><br><span class="line">  inPhotos: <span class="function"><span class="params">parent</span> =&gt;</span> tags</span><br><span class="line">    <span class="comment">// 回傳一個只含有當前使用者的 tag 陣列</span></span><br><span class="line">    .filter(<span class="function"><span class="params">tag</span> =&gt;</span> tag.userID === parent.appLogin)</span><br><span class="line">    <span class="comment">// 將 tag 陣列轉換成 PhotoID 陣列，我們只需要 photoID 屬性</span></span><br><span class="line">    .map(<span class="function"><span class="params">tag</span> =&gt;</span> tag.photoID)</span><br><span class="line">    <span class="comment">// 將 photoID 陣列轉換成照片物件陣列</span></span><br><span class="line">    .map(<span class="function"><span class="params">photoID</span> =&gt;</span> photos.find(<span class="function"><span class="params">p</span> =&gt;</span> p.id === photoID))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>taggedUsers 欄位解析函式會濾除所有非當前照片的照片，並將過濾後的串列對應到實際的 User 物件組成的陣列。inPhotos 欄位解析函式會用使用者來過濾標記，並將使用者標記對應到實際的 Photo 物件組成的陣列。</p>
<p>接著我們可以傳送一個 GraphQL query 來查看每一張照片中有哪些使用者被標記:</p>
<figure class="highlight plain"><figcaption><span>query</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">query listPhotos &#123;</span><br><span class="line">  allPhotos &#123;</span><br><span class="line">    name</span><br><span class="line">    url</span><br><span class="line">    taggedUsers &#123;</span><br><span class="line">      name</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>你應該會發現，我們有個 tags 的陣列，但沒有稱為 Tag 的 GraphQL 型態。GraphQL 並不要求資料模型完全匹配 schema 內的型態。用戶端可以藉由查詢 User 型態或 Photo 型態在每張照片找到被標記的使用者，以及有某位使用者被標記的照片。他們不需要查詢 Tag 型態，這只會讓事情更複雜。我們已經完成在解析函式中尋找被標記的使用者或照片的工作了，這可以讓用戶端更容易查詢這些資料。</p>
<p style="text-align: right;">接續下一篇 <a href="/2019/11/06/GraplQL-API-3/" title="建立 GraphQL API (3)">建立 GraphQL API (3)</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://1184yang.github.io/2019/11/06/GraphQL-API-2/" data-id="ckcpzj95m000e80vzh7gzpdsv" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-GraphQL-API-1" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/11/06/GraphQL-API-1/" class="article-date">
  <time datetime="2019-11-06T00:36:46.000Z" itemprop="datePublished">2019-11-06</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/GraphQL/">GraphQL</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/11/06/GraphQL-API-1/">建立 GraphQL API (1)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>瞭解了 query 與 schema 後，我們要開始建立一個 GraphQL 服務。這可以採用各種不同的技術來完成，但是接下來我們要使用 JavaScript。因為它可以同時使用在伺服器端(Node.js)與客戶端(Browser JavaScript)。</p>
<p>當 GraphQL 在 2015 年發表規格時，它把焦點放在 “明確地解釋查詢語言與型態系統”，刻意不講明伺服器的實作細節，允許具備各種語言背景的開發者使用他們最熟悉的語言。Facebook 的團隊則以 JavaScript 寫了一個參考作品，稱為 <a href="https://graphql.org/" target="_blank" rel="noopener">GraphQL.js</a>，並且與它一起發表了 <a href="https://graphql.org/graphql-js/running-an-express-graphql-server/" target="_blank" rel="noopener">express-graphql</a>；它是以 Express 建構 GraphQL 伺服器的簡單做法，值得特別強調的是，它是第一個可協助開發者完成工作的程式庫。</p>
<p>介紹了用 JavaScript 製作 GraphQL 伺服器後，我們選擇使用 <a href="https://www.apollographql.com/docs/apollo-server/" target="_blank" rel="noopener">Apollo Server</a>，它是 Apollo 團隊提供的開放原始碼解決方案。Apollo Server 相當容易設定，且提供一系列的準產品功能，包括訂閱支援、檔案上傳、可快速連接既有服務的資料來源 API ，及立即可用的 Apollo Engine 集成。它也包含 GraphQL Playground，可讓你直接在瀏覽器內編寫 query。</p>
<h2 id="Node-js-with-GraphQL-and-Apollo-Server"><a href="#Node-js-with-GraphQL-and-Apollo-Server" class="headerlink" title="Node.js with GraphQL and Apollo Server"></a>Node.js with GraphQL and Apollo Server</h2><p>Apollo Server 可以與 Express、Koa、Hapi 等 Node.js 的架構一起使用。 它與類別庫無關，因此可以將其與客戶端和服務器端應用程序中的許多不同的第三方程式庫連接。在此應用程序中，我們將使用 Express，因為它是Node.js 中最流行和最常見的中間件庫套件(Middleware library)。這是我們的 <a href="/useful/nodejs.pdf" target="_blank">Node.js 教育訓練文件</a>，第 253 頁開始有詳細談到 Express。</p>
<h3 id="設定專案"><a href="#設定專案" class="headerlink" title="設定專案"></a>設定專案</h3><p>首先在電腦裡面用一個空的資料夾建立 <strong>graphql-sample-api</strong> 專案。然後切換到 graphql-sample-api 目錄，在終端視窗或命令提示字元使用 <em>npm init -y</em> 命令在這個資料夾裡面建立一個新的 npm 專案。這個工具程式會產生一個 package.json 檔案，因為我們使用 -y 旗標，所有的選項都會被設成預設值。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd graphql-sample-api</span><br><span class="line"></span><br><span class="line">npm init -y</span><br></pre></td></tr></table></figure>

<p>接著安裝兩個專案套件: apollo-server 與 apollo-server-express</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install apollo-server apollo-server-express --save</span><br></pre></td></tr></table></figure>

<p>正如在程式庫名稱中所看到的，你可以使用任何其他中間件解決方案（例如，Koa 或 Hapi）來補充獨立的 Apollo 服務器。你不一定要使用 Express 與 Apollo Server Express，但它可以整合 Express 與 Apollo Server，這樣你除了可以使用 Apollo Server 的所有功能，也可以使用 Express 中介軟體，設定更客製化的組態。</p>
<p>除了Apollo Server 的這些程式庫之外，還需要 Express 和 GraphQL 的核心程式庫：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install express graphql --save</span><br></pre></td></tr></table></figure>

<p>你也可以選擇性的加入 CORS 套件。因為同源準則的限制，當你要跨域向服務器執行 HTTP 請求，需要設定同源準則策略，否則，您可能會遇到 GraplQL 伺服器的跨域資源共享錯誤。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install cors --save</span><br></pre></td></tr></table></figure>

<p>除此之外，我們還可以安裝 nodemon。nodemon 將監視檔案的變更，並且在我們做出更改時重新啟動伺服器。如此一來，我們就不用在每次更改時都要停止並重新啟動伺服器。但這應該只用在開發階段，避免用在正式上線時。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install nodemon --save-dev</span><br></pre></td></tr></table></figure>

<p>然後我們在 package.json 的 scripts 鍵加入 nodemon 命令:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">"scripts": &#123;</span><br><span class="line">  "start": "nodemon -e js,json,graphql"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>現在當我們使用 npm start 啟動專案後，nodemon 會監視副檔名為 js、json 或 graphql 的任何檔案的異動。此外，我們要在專案根目錄建立一個 index.js 檔案。並確定 package.json 裡面的 main 鍵值指向 index.js，這會是這個專案的入口點:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">"main": "index.js"</span><br></pre></td></tr></table></figure>

<p>現在我們可以開始在 index.js 建立我們的程式碼了:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; ApolloServer, gql &#125; = <span class="built_in">require</span>(<span class="string">'apollo-server-express'</span>);</span><br><span class="line"><span class="keyword">const</span> cors = <span class="built_in">require</span>(<span class="string">'cors'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = express();</span><br><span class="line"></span><br><span class="line">app.use(cors());</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> typeDefs = gql<span class="string">`</span></span><br><span class="line"><span class="string">  type Query &#123;</span></span><br><span class="line"><span class="string">    sayHello: String!</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">`</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> resolvers = &#123;</span><br><span class="line">  Query: &#123;</span><br><span class="line">    sayHello: <span class="function"><span class="params">()</span> =&gt;</span> <span class="string">"哈囉，台南! 就從這裡開始。"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> server = <span class="keyword">new</span> ApolloServer(&#123;</span><br><span class="line">  typeDefs,</span><br><span class="line">  resolvers</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">server.applyMiddleware(&#123; app &#125;);</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/'</span>, (req, res) =&gt; res.end(<span class="string">"Welcome to the GraphQL Sample API"</span>));</span><br><span class="line"></span><br><span class="line">app.listen(&#123; <span class="attr">port</span>: <span class="number">4000</span> &#125;, () =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`GraphQL Server running @ http://localhost:4000<span class="subst">$&#123;server.graphqlPath&#125;</span>`</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>第 21 行使用 ApolloServer 建構式建立一個新的伺服器實例，傳送含有兩個值 typeDefs 與 resolvers 的物件給建構式。 </p>
</blockquote>
<blockquote>
<p>第 9 行 typeDefs 是定義 GraphQL schema 的地方，這只是個字串。</p>
</blockquote>
<blockquote>
<p>第 15 行 resolvers 是定義 GraphQL resolver 的地方。截至目前為止，我們則還未談到解析函式 (resolver)，稍後我們再談。</p>
</blockquote>
<blockquote>
<p>第 26 行我們呼叫 applyMiddleWare 將 Express 加進來，這樣我們就可以使用 Express 框架提供的所有中介函式了。</p>
</blockquote>
<p>現在使用 npm start 啟動 GraphQL API，然後就可以用瀏覽器造訪我們的 <a href="http://localhost:4000/graphql" target="_blank" rel="noopener">GraphQL API</a> 了。 試試這個 query:</p>
<figure class="highlight plain"><figcaption><span>query</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  sayHello</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>瀏覽器的右半邊回傳:</p>
<figure class="highlight json"><figcaption><span>result</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"data"</span>: &#123;</span><br><span class="line">    <span class="attr">"sayHello"</span>: <span class="string">"哈囉，台南! 就從這裡開始。"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>好了，你已經建立了一個 GraphQL API 伺服器。</p>
<p>繼續往下之前，我們需要來了解甚麼是解析函式 (resolver)。</p>
<h3 id="解析函式-Resolver"><a href="#解析函式-Resolver" class="headerlink" title="解析函式 Resolver"></a>解析函式 Resolver</h3><p>截至目前為止，我們在討論 GraphQL 時將重點都放在 query 上。schema 定義了用戶端可執行的查詢操作，以及各種型態之間的關係。 schema 描述了資料需求，但不會執行取得該資料的的工作，這是解析函式的工作。</p>
<p><strong>解析函式</strong> (<em>resolver</em>) 是回傳特定欄位(field)資料的函式。解析函式會以 schema 定義的型態與外形來回傳資料。解析函式可非同步執行，也可以從 REST API、資料庫或任何其它服務抓取或上傳資料。</p>
<p>我們來看一下根 Query (Root Query) 的解析函式長得如何。在上述 index.js 中，typeDefs 變數是定義 schema 的地方，這只是個<strong>字串</strong>，resolvers 變數則是個<strong>物件</strong>:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> typeDefs = <span class="string">`</span></span><br><span class="line"><span class="string">  type Query &#123;</span></span><br><span class="line"><span class="string">    sayHello: String!</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">`</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> resolvers = &#123;</span><br><span class="line">  Query: &#123;</span><br><span class="line">    sayHello: <span class="function"><span class="params">()</span> =&gt;</span> <span class="string">"哈囉，台南! 就從這裡開始。"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>這裡 sayHello 是根 Query 的一個<strong>欄位 (field)</strong>，當我們建立 sayHello 這類的 query 時，必須提供一個<strong>名稱相同</strong>的解析函式來支援它。我們用型態定義來描述該欄位(sayHello)應回傳那一種型態。解析函式會從某處回傳該型態的值，在此只是個靜態字串值 “哈囉，台南! 就從這裡開始。”。</p>
<p>另外要特別注意的是，你必須在 “typename 與 schema 內物件相同的物件” 底下定義解析函式。sayHello 欄位是 schema 中 <strong>Query</strong> 型態物件的一部份，這個欄位的解析函式也必須在 <strong>Query</strong> 物件裡面。</p>
<p>現在可以定義第二個 query，看看如何運作:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> typeDefs = <span class="string">`</span></span><br><span class="line"><span class="string">  type Query &#123;</span></span><br><span class="line"><span class="string">    sayHello: String!</span></span><br><span class="line"><span class="string">    totalPhotos: Int!</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">`</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> resolvers = &#123;</span><br><span class="line">  Query: &#123;</span><br><span class="line">    sayHello: <span class="function"><span class="params">()</span> =&gt;</span> <span class="string">"哈囉，台南! 就從這裡開始。"</span>,</span><br><span class="line">    totalPhotos: <span class="function"><span class="params">()</span> =&gt;</span> <span class="number">42</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>現在試試從 GraphQL Playground 查詢:</p>
<figure class="highlight plain"><figcaption><span>query</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  totalPhotos</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight json"><figcaption><span>result</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"data"</span>: &#123;</span><br><span class="line">    <span class="attr">"totalPhotos"</span>: <span class="number">42</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>解析函式是製作 GraphQL 的關鍵。每個欄位(field)都要有個對應的解析函式。解析函式必須遵守 schema 的規則。它的名稱必須和在 schema 內定義的欄位名稱一樣，而且它必須回傳在 schema 定義的資料型態。</p>
<h3 id="根解析函式"><a href="#根解析函式" class="headerlink" title="根解析函式"></a>根解析函式</h3><p>之前談過，GraphQL API 有 Query、Mutation 與 Subscription 根型態。這些型態位於最頂層，代表 API 的所有入口。到目前為止，我們已經在 Query 型態加入了 sayHello 與 totalPhotos 兩個欄位了，代表 API 可以查詢這些欄位。</p>
<p>我們來為 Mutation 建立根型態。這個 mutation 欄位稱為 postPhoto，它可接收 String 型態的 name 與 description 引數。當 mutation 被送出時，它必須回傳一個 Boolean:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">const typeDefs = `</span><br><span class="line">  type Query &#123;</span><br><span class="line">    sayHello: String!</span><br><span class="line">    totalPhotos: Int!</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  type Mutation &#123;</span><br><span class="line">    postPhoto(name: String! description: String): Boolean!</span><br><span class="line">  &#125;</span><br><span class="line">`;</span><br></pre></td></tr></table></figure>

<p>建立 postPhoto mutation 之後，我們要在 resolvers 物件內加入對應的解析函式:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> photos = [];</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> resolvers = &#123;</span><br><span class="line">  Query: &#123;</span><br><span class="line">    sayHello: <span class="function"><span class="params">()</span> =&gt;</span> <span class="string">"哈囉，台南! 就從這裡開始。"</span>,</span><br><span class="line">    totalPhotos: <span class="function"><span class="params">()</span> =&gt;</span> photos.length</span><br><span class="line">  &#125;,</span><br><span class="line">  Mutation: &#123;</span><br><span class="line">    postPhoto(parent, args) &#123;</span><br><span class="line">      photos.push(args);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>為了不要失去目前的學習焦點，我們建立一個 photos 變數，用來將照片的細節儲存在陣列中，稍後會將照片資料存放到資料庫內。</p>
<p>接著，我們修改第 6 行的 totalPhotos 解析函式，讓它回傳 photos 陣列的長度。當這個欄位被查詢時，它會回傳目前在陣列中的照片數量。</p>
<p>接著加入 postPhoto 解析函式。我們這一次在 postPhoto 函式中使用引數。第一個引數是父物件 (parent) 的參考。在本例，postPhoto 解析函式的父物件是 Mutation，目前我們不會使用父物件的資料，但它必定是解析函式的第一個引數，因此，我們要加入一個預留的 parent 引數，這樣才可以使用解析函式的第二個引數: mutation 的引數。</p>
<p>傳送給 postPhoto 解析函式的第二個引數是傳給這項操作(Operation) 的 GraphQL 引數: name 以及可選的 description。 args 變數是個含有 { name, description } 這兩個屬性的物件，目前這引數代表一個照片物件，所以我們直接將它們傳給 photos 陣列。</p>
<p>接下來我們要在 GraphQL Playground 中測試 postPhoto mutation，傳送一個字串給 name 引數:</p>
<figure class="highlight plain"><figcaption><span>mutation</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mutation newPhoto &#123;</span><br><span class="line">  postPhoto(name: &quot;sample photo&quot;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>這個 mutation 會將照片細節加入陣列，並回傳 true。</p>
<p>接著使用查詢變數(Query Variables)來修改這個 mutation:</p>
<figure class="highlight plain"><figcaption><span>mutation</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mutation newPhoto($name: String!, $description: String) &#123;</span><br><span class="line">  postPhoto(name: $name, description: $description)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>將變數加入 mutation 後( 這裡的變數是 $name 與 $description)，我們必須傳送資料來提供字串變數。我們在 Playground 的左下角將 name 與 description 的值加到 Query Variables 視窗:</p>
<figure class="highlight json"><figcaption><span>Query Variables</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"name"</span>: <span class="string">"sample photo A"</span>,</span><br><span class="line">  <span class="attr">"description"</span>: <span class="string">"我們數據集的示例照片"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="型態解析函式"><a href="#型態解析函式" class="headerlink" title="型態解析函式"></a>型態解析函式</h3><p>當你執行 GraphQL query、mutation 或 subscription 時，它會回傳外形與 query 相同的結果。我們知道解析函式可回傳純量型態(scalar type)值，例如整數、字串與布林，但解析函式也可以回傳物件。</p>
<p>我們要在此應用中建立一個 Photo 型態與一個將會回傳一串 Photo 物件的 allPhotos query 欄位:</p>
<figure class="highlight js"><figcaption><span>index.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> typeDefs = <span class="string">`</span></span><br><span class="line"><span class="string">  type Query &#123;</span></span><br><span class="line"><span class="string">    sayHello: String!</span></span><br><span class="line"><span class="string">    totalPhotos: Int!</span></span><br><span class="line"><span class="string">    allPhotos: [Photo!]!</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  type Mutation &#123;</span></span><br><span class="line"><span class="string">    postPhoto(name: String! description: String): Photo!</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  type Photo &#123;</span></span><br><span class="line"><span class="string">    id: ID!</span></span><br><span class="line"><span class="string">    url: String!</span></span><br><span class="line"><span class="string">    name: String!</span></span><br><span class="line"><span class="string">    description: String</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">`</span>;</span><br></pre></td></tr></table></figure>

<p>因為我們在第 12 行型態定義中加入 Photo 物件與第 5 行加入了 allPhotos query，所以必須在解析函式中做對應的調整。</p>
<p>postPhoto mutation 原來回傳一個布林值，現在將它改為回傳一個外形為 Photo 型態的資料。 allPhotos query  則回傳一串外形與 Photo 型態的物件陣列: </p>
<figure class="highlight js"><figcaption><span>index.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> photos = [];</span><br><span class="line"><span class="keyword">let</span> _id = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> resolvers = &#123;</span><br><span class="line">  Query: &#123;</span><br><span class="line">    sayHello: <span class="function"><span class="params">()</span> =&gt;</span> <span class="string">"哈囉，台南! 就從這裡開始。"</span>,</span><br><span class="line">    totalPhotos: <span class="function"><span class="params">()</span> =&gt;</span> photos.length,</span><br><span class="line">    allPhotos: <span class="function"><span class="params">()</span> =&gt;</span> photos</span><br><span class="line">  &#125;,</span><br><span class="line">  Mutation: &#123;</span><br><span class="line">    postPhoto(parent, args) &#123;</span><br><span class="line">      <span class="keyword">let</span> newPhoto = &#123;</span><br><span class="line">        id: _id++,</span><br><span class="line">        ...args</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      photos.push(newPhoto);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> newPhoto;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>因為 Photo 型態需要一個 ID，所以我們建立一個變數來儲存 ID。我們會在 postPhoto 解析函式裡面遞增這個值來產生 ID。args 變數提供照片的 name 與 description 欄位，但我們也需要 ID。是否建立代碼與時戳之類的變數通常則是由伺服器決定的。</p>
<p>postPhoto mutation 除了會在 photos 加入照片物件外，也會回傳一個外形符合 Photo 型態的物件，而不是回傳布林值。這個物件是用自動產生的 ID 及以 args 傳入的 name 和 description 欄位來建構的。這些物件的外形都符合在 schema 中定義的 Photo 型態的外形，所以我們可以從 allPhotos query 回傳整個 photos 組成的陣列。</p>
<p>我們可以調整 mutation 來確認 postPhoto 可正確的運作。因為回傳的 Photo 是一種型態，我們必須在 mutation 中加入一個選擇組 (第 3、 4、 5 行):</p>
<figure class="highlight plain"><figcaption><span>mutation</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mutation newPhoto($name: String!, $description: String) &#123;</span><br><span class="line">  postPhoto(name: $name, description: $description) &#123;</span><br><span class="line">    id</span><br><span class="line">    name</span><br><span class="line">    description</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>用 mutation 加入一些照片後，使用 allPhotos query 可回傳一個包含所有新增的 Photo 物件的陣列:</p>
<figure class="highlight plain"><figcaption><span>query</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">query listPhotos &#123;</span><br><span class="line">  allPhotos &#123;</span><br><span class="line">    id</span><br><span class="line">    name</span><br><span class="line">    description</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我們也曾經在 Photo 型態中加入一個不可為 null 的 url 欄位。當我們現在在選擇組加入 url 時會發生甚麼事情?</p>
<figure class="highlight plain"><figcaption><span>query</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">query listPhotos &#123;</span><br><span class="line">  allPhotos &#123;</span><br><span class="line">    id</span><br><span class="line">    name</span><br><span class="line">    description</span><br><span class="line">    url</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>當我們在 query 的選擇組加入 url 時，會顯示一個錯誤: <strong>Cannot return null for non-nullable field Photo.url</strong>。我們並未在 postPhoto mutation 的資料集中加入 url 欄位，我們不需要儲存 url，我們<strong>只需要在 query 時產生 url 的資料即可</strong>。schema 的每一個欄位都會對應一個解析函式。我們只要在解析函式清單加入一個 Photo 物件，並定義想要對應解析函式的欄位即可。在本例中，我們想要使用一個函式來協助解析 url:</p>
<figure class="highlight js"><figcaption><span>index.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> resolvers = &#123;</span><br><span class="line">  Query: &#123; ... &#125;,</span><br><span class="line">  Mutation: &#123; ... &#125;,</span><br><span class="line">  Photo: &#123;</span><br><span class="line">    url: <span class="function"><span class="params">parent</span> =&gt;</span> <span class="string">`https://fakeimg.pl/120x160/?text=<span class="subst">$&#123;parent.id&#125;</span>`</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>因為我們要使用 Photo url 的解析函式，所以在解析函式中加入一個 Photo 物件。這個在根部加入的 Photo 解析函式稱為 <em>trivial</em>  <strong>解析函式</strong>。我們會在 resolvers 物件的最頂層加入 trivial 解析函式。如果你沒有指定 trivial 解析函式，GraphQL 會使用<strong>預設</strong>的解析函式，回傳與欄位同名的特性 (例如, Photo.name、Photo.description) 。</p>
<p>在 query 中選擇 Photo 的 url 時會呼叫對應的解析函式。解析函式的第一個引數一定是 parent 物件。在本例中，parent 代表目前被解析的 Photo 物件。假設我們的服務只能處裡 JPEG 圖像，這些圖像是用他們的 Photo ID 來命名的，可以用 <a href="http://yoursite.com/img/${parent.id}.jpg" target="_blank" rel="noopener">http://yoursite.com/img/${parent.id}.jpg</a>  路由來找到(我們這裡沒有實作可以放範例照片的伺服器，所以用一個假圖片的網址)。因為 parent 是 Photo 物件，我們可以透過這個引數來取得照片的 ID，並用它來自動產生當前照片的 URL。</p>
<p>當我們定義 GraphQL schema 時，就是在描述 application 的資料需求。使用解析函式可讓我們有充分的能力與彈性滿足這個需求。函式提供這些能力與彈性。<strong>函式可以是非同步的、可以回傳純量型態和物件，也可以從各種來源回傳資料。解析函式只是個函式，GraphQL schema 的每一個欄位 (field) 都可以對應一個解析函式</strong>。</p>
<h3 id="使用-input-與-enum"><a href="#使用-input-與-enum" class="headerlink" title="使用 input 與 enum"></a>使用 input 與 enum</h3><p>接下來我們要在 typeDefs 加入一種 <strong>enum</strong> 型態: PhotoCategory，以及一種 <strong>input</strong> 型態: PostPhotoInput:</p>
<figure class="highlight javascript"><figcaption><span>typeDefs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">enum PhotoCategory &#123;</span><br><span class="line">  SELFIE</span><br><span class="line">  PORTRAIT</span><br><span class="line">  ACTION</span><br><span class="line">  LANDSCAPE</span><br><span class="line">  GRAPHIC</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">type Photo &#123;</span><br><span class="line">  ...</span><br><span class="line">  category: PhotoCategory!</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">input PostPhotoInput &#123;</span><br><span class="line">  name: <span class="built_in">String</span>!</span><br><span class="line">  category: PhotoCategory=PORTRAIT</span><br><span class="line">  description: <span class="built_in">String</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">type Mutation &#123;</span><br><span class="line">  postPhoto(input: PostPhotoInput!): Photo!</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在解析 Photo 時，我們必須確保照片分類 (它是個字串，應符合在 enum 內定義的值) 是有效的。我們也要在使用者貼出新照片時接收分類。</p>
<p>我們在單一物件下加入一個 PostPhotoInput 型態來整合 postPhoto mutation 的引數。這個 input 型態有個 category 欄位，就算使用者沒有提供引數給 category 欄位，也會使用預設的 PORTRAIT。</p>
<p>我們也必須稍微修改 postPhoto 解析函式。我們將 Photo 的細節，包括 name、description 與 category 放在 input 欄位裡面。我們必須從 args.input 存取這些值，而不是 args:</p>
<figure class="highlight js"><figcaption><span>resolvers</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">postPhoto(parent, args) &#123;</span><br><span class="line">  <span class="keyword">let</span> newPhoto = &#123;</span><br><span class="line">    id: _id++,</span><br><span class="line">    ...args.input</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  photos.push(newPhoto);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> newPhoto;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接著我們用新的 input 型態執行 mutation:</p>
<figure class="highlight plain"><figcaption><span>mutation</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mutation newPhoto($input: PostPhotoInput!) &#123;</span><br><span class="line">  postPhoto(input: $input) &#123;</span><br><span class="line">    id</span><br><span class="line">    name</span><br><span class="line">    url</span><br><span class="line">    description</span><br><span class="line">    category</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我們必須在 Query Variables 面板中傳送對應的 JSON:</p>
<figure class="highlight json"><figcaption><span>Query Variables</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"input"</span>: &#123;</span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"sample photo A"</span>,</span><br><span class="line">    <span class="attr">"description"</span>: <span class="string">"我們數據集的示例照片"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果用戶端沒有提供 category，它會使用預設的 PORTRAIT。或者，如果用戶端提供 category 的值，我們就用 enum 型態來驗證它，再將操作送給伺服器。當它是有效的 category 時，我們用引數將它傳給解析函式。</p>
<p>藉由 input 型態，我們更容易重複使用 “由用戶端傳遞引數給 mutation” 的操作，且較不容易出錯。藉由結合 input 型態與 enum，我們可以更了解特定欄位可用的輸入型態有哪些。input 與 enum 是很棒的功能，且同時使用可發揮更好的效果。</p>
<p style="text-align: right;">接續下一篇 <a href="/2019/11/06/GraphQL-API-2/" title="建立 GraphQL API (2)">建立 GraphQL API (2)</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://1184yang.github.io/2019/11/06/GraphQL-API-1/" data-id="ckcpzj95i000a80vzeyonfnkt" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/3/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Apache-Kafka/">Apache Kafka</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/C/">C#</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/GraphQL/">GraphQL</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/JavaScript/">JavaScript</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Oracle/">Oracle</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/PostgreSQL/">PostgreSQL</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/RabbitMQ/">RabbitMQ</a></li></ul>
    </div>
  </div>


  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">July 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">June 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">May 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/07/13/Sequential-Execution/">Node.js 非同步控制流程模式 - 並行限制與循序執行</a>
          </li>
        
          <li>
            <a href="/2020/06/12/C-Entity-Framework-Core-2-0-and-PostgreSQL-Provider/">C# Entity Framework Core 2.0 and PostgreSQL Provider</a>
          </li>
        
          <li>
            <a href="/2020/06/04/C-Entity-Framework-Core-2-0-and-Oracle-Provider/">C# Entity Framework Core 2.0 and Oracle Provider</a>
          </li>
        
          <li>
            <a href="/2020/06/02/Kafka-RabbitMQ-Electron/">Apache Kafka 與 Electron-RabbitMQ Notification</a>
          </li>
        
          <li>
            <a href="/2020/05/21/Electron-Notification-Buzzer/">Desktop 桌面應用程式 Electron-RabbitMQ Notification</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 J.Y. Yang<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>