<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.9.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=EB Garamond:300,300italic,400,400italic,700,700italic|Cinzel Decorative:300,300italic,400,400italic,700,700italic|Noto Serif TC:300,300italic,400,400italic,700,700italic|Source Code Pro:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"1184yang.github.io","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12,"onmobile":true},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title">
<meta property="og:url" content="https://1184yang.github.io/page/2/index.html">
<meta property="og:site_name">
<meta property="og:locale" content="zh-TW">
<meta name="twitter:card" content="summary">
<meta name="twitter:title">

<link rel="canonical" href="https://1184yang.github.io/page/2/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-TW'
  };
</script>

  <title></title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切換導航欄">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title"></h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首頁</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>歸檔</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分類</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜尋
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜尋..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

  <a href="https://github.com/1184yang?tab=repositories" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://1184yang.github.io/2020/11/03/AWS-Serverless-GraphQL-API/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/1184yang.jpg">
      <meta itemprop="name" content="J.Y. Yang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/11/03/AWS-Serverless-GraphQL-API/" class="post-title-link" itemprop="url">AWS Serverless GraphQL API</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2020-11-03 10:55:37" itemprop="dateCreated datePublished" datetime="2020-11-03T10:55:37+08:00">2020-11-03</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2020-12-24 18:13:30" itemprop="dateModified" datetime="2020-12-24T18:13:30+08:00">2020-12-24</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/JavaScript/" itemprop="url" rel="index"><span itemprop="name">JavaScript</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/AWS/" itemprop="url" rel="index"><span itemprop="name">AWS</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>之前的範例中，我們結合使用 API Gateway 和無伺服器函式創建了一個基本的 API 層。 這種組合非常強大，但是我們尚未與真實的資料庫進行互動。</p>
<p>在本範例中，我們將創建一個與 DynamoDB NoSQL 資料庫互動以執行 CRUD + L (create，read，update，delete 和 list) 操作的 GraphQL API。 你將了解什麼是 GraphQL，為什麼開發人員採用它，以及它是如何工作的。</p>
<p>我們將構建一個便箋應用程序 (notes app)，該應用程序將允許用戶創建，更新和刪除便箋。 它還將啟用 GraphQL 訂閱，以便能即時取得更新，如果有用戶正在使用該應用程序，並且新增了便箋，則其他的用戶將會即時看到新增的便箋。</p>
<p>有關 GraphQL，你可以參考之前的文章，<a href="/2019/07/05/What-is-GraphQL/">什麼是 GraphQL ?</a>。</p>
<p>儘管有多種方法可以實現 GraphQL 伺服器，但在本範例中，我們將使用 AWS AppSync。 AppSync 是一項託管服務，使我們能夠使用 Amplify CLI 快速輕鬆地部署 GraphQL API，解析器 (resolvers) 和數據源。</p>
<h4 id="創建-GraphQL-API"><a href="#創建-GraphQL-API" class="headerlink" title="創建 GraphQL API"></a>創建 GraphQL API</h4><p>現在，我們要使用 GraphQL API 來構建 Notes 應用程序。</p>
<p>首先要創建一個新的 React 應用程序並安裝必要的依賴項。 該應用程序將使用 AWS Amplify client 程式庫與 API 互動，使用 uuid 用於創建唯一的 ID 和用於樣式設置的 Ant Design 程式庫。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">yarn create react-app notesapp</span><br><span class="line"></span><br><span class="line">cd notesapp</span><br><span class="line"></span><br><span class="line">yarn add aws-amplify antd uuid</span><br></pre></td></tr></table></figure>

<p>現在，在新應用程序的根目錄下，創建 Amplify 專案：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">amplify init</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">? Enter a name for the project: notesapp</span><br><span class="line">? Enter a name for the environment: dev</span><br><span class="line">? Choose your default editor: Visual Studio Code</span><br><span class="line">? Choose the type of app that you're building: javascript</span><br><span class="line">Please tell us about your project</span><br><span class="line">? What javascript framework are you using: react</span><br><span class="line">? Source Directory Path: src</span><br><span class="line">? Distribution Directory Path: build</span><br><span class="line">? Build Command:  npm.cmd run-script build</span><br><span class="line">? Start Command: npm.cmd run-script start</span><br><span class="line">? Do you want to use an AWS profile? Yes</span><br><span class="line">? Please choose the profile you want to use default</span><br></pre></td></tr></table></figure>

<p>初始化 Amplify 專案後，我們可以添加 GraphQL API：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">amplify add api</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">? Please select from one of the below mentioned services: GraphQL</span><br><span class="line">? Provide API name: notesapi</span><br><span class="line">? Choose the default authorization type for the API: API key</span><br><span class="line">? Enter a description for the API key: public</span><br><span class="line">? After how many days from now the API key should expire (1-365): 365</span><br><span class="line">? Do you want to configure advanced settings for the GraphQL API: No, I am done.</span><br><span class="line">? Do you have an annotated GraphQL schema? No</span><br><span class="line">? Choose a schema template: Single object with fields (e.g., “Todo” with ID, name, description)</span><br><span class="line">? Do you want to edit the schema now? (y/N) Y</span><br></pre></td></tr></table></figure>

<p>接下來，在你的編輯器中打開位於 notesapp/amplify/backend/api/notesapi/schema.graphql 的基本 GraphQL schema (由 CLI 生成)。 將 schema 更新為以下內容：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">type Note @model &#123;</span><br><span class="line">  id: ID!</span><br><span class="line">  clientId: ID</span><br><span class="line">  name: <span class="built_in">String</span>!</span><br><span class="line">  description: <span class="built_in">String</span></span><br><span class="line">  completed: <span class="built_in">Boolean</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>這個 schema 具有一個主要的 Note 類型，其中包含五個字段。字段可以為可為 nullable (不是必需)或 non-nullable (必需)。 用 ！ 指定 non-nullable 字段。</p>
<p>此架構中的 Note 類型以 @model 指令註釋。 該指令不是 GraphQL SDL 的一部分； 它是 AWS Amplify GraphQL Transform 程式庫的一部分。</p>
<p>GraphQL Transform 程式庫允許你使用 @model、@connection、@auth 等不同的指令註釋GraphQL schema。</p>
<p>我們在此架構中使用的 @model 指令會將基本 Note 類型轉換為擴展的 AWS AppSync GraphQL API，並具有：</p>
<ol>
<li>附加的 schema queries 和 mutations 的其他架構定義 (Create、Read、Update、Delete、和 List 操作)。</li>
<li>附加的 GraphQL schema subscriptions 的架構定義。</li>
<li>DynamoDB 資料庫。</li>
<li>映射到 DynamoDB 資料庫的所有 GraphQL 操作的解析器代碼(resolver code)。</li>
</ol>
<p>只需定義好 GraphQL schema Note 類型，現在，執行 push 命令部署 API：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">amplify push</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">? Are you sure you want to continue? Yes</span><br><span class="line">? Do you want to generate code for your newly created GraphQL API: Yes</span><br><span class="line">? Choose the code generation language target: javascript</span><br><span class="line">? Enter the file name pattern of graphql queries, mutations and subscriptions: src\graphql\**\*.js</span><br><span class="line">? Do you want to generate/update all possible GraphQL operations - queries, mutations and subscriptions: Yes</span><br><span class="line">? Enter maximum statement depth [increase from default if your schema is deeply nested]: 2</span><br></pre></td></tr></table></figure>

<p>部署完成後，將在你的帳戶中成功創建 API 和資料庫。 接下來，讓我們在 AWS 控制台中打開新創建的 AppSync API，並測試一些 GraphQL 操作。</p>
<h4 id="AWS-AppSync-控制台"><a href="#AWS-AppSync-控制台" class="headerlink" title="AWS AppSync 控制台"></a>AWS AppSync 控制台</h4><p>你隨時可以打開 AWS AppSync 控制台：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">amplify console api</span><br></pre></td></tr></table></figure>

<p>這會在瀏覽器打開 AppSync 控制台，單擊左側菜單中的 Queries 以打開查詢編輯器。在這裡，你可以使用 API 測試 GraphQL queries、mutations、和 subscriptions。</p>
<p>首先，我們要用 mutation 新增一筆便箋資料。 在查詢編輯器中，執行以下的 mutation：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mutation createNote &#123;</span><br><span class="line">  createNote(input: &#123;</span><br><span class="line">    name: &quot;流感疫苗&quot;</span><br><span class="line">    description: &quot;門診時順便施打疫苗&quot;</span><br><span class="line">    completed: false</span><br><span class="line">  &#125;) &#123;</span><br><span class="line">    id name description completed</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src="/2020/11/03/AWS-Serverless-GraphQL-API/20201103-01.png" title="AWS AppSync Console">

<p>現在，您已經建立了一個項目，你可以嘗試查詢它。 讓我們查詢應用程序中的所有便箋：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">query listNotes &#123;</span><br><span class="line">  listNotes &#123;</span><br><span class="line">    items &#123;</span><br><span class="line">      id</span><br><span class="line">      name</span><br><span class="line">      description</span><br><span class="line">      completed</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>你也可以用 ID 查詢單筆便箋：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">query getNote &#123;</span><br><span class="line">  getNote(id: &quot;&lt;NOTE_ID&gt;&quot;) &#123;</span><br><span class="line">    id</span><br><span class="line">    name</span><br><span class="line">    description</span><br><span class="line">    completed</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用 AWS Serverless GraphQL API，定義好 GraphQL schema 後，我們沒有寫任何一行 GraphQL 代碼。現在 GraphQL API 已部署並且可以正常運行，讓我們開始編寫一些前端代碼。</p>
<h4 id="構建前端-React-應用程序"><a href="#構建前端-React-應用程序" class="headerlink" title="構建前端 React 應用程序"></a>構建前端 React 應用程序</h4><p>我們需要做的第一件事是配置 React 應用程序以識別位於 src/aws-exports.js 的 Amplify 資源。 為此，請打開 src/index.js 並在最後一個 import 下面添加以下內容：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Amplify <span class="keyword">from</span> <span class="string">'aws-amplify'</span></span><br><span class="line"><span class="keyword">import</span> config <span class="keyword">from</span> <span class="string">'./aws-exports'</span></span><br><span class="line">Amplify.configure(config)</span><br></pre></td></tr></table></figure>

<h5 id="Listing-Notes-GraphQL-Query"><a href="#Listing-Notes-GraphQL-Query" class="headerlink" title="Listing Notes (GraphQL Query)"></a>Listing Notes (GraphQL Query)</h5><p>現在已經配置了應用程序，可以開始對 GraphQL API 進行調用。 我們將要執行的第一個操作將是 GraphQL query 以列出所有便箋。</p>
<p>這個查詢將返回一個陣列，我們將使用陣列的 map 映射所有項目，顯示便箋的 name，description 以及是否已經 completed。</p>
<p>在 src/App.js 中，首先將以下內容加入文件頂部：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; useEffect, useReducer &#125; <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"><span class="keyword">import</span> &#123; API &#125; <span class="keyword">from</span> <span class="string">'aws-amplify'</span></span><br><span class="line"><span class="keyword">import</span> &#123; List &#125; <span class="keyword">from</span> <span class="string">'antd'</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">'antd/dist/antd.css'</span></span><br><span class="line"><span class="keyword">import</span> &#123; listNotes &#125; <span class="keyword">from</span> <span class="string">'./graphql/queries'</span></span><br></pre></td></tr></table></figure>

<ul>
<li>useEffect and useReducer<br>這是 React Hooks。可參考<a href="/2020/10/12/Enhancing-Components-with-Hooks/">這裡</a>。</li>
<li>API<br>這是我們將用於與 AppSync 端點進行互動的 GraphQL 客戶端(類似於 fetch 或 axios)。</li>
<li>List<br><a href="https://ant.design/" target="_blank" rel="noopener">Ant Design</a> 程式庫中的 UI 組件 以渲染呈現列表。</li>
<li>listNotes<br>用於獲取便箋陣列的 GraphQL query 查詢操作。</li>
</ul>
<p>接下來，我們將需要創建一個變數來保存我們的初始應用程序狀態。 因為我們的應用程序將保存並使用多個狀態變數，所以我們將使用 React 的 <a href="/2020/10/20/Enhancing-Components-with-Hooks-3/">useReducer 掛鉤</a>來管理狀態。</p>
<p>useReducer 具有以下 API：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> [state, dispatch] = useReducer(reducer &lt;<span class="function"><span class="keyword">function</span>&gt;, <span class="title">initialState</span> &lt;<span class="title">any</span>&gt;)</span></span><br></pre></td></tr></table></figure>

<p>useReducer 接受兩個參數，</p>
<ol>
<li>類型為 (state, action) =&gt; newState 的 reducer 函式。</li>
<li>initialState 初始值。</li>
</ol>
<p>基本的用法如下:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Example of some basic state */</span></span><br><span class="line"><span class="keyword">const</span> initialState = &#123; <span class="attr">notes</span>: [] &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Example of a basic reducer */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reducer</span>(<span class="params">state, action</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span>(action.type) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'SET_NOTES'</span>:</span><br><span class="line">      <span class="keyword">return</span> &#123; ...state, <span class="attr">notes</span>: action.notes &#125;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> state</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Implementing useReducer */</span></span><br><span class="line"><span class="keyword">const</span> [state, dispatch] = useReducer(reducer: &lt;function&gt;, initialState: &lt;any&gt;)</span><br><span class="line"></span><br><span class="line">/* Sending an update to the reducer */</span><br><span class="line">const notes = [&#123; name: 'Hello Tainan' &#125;]</span><br><span class="line">dispatch(&#123; type: 'SET_NOTES', notes: notes &#125;)</span><br><span class="line"></span><br><span class="line">/* Using the state in your app */</span><br><span class="line">&#123;</span><br><span class="line">  state.notes.map(note =&gt; &lt;p&gt;&#123;note.name&#125;&lt;/p&gt;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>調用時，useReducer 掛鉤會返回一個包含兩個項目的陣列：</p>
<ol>
<li>state: 應用程序 state 變數並賦予初始狀態值。</li>
<li>dispatch: 這是一個函式，此函式會調用 reducer 函式更新應用程序 state 變數值。</li>
</ol>
<p>這裡的 Notes 應用程序的初始狀態將包含一個用於便箋的 notes，form values 表單值，error 錯誤和 loading 加載狀態的陣列。</p>
<p>在 src/App.js 中，在最後一個 import 之後添加 initialState 物件：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> initialState = &#123;</span><br><span class="line">  notes: [],</span><br><span class="line">  loading: <span class="literal">true</span>,</span><br><span class="line">  error: <span class="literal">false</span>,</span><br><span class="line">  form: &#123; <span class="attr">name</span>: <span class="string">''</span>, <span class="attr">description</span>: <span class="string">''</span>&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然後創建 reducer。 目前，reducer 只具有設置 notes 陣列或設置錯誤狀態兩種事例：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reducer</span>(<span class="params">state, action</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span>(action.type) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'SET_NOTES'</span>:</span><br><span class="line">      <span class="keyword">return</span> &#123; ...state, <span class="attr">notes</span>: action.notes, <span class="attr">loading</span>: <span class="literal">false</span> &#125;;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'ERROR'</span>:</span><br><span class="line">      <span class="keyword">return</span> &#123; ...state, <span class="attr">loading</span>: <span class="literal">false</span>, <span class="attr">error</span>: <span class="literal">true</span> &#125;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> state</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下來，我們要更新 App 主函式。最後整個 src/App.js 會如下:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; useEffect, useReducer &#125; <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"><span class="keyword">import</span> &#123; API &#125; <span class="keyword">from</span> <span class="string">'aws-amplify'</span></span><br><span class="line"><span class="keyword">import</span> &#123; List &#125; <span class="keyword">from</span> <span class="string">'antd'</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">'antd/dist/antd.css'</span></span><br><span class="line"><span class="keyword">import</span> &#123; listNotes &#125; <span class="keyword">from</span> <span class="string">'./graphql/queries'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> initialState = &#123;</span><br><span class="line">  notes: [],</span><br><span class="line">  loading: <span class="literal">true</span>,</span><br><span class="line">  error: <span class="literal">false</span>,</span><br><span class="line">  form: &#123; <span class="attr">name</span>: <span class="string">''</span>, <span class="attr">description</span>: <span class="string">''</span>&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reducer</span>(<span class="params">state, action</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span>(action.type) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'SET_NOTES'</span>:</span><br><span class="line">      <span class="keyword">return</span> &#123; ...state, <span class="attr">notes</span>: action.notes, <span class="attr">loading</span>: <span class="literal">false</span> &#125;;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'ERROR'</span>:</span><br><span class="line">      <span class="keyword">return</span> &#123; ...state, <span class="attr">loading</span>: <span class="literal">false</span>, <span class="attr">error</span>: <span class="literal">true</span> &#125;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> state</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">App</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [state, dispatch] = useReducer(reducer, initialState)</span><br><span class="line"></span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    fetchNotes()</span><br><span class="line">  &#125;, [])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">fetchNotes</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> notesData = <span class="keyword">await</span> API.graphql(&#123;</span><br><span class="line">        query: listNotes</span><br><span class="line">      &#125;)</span><br><span class="line">      dispatch(&#123; <span class="attr">type</span>: <span class="string">'SET_NOTES'</span>, <span class="attr">notes</span>: notesData.data.listNotes.items &#125;)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'error: '</span>, err)</span><br><span class="line">      dispatch(&#123; <span class="attr">type</span>: <span class="string">'ERROR'</span> &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">renderItem</span>(<span class="params">item</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;List.Item style=&#123;styles.item&#125;&gt;</span><br><span class="line">        &lt;List.Item.Meta </span><br><span class="line">          title=&#123;item.name&#125;</span><br><span class="line">          description=&#123;item.description&#125;</span><br><span class="line">        /&gt;</span><br><span class="line">      &lt;<span class="regexp">/List.Item&gt;</span></span><br><span class="line"><span class="regexp">    )</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">  return (</span></span><br><span class="line"><span class="regexp">    &lt;div style=&#123;styles.container&#125;&gt;</span></span><br><span class="line"><span class="regexp">      &lt;List </span></span><br><span class="line"><span class="regexp">        loading=&#123;state.loading&#125;</span></span><br><span class="line"><span class="regexp">        dataSource=&#123;state.notes&#125;</span></span><br><span class="line"><span class="regexp">        renderItem=&#123;renderItem&#125;</span></span><br><span class="line"><span class="regexp">      /</span>&gt;</span><br><span class="line">    &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">const styles = &#123;</span></span><br><span class="line"><span class="regexp">  container: &#123; padding: 20 &#125;,</span></span><br><span class="line"><span class="regexp">  input: &#123; marginBottom: 10 &#125;,</span></span><br><span class="line"><span class="regexp">  item: &#123;textAlign: 'left' &#125;,</span></span><br><span class="line"><span class="regexp">  p: &#123; color: '#1890ff', cursor: 'pointer' &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">export default App;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>第 26 行，調用 useReducer 並傳入 reducer 和 initialState 以創建 state 和 dispatch 變數。</li>
<li>第 32 行，fetchNotes 函式將調用 AppSync API，並在 API 調用成功後於第 37 行以一個 action 物件當引數調用 dispatch 函式，用來重置 notes 陣列。</li>
<li>第 28 行，透過 useEffect 掛鉤來調用 fetchNotes 函式初始化 notes 陣列。</li>
<li>第 57 行，我們使用 Ant Design 的 List 組件。 該組件將映射到陣列(dataSource)上，並調用 renderItem 函式為陣列中的每個項目返回一個 UI 組件。</li>
<li>第 66 行，為我們將用於此應用程序的組件創建一些樣式。</li>
</ul>
<p>現在我們可以啟動 app 了！</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">yarn start</span><br></pre></td></tr></table></figure>

<p>你應該會在瀏覽器上看到當前 notes 便箋列表。</p>
<img src="/2020/11/03/AWS-Serverless-GraphQL-API/20201103-02.png" title="List notes">

<h4 id="Creating-Notes-GraphQL-Mutation"><a href="#Creating-Notes-GraphQL-Mutation" class="headerlink" title="Creating Notes (GraphQL Mutation)"></a>Creating Notes (GraphQL Mutation)</h4><p>現在你已經知道要如何查詢便箋列表，再來讓我們看一下如何新增便箋。我們需要:</p>
<ol>
<li>用於建立新便箋的 HTML 表單。</li>
<li>當用戶輸入表單時更新狀態的函式。</li>
<li>將新便箋添加到 UI，並發送 API 調用 GraphQL API 以便將新便箋存入資料庫的函式。</li>
</ol>
<p>首先，導入 UUID 程式庫，以便可以為客戶端創建唯一的標識符，以便稍後在實現訂閱時，我們可以識別創建便箋的客戶端。 </p>
<p>我們還將從 Ant Design 導入 Input 和 Button 組件：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; v4 <span class="keyword">as</span> uuid &#125; <span class="keyword">from</span> <span class="string">'uuid'</span></span><br><span class="line"><span class="keyword">import</span> &#123; List, Input, Button &#125; <span class="keyword">from</span> <span class="string">'antd'</span></span><br></pre></td></tr></table></figure>

<p>接下來，您將需要導入 GraphQL createNote mutation 定義：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createNote <span class="keyword">as</span> CreateNote &#125; <span class="keyword">from</span> <span class="string">'./graphql/mutations'</span></span><br></pre></td></tr></table></figure>

<p>然後在最後一個 import 下面創建一個新的 CLIENT_ID 變數：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> CLIENT_ID = uuid();</span><br></pre></td></tr></table></figure>

<p>更新 reducer 函式中的 switch 語句以添加三個新案例。</p>
<ol>
<li>向本地端的狀態添加新便箋</li>
<li>重置 HTML 表單狀態以清除表單</li>
<li>用戶輸入時更新表單狀態</li>
</ol>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="string">'ADD_NOTE'</span>:</span><br><span class="line">  <span class="keyword">return</span> &#123; ...state, <span class="attr">notes</span>: [action.note, ...state.notes]&#125;</span><br><span class="line"><span class="keyword">case</span> <span class="string">'RESET_FORM'</span>:</span><br><span class="line">  <span class="keyword">return</span> &#123; ...state, <span class="attr">form</span>: initialState.form &#125;</span><br><span class="line"><span class="keyword">case</span> <span class="string">'SET_INPUT'</span>:</span><br><span class="line">  <span class="keyword">return</span> &#123; ...state, <span class="attr">form</span>: &#123; ...state.form, [action.name]: action.value &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>接下來，在 App 主函式內創建 createNote 函式：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">createNote</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; form &#125; = state</span><br><span class="line">  <span class="keyword">if</span> (!form.name || !form.description) &#123;</span><br><span class="line">    <span class="keyword">return</span> alert(<span class="string">'please enter a name and description'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> note = &#123; ...form, <span class="attr">clientId</span>: CLIENT_ID, <span class="attr">completed</span>: <span class="literal">false</span>, <span class="attr">id</span>: uuid() &#125;</span><br><span class="line">  dispatch(&#123; <span class="attr">type</span>: <span class="string">'ADD_NOTE'</span>, note &#125;)</span><br><span class="line">  dispatch(&#123; <span class="attr">type</span>: <span class="string">'RESET_FORM'</span> &#125;)</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">await</span> API.graphql(&#123;</span><br><span class="line">      query: CreateNote,</span><br><span class="line">      variables: &#123; <span class="attr">input</span>: note &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'successfully created note!'</span>)</span><br><span class="line">  &#125; <span class="keyword">catch</span> (err ) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'error: '</span>, err)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>  

<p>在此函式中，我們在第 10 行 API 調用成功之前先在第 7 行更新本地狀態。 這被稱為 <strong>optimistic response</strong>。 這樣做是因為我們希望用戶在添加新便箋後立即更新用戶界面。 如果 API 調用失敗，則可以在 catch 區塊中實現某些功能並通知用戶錯誤訊息。</p>
<p>現在，在 App 主函式內創建一個 onChange 處理函式，以在用戶輸入即時更新表單狀態：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">onChange</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">  dispatch(&#123; <span class="attr">type</span>: <span class="string">'SET_INPUT'</span>, <span class="attr">name</span>: e.target.name, <span class="attr">value</span>: e.target.value &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最後，我們將更新 UI 以添加表單組件。 在 List 組件之前，添加以下兩個輸入和按鈕：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Input</span> </span></span><br><span class="line"><span class="tag">  <span class="attr">onChange</span>=<span class="string">&#123;onChange&#125;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">value</span>=<span class="string">&#123;state.form.name&#125;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">placeholder</span>=<span class="string">"Note Name"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">name</span>=<span class="string">'name'</span></span></span><br><span class="line"><span class="tag">  <span class="attr">style</span>=<span class="string">&#123;styles.input&#125;</span></span></span><br><span class="line"><span class="tag">/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Input</span> </span></span><br><span class="line"><span class="tag">  <span class="attr">onChange</span>=<span class="string">&#123;onChange&#125;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">value</span>=<span class="string">&#123;state.form.description&#125;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">placeholder</span>=<span class="string">"Note description"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">name</span>=<span class="string">'description'</span></span></span><br><span class="line"><span class="tag">  <span class="attr">style</span>=<span class="string">&#123;styles.input&#125;</span></span></span><br><span class="line"><span class="tag">/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Button</span> </span></span><br><span class="line"><span class="tag">  <span class="attr">onClick</span>=<span class="string">&#123;createNote&#125;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">type</span>=<span class="string">"primary"</span></span></span><br><span class="line"><span class="tag">&gt;</span>Create Note<span class="tag">&lt;/<span class="name">Button</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>現在，我們應該能夠使用該表單建立新的便箋。</p>
<img src="/2020/11/03/AWS-Serverless-GraphQL-API/20201103-03.png" title="Create new notes">

<h4 id="Deleting-Notes-GraphQL-Mutation"><a href="#Deleting-Notes-GraphQL-Mutation" class="headerlink" title="Deleting Notes (GraphQL Mutation)"></a>Deleting Notes (GraphQL Mutation)</h4><p>接下來，讓我們看一下如何刪除便箋。</p>
<p>首先，導入 deleteNote mutation。</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; </span><br><span class="line">  createNote <span class="keyword">as</span> CreateNote,</span><br><span class="line">  deleteNote <span class="keyword">as</span> DeleteNote</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'./graphql/mutations'</span>  </span><br></pre></td></tr></table></figure>

<p>然後，在 App 主函式內創建一個 deleteNote 函式：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">deleteNote</span>(<span class="params">&#123; id &#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> index = state.notes.findIndex( <span class="function"><span class="params">n</span> =&gt;</span> n.id === id)</span><br><span class="line">  <span class="keyword">const</span> notes = [</span><br><span class="line">    ...state.notes.slice(<span class="number">0</span>, index),</span><br><span class="line">    ...state.notes.slice(index + <span class="number">1</span>)</span><br><span class="line">  ];</span><br><span class="line">  dispatch(&#123; <span class="attr">type</span>: <span class="string">'SET_NOTES'</span>, notes &#125;)</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">await</span> API.graphql(&#123;</span><br><span class="line">      query: DeleteNote,</span><br><span class="line">      variables: &#123; <span class="attr">input</span>: &#123; id &#125;&#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'successfully deleted note!'</span>)</span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(&#123; err &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>現在，更新 renderItem 函式中的 List.Item 組件，以將將會調用 deleteNote 函式的刪除按鈕添加到 actions 屬性中，並傳入該要刪除的項目：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">List.Item</span> </span></span><br><span class="line"><span class="tag">  <span class="attr">style</span>=<span class="string">&#123;styles.item&#125;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">actions</span>=<span class="string">&#123;[</span></span></span><br><span class="line">    &lt;p style=&#123;styles.p&#125; onClick=&#123;() =&gt; deleteNote(item)&#125;&gt;Delete&lt;/p&gt;</span><br><span class="line">  ]&#125;</span><br><span class="line">&gt;</span><br><span class="line">  <span class="tag">&lt;<span class="name">List.Item.Meta</span> </span></span><br><span class="line"><span class="tag">    <span class="attr">title</span>=<span class="string">&#123;item.name&#125;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">description</span>=<span class="string">&#123;item.description&#125;</span></span></span><br><span class="line"><span class="tag">  /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">List.Item</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>現在，我們應該可以刪除便箋。</p>
<img src="/2020/11/03/AWS-Serverless-GraphQL-API/20201103-04.png" title="Create new notes">

<h4 id="Updating-Notes-GraphQL-Mutation"><a href="#Updating-Notes-GraphQL-Mutation" class="headerlink" title="Updating Notes (GraphQL Mutation)"></a>Updating Notes (GraphQL Mutation)</h4><p>再來我們要添加更新便箋的功能。</p>
<p>首先，導入 updateNote mutation。</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; </span><br><span class="line">  createNote <span class="keyword">as</span> CreateNote,</span><br><span class="line">  deleteNote <span class="keyword">as</span> DeleteNote,</span><br><span class="line">  updateNote <span class="keyword">as</span> UpdateNote</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'./graphql/mutations'</span></span><br></pre></td></tr></table></figure>

<p>然後，在 App 主函式內創建一個 updateNote 函式：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">updateNote</span>(<span class="params">note</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> index = state.notes.findIndex( <span class="function"><span class="params">n</span> =&gt;</span> n.id === note.id)</span><br><span class="line">  <span class="keyword">const</span> notes = [...state.notes]</span><br><span class="line">  notes[index].completed = !note.completed</span><br><span class="line">  dispatch(&#123; <span class="attr">type</span>: <span class="string">'SET_NOTES'</span>, notes &#125;)</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">await</span> API.graphql(&#123;</span><br><span class="line">      query: UpdateNote,</span><br><span class="line">      variables: &#123; <span class="attr">input</span>: &#123; <span class="attr">id</span>: note.id, <span class="attr">completed</span>: notes[index].completed &#125;&#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'note successfully updated!'</span>)</span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'error: '</span>, err)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最後，在 renderItem 函式中的 List.Item 組件新增一個更新按鈕。</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&lt;List.Item </span><br><span class="line">  style=&#123;styles.item&#125;</span><br><span class="line">  actions=&#123;[</span><br><span class="line">    &lt;p style=&#123;styles.p&#125; onClick=&#123;() =&gt; deleteNote(item)&#125;&gt;Delete&lt;<span class="regexp">/p&gt;,</span></span><br><span class="line"><span class="regexp">    &lt;p style=&#123;styles.p&#125; onClick=&#123;() =&gt; updateNote(item)&#125;&gt;</span></span><br><span class="line"><span class="regexp">      &#123;item.completed ? 'completed' : 'mark completed'&#125;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>p&gt;</span><br><span class="line">  ]&#125;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>

<p>現在，我們應該能夠將便箋更新為 <em>completed</em> 或 <em>not completed</em>。</p>
<img src="/2020/11/03/AWS-Serverless-GraphQL-API/20201103-05.png" title="Create new notes">

<h4 id="Real-Time-Data-GraphQL-Subscriptions"><a href="#Real-Time-Data-GraphQL-Subscriptions" class="headerlink" title="Real-Time Data (GraphQL Subscriptions)"></a>Real-Time Data (GraphQL Subscriptions)</h4><p>最後，我們將實現的一個功能是 <strong>subscribe to updates in real time</strong> 即時訂閱。</p>
<p>我們要訂閱的是當有新便箋新增時，要讓我們的應用程序能夠即時接收到新便箋，更新 notes 陣列，然後將更新後的 notes 陣列呈現到螢幕上。</p>
<p>使用 GraphQL subscription，您可以訂閱不同的事件。 這些事件通常是某種類型的 mutation (on create、on update、on delete)。 當這些事件之一發生時，該事件的數據將發送到已初始化訂閱的客戶端，然後由你決定要如何處理送到客戶端的數據。</p>
<p>要讓訂閱可以運作，你僅需在 useEffect 掛鉤中初始化訂閱，並在觸發訂閱時將 ADD_NOTE 類型與便箋數據一起用 dispatch 發送出去。</p>
<p>首先，導入 onCreateNote subscription。</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; onCreateNote &#125; <span class="keyword">from</span> <span class="string">'./graphql/subscriptions'</span></span><br></pre></td></tr></table></figure>

<p>接下來，使用以下代碼更新 App 主函式內 useEffect 掛鉤：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  fetchNotes()</span><br><span class="line">  <span class="keyword">const</span> subscription = API.graphql(&#123;</span><br><span class="line">    query: onCreateNote</span><br><span class="line">  &#125;).subscribe(&#123;</span><br><span class="line">    next: <span class="function"><span class="params">noteData</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> note = noteData.value.data.onCreateNote</span><br><span class="line">      <span class="keyword">if</span> (CLIENT_ID === note.clientId) <span class="keyword">return</span></span><br><span class="line">      dispatch(&#123; <span class="attr">type</span>: <span class="string">'ADD_NOTE'</span>, note &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> subscription.unsubscribe()</span><br><span class="line">&#125;, [])</span><br></pre></td></tr></table></figure>

<p>在此，我們訂閱了 onCreateNote 事件。 當有新便箋建立時，將觸發此事件，並用便箋數據作為引數調用 next 函式。</p>
<p>在 next 函式中我們獲取便箋數據，並檢查我們的客戶端是否是創建便箋的應用程序。 如果我們的客戶創建了便箋，我們將不做任何運作，避免同一筆資料重複加入 notes 陣列。如果我們不是創建便箋的客戶，則將調用 diapatch 執行 ADD_NOTE 操作，加入便箋數據。</p>
<p>現在你可以在瀏覽器開起兩個不同的客戶端，在一個客戶端新增一筆便箋數據，然後切換到另一個客戶端畫面，應該可以看到新增的便箋數據也顯示在螢幕上了。</p>
<p>恭喜，您已經建立了一個無伺服器 GraphQL 應用程序！</p>
<p>要記住以下幾點：</p>
<ul>
<li>GraphQL queries 用於在 GraphQL API 中讀取數據。</li>
<li>GraphQL mutations 用於在 GraphQL API中 創建，更新或刪除數據。</li>
<li>GraphQL subscription 可以用來訂閱 GraphQL API 中的 API 即時事件。</li>
</ul>
<p>使用 AWS Serverless GraphQL API 你可以只要定義 GraphQL schema，不用編寫任何一行的代碼，就可以有 CRUD + L (create，read，update，delete 和 list) 操作的 GraphQL API 與即時的訂閱事件。你只要專心在你客戶端應用程序的邏輯上，並且可以創造一個即時的現代化應用。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://1184yang.github.io/2020/10/30/Getting-Started-with-AWS-Amplify/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/1184yang.jpg">
      <meta itemprop="name" content="J.Y. Yang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/10/30/Getting-Started-with-AWS-Amplify/" class="post-title-link" itemprop="url">AWS Amplify 入門</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2020-10-30 13:58:21" itemprop="dateCreated datePublished" datetime="2020-10-30T13:58:21+08:00">2020-10-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2020-12-24 18:13:30" itemprop="dateModified" datetime="2020-12-24T18:13:30+08:00">2020-12-24</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/JavaScript/" itemprop="url" rel="index"><span itemprop="name">JavaScript</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/AWS/" itemprop="url" rel="index"><span itemprop="name">AWS</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>大多數應用程序的核心是 data/API 層。該層包含很多東西，在無伺服器世界中，這通常由 API 端點和無伺服器函式的組合而成。 這些無伺服器函式可能執行某些邏輯並返回數據、與某種資料庫進行互動，甚至與另一個 API 端點進行互動。</p>
<p>使用 Amplify 創建 API 有兩種主要方法：</p>
<ul>
<li>Amazon API Gateway 和 Lambda 函式的組合。</li>
<li>連接到某種類型的數據源(資料庫、Lambda 函式或 HTTP 端點)的 GraphQL API。</li>
</ul>
<p>API Gateway 是一項 AWS 服務，可讓您創建 API 終端節點，並將它們透過 Lambda 函式路由到不同的服務。 當進行 API 調用時，它將透過 API Gateway 路由，調用 Lambda 函式，然後返迴結果。 使用 Amplify CLI，您可以創建 API Gateway 端點和 Lambda 函式，CLI 會自動將 API 配置為能夠透過 HTTP 請求調用 Lambda 函式。</p>
<p>創建 API 後，您需要一種與之互動的方法。 使用 Amplify client，您將能夠使用 Amplify API class 從客戶端將請求發送到 API Gateway 端點。 API class 允許你與 GraphQL API 以及 API Gateway 端點進行互動。</p>
<img src="/2020/10/30/Getting-Started-with-AWS-Amplify/20201102-01.png" title="AWS API Gateway">

<p>在這個範例中，您將創建第一個簡單的全棧無伺服器應用程序，這個應用程序將透過 API Gateway 端點與無伺服器函式進行互動。 你將會使用 CLI 創建 API 端點以及無伺服器函式，然後使用 Amplify 客戶端程式庫與 API 進行互動。 從這個範例我們將可以學習到無伺服器應用程序的基本運作。</p>
<h3 id="創建和部署無伺服器函式"><a href="#創建和部署無伺服器函式" class="headerlink" title="創建和部署無伺服器函式"></a>創建和部署無伺服器函式</h3><p><strong>無伺服器函式(serverless functions)</strong>是許多無伺服器應用程序的核心。無伺服器函式在無狀態計算容器(stateless compute containers)中運行代碼，這些容器是事件驅動(event-driven)的、短暫的(short-lived，可能只持續一次調用)，並由雲提供商完全管理。 這些函式可以動態的擴展，不需要擴增額外的伺服器。</p>
<p>大多數人認為無伺服器函式是透過 API 的調用而觸發的，但這些函式也可以由各種不同的事件觸發。 除 HTTP 請求外，一些無伺服器函式常會用在例如將圖像上傳存儲服務、資料庫的新增、更新、或刪除資料，甚至來自其他無伺務器函式。</p>
<p>無伺服器函式會自動擴展，因此，如果流量激增，則無需擔心你的應用程序效能。 第一次調用函式時，服務提供者將創建該函式的實例並運行其處理程序方法(handler method)以處理事件。 函式完成並返迴結果後，它將會被保留並繼續處理其他事件(如果有)。如果在第一個事件仍在處理過程中發生其他調用，則服務將創建另一個實例。</p>
<p>無伺服器函式還具有不同於傳統基礎架構的支付模型。 像 AWS Lambda 之類的服務，您只需對根據函式的請求數量以及代碼執行所耗的時間付費。 這與其他基礎架構之類的服務(無論是否正在使用它們)不同。</p>
<p>現在了解了無伺服器函式的運作概念，我們要來創建一個無伺服器函式，並將其掛接到 HTTP API。</p>
<h4 id="創建-React-應用程序及安裝所需的程式庫"><a href="#創建-React-應用程序及安裝所需的程式庫" class="headerlink" title="創建 React 應用程序及安裝所需的程式庫"></a>創建 React 應用程序及安裝所需的程式庫</h4><p>首先需要創建客戶端 React 應用程序:</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">yarn create react-app amplify-react-api-app</span><br><span class="line"></span><br><span class="line">cd amplify-react-api-app</span><br></pre></td></tr></table></figure>

<p>接下來，需要安裝依賴項。對於此應用程序，只需要 AWS Amplify 程式庫：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">yarn add aws-amplify</span><br></pre></td></tr></table></figure>

<p>安裝依賴項後，現在可以在 React 應用程序的根目錄中初始化一個新的 Amplify 專案：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">amplify init</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">? Enter a name for the project cryptoapp</span><br><span class="line">? Enter a name for the environment local</span><br><span class="line">? Choose your default editor: Visual Studio Code</span><br><span class="line">? Choose the type of app that you're building javascript</span><br><span class="line">Please tell us about your project</span><br><span class="line">? What javascript framework are you using react</span><br><span class="line">? Source Directory Path:  src</span><br><span class="line">? Distribution Directory Path: build</span><br><span class="line">? Build Command:  npm.cmd run-script build</span><br><span class="line">? Start Command: npm.cmd run-script start</span><br><span class="line">Using default provider  awscloudformation</span><br><span class="line"></span><br><span class="line">For more information on AWS Profiles, see:</span><br><span class="line">https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-profiles.html</span><br><span class="line"></span><br><span class="line">? Do you want to use an AWS profile? Yes</span><br><span class="line">? Please choose the profile you want to use default</span><br></pre></td></tr></table></figure>

<p>現在，已經創建了 Amplify 專案和 React 應用程序，可以開始添加新功能。</p>
<h4 id="創建新的無伺服器函式"><a href="#創建新的無伺服器函式" class="headerlink" title="創建新的無伺服器函式"></a>創建新的無伺服器函式</h4><p>下一步，我們將創建將用於此應用程序的無伺服器函式。 在本範例中我們要構建一個加密貨幣應用程序。 首先，將在函式中使用一組硬編碼的加密貨幣的陣列資料，然後將其返回給客戶端。 稍後，我們將更新此函式以調用實際的 API(CoinLore)，以異步方式獲取即時的加密貨幣現值。</p>
<p>要創建無伺服器函式，執行以下命令：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">amplify add function</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">? Select which capability you want to add: Lambda function (serverless function)</span><br><span class="line">? Provide a friendly name for your resource to be used as a label for this category in the project: cryptofunction</span><br><span class="line">? Provide the AWS Lambda function name: cryptofunction</span><br><span class="line">? Choose the runtime that you want to use: NodeJS</span><br><span class="line">? Choose the function template that you want to use: Serverless ExpressJS function (Integration </span><br><span class="line">with API Gateway)</span><br><span class="line">? Do you want to access other resources in this project from your Lambda function? No</span><br><span class="line">? Do you want to invoke this function on a recurring schedule? No</span><br><span class="line">? Do you want to configure Lambda layers for this function? No</span><br><span class="line">? Do you want to edit the local lambda function now? (Y/n) No</span><br></pre></td></tr></table></figure>

<p>現在在專案的根目錄下會產生一個新的子文件夾 <em>amplify</em>，在 amplify 目錄中會看到一個新的子文件夾: amplify/backend/function/cryptofunction</p>
<h4 id="無伺服器函式代碼"><a href="#無伺服器函式代碼" class="headerlink" title="無伺服器函式代碼"></a>無伺服器函式代碼</h4><p>創建此資源時，會在 <em>amplify/backend</em> 中創建了一個 <em>function</em> 的新文件夾。 CLI 創建的所有函式都將存儲在此文件夾中。 目前，您只有一個函式，<strong>cryptofunction</strong> 。 在<em>crytpofunction</em> 文件夾中，您將看到幾個配置文件以及主要功能代碼所在的 src 目錄。</p>
<p>無伺服器函式本質上僅是獨立運行的封裝應用程序。 由於您創建的函式是使用 JavaScript 編寫的，因此你會看到在所有 JavaScript 應用程序中通常都會看到的所有內容，包括 package.json 和 index.js。</p>
<p>接下來，看一下位於 <em>cryptofunction</em> 文件夾中 <em>src/index.js</em> 的函式入口點。 </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> awsServerlessExpress = <span class="built_in">require</span>(<span class="string">'aws-serverless-express'</span>);</span><br><span class="line"><span class="keyword">const</span> app = <span class="built_in">require</span>(<span class="string">'./app'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> server = awsServerlessExpress.createServer(app);</span><br><span class="line"></span><br><span class="line">exports.handler = <span class="function">(<span class="params">event, context</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`EVENT: <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(event)&#125;</span>`</span>);</span><br><span class="line">  <span class="keyword">return</span> awsServerlessExpress.proxy(server, event, context, <span class="string">'PROMISE'</span>).promise;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>在此文件中，您將看到一個名為 <strong>exports.handler</strong> 的函式。 這是無伺服器函式調用的入口點。 調用該無伺服器函式時，這就是運行的代碼。</p>
<p>您可以根據需要直接在此函式中處理事件，但是由於這裡將使用 API，因此更好的方式是透過代理使用 Express 的路由。 這樣做可以在一個函式中提供多個路由，每個路由提供不同的 HTTP 請求方法，例如 get、put、post 、和 delete。 無伺服器框架提供了一種簡便的方法，並且已為您在 <em>src/app.js</em> 文件中內置了函式樣板。</p>
<p>在 index.js 中，你看到的代碼：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">awsServerlessExpress.proxy(server, event, context, 'PROMISE').promise;</span><br></pre></td></tr></table></figure>

<p>此代碼就是將事件，上下文和路徑代理到在 app.js 中運行的 Express 伺務器的地方。</p>
<p>然後，在 app.js 中，你將能夠針對為 API 創建任何的 HTTP 請求路由。</p>
<h4 id="創建-coins-路由"><a href="#創建-coins-路由" class="headerlink" title="創建 /coins 路由"></a>創建 /coins 路由</h4><p>現在了解了應用程序的結構，讓我們在 app.js 中創建一個新的路由，並返回一些數據。 將創建的路由是 /coins 路由。 此路由將返回包含 coins 陣列的物件。</p>
<p>開啟 <em>amplify/backend/function/cryptofunction/src/app.js</em>，在第一個 app.get(‘/items’) 路由之前，添加以下代碼：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">app.get(<span class="string">'/coins'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> coins = [</span><br><span class="line">    &#123;<span class="attr">name</span>: <span class="string">'Bitcoin'</span>, <span class="attr">symbol</span>: <span class="string">'BTC'</span>, <span class="attr">price_usd</span>: <span class="string">"10000"</span>&#125;,</span><br><span class="line">    &#123;<span class="attr">name</span>: <span class="string">'Ethereum'</span>, <span class="attr">symbol</span>: <span class="string">'ETH'</span>, <span class="attr">price_usd</span>: <span class="string">"400"</span>&#125;,</span><br><span class="line">    &#123;<span class="attr">name</span>: <span class="string">'Litecoin'</span>, <span class="attr">symbol</span>: <span class="string">'LTC'</span>, <span class="attr">price_usd</span>: <span class="string">"150"</span>&#125;</span><br><span class="line">  ];</span><br><span class="line">  </span><br><span class="line">  res.json(&#123; coins &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>這裡暫時使用一組硬編碼的加密貨幣信息陣列。 使用此路由調用該函式時，它將以一個物件方式作為回應，該物件包含一個名為 coins 的屬性。</p>
<h4 id="創建一個新的-API"><a href="#創建一個新的-API" class="headerlink" title="創建一個新的 API"></a>創建一個新的 API</h4><p>創建並配置了函式後，現在要在其前端放置一個 API，以便你可以透過 HTTP 請求來觸發它。</p>
<p>為此，我們將使用 Amazon API Gateway。 API Gateway 是一項完全託管的服務，使開發人員能夠創建、發佈、維護、監控、和保護 REST 與 WebSocket API。 Amplify CLI 和 Amplify client 程式庫都有支援 API Gateway。</p>
<p>在這裡，我們會將創建一個新的 API Gateway 端點並將其配置為調用之前所創建的 Lambda 函式。</p>
<p>要創建 API，可以從專案的根目錄使用 Amplify add 命令：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">amplify add api</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">? Please select from one of the below mentioned services: REST</span><br><span class="line">? Provide a friendly name for your resource to be used as a label for this category in the project: cryptoapi</span><br><span class="line">? Provide a path (e.g., /book/&#123;isbn&#125;): /icons</span><br><span class="line">? Choose a Lambda source: Use a Lambda function already added in the current Amplify project</span><br><span class="line">? Choose the Lambda function to invoke by this path: cryptofunction</span><br><span class="line">? Restrict API access: No</span><br><span class="line">? Do you want to add another path? No</span><br></pre></td></tr></table></figure>

<h4 id="部署-API-和-Lambda-函式"><a href="#部署-API-和-Lambda-函式" class="headerlink" title="部署 API 和 Lambda 函式"></a>部署 API 和 Lambda 函式</h4><p>現在已經創建了函式和 API，現在需要將它們部署到你的帳戶中。 為此，要執行 Amplify push 命令：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">amplify push</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">√ Successfully pulled backend environment local from the cloud.</span><br><span class="line"></span><br><span class="line">Current Environment: local</span><br><span class="line"></span><br><span class="line">| Category | Resource name  | Operation | Provider plugin   |</span><br><span class="line">| -------- | -------------- | --------- | ----------------- |</span><br><span class="line">| Function | cryptofunction | Create    | awscloudformation |</span><br><span class="line">| Api      | cryptoapi      | Create    | awscloudformation |</span><br><span class="line">? Are you sure you want to continue? Yes</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">√ All resources are updated in the cloud</span><br><span class="line"></span><br><span class="line">REST API endpoint: https://k1zvup7xx7.execute-api.ap-southeast-1.amazonaws.com/local</span><br></pre></td></tr></table></figure>

<p>您可以隨時使用 Amplify CLI status 命令來查看專案的當前狀態。status 命令將列出專案中所有當前配置的服務並為您提供每個服務的狀態：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">amplify status</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">Current Environment: local</span><br><span class="line"></span><br><span class="line">| Category | Resource name  | Operation | Provider plugin   |</span><br><span class="line">| -------- | -------------- | --------- | ----------------- |</span><br><span class="line">| Function | cryptofunction | No Change | awscloudformation |</span><br><span class="line">| Api      | cryptoapi      | No Change | awscloudformation |</span><br><span class="line"></span><br><span class="line">REST API endpoint: https://k1zvup7xx7.execute-api.ap-southeast-1.amazonaws.com/local</span><br></pre></td></tr></table></figure>

<p>在此狀態輸出中要注意的主要是 <strong>Operation</strong>。 <strong>Operation</strong> 告訴你下次在專案中執行 <strong>push</strong> 時將發生什麼。 <strong>Operation</strong> 屬性會設置為 <strong>Create</strong>、<strong>Update</strong>、<strong>Delete</strong>、或 <strong>No Change</strong>。</p>
<p>這裡也顯示了我們創建的 REST API 端點，你可以測試一下我們創建的 /coins 路由:</p>
<p><a href="https://k1zvup7xx7.execute-api.ap-southeast-1.amazonaws.com/local/coins" target="_blank" rel="noopener">https://k1zvup7xx7.execute-api.ap-southeast-1.amazonaws.com/local/coins</a></p>
<h4 id="與-API-互動"><a href="#與-API-互動" class="headerlink" title="與 API 互動"></a>與 API 互動</h4><p>現在伺服端已經部署了資源，可以開始從客戶端 React 應用程序與 API 進行互動。</p>
<p>要在任何應用程序中使用 Amplify client 客戶端程式庫，通常需要在應用程序最上層 root 層級進行基本配置。</p>
<p>在創建資源時，CLI 會將有關的資源信息記錄在 <strong>aws-exports.js</strong> 文件中。 我們將使用此文件來配置客戶端應用程序以便能與 Amplify 架構一起使用。</p>
<p>要配置該應用，請打開專案根目錄下的 src/index.js，並將以下內容添加到最後一個 import 後面：</p>
<figure class="highlight js"><figcaption><span>src/index.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Amplify <span class="keyword">from</span> <span class="string">'aws-amplify'</span>;</span><br><span class="line"><span class="keyword">import</span> config <span class="keyword">from</span> <span class="string">'./aws-exports'</span>;</span><br><span class="line">Amplify.configure(config);</span><br></pre></td></tr></table></figure>

<h5 id="Amplify-Client-API-類別"><a href="#Amplify-Client-API-類別" class="headerlink" title="Amplify Client API 類別"></a>Amplify Client API 類別</h5><p>在配置客戶端應用程序之後，您可以開始與資源進行互動了。</p>
<p>Amplify client 客戶端程式庫具有各種 API 類別，可以將其導入並用於各種類型的函式中，包括用於身份驗證的 <strong>Auth</strong>，用於 S3 中存儲項目的 <strong>Storage</strong> 以及用於與 REST 和 GraphQL API 進行互動的 API。</p>
<p>在這裡，您將使用 API 類別。 API 有多種可用方法，包括用於與 REST API 互動的 API.get、API.post、API.put、與 API.del。以及用於與 GraphQL API 互動的 API.graphql。</p>
<p>使用 REST API 時，API 包含三個參數：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">API.get(apiName: <span class="built_in">String</span>, <span class="attr">path</span>: <span class="built_in">String</span>, data?: <span class="built_in">Object</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>apiName<br>從創建 API 時提供的名稱。 在我們的範例中，將是 cryptoapi。</li>
<li>path<br>要與之互動的路徑。 在我們的範例中，將是 /coins。</li>
<li>data<br>這是一個可選的物件，其中包含你要傳遞給 API 的所有屬性，包括 headers、query 字符串參數、或 body。</li>
</ul>
<p>在我們的範例中，API 調用將如下所示：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">API.get(<span class="string">'cryptoapi'</span>, <span class="string">'/coins'</span>)</span><br></pre></td></tr></table></figure>

<p>API 返回一個 promise，這意味著您可以使用 promise 或 async 函式處理所有內容。</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">API.get(<span class="string">'cryptoapi'</span>, <span class="string">'/coins'</span>)</span><br><span class="line">  .then(<span class="function"><span class="params">data</span> =&gt;</span> <span class="built_in">console</span>.log(data))</span><br><span class="line">  .catch(<span class="function"><span class="params">error</span> =&gt;</span> <span class="built_in">console</span>.log(error))</span><br></pre></td></tr></table></figure>

<p>或</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> data = <span class="keyword">await</span> API.get(<span class="string">'cryptoapi'</span>, <span class="string">'/coins'</span>)</span><br></pre></td></tr></table></figure>

<p>接下來，讓我們從客戶端調用 API 並渲染數據。 修改專案根目錄下的 src/App.js：</p>
<figure class="highlight jsx"><figcaption><span>src/App.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; useState, useEffect &#125; <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"><span class="keyword">import</span> &#123; API &#125; <span class="keyword">from</span> <span class="string">'aws-amplify'</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">'./App.css'</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">App</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [coins, updateCoins] = useState([])</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">fetchCoins</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> data = <span class="keyword">await</span> API.get(<span class="string">'cryptoapi'</span>, <span class="string">'/coins'</span>)</span><br><span class="line">    updateCoins(data.coins)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    fetchCoins()</span><br><span class="line">  &#125;, [])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div className=<span class="string">"App"</span>&gt;</span><br><span class="line">      &#123;</span><br><span class="line">        coins.map(<span class="function">(<span class="params">coin, index</span>) =&gt;</span> (</span><br><span class="line">          &lt;div key=&#123;index&#125;&gt;</span><br><span class="line">            &lt;h2&gt;&#123;coin.name&#125; - &#123;coin.symbol&#125;&lt;<span class="regexp">/h2&gt;</span></span><br><span class="line"><span class="regexp">            &lt;h5&gt;$&#123;coin.price_usd&#125;&lt;/</span>h5&gt;</span><br><span class="line">          &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">        ))</span></span><br><span class="line"><span class="regexp">      &#125;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>div&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> App;</span><br></pre></td></tr></table></figure>

<p>然後，啟動 app:</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">yarn start</span><br></pre></td></tr></table></figure>

<p>現在你可以從瀏覽器看到:</p>
<img src="/2020/10/30/Getting-Started-with-AWS-Amplify/20201102-02.png" title="AWS API Gateway Example">

<h5 id="調用另一個-API"><a href="#調用另一個-API" class="headerlink" title="調用另一個 API"></a>調用另一個 API</h5><p>接下來，我們將更新 AWS Lambda 函式以調用另一個 API，即 CoinLore API，它將從 CoinLore 服務返回動態的數據。使用者也將能夠設置過濾器，例如 <strong>limit</strong> 與 <strong>start</strong>，限制從 API 返回的項目數量。</p>
<p>首先，你需要一種可以在 Lambda 函式中與 HTTP 端點進行互動的方法。 在本範例中要使用的是 Axios 程式庫。 Axios 是可用於瀏覽器和 Node.js 且是基於 Promise 的 HTTP 客戶端程式庫。</p>
<p>您需要做的第一件事是在 <em>function</em> 文件夾中安裝 Axios 程式庫，以便從 Lambda 函式發送 HTTP 請求。 切換到 <em>amplify/backend/function/cryptofunction/src</em> 目錄，安裝 Axios，然後切換回應用程序的根目錄：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> amplify/backend/<span class="keyword">function</span>/cryptofunction/src</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> yarn add axios</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> ../../../../../</span></span><br></pre></td></tr></table></figure>

<p>接下來，更新 amplify/backend/function/cryptofunction/src/app.js 中的 /coins 路由：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> axios = <span class="built_in">require</span>(<span class="string">'axios'</span>)</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/coins'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> apiUrl = <span class="string">`https://api.coinlore.com/api/tickers/?start=0&amp;limit=10`</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (req.apiGateway &amp;&amp; req.apiGateway.event.queryStringParameters) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; start = <span class="number">0</span>, limit = <span class="number">10</span> &#125; = req.apiGateway.event.queryStringParameters;</span><br><span class="line">    apiUrl = <span class="string">`https://api.coinlore.com/api/tickers/?start=<span class="subst">$&#123;start&#125;</span>&amp;limit=<span class="subst">$&#123;limit&#125;</span>`</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  axios.get(apiUrl)</span><br><span class="line">    .then(<span class="function"><span class="params">response</span> =&gt;</span> &#123;</span><br><span class="line">      res.json(&#123; <span class="attr">coins</span>: response.data.data &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">    .catch(<span class="function"><span class="params">err</span> =&gt;</span> res.json(&#123; <span class="attr">error</span>: err &#125;))</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>在前面的函式中，我們導入了 Axios 程式庫，然後對 CoinLore API 進行了 API 調用。 在 API 調用中，你可以將 start 和 limit 參數傳遞給請求，以定義要返回的項目數量以及起始點。</p>
<p>在 req 參數中，有一個 apiGateway 屬性，用於保存事件(event)和上下文(context)變數。 在函式中，檢查該事件是否存在以及該事件的 queryStringParameters 屬性。 如果 queryStringParameters 屬性存在，我們將使用這些值來更新基本的 URL。 使用 queryStringParameters，用戶可以在查詢 CoinLore API 時指定起始值和極限值。</p>
<p>要注意，這裡修改的是伺服器端的函式，使用的是 Node.js 環境，導入程式庫用的是 require 函式。</p>
<p>函式更新後，在終端中執行 push 命令來部署更新：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">amplify push</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">√ Successfully pulled backend environment local from the cloud.</span><br><span class="line"></span><br><span class="line">Current Environment: local</span><br><span class="line"></span><br><span class="line">| Category | Resource name  | Operation | Provider plugin   |</span><br><span class="line">| -------- | -------------- | --------- | ----------------- |</span><br><span class="line">| Function | cryptofunction | Update    | awscloudformation |</span><br><span class="line">| Api      | cryptoapi      | No Change | awscloudformation |</span><br><span class="line">? Are you sure you want to continue? Yes</span><br></pre></td></tr></table></figure>

<h5 id="更新客戶端"><a href="#更新客戶端" class="headerlink" title="更新客戶端"></a>更新客戶端</h5><p>現在，我們要更新客戶端的 React 應用程序，為用戶提供指定 limit 和 start 參數的選項。</p>
<p>為此，您需要添加用於用戶輸入的字段(field)，並為用戶提供一個按鈕以觸發新的 API 請求。</p>
<p>更改專案根目錄下的 src/App.js：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">App</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [coins, updateCoins] = useState([])</span><br><span class="line">  <span class="keyword">const</span> [input, updateInput] = useState(&#123; <span class="attr">limit</span>: <span class="number">5</span>, <span class="attr">start</span>: <span class="number">0</span> &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">updateInputValues</span>(<span class="params">type, value</span>) </span>&#123;</span><br><span class="line">    updateInput(&#123; ...input, [type]: value &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">fetchCoins</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; limit, start &#125; = input;</span><br><span class="line">    <span class="keyword">const</span> data = <span class="keyword">await</span> API.get(<span class="string">'cryptoapi'</span>, <span class="string">`/coins?limit=<span class="subst">$&#123;limit&#125;</span>&amp;start=<span class="subst">$&#123;start&#125;</span>`</span>)</span><br><span class="line">    updateCoins(data.coins)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    fetchCoins()</span><br><span class="line">  &#125;, [])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div className=<span class="string">"App"</span>&gt;</span><br><span class="line">      &lt;input</span><br><span class="line">        placeholder=<span class="string">"limit"</span></span><br><span class="line">        onChange=&#123;e =&gt; updateInputValues(<span class="string">'limit'</span>, e.target.value)&#125;</span><br><span class="line">      /&gt;</span><br><span class="line">      &lt;input </span><br><span class="line">        placeholder=<span class="string">"start"</span></span><br><span class="line">        onChange=&#123; e =&gt; updateInputValues(<span class="string">'start'</span>, e.target.value)&#125;</span><br><span class="line">      /&gt;</span><br><span class="line">      &lt;button onClick=&#123;fetchCoins&#125;&gt;Fetch Coins&lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">      &lt;div&gt;</span></span><br><span class="line"><span class="regexp">        &#123;</span></span><br><span class="line"><span class="regexp">          coins.map((coin, index) =&gt; (</span></span><br><span class="line"><span class="regexp">            &lt;div key=&#123;index&#125;&gt;</span></span><br><span class="line"><span class="regexp">              &lt;h2&gt;&#123;coin.name&#125; - &#123;coin.symbol&#125;&lt;/</span>h2&gt;</span><br><span class="line">              &lt;h5&gt;$&#123;coin.price_usd&#125;&lt;<span class="regexp">/h5&gt;</span></span><br><span class="line"><span class="regexp">            &lt;/</span>div&gt;</span><br><span class="line">          ))</span><br><span class="line">        &#125;</span><br><span class="line">      &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>div&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然後，啟動 app:</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">yarn start</span><br></pre></td></tr></table></figure>

<p>恭喜，你已經部署了第一個無伺務器 API!</p>
<p>這裡要牢記以下幾點：</p>
<ul>
<li>Lambda 函式可以從各種事件中觸發。 在此範例中，我們使用來自 API Gateway 的 API 調用觸發了該函式。</li>
<li>可以使用 Amplify CLI 的指令 amplify add function 創建 Lambda 函式，並且可以使用 amplify add api 創建 API。</li>
<li>可以將單個 API Gateway 端點配置為與多個 Lambda 函式一起使用。 在此範例中，我們僅將其連接到單個函式。</li>
<li>Lambda 函式本質上是獨立的 Node.js 應用程序。 在此範例中，我們選擇 Express 應用程序來處理諸如 get、post、和 delete 之類的 REST 方法。在這個範例中我們僅使用了 get 調用。</li>
<li>Amplify client 客戶端程式庫中的 API 類別可同時用於 GraphQL 以及 REST API。</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://1184yang.github.io/2020/10/27/Full-Stack-Serverless/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/1184yang.jpg">
      <meta itemprop="name" content="J.Y. Yang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/10/27/Full-Stack-Serverless/" class="post-title-link" itemprop="url">Full Stack Serverless</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2020-10-27 14:03:59" itemprop="dateCreated datePublished" datetime="2020-10-27T14:03:59+08:00">2020-10-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2020-12-24 18:13:30" itemprop="dateModified" datetime="2020-12-24T18:13:30+08:00">2020-12-24</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/JavaScript/" itemprop="url" rel="index"><span itemprop="name">JavaScript</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/AWS/" itemprop="url" rel="index"><span itemprop="name">AWS</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>人們通常將雲計算與後端(backend)開發和開發與維運(DevOps)相關聯。但是，在過去幾年中，這種情況已經開始改變。隨著<strong>功能即服務</strong>(functions as a service, FaaS)的興起以及強大抽象式的託管服務，雲提供商降低了雲計算新手和傳統前端開發人員的進入門檻。</p>
<p>使用現代工具、框架和服務，例如 Amazon Web Services（AWS）Amplify 和 Firebase 等，獨立的開發人員可以利用他們現有的技能，以及對單個框架和生態系統(例如 JavaScript)的知識，來構建過去需要技術熟練的後端團隊和 DevOps 工程師團隊來構建和維護的全棧應用程序，而無須擔心伺服器的問題。</p>
<h4 id="現代的無伺服器概念"><a href="#現代的無伺服器概念" class="headerlink" title="現代的無伺服器概念"></a>現代的無伺服器概念</h4><p><em>Serverless</em> 通常與 FaaS 相關聯。儘管您會對其含義有所不同的定義，但該術語最近已包含更多的意義而不只是共享的定義。</p>
<p>很多時候，人們談論無伺服器時，他們實際上是在描述如何最有效地編寫業務邏輯以呈現業務的價值。重點是編寫業務邏輯，而不是為編寫業務邏輯而必須建構和維護的基礎設施。採用 FaaS 的思維，您可以快速有效的做到這一點。 你不需要其他的託管服務和一些抽象化的思維，也可以構建自定義的解決方案。</p>
<p>越來越多的公司和開發人員正在採用這種方法，隨著這種哲學的日益普及，初創企業和雲提供商可以使用提供的服務和工具來提供簡化後端複雜性的產品和服務。</p>
<p>對於無伺服器在學術研究中認為這是一種 “簡化的雲編程”:</p>
<blockquote>
<blockquote>
<p>雖然雲將功能打包為 FaaS(功能即服務)，代表了無伺服器計算的核心，但雲平台還提供了專門的無伺服器框架，可像 BaaS(後端即服務)一樣滿足特定的應用需求。 簡單地說，無伺服器計算 = FaaS + BaaS。</p>
</blockquote>
</blockquote>
<p>後端即服務(BaaS)通常是指託管服務，例如資料庫(Firestore，Amazon DynamoDB)、身份驗證服務(Auth0，Amanzon Cognito)和人工智能服務(Amanzon Relognition，Amazon Comprehend)等託管服務。在學術的研究中重新定義了無伺服器的含義，這突顯了隨著雲提供商開始構建更多，管理更好的服務。這種無伺服器的思維正在蓬勃的發生中。</p>
<h4 id="無伺服器應用程序的特徵"><a href="#無伺服器應用程序的特徵" class="headerlink" title="無伺服器應用程序的特徵"></a>無伺服器應用程序的特徵</h4><ul>
<li>降低運營責任<br>使用 FaaS，您唯一需要擔心的是代碼中的函式是否正確的運行。不再需要負責伺服器的所有修補，更新，維護和升級。</li>
<li>大量使用託管服務</li>
</ul>
<h4 id="無伺服器架構的好處"><a href="#無伺服器架構的好處" class="headerlink" title="無伺服器架構的好處"></a>無伺服器架構的好處</h4><ul>
<li>可擴展性<br>您不必擔心你的應用程序突然湧入了大量的新用戶，雲提供商將為您處理此事。</li>
<li>成本<br>使用無伺服器技術，您只需為使用的東西付費。使用 FaaS，將根據對功能的請求數，執行功能代碼所花費的時間以及每個功能使用的記憶體來向您收費。</li>
<li>開發速度<br>開發人員只需構建較少的功能，提高工作效率。開發人員不必費心在大多數應用程序所需的典型功能類型，例如，資料庫，身份驗證，存儲和 API，可以快速專注於編寫要交付的核心功能和業務邏輯。</li>
<li>實驗與測試<br>如果您沒有花大量的時間構建一些典型所需的重複功能，就可以低風險輕鬆地進行實驗及測試。 </li>
<li>安全穩定<br>你所使用的核心服務是由雲提供商所提供，所以通常比您自己建立的更加穩定和安全。</li>
<li>更少的代碼<br>代碼是一種責任。有價值的是代碼提供的功能，而不是代碼本身。當您找到實現這些功能的方法，同時限制了您需要維護的代碼量，甚至完全取消了代碼時，您就可以降低應用程序的整體複雜性。複雜性降低，錯誤減少，新工程師更容易上手，維護和添加新功能的人員的總體負載也更少。開發人員可以專注於功能的實現，而無需了解實際的後端運作，並且幾乎不需要編寫後端代碼。</li>
</ul>
<h3 id="不同的無伺服器的實現"><a href="#不同的無伺服器的實現" class="headerlink" title="不同的無伺服器的實現"></a>不同的無伺服器的實現</h3><ul>
<li><h4 id="Serverless-Framework"><a href="#Serverless-Framework" class="headerlink" title="Serverless Framework"></a>Serverless Framework</h4><p>最早與最受歡迎的的無伺務器框架 Severless Framework，是一個免費開放源代碼框架，於2015年10月以 JAWS 的名稱啟動，使用 Node.js 編寫。最初，這個框架僅支援 AWS，但隨後又增加了對 Google 和 Microsoft Azure 等雲提供商的支援。</p>
<p>Serverless Framework 利用配置文件，CLI 和功能代碼的組合，為希望從本地環境將無伺服器功能和其他 AWS 服務部署到雲的人們提供良好的體驗。要使用此框架可能會有一些陡峭的學習曲線，特別是對於不熟悉雲計算的開發人員而言，有很多術語需要學習，還有很多知識需要理解雲服務如何工作，以便構建不僅僅是 “Hello World” 的應用程序。</p>
<p>總體而言，如果您某種程度上了解除了 AWS 之外的雲提供商的能力，那麼 Serverless Framework 是一個不錯的選擇。</p>
</li>
<li><h4 id="The-AWS-Serverless-Application-Model"><a href="#The-AWS-Serverless-Application-Model" class="headerlink" title="The AWS Serverless Application Model"></a>The AWS Serverless Application Model</h4><p>AWS Serverless Applicaton Model(AWS SAM) 是一個開源框架，於2016年11月18日發布，由 AWS 和社區構建和維護。 該框架僅支援 AWS。</p>
<p>SAM 允許您透過在 YAML 文件中定義無伺務器應用程序所需的 API Gateway APIs，AWS Lambda 函式和 Amazon DynamoDB 來構建無伺服器應用程序。它結合使用 YAML 配置和功能代碼以及 CLI 來創建、管理和部署無伺務器應用程序。</p>
</li>
<li><h4 id="Amplify-Framework"><a href="#Amplify-Framework" class="headerlink" title="Amplify Framework"></a>Amplify Framework</h4><p>Amplify Framework 是四項內容的組合：CLI、客戶端程式庫、工具鍊和 Web 託管平台。Amplify 的目的是為開發人員提供一種簡便的方法來構建和部署利用雲的全棧 Web 和移動應用程序。它不僅啟用無伺務器功能和身份驗證等功能，而且還啟用 GraphQL API、機器學習(ML)、存儲、分析、推送通知等功能。</p>
<p>Amplify 消除了 AWS 的新手可能不熟悉的術語，使用類別名稱方法來引用服務，從而提供了一個輕鬆進入雲的切入點。它不是將身份驗證服務稱為 Amazon Cognito，而是稱為 auth，避免新手搞得一頭霧水。</p>
</li>
</ul>
<h3 id="Full-Stack-Serverless-on-AWS"><a href="#Full-Stack-Serverless-on-AWS" class="headerlink" title="Full Stack Serverless on AWS"></a>Full Stack Serverless on AWS</h3><p><em>Full stack serverless</em> 旨在為開發人員提供前、後兩端全棧所需的一切，以實現他們盡快構建應用程序的目標。在這裡，我們將使用 AWS 工具和服務以這種方式構建應用程序。</p>
<h4 id="Amplify-CLI"><a href="#Amplify-CLI" class="headerlink" title="Amplify CLI"></a>Amplify CLI</h4><p>如果您剛開始使用 AWS，那麼大量的服務可能會讓你卻步。除了要識別許多服務之外，每個服務通常都有自己的陡峭的學習曲線。為了緩解這種情況，AWS 創建了 Amplify CLI。</p>
<p>Amplify CLI 為希望在 AWS 上構建應用程序的開發人員提供了一個簡單的入口點。 CLI 允許開發人員直接從其前端環境創建、配置、更新和刪除雲服務。</p>
<p>CLI 使用諸如 <em>storage</em>(Amazon S3)、<em>auth</em>(Amazon Cognito)和 <em>analytics</em>(Amazon Pinpoint)之類的名稱為您提供了一種了解服務實際功能的方法，而不僅僅是提供讓人迷惑的服務名稱。</p>
<h5 id="Amplify-client"><a href="#Amplify-client" class="headerlink" title="Amplify client"></a>Amplify client</h5><p>構建全棧應用程序需要客戶端工具和後端服務的結合。過去，與 AWS 服務互動的主要方式是使用 AWS 軟件開發套件(SDK)，例如 Java、.NET、Node.js、和 Python。 這些 SDK 運作良好，但沒有一個特別適合客戶端開發。在 Amplify 之前，還沒有使用 AWS 構建客戶端應用程序的簡單方法。如果查看 AWS Node.js SDK 的文件，您會了解到，這是一條陡峭的學習曲線。</p>
<p>Amplify 客戶端是一個程式庫，專門為需要與 AWS 服務互動的 JavaScript 應用程序提供了易於使用的 API。 Amplify 還提供用於 React Native、iOS 和 Addroid 的客戶端 SDK。</p>
<p>Amplify 還為流行的前端和移動框架提供 UI 組件，包括 React、React Native、Vue、Angular、Ionic、Android 和 iOS。</p>
<p>Amplify Framework 不支持整套 AWS 服務。相反的，它支持要開發無伺務器類型的應用程序所需要的服務。使用 Amplify，為與 EC2 的互動提供支援並沒有多大意義，但為 REST 和 GraphQL API 提供支援則會比較實際。</p>
<h5 id="AWS-AppSync"><a href="#AWS-AppSync" class="headerlink" title="AWS AppSync"></a>AWS AppSync</h5><p>AWS AppSync 是使用 GraphQL 的託管 API 層，使應用程序易於與任何數據源，REST API 或微服務進行互動。</p>
<p><strong>API 層是應用程序最重要的部分之一</strong>。現代應用程序通常與大量後端服務和 API 進行互動。諸如資料庫、託管服務、第三方 API 和存儲解決方案之類的東西。</p>
<p>微服務架構是使用模塊化組件或服務組合構建的大型應用程序的常用術語。大多數服務和 API 都有不同的實現細節，這在您使用微服務體系結構時會帶來一些挑戰。這導致不一致的代碼，有時甚至是混亂的代碼，以及對這些 API 發出請求的前端開發人員的認知負荷。</p>
<p>使用微服務體系結構的一種好方法是提供一個一致的 API 層，該 API 層將接收所有請求並將其轉發到後端服務。這為你的客戶提供了一個一致的互動層，從而使您的前端開發更加輕鬆。</p>
<p>GraphQL 為創建 API 提供了特別好的抽象層。 GraphQL 引入了一種定義和一致的規範，透過三種操作形式與 API 進行互動：<em>queries</em>(讀取)、<em>mutations</em>(寫入/更新)和 <em>subscriptions</em>(實時數據 real-time data)。這些操作被定義為主要模式的一部分，該主要模式還以 GraphQL 提示的形式提供了客戶端和伺務器之間的協定。GraphQL 操作未綁定到任何特定的數據源，因此，作為開發人員，您可以自由地使用它們與資料庫、HTTP 端點、微服務、甚至是無伺服器功能中的任何內容進行互動。</p>
<p>通常，在構建 GraphQL API 時，您需要處理構建，部署維護和配置自己的 API 的問題。借助 AWS AppSync，您可以卸載伺服器和 API 管理以及使用 AWS 的安全性機制。</p>
<p>現代應用程序通常還涉及 real-time 和 offline 等問題。 AppSync 的另一個好處是，它具有對 offline(Amplify client)和 real time(GraphQL subscriptions)的內建支援，以使開發人員能夠構建這些類型的應用程序。</p>
<h3 id="初步認識-AWS-Amplify-CLI"><a href="#初步認識-AWS-Amplify-CLI" class="headerlink" title="初步認識 AWS Amplify CLI"></a>初步認識 AWS Amplify CLI</h3><h4 id="安裝和設定-Amplify-CLI"><a href="#安裝和設定-Amplify-CLI" class="headerlink" title="安裝和設定 Amplify CLI"></a>安裝和設定 Amplify CLI</h4><p>要使用 Amplify CLI，首先需要安裝 Node.js 10 以上的版本，以及 npm 5 以上的版本。也可以選擇使用 yarn。　</p>
<p>當然也需要一個 AWS 帳戶，你可以選擇從免費的帳戶開始，會要求綁定信用卡，註冊費 1 美元。當你沒有用超過免費的額度，不會收取任何費用。在私人的一般學習的專案應該都不會超過免費的額度。</p>
<p>首先安裝 Amplify CLI:</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npm install -g @aws-amplify/cli</span></span><br></pre></td></tr></table></figure>

<p>安裝 CLI 後，我們將會使用 Amplify CLI 與 AWS 服務互動，這需要用戶憑證。我們不會使用註冊的 AWS 帳戶來連結 AWS 服務，這個註冊的 AWS 帳戶只用來付帳單或登入 AWS 管理用。程式、API 等與 AWS 服務的互動我們要使用 IAM (identify and access management) user。所以我們首先需要使用 IAM  用戶來設定 Amplify CLI。這將會使用一組用戶憑據（accesss key ID 和 secret access key）來設定 CLI。 使用這些憑證，您將能夠直接從 CLI 使用這個 IAM 用戶創建 AWS 服務。</p>
<p>要創建 IAM 新用戶並設定 CLI，要執行 configure 指令：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> amplify configure</span></span><br></pre></td></tr></table></figure>

<p>這將引導你完成以下步驟:</p>
<ol>
<li>指定 AWS 區域<br>您可以選擇要在那區域個創建 IAM 用戶(以及與此用戶相關聯的服務)。選擇離您最近的區域或你偏好的區域。</li>
</ol>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">Scanning for plugins...</span><br><span class="line">Plugin scan successful</span><br><span class="line">Follow these steps to set up access to your AWS account:</span><br><span class="line"></span><br><span class="line">Sign in to your AWS administrator account:</span><br><span class="line">https://console.aws.amazon.com/</span><br><span class="line">Press Enter to continue</span><br></pre></td></tr></table></figure>

<p>   這會開啟瀏覽器要求你登入 AWS:</p>
<img src="/2020/10/27/Full-Stack-Serverless/20201028-01.png" title="AWS login">

<p>回到 CLI 操作畫面，按 Enter 繼續，選擇 AWS 區域，這裡我選擇使用 ap-southeast-1 位於新加坡：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">Specify the AWS Region</span><br><span class="line">? region: </span><br><span class="line">  eu-central-1</span><br><span class="line">  ap-northeast-1</span><br><span class="line">  ap-northeast-2</span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> ap-southeast-1</span></span><br><span class="line">  ap-southeast-2</span><br><span class="line">  ap-south-1</span><br><span class="line">  ca-central-1</span><br><span class="line">(Move up and down to reveal more choices)</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><p>指定 IAM 用戶名</p>
<p>該名稱將是您的 AWS 帳戶中創建的 IAM 用戶。我建議你使用一個稍後在引用時可以識別的名稱，例如 amplify-cli-ap-southeast-1-user 或 mycompany-cli-admin。</p>
</li>
</ol>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">Specify the username of the new IAM user:</span><br><span class="line">? user name:  pec-amplify-cli-admin</span><br></pre></td></tr></table></figure>

<p>   輸入名稱後，CLI 將打開 AWS IAM dashboard。我們可以在這個 dashboard 建立 IAM 用戶。</p>
<p>   IAM 用戶的權限全都透過 Groups 群組設定，所以首先先建立一個群組：</p>
<img src="/2020/10/27/Full-Stack-Serverless/20201028-02.png" title="AWS login">

<p>   這裡我建立一個 admin 群組，權限選擇 AdministratorAccess。剛開始，所以給較大的權限，有經驗後再來建立其他的群組與權限。</p>
<img src="/2020/10/27/Full-Stack-Serverless/20201028-03.png" title="AWS login">

<img src="/2020/10/27/Full-Stack-Serverless/20201028-04.png" title="AWS login">

<p>   現在創建 IAM 用戶。Access type 勾選 Programmatic access。</p>
<img src="/2020/10/27/Full-Stack-Serverless/20201028-05.png" title="AWS IAM User">

<p>   你可以透過單擊 Next 接受 Permissions、Tags、Reviews 等預設值並創建 IAM 用戶。在下一個畫面中，將會提供 IAM 用戶憑據：Access key ID 和 Secret access key。</p>
<img src="/2020/10/27/Full-Stack-Serverless/20201026-01.png" title="AWS IAM User">

<p>返回 CLI 操作畫面，複製貼上 access key ID 和 secret access key。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">Enter the access key of the newly created user:</span><br><span class="line">? accessKeyId:  # YOUR_ACCESS_KEY_ID</span><br><span class="line">? secretAccessKey:  # YOUR_SECRET_ACCESS_KEY</span><br><span class="line">This would update/create the AWS Profile in your local machine</span><br><span class="line">? Profile Name:  # (default)</span><br><span class="line"></span><br><span class="line">Successfully set up the new user.</span><br></pre></td></tr></table></figure>

<p>現在，您已經成功設定了 CLI，可以開始創建新服務了。</p>
<h3 id="初始化第一個-Amplify-專案"><a href="#初始化第一個-Amplify-專案" class="headerlink" title="初始化第一個 Amplify 專案"></a>初始化第一個 Amplify 專案</h3><p>現在已經安裝和設定了 CLI，可以開始創建第一個專案。在接下來序列的範例中，客戶端我都會使用 React 架構，API 則會使用 GraphQL。</p>
<p>之前在 Oracle APEX 中學習到的 React 技術正好可以用在這裡。你也可以學習到創建一個 React 所使用的工具以及如何部署。</p>
<p>所以這裡我們將從初始化一個新的 React 專案開始：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">npx create-react-app first-amplify-app</span><br></pre></td></tr></table></figure>

<p>我則習慣使用 yarn: </p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">yarn create react-app first-amplify-app</span><br></pre></td></tr></table></figure>

<p>創建 React 專案後，切換到所產生的專案目錄。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cd first-amplify-app</span><br></pre></td></tr></table></figure>

<p>你可以瀏覽一下 React 專案目錄的結構。</p>
<p>現在啟動 React 專案應用程序開發伺服器，看看初始專案是甚麼樣子。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">npm start </span><br></pre></td></tr></table></figure>

<p>或用 yarn:</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">yarn start </span><br></pre></td></tr></table></figure>

<p>React 專案初始畫面:</p>
<img src="/2020/10/27/Full-Stack-Serverless/20201029-01.png" title="React">

<p>關掉 React 應用程序開發伺服器。</p>
<p>現在，需要在 React 客戶端上安裝 Amplify。我們將安裝 AWS Amplify 程式庫與適用於 React 特定 UI 組件的 AWS Amplify React 程式庫。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">yarn add aws-amplify @aws-amplify/ui-react</span><br></pre></td></tr></table></figure>

<p>接下來，你可以創建一個 Amplify 專案。 執行 init 命令初始化 Amplify 專案：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">amplify init</span><br></pre></td></tr></table></figure>

<p>這將引導您完成以下步驟：</p>
<ol>
<li><p><em>Enter a name for the project.</em><br>這將是專案的本地名稱，通常是用來描述專案是什麼或做什麼的。</p>
</li>
<li><p><em>Enter a name for the environment.</em><br>這將是您將要使用的初始環境的參考。典型環境可能是諸如 <em>dev<em>、</em>local</em> 或 <em>prod</em> 之類的，但可以是對你有意義的任何名稱。</p>
</li>
<li><p><em>Choose your default editor.</em><br>這將設置您的編輯器。 CLI 稍後將使用此編輯器打開專案中的文件。</p>
</li>
<li><p><em>Choose the type of app that you’re building.</em><br>如果你使用 JavaScript，這將確定 CLI 是否應配置、構建和運行命令。在此範例中，選擇 <em>javascript</em>。</p>
</li>
<li><p><em>What JavaScript framework are you using?</em><br>這將確定一些基本的構建和啟動命令。對於此範例，請選擇 <em>react</em>。</p>
</li>
<li><p><em>Source Directory Path.</em><br>這使您可以設置源代碼所在的目錄。對於此範例，請選擇 <em>src</em>。</p>
</li>
<li><p><em>Distribution Directory Path.</em><br>對於 Web 專案，這將是包含編譯的 JavaScript 源代碼以及你的 favicon 圖標、HTML、和 CSS 文檔的文件夾。對於此範例，選擇 <em>build</em>。</p>
</li>
<li><p><em>Build Command.</em><br>這指定用於編譯和捆綁 JavaScript 代碼的命令。 對於此範例，請使用 <em>npm run-script build</em>。</p>
</li>
<li><p><em>Start Command.</em><br>這指定在本地端啟動應用程序開發伺服器的命令。對於此範例，請使用 <em>npm run-script start</em>。</p>
</li>
<li><p><em>Do you want to use an AWS profile</em><br>在這裡，選擇 <em>Y</em>，然後選擇你先前用 <em>amplify configure</em> 設定的的 AWS profile。</p>
</li>
</ol>
<p>這是這個範例初始化的過程：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">? Enter a name for the project firstamplifyapp</span><br><span class="line">? Enter a name for the environment local</span><br><span class="line">? Choose your default editor: Visual Studio Code</span><br><span class="line">? Choose the type of app that you're building javascript</span><br><span class="line">Please tell us about your project</span><br><span class="line">? What javascript framework are you using react</span><br><span class="line">? Source Directory Path:  src</span><br><span class="line">? Distribution Directory Path: build</span><br><span class="line">? Build Command:  npm.cmd run-script build  </span><br><span class="line">? Start Command: npm.cmd run-script start</span><br><span class="line">Using default provider  awscloudformation</span><br><span class="line"></span><br><span class="line">For more information on AWS Profiles, see:</span><br><span class="line">https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-profiles.html</span><br><span class="line"></span><br><span class="line">? Do you want to use an AWS profile? Yes</span><br><span class="line">? Please choose the profile you want to use default</span><br></pre></td></tr></table></figure>


<p>現在，Amplify CLI 將初始化您的新 Amplify 專案。初始化完成後，將會在專案中為您創建兩個資源： 位於 src 目錄中的 aws-exports 的文件檔和位於專案根目錄中的名為 amplify 的文件夾。</p>
<ul>
<li><p>aws-exports<br>aws-exports 文件是 CLI 根據憑據所建立的 key-value 鍵值對資源類別。</p>
</li>
<li><p>amplify 目錄<br>此文件夾包含 Amplify 專案的所有代碼和配置文件。 在此文件夾中，您將看到兩個子文件夾： <em>backend</em> 和 <em>#current-cloud-backend</em></p>
<ul>
<li><p>backend 目錄<br>此文件夾包含專案的所有本地代碼，例如 AppSync API 的 GraphQL schema，任何無伺服器功能的源代碼以及 Amplify 專案當前本地狀態的代碼的基礎結構。</p>
</li>
<li><p>#current-cloud-backend 目錄<br>該文件夾保存的代碼和配置反映了最後一個 Amplify push 命令在雲中部署了哪些資源。它可幫助 CLI 區分雲中已配置的資源配置和本地 <em>backend</em> 目錄中的當前配置有甚麼不同(反映本地端的更改)。</p>
</li>
</ul>
</li>
</ul>
<p>現在，您已經初始化了專案，你可以添加第一個雲服務：身份驗證 (authentication)。</p>
<h3 id="創建和部署雲服務"><a href="#創建和部署雲服務" class="headerlink" title="創建和部署雲服務"></a>創建和部署雲服務</h3><p>要創建新服務，可以使用 Amplify 的 add 命令：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">amplify add auth</span><br></pre></td></tr></table></figure>

<p>這將引導您完成以下步驟：</p>
<ol>
<li><p><em>Do you want to use the default authentication and security configuration?</em><br>這使您可以選擇使用預設的配置（sign-up 使用 MFA，sign-in 使用 password）創建身份驗證服務(authentication service)、或使用 social providers 創建身份驗證配置、或者創建完全自定義的身份驗證配置。 對於此範例，請選擇 <em>Default configuration</em>。</p>
<blockquote>
<blockquote>
<p>MFA<br>   多重要素驗證(Multi-factor authentication，縮寫為 MFA)，又譯多因子認證、多因素驗證、多因素認證，是一種電腦存取控制的方法，用戶要通過兩種以上的認證機制之後，才能得到授權，使用電腦資源。</p>
</blockquote>
</blockquote>
</li>
<li><p><em>How do you want users to be able to sign in?</em><br>這將允許您指定所需的 sign-in 屬性。 對於此範例，選擇預設值 <em>Username</em>。</p>
</li>
<li><p><em>Do you want to configure advanced settings?</em><br>這將使您逐步設置一些更高階的認證，例如其他的 sign-up 屬性和 Lambda 觸發器。在此範例中，您不需要任何這些，因此請選擇 <em>No, I am done.</em> 接受預設的設置。</p>
<p>現在，您已經成功配置了身份驗證服務，現在可以進行部署了。 要部署身份驗證服務，可以執行 push 命令：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">amplify push</span><br></pre></td></tr></table></figure>


</li>
</ol>
<ol start="4">
<li><em>Are you sure you want to continue?</em><br>選擇 Y。</li>
</ol>
<p>部署完成後，您的身份驗證服務已成功創建。 恭喜，您已經部署了第一個功能。 現在，讓我們對其進行測試。</p>
<p>在 React 應用程序中有幾種與身份驗證服務互動的方法。你可以使用 Amplify 中的 Auth class，該類具有 30 多種可用方法，諸如 signUp、signIn、signOut 等方法。也可以使用特定的框架組件，例如 withAuthenticator 來構建完整的身份驗證流程，包括預配置的用戶界面。讓我們試用 withAuthenticator 高階(HOC higher-order)組件。</p>
<p>首先，在 React 應用程序中配置 Amplify。 打開 src/index.js 並將以下代碼添加到最後一個 import 語句下面。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> Amplify <span class="keyword">from</span> <span class="string">'aws-amplify'</span></span><br><span class="line"><span class="keyword">import</span> config <span class="keyword">from</span> <span class="string">'./aws-exports'</span></span><br><span class="line">Amplify.configure(config) </span><br></pre></td></tr></table></figure>

<p>現在，該應用已配置完畢，您可以開始與身份驗證服務進行互動。打開 src/App.js 並使用以下代碼更新文件：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">import React from 'react';</span><br><span class="line">import &#123; withAuthenticator, AmplifySignOut &#125; from '@aws-amplify/ui-react'</span><br><span class="line"></span><br><span class="line">function App() &#123;</span><br><span class="line">  return (</span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">width:</span> "<span class="attr">500px</span>", <span class="attr">textAlign:</span> "<span class="attr">center</span>", <span class="attr">margin:</span> "<span class="attr">auto</span>" &#125;&#125;&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Hello Tainan, 台南!<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">AmplifySignOut</span> /&gt;</span>    </span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export default withAuthenticator(App);</span><br></pre></td></tr></table></figure>

<p>現在，可以啟動應用程序進行測試：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">yarn start</span><br></pre></td></tr></table></figure>

<p>現在，你的應用程序已啟動了預配置的身份驗證流程: sign-up 使用 MFA，sign-in 使用 password。</p>
<img src="/2020/10/27/Full-Stack-Serverless/20201029-02.png" title="AWS IAM User">

<p>使用 Create account 建立一個新帳戶:</p>
<img src="/2020/10/27/Full-Stack-Serverless/20201029-03.png" title="AWS IAM User">

<p>MFA 身份驗證流程，你需要到你的 email 取得驗證碼。</p>
<img src="/2020/10/27/Full-Stack-Serverless/20201029-06.png" title="AWS IAM User">

<p>輸入驗證碼 (Comfirmation code):</p>
<img src="/2020/10/27/Full-Stack-Serverless/20201029-04.png" title="AWS IAM User">

<p>現在使用新的 User account sign-in:</p>
<img src="/2020/10/27/Full-Stack-Serverless/20201029-05.png" title="AWS IAM User">

<h3 id="刪除資源"><a href="#刪除資源" class="headerlink" title="刪除資源"></a>刪除資源</h3><p>如果單一的服務或專案已不再需要，可以使用 CLI 刪除它。</p>
<p>要刪除單一的功能，可以執行 remove 命令。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">amplify remove auth</span><br></pre></td></tr></table></figure>

<p>要刪除整個 Amplify 專案以及帳戶中已部署的所有相應資源，可以執行 delete 命令。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">amplify delete</span><br></pre></td></tr></table></figure>

<p>隨著越來越多的公司開始依靠雲來處理大量的工作負載，雲計算正急速的增長中。隨著使用量的增長，雲計算的技能應該要納入你的職能規畫中。</p>
<p>Serverless 無伺務器模式是雲計算的子集，它在企業用戶中也迅速流行，因為它提供了雲計算的所有優勢，同時還具有自動擴展功能，而幾乎不需要維護。</p>
<p>諸如 Amplify Framework 之類的工具使所有背景的開發人員都可以更輕鬆地啟動和運行雲以及無伺服器運算。接下來將要利用雲服務和 Amplify Framework 在雲中構建真實的全棧無伺服器應用程序。這將會使用 AWS 的 auth、API、storage 等服務。使用的架構將會包含 GraphQL 與 React。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://1184yang.github.io/2020/10/20/Enhancing-Components-with-Hooks-3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/1184yang.jpg">
      <meta itemprop="name" content="J.Y. Yang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/10/20/Enhancing-Components-with-Hooks-3/" class="post-title-link" itemprop="url">Enhancing Components with Hooks (Ⅲ)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2020-10-20 10:57:56" itemprop="dateCreated datePublished" datetime="2020-10-20T10:57:56+08:00">2020-10-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2020-12-24 18:13:30" itemprop="dateModified" datetime="2020-12-24T18:13:30+08:00">2020-12-24</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/JavaScript/" itemprop="url" rel="index"><span itemprop="name">JavaScript</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/React/" itemprop="url" rel="index"><span itemprop="name">React</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="掛鉤規則"><a href="#掛鉤規則" class="headerlink" title="掛鉤規則"></a>掛鉤規則</h4><p>在使用 Hooks 時，有一些原則需要遵守，以避免錯誤和異常的行為：</p>
<ul>
<li><p><strong>掛鉤僅能在組件中運行</strong></p>
<p>  掛鉤只能從 React 組件中調用。也可以將它們添加到自定義掛鉤中，然後將它們添加到組件中。 掛鉤不是常規的 JavaScript，它們是一種 React 模式，可建立以模組化方式整合到其他庫中。</p>
</li>
<li><p><strong>將功能分解為多個掛鉤是個好主意</strong></p>
<p>  拆分功能為多個掛鉤，除了使代碼更易於閱讀外，還有另一個好處。由於 Hook 是按順序調用的，因此最好使它們保持較小的功能。調用後，React 會將 Hooks 的值保存在陣列中，所以比較好追蹤較小功能的運作。</p>
  <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Counter = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> [count, setCount] = useState(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">const</span> [checked, toggle] = useState(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;, [checked]);</span><br><span class="line"></span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;, []);</span><br><span class="line"></span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;, [count]);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> ( ...)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>  每個 Hook 的調用和渲染順序都相同：</p>
  <figure class="highlight js"><table><tr><td class="code"><pre><span class="line">[count, checked, DependencyArray, DependencyArray, DependencyArray]</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>掛鉤只能在頂層調用</strong></p>
<p>  掛鉤應在 React 函式的頂層使用。它們不能放入條件語句，循環或嵌套函式中。</p>
  <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Counter = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> [count, setCount] = useState(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (count &gt; <span class="number">5</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> [checked, toggle] = useState(<span class="literal">false</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (count &gt; <span class="number">5</span>) &#123;</span><br><span class="line">    useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      ...</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> ( ... );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>  當我們在 if 語句中使用 useState 時，僅當 count 大於 5 時才應調用該掛鉤。拋出的陣列值，有時是 <strong>[count, checked, DependencyArray, 0, DependencyArray]</strong>，有時則會是　<strong>[count, DependencyArray, 1]</strong>。陣列中的 effect 索引對 React 很重要，這是 React 保存 effect 值的方式。</p>
<p>  這並不是說我們不能在 React 應用程序中使用條件語句。我們只需要以不同的方式組織這些條件。我們可以在掛鉤中嵌套 if 語句，循環和其他條件：</p>
  <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Counter = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> [count, setCount] = useState(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">const</span> [checked, toggle] = useState(<span class="function"><span class="params">count</span> =&gt;</span> (count &lt; <span class="number">5</span>) ? <span class="literal">undefined</span> : <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (count &lt; <span class="number">5</span>) <span class="keyword">return</span>;</span><br><span class="line">    ...</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> ( ... );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>  第 3 行，count 小於 5 時，checked 值為 undefined。 將條件嵌套在掛鉤內部而將該掛鉤保留在頂層，但是結果是相似的。 第 9 行的 effect 執行相同的規則，如果 count 小於 5，則 return 語句將阻止 effect 繼續執行。這將使掛鉤陣列值保持一致 <strong>[count，checked，DependencyArray，DependencyArray，DependencyArray]</strong>。</p>
<p>  與條件語句邏輯一樣，當你需要在掛鉤中嵌套異步行為。 useEffect 將函式作為第一個參數，而不是 Promise。因此，您不能將異步函式用作第一個參數：</p>
  <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">useEffect(<span class="keyword">async</span> () =&gt; &#123;&#125;)</span><br></pre></td></tr></table></figure>

<p>  但是，你可以在參數函式內部嵌套一個異步函數：</p>
  <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> fn = <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="keyword">await</span> SomePromise();</span><br><span class="line">  &#125;;</span><br><span class="line">  fn();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>  我們創建了一個變數 fn，以處理 async/await，然後執行該函式。 您也可以使用匿名函式：</p>
  <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  (<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="keyword">await</span> SomePromise();</span><br><span class="line">  &#125;)();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>如果遵循上述的這些規則，你可以避免 React Hooks 的一些常見問題。</p>
<h4 id="使用-useReducer-改進代碼"><a href="#使用-useReducer-改進代碼" class="headerlink" title="使用 useReducer 改進代碼"></a>使用 useReducer 改進代碼</h4><p>思考一下 Checkbox 複選框組件，該組件擁有簡單的狀態，複選框值只有 “checked” 與 “not checked”。 其中，checked 是狀態值，而 setChecked 是用於更改狀態的函式。 首次渲染組件時，checked 的值為 false：</p>
<figure class="highlight html"><figcaption><span>useReducer</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"react-container"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/babel"</span>&gt;</span></span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> &#123; render &#125; = ReactDOM;</span></span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> &#123; useState &#125; = React;</span></span><br><span class="line">  </span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> Checkbox = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">const</span> [checked, setChecked] = useState(<span class="literal">false</span>);</span></span><br><span class="line">    </span><br><span class="line"><span class="javascript">    <span class="keyword">return</span> (</span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;&gt;</span></span></span><br><span class="line">        &lt;input</span><br><span class="line"><span class="javascript">          type=<span class="string">"checkbox"</span></span></span><br><span class="line">          value=&#123;checked&#125;</span><br><span class="line"><span class="javascript">          onChange=&#123;() =&gt; setChecked(<span class="function"><span class="params">checked</span> =&gt;</span> !checked)&#125;</span></span><br><span class="line">        /&gt;</span><br><span class="line"><span class="javascript">        &lt;span className=<span class="string">"margin-left-sm"</span>&gt;&#123;checked ? <span class="string">"checked"</span> : <span class="string">"not checked"</span>&#125;&lt;<span class="regexp">/span&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;/&gt;</span></span></span><br><span class="line">    );</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> App = <span class="function"><span class="params">()</span> =&gt;</span> (</span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Hello Tainan!<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">Checkbox</span> /&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/&gt;</span></span></span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  render(</span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">App</span> /&gt;</span>,</span></span><br><span class="line"><span class="javascript">    <span class="built_in">document</span>.getElementById(<span class="string">"react-container"</span>)</span></span><br><span class="line">  );</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>效果不錯，但是此功能如果用在不同的的區域可能會引起一些維護上的困擾。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">onChange=&#123;() =&gt; setChecked(<span class="function"><span class="params">checked</span> =&gt;</span> !checked)&#125;</span><br></pre></td></tr></table></figure>

<p>乍看下感覺還可以，這裡會有甚麼問題嗎？我們送出一個接受當前 checked 值並返回相反的！checked 的函式。 開發人員有可能會送出錯誤的函式並破壞整個過程。與其以這種方式進行處理，為什麼不提供一個功能函式呢？</p>
<p>讓我們添加一個名為 toggle 的函式，該函式將執行與 setChecked 相同的操作，並返回與 checked 當前值相反的值：</p>
<figure class="highlight js"><figcaption><span>Checkbox and toggle</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Checkbox = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> [checked, setChecked] = useState(<span class="literal">false</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> toggle = <span class="function"><span class="params">()</span> =&gt;</span> setChecked(<span class="function"><span class="params">checked</span> =&gt;</span> !checked);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;&gt;</span><br><span class="line">      &lt;input</span><br><span class="line">        type=<span class="string">"checkbox"</span></span><br><span class="line">        value=&#123;checked&#125;</span><br><span class="line">        onChange=&#123;toggle&#125;</span><br><span class="line">      /&gt;</span><br><span class="line">      &lt;span className=<span class="string">"margin-left-sm"</span>&gt;&#123;checked ? <span class="string">"checked"</span> : <span class="string">"not checked"</span>&#125;&lt;<span class="regexp">/span&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>這個好些了。onChange 設置為可預測的值：toggle 函式。我們知道每次使用該函式時，它將執行預定地操作，產生更可預測的結果。</p>
<p>這裡我們在 toggle 函式中使用了setChecked 的涵式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setChecked(checked =&gt; !checked);</span><br></pre></td></tr></table></figure>

<p>我們現在要使用另一個方式來引用這個函式，<em>checked =&gt;！checked</em>，它是一個 reducer。<strong>reducer 函式最簡單的定義是，它接受當前狀態並返回新狀態。</strong> 如果 checked 為 false，則應返回相反的 true。</p>
<p>在最初我們將此行為硬編碼為 onChange 事件，我們現在可以將邏輯簡化為 reducer 函式，該邏輯將始終產生相同的結果。 </p>
<p>我們將使用 <strong>useReducer</strong> 代替組件中的 useState：</p>
<figure class="highlight js"><figcaption><span>Checkbox</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Checkbox = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> [checked, toggle] = useReducer(<span class="function"><span class="params">checked</span> =&gt;</span> !checked, <span class="literal">false</span>);</span><br><span class="line">     </span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;&gt;</span><br><span class="line">      &lt;input</span><br><span class="line">        type=<span class="string">"checkbox"</span></span><br><span class="line">        value=&#123;checked&#125;</span><br><span class="line">        onChange=&#123;toggle&#125;</span><br><span class="line">      /&gt;</span><br><span class="line">      &lt;span className=<span class="string">"margin-left-sm"</span>&gt;&#123;checked ? <span class="string">"checked"</span> : <span class="string">"not checked"</span>&#125;&lt;<span class="regexp">/span&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>第 2 行，useReducer 接受一個 reducer 函式和初始狀態 false。 然後，將 onChange 函式設置為 toggle，這將會調用 reducer 函式。</p>
<p>我們較早的 reducer，checked =&gt;！checked，就是一個很好的例子。如果將相同的輸入提供給函式，則應預期會有相同的輸出。</p>
<p>這個概念起源於 JavaScript 中的 Array.reduce。reduce 從根本上與 reducer 具有相同的作用：它接受一個函式(這個函式會將所有值都簡化為單一的值)和一個初始值，並返回一個單一的值。</p>
<p>Array.reduce 接受一個 reducer 函式和一個初始值。 對於 numbers 陣列中的每個值，將調用 reducer 直到返回一個值：</p>
<figure class="highlight js"><figcaption><span>Array.reduce</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> numbers = [<span class="number">28</span>, <span class="number">34</span>, <span class="number">67</span>, <span class="number">68</span>];</span><br><span class="line"></span><br><span class="line">numbers.reduce(<span class="function">(<span class="params">number, nextNumber</span>) =&gt;</span> number + nextNumber, <span class="number">0</span>);  <span class="comment">// 197</span></span><br></pre></td></tr></table></figure>

<p>發送到 Array.reduce 的 reducer 函式接受兩個參數。所以這裡我們也可以將多個參數發送給 useReducer 的 reducer 函式：</p>
<figure class="highlight js"><figcaption><span>Numbers</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Numbers = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> [number, setNumber] = useReducer(</span><br><span class="line">    (number, newNumber) =&gt; number + newNumber,</span><br><span class="line">    <span class="number">0</span></span><br><span class="line">  );</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">h1</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> setNumber(30)&#125;&gt;&#123;number&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>第 3 行就是這裡的 reducer 函式，接受了兩個參數 number 與 newNumber。在第 7 行調用 setNumber 時就會執行這個 reducer 函式，傳入 30 給 newNumber，然後加到當前的 number 狀態值。現在，每次單擊 h1 時，我們都會將總數加 30。</p>
<h4 id="useReducer-處理複雜狀態"><a href="#useReducer-處理複雜狀態" class="headerlink" title="useReducer 處理複雜狀態"></a>useReducer 處理複雜狀態</h4><p>隨著狀態變得越來越複雜，useReducer 可以幫助我們更可預測地處理狀態更新。來看另外一個含有 User 數據的物件：</p>
<figure class="highlight js"><figcaption><span>user data</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> firstUser = &#123;</span><br><span class="line">  id: <span class="string">"0391-3233-301"</span>,</span><br><span class="line">  firstName: <span class="string">"Scott"</span>,</span><br><span class="line">  lastName: <span class="string">"Tiger"</span>,</span><br><span class="line">  city: <span class="string">"Tainan"</span>,</span><br><span class="line">  email: <span class="string">"scott@example.com"</span>,</span><br><span class="line">  admin: <span class="literal">false</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> User = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> [user, setUesr] = useState(firstUser);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;h1&gt;&#123;user.firstName&#125; &#123;user.lastName&#125; - &#123;user.admin ? <span class="string">"Admin"</span> : <span class="string">"User"</span>&#125;&lt;<span class="regexp">/h1&gt;</span></span><br><span class="line"><span class="regexp">      &lt;p&gt;Email: &#123;user.email&#125;&lt;/</span>p&gt;</span><br><span class="line">      &lt;p&gt;Location: &#123;user.city&#125;&lt;<span class="regexp">/p&gt;</span></span><br><span class="line"><span class="regexp">      &lt;button&gt;Make Admin&lt;/</span>button&gt;</span><br><span class="line">    &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>

<p>管理狀態時常見的錯誤是覆蓋狀態：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">button</span></span></span><br><span class="line"><span class="tag">  <span class="attr">onClick</span>=<span class="string">&#123;(e)</span> =&gt;</span> &#123;</span><br><span class="line">    e.preventDefault();</span><br><span class="line">    setUser(&#123; admin: true &#125;);</span><br><span class="line">  &#125;&#125;</span><br><span class="line">&gt;</span><br><span class="line">  Make Admin</span><br><span class="line"><span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>第 4 行這樣做將覆蓋 firstUser 的狀態，並將其替換為我們發送給 setUser 函式的內容：{admin：true}。這可以透過 JavaScript 的展開運算子(Spread syntax)解決此問題：展開 user 的當前值，然後覆蓋 admin 值：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">button</span></span></span><br><span class="line"><span class="tag">  <span class="attr">onClick</span>=<span class="string">&#123;(e)</span> =&gt;</span> &#123;</span><br><span class="line">    e.preventDefault();</span><br><span class="line">    setUser(&#123; ...user, admin: true &#125;);</span><br><span class="line">  &#125;&#125;</span><br><span class="line">&gt;</span><br><span class="line">  Make Admin</span><br><span class="line"><span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>這將採用初始狀態並輸入新的鍵/值：{ admin：true }。我們需要在每個 onClick 中重寫此邏輯，這很容易出錯，也可能會忘記這樣做。現在改用 useReducer：</p>
<figure class="highlight js"><figcaption><span>useReducer</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> User = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> [user, setUser] = useReducer(</span><br><span class="line">    (user, newDetails) =&gt; (&#123; ...user, ...newDetails &#125;),</span><br><span class="line">    firstUser</span><br><span class="line">  );</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然後，我們發送新的狀態值 newDetails，傳遞給 reducer，並將其推入物件。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">button</span></span></span><br><span class="line"><span class="tag">  <span class="attr">onClick</span>=<span class="string">&#123;(e)</span> =&gt;</span> &#123;</span><br><span class="line">    e.preventDefault();</span><br><span class="line">    setUser(&#123; admin: true &#125;);</span><br><span class="line">  &#125;&#125;</span><br><span class="line">&gt;</span><br><span class="line">  Make Admin</span><br><span class="line"><span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>當狀態具有多個子值或下一個狀態取決於上一個狀態時，此模式很有用。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://1184yang.github.io/2020/10/19/Using-Git-in-SQLDeveloper/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/1184yang.jpg">
      <meta itemprop="name" content="J.Y. Yang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/10/19/Using-Git-in-SQLDeveloper/" class="post-title-link" itemprop="url">Using Git in SQL Developer</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2020-10-19 14:58:20" itemprop="dateCreated datePublished" datetime="2020-10-19T14:58:20+08:00">2020-10-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2020-12-24 18:13:30" itemprop="dateModified" datetime="2020-12-24T18:13:30+08:00">2020-12-24</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Oracle/" itemprop="url" rel="index"><span itemprop="name">Oracle</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Git/" itemprop="url" rel="index"><span itemprop="name">Git</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>對我來說資料庫的備份比甚麼都重要，這種觀念讓我延伸到對文字或是程式的專案備份的重要性。目前我們大部分都是使用 Oracle PL/SQL，程式碼都是儲存在資料庫中，我們不用另外備份程式碼。</p>
<p>但對軟體程式專案來說，尤其是團隊合作的專案，這是不夠的。備份機制應該包括版本控制或是追蹤、維護修訂版本。</p>
<p>SQL Developer 從第 4 版就有支援 Git 版本控制，提供一些 GUI 的介面，讓你操作更方便。以下範例我用的 SQL Developer 版本是 19.2.1。</p>
<h4 id="Create-Git-Repository"><a href="#Create-Git-Repository" class="headerlink" title="Create Git Repository"></a>Create Git Repository</h4><p>首先選擇 Team &gt; Versions 與 View &gt; Files 打開左邊的 Versions 與 Files 區塊。</p>
<img src="/2020/10/19/Using-Git-in-SQLDeveloper/20201019-01.png" title="SQL Developer">

<p>建立新的 Git 儲存庫 (Repository 或稱容器)，Teams &gt; Git &gt; Initialize</p>
<img src="/2020/10/19/Using-Git-in-SQLDeveloper/20201019-02.png" title="SQL Developer">

<p>選擇 Git 儲存庫所在的目錄:</p>
<img src="/2020/10/19/Using-Git-in-SQLDeveloper/20201019-03.png" title="SQL Developer">

<p>建立新的 Git 儲存庫後，在 Files 區塊選擇剛建立的 Git 儲存庫目錄。然後在 Versions 區塊就可以看到 Git 儲存庫的基本資訊。</p>
<img src="/2020/10/19/Using-Git-in-SQLDeveloper/20201019-04.png" title="SQL Developer">

<p>現在可以開始使用 Git 儲存庫目錄存儲檔案了。</p>
<img src="/2020/10/19/Using-Git-in-SQLDeveloper/20201019-05.png" title="SQL Developer">

<p>新增、修改或刪除檔案後將這些更動後的檔案加到 Git stage，然後 commit Git 儲存庫。</p>
<img src="/2020/10/19/Using-Git-in-SQLDeveloper/20201019-06.png" title="SQL Developer">

<p>commit Git 儲存庫時記得要輸入 Comments。</p>
<img src="/2020/10/19/Using-Git-in-SQLDeveloper/20201019-07.png" title="SQL Developer">

<p>現在修改 Demo_emp.sql 後，commit Git 儲存庫。現在 Git 儲存庫有兩個 commit 的版本。</p>
<img src="/2020/10/19/Using-Git-in-SQLDeveloper/20201019-08.png" title="SQL Developer">

<p>現在因某些原因，想將舊的版本找回來：</p>
<img src="/2020/10/19/Using-Git-in-SQLDeveloper/20201019-09.png" title="SQL Developer">

<p>選擇先前 commit 的版本：</p>
<img src="/2020/10/19/Using-Git-in-SQLDeveloper/20201019-10.png" title="SQL Developer">

<p>左右兩個視窗，可比較不同的版本:</p>
<img src="/2020/10/19/Using-Git-in-SQLDeveloper/20201019-10.png" title="SQL Developer">

<p>選擇 Open 的版本:</p>
<img src="/2020/10/19/Using-Git-in-SQLDeveloper/20201019-11.png" title="SQL Developer">

<h4 id="Github-中央儲存庫"><a href="#Github-中央儲存庫" class="headerlink" title="Github 中央儲存庫"></a>Github 中央儲存庫</h4><p>如果是一個團隊開發的專案，必須有一個共同存儲專案程式碼或其他資料的地方。中央儲存庫可以選擇放在公司內部的媒體上，也可以選擇雲端的 Github 中央儲存庫，以方便部署到其他雲端的服務上。</p>
<p>這裡有有關 <a href="/2020/07/29/Git-Depot/">Git 遠端中央儲存庫</a> 的基本介紹。</p>
<p>你也可以參考 <a href="https://1184yang.github.io/2020/07/23/Hexo-Quickstart/">Hexo 快速入門</a> 使用 Git 版本控制章節，有關 GitHub 中央儲存庫的介紹。</p>
<p>現在我要將它存儲到雲端的 Github 中央儲存庫。首先到 Github 建立一個儲存庫 (Repository)：</p>
<img src="/2020/10/19/Using-Git-in-SQLDeveloper/20201019-12.png" title="SQL Developer">

<p>這裡選擇 Private ，因為我們不想對外公開。不要選擇 Initialize this repository 的任何選項，因為我們在本機上已有一個 Git 專案儲存庫，我們要從本地端將 Git 儲存庫上傳到 Github。</p>
<p>按下 Create Repository 按鈕後，會有一些指引:</p>
<img src="/2020/10/19/Using-Git-in-SQLDeveloper/20201019-13.png" title="SQL Developer">

<p>你可以到本地端 Git 儲存庫的目錄，依照上面的指引使用 Git 指令將 Git 儲存庫上傳到 Github。但我們現在要使用 SQL Developer 中的 Git。</p>
<p>新增一個 Remote 連結:</p>
<img src="/2020/10/19/Using-Git-in-SQLDeveloper/20201019-14.png" title="SQL Developer">

<p>將 Github 專案儲存庫的遠端網址複製貼上，這裡的 Remote name 取名為： origin。</p>
<img src="/2020/10/19/Using-Git-in-SQLDeveloper/20201019-15.png" title="SQL Developer">

<p>設定好遠端的連結，現在可以將本地端的儲存庫 push 上傳到 Github 中央儲存庫。</p>
<img src="/2020/10/19/Using-Git-in-SQLDeveloper/20201019-16.png" title="SQL Developer">

<p>輸入你的 Github 帳號密碼:</p>
<img src="/2020/10/19/Using-Git-in-SQLDeveloper/20201019-17.png" title="SQL Developer">

<p>現在你有本地端的 Git 儲存庫與 Github 中央儲存庫。在本地端開發測試完成後可以使用 push 將本地端的程式同步到 Github 中央儲存庫。其他開團隊的開發者可以使用 pull 將　Github 中央儲存庫的程式抓到他本地端的 Git 儲存庫。</p>
<img src="/2020/10/19/Using-Git-in-SQLDeveloper/20201019-18.png" title="SQL Developer">

<p>因為目前的 Github 專案儲存庫是私有的 (Private)，我們可以邀請其他的 Github 帳號共同開發。被邀請的帳號就可以有權限新增修改 此 Github 儲存庫。</p>
<img src="/2020/10/19/Using-Git-in-SQLDeveloper/20201019-19.png" title="SQL Developer">

<p>SQL Developer 提供的 Git 介面並沒有限定這個 Git 儲存庫必須得在 SQL Developer 初始化的 Git 儲存庫才可以。只要是 Git 儲存庫都可以使用 SQL Developer 中的 Git 介面，你可以不用安裝其他的 Git GUI 軟體。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://1184yang.github.io/2020/10/15/Enhancing-Components-with-Hooks-2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/1184yang.jpg">
      <meta itemprop="name" content="J.Y. Yang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/10/15/Enhancing-Components-with-Hooks-2/" class="post-title-link" itemprop="url">Enhancing Components with Hooks (Ⅱ)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2020-10-15 08:59:50" itemprop="dateCreated datePublished" datetime="2020-10-15T08:59:50+08:00">2020-10-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2020-12-24 18:13:30" itemprop="dateModified" datetime="2020-12-24T18:13:30+08:00">2020-12-24</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/JavaScript/" itemprop="url" rel="index"><span itemprop="name">JavaScript</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/React/" itemprop="url" rel="index"><span itemprop="name">React</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>到目前為止，我們添加到依賴陣列的依賴項是字符串。字符串，布爾值，數字等 JavaScript 原生型態都是可以有比較性的。 </p>
<p>字符串將等於預期的字符串。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( <span class="string">"tainan"</span> === <span class="string">"tainan"</span>) &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"Tainan!!"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但是，當我們開始比較物件，陣列和函式時，這就有不同的結果了。 例如，如果我們比較兩個陣列：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>] !== [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]) &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"但它們是一樣的"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>這兩組陣列不相等，即使它們的長度和項目看起來相同。 這是因為它們是外觀相似的陣列，但卻是兩個不同的實例 (instance)。如果我們創建一個變數來保存該陣列的值然後進行比較，我們將看到預期的結果:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> array = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line"><span class="keyword">if</span> ( array === array) &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"因為它是同一個實例 (instance)"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="深度檢查依賴項-Deep-Checking-Dependencies"><a href="#深度檢查依賴項-Deep-Checking-Dependencies" class="headerlink" title="深度檢查依賴項 (Deep Checking Dependencies)"></a>深度檢查依賴項 (Deep Checking Dependencies)</h4><p>在 JavaScript 中，陣列、物件和函式只有在它們完全相同的實例時才是相同的。 那麼，這與 useEffect 依賴陣列有何關係？ 為了了解這一點，我們需要一個盡可能頻繁強制渲染的組件。我們要構建一個掛鉤，該掛鉤使組件在每次按下任何鍵時都會渲染：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"react-container"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/babel"</span>&gt;</span></span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> &#123; useState, useEffect &#125; = React;</span></span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> &#123; render &#125; = ReactDOM;</span></span><br><span class="line">  </span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> useAnyKeyToRender = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">const</span> [, forceRender] = useState();</span></span><br><span class="line">    </span><br><span class="line"><span class="javascript">    useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">      <span class="built_in">window</span>.addEventListener(<span class="string">"keydown"</span>, forceRender);</span></span><br><span class="line"><span class="javascript">      <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">window</span>.removeEventListener(<span class="string">"keydown"</span>, forceRender);</span></span><br><span class="line">    &#125;, []);</span><br><span class="line">  &#125;;</span><br><span class="line">  </span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> App = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span></span><br><span class="line">    useAnyKeyToRender();</span><br><span class="line">    </span><br><span class="line"><span class="javascript">    useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">      <span class="built_in">console</span>.log(<span class="string">"fresh render"</span>);</span></span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line"><span class="javascript">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Open the console<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span>;</span></span><br><span class="line">  &#125;;</span><br><span class="line">  </span><br><span class="line">  render(</span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">App</span> /&gt;</span>,</span></span><br><span class="line"><span class="javascript">    <span class="built_in">document</span>.getElementById(<span class="string">"react-container"</span>)</span></span><br><span class="line">  );</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>第 7 行 useAnyKeyToRender 是我們自定義的掛鉤。</li>
<li>第 8 行 我們要強制渲染的工作就是調用狀態更改函式。我們不在乎狀態值。我們只需要狀態函式：forceRender。</li>
<li>第 11 行 在第一次渲染組件時，我們將監聽 keydown 事件。按下某個鍵時，我們將通過調用 forceRender 強制組件進行渲染。</li>
</ul>
<p>通過將此掛鉤添加到組件，我們只需按一下任何鍵就可以強制其重新渲染。我們將此掛鉤直接加入 App 組件。現在，每次我們按下一個鍵，都會渲染 App 組件。每次渲染 App 組件時都會調用 useEffect 將 “fresh render” 記錄到控制台。</p>
<p>現在讓我們在 App 組件中調整 useEffect 來引用 <strong>word</strong> 值。 如果 word 值更改，我們將重新渲染：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> word = <span class="string">"tainan"</span>;</span><br><span class="line">useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"fresh render"</span>);</span><br><span class="line">&#125;, [word]);</span><br></pre></td></tr></table></figure>

<p>現在不會在每個 keydown 事件上調用 useEffect，我們只會在首次渲染之後以及 word 值更改的時後會調用此方法。word 的值沒有改變，因此不會發生後續的重新渲染。 將原生類型或數字添加到依賴陣列，會按預期方式工作。 該 effect 只被調用一次。</p>
<p>如果我們改用字串陣列，會發生什麼？</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> words = [<span class="string">"hello"</span>, <span class="string">"tainan"</span>, <span class="string">"!"</span>];</span><br><span class="line">useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"fresh render"</span>);</span><br><span class="line">&#125;, [words]);</span><br></pre></td></tr></table></figure>

<p>變數 words 是一個陣列，因為每次渲染都會宣告一個新陣列，是一個新實例，JavaScript 認定 words 已被更改，因此每次都會觸發重新渲染調用 “fresh render” effect。</p>
<p>將變數 words 宣告在 App 組件之外可以解決該問題：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> words = [<span class="string">"hello"</span>, <span class="string">"tainan"</span>, <span class="string">"!"</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> App = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  useAnyKeyToRender();</span><br><span class="line">  </span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"fresh render"</span>);</span><br><span class="line">  &#125;, [words]);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Open the console<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>在這種情況下，依賴陣列引用在函式外部宣告的 words 實例，在第一個渲染之後不會再次調用 “fresh render” effect，因為 words 與上次渲染時是同一個實例。對於此示例來說，這是一個很好的解決方案，但並非總是可能 (或建議) 在函式範圍之外定義變數。有時，傳遞給依賴陣列的值需要宣告在函式範圍內。</p>
<p>例如，我們可能需要從類似 children 的 React 屬性建立 words 陣列：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> WordCount = <span class="function">(<span class="params">&#123; children = <span class="string">""</span> &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  useAnyKeyToRender();</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> words = children.split(<span class="string">" "</span> );</span><br><span class="line">  </span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"fresh render"</span>);</span><br><span class="line">  &#125;, [words]);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;&gt;</span><br><span class="line">      &lt;p&gt;&#123;children&#125;&lt;<span class="regexp">/p&gt;</span></span><br><span class="line"><span class="regexp">      &lt;p&gt;</span></span><br><span class="line"><span class="regexp">        &lt;strong&gt;&#123;words.length&#125; - words&lt;/</span>strong&gt;</span><br><span class="line">      &lt;<span class="regexp">/p&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> App = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">WordCount</span>&gt;</span>You are not going to believe this but...<span class="tag">&lt;/<span class="name">WordCount</span>&gt;</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>App 組件包含一些字串，它們是 WordCount 組件的子代，WordCount 組件將 children 作為屬性。 然後，我們在組件中將這些單字使用 .split 方法轉換為單字陣列。我們希望該組件僅在單字更改時才會重新渲染。但是事與願違，一旦按下任何鍵，我們就會在控制台中看到 “fresh render”。</p>
<p>React 提供了一種避免這些額外渲染的方法。此問題的解決方案是另一個掛鉤：useMemo。</p>
<p>useMemo 調用一個函式來計算已記憶的值 (memoized value)。在計算機科學中，記憶 (memoization) 是一種用於提高性能的技術。在記憶功能中，函式調用的結果將會保存並緩存。 然後，當使用相同的輸入再次調用該函式時，將返回緩存的值。在 React 中，useMemo 允許我們將緩存的值與其自身進行比較，以查看其是否實際被更改。</p>
<p>首先，讓我們導入 useMemo 掛鉤。</p>
<figure class="highlight js"><figcaption><span>useMemo</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; useState, useEffect, useMemo &#125; = React;</span><br></pre></td></tr></table></figure>

<p>然後，我們將傳遞給一個用於計算和創建記憶值的函式給 useMemo 掛鉤，這個函式返回的值將被用來設定 words：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">const words = children.split(&quot; &quot;);</span><br><span class="line"></span><br><span class="line">         ⇓</span><br><span class="line"></span><br><span class="line">const words = useMemo(() =&gt; &#123;</span><br><span class="line">  const words = children.split(&quot; &quot;);</span><br><span class="line">  return words;</span><br><span class="line">&#125;, []);</span><br></pre></td></tr></table></figure>

<p>與 useEffect 一樣，useMemo 也有依賴陣列：</p>
<figure class="highlight js"><figcaption><span>useMemo</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> words = useMemo(<span class="function"><span class="params">()</span> =&gt;</span> children.split(<span class="string">" "</span>));</span><br></pre></td></tr></table></figure>

<p>當我們在 useMemo 中不包括依賴陣列時，將會在每次渲染時重新計算 words。依賴陣列控制何時應調用回調函式。這裡將 children 值加到依賴陣列：</p>
<figure class="highlight js"><figcaption><span>useMemo</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> words = useMemo(<span class="function"><span class="params">()</span> =&gt;</span> children.split(<span class="string">" "</span>), [children]);</span><br></pre></td></tr></table></figure>

<p>words 陣列取決於 children 屬性，如果子元素發生變化，我們應該為反映該變化的 words 計算一個新值。現在，useMemo 將在組件第一次渲染時以及 children 屬性更改時為 words 計算一個新值。</p>
<p>在創建 React 應用程序時，需要好好理解 useMemo 掛鉤的用途。</p>
<p>useCallback 的使用方式類似 useMemo，但它用於記億函式而不是值。</p>
<figure class="highlight js"><figcaption><span>useCallback</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fn = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"Hello"</span>);</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"Tainan"</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"fresh render"</span>);</span><br><span class="line">  fn();</span><br><span class="line">&#125;, [fn]);</span><br></pre></td></tr></table></figure>

<p>fn 是一個函式。它是 useEffect 的依賴項，但是就像 words 一樣，JavaScript 假定 fn 每次渲染都是不同的實例。因此，它會在每次按鍵渲染時觸發 effect。 這不是很理想的，這可以使用 useCallback 來包裝函式：</p>
<figure class="highlight js"><figcaption><span>useCallback</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fn = useCallback(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"Hello"</span>);</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"Tainan"</span>);</span><br><span class="line">&#125;, []);</span><br></pre></td></tr></table></figure>

<p>useCallback 會記住 fn 的函數值。就像 useMemo 和 useEffect 一樣，它也有依賴陣列作為第二個參數。在這裡，由於依賴陣列是空陣列，因此只會創建了一次回調函式。</p>
<p>其實我們可以使用 useMemo 達到一樣的結果:</p>
<figure class="highlight js"><figcaption><span>useMemo</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fn = useMemo(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> fn = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"Hello"</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"Tainan"</span>);</span><br><span class="line">  &#125;;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> fn;</span><br><span class="line">&#125;, []);</span><br></pre></td></tr></table></figure>

<p>useCallback 只省掉幾個程式碼字元而已。</p>
<h4 id="When-to-useLayoutEffect"><a href="#When-to-useLayoutEffect" class="headerlink" title="When to useLayoutEffect"></a>When to useLayoutEffect</h4><p>我們知道，渲染始終在 useEffect 之前。 渲染首先發生，然後所有的 effect 按順序運行，並且可以完全訪問渲染中的所有值。</p>
<p>在 React 還有另一種 effect 掛鉤：useLayoutEffect。</p>
<p>useLayoutEffect 可以在渲染週期的特定時刻被調用。這一系列的週期事件如下：</p>
<ol>
<li>Render</li>
<li>調用 useLayoutEffect</li>
<li>瀏覽器繪製畫面：組件的元素實際添加到 DOM 的時間</li>
<li>調用 useEffect</li>
</ol>
<p>我們可以通過添加一些簡單的控制台訊息來觀察這些事件：</p>
<figure class="highlight html"><figcaption><span>render cycle</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"react-container"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/babel"</span>&gt;</span></span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> &#123; useEffect, useLayoutEffect &#125; = React;</span></span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> &#123; render &#125; = ReactDOM;</span></span><br><span class="line">  </span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> App = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">    useEffect(<span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">"useEffect"</span>));</span></span><br><span class="line"><span class="javascript">    useLayoutEffect(<span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">"useLayoutEffect"</span>));</span></span><br><span class="line"><span class="javascript">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>ready<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span></span><br><span class="line">  &#125;;</span><br><span class="line">  </span><br><span class="line">  render (</span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">App</span> /&gt;</span>,</span></span><br><span class="line"><span class="javascript">    <span class="built_in">document</span>.getElementById(<span class="string">"react-container"</span>)</span></span><br><span class="line">  );</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在 App 組件中，useEffect 是第一個掛鉤，其後是 useLayoutEffect，但我們看到 useLayoutEffect 在 useEffect 之前被調用。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">useLayoutEffect</span><br><span class="line">useEffect</span><br></pre></td></tr></table></figure>

<p>useLayoutEffect 在渲染之後但在瀏覽器繪製更改之前被調用。在大多數情況下，useEffect 是完成工作的正確工具，但是如果您的 effect 對於瀏覽器繪畫（螢幕上 UI 元素的外觀或位置）至關重要，則可能要使用 useLayoutEffect。</p>
<p>例如，您可能需要在調整窗口大小時獲取元素的寬度和高度。</p>
<figure class="highlight js"><figcaption><span>useWindowSize</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> useWindowSize = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> [width, setWidth] = useState(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">const</span> [height, setHeight] = useState(<span class="number">0</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> resize = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    setWidth(<span class="built_in">window</span>.innerWidth);</span><br><span class="line">    setHeight(<span class="built_in">window</span>.innerHeight);</span><br><span class="line">  &#125;;</span><br><span class="line">  </span><br><span class="line">  useLayoutEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">window</span>.addEventListener(<span class="string">"resize"</span>, resize);</span><br><span class="line">    resize();</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">window</span>.removeEventListener(<span class="string">"resize"</span>, resize);</span><br><span class="line">  &#125;, []);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> [width, height]</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>窗口的寬度和高度是我們的組件在瀏覽器繪製之前可能需要的信息。useLayoutEffect 用於在繪製之前計算窗口的寬度和高度。</p>
<p>另一個使用 useLayoutEffect 的示例是在追踪鼠標的位置時：</p>
<figure class="highlight js"><figcaption><span>useMousePosition</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> useMousePosition = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> [x, setX] = useState(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">const</span> [y, setY] = useState(<span class="number">0</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> setPosition = <span class="function">(<span class="params">&#123; x, y &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">    setX(x);</span><br><span class="line">    setY(y);</span><br><span class="line">  &#125;;</span><br><span class="line">  </span><br><span class="line">  useLayoutEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">window</span>.addEventListener(<span class="string">"mousemove"</span>, setPosition);</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">window</span>.removeEventListener(<span class="string">"mousemove"</span>, setPosition);</span><br><span class="line">  &#125;, []);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> [x, y];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>繪製螢幕時很有可能會使用鼠標的 x 和 y 位置。 useLayoutEffect 可用於幫助在繪製之前準確計算這些位置。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://1184yang.github.io/2020/10/14/WebSocket-Service-and-React/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/1184yang.jpg">
      <meta itemprop="name" content="J.Y. Yang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/10/14/WebSocket-Service-and-React/" class="post-title-link" itemprop="url">WebSocket Service and React</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2020-10-14 08:00:18" itemprop="dateCreated datePublished" datetime="2020-10-14T08:00:18+08:00">2020-10-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2020-12-24 18:13:30" itemprop="dateModified" datetime="2020-12-24T18:13:30+08:00">2020-12-24</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/JavaScript/" itemprop="url" rel="index"><span itemprop="name">JavaScript</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/React/" itemprop="url" rel="index"><span itemprop="name">React</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>了解了 React useState 與 useEffect 掛鉤，現在來實作一個可以實際應用的範例。</p>
<p>我們要使用先前建立的 <a href="http://10.11.25.137:6460/2020/08/04/WebSocket-RabbitMQ-Service/" target="_blank" rel="noopener">WebSocket Service and RabbitMQ 即時訊息通知</a>來建立一個 Web App 即時訊息通知功能。透過這個 WebScocket 伺服器可以讓你從任何地方送出訊息，並即時顯示在你的 APEX Web Application 上。</p>
<h4 id="加入基本的原始碼"><a href="#加入基本的原始碼" class="headerlink" title="加入基本的原始碼"></a>加入基本的原始碼</h4><p>建立一個新的 APEX Page，在 Page Properties 的 JavaScript File URLs 加入三個原始碼。</p>
<figure class="highlight html"><figcaption><span>File URLs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">https://unpkg.com/react@16.13.1/umd/react.development.js</span><br><span class="line">https://unpkg.com/react-dom@16.13.1/umd/react-dom.development.js</span><br><span class="line">https://unpkg.com/@babel/standalone/babel.min.js</span><br></pre></td></tr></table></figure>

<h4 id="應用程序模組"><a href="#應用程序模組" class="headerlink" title="應用程序模組"></a>應用程序模組</h4><p>然後在 Page Properties 的 JavaScript Function and Global Variable Declaration 加入我們自己的程式碼。</p>
<figure class="highlight js"><figcaption><span>Demo module</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> Demo = <span class="function">(<span class="params">(</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> uuid = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> s4 = <span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">Math</span>.floor((<span class="number">1</span> + <span class="built_in">Math</span>.random()) * <span class="number">0x10000</span>).toString(<span class="number">16</span>).substring(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> s4() + s4() + <span class="string">'-'</span> + s4() + <span class="string">'-'</span> + s4() + <span class="string">'-'</span> + s4() + <span class="string">'-'</span> + s4() + s4() + s4()    </span><br><span class="line">  &#125;;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> toLoalISOString = <span class="function">(<span class="params">date</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> tzo = -date.getTimezoneOffset(),</span><br><span class="line">      dif = tzo &gt;= <span class="number">0</span> ? <span class="string">'+'</span> : <span class="string">'-'</span>,</span><br><span class="line">      pad = <span class="function"><span class="keyword">function</span> (<span class="params">num</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> norm = <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.abs(num));</span><br><span class="line">        <span class="keyword">return</span> (norm &lt; <span class="number">10</span> ? <span class="string">'0'</span> : <span class="string">''</span>) + norm;</span><br><span class="line">      &#125;;</span><br><span class="line">    <span class="keyword">return</span> date.getFullYear() +</span><br><span class="line">      <span class="string">'-'</span> + pad(date.getMonth() + <span class="number">1</span>) +</span><br><span class="line">      <span class="string">'-'</span> + pad(date.getDate()) +</span><br><span class="line">      <span class="string">'T'</span> + pad(date.getHours()) +</span><br><span class="line">      <span class="string">':'</span> + pad(date.getMinutes()) +</span><br><span class="line">      <span class="string">':'</span> + pad(date.getSeconds()) +</span><br><span class="line">      dif + pad(tzo / <span class="number">60</span>) +</span><br><span class="line">      <span class="string">':'</span> + pad(tzo % <span class="number">60</span>);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> roles = &#123;</span><br><span class="line">    <span class="string">"roleDemo"</span>: &#123;</span><br><span class="line">      token: <span class="string">'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ3c3NpZCI6IjAwMDEzY2Y1LTcxOWItNDAxZC05YWUyLWRjZjJkYTVlZTRmYyIsIk5hbWUiOiJyb2xlRGVtbyIsImlhdCI6MTU5NjQ0MDYxNH0.KYIuu2xqITmStn1Yy1cu2xuGOcd1CuXYKpLGAU9OmhI'</span>,</span><br><span class="line">      wssid: <span class="string">'00013cf5-719b-401d-9ae2-dcf2da5ee4fc'</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"roleOne"</span>: &#123;</span><br><span class="line">      token: <span class="string">'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ3c3NpZCI6ImY0YTk0MDkxLTgxYWItNDRiOC1hZWNlLTYzNTI2ZWU4OGFlNiIsIk5hbWUiOiJyb2xlT25lIiwiaWF0IjoxNTk2NDQwNzA3fQ.IFdERyYpwAs3zLx9eUznqLdbuq1xjLF3snw3etgbTpQ'</span>,</span><br><span class="line">      wssid: <span class="string">'f4a94091-81ab-44b8-aece-63526ee88ae6'</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"roleOther"</span>: &#123;</span><br><span class="line">      token: <span class="string">'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ3c3NpZCI6ImRlYjg4N2ZhLTNlODQtNGEyYi1hNzZmLTA2OWY4MzU0ZmE0MyIsIk5hbWUiOiJyb2xlT3RoZXIiLCJpYXQiOjE1OTY0NDA3ODd9.jSnLlUeYfCpCR7_bg5nlPeQGKwFtI8IEa-NPsWfgtIw'</span>,</span><br><span class="line">      wssid: <span class="string">'deb887fa-3e84-4a2b-a76f-069f8354fa43'</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> dataSample = &#123;</span><br><span class="line">    id: uuid(),</span><br><span class="line">    title: <span class="string">'Title 標頭'</span>,</span><br><span class="line">    message: <span class="string">'Hello, Tainan. 自己從瀏覽器送出的訊息。'</span></span><br><span class="line">  &#125;;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> socket = <span class="function">(<span class="params">roleName = <span class="string">"roleDemo"</span></span>) =&gt;</span> &#123;   </span><br><span class="line">    <span class="keyword">const</span> &#123; token &#125; = roles[roleName];</span><br><span class="line">    <span class="keyword">const</span> url = <span class="string">`ws://10.11.25.138:4040/?token=<span class="subst">$&#123;token&#125;</span>`</span>;</span><br><span class="line">    <span class="keyword">const</span> ws = <span class="keyword">new</span> WebSocket(<span class="string">`ws://10.11.25.138:4040/?token=<span class="subst">$&#123;token&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> subscribe = <span class="function">(<span class="params">callback</span>) =&gt;</span> &#123;   </span><br><span class="line">      ws.onmessage = <span class="function">(<span class="params">&#123; data &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="keyword">const</span> parsedData = <span class="built_in">JSON</span>.parse(data);</span><br><span class="line">          callback(parsedData);</span><br><span class="line">        &#125; <span class="keyword">catch</span>(err) &#123;</span><br><span class="line">          <span class="built_in">console</span>.log(err);</span><br><span class="line">          callback(<span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> sendTo = <span class="function">(<span class="params">roleName = <span class="string">"roleDemo"</span>, data = dataSample</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> &#123; wssid &#125; = roles[roleName];</span><br><span class="line">      <span class="keyword">const</span> message = &#123; wssid, ...data, <span class="attr">created</span>: <span class="built_in">Date</span>.now() &#125;;</span><br><span class="line">    </span><br><span class="line">      <span class="keyword">return</span> ws.send(<span class="built_in">JSON</span>.stringify(message));</span><br><span class="line">    &#125;;</span><br><span class="line">      </span><br><span class="line">    <span class="keyword">return</span> &#123; subscribe, sendTo &#125;;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123; uuid, toLoalISOString, socket, ...Demo &#125;;</span><br><span class="line">&#125;)(Demo || &#123;&#125;);</span><br></pre></td></tr></table></figure>

<p>這裡列出 3 個可用的測試角色，你可以申請自己的 token 與 wssid。這個範例預設會使用 roleDemo 訂閱 WebSocket Service。sendTo 函式會用來測試送出訊息，預設也是會送給 roleDemo 自己。也用一個預設的訊息範例 dataSample。這些訊息的資料欄位請視你的所需自行調整。</p>
<p>現在可以測試一下我們的模組。開啟瀏覽器的 Console:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">const wss = Demo.socket();</span><br><span class="line"></span><br><span class="line">wss.subscribe(console.log);</span><br><span class="line"></span><br><span class="line">wss.sendTo();</span><br><span class="line"></span><br><span class="line">&#123;&quot;wssid&quot;:&quot;00013cf5-719b-401d-9ae2-dcf2da5ee4fc&quot;,&quot;id&quot;:&quot;e5adf55e-1949-45c7-8cd5-d4c47ae1bb28&quot;,&quot;title&quot;:&quot;Title 標頭&quot;,&quot;message&quot;:&quot;Hello, Tainan. 自己從瀏覽器送出的訊息。&quot;,&quot;created&quot;:1602638703748&#125;</span><br></pre></td></tr></table></figure>

<h4 id="React-組件"><a href="#React-組件" class="headerlink" title="React 組件"></a>React 組件</h4><p>建立一個新的 Region，我們現在可以在 Region Properties Source 的 Text 中加 React 程式碼。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"react-container"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/babel"</span>&gt;</span></span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> &#123; useState, useEffect &#125; = React;</span></span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> &#123; render &#125; = ReactDOM;</span></span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> &#123; toLoalISOString, socket &#125; = Demo;</span></span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> wss = socket(<span class="string">"roleDemo"</span>);</span></span><br><span class="line">  </span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> useWssMessages = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">const</span> [messages, setMessages] = useState([]);</span></span><br><span class="line"><span class="javascript">    <span class="keyword">const</span> addMessage = <span class="function"><span class="params">message</span> =&gt;</span> setMessages(<span class="function"><span class="params">allMessages</span> =&gt;</span> (message ? [message, ...allMessages] : allMessages));</span></span><br><span class="line">        </span><br><span class="line"><span class="javascript">    useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span></span><br><span class="line">      wss.subscribe(addMessage);</span><br><span class="line">    &#125;, []);</span><br><span class="line">    </span><br><span class="line"><span class="javascript">    <span class="keyword">return</span> messages;</span></span><br><span class="line">  &#125;;</span><br><span class="line">  </span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> Message = <span class="function">(<span class="params">&#123;title, message, created&#125;</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">return</span> (</span></span><br><span class="line"><span class="javascript">      &lt;p&gt;Title: &#123;title&#125; Content: &#123;message&#125; AT: &#123;toLoalISOString(<span class="keyword">new</span> <span class="built_in">Date</span>(created))&#125;&lt;<span class="regexp">/p&gt;</span></span></span><br><span class="line">    );</span><br><span class="line">  &#125;;</span><br><span class="line">  </span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> MessageList = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">const</span> messages = useWssMessages();</span></span><br><span class="line"><span class="javascript">    <span class="keyword">if</span> (!messages.length) <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>No Messages Listed.<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span></span><br><span class="line">    </span><br><span class="line"><span class="javascript">    <span class="keyword">return</span> ( </span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">p</span>&gt;</span>Messages: &#123;messages.length&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line">        &#123;</span><br><span class="line"><span class="javascript">          messages.map(<span class="function">(<span class="params">message, i</span>) =&gt;</span> <span class="xml"><span class="tag">&lt;<span class="name">Message</span> <span class="attr">key</span>=<span class="string">&#123;i&#125;</span> &#123;<span class="attr">...message</span>&#125; /&gt;</span></span>)</span></span><br><span class="line">        &#125;</span><br><span class="line"><span class="xml">      <span class="tag">&lt;/&gt;</span></span></span><br><span class="line">    );</span><br><span class="line">  &#125;;</span><br><span class="line">  </span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> App = <span class="function"><span class="params">()</span> =&gt;</span> (</span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">h3</span>&gt;</span>WebSocket instant messages<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">MessageList</span> /&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">  </span><br><span class="line">  render(</span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">App</span> /&gt;</span>,</span></span><br><span class="line"><span class="javascript">    <span class="built_in">document</span>.getElementById(<span class="string">"react-container"</span>)</span></span><br><span class="line">  ); </span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>開啟瀏覽器的 Console:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wss.sendTo();</span><br></pre></td></tr></table></figure>

<p>你的 APEX Page 畫面應該馬上會顯示訊息。</p>
<h4 id="使用-GraphQL-API-送出訊息"><a href="#使用-GraphQL-API-送出訊息" class="headerlink" title="使用 GraphQL API 送出訊息"></a>使用 GraphQL API 送出訊息</h4><p>透過 GraphQL API ，其實你可以從任何的地方使用 http 協定送出即時訊息。</p>
<p>可以使用 <a href="http://10.11.25.138:4000/v1/graphql" target="_blank" rel="noopener">GraphQL PlayGround</a> 送出測試資料。</p>
<figure class="highlight"><figcaption><span>GrlphQL API</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// url: GraphQL http://10.11.25.138:4000/v1/graphql</span><br><span class="line"></span><br><span class="line">// Mutation</span><br><span class="line">mutation sendToQueue($queue: String!, $message: String!) &#123;</span><br><span class="line">  sendToQueue(queue: $queue, message: $message)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Query Variables</span><br><span class="line">&#123;"queue":"wss.notification.demo",</span><br><span class="line">  "message":"&#123;\"wssid\":\"00013cf5-719b-401d-9ae2-dcf2da5ee4fc\",\"title\":\"Hello Tainan! 台南!\",\"message\":\"GraphQL http://10.11.25.138:4000/v1/graphql API\",\"created\":1602641256154&#125;" </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>現在從 Oracle 資料庫透過 GraphQL API 送出訊息。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span></span><br><span class="line">  l_http_request  Utl_Http.req;</span><br><span class="line">  l_http_response Utl_Http.resp;</span><br><span class="line">  l_url           varchar2(255) := 'http://10.11.25.138:4000/v1/graphql';</span><br><span class="line">  l_buffer        varchar2(32767);</span><br><span class="line">  l_item          varchar2(1024);</span><br><span class="line">  l_queue         varchar2(32) := 'wss.notification.demo';</span><br><span class="line">  l_wssid         varchar2(36) := '00013cf5-719b-401d-9ae2-dcf2da5ee4fc';</span><br><span class="line">  l_query         varchar2(32767);</span><br><span class="line"></span><br><span class="line">  procedure send(empno_in in number)</span><br><span class="line">  is</span><br><span class="line">    rec          emp%rowtype;</span><br><span class="line">    l_message    varchar2(1024);</span><br><span class="line">  <span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">select</span> * <span class="keyword">into</span> rec</span><br><span class="line">      <span class="keyword">from</span> emp</span><br><span class="line">     <span class="keyword">where</span> empno = empno_in;</span><br><span class="line"></span><br><span class="line">    l_message := '"&#123;'||</span><br><span class="line">                 '\"wssid\":'   ||'\"'||l_wssid||'\",'||</span><br><span class="line">                 '\"id\":'     ||'\"'||rec.empno||'-'||rec.deptno||'-'||rec.job||'\",'||</span><br><span class="line">                 '\"title\":'   ||rec.empno||','||</span><br><span class="line">                 '\"message\":'   ||'\"'||rec.ename||'\",'||</span><br><span class="line">                 '\"created\":'||'\"'||to_char(sysdate,'yyyy-mm-dd"T"hh24:mi:ss')||'\"'||</span><br><span class="line">                 '&#125;"';</span><br><span class="line"></span><br><span class="line">    l_query := '&#123;"query":"mutation sendToQueue($queue: String!, $message: String!)' ||</span><br><span class="line">               ' &#123;\n  sendToQueue(queue: $queue, message: $message)\n&#125;",' ||</span><br><span class="line">               '"variables":&#123;"queue":"' || l_queue || '","message":' || l_message ||'&#125;&#125;';</span><br><span class="line"></span><br><span class="line">    <span class="comment">--dbms_output.put_line(l_query);</span></span><br><span class="line"></span><br><span class="line">    l_http_request := utl_http.begin_request(l_url, 'POST','HTTP/1.1');</span><br><span class="line">    utl_http.set_header(l_http_request, 'user-agent', 'mozilla/4.0');</span><br><span class="line">    utl_http.set_header(l_http_request, 'content-type', 'application/json; charset=utf-8');</span><br><span class="line">    utl_http.set_header(l_http_request, 'Content-Length', lengthb(l_query));</span><br><span class="line">    utl_http.set_body_charset(l_http_request, charset =&gt; 'utf-8');</span><br><span class="line">    utl_http.write_text(l_http_request, l_query);</span><br><span class="line">    l_http_response := utl_http.get_response(l_http_request);</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- process the response from the HTTP call</span></span><br><span class="line">    <span class="keyword">begin</span></span><br><span class="line">      <span class="keyword">loop</span></span><br><span class="line">        utl_http.read_line(l_http_response, l_buffer);</span><br><span class="line">        dbms_output.put_line(l_buffer);</span><br><span class="line">      <span class="keyword">end</span> <span class="keyword">loop</span>;</span><br><span class="line">      utl_http.end_response(l_http_response);</span><br><span class="line">    exception</span><br><span class="line">      when utl_http.end_of_body</span><br><span class="line">      then</span><br><span class="line">        utl_http.end_response(l_http_response);</span><br><span class="line">      <span class="keyword">end</span>;</span><br><span class="line">  exception</span><br><span class="line">    when no_data_found</span><br><span class="line">    then</span><br><span class="line">      dbms_output.put_line('No data found.');</span><br><span class="line">  <span class="keyword">end</span>;</span><br><span class="line"><span class="comment">-- main body</span></span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  <span class="keyword">for</span> rec <span class="keyword">in</span> (<span class="keyword">select</span> <span class="keyword">rownum</span>, empno <span class="keyword">from</span> emp <span class="keyword">where</span> empno = <span class="number">7654</span>)</span><br><span class="line">  <span class="keyword">loop</span></span><br><span class="line">    send(rec.empno);</span><br><span class="line">  <span class="keyword">end</span> <span class="keyword">loop</span>;</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line">/</span><br></pre></td></tr></table></figure>

<p>接收與送出所需要的資料欄位請視所需自行調整。</p>
<p>你每次收到的訊息如果有可能都有不同的資料欄位，可修改 Message 組件:</p>
<figure class="highlight js"><figcaption><span>Message</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Message = <span class="function">(<span class="params"> props </span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;p&gt;</span><br><span class="line">      &#123;<span class="built_in">Object</span>.keys(props).map(<span class="function">(<span class="params">prop, i</span>) =&gt;</span> </span><br><span class="line">         (<span class="xml"><span class="tag">&lt;<span class="name">span</span> <span class="attr">key</span>=<span class="string">&#123;i&#125;</span>&gt;</span> &#123; prop.toUpperCase() &#125;: &#123; props[prop] &#125; <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span>)</span><br><span class="line">      )&#125;</span><br><span class="line">    &lt;<span class="regexp">/p&gt;</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp">&#125;;</span></span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://1184yang.github.io/2020/10/12/Enhancing-Components-with-Hooks/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/1184yang.jpg">
      <meta itemprop="name" content="J.Y. Yang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/10/12/Enhancing-Components-with-Hooks/" class="post-title-link" itemprop="url">Enhancing Components with Hooks (Ⅰ)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2020-10-12 13:29:32" itemprop="dateCreated datePublished" datetime="2020-10-12T13:29:32+08:00">2020-10-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2020-12-24 18:13:30" itemprop="dateModified" datetime="2020-12-24T18:13:30+08:00">2020-12-24</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/JavaScript/" itemprop="url" rel="index"><span itemprop="name">JavaScript</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/React/" itemprop="url" rel="index"><span itemprop="name">React</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>渲染 (rendering) 是 React 應用程序的心臟，當某些東西（屬性，狀態）發生變化時，組件樹會重新渲染，將最新數據反映給使用者界面。到目前為止，useState 一直是描述組件渲染方式的主要工作。但是我們可以做的更多。還有更多的 Hooks 可以定義有關為什麼以及何時進行渲染的規則。還有更多的掛鉤可以增強渲染效能。</p>
<p>之前，我們介紹了 useState，useContext，我們看到可以將這些 Hooks 組合到我們自己的自定義 Hooks 中：useInput 和 useColors。 不過，還有更多，React 附帶了更多可用的 Hooks。再來，我們將仔細研究 useEffect，useLayoutEffect 和 useReducer。所有這些對於構建應用程序都至關重要。我們還將介紹 useCallback 和 useMemo，它們可以幫助優化我們的組件以提高性能。</p>
<h4 id="使用-useEffect"><a href="#使用-useEffect" class="headerlink" title="使用 useEffect"></a>使用 useEffect</h4><p>現在，我們對渲染組件時發生的情況有了很好的了解。組件僅僅是渲染用戶界面的函式。渲染在應用程序<strong>首次加載</strong>以及<strong>屬性和狀態(props and state)值更改</strong>時發生。但是，有時候我們希望在 React 渲染更新 DOM 之後執行一些額外的程式碼。網路請求、手動變更 DOM、和 logging，該如何做？</p>
<p>我們使用一個簡單的 Checkbox 複選框組件來觀察組件的渲染週期。我們使用 useState 設置一個 checked 值，並使用 setChecked 函式來更改 checked 的值。用戶可以選擇和取消選擇該複選框，但是我們如何提醒用戶該複選框已被選擇呢？</p>
<p>我們使用 console.log 來觀察一下組件的渲染週期:</p>
<figure class="highlight html"><figcaption><span>Checkbox</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"react-container"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/babel"</span>&gt;</span></span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> &#123; useState &#125; = React;</span></span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> &#123; render &#125; = ReactDOM;</span></span><br><span class="line">  </span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> Checkbox = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">const</span> [checked, setChecked] = useState(<span class="literal">false</span>);</span></span><br><span class="line">    </span><br><span class="line"><span class="javascript">    <span class="built_in">console</span>.log(<span class="string">`before render: checked: <span class="subst">$&#123;checked.toString()&#125;</span>`</span>);</span></span><br><span class="line">    </span><br><span class="line"><span class="javascript">    <span class="keyword">return</span> (</span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;&gt;</span></span></span><br><span class="line">        &lt;input </span><br><span class="line"><span class="javascript">          type=<span class="string">"checkbox"</span></span></span><br><span class="line">          value=&#123;checked&#125;</span><br><span class="line"><span class="javascript">          onChange=&#123;() =&gt; setChecked(<span class="function"><span class="params">checked</span> =&gt;</span> !checked)&#125;</span></span><br><span class="line">        /&gt;</span><br><span class="line"><span class="javascript">        &lt;span className=<span class="string">"margin-left-sm"</span>&gt;&#123;checked ? <span class="string">"checked"</span> : <span class="string">"not checked"</span>&#125;&lt;<span class="regexp">/span&gt;</span></span></span><br><span class="line"><span class="javascript">        &#123;<span class="built_in">console</span>.log(<span class="string">`rendering: checked: <span class="subst">$&#123;checked.toString()&#125;</span>`</span>)&#125;</span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;/&gt;</span></span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line"><span class="javascript">    <span class="built_in">console</span>.log(<span class="string">`after render: checked: <span class="subst">$&#123;checked.toString()&#125;</span>`</span>);</span></span><br><span class="line">  &#125;;</span><br><span class="line"> </span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> App = <span class="function"><span class="params">()</span> =&gt;</span> (</span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Hello Tainan!<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">Checkbox</span> /&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">  </span><br><span class="line">  render (</span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">App</span> /&gt;</span>,</span></span><br><span class="line"><span class="javascript">    <span class="built_in">document</span>.getElementById(<span class="string">"react-container"</span>)</span></span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>組件的渲染主要是第 12 行到第 22 行 return 的 JSX 程式碼。我們在第 10 行渲染之前、第 20 行渲染時與第 24 行渲染後添加了 console.log。執行的結果是:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">before render: checked: false</span><br><span class="line">rendering: checked: false</span><br></pre></td></tr></table></figure>

<p>第 24 行渲染後調用的 console.log 沒有被執行，因為它位於 return 之後，將永遠無法到達該代碼。</p>
<p>為確保渲染後按預期方式看到 console.log，我們可以使用 useEffect。放置在 useEffect 函式內的 console.log 意味著該函式將在渲染後被當成一種<strong>副作用(side effect)</strong>而被調用。</p>
<figure class="highlight js"><figcaption><span>Checkbox</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; useState, useEffect &#125; = React;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">const</span> Checkbox = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> [checked, setChecked] = useState(<span class="literal">false</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`before render: checked: <span class="subst">$&#123;checked.toString()&#125;</span>`</span>);</span><br><span class="line">  </span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`after render: checked: <span class="subst">$&#123;checked.toString()&#125;</span>`</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;&gt;</span><br><span class="line">      &lt;input </span><br><span class="line">        type=<span class="string">"checkbox"</span></span><br><span class="line">        value=&#123;checked&#125;</span><br><span class="line">        onChange=&#123;() =&gt; setChecked(<span class="function"><span class="params">checked</span> =&gt;</span> !checked)&#125;</span><br><span class="line">      /&gt;</span><br><span class="line">      &lt;span className=<span class="string">"margin-left-sm"</span>&gt;&#123;checked ? <span class="string">"checked"</span> : <span class="string">"not checked"</span>&#125;&lt;<span class="regexp">/span&gt;</span></span><br><span class="line"><span class="regexp">      &#123;console.log(`rendering: checked: $&#123;checked.toString()&#125;`)&#125;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>第 1 行加入 useEffect；第 9 行將原來在渲染後調用的 console.log 放置在 useEffect 函式裡，而 useEffect 函式將在渲染後作為副作用而被調用。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">before render: checked: false</span><br><span class="line">rendering: checked: false</span><br><span class="line">after render: checked: false</span><br></pre></td></tr></table></figure>

<p>當渲染需要引起副作用時，我們使用 useEffect。 可以將副作用視為函式除了使用 return 所返回的結果之外還可以完成並影響函式外的事情。 Checkbox 函式使用 return 渲染 UI，但是我們希望 Checkbox 組件做更多的事情。組件執行除 return UI 之外的其他操作稱為 <strong>effect</strong>。</p>
<p>console.log 或與瀏覽器或本機 API 的互動都不是渲染的一部分，這不是 return 的一部分。在 React 應用程序中，<strong>渲染會影響這些事件的結果，我們可以使用 useEffect 等待渲染之後</strong>，再將值提供給 console.log：</p>
<figure class="highlight js"><figcaption><span>useEffect</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(checked ? <span class="string">"Yes, checked"</span> : <span class="string">"No, not checked"</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>同樣，我們可以使用渲染時的 checked 值，然後將其存儲到 localStorage 中。</p>
<figure class="highlight js"><figcaption><span>useEffect</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  localStorage.setItem(<span class="string">"checkbox-value"</span>, checked);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>將 useEffect 視為渲染後發生的函式。當渲染觸發時，我們可以訪問組件中當前的狀態值，並使用它們執行其他操作，這些操作都必須在渲染後調用，否則就與渲染的 UI 不相等了。然後，一旦我們再次渲染，整個過程就會重新開始。 新值，新渲染，新 effects。</p>
<h4 id="依賴陣列-The-Dependency-Array"><a href="#依賴陣列-The-Dependency-Array" class="headerlink" title="依賴陣列 (The Dependency Array)"></a>依賴陣列 (The Dependency Array)</h4><p>useEffect 的設計旨在與其他有狀態的 Hooks，例如 useState 和迄今未提及的 useReducer 結合使用。當狀態改變時，React 將重新渲染組件樹。然後，在這些渲染之後調用 useEffect。</p>
<p>我們來看看與 useState 結合使用的範例。</p>
<figure class="highlight js"><figcaption><span>useState and useEffect</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; useState, useEffect &#125; = React;</span><br><span class="line">  <span class="keyword">const</span> &#123; render &#125; = ReactDOM;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> App = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> [val, <span class="keyword">set</span>] = useState("");</span><br><span class="line">    const [phrase, setPhrase] = useState("example phrase");</span><br><span class="line">    </span><br><span class="line">    const createPhrase = (e) =&gt; &#123;</span><br><span class="line">      e.preventDefault();</span><br><span class="line">      </span><br><span class="line">      setPhrase(val);</span><br><span class="line">      <span class="keyword">set</span>("");</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    useEffect(() =&gt; &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`typing "<span class="subst">$&#123;val&#125;</span>"`</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`saved phrase: "<span class="subst">$&#123;phrase&#125;</span>"`</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;&gt;</span><br><span class="line">        &lt;label className=<span class="string">"margin-right-sm"</span>&gt;Favorite phrase:&lt;<span class="regexp">/label&gt;</span></span><br><span class="line"><span class="regexp">        &lt;input</span></span><br><span class="line"><span class="regexp">          value=&#123;val&#125;</span></span><br><span class="line"><span class="regexp">          placeholder=&#123;phrase&#125;</span></span><br><span class="line"><span class="regexp">          onChange=&#123;e =&gt; set(e.target.value)&#125;</span></span><br><span class="line"><span class="regexp">        /</span>&gt;</span><br><span class="line">        &lt;button </span><br><span class="line">          className=<span class="string">"t-Button t-Button--hot margin-left-sm"</span> </span><br><span class="line">          onClick=&#123;createPhrase&#125;</span><br><span class="line">        &gt;Send&lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">      &lt;/</span>&gt;</span><br><span class="line">    );  </span><br><span class="line">  &#125;;</span><br><span class="line">  </span><br><span class="line">  render (</span><br><span class="line">    &lt;App /&gt;,</span><br><span class="line">    <span class="built_in">document</span>.getElementById(<span class="string">"react-container"</span>)</span><br><span class="line">  );</span><br></pre></td></tr></table></figure>

<p>val 是一個狀態變數，表示輸入字段的值。每次輸入字段的值時 val 都會更改，這會使組件在用戶每次鍵入新字符時渲染 App 組件。當用戶單擊 “Send” 按鈕時，文本區域的 val 會被保存到 phrase 狀態變數，並且重置 val 為空字串，這將清空文本字段。這是一個不斷渲染的過程。</p>
<p>這可以按預期工作，但是 useEffect 掛鉤被調用的次數超過了應有的次數。 每次鍵入新字符渲染後，兩個 useEffect Hooks 均會被調用：</p>
<figure class="highlight plain"><figcaption><span>console.log</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">typing &quot;&quot;                             // First Render</span><br><span class="line">saved phrase: &quot;example phrase&quot;        // First Render</span><br><span class="line">typing &quot;H&quot;                            // Second Render</span><br><span class="line">saved phrase: &quot;example phrase&quot;        // Second Render</span><br><span class="line">typing &quot;He&quot;                           // Third Render </span><br><span class="line">saved phrase: &quot;example phrase&quot;        // Third Render</span><br><span class="line">typing &quot;Hel&quot;                          // Fourth Render</span><br><span class="line">saved phrase: &quot;example phrase&quot;        // Fourth Render</span><br><span class="line">typing &quot;Hell&quot;                         // Fifth Render</span><br><span class="line">saved phrase: &quot;example phrase&quot;        // Fifth Render</span><br><span class="line">typing &quot;Hello&quot;                        // Sixth Render</span><br><span class="line">saved phrase: &quot;example phrase&quot;        // Sixth Render</span><br></pre></td></tr></table></figure>

<p>我們不希望在每個渲染調用所有的 effect。 我們需要將 useEffect 掛鉤與特定的數據更改相關聯，當某些數據更改時才調用 useEffect。為了解決這個問題，我們可以合併<strong>依賴陣列(Dependency array)</strong>。依賴陣列可用於控制何時調用 useEffect：</p>
<figure class="highlight js"><figcaption><span>Dependency array</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`typing "<span class="subst">$&#123;val&#125;</span>"`</span>);</span><br><span class="line">&#125;, [val]);</span><br><span class="line"></span><br><span class="line">useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`saved phrase: "<span class="subst">$&#123;phrase&#125;</span>"`</span>);</span><br><span class="line">&#125;, [phrase]);</span><br></pre></td></tr></table></figure>

<p>第 3 與第 7 行我們將依賴陣列添加到兩個 effect 中，以控制它們何時被調用。現在，僅在依賴陣列中的值更改時才會調用這些 effect。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">typing &quot;&quot;                             // First Render</span><br><span class="line">saved phrase: &quot;example phrase&quot;        // First Render</span><br><span class="line">typing &quot;H&quot;                            // Second Render</span><br><span class="line">typing &quot;He&quot;                           // Third Render</span><br><span class="line">typing &quot;Hel&quot;                          // Fourth Render</span><br><span class="line">typing &quot;Hell&quot;                         // Fifth Render</span><br><span class="line">typing &quot;Hello&quot;                        // Sixth Render</span><br><span class="line">typing &quot;&quot;                             // Seventh Render</span><br><span class="line">saved phrase: &quot;Hello&quot;                 // Seventh Render</span><br></pre></td></tr></table></figure>

<p>依賴陣列畢竟是一個陣列，因此可以檢查依賴陣列中的多個值。假設我們想在 val 或 phreae 發生變化時調用 useEffect。</p>
<figure class="highlight js"><figcaption><span>Dependency array</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"either val or phrase has changed"</span>);</span><br><span class="line">&#125;, [val, phrase]);</span><br></pre></td></tr></table></figure>

<p>還可以提供一個空陣列，空的依賴陣列會導致 effect 在初始渲染之後<strong>僅被調用一次</strong>。</p>
<figure class="highlight js"><figcaption><span>Dependency array</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"only once after initial render"</span>);</span><br><span class="line">&#125;, []);</span><br></pre></td></tr></table></figure>

<p>依賴陣列中沒有依賴項意味著沒有更改，因此 effect 將不再被調用。 僅在第一個渲染上調用的 effects 對於初始化非常有用：</p>
<figure class="highlight js"><figcaption><span>Dependency array</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  welcome();</span><br><span class="line">&#125;, []);</span><br></pre></td></tr></table></figure>

<p>如果從 effect 中返回一個函式，則從組件樹中刪除該組件時將會調用該函式：</p>
<figure class="highlight js"><figcaption><span>Dependency array</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  welcome();</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> goodbye();</span><br><span class="line">&#125;, []);</span><br></pre></td></tr></table></figure>

<p>這意味著，您可以使用 useEffect 進行初始設定和卸載。空陣列意味著 welcome 將在第一次渲染時只被調用一次。然後，當組件從組件樹中刪除時，我們將返回一個 goodbye 函式作為清理函式。</p>
<p>此模式在許多情況下很有用。我們可以在第一次渲染時訂閱 WebSocket 服務。 然後，我們將使用清理函式退訂 WebSocket 服務。</p>
<figure class="highlight js"><figcaption><span>useEffect</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> [messages, setMessages] = useState([]);</span><br><span class="line"><span class="keyword">const</span> addMessage = <span class="function"><span class="params">message</span> =&gt;</span> setMessages(<span class="function"><span class="params">allMessages</span> =&gt;</span> [message, ...allMessages]);</span><br><span class="line"></span><br><span class="line">useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  wsService.subscribe(addMessage);</span><br><span class="line">  welcome();</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    wsService.unsubscribe();</span><br><span class="line">    goodbye();</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;, []);</span><br></pre></td></tr></table></figure>

<p>在一個 useEffect 進行太多工作，看起來很雜亂，也較容易出錯。將功能分為多個 useEffect 調用，通常是一個比較好的主意。</p>
<figure class="highlight js"><figcaption><span>useEffect</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  wsService.subscribe(addMessage);</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span>  wsService.unsubscribe();</span><br><span class="line">&#125;, []);</span><br><span class="line"></span><br><span class="line">useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  welcome();</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> goodbye();</span><br><span class="line">&#125;, []);</span><br></pre></td></tr></table></figure>

<p>我們還可以進一步增強它。這是自定義掛鉤 (custom hook) 的好地方。</p>
<figure class="highlight js"><figcaption><span>useWsMessages custom hook</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> useWsMessages = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> [messages, setMessages] = useState([]);</span><br><span class="line">  <span class="keyword">const</span> addMessage = <span class="function"><span class="params">message</span> =&gt;</span> setMessages(<span class="function"><span class="params">allMessages</span> =&gt;</span> [message, ...allMessages]);</span><br><span class="line">    </span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    wsService.subscribe(addMessage);</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span>  wsService.unsubscribe();</span><br><span class="line">  &#125;, []);</span><br><span class="line">  </span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    welcome();</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> goodbye();</span><br><span class="line">  &#125;, []);</span><br><span class="line">    </span><br><span class="line">  <span class="keyword">return</span> messages;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>我們的自定義掛鉤包含處理數據的所有功能，這意味著，我們可以輕鬆地與其他的組件共享此功能。在一個名為 MessageList 的新組件中，我們將可以使用自定義掛鉤:</p>
<figure class="highlight js"><figcaption><span>MessageList</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> MessageList = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> messages = useWsMessages();</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;&gt;</span><br><span class="line">      &lt;h1&gt;&#123;messages.length&#125;&lt;<span class="regexp">/h1&gt;</span></span><br><span class="line"><span class="regexp">      &#123;messages.map(message =&gt; (</span></span><br><span class="line"><span class="regexp">        &lt;Message key=&#123;message.id&#125; &#123;...message&#125; /</span>&gt;    </span><br><span class="line">      ))&#125;</span><br><span class="line">    &lt;<span class="regexp">/&gt;</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp">&#125;;</span></span><br></pre></td></tr></table></figure>

<p>我們可以輕鬆的使用 useWsMessages 自定義掛鉤，當有訂閱的數據到達時，MessageList 組件將會重新渲染。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://1184yang.github.io/2020/10/07/React-Context/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/1184yang.jpg">
      <meta itemprop="name" content="J.Y. Yang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/10/07/React-Context/" class="post-title-link" itemprop="url">React Context</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2020-10-07 08:55:21" itemprop="dateCreated datePublished" datetime="2020-10-07T08:55:21+08:00">2020-10-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2020-12-24 18:13:30" itemprop="dateModified" datetime="2020-12-24T18:13:30+08:00">2020-12-24</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/JavaScript/" itemprop="url" rel="index"><span itemprop="name">JavaScript</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/React/" itemprop="url" rel="index"><span itemprop="name">React</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>執行上下文(Execution Context)的概念(簡稱為 context)在 JavaScript 中非常重要。變數或函式的執行上下文定義了它可以存取運作的資料，以及它應該如何運作。 每個執行上下文都有一個關聯的 variable 物件，在這個執行上下文所定義的變數和函數，都存在這個 variable 物件上。此 variable 物件無法由程式碼作存取，一卻都在幕後運作。</p>
<p>在各種 JavaScript 運作的架構，都將此 context 概念運用在其結構上。GraphQL 有 context，React 也不例外。</p>
<p>在 React 中，<strong>context</strong> (上下文) 就像為數據設置噴射機一樣。 您可以通過創建 <strong>context provider</strong> (上下文提供者) 將數據放置在 React context 中。Context provider 是一個 React 組件，您可以將其包裹在整個組件樹或組件樹的特定部分中。</p>
<p>Context provider 是您的數據所在的出發機場。它也是航空公司的樞紐。所有航班都從該機場出發，飛往不同的目的地。每個目的地都是 <strong>context consumer</strong> (上下文使用者)。</p>
<p>context consumer 是一種從 context 檢索數據的 React 組件。這是您的數據著陸，下機並開始工作的目的地機場。</p>
<p>使用 context 將使我們能夠將數據存儲在單個位置，但是不需要我們將數據通過不需要它們的一堆組件傳遞。</p>
<h4 id="將資料放置在-Context"><a href="#將資料放置在-Context" class="headerlink" title="將資料放置在 Context"></a>將資料放置在 Context</h4><p>為了在 React 中使用 context，我們必須首先在 context provider 中放置一些數據，然後將該 provider 添加到我們的組件樹中。React 有一個稱為 createContext 的函式，我們可以使用它創建一個新的 context 物件。 該物件包含兩個組件：context <strong>Provider</strong> 和 <strong>Consumer</strong>。</p>
<p>讓我們將顏色數據 colors 放入 context 中。 通常都會將 context 添加到應用程序的入口點，然後就可以在每個組件中使用。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;div id=<span class="string">"react-container"</span>&gt;&lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">&lt;script type="text/</span>babel<span class="string">"&gt;</span></span><br><span class="line"><span class="string">  const &#123; createContext &#125; = React;</span></span><br><span class="line"><span class="string">  const &#123; render &#125; = ReactDOM;</span></span><br><span class="line"><span class="string">  const &#123; uuid, colorData &#125; = Demo;</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">  const ColorContext = createContext();</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">  ...</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  render(</span></span><br><span class="line"><span class="string">    &lt;ColorContext.Provider value=&#123;&#123; colors: colorData &#125;&#125;&gt;</span></span><br><span class="line"><span class="string">      &lt;App /&gt;</span></span><br><span class="line"><span class="string">    &lt;/ColorContext.Provider&gt;,</span></span><br><span class="line"><span class="string">    document.getElementById("</span>react-container<span class="string">")</span></span><br><span class="line"><span class="string">  ); </span></span><br><span class="line"><span class="string">&lt;/script&gt;</span></span><br></pre></td></tr></table></figure>

<p>第 8 行我們使用 createContext 創建了一個新的 React context 實例，我們將其命名為 ColorContext。color context 包含兩個組件：ColorContext.Provider 和 ColorContext.Consumer。</p>
<p>我們需要使用 provider 將 colors 數據置於狀態中。第 13 行通過設置 Provider 的 value 屬性，可以將數據添加到 context 中。 這裡，我們向 context 添加了一個包含 colorData 數據的 colors 屬性的物件。由於我們使用 provider 包裝了整個 App 組件，因此 colors 數據將可供我們整個組件樹中含有 context consumer 的組件使用。當組件想從 context 中獲取 colors 數據時，只需要訪問 ColorContext.Consumer。</p>
<p>Context provider 並不必總是需要包裝整個應用程序；可以只包裝特定部分的組件，這可以使您的應用程序有更好的效能。Provider 將僅向其子組件提供 context 值。因此可以在一個應用程序使用多個 context provider。</p>
<p>現在我們在 conext 中提供 colors 數據，App 組件不再需要保持狀態並將其作為 props 屬性傳遞給其子組件。我們可以直接飛過 App 組件。Provider 是 App 組件的父級，它在 context 中提供 colors。 ColorList 是 App 組件的子級，它可以直接自己獲取 colors。 因此 App 組件根本不需要接觸 colors，因為 App 組件本身與 colors 無關，這種保持狀態的責任已從組件樹中解脫了。</p>
<p>我們可以從　App　組件中刪除很多代碼。它只需要呈現　AddColorForm　和　ColorList。 它不再需要擔心數據狀態：</p>
<figure class="highlight js"><figcaption><span>App</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> App = <span class="function"><span class="params">()</span> =&gt;</span> &#123;   </span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;&gt;</span><br><span class="line">      &lt;AddColorForm /&gt;  </span><br><span class="line">      &lt;ColorList /&gt;</span><br><span class="line">    &lt;<span class="regexp">/&gt;</span></span><br><span class="line"><span class="regexp">  );  </span></span><br><span class="line"><span class="regexp">&#125;;</span></span><br></pre></td></tr></table></figure>

<h4 id="使用-useContext-取得資料"><a href="#使用-useContext-取得資料" class="headerlink" title="使用 useContext 取得資料"></a>使用 useContext 取得資料</h4><p>React 16.8 之後添加的 Hooks 使處理 context 變得更簡易。現在使用 useContext 掛鉤，直接在掛鉤中訪問 Consumer，我們不再需要直接使用 Consumer 組件。在使用 Hooks 之前，我們必須使用 context consumer 中稱為 <strong>render props</strong> 的模式從 context 中獲取 colors。Render props 作為參數傳遞給子組件。 現在我們直接使用 useContext 掛鉤從 context consumer 中獲取我們需要的那些值。</p>
<p>ColorList 組件不再需要從其屬性獲取 colors。它可以通過 useContext 掛鉤直接訪問它們：</p>
<figure class="highlight js"><figcaption><span>ColorList</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; createContext, useContext &#125; = React;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> ColorList = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; colors &#125; = useContext(ColorContext);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span>(!colors.length) <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>No Colors Listed.<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &#123;</span><br><span class="line">         colors.map(<span class="function"><span class="params">color</span> =&gt;</span> <span class="xml"><span class="tag">&lt;<span class="name">Color</span> <span class="attr">key</span>=<span class="string">&#123;color.id&#125;</span> &#123;<span class="attr">...color</span>&#125; /&gt;</span></span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp">&#125;;</span></span><br></pre></td></tr></table></figure>

<p>第 1 行將 useContext 加進來。第 6 行使用 useContext 掛鉤從 context consumer 中獲取我們需要的數據 colors。現在，ColorList 可以基於 context 中提供的數據構造用戶界面。</p>
<h4 id="Stateful-Context-Provider"><a href="#Stateful-Context-Provider" class="headerlink" title="Stateful Context Provider"></a>Stateful Context Provider</h4><p>Context provider 可以將一個物件放入 context 中，但是不能自行更改 context 中的值。它需要父級組件的幫助。訣竅是創建一個能夠渲染 context provider 的有狀態父組件。當有狀態組件的狀態更改時，它將使用新的 context 數據重新渲染 context provider (context provider 也是一個 React 組件)。 而 context provider 的任何子代也將重新以新的 context 數據渲染介面。</p>
<p>這個會渲染 context provider 的有狀態組件是我們的 <strong>custom provider</strong>。 這個自定義的有狀態組件將我們的 App 組件與 provider 包裝在一起。</p>
<figure class="highlight js"><figcaption><span>ColorProvider</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; createContext, useContext, useState &#125; = React;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> ColorProvider = <span class="function">(<span class="params">&#123; children &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> [colors, setColors] = useState(colorData);</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;ColorContext.Provider value=&#123;&#123; colors, setColors &#125;&#125;&gt;</span><br><span class="line">      &#123;children&#125;</span><br><span class="line">    &lt;<span class="regexp">/ColorContext.Provider&gt;</span></span><br><span class="line"><span class="regexp">  )</span></span><br><span class="line"><span class="regexp">&#125;;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">render(</span></span><br><span class="line"><span class="regexp">  &lt;ColorProvider&gt;</span></span><br><span class="line"><span class="regexp">    &lt;App /</span>&gt;</span><br><span class="line">  &lt;<span class="regexp">/ColorProvider&gt;,</span></span><br><span class="line"><span class="regexp">  document.getElementById("react-container")</span></span><br><span class="line"><span class="regexp">);</span></span><br></pre></td></tr></table></figure>

<p>在此 ColorProvider 組件中，我們使用 useState 掛鉤創建了 colors 狀態變數。 ColorProvider 使用 ColorContext.Provider 的 value 屬性將 colors 從狀態添加到 context。 ColorProvider 中的所有子組件都會因狀態的改變而重新渲染，而且也都包裝在 ColorContext.Provider 中，所以也都將可以從 context 直接訪問 colors 數據。</p>
<p>您可能已經注意到，我們在第 8 行也將 setColors 函式添加到 context 中。這使 context consumers 可以更改 colors 數據。每當調用 setColors 時，colors 數據都會更改。這將導致 ColorProvider 的渲染，我們的 UI 將被更新，以顯示新的 colors 數據。</p>
<p>將 setColors 添加到 context 可能不是最好的主意。它可能會讓其他開發人員和您在以後使用它時出錯。更改 colors 數據的值時只有三個選項：添加顏色，刪除顏色或對顏色進行評級。 最好在 context 中為每個操作各自添加函式功能。這樣，您就不必向 consumers 公開 setColors 函式。 您將只公開允許其進行更改的函式功能：</p>
<figure class="highlight js"><figcaption><span>ColorProvider</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ColorProvider = <span class="function">(<span class="params">&#123; children &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> [colors, setColors] = useState(colorData);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> addColor = <span class="function">(<span class="params">title, color</span>) =&gt;</span> </span><br><span class="line">    setColors([</span><br><span class="line">      ...colors,</span><br><span class="line">      &#123;</span><br><span class="line">        id: uuid(),</span><br><span class="line">        rating: <span class="number">0</span>,</span><br><span class="line">        title,</span><br><span class="line">        color</span><br><span class="line">      &#125;</span><br><span class="line">    ]);</span><br><span class="line">    </span><br><span class="line">  <span class="keyword">const</span> rateColor = <span class="function">(<span class="params">id, rating</span>) =&gt;</span></span><br><span class="line">    setColors(colors.map(<span class="function"><span class="params">color</span> =&gt;</span> (color.id === id ? &#123; ...color, rating &#125; : color ))</span><br><span class="line">  );</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> removeColor = <span class="function"><span class="params">id</span> =&gt;</span> setColors(colors.filter(<span class="function"><span class="params">color</span> =&gt;</span> color.id !== id ));</span><br><span class="line">    </span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;ColorContext.Provider value=&#123;&#123; colors, addColor, removeColor, rateColor &#125;&#125;&gt;</span><br><span class="line">      &#123;children&#125;</span><br><span class="line">    &lt;<span class="regexp">/ColorContext.Provider&gt;</span></span><br><span class="line"><span class="regexp">  )</span></span><br><span class="line"><span class="regexp">&#125;;</span></span><br></pre></td></tr></table></figure>

<p>看起來好多了。在此我們為 context 添加了可以在 colors 陣列上進行的所有操作函式，addColor、reteColor 與 removeColor。 現在，組件樹中的任何組件都可以使用這些函式更改 colors 數據。</p>
<h4 id="Custom-Hooks-with-Context"><a href="#Custom-Hooks-with-Context" class="headerlink" title="Custom Hooks with Context"></a>Custom Hooks with Context</h4><p>我們還可以做出一些改變。Hooks 的引入使得 context 完全不必暴露於 consumer 組件。 但對於團隊成員而言，context 可能會造成混亂。 通過將 context 包裝在自定義掛鉤(custom hooks)中，我們可以使它們更容易理解與維護。</p>
<p>無需公開 ColorContext 實例，我們可以創建一個名為 useColors 的 hook ，該 hook 會從 context 返回 colors 數據。</p>
<figure class="highlight js"><figcaption><span>useColors</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ColorContext = createContext();</span><br><span class="line"><span class="keyword">const</span> useColors = <span class="function"><span class="params">()</span> =&gt;</span> useContext(ColorContext);</span><br></pre></td></tr></table></figure>

<p>這一簡單更改對應用程序結構產生了巨大影響。我們可以將呈現和使用有狀態數據 colors 所需的所有功能包裝在一個自定義掛鉤中。</p>
<p>現在 consumer 使用 ColorProvider 和 useColors 掛鉤是一件比較愉快的事情。App 組件的所有子級組件都可以從 useColors 掛鉤中獲取 colors 數據。 ColorList 組件現在可以直接使用自行定義的 useColors 掛鉤取得 colors 數據：</p>
<figure class="highlight js"><figcaption><span>ColorList</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ColorList = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; colors &#125; = useColors();</span><br><span class="line">  </span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> ( ... );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>我們從該組件中刪除了對 context 的任何引用。 現在，我們需要的一切都可以從我們自定義的掛鉤中獲得。</p>
<p>Color 組件現在也可以使用我們自行定義的 useColors 掛鉤直接獲取用於對 color 進行評級和刪除顏色的函式 rateColor 與 removeColor：</p>
<figure class="highlight js"><figcaption><span>Color</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Color = <span class="function">(<span class="params">&#123; id, title, color, rating &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; rateColor, removeColor &#125; = useColors();</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;section&gt;</span><br><span class="line">      &lt;h1&gt;&#123;title&#125;&lt;<span class="regexp">/h1&gt;</span></span><br><span class="line"><span class="regexp">      &lt;button className="t-Button" onClick=&#123;() =&gt; removeColor(id)&#125; &gt;</span></span><br><span class="line"><span class="regexp">        &lt;FaRemove /</span>&gt;</span><br><span class="line">      &lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">      &lt;div style=&#123;&#123; height: 50, backgroundColor: color&#125;&#125; /</span>&gt;</span><br><span class="line">      &lt;StarRating selectedStars=&#123;rating&#125; onRate=&#123;rating =&gt; rateColor(id, rating)&#125; /&gt;</span><br><span class="line">    &lt;<span class="regexp">/section&gt;</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp">&#125;;</span></span><br></pre></td></tr></table></figure>

<p>最後則是 AddColorForm 組件直接從 useColors 掛鉤取得 addColor 函式:</p>
<figure class="highlight js"><figcaption><span>AddColorForm</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> AddColorForm = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> [title, setTitle] = useState(<span class="string">""</span>);</span><br><span class="line">  <span class="keyword">const</span> [color, setColor] = useState(<span class="string">"#000000"</span>);</span><br><span class="line">  <span class="keyword">const</span> &#123; addColor &#125; = useColors();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> submit = <span class="function"><span class="params">e</span> =&gt;</span> &#123;</span><br><span class="line">    e.preventDefault();</span><br><span class="line">    addColor(title, color);</span><br><span class="line">    setTitle(<span class="string">""</span>);</span><br><span class="line">    setColor(<span class="string">"#000000"</span>);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;form onSubmit=&#123;submit&#125; &gt;</span><br><span class="line">      &lt;input </span><br><span class="line">        value=&#123;title&#125;</span><br><span class="line">        onChange=&#123; event =&gt; setTitle(event.target.value)&#125;</span><br><span class="line">        type=<span class="string">"text"</span></span><br><span class="line">        placeholder=<span class="string">"color title..."</span></span><br><span class="line">        required</span><br><span class="line">      /&gt;</span><br><span class="line">      &lt;input </span><br><span class="line">        value=&#123;color&#125;</span><br><span class="line">        onChange=&#123; event =&gt; setColor(event.target.value)&#125;</span><br><span class="line">        type=<span class="string">"color"</span></span><br><span class="line">        required</span><br><span class="line">      /&gt;</span><br><span class="line">      &lt;button className=<span class="string">"t-Button t-Button--hot margin-left-sm"</span>&gt;Add&lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>form&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="Custom-Hooks"><a href="#Custom-Hooks" class="headerlink" title="Custom Hooks"></a>Custom Hooks</h4><p>在 AddColorForm 組件中還有一個地方可以改進的。當您的大型表單具有很多 input 元素時，您可能會複製並貼上以下兩行代碼：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">value=&#123;title&#125;</span><br><span class="line">onChange=&#123; event =&gt; setTitle(event.target.value)&#125;</span><br></pre></td></tr></table></figure>

<p>通過簡單地將這些屬性複制並粘貼到每個表單元素中，同時調整變數名稱，似乎很快速。但是，腦海裡總覺得，複製和粘貼代碼表明這些應改可以用函式更抽象化這些冗餘的工作。</p>
<p>我們可以創建受控表單組件所需的詳細信息打包到自定義的掛鉤(Custom Hook)中。 我們可以創建自己的 useInput 掛鉤，可以抽像出創建受控表單輸入所涉及的冗餘部分：</p>
<figure class="highlight js"><figcaption><span>useInput</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> useInput = <span class="function"><span class="params">initialValue</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> [value, setValue] = useState(initialValue);</span><br><span class="line">  <span class="keyword">return</span> [</span><br><span class="line">    &#123; value, <span class="attr">onChange</span>: <span class="function"><span class="params">e</span> =&gt;</span> setValue(e.target.value) &#125;,</span><br><span class="line">    () =&gt; setValue(initialValue)</span><br><span class="line">  ];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>現在可以在 AddColorForm 使用自定義的 useInput 掛鉤：</p>
<figure class="highlight js"><figcaption><span>AddColorForm</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> AddColorForm = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> [titleProps, resetTitle] = useInput(<span class="string">""</span>);</span><br><span class="line">  <span class="keyword">const</span> [colorProps, resetColor] = useInput(<span class="string">"#000000"</span>);</span><br><span class="line">  <span class="keyword">const</span> &#123; addColor &#125; = useColors();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> submit = <span class="function"><span class="params">e</span> =&gt;</span> &#123;</span><br><span class="line">    e.preventDefault();</span><br><span class="line">    addColor(titleProps.value, colorProps.value);</span><br><span class="line">    resetTitle();</span><br><span class="line">    resetColor();</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;form onSubmit=&#123;submit&#125; &gt;</span><br><span class="line">      &lt;input </span><br><span class="line">        &#123;...titleProps&#125;</span><br><span class="line">        type=<span class="string">"text"</span></span><br><span class="line">        placeholder=<span class="string">"color title..."</span></span><br><span class="line">        required</span><br><span class="line">      /&gt;</span><br><span class="line">      &lt;input </span><br><span class="line">        &#123;...colorProps&#125;</span><br><span class="line">        type=<span class="string">"color"</span></span><br><span class="line">        required</span><br><span class="line">      /&gt;</span><br><span class="line">      &lt;button className=<span class="string">"t-Button t-Button--hot margin-left-sm"</span>&gt;Add&lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>form&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li>第 2、3 行改用自定義的 useInput 掛鉤。</li>
<li>第 16、22 行我們不用重複輸入 value 與 onChange 事件。</li>
<li>記得要一起修改 submit 函式中第 8 行 addColor 的參數與第 9 、10 行預設值設定。這個預設值是我們在調用 useInput 時設定的。</li>
</ul>
<p>不必靠組件屬性將數據傳上傳下的，整個程式碼更清楚與更容易理解。</p>
<figure class="highlight html"><figcaption><span>Oracle APEX: Color Organizer </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"react-container"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/babel"</span>&gt;</span></span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> &#123; createContext, useContext, useState &#125; = React;</span></span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> &#123; render &#125; = ReactDOM;</span></span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> &#123; uuid, colorData &#125; = Demo;</span></span><br><span class="line">  </span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> ColorContext = createContext();</span></span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> useColors = <span class="function"><span class="params">()</span> =&gt;</span> useContext(ColorContext);</span></span><br><span class="line">  </span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> ColorProvider = <span class="function">(<span class="params">&#123; children &#125;</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">const</span> [colors, setColors] = useState(colorData);</span></span><br><span class="line">  </span><br><span class="line"><span class="javascript">    <span class="keyword">const</span> addColor = <span class="function">(<span class="params">title, color</span>) =&gt;</span> </span></span><br><span class="line">      setColors([</span><br><span class="line">        ...colors,</span><br><span class="line">        &#123;</span><br><span class="line">          id: uuid(),</span><br><span class="line">          rating: 0,</span><br><span class="line">          title,</span><br><span class="line">          color</span><br><span class="line">        &#125;</span><br><span class="line">    ]);</span><br><span class="line">    </span><br><span class="line"><span class="javascript">    <span class="keyword">const</span> rateColor = <span class="function">(<span class="params">id, rating</span>) =&gt;</span></span></span><br><span class="line"><span class="javascript">      setColors(colors.map(<span class="function"><span class="params">color</span> =&gt;</span> (color.id === id ? &#123; ...color, rating &#125; : color ))</span></span><br><span class="line">    );</span><br><span class="line">  </span><br><span class="line"><span class="javascript">    <span class="keyword">const</span> removeColor = <span class="function"><span class="params">id</span> =&gt;</span> setColors(colors.filter(<span class="function"><span class="params">color</span> =&gt;</span> color.id !== id ));</span></span><br><span class="line">    </span><br><span class="line"><span class="javascript">    <span class="keyword">return</span> (</span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">ColorContext.Provider</span> <span class="attr">value</span>=<span class="string">&#123;&#123;</span> <span class="attr">colors</span>, <span class="attr">addColor</span>, <span class="attr">removeColor</span>, <span class="attr">rateColor</span> &#125;&#125;&gt;</span></span></span><br><span class="line">        &#123;children&#125;</span><br><span class="line"><span class="xml">      <span class="tag">&lt;/<span class="name">ColorContext.Provider</span>&gt;</span></span></span><br><span class="line">    )</span><br><span class="line">  &#125;;</span><br><span class="line">  </span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> FaStar = <span class="function">(<span class="params">&#123; color, onSelect =  f =&gt; f &#125;</span>) =&gt;</span> ( </span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">span</span> <span class="attr">className</span>=<span class="string">"fa fa-star"</span> <span class="attr">style</span>=<span class="string">&#123;&#123;color&#125;&#125;</span> <span class="attr">onClick</span>=<span class="string">&#123;onSelect&#125;</span> &gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">  </span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> Star = <span class="function">(<span class="params">&#123; selected = <span class="literal">false</span>, onSelect = f =&gt; f &#125;</span>) =&gt;</span> (</span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">FaStar</span> <span class="attr">color</span>=<span class="string">&#123;selected</span> ? "<span class="attr">gold</span>" <span class="attr">:</span> "<span class="attr">grey</span>"&#125; <span class="attr">onSelect</span>=<span class="string">&#123;onSelect&#125;</span> /&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">   </span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> createArray = <span class="function"><span class="params">length</span> =&gt;</span> [...Array(length)];</span></span><br><span class="line">  </span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> StarRating = <span class="function">(<span class="params">&#123; totalStars = <span class="number">5</span>, selectedStars = <span class="number">0</span>, onRate = f =&gt; f &#125;</span>) =&gt;</span> &#123;    </span></span><br><span class="line"><span class="javascript">    <span class="keyword">return</span> (</span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;&gt;</span></span></span><br><span class="line"><span class="javascript">        &#123;createArray(totalStars).map(<span class="function">(<span class="params">n, i</span>) =&gt;</span> (</span></span><br><span class="line">          &lt;Star</span><br><span class="line">            key=&#123;i&#125; </span><br><span class="line">            selected=&#123;selectedStars &gt; i&#125;</span><br><span class="line">            onSelect=&#123;() =&gt; onRate(i + 1)&#125;</span><br><span class="line">          /&gt;</span><br><span class="line">        ))&#125;</span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">p</span> <span class="attr">style</span>=<span class="string">&#123;&#123;fontSize:</span> "<span class="attr">1.5em</span>", <span class="attr">margin:</span> "<span class="attr">10px</span>"&#125;&#125;&gt;</span>&#123;selectedStars&#125; of &#123;totalStars&#125; stars<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;/&gt;</span></span></span><br><span class="line">    );</span><br><span class="line">  &#125;;</span><br><span class="line">  </span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> FaRemove = <span class="function"><span class="params">()</span> =&gt;</span>  <span class="xml"><span class="tag">&lt;<span class="name">span</span> <span class="attr">className</span>=<span class="string">"fa fa-remove"</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span>;</span></span><br><span class="line">  </span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> Color = <span class="function">(<span class="params">&#123; id, title, color, rating &#125;</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">const</span> &#123; rateColor, removeColor &#125; = useColors();</span></span><br><span class="line"><span class="javascript">    <span class="keyword">return</span> (</span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">section</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">h1</span>&gt;</span>&#123;title&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">className</span>=<span class="string">"t-Button"</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> removeColor(id)&#125; &gt;</span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;<span class="name">FaRemove</span> /&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">height:</span> <span class="attr">50</span>, <span class="attr">backgroundColor:</span> <span class="attr">color</span>&#125;&#125; /&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">StarRating</span> <span class="attr">selectedStars</span>=<span class="string">&#123;rating&#125;</span> <span class="attr">onRate</span>=<span class="string">&#123;rating</span> =&gt;</span> rateColor(id, rating)&#125; /&gt;</span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;/<span class="name">section</span>&gt;</span></span></span><br><span class="line">    );</span><br><span class="line">  &#125;;</span><br><span class="line">  </span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> ColorList = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">const</span> &#123; colors &#125; = useColors();</span></span><br><span class="line">    </span><br><span class="line"><span class="javascript">    <span class="keyword">if</span>(!colors.length) <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>No Colors Listed.<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span></span><br><span class="line"></span><br><span class="line"><span class="javascript">    <span class="keyword">return</span> (</span></span><br><span class="line"><span class="javascript">      &lt;div&gt;&#123; colors.map(<span class="function"><span class="params">color</span> =&gt;</span> <span class="xml"><span class="tag">&lt;<span class="name">Color</span> <span class="attr">key</span>=<span class="string">&#123;color.id&#125;</span> &#123;<span class="attr">...color</span>&#125; /&gt;</span></span>) &#125; &lt;<span class="regexp">/div&gt;</span></span></span><br><span class="line">    );</span><br><span class="line">  &#125;;</span><br><span class="line">  </span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> useInput = <span class="function"><span class="params">initialValue</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">const</span> [value, setValue] = useState(initialValue);</span></span><br><span class="line"><span class="javascript">    <span class="keyword">return</span> [</span></span><br><span class="line"><span class="javascript">      &#123; value, <span class="attr">onChange</span>: <span class="function"><span class="params">e</span> =&gt;</span> setValue(e.target.value) &#125;,</span></span><br><span class="line">      () =&gt; setValue(initialValue)</span><br><span class="line">    ];</span><br><span class="line">  &#125;;</span><br><span class="line">  </span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> AddColorForm = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">const</span> [titleProps, resetTitle] = useInput(<span class="string">""</span>);</span></span><br><span class="line"><span class="javascript">    <span class="keyword">const</span> [colorProps, resetColor] = useInput(<span class="string">"#000000"</span>);</span></span><br><span class="line"><span class="javascript">    <span class="keyword">const</span> &#123; addColor &#125; = useColors();</span></span><br><span class="line">  </span><br><span class="line"><span class="javascript">    <span class="keyword">const</span> submit = <span class="function"><span class="params">e</span> =&gt;</span> &#123;</span></span><br><span class="line">      e.preventDefault();</span><br><span class="line">      addColor(titleProps.value, colorProps.value);</span><br><span class="line">      resetTitle();</span><br><span class="line">      resetColor();</span><br><span class="line">    &#125;;</span><br><span class="line">  </span><br><span class="line"><span class="javascript">    <span class="keyword">return</span> (</span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">form</span> <span class="attr">onSubmit</span>=<span class="string">&#123;submit&#125;</span> &gt;</span></span></span><br><span class="line">        &lt;input </span><br><span class="line">          &#123;...titleProps&#125;</span><br><span class="line"><span class="javascript">          type=<span class="string">"text"</span></span></span><br><span class="line"><span class="javascript">          placeholder=<span class="string">"color title..."</span></span></span><br><span class="line">          required</span><br><span class="line">        /&gt;</span><br><span class="line">        &lt;input </span><br><span class="line">          &#123;...colorProps&#125;</span><br><span class="line"><span class="javascript">          type=<span class="string">"color"</span></span></span><br><span class="line">          required</span><br><span class="line">        /&gt;</span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">className</span>=<span class="string">"t-Button t-Button--hot margin-left-sm"</span>&gt;</span>Add<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span></span><br><span class="line">    );</span><br><span class="line">  &#125;;</span><br><span class="line">  </span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> App = <span class="function"><span class="params">()</span> =&gt;</span> &#123;   </span></span><br><span class="line"><span class="javascript">    <span class="keyword">return</span> (</span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">AddColorForm</span> /&gt;</span>  </span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">ColorList</span> /&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;/&gt;</span></span></span><br><span class="line">    );  </span><br><span class="line">  &#125;;</span><br><span class="line">  </span><br><span class="line">  render(</span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">ColorProvider</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">App</span> /&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">ColorProvider</span>&gt;</span>,</span></span><br><span class="line"><span class="javascript">    <span class="built_in">document</span>.getElementById(<span class="string">"react-container"</span>)</span></span><br><span class="line">  ); </span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>Hook 是 React 16.8 中增加的新功能，它解決了 React 中我們過去在編寫與維護數萬個 component 組件時所遇到的各種看似不相關的問題。</p>
<p>Hook 可以讓你從 component 組件抽取 stateful 的邏輯，讓你不需要改變 component 階層就能重用 stateful 的邏輯，如此一來它就可以獨立地被測試和重複使用。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://1184yang.github.io/2020/09/26/React-State-in-Component-Trees/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/1184yang.jpg">
      <meta itemprop="name" content="J.Y. Yang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/09/26/React-State-in-Component-Trees/" class="post-title-link" itemprop="url">React State in Component Trees</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2020-09-26 09:46:37" itemprop="dateCreated datePublished" datetime="2020-09-26T09:46:37+08:00">2020-09-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2020-10-10 13:48:16" itemprop="dateModified" datetime="2020-10-10T13:48:16+08:00">2020-10-10</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/JavaScript/" itemprop="url" rel="index"><span itemprop="name">JavaScript</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/React/" itemprop="url" rel="index"><span itemprop="name">React</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="組件樹中的狀態"><a href="#組件樹中的狀態" class="headerlink" title="組件樹中的狀態"></a>組件樹中的狀態</h3><p>在每個組件中使用狀態不是一個好主意。 將狀態數據分佈在過多的組件中，將使追蹤錯誤和在應用程序中進行更改變得更加困難。發生這種情況，是因為很難追踪狀態值在組件樹中的位置。如果您統一從單一的位置進行狀態管理，將更容易理解應用程序的狀態。</p>
<p>在 React 有多種方法可達到此目的，這裡將分析的第一個方法是將狀態存儲在組件樹的根組件中，然後通過屬性(props)將其傳遞給子組件。</p>
<p>我們要構建一個 “顏色管理器”，用於保存顏色列表的小型應用程序，它將允許用戶管理顏色列表、自定義標題並使用先前建立的 StarRating 組件評定顏色等級。</p>
<p>首先，樣本數據如下所示。可以將它放在 APEX Page Properties 的 JavaScript &gt; Function and Global Variable Declaration 中。</p>
<figure class="highlight js"><figcaption><span>Demo module</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> Demo = <span class="function">(<span class="params">(Demo</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> uuid = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> s4 = <span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">Math</span>.floor((<span class="number">1</span> + <span class="built_in">Math</span>.random()) * <span class="number">0x10000</span>).toString(<span class="number">16</span>).substring(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> s4() + s4() + <span class="string">'-'</span> + s4() + <span class="string">'-'</span> + s4() + <span class="string">'-'</span> + s4() + <span class="string">'-'</span> + s4() + s4() + s4()    </span><br><span class="line">  &#125;;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> colorData = [</span><br><span class="line">    &#123;</span><br><span class="line">      id: uuid(),</span><br><span class="line">      title: <span class="string">"ocean at dust"</span>,</span><br><span class="line">      color: <span class="string">"#00c4e2"</span>,</span><br><span class="line">      rating: <span class="number">5</span></span><br><span class="line">    &#125;,  </span><br><span class="line">    &#123;</span><br><span class="line">      id: uuid(),</span><br><span class="line">      title: <span class="string">"lawn"</span>,</span><br><span class="line">      color: <span class="string">"#26ac56"</span>,</span><br><span class="line">      rating: <span class="number">3</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      id: uuid(),</span><br><span class="line">      title: <span class="string">"bright red"</span>,</span><br><span class="line">      color: <span class="string">"#ff0000"</span>,</span><br><span class="line">      rating: <span class="number">0</span></span><br><span class="line">    &#125;,</span><br><span class="line">  ];</span><br><span class="line">    </span><br><span class="line">  <span class="keyword">return</span> &#123; uuid, colorData, ...Demo &#125;;  </span><br><span class="line">&#125;)(Demo || &#123;&#125;);</span><br></pre></td></tr></table></figure>

<p>我們將創建一個由 React 組件組成的 UI，來顯示這些數據。也將允許用戶添加新顏色以及對顏色進行等級評定和刪除顏色。</p>
<h4 id="由根組件向下發送狀態"><a href="#由根組件向下發送狀態" class="headerlink" title="由根組件向下發送狀態"></a>由根組件向下發送狀態</h4><p>我們將狀態存儲在 App 根組件中，並將顏色向下傳遞給子組件以處理渲染。App 組件將是我們應用程序中唯一擁有狀態的組件。我們將使用 useState 掛鉤將顏色列表添加到 App 中：</p>
<figure class="highlight js"><figcaption><span>Color Organizer</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">&lt;div id=<span class="string">"react-container"</span>&gt;&lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">&lt;script type="text/</span>babel<span class="string">"&gt;</span></span><br><span class="line"><span class="string">  const &#123; useState &#125; = React;</span></span><br><span class="line"><span class="string">  const &#123; render &#125; = ReactDOM;</span></span><br><span class="line"><span class="string">  const &#123; colorData &#125; = Demo;</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">  const Color = (&#123; id, title, color, rating &#125;) =&gt; &#123;</span></span><br><span class="line"><span class="string">    return (</span></span><br><span class="line"><span class="string">      &lt;section&gt;</span></span><br><span class="line"><span class="string">        &lt;h1&gt;&#123;title&#125;&lt;/h1&gt;</span></span><br><span class="line"><span class="string">        &lt;div style=&#123;&#123; height: 50, backgroundColor: color &#125;&#125; /&gt;</span></span><br><span class="line"><span class="string">      &lt;/section&gt;</span></span><br><span class="line"><span class="string">    );</span></span><br><span class="line"><span class="string">  &#125;;</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">  const ColorList = (&#123; colors = [] &#125;) =&gt; &#123;</span></span><br><span class="line"><span class="string">    if(!colors.length) return &lt;div&gt;No Colors Listed.&lt;/div&gt;;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    return (</span></span><br><span class="line"><span class="string">      &lt;div&gt;</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">           colors.map(color =&gt; &lt;Color key=&#123;color.id&#125; &#123;...color&#125; /&gt;)</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">      &lt;/div&gt;</span></span><br><span class="line"><span class="string">    );</span></span><br><span class="line"><span class="string">  &#125;;</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">  const App = () =&gt; &#123;</span></span><br><span class="line"><span class="string">    const [colors] = useState(colorData);</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    return &lt;ColorList colors=&#123;colors&#125; /&gt;</span></span><br><span class="line"><span class="string">  &#125;;</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">  render(&lt;App /&gt;, document.getElementById("</span>react-container<span class="string">")); </span></span><br><span class="line"><span class="string">&lt;/script&gt;</span></span><br></pre></td></tr></table></figure>

<p>App 組件位於樹的根部，第 30 行在該組件添加 useState 使其與 colors 的狀態管理掛鉤。在第 32 行並將顏色數據通過屬性傳遞給 ColorList 組件。並依序在第 23 行將每種顏色的詳細信息傳遞到樹的更遠端 Color 組件。</p>
<p>我們允許對顏色進行等級評定，所以要將先前建立的 StarRating 組件加到 Color 組件，這將允許每個 Color 組件擁有自己的 StarRating 子組件。並將顏色數據中的 rating 沿著樹向下傳遞到 StarRating 的子組件，以顯示評定的星星個數。</p>
<figure class="highlight js"><figcaption><span>Color</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Color = <span class="function">(<span class="params">&#123; id, title, color, rating &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;section&gt;</span><br><span class="line">      &lt;h1&gt;&#123;title&#125;&lt;<span class="regexp">/h1&gt;</span></span><br><span class="line"><span class="regexp">      &lt;div style=&#123;&#123; height: 50, backgroundColor: color&#125;&#125; /</span>&gt;</span><br><span class="line">      &lt;StarRating selectedStars=&#123;rating&#125; /&gt;</span><br><span class="line">    &lt;<span class="regexp">/section&gt;</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp">&#125;;</span></span><br></pre></td></tr></table></figure>

<p>先前的 StarRating 組件將選擇的星星個數 selectedStars 儲存在自己組件的狀態中，我們必須修改 StarRating 組件將其變成純組件(pure component)。純組件是不包含狀態(state)的函式組件(function component)。</p>
<p>我們將此組件設為純組件，因為顏色評級的數據 rating 將存儲在組件樹 App 根組件的 colors 數據中，而不再儲存在自己組件的狀態中。</p>
<p>以下是修改前原先的 StarRating 組件，是一個包含狀態的組件。</p>
<figure class="highlight js"><figcaption><span>StarRating</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> StarRating = <span class="function">(<span class="params">&#123; totalStars = <span class="number">5</span> &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> [selectedStars, setSelectedStars] = useState(<span class="number">0</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;&gt;</span><br><span class="line">      &#123;createArray(totalStars).map(<span class="function">(<span class="params">n, i</span>) =&gt;</span> (</span><br><span class="line">        &lt;Star</span><br><span class="line">          key=&#123;i&#125; </span><br><span class="line">          selected=&#123;selectedStars &gt; i&#125;</span><br><span class="line">          onSelect=&#123;() =&gt; setSelectedStars(i + <span class="number">1</span>)&#125;</span><br><span class="line">        /&gt;</span><br><span class="line">      ))&#125;</span><br><span class="line">      &lt;p style=&#123;&#123;<span class="attr">fontSize</span>: <span class="string">"1.5em"</span>, <span class="attr">margin</span>: <span class="string">"10px"</span>&#125;&#125;&gt;&#123;selectedStars&#125; <span class="keyword">of</span> &#123;totalStars&#125; stars&lt;<span class="regexp">/p&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>我們將拿掉第 2 行使用 useState 狀態管理的 selectedStars 變數、setSelectedStars 函式，與第 10 行 setSelectedStars 的調用。</p>
<figure class="highlight js"><figcaption><span>StarRating</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> StarRating = <span class="function">(<span class="params">&#123; totalStars = <span class="number">5</span>, selectedStars = <span class="number">0</span> &#125;</span>) =&gt;</span> &#123;    </span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;&gt;</span><br><span class="line">      &#123;createArray(totalStars).map(<span class="function">(<span class="params">n, i</span>) =&gt;</span> (</span><br><span class="line">        &lt;Star</span><br><span class="line">          key=&#123;i&#125; </span><br><span class="line">          selected=&#123;selectedStars &gt; i&#125;</span><br><span class="line">        /&gt;</span><br><span class="line">      ))&#125;</span><br><span class="line">      &lt;p style=&#123;&#123;<span class="attr">fontSize</span>: <span class="string">"1.5em"</span>, <span class="attr">margin</span>: <span class="string">"10px"</span>&#125;&#125;&gt;&#123;selectedStars&#125; <span class="keyword">of</span> &#123;totalStars&#125; stars&lt;<span class="regexp">/p&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>現在在第 1 行 selectedStars 直接由父組件 Color 通過屬性傳入，這將會是顏色數據中的 rating。 這裡也暫時拿掉 onSelect 屬性，稍後再來處理。</p>
<p>現在應用程序執行後看起來會像是:</p>
<img src="/2020/09/26/React-State-in-Component-Trees/20201005-01.png" title="Color Oraginer">

<p>至此，我們已經完成了將狀態從 App 組件一直向下傳遞到 FaStar 組件的過程。</p>
<h4 id="將互動由葉端向上傳送到根組件"><a href="#將互動由葉端向上傳送到根組件" class="headerlink" title="將互動由葉端向上傳送到根組件"></a>將互動由葉端向上傳送到根組件</h4><p>到目前為止，我們透過 props 屬性將數據從父組件向下傳遞到子組件。現在，如果我們要從列表中刪除顏色或更改列表中的顏色評等等級，會發生什麼？</p>
<p>顏色數據以狀態存儲在樹的根組件 APP，但我們需要從子組件中收集使用者的互動，並將其沿著樹狀結構發送回根組件，以便在根組件中更改狀態。</p>
<h5 id="Remove-Color"><a href="#Remove-Color" class="headerlink" title="Remove Color"></a>Remove Color</h5><p>例如，假設我們要在每種顏色的標題下端添加一個刪除按鈕，以允許用戶從狀態中刪除顏色。我們將該按鈕添加到 Color 組件中：</p>
<figure class="highlight js"><figcaption><span>Color component</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> FaRemove = <span class="function"><span class="params">()</span> =&gt;</span>  <span class="xml"><span class="tag">&lt;<span class="name">span</span> <span class="attr">className</span>=<span class="string">"fa fa-remove"</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Color = <span class="function">(<span class="params">&#123; id, title, color, rating, onRemove = f =&gt; f &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;section&gt;</span><br><span class="line">      &lt;h1&gt;&#123;title&#125;&lt;<span class="regexp">/h1&gt;</span></span><br><span class="line"><span class="regexp">      &lt;button className="t-Button" onClick=&#123;() =&gt; onRemove(id)&#125; &gt;</span></span><br><span class="line"><span class="regexp">        &lt;FaRemove /</span>&gt;</span><br><span class="line">      &lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">      &lt;div style=&#123;&#123; height: 50, backgroundColor: color&#125;&#125; /</span>&gt;</span><br><span class="line">      &lt;StarRating selectedStars=&#123;rating&#125; /&gt;</span><br><span class="line">    &lt;<span class="regexp">/section&gt;</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp">&#125;;</span></span><br></pre></td></tr></table></figure>

<p>第 1 行使用 APEX icons fa-remove 新增一個 FaRemove 圖標組件。 接下來 7 ~ 9 行將 FaRemove 圖標包裝在一個按鈕中，並在此按鈕上添加 onClick 處理程序，這使我們可以調用 onRemove 函式。 當用戶單擊 “刪除” 按鈕時，通過第 3 行的 onRemove 函式屬性將事件往上傳送到根組件(CPS 延續傳遞風格)，最終我們將在 App 根組件調用一個 onRemoveColor 函式將其想要刪除的顏色刪除。</p>
<p>這裡我們使 Color 組件保持純淨。它沒有狀態，可以很容易地在別的地方重複使用。Color 組件與用戶單擊 “刪除” 按鈕時發生甚麼事無關，它關心的只是通知父組件該事件已發生，並傳遞有關用戶希望刪除的顏色的資料，這裡傳遞的是顏色的 id。</p>
<p>現在，父組件有責任處理此事件：</p>
<figure class="highlight js"><figcaption><span>ColorList</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ColorList = <span class="function">(<span class="params">&#123; colors = [], onRemoveColor = f =&gt; f &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span>(!colors.length) <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>No Colors Listed.<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &#123;</span><br><span class="line">         colors.map(<span class="function"><span class="params">color</span> =&gt;</span> <span class="xml"><span class="tag">&lt;<span class="name">Color</span> <span class="attr">key</span>=<span class="string">&#123;color.id&#125;</span> &#123;<span class="attr">...color</span>&#125;  <span class="attr">onRemove</span>=<span class="string">&#123;onRemoveColor&#125;</span> /&gt;</span></span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp">&#125;;</span></span><br></pre></td></tr></table></figure>

<p>Color 組件的父級是 ColorList，該組件也無權訪問狀態。它只是將事件繼續傳遞給其父組件。它通過添加 onRemoveColor 函式屬性來實現此目的。如果 Color 組件調用 onRemove 屬性，則 ColorList 將延續調用其 onRemoveColor 屬性，並將刪除顏色的責任發送給其父組件 App。 </p>
<p>ColorList 的父級是 App。 該組件是最終與狀態掛勾的組件，在這裡我們可以刪除狀態下的顏色。</p>
<figure class="highlight js"><figcaption><span>App</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> App = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> [colors, setColors] = useState(colorData);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> ( </span><br><span class="line">    &lt;ColorList </span><br><span class="line">      colors=&#123;colors&#125;</span><br><span class="line">      onRemoveColor=&#123;id =&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> newColors = colors.filter(<span class="function"><span class="params">color</span> =&gt;</span> color.id !== id);</span><br><span class="line">        setColors(newColors);</span><br><span class="line">      &#125;&#125;</span><br><span class="line">    /&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>首先，我們在第 2 行添加一個 setColors 變數。請記住，useState 返回的陣列中的第二個參數是一個可以用來修改狀態的函式。當 ColorList 引發一個 onRemoveColor 事件時，我們使用參數中所要刪除的顏色的 id 來過濾，以排除使用者想要刪除的顏色。接下來，我們使用 setColors 函式更改狀態，將 colors 更改為新過濾的陣列。</p>
<p>更改 colors 陣列的狀態會使 App 組件重新呈現新的 colors。這些新的 colors 也將透過屬性傳遞到所有相關的子組件，進而引發整個樹狀結構的重新渲染。</p>
<h5 id="Color-Rating"><a href="#Color-Rating" class="headerlink" title="Color Rating"></a>Color Rating</h5><p>如果要對存儲在 App 組件狀態中的顏色進行評分，則必須使用 onRate 事件重複上述刪除顏色的過程。</p>
<p>首先，我們將從被點擊的 FaStar 組件中觸發新的評分事件，並將事件往上傳送 Star 父組件，再經過 StarRating 組件，依序直到 App 根組件以修改顏色的評分 rating。</p>
<p>FaStar 與 Star 組件都是無狀態組件，可以被重複使用，無須變動。我們只需從 StarRating 組件開始新增 onRate 函式屬性。</p>
<figure class="highlight js"><figcaption><span>onRate:StarRating</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> StarRating = <span class="function">(<span class="params">&#123; totalStars = <span class="number">5</span>, selectedStars = <span class="number">0</span>, onRate = f =&gt; f &#125;</span>) =&gt;</span> &#123;    </span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;&gt;</span><br><span class="line">      &#123;createArray(totalStars).map(<span class="function">(<span class="params">n, i</span>) =&gt;</span> (</span><br><span class="line">        &lt;Star</span><br><span class="line">          key=&#123;i&#125; </span><br><span class="line">          selected=&#123;selectedStars &gt; i&#125;</span><br><span class="line">          onSelect=&#123;() =&gt; onRate(i + <span class="number">1</span>)&#125;</span><br><span class="line">        /&gt;</span><br><span class="line">      ))&#125;</span><br><span class="line">      &lt;p style=&#123;&#123;<span class="attr">fontSize</span>: <span class="string">"1.5em"</span>, <span class="attr">margin</span>: <span class="string">"10px"</span>&#125;&#125;&gt;&#123;selectedStars&#125; <span class="keyword">of</span> &#123;totalStars&#125; stars&lt;<span class="regexp">/p&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>第 8 行我們重新將 onSelect 屬性加進 Star 組件，並透過第 1 行的 onRate 函式屬性將事件與 rating 評分等級 (i + 1) 往上傳送給 StarRating 的父組件 Color。</p>
<figure class="highlight js"><figcaption><span>onRate:Color</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Color = <span class="function">(<span class="params">&#123; id, title, color, rating, onRemove = f =&gt; f, onRate = f =&gt; f &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;section&gt;</span><br><span class="line">      &lt;h1&gt;&#123;title&#125;&lt;<span class="regexp">/h1&gt;</span></span><br><span class="line"><span class="regexp">      &lt;button className="t-Button" onClick=&#123;() =&gt; onRemove(id)&#125; &gt;</span></span><br><span class="line"><span class="regexp">        &lt;FaRemove /</span>&gt;</span><br><span class="line">      &lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">      &lt;div style=&#123;&#123; height: 50, backgroundColor: color&#125;&#125; /</span>&gt;</span><br><span class="line">      &lt;StarRating </span><br><span class="line">        selectedStars=&#123;rating&#125;</span><br><span class="line">        onRate=&#123;rating =&gt; onRate(id, rating)&#125;</span><br><span class="line">      /&gt;</span><br><span class="line">    &lt;<span class="regexp">/section&gt;</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp">&#125;;</span></span><br></pre></td></tr></table></figure>

<p>在 Color 組件第 11 行將新的評級 rating 以及將要評級的顏色 id 通過第 1 行的 onRate 函式屬性傳遞給 Color 組件的父項 ColorList 組件。</p>
<p>在 ColorList 組件中，我們必須從各個顏色 Color 組件中捕獲 onRate 事件，然後通過第 1 行的 onRateColor 函式屬性將它們傳遞給其父級 App 組件：</p>
<figure class="highlight js"><figcaption><span>onRate:ColorList</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ColorList = <span class="function">(<span class="params">&#123; colors = [], onRemoveColor = f =&gt; f, onRateColor = f =&gt; f &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span>(!colors.length) <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>No Colors Listed.<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &#123;</span><br><span class="line">         colors.map(<span class="function"><span class="params">color</span> =&gt;</span> (</span><br><span class="line">           &lt;Color </span><br><span class="line">             key=&#123;color.id&#125; </span><br><span class="line">             &#123;...color&#125;  </span><br><span class="line">             onRemove=&#123;onRemoveColor&#125;</span><br><span class="line">             onRate=&#123;onRateColor&#125;</span><br><span class="line">           /&gt;</span><br><span class="line">         ))</span><br><span class="line">      &#125;</span><br><span class="line">    &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp">&#125;;</span></span><br></pre></td></tr></table></figure>

<p>最後，在將事件依序經過些組件往上傳遞之後，我們將到達應用程序存儲狀態的根組件 App，可以更改 colors 數據保存新的評分。</p>
<figure class="highlight js"><figcaption><span>onRate:App</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> App = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> [colors, setColors] = useState(colorData);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> ( </span><br><span class="line">    &lt;ColorList </span><br><span class="line">      colors=&#123;colors&#125;</span><br><span class="line">      onRateColor=&#123;(id, rating) =&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> newColors = colors.map(<span class="function"><span class="params">color</span> =&gt;</span> color.id === id ? &#123;...color, rating&#125; : color);</span><br><span class="line">        setColors(newColors);</span><br><span class="line">      &#125;&#125;</span><br><span class="line">      onRemoveColor=&#123;id =&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> newColors = colors.filter(<span class="function"><span class="params">color</span> =&gt;</span> color.id !== id);</span><br><span class="line">        setColors(newColors);</span><br><span class="line">      &#125;&#125;</span><br><span class="line">    /&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>一旦我們的顏色陣列 colors 的狀態發生變化，相關的 UI 組件樹就會使用新數據進行渲染，新的評級將反映給用戶。</p>
<p>就像我們通過 props 屬性將數據往下傳遞到整個組件樹一樣，使用者的互動也可以通過函式屬性與數據一起往上傳遞回樹根。</p>
<h4 id="使用-Forms-新增數據"><a href="#使用-Forms-新增數據" class="headerlink" title="使用 Forms 新增數據"></a>使用 Forms 新增數據</h4><p>成為一名 Web 開發人員總是必須使用表單從使用者那裡收集大量的信息，那麼將會使用 React 構建許多表單組件。DOM 所有可用的 HTML 表單元素也都可以作為 React 元素使用，因此可以用 JSX 呈現表單。</p>
<p>當需要在 React 中構建表單組件時，可以使用幾種模式。 模式之一使用稱為 refs 的 React 功能直接訪問 DOM 節點。在 React 中，ref 是一個物件，它存儲組件生命週期內的值。React 為我們提供了一個 useRef 掛鉤(hook)，我們可以使用它來創建一個 ref 物件。</p>
<p>直接通過將 DOM 節點的 value 屬性設定值，稱為不受控制的組件(uncontrolled component)，因為它使用 DOM 來保存表單值。有時使用不受控制的組件可以使您解決一些麻煩。 例如，您可能想與 React 之外的代碼共享一個表單及其值。 但是，在 React 中使用受控制組件(controlled component)是比較好的方法。</p>
<p>在受控制組件中，表單值由 React 而不是 DOM 管理。它們不需要我們使用 ref 物件，也不需要我們編寫命令性代碼。當使用受控組件時，添加表單驗證之類的功能要容易得多。</p>
<p>這裡，我們不展示不受控制組件，直接使用受控制組件。</p>
<p>受控制組件使用 React 狀態(state)保存表單的值。我們將用 useState 掛鉤建立兩個變數 title 與 color。此外，我們將也將定義可用於更改狀態的函式：setTitle 和 setColor。</p>
<figure class="highlight js"><figcaption><span>AddColorForm</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> AddColorForm = <span class="function">(<span class="params">&#123; onNewColor = f =&gt; f &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> [title, setTitle] = useState(<span class="string">""</span>);</span><br><span class="line">  <span class="keyword">const</span> [color, setColor] = useState(<span class="string">"#000000"</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> submit = <span class="function"><span class="params">e</span> =&gt;</span> &#123;</span><br><span class="line">    e.preventDefault();</span><br><span class="line">    onNewColor(title, color);</span><br><span class="line">    setTitle(<span class="string">""</span>);</span><br><span class="line">    setColor(<span class="string">"#000000"</span>);</span><br><span class="line">  &#125;;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;form onSubmit=&#123;submit&#125; &gt;</span><br><span class="line">      &lt;input </span><br><span class="line">        value=&#123;title&#125;</span><br><span class="line">        onChange=&#123; event =&gt; setTitle(event.target.value)&#125;</span><br><span class="line">        type=<span class="string">"text"</span></span><br><span class="line">        placeholder=<span class="string">"color title..."</span></span><br><span class="line">        required</span><br><span class="line">      /&gt;</span><br><span class="line">      &lt;input </span><br><span class="line">        value=&#123;color&#125;</span><br><span class="line">        onChange=&#123; event =&gt; setColor(event.target.value)&#125;</span><br><span class="line">        type=<span class="string">"color"</span></span><br><span class="line">        required</span><br><span class="line">      /&gt;</span><br><span class="line">      &lt;button className=<span class="string">"t-Button t-Button--hot margin-left-sm"</span>&gt;Add&lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>form&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>每當這些 input 元素引發 onChange 事件時，我們將調用 setTitle 或 setColor 來更改狀態中的值。更改該值將導致該組件重新渲染，會立即在 input 元素中顯示新的值。</p>
<p>提交表單時，我們只需在第 7 行直接將 title 和 color 的狀態值作為參數傳遞給 onNewColor 函式屬性即可。</p>
<p>知道受控組件會經常重新渲染，你將知道避免向該組件添加一些漫長且昂貴的處理過程。當您嘗試優化 React 組件時，這些知識將會派上用場。</p>
<p>現在將 AddColorForm 加入我們的根組件 App，並定義 onNewColor 函式屬性。記得也將 Demo 模組的 uuid 函式加進來。</p>
<figure class="highlight js"><figcaption><span>AddColorForm:App</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; uuid, colorData &#125; = Demo;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> App = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> [colors, setColors] = useState(colorData);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> ( </span><br><span class="line">    &lt;&gt;</span><br><span class="line">      &lt;AddColorForm </span><br><span class="line">        onNewColor=&#123;(title, color) =&gt; &#123;</span><br><span class="line">          <span class="keyword">const</span> newColors = [</span><br><span class="line">            ...colors,</span><br><span class="line">            &#123;</span><br><span class="line">              id: uuid(),</span><br><span class="line">              rating: <span class="number">0</span>,</span><br><span class="line">              title,</span><br><span class="line">              color</span><br><span class="line">            &#125;</span><br><span class="line">          ];</span><br><span class="line">          setColors(newColors);</span><br><span class="line">        &#125;&#125;</span><br><span class="line">      /&gt;</span><br><span class="line">      &lt;ColorList </span><br><span class="line">        colors=&#123;colors&#125;</span><br><span class="line">        onRateColor=&#123;(id, rating) =&gt; &#123;</span><br><span class="line">          <span class="keyword">const</span> newColors = colors.map(<span class="function"><span class="params">color</span> =&gt;</span> color.id === id ? &#123;...color, rating&#125; : color);</span><br><span class="line">          setColors(newColors);</span><br><span class="line">        &#125;&#125;</span><br><span class="line">        onRemoveColor=&#123;id =&gt; &#123;</span><br><span class="line">          <span class="keyword">const</span> newColors = colors.filter(<span class="function"><span class="params">color</span> =&gt;</span> color.id !== id);</span><br><span class="line">          setColors(newColors);</span><br><span class="line">        &#125;&#125;</span><br><span class="line">      /&gt;</span><br><span class="line">    &lt;<span class="regexp">/&gt;</span></span><br><span class="line"><span class="regexp">  )</span></span><br><span class="line"><span class="regexp">&#125;;</span></span><br></pre></td></tr></table></figure>

<p>AddColorForm 組件通過 onNewColor 函式將 title 和 color 的值傳遞給父組件 App。調用 onNewColor 屬性時，我們會將新顏色保存在狀態中。</p>
<p>將狀態統一存儲在樹狀結構的根的位置是一種重要的模式，這是早期版本 React 的重要模式。通過屬性上下傳遞狀態是任何 React 開發人員必須知道的概念，是我們所有人都應該知道的方法。 但是，隨著 React 的發展以及我們的組件樹越來越大，遵循此原理逐漸變得不切實際。對於復雜的應用程序來說，許多開發人員很難在組件樹根的單個位置維護狀態。通過數十個組件將狀態上下傳遞是繁瑣且容易出錯的。</p>
<p>多數的 UI 元素都很複雜，樹的根通常離葉子很遠，將數據置於離使用數據組件許多層的位置，每個組件都必須收到只能傳遞給子組件的屬性，這將使我們的代碼變的臃腫，並使我們的 UI 難以擴展。</p>
<p>將狀態數據作為屬性傳遞通過每個組件，直到到達需要使用的組件，就像乘火車從台南到台北。在火車上，您會經過每個站，但直到到達目的地，您都不會下車。</p>
<p>搭飛機從台南飛往台北顯然效率較佳。這樣，您不必通過每個中間站，你直接飛越它們。</p>
<p>下次我們將用比較有效率的方式，直接飛越它們: <strong>React Context</strong>。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="上一頁"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="下一頁"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目錄
        </li>
        <li class="sidebar-nav-overview">
          本站概要
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="J.Y. Yang"
      src="/images/1184yang.jpg">
  <p class="site-author-name" itemprop="name">J.Y. Yang</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">62</span>
          <span class="site-state-item-name">文章</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">分類</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/1184yang" title="GitHub → https://github.com/1184yang" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:1184yang@gmail.com" title="E-Mail → mailto:1184yang@gmail.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/1184yang" title="Twitter → https://twitter.com/1184yang" rel="noopener" target="_blank"><i class="fa fa-fw fa-twitter"></i>Twitter</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">J.Y. Yang</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/muse.js"></script>
<script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script>



  




  <script src="/js/local-search.js"></script>












  

  

</body>
</html>
