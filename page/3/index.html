<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.9.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=EB Garamond:300,300italic,400,400italic,700,700italic|Cinzel Decorative:300,300italic,400,400italic,700,700italic|Noto Serif TC:300,300italic,400,400italic,700,700italic|Source Code Pro:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"1184yang.github.io","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12,"onmobile":true},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title">
<meta property="og:url" content="https://1184yang.github.io/page/3/index.html">
<meta property="og:site_name">
<meta property="og:locale" content="zh-TW">
<meta name="twitter:card" content="summary">
<meta name="twitter:title">

<link rel="canonical" href="https://1184yang.github.io/page/3/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-TW'
  };
</script>

  <title></title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切換導航欄">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title"></h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首頁</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>歸檔</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分類</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜尋
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜尋..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

  <a href="https://github.com/1184yang?tab=repositories" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://1184yang.github.io/2020/09/26/React-State-in-Component-Trees/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/1184yang.jpg">
      <meta itemprop="name" content="J.Y. Yang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/09/26/React-State-in-Component-Trees/" class="post-title-link" itemprop="url">React State in Component Trees</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2020-09-26 09:46:37" itemprop="dateCreated datePublished" datetime="2020-09-26T09:46:37+08:00">2020-09-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2020-10-10 13:48:16" itemprop="dateModified" datetime="2020-10-10T13:48:16+08:00">2020-10-10</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/JavaScript/" itemprop="url" rel="index"><span itemprop="name">JavaScript</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/React/" itemprop="url" rel="index"><span itemprop="name">React</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="組件樹中的狀態"><a href="#組件樹中的狀態" class="headerlink" title="組件樹中的狀態"></a>組件樹中的狀態</h3><p>在每個組件中使用狀態不是一個好主意。 將狀態數據分佈在過多的組件中，將使追蹤錯誤和在應用程序中進行更改變得更加困難。發生這種情況，是因為很難追踪狀態值在組件樹中的位置。如果您統一從單一的位置進行狀態管理，將更容易理解應用程序的狀態。</p>
<p>在 React 有多種方法可達到此目的，這裡將分析的第一個方法是將狀態存儲在組件樹的根組件中，然後通過屬性(props)將其傳遞給子組件。</p>
<p>我們要構建一個 “顏色管理器”，用於保存顏色列表的小型應用程序，它將允許用戶管理顏色列表、自定義標題並使用先前建立的 StarRating 組件評定顏色等級。</p>
<p>首先，樣本數據如下所示。可以將它放在 APEX Page Properties 的 JavaScript &gt; Function and Global Variable Declaration 中。</p>
<figure class="highlight js"><figcaption><span>Demo module</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> Demo = <span class="function">(<span class="params">(Demo</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> uuid = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> s4 = <span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">Math</span>.floor((<span class="number">1</span> + <span class="built_in">Math</span>.random()) * <span class="number">0x10000</span>).toString(<span class="number">16</span>).substring(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> s4() + s4() + <span class="string">'-'</span> + s4() + <span class="string">'-'</span> + s4() + <span class="string">'-'</span> + s4() + <span class="string">'-'</span> + s4() + s4() + s4()    </span><br><span class="line">  &#125;;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> colorData = [</span><br><span class="line">    &#123;</span><br><span class="line">      id: uuid(),</span><br><span class="line">      title: <span class="string">"ocean at dust"</span>,</span><br><span class="line">      color: <span class="string">"#00c4e2"</span>,</span><br><span class="line">      rating: <span class="number">5</span></span><br><span class="line">    &#125;,  </span><br><span class="line">    &#123;</span><br><span class="line">      id: uuid(),</span><br><span class="line">      title: <span class="string">"lawn"</span>,</span><br><span class="line">      color: <span class="string">"#26ac56"</span>,</span><br><span class="line">      rating: <span class="number">3</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      id: uuid(),</span><br><span class="line">      title: <span class="string">"bright red"</span>,</span><br><span class="line">      color: <span class="string">"#ff0000"</span>,</span><br><span class="line">      rating: <span class="number">0</span></span><br><span class="line">    &#125;,</span><br><span class="line">  ];</span><br><span class="line">    </span><br><span class="line">  <span class="keyword">return</span> &#123; uuid, colorData, ...Demo &#125;;  </span><br><span class="line">&#125;)(Demo || &#123;&#125;);</span><br></pre></td></tr></table></figure>

<p>我們將創建一個由 React 組件組成的 UI，來顯示這些數據。也將允許用戶添加新顏色以及對顏色進行等級評定和刪除顏色。</p>
<h4 id="由根組件向下發送狀態"><a href="#由根組件向下發送狀態" class="headerlink" title="由根組件向下發送狀態"></a>由根組件向下發送狀態</h4><p>我們將狀態存儲在 App 根組件中，並將顏色向下傳遞給子組件以處理渲染。App 組件將是我們應用程序中唯一擁有狀態的組件。我們將使用 useState 掛鉤將顏色列表添加到 App 中：</p>
<figure class="highlight js"><figcaption><span>Color Organizer</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">&lt;div id=<span class="string">"react-container"</span>&gt;&lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">&lt;script type="text/</span>babel<span class="string">"&gt;</span></span><br><span class="line"><span class="string">  const &#123; useState &#125; = React;</span></span><br><span class="line"><span class="string">  const &#123; render &#125; = ReactDOM;</span></span><br><span class="line"><span class="string">  const &#123; colorData &#125; = Demo;</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">  const Color = (&#123; id, title, color, rating &#125;) =&gt; &#123;</span></span><br><span class="line"><span class="string">    return (</span></span><br><span class="line"><span class="string">      &lt;section&gt;</span></span><br><span class="line"><span class="string">        &lt;h1&gt;&#123;title&#125;&lt;/h1&gt;</span></span><br><span class="line"><span class="string">        &lt;div style=&#123;&#123; height: 50, backgroundColor: color &#125;&#125; /&gt;</span></span><br><span class="line"><span class="string">      &lt;/section&gt;</span></span><br><span class="line"><span class="string">    );</span></span><br><span class="line"><span class="string">  &#125;;</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">  const ColorList = (&#123; colors = [] &#125;) =&gt; &#123;</span></span><br><span class="line"><span class="string">    if(!colors.length) return &lt;div&gt;No Colors Listed.&lt;/div&gt;;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    return (</span></span><br><span class="line"><span class="string">      &lt;div&gt;</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">           colors.map(color =&gt; &lt;Color key=&#123;color.id&#125; &#123;...color&#125; /&gt;)</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">      &lt;/div&gt;</span></span><br><span class="line"><span class="string">    );</span></span><br><span class="line"><span class="string">  &#125;;</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">  const App = () =&gt; &#123;</span></span><br><span class="line"><span class="string">    const [colors] = useState(colorData);</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    return &lt;ColorList colors=&#123;colors&#125; /&gt;</span></span><br><span class="line"><span class="string">  &#125;;</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">  render(&lt;App /&gt;, document.getElementById("</span>react-container<span class="string">")); </span></span><br><span class="line"><span class="string">&lt;/script&gt;</span></span><br></pre></td></tr></table></figure>

<p>App 組件位於樹的根部，第 30 行在該組件添加 useState 使其與 colors 的狀態管理掛鉤。在第 32 行並將顏色數據通過屬性傳遞給 ColorList 組件。並依序在第 23 行將每種顏色的詳細信息傳遞到樹的更遠端 Color 組件。</p>
<p>我們允許對顏色進行等級評定，所以要將先前建立的 StarRating 組件加到 Color 組件，這將允許每個 Color 組件擁有自己的 StarRating 子組件。並將顏色數據中的 rating 沿著樹向下傳遞到 StarRating 的子組件，以顯示評定的星星個數。</p>
<figure class="highlight js"><figcaption><span>Color</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Color = <span class="function">(<span class="params">&#123; id, title, color, rating &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;section&gt;</span><br><span class="line">      &lt;h1&gt;&#123;title&#125;&lt;<span class="regexp">/h1&gt;</span></span><br><span class="line"><span class="regexp">      &lt;div style=&#123;&#123; height: 50, backgroundColor: color&#125;&#125; /</span>&gt;</span><br><span class="line">      &lt;StarRating selectedStars=&#123;rating&#125; /&gt;</span><br><span class="line">    &lt;<span class="regexp">/section&gt;</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp">&#125;;</span></span><br></pre></td></tr></table></figure>

<p>先前的 StarRating 組件將選擇的星星個數 selectedStars 儲存在自己組件的狀態中，我們必須修改 StarRating 組件將其變成純組件(pure component)。純組件是不包含狀態(state)的函式組件(function component)。</p>
<p>我們將此組件設為純組件，因為顏色評級的數據 rating 將存儲在組件樹 App 根組件的 colors 數據中，而不再儲存在自己組件的狀態中。</p>
<p>以下是修改前原先的 StarRating 組件，是一個包含狀態的組件。</p>
<figure class="highlight js"><figcaption><span>StarRating</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> StarRating = <span class="function">(<span class="params">&#123; totalStars = <span class="number">5</span> &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> [selectedStars, setSelectedStars] = useState(<span class="number">0</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;&gt;</span><br><span class="line">      &#123;createArray(totalStars).map(<span class="function">(<span class="params">n, i</span>) =&gt;</span> (</span><br><span class="line">        &lt;Star</span><br><span class="line">          key=&#123;i&#125; </span><br><span class="line">          selected=&#123;selectedStars &gt; i&#125;</span><br><span class="line">          onSelect=&#123;() =&gt; setSelectedStars(i + <span class="number">1</span>)&#125;</span><br><span class="line">        /&gt;</span><br><span class="line">      ))&#125;</span><br><span class="line">      &lt;p style=&#123;&#123;<span class="attr">fontSize</span>: <span class="string">"1.5em"</span>, <span class="attr">margin</span>: <span class="string">"10px"</span>&#125;&#125;&gt;&#123;selectedStars&#125; <span class="keyword">of</span> &#123;totalStars&#125; stars&lt;<span class="regexp">/p&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>我們將拿掉第 2 行使用 useState 狀態管理的 selectedStars 變數、setSelectedStars 函式，與第 10 行 setSelectedStars 的調用。</p>
<figure class="highlight js"><figcaption><span>StarRating</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> StarRating = <span class="function">(<span class="params">&#123; totalStars = <span class="number">5</span>, selectedStars = <span class="number">0</span> &#125;</span>) =&gt;</span> &#123;    </span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;&gt;</span><br><span class="line">      &#123;createArray(totalStars).map(<span class="function">(<span class="params">n, i</span>) =&gt;</span> (</span><br><span class="line">        &lt;Star</span><br><span class="line">          key=&#123;i&#125; </span><br><span class="line">          selected=&#123;selectedStars &gt; i&#125;</span><br><span class="line">        /&gt;</span><br><span class="line">      ))&#125;</span><br><span class="line">      &lt;p style=&#123;&#123;<span class="attr">fontSize</span>: <span class="string">"1.5em"</span>, <span class="attr">margin</span>: <span class="string">"10px"</span>&#125;&#125;&gt;&#123;selectedStars&#125; <span class="keyword">of</span> &#123;totalStars&#125; stars&lt;<span class="regexp">/p&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>現在在第 1 行 selectedStars 直接由父組件 Color 通過屬性傳入，這將會是顏色數據中的 rating。 這裡也暫時拿掉 onSelect 屬性，稍後再來處理。</p>
<p>現在應用程序執行後看起來會像是:</p>
<img src="/2020/09/26/React-State-in-Component-Trees/20201005-01.png" title="Color Oraginer">

<p>至此，我們已經完成了將狀態從 App 組件一直向下傳遞到 FaStar 組件的過程。</p>
<h4 id="將互動由葉端向上傳送到根組件"><a href="#將互動由葉端向上傳送到根組件" class="headerlink" title="將互動由葉端向上傳送到根組件"></a>將互動由葉端向上傳送到根組件</h4><p>到目前為止，我們透過 props 屬性將數據從父組件向下傳遞到子組件。現在，如果我們要從列表中刪除顏色或更改列表中的顏色評等等級，會發生什麼？</p>
<p>顏色數據以狀態存儲在樹的根組件 APP，但我們需要從子組件中收集使用者的互動，並將其沿著樹狀結構發送回根組件，以便在根組件中更改狀態。</p>
<h5 id="Remove-Color"><a href="#Remove-Color" class="headerlink" title="Remove Color"></a>Remove Color</h5><p>例如，假設我們要在每種顏色的標題下端添加一個刪除按鈕，以允許用戶從狀態中刪除顏色。我們將該按鈕添加到 Color 組件中：</p>
<figure class="highlight js"><figcaption><span>Color component</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> FaRemove = <span class="function"><span class="params">()</span> =&gt;</span>  <span class="xml"><span class="tag">&lt;<span class="name">span</span> <span class="attr">className</span>=<span class="string">"fa fa-remove"</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Color = <span class="function">(<span class="params">&#123; id, title, color, rating, onRemove = f =&gt; f &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;section&gt;</span><br><span class="line">      &lt;h1&gt;&#123;title&#125;&lt;<span class="regexp">/h1&gt;</span></span><br><span class="line"><span class="regexp">      &lt;button className="t-Button" onClick=&#123;() =&gt; onRemove(id)&#125; &gt;</span></span><br><span class="line"><span class="regexp">        &lt;FaRemove /</span>&gt;</span><br><span class="line">      &lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">      &lt;div style=&#123;&#123; height: 50, backgroundColor: color&#125;&#125; /</span>&gt;</span><br><span class="line">      &lt;StarRating selectedStars=&#123;rating&#125; /&gt;</span><br><span class="line">    &lt;<span class="regexp">/section&gt;</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp">&#125;;</span></span><br></pre></td></tr></table></figure>

<p>第 1 行使用 APEX icons fa-remove 新增一個 FaRemove 圖標組件。 接下來 7 ~ 9 行將 FaRemove 圖標包裝在一個按鈕中，並在此按鈕上添加 onClick 處理程序，這使我們可以調用 onRemove 函式。 當用戶單擊 “刪除” 按鈕時，通過第 3 行的 onRemove 函式屬性將事件往上傳送到根組件(CPS 延續傳遞風格)，最終我們將在 App 根組件調用一個 onRemoveColor 函式將其想要刪除的顏色刪除。</p>
<p>這裡我們使 Color 組件保持純淨。它沒有狀態，可以很容易地在別的地方重複使用。Color 組件與用戶單擊 “刪除” 按鈕時發生甚麼事無關，它關心的只是通知父組件該事件已發生，並傳遞有關用戶希望刪除的顏色的資料，這裡傳遞的是顏色的 id。</p>
<p>現在，父組件有責任處理此事件：</p>
<figure class="highlight js"><figcaption><span>ColorList</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ColorList = <span class="function">(<span class="params">&#123; colors = [], onRemoveColor = f =&gt; f &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span>(!colors.length) <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>No Colors Listed.<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &#123;</span><br><span class="line">         colors.map(<span class="function"><span class="params">color</span> =&gt;</span> <span class="xml"><span class="tag">&lt;<span class="name">Color</span> <span class="attr">key</span>=<span class="string">&#123;color.id&#125;</span> &#123;<span class="attr">...color</span>&#125;  <span class="attr">onRemove</span>=<span class="string">&#123;onRemoveColor&#125;</span> /&gt;</span></span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp">&#125;;</span></span><br></pre></td></tr></table></figure>

<p>Color 組件的父級是 ColorList，該組件也無權訪問狀態。它只是將事件繼續傳遞給其父組件。它通過添加 onRemoveColor 函式屬性來實現此目的。如果 Color 組件調用 onRemove 屬性，則 ColorList 將延續調用其 onRemoveColor 屬性，並將刪除顏色的責任發送給其父組件 App。 </p>
<p>ColorList 的父級是 App。 該組件是最終與狀態掛勾的組件，在這裡我們可以刪除狀態下的顏色。</p>
<figure class="highlight js"><figcaption><span>App</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> App = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> [colors, setColors] = useState(colorData);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> ( </span><br><span class="line">    &lt;ColorList </span><br><span class="line">      colors=&#123;colors&#125;</span><br><span class="line">      onRemoveColor=&#123;id =&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> newColors = colors.filter(<span class="function"><span class="params">color</span> =&gt;</span> color.id !== id);</span><br><span class="line">        setColors(newColors);</span><br><span class="line">      &#125;&#125;</span><br><span class="line">    /&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>首先，我們在第 2 行添加一個 setColors 變數。請記住，useState 返回的陣列中的第二個參數是一個可以用來修改狀態的函式。當 ColorList 引發一個 onRemoveColor 事件時，我們使用參數中所要刪除的顏色的 id 來過濾，以排除使用者想要刪除的顏色。接下來，我們使用 setColors 函式更改狀態，將 colors 更改為新過濾的陣列。</p>
<p>更改 colors 陣列的狀態會使 App 組件重新呈現新的 colors。這些新的 colors 也將透過屬性傳遞到所有相關的子組件，進而引發整個樹狀結構的重新渲染。</p>
<h5 id="Color-Rating"><a href="#Color-Rating" class="headerlink" title="Color Rating"></a>Color Rating</h5><p>如果要對存儲在 App 組件狀態中的顏色進行評分，則必須使用 onRate 事件重複上述刪除顏色的過程。</p>
<p>首先，我們將從被點擊的 FaStar 組件中觸發新的評分事件，並將事件往上傳送 Star 父組件，再經過 StarRating 組件，依序直到 App 根組件以修改顏色的評分 rating。</p>
<p>FaStar 與 Star 組件都是無狀態組件，可以被重複使用，無須變動。我們只需從 StarRating 組件開始新增 onRate 函式屬性。</p>
<figure class="highlight js"><figcaption><span>onRate:StarRating</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> StarRating = <span class="function">(<span class="params">&#123; totalStars = <span class="number">5</span>, selectedStars = <span class="number">0</span>, onRate = f =&gt; f &#125;</span>) =&gt;</span> &#123;    </span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;&gt;</span><br><span class="line">      &#123;createArray(totalStars).map(<span class="function">(<span class="params">n, i</span>) =&gt;</span> (</span><br><span class="line">        &lt;Star</span><br><span class="line">          key=&#123;i&#125; </span><br><span class="line">          selected=&#123;selectedStars &gt; i&#125;</span><br><span class="line">          onSelect=&#123;() =&gt; onRate(i + <span class="number">1</span>)&#125;</span><br><span class="line">        /&gt;</span><br><span class="line">      ))&#125;</span><br><span class="line">      &lt;p style=&#123;&#123;<span class="attr">fontSize</span>: <span class="string">"1.5em"</span>, <span class="attr">margin</span>: <span class="string">"10px"</span>&#125;&#125;&gt;&#123;selectedStars&#125; <span class="keyword">of</span> &#123;totalStars&#125; stars&lt;<span class="regexp">/p&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>第 8 行我們重新將 onSelect 屬性加進 Star 組件，並透過第 1 行的 onRate 函式屬性將事件與 rating 評分等級 (i + 1) 往上傳送給 StarRating 的父組件 Color。</p>
<figure class="highlight js"><figcaption><span>onRate:Color</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Color = <span class="function">(<span class="params">&#123; id, title, color, rating, onRemove = f =&gt; f, onRate = f =&gt; f &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;section&gt;</span><br><span class="line">      &lt;h1&gt;&#123;title&#125;&lt;<span class="regexp">/h1&gt;</span></span><br><span class="line"><span class="regexp">      &lt;button className="t-Button" onClick=&#123;() =&gt; onRemove(id)&#125; &gt;</span></span><br><span class="line"><span class="regexp">        &lt;FaRemove /</span>&gt;</span><br><span class="line">      &lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">      &lt;div style=&#123;&#123; height: 50, backgroundColor: color&#125;&#125; /</span>&gt;</span><br><span class="line">      &lt;StarRating </span><br><span class="line">        selectedStars=&#123;rating&#125;</span><br><span class="line">        onRate=&#123;rating =&gt; onRate(id, rating)&#125;</span><br><span class="line">      /&gt;</span><br><span class="line">    &lt;<span class="regexp">/section&gt;</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp">&#125;;</span></span><br></pre></td></tr></table></figure>

<p>在 Color 組件第 11 行將新的評級 rating 以及將要評級的顏色 id 通過第 1 行的 onRate 函式屬性傳遞給 Color 組件的父項 ColorList 組件。</p>
<p>在 ColorList 組件中，我們必須從各個顏色 Color 組件中捕獲 onRate 事件，然後通過第 1 行的 onRateColor 函式屬性將它們傳遞給其父級 App 組件：</p>
<figure class="highlight js"><figcaption><span>onRate:ColorList</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ColorList = <span class="function">(<span class="params">&#123; colors = [], onRemoveColor = f =&gt; f, onRateColor = f =&gt; f &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span>(!colors.length) <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>No Colors Listed.<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &#123;</span><br><span class="line">         colors.map(<span class="function"><span class="params">color</span> =&gt;</span> (</span><br><span class="line">           &lt;Color </span><br><span class="line">             key=&#123;color.id&#125; </span><br><span class="line">             &#123;...color&#125;  </span><br><span class="line">             onRemove=&#123;onRemoveColor&#125;</span><br><span class="line">             onRate=&#123;onRateColor&#125;</span><br><span class="line">           /&gt;</span><br><span class="line">         ))</span><br><span class="line">      &#125;</span><br><span class="line">    &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp">&#125;;</span></span><br></pre></td></tr></table></figure>

<p>最後，在將事件依序經過些組件往上傳遞之後，我們將到達應用程序存儲狀態的根組件 App，可以更改 colors 數據保存新的評分。</p>
<figure class="highlight js"><figcaption><span>onRate:App</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> App = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> [colors, setColors] = useState(colorData);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> ( </span><br><span class="line">    &lt;ColorList </span><br><span class="line">      colors=&#123;colors&#125;</span><br><span class="line">      onRateColor=&#123;(id, rating) =&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> newColors = colors.map(<span class="function"><span class="params">color</span> =&gt;</span> color.id === id ? &#123;...color, rating&#125; : color);</span><br><span class="line">        setColors(newColors);</span><br><span class="line">      &#125;&#125;</span><br><span class="line">      onRemoveColor=&#123;id =&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> newColors = colors.filter(<span class="function"><span class="params">color</span> =&gt;</span> color.id !== id);</span><br><span class="line">        setColors(newColors);</span><br><span class="line">      &#125;&#125;</span><br><span class="line">    /&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>一旦我們的顏色陣列 colors 的狀態發生變化，相關的 UI 組件樹就會使用新數據進行渲染，新的評級將反映給用戶。</p>
<p>就像我們通過 props 屬性將數據往下傳遞到整個組件樹一樣，使用者的互動也可以通過函式屬性與數據一起往上傳遞回樹根。</p>
<h4 id="使用-Forms-新增數據"><a href="#使用-Forms-新增數據" class="headerlink" title="使用 Forms 新增數據"></a>使用 Forms 新增數據</h4><p>成為一名 Web 開發人員總是必須使用表單從使用者那裡收集大量的信息，那麼將會使用 React 構建許多表單組件。DOM 所有可用的 HTML 表單元素也都可以作為 React 元素使用，因此可以用 JSX 呈現表單。</p>
<p>當需要在 React 中構建表單組件時，可以使用幾種模式。 模式之一使用稱為 refs 的 React 功能直接訪問 DOM 節點。在 React 中，ref 是一個物件，它存儲組件生命週期內的值。React 為我們提供了一個 useRef 掛鉤(hook)，我們可以使用它來創建一個 ref 物件。</p>
<p>直接通過將 DOM 節點的 value 屬性設定值，稱為不受控制的組件(uncontrolled component)，因為它使用 DOM 來保存表單值。有時使用不受控制的組件可以使您解決一些麻煩。 例如，您可能想與 React 之外的代碼共享一個表單及其值。 但是，在 React 中使用受控制組件(controlled component)是比較好的方法。</p>
<p>在受控制組件中，表單值由 React 而不是 DOM 管理。它們不需要我們使用 ref 物件，也不需要我們編寫命令性代碼。當使用受控組件時，添加表單驗證之類的功能要容易得多。</p>
<p>這裡，我們不展示不受控制組件，直接使用受控制組件。</p>
<p>受控制組件使用 React 狀態(state)保存表單的值。我們將用 useState 掛鉤建立兩個變數 title 與 color。此外，我們將也將定義可用於更改狀態的函式：setTitle 和 setColor。</p>
<figure class="highlight js"><figcaption><span>AddColorForm</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> AddColorForm = <span class="function">(<span class="params">&#123; onNewColor = f =&gt; f &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> [title, setTitle] = useState(<span class="string">""</span>);</span><br><span class="line">  <span class="keyword">const</span> [color, setColor] = useState(<span class="string">"#000000"</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> submit = <span class="function"><span class="params">e</span> =&gt;</span> &#123;</span><br><span class="line">    e.preventDefault();</span><br><span class="line">    onNewColor(title, color);</span><br><span class="line">    setTitle(<span class="string">""</span>);</span><br><span class="line">    setColor(<span class="string">"#000000"</span>);</span><br><span class="line">  &#125;;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;form onSubmit=&#123;submit&#125; &gt;</span><br><span class="line">      &lt;input </span><br><span class="line">        value=&#123;title&#125;</span><br><span class="line">        onChange=&#123; event =&gt; setTitle(event.target.value)&#125;</span><br><span class="line">        type=<span class="string">"text"</span></span><br><span class="line">        placeholder=<span class="string">"color title..."</span></span><br><span class="line">        required</span><br><span class="line">      /&gt;</span><br><span class="line">      &lt;input </span><br><span class="line">        value=&#123;color&#125;</span><br><span class="line">        onChange=&#123; event =&gt; setColor(event.target.value)&#125;</span><br><span class="line">        type=<span class="string">"color"</span></span><br><span class="line">        required</span><br><span class="line">      /&gt;</span><br><span class="line">      &lt;button className=<span class="string">"t-Button t-Button--hot margin-left-sm"</span>&gt;Add&lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>form&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>每當這些 input 元素引發 onChange 事件時，我們將調用 setTitle 或 setColor 來更改狀態中的值。更改該值將導致該組件重新渲染，會立即在 input 元素中顯示新的值。</p>
<p>提交表單時，我們只需在第 7 行直接將 title 和 color 的狀態值作為參數傳遞給 onNewColor 函式屬性即可。</p>
<p>知道受控組件會經常重新渲染，你將知道避免向該組件添加一些漫長且昂貴的處理過程。當您嘗試優化 React 組件時，這些知識將會派上用場。</p>
<p>現在將 AddColorForm 加入我們的根組件 App，並定義 onNewColor 函式屬性。記得也將 Demo 模組的 uuid 函式加進來。</p>
<figure class="highlight js"><figcaption><span>AddColorForm:App</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; uuid, colorData &#125; = Demo;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> App = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> [colors, setColors] = useState(colorData);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> ( </span><br><span class="line">    &lt;&gt;</span><br><span class="line">      &lt;AddColorForm </span><br><span class="line">        onNewColor=&#123;(title, color) =&gt; &#123;</span><br><span class="line">          <span class="keyword">const</span> newColors = [</span><br><span class="line">            ...colors,</span><br><span class="line">            &#123;</span><br><span class="line">              id: uuid(),</span><br><span class="line">              rating: <span class="number">0</span>,</span><br><span class="line">              title,</span><br><span class="line">              color</span><br><span class="line">            &#125;</span><br><span class="line">          ];</span><br><span class="line">          setColors(newColors);</span><br><span class="line">        &#125;&#125;</span><br><span class="line">      /&gt;</span><br><span class="line">      &lt;ColorList </span><br><span class="line">        colors=&#123;colors&#125;</span><br><span class="line">        onRateColor=&#123;(id, rating) =&gt; &#123;</span><br><span class="line">          <span class="keyword">const</span> newColors = colors.map(<span class="function"><span class="params">color</span> =&gt;</span> color.id === id ? &#123;...color, rating&#125; : color);</span><br><span class="line">          setColors(newColors);</span><br><span class="line">        &#125;&#125;</span><br><span class="line">        onRemoveColor=&#123;id =&gt; &#123;</span><br><span class="line">          <span class="keyword">const</span> newColors = colors.filter(<span class="function"><span class="params">color</span> =&gt;</span> color.id !== id);</span><br><span class="line">          setColors(newColors);</span><br><span class="line">        &#125;&#125;</span><br><span class="line">      /&gt;</span><br><span class="line">    &lt;<span class="regexp">/&gt;</span></span><br><span class="line"><span class="regexp">  )</span></span><br><span class="line"><span class="regexp">&#125;;</span></span><br></pre></td></tr></table></figure>

<p>AddColorForm 組件通過 onNewColor 函式將 title 和 color 的值傳遞給父組件 App。調用 onNewColor 屬性時，我們會將新顏色保存在狀態中。</p>
<p>將狀態統一存儲在樹狀結構的根的位置是一種重要的模式，這是早期版本 React 的重要模式。通過屬性上下傳遞狀態是任何 React 開發人員必須知道的概念，是我們所有人都應該知道的方法。 但是，隨著 React 的發展以及我們的組件樹越來越大，遵循此原理逐漸變得不切實際。對於復雜的應用程序來說，許多開發人員很難在組件樹根的單個位置維護狀態。通過數十個組件將狀態上下傳遞是繁瑣且容易出錯的。</p>
<p>多數的 UI 元素都很複雜，樹的根通常離葉子很遠，將數據置於離使用數據組件許多層的位置，每個組件都必須收到只能傳遞給子組件的屬性，這將使我們的代碼變的臃腫，並使我們的 UI 難以擴展。</p>
<p>將狀態數據作為屬性傳遞通過每個組件，直到到達需要使用的組件，就像乘火車從台南到台北。在火車上，您會經過每個站，但直到到達目的地，您都不會下車。</p>
<p>搭飛機從台南飛往台北顯然效率較佳。這樣，您不必通過每個中間站，你直接飛越它們。</p>
<p>下次我們將用比較有效率的方式，直接飛越它們: <strong>React Context</strong>。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://1184yang.github.io/2020/09/24/React-State-Management/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/1184yang.jpg">
      <meta itemprop="name" content="J.Y. Yang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/09/24/React-State-Management/" class="post-title-link" itemprop="url">React State Management</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2020-09-24 07:28:43" itemprop="dateCreated datePublished" datetime="2020-09-24T07:28:43+08:00">2020-09-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2020-10-10 13:48:16" itemprop="dateModified" datetime="2020-10-10T13:48:16+08:00">2020-10-10</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/JavaScript/" itemprop="url" rel="index"><span itemprop="name">JavaScript</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/React/" itemprop="url" rel="index"><span itemprop="name">React</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>數據活化我們的 React 組件。 沒有數據，我們構建的使用者介面就沒有用。我們的使用者介面是創建用來生成數據內容的工具。 為了為我們的數據內容創建者構建最好的工具，我們需要知道如何有效地操作和更改數據。</p>
<p>之前，我們建構了一個組件樹(component tree)：數據能夠作為屬性流經整個組件層次結構。 屬性(properties)是整體構圖的一半。另一半則是狀態(state)。 React 應用程序的狀態由具有更改能力的數據驅動。 應用程序有了狀態，讓我們可以創建、修改、刪除現有的數據。</p>
<p>狀態和屬性相互之間具有聯繫性。當我們使用 React 應用程序時，我們會根據狀態和屬性這種關係，將所有的組件組合在一起。當組件樹的狀態更改時，屬性也會更改。 新數據流過組件樹，導致特定的終端組件和分支重新渲染以呈現反映新的內容。</p>
<p>我們將使用狀態來活化應用程序，創建<strong>有狀態組件(stateful components)</strong>，將狀態由根組件往下發送到整個組件樹，及如何將使用者使用表單收集的互動數據由組件樹的末端往上回溯。</p>
<h3 id="Star-Rating-Component"><a href="#Star-Rating-Component" class="headerlink" title="Star Rating Component"></a>Star Rating Component</h3><p>這裡要建立一個星級評分組件，五星級評分，可以讓我們評論東西的好壞。也能讓使用者驅動我們對內容的改進。</p>
<img src="/2020/09/24/React-State-Management/20200925-01.png" title="Star Rating">

<p>我們要建立一個 StarRating 組件，StarRating 組件將允許使用者根據特定的星星數對內容進行評分。不好的內容獲得一顆星。高度推薦的內容獲得五顆星。用戶可以透過單擊特定的星號來設置內容的等級。</p>
<p>首先我們需要一個星星圖標。<a href="https://apex.oracle.com/pls/apex/apex_pm/r/ut/icons" target="_blank" rel="noopener">Oracle APEX - Universal Theme</a> 內建有許多 icons 可以直接使用。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"react-root"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/babel"</span>&gt;</span></span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> &#123; render &#125; = ReactDOM;</span></span><br><span class="line">  </span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> FaStar = <span class="function">(<span class="params">&#123; color &#125;</span>) =&gt;</span> ( </span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">span</span> <span class="attr">className</span>=<span class="string">"fa fa-star fa-2x"</span> <span class="attr">style</span>=<span class="string">&#123;&#123;color&#125;&#125;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">  </span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> StarRating = <span class="function"><span class="params">()</span> =&gt;</span> (</span></span><br><span class="line">    [</span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">FaStar</span> <span class="attr">color</span>=<span class="string">"gold"</span> /&gt;</span>,</span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">FaStar</span> <span class="attr">color</span>=<span class="string">"gold"</span> /&gt;</span>,</span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">FaStar</span> <span class="attr">color</span>=<span class="string">"gold"</span> /&gt;</span>,</span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">FaStar</span> <span class="attr">color</span>=<span class="string">"grey"</span> /&gt;</span>,</span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">FaStar</span> <span class="attr">color</span>=<span class="string">"grey"</span> /&gt;</span></span></span><br><span class="line">    ]</span><br><span class="line">  );  </span><br><span class="line">   </span><br><span class="line"><span class="javascript">  render(<span class="xml"><span class="tag">&lt;<span class="name">StarRating</span> /&gt;</span></span>, <span class="built_in">document</span>.getElementById(<span class="string">"react-root"</span>)); </span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在這裡，我們創建了 FaStar 組件將 APEX Universal Theme 的圖標 fa-star 包裝起來。然後創建一個 StarRating 組件，該組件渲染了五個 FaStar 組件，產生五顆星星， 前三顆填滿了金色，後兩顆是灰色。</p>
<p>首先渲染了五顆星星，它們為我們提供了構建的基礎。 選定的星星填滿金色，未選擇的星星是灰色。</p>
<p>讓我們再創建一個 Star 組件，該組件會根據 selected 屬性自動填滿星星的顏色：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Star = <span class="function">(<span class="params">&#123; selected = <span class="literal">false</span> &#125;</span>) =&gt;</span> (</span><br><span class="line">  &lt;FaStar color=&#123;selected ? <span class="string">"gold"</span> : <span class="string">"grey"</span>&#125; /&gt;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>Star 組件將渲染單個星星，並使用 selected 屬性為其填充適當的顏色。如果未將 selected 屬性傳遞給此組件，則假定該星星沒有被選，並且預設填充灰色。</p>
<p>5 星級評分很好，但 10 星級可以提供更詳細的評分。我們應該允許開發人員將組件添加到應用程序時，可以選擇希望使用的總星數。這可以透過在 StarRating 組件中添加 totalStars 屬性來實現。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> createArray = <span class="function"><span class="params">length</span> =&gt;</span> [...Array(length)];</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> StarRating = <span class="function">(<span class="params">&#123; totalStars = <span class="number">5</span> &#125;</span>) =&gt;</span> (</span><br><span class="line">  createArray(totalStars).map(<span class="function">(<span class="params">n, i</span>) =&gt;</span> <span class="xml"><span class="tag">&lt;<span class="name">Star</span> <span class="attr">key</span>=<span class="string">&#123;i&#125;</span> /&gt;</span></span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>我們添加了 createArray 函式。我們要做的就是提供要創建的陣列長度，然後用該長度取得一個新的陣列。 我們將此函式與 totalStars 屬性一起使用，就可以用陣列 map 渲染 Star 組件。 預設情況下，totalStars 等於 5，將渲染 5 個灰色星星。</p>
<img src="/2020/09/24/React-State-Management/20200925-02.png" title="Star Rating">

<h4 id="useState-Hook"><a href="#useState-Hook" class="headerlink" title="useState Hook"></a>useState Hook</h4><p>現在要使星級評分組件可以單擊，這將允許使用者更改評分。</p>
<p>由於評分是一個會改變的值，因此我們將使用 React 狀態(state)來儲存和更改該值。我們要使用稱為 <a href="https://zh-hant.reactjs.org/docs/hooks-intro.html" target="_blank" rel="noopener">Hook</a> 的 React 功能將狀態合併到組件中。 Hook 包含與組件樹分開的可重用代碼邏輯。它使我們能夠將所要處裡的功能連接到我們的組件。React 有幾個內建的 Hooks，我們可以直接使用它們。這裡，我們想向 React 組件添加狀態，因此我們要使用的第一個 Hook 是 React 的 useState。這個 Hook 已經包含在 react 程式包中，我們只需要將它加入我們的程式：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; useState &#125; = React;</span><br></pre></td></tr></table></figure>

<p>使用者所選擇的星號代表等級。我們將創建一個名為 selectedStars 的狀態變數(state variable)，它將保存用戶的評分。我們將透過將 useState Hook 直接添加到 StarRating 組件中來創建此狀態變數：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> StarRating = <span class="function">(<span class="params">&#123; totalStars = <span class="number">5</span> &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> [selectedStars] = useState(<span class="number">3</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;&gt;</span><br><span class="line">      &#123;createArray(totalStars).map(<span class="function">(<span class="params">n, i</span>) =&gt;</span> (</span><br><span class="line">        &lt;Star key=&#123;i&#125; selected=&#123;selectedStars &gt; i&#125; /&gt;</span><br><span class="line">      ))&#125;</span><br><span class="line">      &lt;p style=&#123;&#123;<span class="attr">fontSize</span>: <span class="string">"1.5em"</span>, <span class="attr">margin</span>: <span class="string">"10px"</span>&#125;&#125;&gt;&#123;selectedStars&#125; <span class="keyword">of</span> &#123;totalStars&#125; stars&lt;<span class="regexp">/p&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>我們只是將該組件與狀態掛鉤。useState 掛鉤是一個函式，調用它會返回一個陣列。返回的陣列的第一個值是我們要使用的狀態變數。在這裡，該變數為 selectedStars，也就是 StarRating 組件將顏色變為金色的星數。useState 返回一個陣列，我們可以利用陣列解構賦值，這使我們可以隨意命名狀態變數。我們調用 useState 函式時給的引數值是狀態變數的初始預設值。在這裡，selectedStars 初始預設值將設置為 3。</p>
<img src="/2020/09/24/React-State-Management/20200925-01.png" title="Star Rating">

<p>為了從使用者那裡獲得不同的評分，我們需要允許他們點擊我們的任何一顆星星。 所以，我們需要透過向 FaStar 組件中的星形圖標 fa-star 添加 onClick 處理程序來使星星可點擊：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> FaStar = <span class="function">(<span class="params">&#123; color, onSelect =  f =&gt; f &#125;</span>) =&gt;</span> ( </span><br><span class="line">  &lt;span className=<span class="string">"fa fa-star fa-2x"</span> style=&#123;&#123;color&#125;&#125; onClick=&#123;onSelect&#125; &gt;&lt;<span class="regexp">/span&gt;</span></span><br><span class="line"><span class="regexp">);</span></span><br></pre></td></tr></table></figure>

<p>這裡，我們修改了星形圖標 fa-star 以包含 onClick 事件，這個事件的處理程序是由父組件傳入的 onSelect 屬性。 注意，此屬性是一個函式。 當用戶單擊星形圖標時，我們將調用此函式，該函式可以通知其父組件已單擊星形圖標。該函式的預設值為 f =&gt; f。 這只是一個偽造的函式，什麼也不做。它只是返回發送給它的任何參數。但是，如果我們未設置預設函式並且未定義 onSelect 屬性，則在我們單擊星形圖標時會發生錯誤，因為 onSelect 的值必須是一個函式。 即使 f =&gt; f 什麼也不做，它還是一個函式，可以調用它而不會引起錯誤。如果沒有定義 onSelect 屬性，沒有問題，React 將簡單地調用偽函式，而不會發生任何事情。</p>
<p>現在我們的星形圖標 fa-star 是可單擊的，我們將使用它來更改 StarRating 的狀態。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> StarRating = <span class="function">(<span class="params">&#123; totalStars = <span class="number">5</span> &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> [selectedStars, setSelectedStars] = useState(<span class="number">0</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;&gt;</span><br><span class="line">      &#123;createArray(totalStars).map(<span class="function">(<span class="params">n, i</span>) =&gt;</span> (</span><br><span class="line">        &lt;Star</span><br><span class="line">          key=&#123;i&#125; </span><br><span class="line">          selected=&#123;selectedStars &gt; i&#125;</span><br><span class="line">          onSelect=&#123;() =&gt; setSelectedStars(i + <span class="number">1</span>)&#125;</span><br><span class="line">        /&gt;</span><br><span class="line">      ))&#125;</span><br><span class="line">      &lt;p style=&#123;&#123;<span class="attr">fontSize</span>: <span class="string">"1.5em"</span>, <span class="attr">margin</span>: <span class="string">"10px"</span>&#125;&#125;&gt;&#123;selectedStars&#125; <span class="keyword">of</span> &#123;totalStars&#125; stars&lt;<span class="regexp">/p&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>為了更改 StarRating 組件的狀態，我們需要一個可以修改 selectedStars 值的函式。 useState 掛鉤返回的陣列中的第二項是可用於更改狀態值的函式。同樣，透過陣列解構賦值，我們可以隨心所欲地命名該函式。在這裡，我們稱其為 setSelectedStars，因為它就是用來設置 selectedStars 的值。</p>
<p>關於 Hooks，要記住的最重要的事情是，Hooks 可能導致掛鉤他們的組件重新渲染。每次我們調用 setSelectedStars 函式來更改 selectedStars 的值時，該掛鉤將重新調用 StarRating 函式組件，並且它將再次重新渲染。 這就是為什麼 Hooks 是殺手級功能的原因。當 Hook 中的數據發生更改時，他們會使用新數據重新渲染掛接它們的組件。</p>
<p>每次使用者單擊星形圖標 fa-star 時，將重新渲染 StarRating 組件。當使用者單擊星形圖標 fa-star 時，將調用該星星的 onSelect 屬性。 調用 onSelect 屬性時，我們將調用 setSelectedStars 函式並將剛選擇的星星編號當為函式的引數傳入。 我們使用 map 函數中的 i 變數來幫助我們計算該數字。當 map 函式渲染第一個 Star 時，i 的值為 0，我們需要在該值上加上 1 以獲取正確的 star 編號。 新的 selectedStars 的值發生變化會導致 StarRating 組件的重新渲染。</p>
<p>你如果現在單擊星形圖標，將不會發生任何作用，因為 FaStar 組件與 StarRating 組件並沒有直接關連，它是透過 Star 組件組成一個階層式組件樹，數據透過屬性流經整個組件層次結構。onSelect 屬性也必須透過 Star 組件流到 FaStar 組件，因為 FaStar 組件中的星形圖標 fa-star 才是使用者單擊的標的，onClick 事件是由此被觸發的。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Star = <span class="function">(<span class="params">&#123; selected = <span class="literal">false</span>, onSelect = f =&gt; f &#125;</span>) =&gt;</span> (</span><br><span class="line">  &lt;FaStar color=&#123;selected ? <span class="string">"gold"</span> : <span class="string">"grey"</span>&#125; onSelect=&#123;onSelect&#125; /&gt;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>整個程式碼現在如下:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"react-root"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/babel"</span>&gt;</span></span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> &#123; useState &#125; = React;</span></span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> &#123; render &#125; = ReactDOM;</span></span><br><span class="line">  </span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> FaStar = <span class="function">(<span class="params">&#123; color, onSelect =  f =&gt; f &#125;</span>) =&gt;</span> ( </span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">span</span> <span class="attr">className</span>=<span class="string">"fa fa-star fa-2x"</span> <span class="attr">style</span>=<span class="string">&#123;&#123;color&#125;&#125;</span> <span class="attr">onClick</span>=<span class="string">&#123;onSelect&#125;</span> &gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">  </span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> Star = <span class="function">(<span class="params">&#123; selected = <span class="literal">false</span>, onSelect = f =&gt; f &#125;</span>) =&gt;</span> (</span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">FaStar</span> <span class="attr">color</span>=<span class="string">&#123;selected</span> ? "<span class="attr">gold</span>" <span class="attr">:</span> "<span class="attr">grey</span>"&#125; <span class="attr">onSelect</span>=<span class="string">&#123;onSelect&#125;</span> /&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">   </span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> createArray = <span class="function"><span class="params">length</span> =&gt;</span> [...Array(length)];</span></span><br><span class="line">  </span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> StarRating = <span class="function">(<span class="params">&#123; totalStars = <span class="number">5</span> &#125;</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">const</span> [selectedStars, setSelectedStars] = useState(<span class="number">0</span>);</span></span><br><span class="line">    </span><br><span class="line"><span class="javascript">    <span class="keyword">return</span> (</span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;&gt;</span></span></span><br><span class="line"><span class="javascript">        &#123;createArray(totalStars).map(<span class="function">(<span class="params">n, i</span>) =&gt;</span> (</span></span><br><span class="line">          &lt;Star</span><br><span class="line">            key=&#123;i&#125; </span><br><span class="line">            selected=&#123;selectedStars &gt; i&#125;</span><br><span class="line">            onSelect=&#123;() =&gt; setSelectedStars(i + 1)&#125;</span><br><span class="line">          /&gt;</span><br><span class="line">        ))&#125;</span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">p</span> <span class="attr">style</span>=<span class="string">&#123;&#123;fontSize:</span> "<span class="attr">1.5em</span>", <span class="attr">margin:</span> "<span class="attr">10px</span>"&#125;&#125;&gt;</span>&#123;selectedStars&#125; of &#123;totalStars&#125; stars<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;/&gt;</span></span></span><br><span class="line">    );</span><br><span class="line">  &#125;;  </span><br><span class="line">   </span><br><span class="line"><span class="javascript">  render(<span class="xml"><span class="tag">&lt;<span class="name">StarRating</span> <span class="attr">totalStars</span>=<span class="string">&#123;5&#125;</span> /&gt;</span></span>, <span class="built_in">document</span>.getElementById(<span class="string">"react-root"</span>)); </span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>你可以將第 34 行的 totalStars 改為 10 就變成 10 星級評分了。</p>
<p>在 v16.8.0 之前的 React 早期版本中，向組件添加狀態的唯一方法是使用類組件(class component)。這不僅需要大量的代碼，而且還使得跨組件重用功能變得更加困難。Hooks 旨在透過將功能掛鉤到函式組件來解決類組件所帶來的問題。目前，類組件代碼仍然有效，但我們已不再需要它們，可能會有一天類組件會正式被棄用。</p>
<p>函式組件和 Hooks 是 React 的未來。</p>
<h3 id="延續傳遞風格-CPS"><a href="#延續傳遞風格-CPS" class="headerlink" title="延續傳遞風格(CPS)"></a>延續傳遞風格(CPS)</h3><p>在這個星級評分組件中我們用到了 JavaScript 的一種很重要的概念，延續傳遞風格(Continuation-passing style)，簡稱 CPS。</p>
<p>JavaScript 的回呼 (callback) 是作為參數傳遞給其他函式，並在操作完成時呼叫以傳遞結果。在函式化的程式設計風格，這種傳遞結果的方式稱為延續傳遞風格(Continuation-passing style)，簡稱 CPS 。這是ㄧ個通用的概念，而不一定與非同步操作相關。事實上，它只是指出操作結果是以傳給另一個函式(回呼)的方式來傳遞，而不是直接傳給呼叫者。</p>
<p>程式碼的第 26 行的 onSelect 屬性是一個函式，這個函式我們是定義在 StarRating 組件上，以組件屬性的方式傳遞到 FaStar 組件中的星形圖標 fa-star，當使用者單擊星形圖標 fa-star 時將結果透過函式回傳 StarRating 根組件。每一個星形圖標 fa-star 的函式看起來都一樣，但它其實是一個閉包 (closure)，函式 ( ) =&gt; setSelectedStars( i + 1 ) 中 i 變數的值都不同。</p>
<p>閉包與延續傳遞風格在 JavaScript 中是很重要的概念，需要花點時間熟悉它。</p>
<p>思考一下這一段 JavaScript:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> stars = [...Array(<span class="number">5</span>)].map(<span class="function">(<span class="params">n, i</span>) =&gt;</span> <span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">`Star =&gt; <span class="subst">$&#123;i&#125;</span>`</span>));</span><br><span class="line"></span><br><span class="line">stars[<span class="number">2</span>]();</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://1184yang.github.io/2020/09/22/React-with-JSX/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/1184yang.jpg">
      <meta itemprop="name" content="J.Y. Yang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/09/22/React-with-JSX/" class="post-title-link" itemprop="url">React with JSX</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2020-09-22 09:38:19" itemprop="dateCreated datePublished" datetime="2020-09-22T09:38:19+08:00">2020-09-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2020-10-10 13:48:16" itemprop="dateModified" datetime="2020-10-10T13:48:16+08:00">2020-10-10</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/JavaScript/" itemprop="url" rel="index"><span itemprop="name">JavaScript</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/React/" itemprop="url" rel="index"><span itemprop="name">React</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>考慮下面這個變數宣告：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">const element = <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Hello Tainan，台南!<span class="tag">&lt;/<span class="name">h1</span>&gt;</span>;</span><br></pre></td></tr></table></figure>

<p>這個標籤語法不是一個字串也不是 HTML。</p>
<p>這個語法叫做 JSX。JSX 結合了 JavaScript 的 JS 和 XML 的 X，是一個 JavaScript 的語法擴充。允許我們直接在  Javascript 源代碼中使用基於<strong>標籤</strong>的語法來定義 React 元素。有時 JSX 會與 HTML 混淆，因為它們看起來很相似。JSX 也可能會讓你想到一些樣板語言(template language)，但不一樣的地方是 JSX 允許你使用 JavaScript 所有的功能。</p>
<p>JSX 是創建 React 元素的另一種方式，執行 JSX 會產生 React 元素，因此您不必費力地在復雜的 React.createElement 調用中尋找缺少的逗號。</p>
<p>建議你在寫 React 的時候透過 JSX 語法來描述使用者介面的外觀。</p>
<p>將 React.createElement 改用 JSX:</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">const hello = React.createElement("h1", &#123; id: "hello" &#125;, "Hello Scott!");</span><br><span class="line">               ⇓</span><br><span class="line">const hello = <span class="tag">&lt;<span class="name">h1</span> <span class="attr">id</span>=<span class="string">"hello"</span>&gt;</span>Hello Scott!<span class="tag">&lt;/<span class="name">h1</span>&gt;</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"react-root"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/babel"</span>&gt;</span></span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> hello = <span class="xml"><span class="tag">&lt;<span class="name">h1</span> <span class="attr">id</span>=<span class="string">"hello"</span>&gt;</span>Hello Scott!<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span>;</span></span><br><span class="line"></span><br><span class="line"><span class="javascript">  ReactDOM.render(hello, <span class="built_in">document</span>.getElementById(<span class="string">"react-root"</span>));</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>JavaScript 不認識 JSX 語法，必須先經過 Babel 的預處理(compiling)。</p>
<p>但我們通常不會使用變數的方式，而會使用函式組件的方式:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/babel"</span>&gt;</span></span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> Hello = <span class="function"><span class="params">()</span> =&gt;</span> <span class="xml"><span class="tag">&lt;<span class="name">h1</span> <span class="attr">id</span>=<span class="string">"hello"</span>&gt;</span>Hello Scott!<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span>;</span></span><br><span class="line"></span><br><span class="line"><span class="javascript">  ReactDOM.render(<span class="xml"><span class="tag">&lt;<span class="name">Hello</span> /&gt;</span></span>, <span class="built_in">document</span>.getElementById(<span class="string">"react-root"</span>));</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>這個模式是 React JSX 的基本使用方式: 函式組件 (function component)。組成的組件樹(component tree)構造整個 React 應用程序。</p>
<h4 id="JSX-Tips"><a href="#JSX-Tips" class="headerlink" title="JSX Tips"></a>JSX Tips</h4><p>JSX 可能看起來很熟悉，並且大多數規則導致的語法類似於 HTML。但是，使用 JSX 時應注意一些事項。</p>
<h5 id="Nested-components"><a href="#Nested-components" class="headerlink" title="Nested components"></a>Nested components</h5><p>JSX 允許我們將組件添加為其他組件的子代。 例如，在 UsersList 內部，我們可以多次渲染另一個名為 User 的組件。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">UsersList</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">User</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">User</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">User</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">UsersList</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="className"><a href="#className" class="headerlink" title="className"></a>className</h5><p>由於 class 是 JavaScript 中的保留字，因此使用 className 來定義 class 屬性。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h1</span> <span class="attr">className</span>=<span class="string">"fancy"</span>&gt;</span>Hello Scott!<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="JavaScript-expressions"><a href="#JavaScript-expressions" class="headerlink" title="JavaScript expressions"></a>JavaScript expressions</h5><p>JavaScript 表達式用大括號 { } 括起來，指示變數將在何處被求值並返回其結果值。例如，如果要在元素中顯示 user 屬性的值，則可以使用 JavaScript 表達式插入該值。該變數 user 將被求值並返回其值。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>&#123;user&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>除字符串以外的其他類型的值，也應顯示為 JavaScript 表達式:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"checkbox"</span> <span class="attr">defaultChecked</span>=<span class="string">&#123;false&#125;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="Evaluation"><a href="#Evaluation" class="headerlink" title="Evaluation"></a>Evaluation</h5><p>大括號之間添加的 JavaScript 將被求值。 這意味著，可以執行字串串聯或加法之類的操作。這也意味著, JavaScript 將會調用在表達式中找到的函數：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>&#123;"Hello " + user&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>&#123;user.toLowerCase()&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>&#123;`Hello $&#123;user.toLowerCase()&#125;`&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="Mapping-Arrays-with-JSX"><a href="#Mapping-Arrays-with-JSX" class="headerlink" title="Mapping Arrays with JSX"></a>Mapping Arrays with JSX</h5><p>JSX 是 JavaScript，因此您可以將 JSX 直接合併到 JavaScript 函數中。例如，您可以將陣列映射到 JSX 元素：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">  &#123; userData.map((user, i) =&gt; (</span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">key</span>=<span class="string">&#123;i&#125;</span>&gt;</span>&#123;user&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">  ))&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>可以比對一下使用 React.createElement 與 使用 JSX 的差別:</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">const hello = React.createElement(</span><br><span class="line">  "ul",</span><br><span class="line">  null,</span><br><span class="line">  userData.map((user, i) =&gt; </span><br><span class="line">    React.createElement("li", &#123; key: i &#125;, `Hello $&#123;user&#125;`)</span><br><span class="line">  )</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">      ⇓</span><br><span class="line"></span><br><span class="line">const hello = </span><br><span class="line">  <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">    &#123; userData.map((user, i) =&gt; (</span><br><span class="line">      <span class="tag">&lt;<span class="name">li</span> <span class="attr">key</span>=<span class="string">&#123;i&#125;</span>&gt;</span>&#123;user&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    ))&#125;</span><br><span class="line">  <span class="tag">&lt;/<span class="name">ul</span>&gt;</span>;</span><br></pre></td></tr></table></figure>

<p>JSX 看起來很乾淨而且有較佳的可讀性，但是無法直接在瀏覽器解譯執行。所有 JSX 必須轉換為 React.createElement 調用。幸運的是，有一個出色的工具可以執行此任務：Babel。</p>
<p>整段由使用 React.createElement 改用 JSX 改寫。</p>
<ul>
<li>使用 React.createElement</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/babel"</span>&gt;</span></span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> userData = [</span></span><br><span class="line"><span class="javascript">    <span class="string">"Scott"</span>,</span></span><br><span class="line"><span class="javascript">    <span class="string">"Emily"</span>,</span></span><br><span class="line"><span class="javascript">    <span class="string">"Amanda"</span></span></span><br><span class="line">  ];</span><br><span class="line"></span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> UsersList = <span class="function">(<span class="params">&#123; users = [] &#125;</span>) =&gt;</span> (</span></span><br><span class="line">    React.createElement(</span><br><span class="line"><span class="javascript">      <span class="string">"ul"</span>,</span></span><br><span class="line"><span class="javascript">      <span class="literal">null</span>,</span></span><br><span class="line"><span class="javascript">      users.map(<span class="function">(<span class="params">user, i</span>) =&gt;</span> </span></span><br><span class="line"><span class="javascript">        React.createElement(<span class="string">"li"</span>, &#123; <span class="attr">key</span>: i &#125;, <span class="string">`Hello <span class="subst">$&#123;user&#125;</span>`</span>)</span></span><br><span class="line">      )</span><br><span class="line">    )</span><br><span class="line">  );</span><br><span class="line">  </span><br><span class="line">  ReactDOM.render(</span><br><span class="line"><span class="javascript">    React.createElement(UsersList, &#123; <span class="attr">users</span>: userData &#125;, <span class="literal">null</span>),</span></span><br><span class="line"><span class="javascript">    <span class="built_in">document</span>.getElementById(<span class="string">"react-root"</span>)</span></span><br><span class="line">  );</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>使用 JSX</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/babel"</span>&gt;</span></span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> userData = [</span></span><br><span class="line"><span class="javascript">    <span class="string">"Scott"</span>,</span></span><br><span class="line"><span class="javascript">    <span class="string">"Emily"</span>,</span></span><br><span class="line"><span class="javascript">    <span class="string">"Amanda"</span></span></span><br><span class="line">  ];</span><br><span class="line"></span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> UsersList = <span class="function">(<span class="params">&#123; users = [] &#125;</span>) =&gt;</span> (</span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="javascript">      &#123; users.map(<span class="function">(<span class="params">user, i</span>) =&gt;</span> (</span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">li</span> <span class="attr">key</span>=<span class="string">&#123;i&#125;</span>&gt;</span>&#123;user&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line">      ))&#125;</span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">  </span><br><span class="line">  ReactDOM.render(</span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">UsersList</span> <span class="attr">users</span>=<span class="string">&#123;userData&#125;</span> /&gt;</span>,</span></span><br><span class="line"><span class="javascript">    <span class="built_in">document</span>.getElementById(<span class="string">"react-root"</span>)</span></span><br><span class="line">  );</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>第 8 行是一個函式組件，這裡改用 JSX。</li>
<li>第 17 行我們使用 JSX 語法調用 UsersList 函式組件，透過 users 屬性傳遞函式引數。這裡的所有屬性將被包在一個物件 { users: “[…]”, others: “…” } 傳遞給函式組件。</li>
</ul>
<p>有了基礎概念，現在來做一個比較實際的例子。</p>
<h4 id="美味食譜"><a href="#美味食譜" class="headerlink" title="美味食譜"></a>美味食譜</h4><p>我們需要一些美味食譜的資料，我們將它放在 APEX Page Properties 的 JavaScript &gt; Function and Global Variable Declaration 中。</p>
<figure class="highlight javascript"><figcaption><span>recipesData</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> recipesData = [</span><br><span class="line">  &#123;</span><br><span class="line">    name: <span class="string">"烤鮭魚"</span>,</span><br><span class="line">    ingredients: [</span><br><span class="line">      &#123; <span class="attr">name</span>: <span class="string">"鮭魚"</span>, <span class="attr">amount</span>: <span class="number">1</span>, <span class="attr">measurement</span>: <span class="string">"磅"</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">name</span>: <span class="string">"松子"</span>, <span class="attr">amount</span>: <span class="number">1</span>, <span class="attr">measurement</span>: <span class="string">"杯"</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">name</span>: <span class="string">"生菜"</span>, <span class="attr">amount</span>: <span class="number">2</span>, <span class="attr">measurement</span>: <span class="string">"杯"</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">name</span>: <span class="string">"黃色的南瓜"</span>, <span class="attr">amount</span>: <span class="number">1</span>, <span class="attr">measurement</span>: <span class="string">"中"</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">name</span>: <span class="string">"橄欖油"</span>, <span class="attr">amount</span>: <span class="number">0.5</span>, <span class="attr">measurement</span>: <span class="string">"杯"</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">name</span>: <span class="string">"大蒜"</span>, <span class="attr">amount</span>: <span class="number">3</span>, <span class="attr">measurement</span>: <span class="string">"瓣"</span> &#125;,</span><br><span class="line">    ],</span><br><span class="line">    steps: [</span><br><span class="line">      <span class="string">"將烤箱預熱至350度。"</span>,</span><br><span class="line">      <span class="string">"將橄欖油撒在玻璃烤盤上。"</span>,</span><br><span class="line">      <span class="string">"加入南瓜，放入烤箱30分鐘。"</span>,</span><br><span class="line">      <span class="string">"將鮭魚，大蒜和松子添加到菜中."</span>,</span><br><span class="line">      <span class="string">"烤15分鐘。"</span>,</span><br><span class="line">      <span class="string">"從烤箱中取出，加入生菜即可食用。"</span></span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    name: <span class="string">"魚炸玉米餅"</span>,</span><br><span class="line">    ingredients: [</span><br><span class="line">      &#123; <span class="attr">name</span>: <span class="string">"白鲑"</span>, <span class="attr">amount</span>: <span class="number">1</span>, <span class="attr">measurement</span>: <span class="string">"磅"</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">name</span>: <span class="string">"乳酪"</span>, <span class="attr">amount</span>: <span class="number">1</span>, <span class="attr">measurement</span>: <span class="string">"杯"</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">name</span>: <span class="string">"捲心萵苣"</span>, <span class="attr">amount</span>: <span class="number">2</span>, <span class="attr">measurement</span>: <span class="string">"杯"</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">name</span>: <span class="string">"番茄"</span>, <span class="attr">amount</span>: <span class="number">2</span>, <span class="attr">measurement</span>: <span class="string">"大"</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">name</span>: <span class="string">"玉米饼"</span>, <span class="attr">amount</span>: <span class="number">3</span>, <span class="attr">measurement</span>: <span class="string">"中"</span> &#125;</span><br><span class="line">    ],</span><br><span class="line">    steps: [</span><br><span class="line">      <span class="string">"將魚放在烤架上煮至熱。"</span>,</span><br><span class="line">      <span class="string">"將魚放在3個玉米餅上。"</span>,</span><br><span class="line">      <span class="string">"上放生菜，番茄和乳酪。"</span></span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    name: <span class="string">"蕃茄炒蛋"</span>,</span><br><span class="line">    ingredients: [</span><br><span class="line">      &#123; <span class="attr">name</span>: <span class="string">"紅蕃茄"</span>, <span class="attr">amount</span>: <span class="number">3</span>, <span class="attr">measurement</span>: <span class="string">"個"</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">name</span>: <span class="string">"雞蛋"</span>, <span class="attr">amount</span>: <span class="number">3</span>, <span class="attr">measurement</span>: <span class="string">"個"</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">name</span>: <span class="string">"蕃茄醬"</span>, <span class="attr">amount</span>: <span class="number">1</span>, <span class="attr">measurement</span>: <span class="string">"大匙"</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">name</span>: <span class="string">"蔥花"</span>, <span class="attr">amount</span>: <span class="number">2</span>, <span class="attr">measurement</span>: <span class="string">"大匙"</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">name</span>: <span class="string">"蒜末"</span>, <span class="attr">amount</span>: <span class="number">1</span>, <span class="attr">measurement</span>: <span class="string">"小匙"</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">name</span>: <span class="string">"橄欖油"</span>, <span class="attr">amount</span>: <span class="number">2.5</span>, <span class="attr">measurement</span>: <span class="string">"大匙"</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">name</span>: <span class="string">"鹽"</span>, <span class="attr">amount</span>: <span class="number">1</span>, <span class="attr">measurement</span>: <span class="string">"小匙"</span> &#125;</span><br><span class="line">    ],</span><br><span class="line">    steps: [</span><br><span class="line">      <span class="string">"蕃茄洗淨後切塊狀..(去皮否隨個人喜好即可)~蛋打散備用。"</span>,</span><br><span class="line">      <span class="string">"起油鍋(兩大匙油)~蛋先入鍋炒至5分熟後盛出備用。"</span>,</span><br><span class="line">      <span class="string">"原鍋再加入油1/2大匙爆香蔥白、蒜末後倒入蕃茄醬拌炒。"</span>,</span><br><span class="line">      <span class="string">"接著加入水適量(剛好淹蓋住食材即可)煮開後，加入調味料煮片刻。"</span>,</span><br><span class="line">      <span class="string">"湯汁略為濃縮後倒入5分熟的炒蛋混合拌勻再煮一下即可。"</span>,</span><br><span class="line">      <span class="string">"起鍋前淋下香油，灑入蔥花拌一下即可盛盤。"</span></span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">];</span><br></pre></td></tr></table></figure>

<p>Region Properties 的 Source &gt; Text 的程式碼:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"react-root"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/babel"</span>&gt;</span></span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> &#123; render &#125; = ReactDOM;</span></span><br><span class="line"></span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> Ingredient = <span class="function">(<span class="params">&#123;amount, measurement, name&#125;</span>) =&gt;</span> </span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">li</span>&gt;</span></span></span><br><span class="line">      &#123;amount&#125; &#123;measurement&#125; &#123;name&#125;</span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">li</span>&gt;</span>;</span></span><br><span class="line">   </span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> IngredientsList = <span class="function">(<span class="params">&#123;list&#125;</span>) =&gt;</span>    </span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">ul</span> <span class="attr">className</span>=<span class="string">"ingredients"</span>&gt;</span></span></span><br><span class="line"><span class="javascript">      &#123;list.map(<span class="function">(<span class="params">ingredient, i</span>) =&gt;</span> (</span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">Ingredient</span> <span class="attr">key</span>=<span class="string">&#123;i&#125;</span> &#123;<span class="attr">...ingredient</span>&#125; /&gt;</span></span></span><br><span class="line">      ))&#125;</span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span>;</span></span><br><span class="line">  </span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> Instructions = <span class="function">(<span class="params">&#123;title, steps&#125;</span>) =&gt;</span>    </span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">section</span> <span class="attr">className</span>=<span class="string">"instructions"</span> <span class="attr">style</span>=<span class="string">&#123;&#123;paddingLeft:</span> "<span class="attr">1em</span>"&#125;&#125;&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">h3</span>&gt;</span>&#123;title&#125;<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span></span><br><span class="line"><span class="javascript">      &#123;steps.map(<span class="function">(<span class="params">s, i</span>) =&gt;</span> (</span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">p</span> <span class="attr">key</span>=<span class="string">&#123;i&#125;</span>&gt;</span>&#123;s&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line">      ))&#125;    </span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">section</span>&gt;</span>;</span></span><br><span class="line">    </span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> Recipe = <span class="function">(<span class="params">&#123;name, ingredients, steps&#125;</span>) =&gt;</span></span></span><br><span class="line"><span class="javascript">    &lt;section id=&#123;name.toLowerCase().replace(<span class="regexp">/ /g</span>, <span class="string">"-"</span>)&#125; style=&#123;&#123;<span class="attr">marginBottom</span>: <span class="string">"1em"</span>&#125;&#125;&gt;</span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">h2</span>&gt;</span>&#123;name&#125;<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">IngredientsList</span> <span class="attr">list</span>=<span class="string">&#123;ingredients&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">Instructions</span> <span class="attr">title</span>=<span class="string">"烹飪說明"</span> <span class="attr">steps</span>=<span class="string">&#123;steps&#125;</span> /&gt;</span>   </span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">section</span>&gt;</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> Menu = <span class="function">(<span class="params">&#123;title, recipes&#125;</span>) =&gt;</span>    </span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">article</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">header</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">h1</span>&gt;</span>&#123;title&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;/<span class="name">header</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">"recipes"</span> &gt;</span></span></span><br><span class="line"><span class="javascript">        &#123;recipes.map(<span class="function">(<span class="params">recipe, i</span>) =&gt;</span> (</span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;<span class="name">Recipe</span> <span class="attr">key</span>=<span class="string">&#123;i&#125;</span> &#123;<span class="attr">...recipe</span>&#125; /&gt;</span></span></span><br><span class="line">        ))&#125;</span><br><span class="line"><span class="xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">article</span>&gt;</span>;</span></span><br><span class="line">   </span><br><span class="line">  render(</span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">Menu</span> <span class="attr">recipes</span>=<span class="string">&#123;recipesData&#125;</span> <span class="attr">title</span>=<span class="string">"美味食譜"</span> /&gt;</span>,</span></span><br><span class="line"><span class="javascript">    <span class="built_in">document</span>.getElementById(<span class="string">'react-root'</span>)</span></span><br><span class="line"> );</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>這裡有 5 個 React 組件，組成一個組件樹。Menu 組件是根組件(root component)，所有的資料從根組件的 recipes 屬性注入(第 46 行) ，往整個組件樹流動。此外還有一個 title 屬性。這兩個屬性組成了 Menu 函式所需的引數。Menu 參數用解構賦值的語法取得傳入的值。</p>
<p>第 39 ~ 41 行用 JavaScript 陣列的 map 方法加入多個 Recipe 組件，這裡使用了展開運算子 { …recipe } 賦予 recipe 的所有屬性 name、ingredients 與 steps。</p>
<p>這些組件是基於將應用程序的數據作為屬性傳遞給 Menu 組件而構造的。 如果我們更改 recipes 陣列並重新渲染 Menu 組件，整個樹狀組件也將引起連鎖反應，而 React 將盡可能有效地更改此 DOM。</p>
<p>數據使我們的 React 組件活起來。沒有 recipes 資料，我們構建的 recipes 的用戶界面是沒有用的。食譜和配料以及清晰的烹飪步驟說明使這樣的應用程序有價值。</p>
<p>我們構建了一個組件樹：數據能夠作為屬性流過組件樹的層次結構。 屬性(properties)是整體構圖的一半。另一半則是狀態(state)。 React 應用程序的狀態由具有更改能力的數據驅動。數據變動，驅動整個 React 應用程序的狀態的變動。</p>
<p>目前資料是死的，我們要讓資料活起來，帶動 React 應用程序的互動性。<span><a href="/2020/09/24/React-State-Management/" title="React State Management">React State Management</a></span></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://1184yang.github.io/2020/09/21/Welcome-to-React/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/1184yang.jpg">
      <meta itemprop="name" content="J.Y. Yang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/09/21/Welcome-to-React/" class="post-title-link" itemprop="url">React 概念</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2020-09-21 07:53:08" itemprop="dateCreated datePublished" datetime="2020-09-21T07:53:08+08:00">2020-09-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2020-10-02 09:34:20" itemprop="dateModified" datetime="2020-10-02T09:34:20+08:00">2020-10-02</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/JavaScript/" itemprop="url" rel="index"><span itemprop="name">JavaScript</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/React/" itemprop="url" rel="index"><span itemprop="name">React</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>React 是一個很小的程式庫，沒有提供構建應用程序需要的所有功能。在 React 中，您可以在 JavaScript 代碼中編寫類似於 HTML 的代碼。 這些標籤需要進行預處理才能在瀏覽器中運行。 為此，你可能需要像 webpack 這樣的構建工具。也需要安裝像 Node.js 這樣的運行環境，以便能建構整個應用程序。</p>
<p>學習這樣整個開發應用程序的架構，需要時間與決心，也常常是我們學習開源應用程序的障礙。React 在剛推出的時候就容許被逐步採用，你可以按自己所需，可多可少的採用 React。不管你是想初步嘗試 React、在簡單的 HTML 網頁上加入互動性，或是實作一個使用 React 驅動的複雜應用程式。</p>
<p>React 不強制要求你使用特定的架構，所以你可以在不同環境中重複使用開發的 React 功能，而不需要重寫原有的程式碼。甚至可以移轉到 React Native 建立行動裝置的原生應用程序。</p>
<p>這裡，我們就從我們熟悉的 Oracle APEX 平台開始。我們可以利用 APEX 伺服器與前端的開發工具加入 React 元件，增進 APEX application 的互動性，也可透過 API 攫取不同來源的網路資源，加強資料的整合性。我們不需要安裝 Node.js 與 webpack。</p>
<p>未來如果需要，這些在 APEX 中開發的 React 元件，也可以很快速地應用在其他架構。</p>
<p>但開始學習 React 之前，你仍必須有堅實的 JavaScript 技術。React 在最近幾年快速的發展，在最近的 2019 年 React 16.8 我們看到了 Hooks 的發布，這是一種在組件(components)之間添加和共享狀態(state)邏輯的新方法，它讓你不必寫 class 就能使用 state 以及其他 React 的功能，讓程式碼更加簡潔。這會大量的使用 JavaScript ES6 的最新語法。</p>
<p>你如果在網路上看到使用 class 的 React 組件，請不要再用。class component 將來可能會被棄用。Function components 與 Hooks 是 React 的未來。</p>
<p>身為一個專業的軟體工程師，不管你伺服端使用何種架構、何種資料庫，你還是都得精於 JavaScript。JavaScript 是目前軟體工程師最重要的技術。</p>
<h3 id="APEX-平台"><a href="#APEX-平台" class="headerlink" title="APEX 平台"></a>APEX 平台</h3><p>這裡使用的 APEX 版本是 5.1.4。如果你使用的環境低於 5.1.4，建議您盡快升級。它除了有較好的使用者介面，伺服端也提供 APEX_JSON Package 支援 JSON。JSON 是目前資料交換最重要的格式，你也須花點時間了解它。</p>
<p>要在 APEX 中能夠運作，我們必須 import 三個 JavaScript 程式庫。你可以將這三個程式庫加入 APEX Page Properties 的 JavaScript &gt; File URLs 中。</p>
<ul>
<li><a href="https://unpkg.com/react@16.13.1/umd/react.development.js" target="_blank" rel="noopener">https://unpkg.com/react@16.13.1/umd/react.development.js</a></li>
<li><a href="https://unpkg.com/react-dom@16.13.1/umd/react-dom.development.js" target="_blank" rel="noopener">https://unpkg.com/react-dom@16.13.1/umd/react-dom.development.js</a></li>
<li><a href="https://unpkg.com/@babel/standalone/babel.min.js" target="_blank" rel="noopener">https://unpkg.com/@babel/standalone/babel.min.js</a></li>
</ul>
<p>我們會在開發 React 時用到 JavaScript ES6 與 React JSX 語法，並不是所有的瀏覽器都支援這些語法，Babel 就是負責這些預處理，將這些語法事先轉譯成瀏覽器看得懂的語法，這稱為 compiling。</p>
<h3 id="React-如何運作的"><a href="#React-如何運作的" class="headerlink" title="React 如何運作的"></a>React 如何運作的</h3><p>使用 React 時，會用 JSX 創建應用程序。JSX 是基於標籤(tag-based)的 JavaScirpt 語法，看起來很像 HTML。使用 React 必須深入探討 JSX。 為了真正理解 React，我們就從其最原子的單元：React 元素(React elements)開始。但我們先不使用 JSX 語法，而先用 React.createElement 來探討 React 元素。</p>
<h5 id="React-Elements"><a href="#React-Elements" class="headerlink" title="React Elements"></a>React Elements</h5><p>我們將了解 React 元素，及如何與其他元素組成自定義的 React 組件(React components)，從而了解 React 組件。</p>
<p>瀏覽器 DOM 由 DOM 元素(DOM elements)組成。 同樣，React DOM 由 React 元素組成。 DOM 元素和 React 元素看起來相同，但實際上卻完全不同。 React 元素是對實際 DOM 元素的外觀的描述。 換句話說，React 元素是有關如何創建瀏覽器 DOM 的指令。</p>
<p>我們可以使用 React.createElement 創建一個 React 元素來代表 h1。</p>
<p>在 APEX Page 建立一個 Region，在 Region Properties 的 Source &gt; Text 加入程式碼:</p>
<figure class="highlight html"><figcaption><span>Region Source Text</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"react-root"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/babel"</span>&gt;</span></span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> hello = React.createElement(<span class="string">"h1"</span>, &#123; <span class="attr">id</span>: <span class="string">"hello"</span> &#125;, <span class="string">"Hello Scott!"</span>);</span></span><br><span class="line">  </span><br><span class="line"><span class="javascript">  ReactDOM.render(hello, <span class="built_in">document</span>.getElementById(<span class="string">"react-root"</span>));</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>第 3 行的 script 標籤的 type 是 text/babel，Babel 將在運行客戶端之前在客戶端上事先編譯代碼。</li>
<li>第 4 行使用 React.createElement 創建一個 React 元素<blockquote>
<ul>
<li>第一個參數定義我們要創建的元素的類型。 在這裡，我們要創建一個 h1 元素。 </li>
<li>第二個參數表示元素的屬性(properties)。 創建的 h1 當前具有 id 為 hello 的屬性 。 </li>
<li>第三個參數表示元素的子元素：在開始和結束標記之間插入的任何節點，在這裡，僅是一些文本字串 “Hello Scott!”。</li>
</ul>
</blockquote>
</li>
<li>第 6 行 ReactDOM.render 會將創建的 React 元素渲染(rendering)為實際的 DOM 元素。並掛載到實際的 DOM 目標節點 react-root。</li>
</ul>
<p>渲染後實際的 DOM 元素如下:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h1</span> <span class="attr">id</span>=<span class="string">"hello"</span>&gt;</span>Hello Scott!<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>React 元素只是一個 JavaScript 描述，告訴 React 如何構造 DOM 元素。如果將它 log 到 Chrome 開發環境的 Console，則它會像:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  $$<span class="keyword">typeof</span>: <span class="built_in">Symbol</span>(react.element),</span><br><span class="line">  key: <span class="literal">null</span>,</span><br><span class="line">  props: &#123;<span class="attr">id</span>: <span class="string">"hello"</span>, <span class="attr">children</span>: <span class="string">"Hello Scott!"</span>&#125;,</span><br><span class="line">  ref: <span class="literal">null</span>,</span><br><span class="line">  type: <span class="string">"h1"</span>,</span><br><span class="line">  _owner: <span class="literal">null</span>,</span><br><span class="line">  _store: &#123;<span class="attr">validated</span>: <span class="literal">false</span>&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所看到的這些字段(fields) 對 React 都很重要，先讓我們仔細看看 type 和 props 字段。</p>
<p>React 元素的 type 屬性告訴 React 創建哪種類型的 HTML 或 SVG 元素。 props 屬性表示構造 DOM 元素所需的數據和子元素。 children，用於將其他嵌套元素顯示為文本。</p>
<h5 id="ReactDOM"><a href="#ReactDOM" class="headerlink" title="ReactDOM"></a>ReactDOM</h5><p>創建 React 元素後，我們希望在瀏覽器中看到它。 ReactDOM 包含了在瀏覽器中呈現 React 元素所需的工具。 在上端程式碼的第 6 行 ReactDOM.render 就是我們所需要的。 在 React 16 以後的版本 render 也可以接受陣列，這會使陣列中的元素都成為同級元素(siblings)。</p>
<h6 id="Children"><a href="#Children" class="headerlink" title="Children"></a>Children</h6><p>React 使用 props.children 渲染子元素。 我們也可以將其他 React 元素渲染為子元素，從而創建樹狀元素。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">React.createElement(</span><br><span class="line">  <span class="string">"ul"</span>,</span><br><span class="line">  <span class="literal">null</span>,</span><br><span class="line">  React.createElement(<span class="string">"li"</span>, <span class="literal">null</span>, <span class="string">"Hello Scott"</span>),</span><br><span class="line">  React.createElement(<span class="string">"li"</span>, <span class="literal">null</span>, <span class="string">"Hello Emily"</span>),</span><br><span class="line">  React.createElement(<span class="string">"li"</span>, <span class="literal">null</span>, <span class="string">"Hello Amanda"</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>渲染後實際的 DOM 元素如下:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">li</span>&gt;</span>Hello Scott<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">li</span>&gt;</span>Hello Emily<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">li</span>&gt;</span>Hello Amanda<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>我們可以改用陣列的 map 映射創建列表項:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> userData = [</span><br><span class="line">  <span class="string">"Scott"</span>,</span><br><span class="line">  <span class="string">"Emily"</span>,</span><br><span class="line">  <span class="string">"Amanda"</span></span><br><span class="line">];</span><br><span class="line">  </span><br><span class="line"><span class="keyword">const</span> hello = React.createElement(</span><br><span class="line">  <span class="string">"ul"</span>,</span><br><span class="line">  <span class="literal">null</span>,</span><br><span class="line">  userData.map(<span class="function">(<span class="params">user, i</span>) =&gt;</span> </span><br><span class="line">    React.createElement(<span class="string">"li"</span>, &#123; <span class="attr">key</span>: i &#125;, <span class="string">`Hello <span class="subst">$&#123;user&#125;</span>`</span>)</span><br><span class="line">  )</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>當我們透過迭代陣列來構建子元素列表時，React 需要每個元素都有一個 key 屬性。 React 使用 key 屬性來更有效率地更新 DOM。</p>
<h5 id="React-Components"><a href="#React-Components" class="headerlink" title="React Components"></a>React Components</h5><p>無論其大小，內容或使用何種技術創建，使用者介面都是由部件(parts)組成的。 按鈕，列表，標題等等。所有這些部件放在一起構成一個使用者介面。有些介面所需的部件都相同，可以重複使用。</p>
<p>在 React 中，我們將每個部件描述為一個組件(component)。組件使我們可以重用相同的結構，然後可以使用不同的數據集填充這些結構。</p>
<p>我們將通過編寫函式來創建組件。該函式將返回使用者介面的可重用部件，也就是 React 組件。</p>
<p>讓我們創建一個返回無序列表的函式。我們將這函式取名為 UsersList。</p>
<figure class="highlight javascript"><figcaption><span>UsersList</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">UsersList</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> React.createElement(</span><br><span class="line">    <span class="string">"ul"</span>,</span><br><span class="line">    <span class="literal">null</span>,</span><br><span class="line">    React.createElement(<span class="string">"li"</span>, <span class="literal">null</span>, <span class="string">"Hello Scott"</span>),</span><br><span class="line">    React.createElement(<span class="string">"li"</span>, <span class="literal">null</span>, <span class="string">"Hello Emily"</span>),</span><br><span class="line">    React.createElement(<span class="string">"li"</span>, <span class="literal">null</span>, <span class="string">"Hello Amanda"</span>)</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ReactDOM.render(</span><br><span class="line">  React.createElement(UsersList, <span class="literal">null</span>, <span class="literal">null</span>),</span><br><span class="line">  <span class="built_in">document</span>.getElementById(<span class="string">"react-root"</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>這個 UsersList 函式返回的就是一個組件，該組件的名稱就稱為 UsersList，該函數輸出如下所示的元素：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">UsersList</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span>&gt;</span>Hello Scott<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span>&gt;</span>Hello Emily<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span>&gt;</span>Hello Amanda<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">UsersList</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>這很酷，但是我們目前將數據硬編碼到組件中。如果我們可以構建一個組件，然後將數據作為屬性傳遞給該組件，然後該組件可以動態呈現數據，這將會更棒。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> userData = [</span><br><span class="line">  <span class="string">"Scott"</span>,</span><br><span class="line">  <span class="string">"Emily"</span>,</span><br><span class="line">  <span class="string">"Amanda"</span></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">UsersList</span>(<span class="params">props</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> React.createElement(</span><br><span class="line">    <span class="string">"ul"</span>,</span><br><span class="line">    <span class="literal">null</span>,</span><br><span class="line">    props.users.map(<span class="function">(<span class="params">user, i</span>) =&gt;</span> </span><br><span class="line">      React.createElement(<span class="string">"li"</span>, &#123; <span class="attr">key</span>: i &#125;, <span class="string">`Hello <span class="subst">$&#123;user&#125;</span>`</span>)</span><br><span class="line">    )</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ReactDOM.render(</span><br><span class="line">  React.createElement(UsersList, &#123; <span class="attr">users</span>: userData &#125;, <span class="literal">null</span>),</span><br><span class="line">  <span class="built_in">document</span>.getElementById(<span class="string">"react-root"</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<ul>
<li>第 7 行在組件函式加一個參數，以便在調用時可以動態的傳入資料。這個參數習慣上都命名為 props，表示這是組件的屬性(properties)。</li>
<li>第 18 行透過 React.createElement <blockquote>
<ul>
<li>第一個參數調用 UsersList 函式，產生一個 UsersList 組件。</li>
<li>第二個參數表示組件的屬性(properties)。 這裡有一個值是 userData 的 users 屬性。所有在這裡定義的屬性被包裝在一個物件中，做為 UsersList 函式的引數。這就是第 7 行 UsersList 函式的參數 props。第 11 行可從 props.users 取得 userData 的資料。</li>
</ul>
</blockquote>
</li>
</ul>
<p>讓我們看一下DOM。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">UsersList</span> <span class="attr">users</span>=<span class="string">"[...]"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">key</span>=<span class="string">"0"</span>&gt;</span>Hello Scott<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">key</span>=<span class="string">"1"</span>&gt;</span>Hello Emily<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">key</span>=<span class="string">"2"</span>&gt;</span>Hello Amanda<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">UsersList</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>注意第 1 行的 users 屬性。</p>
<p>我們還可以通過解構賦值(Destructuring assignment) props 的數據來稍微簡潔代碼，users 預設值為 [ ]，可以防止調用時沒有傳入 users 屬性:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">UsersList</span>(<span class="params">&#123; users = [] &#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> React.createElement(</span><br><span class="line">    <span class="string">"ul"</span>,</span><br><span class="line">    <span class="literal">null</span>,</span><br><span class="line">    users.map(<span class="function">(<span class="params">user, i</span>) =&gt;</span> </span><br><span class="line">      React.createElement(<span class="string">"li"</span>, &#123; <span class="attr">key</span>: i &#125;, <span class="string">`Hello <span class="subst">$&#123;user&#125;</span>`</span>)</span><br><span class="line">    )</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>改用箭頭函式運算式（arrow function expression）:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> UsersList = <span class="function">(<span class="params">&#123; users = [] &#125;</span>) =&gt;</span> (</span><br><span class="line">  React.createElement(</span><br><span class="line">    <span class="string">"ul"</span>,</span><br><span class="line">    <span class="literal">null</span>,</span><br><span class="line">    users.map(<span class="function">(<span class="params">user, i</span>) =&gt;</span> </span><br><span class="line">      React.createElement(<span class="string">"li"</span>, &#123; <span class="attr">key</span>: i &#125;, <span class="string">`Hello <span class="subst">$&#123;user&#125;</span>`</span>)</span><br><span class="line">    )</span><br><span class="line">  )</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>使用 React.createElement 函式是了解 React 如何工作的好方法，但是作為 React 開發人員，這不是我們要做的。為了有效地使用 React，我們還需要做一件事：JSX。<span><a href="/2020/09/22/React-with-JSX/" title="React with JSX">React with JSX</a></span></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://1184yang.github.io/2020/08/20/SQL-GroupBy/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/1184yang.jpg">
      <meta itemprop="name" content="J.Y. Yang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/08/20/SQL-GroupBy/" class="post-title-link" itemprop="url">SQL GROUP BY</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2020-08-20 14:26:40" itemprop="dateCreated datePublished" datetime="2020-08-20T14:26:40+08:00">2020-08-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2020-10-02 09:34:20" itemprop="dateModified" datetime="2020-10-02T09:34:20+08:00">2020-10-02</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Oracle/" itemprop="url" rel="index"><span itemprop="name">Oracle</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/SQL/" itemprop="url" rel="index"><span itemprop="name">SQL</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>GROUP BY 在日常的 SQL 使用中佔了很大的比率，也很重要。但也常常有效能的問題。這裡就從 SELECT Clause 與 GROUP BY 的關聯來看看，與你理解的有何不同 ?</p>
<figure class="highlight sql"><figcaption><span>SQL</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="string">'Hello Tainan'</span> <span class="keyword">as</span> msg,</span><br><span class="line">       <span class="number">1</span> <span class="keyword">as</span> <span class="keyword">num</span>,</span><br><span class="line">       deptno,</span><br><span class="line">       get_dept_name(deptno) dname,</span><br><span class="line">       (<span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">from</span> emp) <span class="keyword">as</span> total,</span><br><span class="line">       <span class="keyword">count</span>(*) <span class="keyword">as</span> cnt</span><br><span class="line">  <span class="keyword">from</span> emp</span><br><span class="line"> <span class="keyword">group</span> <span class="keyword">by</span> deptno</span><br><span class="line">/</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><figcaption><span>Result</span></figcaption><table><tr><td class="code"><pre><span class="line">MSG            NUM  DEPTNO DNAME             TOTAL        CNT</span><br><span class="line">------------ ----- ------- ------------ ---------- ----------</span><br><span class="line">Hello Tainan     1      30 SALES                19          5</span><br><span class="line">Hello Tainan     1      20 RESEARCH             19          5</span><br><span class="line">Hello Tainan     1      70 資訊部                19          3</span><br><span class="line">Hello Tainan     1      40 OPERATIONS           19          2</span><br><span class="line">Hello Tainan     1      10 會計部                19          4</span><br></pre></td></tr></table></figure>

<p>要記得，Oracle Database 10g 以後 GROUP BY 不會自動排序。</p>
<p>上面這段 SQL 你理解了多少? 或與你理解的有何不同 ?</p>
<p>除了 Aggregate function COUNT( ) 外，並不是所有 SELECT clause 上的項目都必須出現在 GROUP BY 裡。這是因為 <strong>SELECT clause 是在執行完 GROUP BY 後，才決定其值</strong>。 除了 deptno 外，其他欄位與在執行 GROUP BY 時都不相干。 也就是說 msg、num、dname、total 與<strong>資料集 emp 毫無關係</strong>，再如何變動 GROUP  BY，這些值都不會變。</p>
<p>以下條列的都有這些特性。</p>
<p><strong>1. Constants</strong> (msg 與 num)<br><strong>2. Scalar values returned by user-defined functions</strong> (dname)<br><strong>3. Analytic Functions (標準的 ISO SQL 稱為 Window Functions)</strong><br><strong>4. Non-correlated scalar subqueries</strong> (total)</p>
<p>了解了這些特性，來看看這段 SQL。</p>
<figure class="highlight sql"><figcaption><span>SQL</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> deptno, <span class="keyword">count</span>(*) cnt,</span><br><span class="line">       <span class="keyword">case</span> <span class="keyword">when</span> <span class="keyword">count</span>(*) <span class="keyword">not</span> <span class="keyword">between</span> <span class="number">4</span> <span class="keyword">and</span> <span class="number">8</span></span><br><span class="line">            <span class="keyword">then</span> <span class="string">'&lt;&lt;&lt;==='</span></span><br><span class="line">            <span class="keyword">else</span> <span class="literal">null</span></span><br><span class="line">        <span class="keyword">end</span> <span class="keyword">as</span> mark</span><br><span class="line">  <span class="keyword">from</span> emp</span><br><span class="line"> <span class="keyword">group</span> <span class="keyword">by</span> deptno</span><br><span class="line"> <span class="keyword">order</span> <span class="keyword">by</span> deptno</span><br><span class="line">/</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><figcaption><span>Result</span></figcaption><table><tr><td class="code"><pre><span class="line"> DEPTNO        CNT MARK</span><br><span class="line">------- ---------- ------</span><br><span class="line">     10          4</span><br><span class="line">     20          5</span><br><span class="line">     30          5</span><br><span class="line">     40          2 &lt;&lt;&lt;===</span><br><span class="line">     70          3 &lt;&lt;&lt;===</span><br></pre></td></tr></table></figure>

<p>CASE 幾乎可出現在任何地方，也很有彈性，這裡與 GROUP BY 欄位無關，所以可出現在 SELECT 中。<strong>注意 CASE 的執行時間點是在 GROUP BY 之後</strong>。</p>
<p>出現在 GROUP BY 的項目也不一定要出現在 SELECT Clause。</p>
<figure class="highlight sql"><figcaption><span>SQL</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(*)</span><br><span class="line">  <span class="keyword">from</span> emp</span><br><span class="line"> <span class="keyword">group</span> <span class="keyword">by</span> deptno</span><br><span class="line">/</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><figcaption><span>Result</span></figcaption><table><tr><td class="code"><pre><span class="line">  COUNT(*)</span><br><span class="line">----------</span><br><span class="line">         5</span><br><span class="line">         5</span><br><span class="line">         3</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><figcaption><span>SQL</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(*)</span><br><span class="line">  <span class="keyword">from</span> emp</span><br><span class="line"> <span class="keyword">group</span> <span class="keyword">by</span> deptno, job</span><br><span class="line">/</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><figcaption><span>Result</span></figcaption><table><tr><td class="code"><pre><span class="line">  COUNT(*)</span><br><span class="line">----------</span><br><span class="line">         1</span><br><span class="line">         2</span><br><span class="line">         3</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>來看看常見的 GROUP BY 的應用，依前面所提的規則，還會有何不同寫法的可能性 ?</p>
<figure class="highlight sql"><figcaption><span>SQL</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> e.deptno, d.dname, <span class="keyword">sum</span>(sal) total</span><br><span class="line">  <span class="keyword">from</span> emp e,</span><br><span class="line">       dept d</span><br><span class="line"> <span class="keyword">where</span> e.deptno = d.deptno</span><br><span class="line"> <span class="keyword">group</span> <span class="keyword">by</span> e.deptno, d.dname</span><br><span class="line">/</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><figcaption><span>Query Execution Plan</span></figcaption><table><tr><td class="code"><pre><span class="line">----------------------------------------------------------------------------</span><br><span class="line">| Id  | Operation           | Name | Rows  | Bytes | Cost (%CPU)| Time     |</span><br><span class="line">----------------------------------------------------------------------------</span><br><span class="line">|   0 | SELECT STATEMENT    |      |    19 |   380 |     7  (15)| 00:00:01 |</span><br><span class="line">|   1 |  HASH GROUP BY      |      |    19 |   380 |     7  (15)| 00:00:01 |</span><br><span class="line">|*  2 |   HASH JOIN         |      |    19 |   380 |     6   (0)| 00:00:01 |</span><br><span class="line">|   3 |    TABLE ACCESS FULL| DEPT |     6 |    78 |     3   (0)| 00:00:01 |</span><br><span class="line">|   4 |    TABLE ACCESS FULL| EMP  |    19 |   133 |     3   (0)| 00:00:01 |</span><br><span class="line">----------------------------------------------------------------------------</span><br></pre></td></tr></table></figure>

<p>這是非常一般的應用，因為需要部門名稱，所以 Join 了 DEPT。Query Execution Plan 顯示 Rows 19，Cost 7。</p>
<p>這可以用 Scalar subquery 來改寫 dname 欄位。</p>
<figure class="highlight sql"><figcaption><span>SQL</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> e.deptno,</span><br><span class="line">       (<span class="keyword">select</span> dname <span class="keyword">from</span> dept d <span class="keyword">where</span> e.deptno = d.deptno) dname,</span><br><span class="line">       <span class="keyword">sum</span>(sal) total</span><br><span class="line">  <span class="keyword">from</span> emp e</span><br><span class="line"> <span class="keyword">group</span> <span class="keyword">by</span> e.deptno</span><br><span class="line">/</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><figcaption><span>Query Execution Plan</span></figcaption><table><tr><td class="code"><pre><span class="line">--------------------------------------------------------------------------------------------</span><br><span class="line">| Id  | Operation                   | Name         | Rows  | Bytes | Cost (%CPU)| Time     |</span><br><span class="line">--------------------------------------------------------------------------------------------</span><br><span class="line">|   0 | SELECT STATEMENT            |              |     5 |    35 |     4  (25)| 00:00:01 |</span><br><span class="line">|   1 |  TABLE ACCESS BY INDEX ROWID| DEPT         |     1 |    13 |     1   (0)| 00:00:01 |</span><br><span class="line">|*  2 |   INDEX UNIQUE SCAN         | SYS_C0036617 |     1 |       |     0   (0)| 00:00:01 |</span><br><span class="line">|   3 |  HASH GROUP BY              |              |     5 |    35 |     4  (25)| 00:00:01 |</span><br><span class="line">|   4 |   TABLE ACCESS FULL         | EMP          |    19 |   133 |     3   (0)| 00:00:01 |</span><br><span class="line">--------------------------------------------------------------------------------------------</span><br></pre></td></tr></table></figure>

<p>將 dname 改用 Scalar Subquery，這樣寫，如果 emp 有百萬筆，會不會有 Loop 的問題 ?</p>
<p>從 Query Execution Plan 中注意它的執行時間點(Id 1 與 2) 在 GROUP BY 之後(Id 3 與 4)，就會比較清楚。也注意 Rows 與 Cost。</p>
<p>效能似乎變得較好，<strong>但要注意的是，上面兩段 SQL 並不完全相同，第二段有 OUTER JOIN 的結果。</strong></p>
<p>使用 GROUP BY 一個常見的錯誤就是 HAVING 的誤用:</p>
<figure class="highlight sql"><figcaption><span>SQL</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> deptno,</span><br><span class="line">       trunc(hiredate, <span class="string">'Y'</span>) <span class="keyword">year</span>,</span><br><span class="line">       <span class="keyword">sum</span>(sal)</span><br><span class="line">  <span class="keyword">from</span> emp</span><br><span class="line"> <span class="keyword">group</span> <span class="keyword">by</span> deptno, trunc(hiredate, <span class="string">'Y'</span>)</span><br><span class="line"><span class="keyword">having</span> trunc(hiredate, <span class="string">'Y'</span>) &gt; <span class="keyword">to_date</span>(<span class="string">'1981'</span>, <span class="string">'yyyy'</span>)</span><br><span class="line"> <span class="keyword">order</span> <span class="keyword">by</span> <span class="number">1</span>, <span class="number">2</span></span><br><span class="line">/</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><figcaption><span>Query Execution Plan</span></figcaption><table><tr><td class="code"><pre><span class="line">-----------------------------------------------------------------------------</span><br><span class="line">| Id  | Operation            | Name | Rows  | Bytes | Cost (%CPU)| Time     |</span><br><span class="line">-----------------------------------------------------------------------------</span><br><span class="line">|   0 | SELECT STATEMENT     |      |     1 |    15 |     5  (40)| 00:00:01 |</span><br><span class="line">|   1 |  SORT ORDER BY       |      |     1 |    15 |     5  (40)| 00:00:01 |</span><br><span class="line">|*  2 |   FILTER             |      |       |       |            |          |</span><br><span class="line">|   3 |    HASH GROUP BY     |      |     1 |    15 |     5  (40)| 00:00:01 |</span><br><span class="line">|   4 |     TABLE ACCESS FULL| EMP  |    19 |   285 |     3   (0)| 00:00:01 |</span><br><span class="line">-----------------------------------------------------------------------------</span><br></pre></td></tr></table></figure>

<p>從 Query Execution Plan 中可以比較清楚的看出來，看它 FILTER(Id 2) 的位置。Filter 不應出現在 GROUP BY 後面。這裡可以將 having 的條件直接移到 where 語句中。不是 Aggregate Function 不應該出現在 HAVING 的地方。</p>
<figure class="highlight sql"><figcaption><span>SQL</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> deptno,</span><br><span class="line">       trunc(hiredate, <span class="string">'Y'</span>) <span class="keyword">year</span>,</span><br><span class="line">       <span class="keyword">sum</span>(sal)</span><br><span class="line">  <span class="keyword">from</span> emp</span><br><span class="line"> <span class="keyword">where</span>  trunc(hiredate, <span class="string">'Y'</span>) &gt; <span class="keyword">to_date</span>(<span class="string">'1981'</span>, <span class="string">'yyyy'</span>)</span><br><span class="line"> <span class="keyword">group</span> <span class="keyword">by</span> deptno, trunc(hiredate, <span class="string">'Y'</span>)</span><br><span class="line"> <span class="keyword">order</span> <span class="keyword">by</span> <span class="number">1</span>, <span class="number">2</span></span><br><span class="line">/</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><figcaption><span>Query Execution Plan</span></figcaption><table><tr><td class="code"><pre><span class="line">----------------------------------------------------------------------------</span><br><span class="line">| Id  | Operation           | Name | Rows  | Bytes | Cost (%CPU)| Time     |</span><br><span class="line">----------------------------------------------------------------------------</span><br><span class="line">|   0 | SELECT STATEMENT    |      |     1 |    15 |     5  (40)| 00:00:01 |</span><br><span class="line">|   1 |  SORT ORDER BY      |      |     1 |    15 |     5  (40)| 00:00:01 |</span><br><span class="line">|   2 |   HASH GROUP BY     |      |     1 |    15 |     5  (40)| 00:00:01 |</span><br><span class="line">|*  3 |    TABLE ACCESS FULL| EMP  |     1 |    15 |     3   (0)| 00:00:01 |</span><br><span class="line">----------------------------------------------------------------------------</span><br></pre></td></tr></table></figure>

<p>Filter(Id 3) 應該在 GROUP BY 之前，這種誤用幾乎很難發覺，但當資料越來越大時效能就有很大的不同。</p>
<p>再看最後一個類似的範例。</p>
<figure class="highlight sql"><figcaption><span>SQL</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> deptno</span><br><span class="line">  <span class="keyword">from</span> emp</span><br><span class="line"> <span class="keyword">where</span>  trunc(hiredate, <span class="string">'Y'</span>) &gt;= <span class="keyword">to_date</span>(<span class="string">'1981'</span>, <span class="string">'yyyy'</span>)</span><br><span class="line"> <span class="keyword">group</span> <span class="keyword">by</span> deptno</span><br><span class="line"><span class="keyword">having</span> <span class="keyword">sum</span>(<span class="keyword">coalesce</span>(comm, <span class="number">0</span>)) &gt; <span class="number">0</span></span><br><span class="line">/</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><figcaption><span>Query Execution Plan</span></figcaption><table><tr><td class="code"><pre><span class="line">----------------------------------------------------------------------------</span><br><span class="line">| Id  | Operation           | Name | Rows  | Bytes | Cost (%CPU)| Time     |</span><br><span class="line">----------------------------------------------------------------------------</span><br><span class="line">|   0 | SELECT STATEMENT    |      |     1 |    13 |     4  (25)| 00:00:01 |</span><br><span class="line">|*  1 |  FILTER             |      |       |       |            |          |</span><br><span class="line">|   2 |   HASH GROUP BY     |      |     1 |    13 |     4  (25)| 00:00:01 |</span><br><span class="line">|*  3 |    TABLE ACCESS FULL| EMP  |     1 |    13 |     3   (0)| 00:00:01 |</span><br><span class="line">----------------------------------------------------------------------------</span><br></pre></td></tr></table></figure>

<p>乍看之下，這似乎很合理，但仔細看一下，sum( ) 只在判斷 comm 是否大於 0，直接就可用在 where。</p>
<figure class="highlight sql"><figcaption><span>SQL</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> deptno</span><br><span class="line">  <span class="keyword">from</span> emp</span><br><span class="line"> <span class="keyword">where</span>  trunc(hiredate, <span class="string">'Y'</span>) &gt;= <span class="keyword">to_date</span>(<span class="string">'1981'</span>, <span class="string">'yyyy'</span>)</span><br><span class="line">   <span class="keyword">and</span> <span class="keyword">coalesce</span>(comm, <span class="number">0</span>) &gt; <span class="number">0</span></span><br><span class="line"> <span class="keyword">group</span> <span class="keyword">by</span> deptno</span><br><span class="line">/</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><figcaption><span>Query Execution Plan</span></figcaption><table><tr><td class="code"><pre><span class="line">---------------------------------------------------------------------------</span><br><span class="line">| Id  | Operation          | Name | Rows  | Bytes | Cost (%CPU)| Time     |</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">|   0 | SELECT STATEMENT   |      |     1 |    13 |     4  (25)| 00:00:01 |</span><br><span class="line">|   1 |  HASH GROUP BY     |      |     1 |    13 |     4  (25)| 00:00:01 |</span><br><span class="line">|*  2 |   TABLE ACCESS FULL| EMP  |     1 |    13 |     3   (0)| 00:00:01 |</span><br><span class="line">---------------------------------------------------------------------------</span><br></pre></td></tr></table></figure>

<p>comm 大於 0，直接就可用在 where。這也是 HAVING 常被誤用的地方。</p>
<p>上面的 SQL 與使用 DISTINCT 沒甚麼不同，但 Query Execution Plan (HASH UNIQUE)卻不太相同。</p>
<figure class="highlight sql"><figcaption><span>SQL</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">distinct</span> deptno</span><br><span class="line">  <span class="keyword">from</span> emp</span><br><span class="line"> <span class="keyword">where</span>  trunc(hiredate, <span class="string">'Y'</span>) &gt;= <span class="keyword">to_date</span>(<span class="string">'1981'</span>, <span class="string">'yyyy'</span>)</span><br><span class="line">   <span class="keyword">and</span> <span class="keyword">coalesce</span>(comm, <span class="number">0</span>) &gt; <span class="number">0</span></span><br><span class="line">/</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><figcaption><span>Query Execution Plan</span></figcaption><table><tr><td class="code"><pre><span class="line">---------------------------------------------------------------------------</span><br><span class="line">| Id  | Operation          | Name | Rows  | Bytes | Cost (%CPU)| Time     |</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">|   0 | SELECT STATEMENT   |      |     1 |    13 |     4  (25)| 00:00:01 |</span><br><span class="line">|   1 |  HASH UNIQUE       |      |     1 |    13 |     4  (25)| 00:00:01 |</span><br><span class="line">|*  2 |   TABLE ACCESS FULL| EMP  |     1 |    13 |     3   (0)| 00:00:01 |</span><br><span class="line">---------------------------------------------------------------------------</span><br></pre></td></tr></table></figure>

<p>遇到有 GROUP BY 的地方要謹慎地思考一下，效能會有很大的不同，最好養成查看 Query Execution Plan 的習慣。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://1184yang.github.io/2020/08/18/Thinking-SQL/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/1184yang.jpg">
      <meta itemprop="name" content="J.Y. Yang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/08/18/Thinking-SQL/" class="post-title-link" itemprop="url">思考 SQL</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2020-08-18 13:27:12" itemprop="dateCreated datePublished" datetime="2020-08-18T13:27:12+08:00">2020-08-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2020-10-02 09:34:20" itemprop="dateModified" datetime="2020-10-02T09:34:20+08:00">2020-10-02</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Oracle/" itemprop="url" rel="index"><span itemprop="name">Oracle</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/SQL/" itemprop="url" rel="index"><span itemprop="name">SQL</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>一樣的結果，可以有不同的 SQL 解法，所以除了科學，SQL 也是一種藝術。現在就來思考幾段 SQL 的藝術。</p>
<p>就用我常用來展示的資料表 DEPT 與 EMP 來展示。當你實際碰到問題時可以回到這裡參閱，看看能不能激發你的思維。 這也是我日常常會參閱的幾段 SQL。</p>
<p>問題很簡單，我們要查詢沒有獎金(comm)的部門。往下看前先試試解解看。</p>
<figure class="highlight plain"><figcaption><span>Table DEPT</span></figcaption><table><tr><td class="code"><pre><span class="line">    DEPTNO DNAME          LOC</span><br><span class="line">---------- -------------- -------------</span><br><span class="line">        10 會計部          紐約</span><br><span class="line">        20 RESEARCH       DALLAS</span><br><span class="line">        30 SALES          台南</span><br><span class="line">        40 OPERATIONS     BOSTON</span><br><span class="line">        70 資訊部          台南</span><br><span class="line">        60 開發部          台南</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><figcaption><span>Table EMP</span></figcaption><table><tr><td class="code"><pre><span class="line">EMPNO ENAME      JOB              MGR HIREDATE            SAL       COMM DEPTNO</span><br><span class="line">----- ---------- --------- ---------- ------------ ---------- ---------- ------</span><br><span class="line"> 7839 KING       PRESIDENT            17-NOV-81          5000                10</span><br><span class="line"> 8907 牸祢        ANALYST         7566 09-DEC-82          9002                10</span><br><span class="line"> 7782 楊建華      MANAGER         7902 09-JUN-81          2400                10</span><br><span class="line"> 7934 楊喆        CLERK           7902 23-JAN-82          1500                10</span><br><span class="line"> 7369 SMITH      CLERK           7902 17-DEC-80          8001                20</span><br><span class="line"> 7902 FORD       ANALYST         7566 03-DEC-81          3000                20</span><br><span class="line"> 7876 ADAMS      CLERK           7788 12-JAN-83          1100                20</span><br><span class="line"> 7566 吳煌珉      MANAGER         7839 02-APR-81          2975                20</span><br><span class="line"> 7788 SCOTT      ANALYST         7566 09-DEC-82         45300                20</span><br><span class="line"> 7900 JAMES      CLERK           7698 03-DEC-81         94998                30</span><br><span class="line"> 7844 하찮고      SALESMAN        7698 08-SEP-81          1500                30</span><br><span class="line"> 7654 葉習堃      SALESMAN        7698 28-SEP-81          1250       1400     30</span><br><span class="line"> 7499 ALLEN      SALESMAN        7698 20-FEB-81          1600        303     30</span><br><span class="line"> 7698 BLAKE      MANAGER1        7839 01-MAY-81          2850        101     30</span><br><span class="line"> 9011 文英蔡      總鋪師           7788 28-AUG-18         77778        180     40</span><br><span class="line"> 7608 馬小九      ANALYST         7788 28-JUN-10          1000        100     40</span><br><span class="line"> 9006 林頂尚      ANALYST         7788 07-MAY-01         66666                70</span><br><span class="line"> 7607 バック      分析師           7788 24-MAR-08         45000        100     70</span><br><span class="line"> 7609 蔡大一      分析師           7788 28-JUN-10         60000                70</span><br></pre></td></tr></table></figure>

<p>資料不多，直接目視就知道只有部門 30、40 與 70 有獎金，因此答案就是: 10(會計部)、20(RESEARCH) 與 60(開發部)。60 開發部雖然沒有員工，但是也應該包括在內。</p>
<p>這就來看看有哪些解法。在這裡的解法所得到的答案都是一樣，但並不表示將這些 SQL 套用到你的系統，所得到的答案都會一樣，因為這牽涉到你系統 Schema 的規劃，例如，欄位的 Contraints 等等。尤其要注意 Nulls 的問題。</p>
<p>Null 是所有資料庫中特有的一個值，不管資料庫是關聯式、或者是新興的非關聯式，都有 Null 值。因此所有的語言也都支援 Null 值的處理，包含 JSON。</p>
<ul>
<li><h4 id="相關性子查詢-Correlated-Subquery"><a href="#相關性子查詢-Correlated-Subquery" class="headerlink" title="相關性子查詢 Correlated Subquery"></a>相關性子查詢 Correlated Subquery</h4></li>
</ul>
<figure class="highlight sql"><figcaption><span>Correlated Subquery</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> dname</span><br><span class="line">  <span class="keyword">from</span> dept d</span><br><span class="line"> <span class="keyword">where</span> <span class="keyword">not</span> <span class="keyword">exists</span> (<span class="keyword">select</span> <span class="literal">null</span></span><br><span class="line">                     <span class="keyword">from</span> emp e</span><br><span class="line">                    <span class="keyword">where</span> e.deptno = d.deptno</span><br><span class="line">                      <span class="keyword">and</span> comm <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span></span><br><span class="line">                  )</span><br><span class="line">;</span><br></pre></td></tr></table></figure>

<p>第 5 行 where 條件句中主查詢(MasterQuery)與子查詢(SubQuery)有了相關性，所以稱為 Correlated Subquery。碰到 NOT 這種反向邏輯總是會腦袋變殘，要好好思考。這種 Correlated Subquery 是最基礎與通常的寫法。結果如下。</p>
<figure class="highlight plain"><figcaption><span>Result</span></figcaption><table><tr><td class="code"><pre><span class="line">DNAME</span><br><span class="line">--------------</span><br><span class="line">開發部</span><br><span class="line">RESEARCH</span><br><span class="line">會計部</span><br></pre></td></tr></table></figure>

<ul>
<li><h4 id="不相關性子查詢-Uncorrelated-Subquery"><a href="#不相關性子查詢-Uncorrelated-Subquery" class="headerlink" title="不相關性子查詢 Uncorrelated Subquery"></a>不相關性子查詢 Uncorrelated Subquery</h4></li>
</ul>
<figure class="highlight sql"><figcaption><span>Uncorrelated Subquery</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> dname</span><br><span class="line">  <span class="keyword">from</span> dept</span><br><span class="line"> <span class="keyword">where</span> deptno <span class="keyword">not</span> <span class="keyword">in</span> (<span class="keyword">select</span> deptno</span><br><span class="line">                        <span class="keyword">from</span> emp</span><br><span class="line">                       <span class="keyword">where</span> comm <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span></span><br><span class="line">                     )</span><br><span class="line">;</span><br></pre></td></tr></table></figure>

<p>主查詢與子查詢沒有直接的相關性，這稱為 Uncorrelated Subquery。</p>
<p>答案一樣這裡就不列出，不要直接複製貼上只看解答，瞄它一眼，然後自己寫寫看。</p>
<p><strong>使用 NOT IN 時，小心 Null 值</strong>，我們先不要中斷這裡的思考，留待後面再來談這個 Nulls 的問題。</p>
<ul>
<li><h4 id="Outer-Join"><a href="#Outer-Join" class="headerlink" title="Outer Join"></a>Outer Join</h4></li>
</ul>
<figure class="highlight sql"><figcaption><span>Outer Join</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> dname</span><br><span class="line">  <span class="keyword">from</span> dept d</span><br><span class="line">       <span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span> emp e</span><br><span class="line">         <span class="keyword">on</span> e.deptno = d.deptno</span><br><span class="line">        <span class="keyword">and</span> e.comm <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span></span><br><span class="line"><span class="keyword">where</span> e.deptno <span class="keyword">is</span> <span class="literal">null</span></span><br><span class="line">;</span><br></pre></td></tr></table></figure>

<ul>
<li><h4 id="集合函数-Aggregate-functions"><a href="#集合函数-Aggregate-functions" class="headerlink" title="集合函数 Aggregate functions"></a>集合函数 Aggregate functions</h4>Aggregate function，平常用的最多的就是 count( ), 你如果以為 Aggregate function 不外乎只有，SUM、AVG、MAX、MIN<br>的功能，那可能就太小看它了。注意，這些集合函數總是與 Group by 同時出現。</li>
</ul>
<blockquote>
<blockquote>
<ul>
<li>SUM</li>
</ul>
</blockquote>
</blockquote>
<figure class="highlight sql"><figcaption><span>Aggregate function SUM</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> dname</span><br><span class="line">  <span class="keyword">from</span> (<span class="keyword">select</span> dname,</span><br><span class="line">               <span class="keyword">case</span> <span class="keyword">when</span> comm <span class="keyword">is</span> <span class="literal">null</span> <span class="keyword">then</span> <span class="number">0</span></span><br><span class="line">                                      <span class="keyword">else</span> <span class="number">1</span></span><br><span class="line">               <span class="keyword">end</span> <span class="keyword">as</span> flag</span><br><span class="line">          <span class="keyword">from</span> emp e,</span><br><span class="line">               dept d</span><br><span class="line">         <span class="keyword">where</span> e.deptno (+) = d.deptno</span><br><span class="line">       ) s</span><br><span class="line"> <span class="keyword">group</span> <span class="keyword">by</span> dname</span><br><span class="line"><span class="keyword">having</span> <span class="keyword">sum</span>(flag) = <span class="number">0</span></span><br><span class="line">;</span><br></pre></td></tr></table></figure>

<p>這與上段類似，但直接省掉 Inline View。</p>
<figure class="highlight sql"><figcaption><span>Aggregate function SUM without Inline View</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> dname</span><br><span class="line">  <span class="keyword">from</span> emp e,</span><br><span class="line">       dept d</span><br><span class="line"> <span class="keyword">where</span> e.deptno (+) = d.deptno</span><br><span class="line"> <span class="keyword">group</span> <span class="keyword">by</span> dname</span><br><span class="line"><span class="keyword">having</span> <span class="keyword">sum</span>(<span class="keyword">case</span> <span class="keyword">when</span> e.comm <span class="keyword">is</span> <span class="literal">null</span> <span class="keyword">then</span> <span class="number">0</span></span><br><span class="line">                                    <span class="keyword">else</span> <span class="number">1</span></span><br><span class="line">           <span class="keyword">end</span>) = <span class="number">0</span></span><br><span class="line">;</span><br></pre></td></tr></table></figure>

<blockquote>
<blockquote>
<ul>
<li>MAX</li>
</ul>
</blockquote>
</blockquote>
<figure class="highlight sql"><figcaption><span>Aggregate function MAX</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> dname</span><br><span class="line">  <span class="keyword">from</span> emp e,</span><br><span class="line">       dept d</span><br><span class="line"> <span class="keyword">where</span> e.deptno (+) = d.deptno</span><br><span class="line"> <span class="keyword">group</span> <span class="keyword">by</span> dname</span><br><span class="line"><span class="keyword">having</span> <span class="keyword">max</span>(<span class="keyword">coalesce</span>(e.comm,<span class="number">0</span>)) = <span class="number">0</span></span><br><span class="line">;</span><br></pre></td></tr></table></figure>

<ul>
<li><h4 id="集合-Set-Operation"><a href="#集合-Set-Operation" class="headerlink" title="集合 Set Operation"></a>集合 Set Operation</h4></li>
</ul>
<figure class="highlight sql"><figcaption><span>Set Operation</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> dname</span><br><span class="line">  <span class="keyword">from</span> dept</span><br><span class="line"><span class="keyword">MINUS</span></span><br><span class="line"><span class="keyword">select</span> dname</span><br><span class="line">  <span class="keyword">from</span> dept d,</span><br><span class="line">       emp e</span><br><span class="line"> <span class="keyword">where</span> d.deptno = e.deptno</span><br><span class="line">   <span class="keyword">and</span> e.comm <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span></span><br><span class="line">;</span><br></pre></td></tr></table></figure>

<ul>
<li><h4 id="Subquery-Factoring"><a href="#Subquery-Factoring" class="headerlink" title="Subquery Factoring"></a>Subquery Factoring</h4></li>
</ul>
<figure class="highlight sql"><figcaption><span>Subquery Factoring</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> x <span class="keyword">as</span> (</span><br><span class="line">  <span class="keyword">select</span> dname,</span><br><span class="line">         <span class="keyword">case</span> <span class="keyword">when</span> comm <span class="keyword">is</span> <span class="literal">null</span> <span class="keyword">then</span> <span class="number">0</span></span><br><span class="line">                                <span class="keyword">else</span> <span class="number">1</span></span><br><span class="line">         <span class="keyword">end</span> <span class="keyword">as</span> flag</span><br><span class="line">    <span class="keyword">from</span> emp e,</span><br><span class="line">         dept d</span><br><span class="line">   <span class="keyword">where</span> e.deptno (+) = d.deptno</span><br><span class="line">)</span><br><span class="line"><span class="keyword">select</span> dname</span><br><span class="line">  <span class="keyword">from</span> x</span><br><span class="line"> <span class="keyword">group</span> <span class="keyword">by</span> dname</span><br><span class="line"><span class="keyword">having</span> <span class="keyword">sum</span>(flag) = <span class="number">0</span></span><br><span class="line">;</span><br></pre></td></tr></table></figure>

<ul>
<li><h4 id="Analytic-function"><a href="#Analytic-function" class="headerlink" title="Analytic function"></a>Analytic function</h4></li>
</ul>
<figure class="highlight sql"><figcaption><span>Analytic function</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> x <span class="keyword">as</span> (</span><br><span class="line">  <span class="keyword">select</span> deptno,</span><br><span class="line">         <span class="keyword">sum</span>(<span class="keyword">coalesce</span>(comm, <span class="number">0</span>)) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> deptno) dept_comm</span><br><span class="line">    <span class="keyword">from</span> emp</span><br><span class="line">)</span><br><span class="line"><span class="keyword">select</span> <span class="keyword">distinct</span> dname</span><br><span class="line">  <span class="keyword">from</span> x,</span><br><span class="line">       dept d</span><br><span class="line"> <span class="keyword">where</span> x.deptno (+) = d.deptno</span><br><span class="line">   <span class="keyword">and</span> <span class="keyword">coalesce</span>(dept_comm, <span class="number">0</span>) = <span class="number">0</span></span><br><span class="line">;</span><br></pre></td></tr></table></figure>

<p>每天都在 SQL 中打滾，應該都看得懂，希望你不是用複製貼上在驗證這些 SQL。現在就給個家庭作業，關掉這個網頁，寫出三個解答。</p>
<h3 id="Nulls-and-NOT-IN"><a href="#Nulls-and-NOT-IN" class="headerlink" title="Nulls and NOT IN"></a>Nulls and NOT IN</h3><p>Nulls 很討厭，它不知是甚麼東西的東西，你也無法把它當成是東西。但它無處不在。我們簡單的來看看。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SQL&gt; select * from car_table;</span><br><span class="line"></span><br><span class="line">CAR                  COLOR</span><br><span class="line">-------------------- --------------------</span><br><span class="line">Car1                 RED</span><br><span class="line">Car2                 BLUE</span><br><span class="line">Car3</span><br><span class="line">Car4</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SQL&gt; select * from car_table where color != &apos;RED&apos;;</span><br><span class="line"></span><br><span class="line">CAR                  COLOR</span><br><span class="line">-------------------- --------------------</span><br><span class="line">Car2                 BLUE</span><br></pre></td></tr></table></figure>

<p>這個答案是正確的嗎? 大部分的人可能不會這麼想!</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SQL&gt; select * from car_table where color != &apos;RED&apos; or color IS NULL;</span><br><span class="line"></span><br><span class="line">CAR                  COLOR</span><br><span class="line">-------------------- --------------------</span><br><span class="line">Car2                 BLUE</span><br><span class="line">Car3</span><br><span class="line">Car4</span><br></pre></td></tr></table></figure>

<p>為了正確的答案，你總必須把 NULL 加到你的每個 Query! 如果需要，可考慮加入 NOT NULL Constraint；NOT NULL Constraint 會影響 Optimizer 的 QUERY REWRITE。對 SQL 的效能也會有影響。尤其要注意，Unique Index 與 Unique Constraint 會有不同的 SQL 效能最佳化。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SQL&gt; desc dual;</span><br><span class="line"> Name                       Null?    Type</span><br><span class="line"> -------------------------- -------- -----------------</span><br><span class="line"> DUMMY                               VARCHAR2(1)</span><br><span class="line"></span><br><span class="line">SQL&gt; select * from dual;</span><br><span class="line"></span><br><span class="line">D</span><br><span class="line">-</span><br><span class="line">X</span><br><span class="line"></span><br><span class="line">SQL&gt; select * from dual where dummy not in (&apos;Y&apos;);</span><br><span class="line"></span><br><span class="line">D</span><br><span class="line">-</span><br><span class="line">X</span><br></pre></td></tr></table></figure>

<p>用最簡單的 DUAL Table 來看 NOT IN 的問題。這裡的 NOT IN 沒有問題。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SQL&gt; select * from dual where dummy not in (&apos;Y&apos;, NULL);</span><br><span class="line"></span><br><span class="line">no rows selected</span><br></pre></td></tr></table></figure>

<p>疑 ? <strong>no rows selected</strong>。使用 NOT IN 時，小心 Null 值。也許這是你要的結果；如果不是，要防止 NULL 值的出現。</p>
<blockquote>
<p>colX <strong>not in</strong> (‘A’, ‘B’, ‘C’) 等於 (colX !=’A’ and colX !=’B’ and colX != ‘C’) 所以如果有 Null 值， colX != NULL  永遠不會是 true。 記得， colX != null 與 colX is not null 是不相同的。</p>
</blockquote>
<blockquote>
<p>colX <strong>in</strong> (‘A’, ‘B’, ‘C’) 等於 (colX =’A’ or colX =’B’ or colX = ‘C’) 所以沒有 Null 的問題。要注意，<strong>IN 與 NOT IN 並不是完全對立的指令</strong>。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SQL&gt; select empno, ename from emp where empno not in (select mgr from emp);</span><br><span class="line"></span><br><span class="line">no rows selected</span><br></pre></td></tr></table></figure>

<p>這裡想找出<strong>非主管人員</strong>，得到的答案是: <strong>怎麼會都是主管 ?</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SQL&gt; select empno, ename from emp where mgr is null;</span><br><span class="line"></span><br><span class="line">     EMPNO ENAME</span><br><span class="line">---------- ----------</span><br><span class="line">      7839 KING</span><br></pre></td></tr></table></figure>

<p>總裁沒有上司。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SQL&gt; select empno, ename</span><br><span class="line">  2  from emp</span><br><span class="line">  3  where empno not in (select mgr from emp where mgr is not null);</span><br><span class="line"></span><br><span class="line">     EMPNO ENAME</span><br><span class="line">---------- ----------</span><br><span class="line">      7369 SMITH</span><br><span class="line">      7499 ALLEN</span><br><span class="line">      7607 バック</span><br><span class="line">      7608 馬小九</span><br><span class="line">      ...</span><br></pre></td></tr></table></figure>

<p>使用 NOT IN 要小心 Nulls。這裡在 Subquery 中要防止 mgr 出現 NULL 值。</p>
<p>在規劃 Schema 時，不該有 NULL 的 Column 就應該要設 NOT NULL Constraint。</p>
<p>相對的，使用 NOT EXISTS 會比較安全。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SQL&gt; select empno, ename</span><br><span class="line">  2  from emp e</span><br><span class="line">  3  where not exists (select null from emp e2 where e.empno = e2.mgr);</span><br><span class="line"></span><br><span class="line">     EMPNO ENAME</span><br><span class="line">---------- ----------</span><br><span class="line">      7369 SMITH</span><br><span class="line">      7499 ALLEN</span><br><span class="line">      7607 バック</span><br><span class="line">      7608 馬小九</span><br><span class="line">      ...</span><br></pre></td></tr></table></figure>

<p>祝，健康快樂。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://1184yang.github.io/2020/08/18/Oracle-Pivot-Clause/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/1184yang.jpg">
      <meta itemprop="name" content="J.Y. Yang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/08/18/Oracle-Pivot-Clause/" class="post-title-link" itemprop="url">Oracle PIVOT 語法範例</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2020-08-18 09:48:10" itemprop="dateCreated datePublished" datetime="2020-08-18T09:48:10+08:00">2020-08-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2020-10-02 09:34:20" itemprop="dateModified" datetime="2020-10-02T09:34:20+08:00">2020-10-02</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Oracle/" itemprop="url" rel="index"><span itemprop="name">Oracle</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/SQL/" itemprop="url" rel="index"><span itemprop="name">SQL</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>上星期有同事問到 Oracle PIVOT 語法的問題，問題如下:</p>
<figure class="highlight sql"><figcaption><span>Pivot</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> t</span><br><span class="line"><span class="keyword">as</span></span><br><span class="line">(<span class="keyword">select</span> dname, job, <span class="keyword">count</span>(*) cnt</span><br><span class="line">   <span class="keyword">from</span> emp e, dept d</span><br><span class="line">  <span class="keyword">where</span> e.deptno = d.deptno</span><br><span class="line">  <span class="keyword">group</span> <span class="keyword">by</span> dname, job</span><br><span class="line">)</span><br><span class="line"><span class="keyword">select</span> *</span><br><span class="line">  <span class="keyword">from</span> t</span><br><span class="line">       <span class="keyword">pivot</span> (</span><br><span class="line">         <span class="keyword">sum</span>(cnt)</span><br><span class="line">         <span class="keyword">for</span> (job) <span class="keyword">in</span> (<span class="string">'ANALYST'</span>, <span class="string">'CLERK'</span>, <span class="string">'SALESMAN'</span>)</span><br><span class="line">      )</span><br><span class="line"> <span class="keyword">order</span> <span class="keyword">by</span> dname</span><br><span class="line">;</span><br></pre></td></tr></table></figure>

<p>這得到的結果 :</p>
<figure class="highlight plain"><figcaption><span>Result</span></figcaption><table><tr><td class="code"><pre><span class="line">DNAME           &apos;ANALYST&apos;    &apos;CLERK&apos; &apos;SALESMAN&apos;</span><br><span class="line">-------------- ---------- ---------- ----------</span><br><span class="line">OPERATIONS              1</span><br><span class="line">RESEARCH                2          2</span><br><span class="line">SALES                              1          3</span><br><span class="line">會計部                   1          1</span><br><span class="line">資訊部                   1</span><br></pre></td></tr></table></figure>

<p>這裡的資料標頭 ‘ANALYST’ 多了 ‘ ‘ 單引號，同事問如何將它去除。</p>
<p>以下就是設定這些標頭的範例。</p>
<figure class="highlight sql"><figcaption><span>Pivot</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> t</span><br><span class="line"><span class="keyword">as</span></span><br><span class="line">(<span class="keyword">select</span> dname, job, <span class="keyword">count</span>(*) cnt</span><br><span class="line">   <span class="keyword">from</span> emp e, dept d</span><br><span class="line">  <span class="keyword">where</span> e.deptno = d.deptno</span><br><span class="line">  <span class="keyword">group</span> <span class="keyword">by</span> dname, job</span><br><span class="line">)</span><br><span class="line"><span class="keyword">select</span> *</span><br><span class="line">  <span class="keyword">from</span> t</span><br><span class="line">       <span class="keyword">pivot</span> (</span><br><span class="line">         <span class="keyword">sum</span>(cnt)</span><br><span class="line">         <span class="keyword">for</span> (job) <span class="keyword">in</span> (<span class="string">'ANALYST'</span> <span class="keyword">as</span> Analyst, <span class="string">'CLERK'</span> <span class="keyword">as</span> Clerk, <span class="string">'SALESMAN'</span> <span class="keyword">as</span> Salesman)</span><br><span class="line">      )</span><br><span class="line"> <span class="keyword">order</span> <span class="keyword">by</span> dname</span><br><span class="line">;</span><br></pre></td></tr></table></figure>

<p>我只修改了第 12 行加入了 AS 語法，就像在 SELECT 語法中一樣。</p>
<figure class="highlight plain"><figcaption><span>Result</span></figcaption><table><tr><td class="code"><pre><span class="line">DNAME             ANALYST      CLERK   SALESMAN</span><br><span class="line">-------------- ---------- ---------- ----------</span><br><span class="line">OPERATIONS              1</span><br><span class="line">RESEARCH                2          2</span><br><span class="line">SALES                              1          3</span><br><span class="line">會計部                   1          1</span><br><span class="line">資訊部                   1</span><br></pre></td></tr></table></figure>

<p>如果想區分大小寫或加入中文，則可以用雙引號 “Analyst “。</p>
<figure class="highlight sql"><figcaption><span>Pivot</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> t</span><br><span class="line"><span class="keyword">as</span></span><br><span class="line">(<span class="keyword">select</span> dname, job, <span class="keyword">count</span>(*) cnt</span><br><span class="line">   <span class="keyword">from</span> emp e, dept d</span><br><span class="line">  <span class="keyword">where</span> e.deptno = d.deptno</span><br><span class="line">  <span class="keyword">group</span> <span class="keyword">by</span> dname, job</span><br><span class="line">)</span><br><span class="line"><span class="keyword">select</span> *</span><br><span class="line">  <span class="keyword">from</span> t</span><br><span class="line">       <span class="keyword">pivot</span> (</span><br><span class="line">         <span class="keyword">sum</span>(cnt)</span><br><span class="line">         <span class="keyword">for</span> (job) <span class="keyword">in</span> (<span class="string">'ANALYST'</span> <span class="keyword">as</span> <span class="string">"分析員"</span>, <span class="string">'CLERK'</span> <span class="keyword">as</span> <span class="string">"營業員"</span>, <span class="string">'SALESMAN'</span> <span class="keyword">as</span> <span class="string">"推銷員"</span>)</span><br><span class="line">      )</span><br><span class="line"> <span class="keyword">order</span> <span class="keyword">by</span> dname</span><br><span class="line">;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><figcaption><span>Result</span></figcaption><table><tr><td class="code"><pre><span class="line">DNAME              分析員     營業員     推銷員</span><br><span class="line">-------------- ---------- ---------- ----------</span><br><span class="line">OPERATIONS              1</span><br><span class="line">RESEARCH                2          2</span><br><span class="line">SALES                              1          3</span><br><span class="line">會計部                   1          1</span><br><span class="line">資訊部                   1</span><br></pre></td></tr></table></figure>

<p>也可以字串合併。</p>
<figure class="highlight sql"><figcaption><span>Pivot</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> t</span><br><span class="line"><span class="keyword">as</span></span><br><span class="line">(<span class="keyword">select</span> dname, job, sal</span><br><span class="line">   <span class="keyword">from</span> emp e, dept d</span><br><span class="line">  <span class="keyword">where</span> e.deptno = d.deptno</span><br><span class="line">)</span><br><span class="line"><span class="keyword">select</span> *</span><br><span class="line">  <span class="keyword">from</span> t</span><br><span class="line">       <span class="keyword">pivot</span> (</span><br><span class="line">         <span class="keyword">min</span>(sal) <span class="keyword">as</span> <span class="string">"最低薪"</span>,</span><br><span class="line">         <span class="keyword">max</span>(sal) <span class="keyword">as</span> <span class="string">"最高薪"</span>,</span><br><span class="line">         <span class="keyword">sum</span>(sal) <span class="keyword">as</span> <span class="string">"合計"</span></span><br><span class="line">         <span class="keyword">for</span> (job) <span class="keyword">in</span> (<span class="string">'CLERK'</span> <span class="keyword">as</span> <span class="string">"營業員"</span>, <span class="string">'SALESMAN'</span> <span class="keyword">as</span> <span class="string">"推銷員"</span>)</span><br><span class="line">      )</span><br><span class="line"> <span class="keyword">order</span> <span class="keyword">by</span> dname</span><br><span class="line">;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><figcaption><span>Result</span></figcaption><table><tr><td class="code"><pre><span class="line">DNAME           營業員_最低薪   營業員_最高薪   營業員_合計   推銷員_最低薪   推銷員_最高薪   推銷員_合計</span><br><span class="line">-------------- ------------- ------------- ----------- ------------- ------------- -----------</span><br><span class="line">OPERATIONS</span><br><span class="line">RESEARCH                1100          8001        9101</span><br><span class="line">SALES                  94998         94998       94998          1250          1600        4350</span><br><span class="line">會計部                   1500          1500        1500</span><br><span class="line">資訊部</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://1184yang.github.io/2020/07/23/Hexo-Quickstart/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/1184yang.jpg">
      <meta itemprop="name" content="J.Y. Yang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/07/23/Hexo-Quickstart/" class="post-title-link" itemprop="url">Hexo 快速入門</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2020-07-23 13:15:25" itemprop="dateCreated datePublished" datetime="2020-07-23T13:15:25+08:00">2020-07-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2020-10-02 09:34:20" itemprop="dateModified" datetime="2020-10-02T09:34:20+08:00">2020-10-02</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/JavaScript/" itemprop="url" rel="index"><span itemprop="name">JavaScript</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Hexo/" itemprop="url" rel="index"><span itemprop="name">Hexo</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><a href="https://hexo.io/zh-tw/" target="_blank" rel="noopener">Hexo</a> 是一個快速，簡單且功能強大的 Blog 框架。 用 <a href="https://zh.wikipedia.org/wiki/Markdown" target="_blank" rel="noopener">Markdown</a> (或其他標記語言) 編寫文章，然後 Hexo 會快速的生成帶有精美主題的靜態文件。</p>
<p>其實除了編寫部落格，也可以利用它來編寫:</p>
<ul>
<li>應用系統的使用者操作手冊</li>
<li>應用系統文件</li>
<li>公佈欄</li>
</ul>
<p>你也可以開啟一個家庭部落格，讓家裡的成員一起來創作。</p>
<p>這裡有一篇快速的參考，<a href="https://ed521.github.io/2019/08/hexo-markdown/" target="_blank" rel="noopener">撰寫 Hexo 文章 - Markdown 語法大全</a>。除了標準的 Markdown 語法，Hexo 也提供了<a href="https://hexo.io/zh-tw/docs/tag-plugins" target="_blank" rel="noopener">標籤外掛（Tag Plugins）</a>。</p>
<p>我們就來快速啟動一個部落格專案，最後則將它部署到雲端。這裡將部署到 <a href="https://github.com/" target="_blank" rel="noopener">GitHub</a>，你也可以選擇其他的雲。</p>
<h4 id="Installation"><a href="#Installation" class="headerlink" title="Installation"></a>Installation</h4><p>安裝 Hexo 伺服器非常簡單，只需要幾分鐘你就可以開始撰寫文章。</p>
<p>但首先你必須先安裝</p>
<ul>
<li><a href="https://nodejs.org/en/download/" target="_blank" rel="noopener">Node.js</a>  </li>
<li><a href="https://git-scm.com/download/win" target="_blank" rel="noopener">Git</a></li>
</ul>
<p>在軟體開發專案中你不能不知道 Git。Node.js 則是最近幾年來最熱門的軟體語言。身為專業的軟體開發人員，建議你一定要花點時間學習。</p>
<p>編寫軟體代碼，則建議你使用 <a href="https://code.visualstudio.com/" target="_blank" rel="noopener">Visual Studio Code</a>。</p>
<p>安裝所有要求後，您可以使用 npm 安裝 Hexo：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ npm install -g hexo-cli</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo --version</span><br><span class="line">hexo: 3.9.0</span><br><span class="line">hexo-cli: 3.1.0</span><br><span class="line">os: Windows_NT 10.0.18363 win32 x64</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>接下來我要用 <a href="https://classic.yarnpkg.com/zh-Hant/" target="_blank" rel="noopener">Yarn</a> 來取代 npm 管理 JavaScript 套件。 Yarn 是 Facebook 與 Exponent、 Google、Tilde 所合作開發的套件管理工具，其功能與 npm 相同，但 npm 最為人詬病的是安裝速度很慢、安裝相依套件沒有順序性，而 Yarn 不但解決了這些問題，還加入了方便的 Cache 機制使套件均只要下載一次，多個專案若使用相同套件時不必重新下載。 官方也表示 Yarn 是快速、安全、可靠的，且能支援多系統。</p>
<h4 id="Setup"><a href="#Setup" class="headerlink" title="Setup"></a>Setup</h4><p>一旦安裝了 Hexo，可以執行以下命令以在目標 &lt;文件夾&gt; 中初始化 Hexo。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo init hello-tainan</span><br><span class="line">INFO  Cloning hexo-starter https://github.com/hexojs/hexo-starter.git</span><br><span class="line">Cloning into <span class="string">'I:\u01\hexo\hello-tainan'</span>...</span><br><span class="line">...</span><br><span class="line">success Saved lockfile.</span><br><span class="line">Done <span class="keyword">in</span> 54.22s.</span><br><span class="line">INFO  Start blogging with Hexo!</span><br></pre></td></tr></table></figure>

<p>這樣我們就初始化了一個 Hexo 部落格專案了。切換到專案目錄，開始安裝套件。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> hello-tainan</span><br><span class="line"></span><br><span class="line">$ yarn install</span><br></pre></td></tr></table></figure>

<p>你如果不想使用 yarn 則可以改用 <strong>npm install</strong>。 可以啟動伺服器了:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ yarn server</span><br><span class="line">yarn run v1.22.4</span><br><span class="line">hexo server</span><br><span class="line">INFO  Start processing</span><br><span class="line">INFO  Hexo is running at http://localhost:4000 . Press Ctrl+C to stop.</span><br></pre></td></tr></table></figure>

<img src="/2020/07/23/Hexo-Quickstart/hexo-0723-01.png" title="Hello World">

<p>這就開始了!</p>
<h4 id="Configuration"><a href="#Configuration" class="headerlink" title="Configuration"></a>Configuration</h4><p>初始化後，您的專案文件夾將如下所示：</p>
<img src="/2020/07/23/Hexo-Quickstart/hexo-0723-02.png" title="hello-tainan project">

<p><strong>package.json</strong></p>
<p>應用程序數據。 預設情況下會安裝 EJS，Stylus 和 Markdown 渲染器。 如果需要，可以稍後將其卸載。</p>
<figure class="highlight json"><figcaption><span>package.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"name"</span>: <span class="string">"hexo-site"</span>,</span><br><span class="line">  <span class="attr">"version"</span>: <span class="string">"0.0.0"</span>,</span><br><span class="line">  <span class="attr">"private"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">"scripts"</span>: &#123;</span><br><span class="line">    <span class="attr">"start"</span>: <span class="string">"hexo server --port 8484"</span>,</span><br><span class="line">    <span class="attr">"build"</span>: <span class="string">"hexo generate"</span>,</span><br><span class="line">    <span class="attr">"clean"</span>: <span class="string">"hexo clean"</span>,</span><br><span class="line">    <span class="attr">"deploy"</span>: <span class="string">"hexo deploy"</span>,</span><br><span class="line">    <span class="attr">"server"</span>: <span class="string">"hexo server"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"hexo"</span>: &#123;</span><br><span class="line">    <span class="attr">"version"</span>: <span class="string">"4.2.1"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"dependencies"</span>: &#123;</span><br><span class="line">    <span class="attr">"hexo"</span>: <span class="string">"^4.2.1"</span>,</span><br><span class="line">    <span class="attr">"hexo-generator-archive"</span>: <span class="string">"^1.0.0"</span>,</span><br><span class="line">    <span class="attr">"hexo-generator-category"</span>: <span class="string">"^1.0.0"</span>,</span><br><span class="line">    <span class="attr">"hexo-generator-index"</span>: <span class="string">"^1.0.0"</span>,</span><br><span class="line">    <span class="attr">"hexo-generator-tag"</span>: <span class="string">"^1.0.0"</span>,</span><br><span class="line">    <span class="attr">"hexo-renderer-ejs"</span>: <span class="string">"^1.0.0"</span>,</span><br><span class="line">    <span class="attr">"hexo-renderer-stylus"</span>: <span class="string">"^1.1.0"</span>,</span><br><span class="line">    <span class="attr">"hexo-renderer-marked"</span>: <span class="string">"^2.0.0"</span>,</span><br><span class="line">    <span class="attr">"hexo-server"</span>: <span class="string">"^1.0.0"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第 6 行是我加入的，可以更改啟動預設的 port。現在可以用 <strong>yarn start</strong> 啟動。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ yarn start</span><br><span class="line">yarn run v1.22.4</span><br><span class="line">hexo server --port 8484</span><br><span class="line">INFO  Start processing</span><br><span class="line">INFO  Hexo is running at http://localhost:8484 . Press Ctrl+C to stop.</span><br></pre></td></tr></table></figure>

<p><strong>_config.yml</strong></p>
<p>站點(Site)配置文件。 您可以在此處配置大多數設置。</p>
<p>在加入新的部落格文章前，這裡先做一些修改 _config.yml 站點配置文件。</p>
<figure class="highlight yaml"><figcaption><span>_config.yml</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="comment"># Site</span></span><br><span class="line"><span class="attr">title:</span> <span class="string">Hello</span> <span class="string">Tainan</span></span><br><span class="line"><span class="attr">subtitle:</span> <span class="string">''</span></span><br><span class="line"><span class="attr">description:</span> <span class="string">''</span></span><br><span class="line"><span class="attr">keywords:</span></span><br><span class="line"><span class="attr">author:</span> <span class="string">Your</span> <span class="string">name</span> </span><br><span class="line"><span class="attr">language:</span> <span class="string">zh-TW</span></span><br><span class="line"><span class="attr">timezone:</span> <span class="string">Asia/Taipei</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="attr">post_asset_folder:</span> <span class="literal">true</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure>

<p>post_asset_folder 設為 true，這會在我們創建一個新的部落格文章時也會同時建立一個同名的目錄，這目錄可用來存放與同名部落格文章有關的檔案，例如，圖片、照片等。</p>
<h4 id="建立新文章"><a href="#建立新文章" class="headerlink" title="建立新文章"></a>建立新文章</h4><p>接下來，我們要在部落格中建立第一篇新文章，你可以直接從現有的範例文章「Hello World」改寫，但我們要使用 new 指令來創建新的文章。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo new <span class="string">"Hello Tainan"</span></span><br><span class="line">INFO  Created: I:\u01\hexo\hello-tainan\<span class="built_in">source</span>\_posts\Hello-Tainan.md</span><br></pre></td></tr></table></figure>

<p>網站馬上發生了變動，左邊的圖示是專案目錄的目前的樣子 source\_posts 目錄下多了 Hello-Tainan 目錄與 Hello-Tainan.md 檔案。右邊圖示則是目前網站的樣子，多了ㄧ篇空白的部落格文章。</p>
<img src="/2020/07/23/Hexo-Quickstart/hexo-0724-01.png" title="Hello World">

<p>開始編輯 Hello-Tainan.md 檔案:</p>
<figure class="highlight markdown"><figcaption><span>Hello-Tainan.md</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">title: Hello Tainan</span><br><span class="line">date: 2020-07-24 09:41:25</span><br><span class="line">tags:</span><br><span class="line">categories:</span><br><span class="line"><span class="bullet">  - </span>[Hello]</span><br><span class="line"><span class="bullet">  - </span>[Hexo]</span><br><span class="line"><span class="bullet">  - </span>[JavaScript]</span><br><span class="line">---</span><br><span class="line"><span class="section">## Hello Tainan, 就從這裡開始!</span></span><br><span class="line"></span><br><span class="line">&#123;% asset_img tainan.png "Hello Tainan" %&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">##### Hello Tainan 程式碼</span></span><br><span class="line"></span><br><span class="line"><span class="code">```</span>javascript hello-tainan.js</span><br><span class="line">const Hello = (name) =&gt; console.log(<span class="code">`Hello $&#123;name&#125;!`</span>);</span><br><span class="line"></span><br><span class="line">Hello('Tainan');</span><br><span class="line"><span class="code">```</span></span><br><span class="line"><span class="code"></span></span><br><span class="line"><span class="code">使用 Hexo [標籤外掛(Tag Plugins)](https://hexo.io/zh-tw/docs/tag-plugins)語法。</span></span><br><span class="line"><span class="code"></span></span><br><span class="line"><span class="code">&#123;% codeblock hello-tainan.js lang:javascript %&#125;</span></span><br><span class="line"><span class="code">const Hello = (name) =&gt; console.log(`Hello $&#123;name&#125;!`);</span></span><br><span class="line"><span class="code"></span></span><br><span class="line"><span class="code">Hello('Tainan');</span></span><br><span class="line"><span class="code">&#123;% endcodeblock %&#125;</span></span><br><span class="line"><span class="code"></span></span><br><span class="line"><span class="code">&#123;% codeblock line_number:false lang:bash %&#125;</span></span><br><span class="line"><span class="code">$ node hello-tainan</span></span><br><span class="line"><span class="code">Hello Tainan!</span></span><br><span class="line"><span class="code">&#123;% endcodeblock %&#125;</span></span><br><span class="line"><span class="code"></span></span><br><span class="line"><span class="code">**Ok! 保持下去!**</span></span><br></pre></td></tr></table></figure>

<p>檔案附屬名是 .md 表示這是一個 markdown 檔案，檔案中使用的都是 markdown 語法。</p>
<ul>
<li>第 5 行加入了 categories 分類，Hexo 會自動分類並在網頁上顯示連結。</li>
<li>第 12 行可以顯示圖檔，圖檔則放在 Hello-Tainan 目錄下。</li>
<li>程式碼可以用 markdown 標準語法，也可以使用 Hexo 標籤外掛語法。</li>
<li>第 22 行可以對外連結。</li>
</ul>
<p>結果應該會如下面的圖示。</p>
<img src="/2020/07/23/Hexo-Quickstart/hexo-0724-02.png" title="Hello World">

<p>OK! 這就可以開始經營你的部落格了。再來我們就要將部落格發佈出去供大家閱讀。</p>
<p>首先我們要先加入 Git 版本控制，然後部署到 GitHub。</p>
<h4 id="Git-與-GitHub"><a href="#Git-與-GitHub" class="headerlink" title="Git 與 GitHub"></a>Git 與 GitHub</h4><h5 id="Git"><a href="#Git" class="headerlink" title="Git"></a>Git</h5><p>Git 是一個版本控制系統。版本控制系統是設計用於跟踪文件隨時間變化狀態的一種軟體。更具體的說，Git 是一個<strong>分布式</strong>的版本控制系統。在 Git 中參與項目的每個程式員不僅能擁有文件的當前狀態，還能擁有項目完整的歷史紀錄。</p>
<h5 id="GitHub"><a href="#GitHub" class="headerlink" title="GitHub"></a>GitHub</h5><p><a href="https://github.com/" target="_blank" rel="noopener">GitHub</a> 是一個網站，你可以向該網站上傳一個 Git 儲存庫(git repository)。使用 GitHub 使你與他人合作一個項目變得更容易，而這歸功於 GitHub 提供的一些機制:</p>
<ul>
<li>一個用以共享儲存庫的集中位置。</li>
<li>一個基於 Web 介面以及分叉(forking)、拉請求(pull request)、提出問題(issue)、維基(WiKi)。</li>
</ul>
<p>這些功能使你和你的團隊能更有效的對所做的修改進行說明、討論和評估。</p>
<p>GitHub 改變了軟體編寫的方式。它最初的構想是為開發者提供一種更容易開發源代碼項目的途徑。目前，GitHub 迅速成為預設的軟體開發平台。GitHub 不僅用於儲存源代碼，還可以對軟體提供詳細說明、討論和評估軟體。</p>
<p>2018 年六月初，在開發者社群中最震撼的新聞事件莫過於微軟以 75 億美元收購軟體原始碼代管服務 GitHub。 2019 年，GitHub 就在官方部落格宣布了兩項更新，首先是將過去按照空間大小收費的私人儲存庫(private repositories)功能提供給免費版用戶使用。並整併「GitHub Enterprise」企業版，企業用戶可以利用 GitHub Connect 安全的在產品間連結，並混合選擇產品功能。</p>
<h4 id="使用-Git-版本控制"><a href="#使用-Git-版本控制" class="headerlink" title="使用 Git 版本控制"></a>使用 Git 版本控制</h4><p>現在我們要將 hello-tainan 專案導入 Git 版本控制，目前專案目錄內容如下:</p>
<img src="/2020/07/23/Hexo-Quickstart/hexo-0724-03.png" title="hello-tainan project">

<p>使用 Git 查閱目前專案的 Git 儲存庫(git repository)狀態。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git status</span><br><span class="line">fatal: not a git repository (or any of the parent directories): .git</span><br></pre></td></tr></table></figure>

<p>報告反映錯誤，專案目前不是一個 Git 儲存庫，我們必須先初始化 Git 儲存庫。初始化 Git 儲存庫之前，先看一下專案目錄下有一個檔案 <strong>.gitignore</strong>，這個檔案是在初始化 Hexo 專案時自動產生的。如果專案目錄下這個檔案不存在，則可手動將它加入。它必須位於專案的根目錄下。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.DS_Store</span><br><span class="line">Thumbs.db</span><br><span class="line">db.json</span><br><span class="line">*.log</span><br><span class="line">node_modules/</span><br><span class="line">public/</span><br><span class="line">.deploy*/</span><br></pre></td></tr></table></figure>

<p>在專案中並不是所有資料都必須做版本控制，例如，暫存檔、日誌資料與一些開源的軟體套件， .gitignore 就是在記載這些可以排除的目錄或檔案。例如，node_modules/ 目錄都是存放一些套件，有些套件會佔據非常大的空間，我們也不會去修改它，所以不必將它納入專案的 Git 儲存庫。</p>
<h5 id="初始化專案"><a href="#初始化專案" class="headerlink" title="初始化專案"></a>初始化專案</h5><p>現在可以初始化專案。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git init</span><br><span class="line">Initialized empty Git repository <span class="keyword">in</span> I:/u01/hexo/hello-tainan/.git/</span><br></pre></td></tr></table></figure>

<p>可以再用 git status 查看目前專案的 Git 儲存庫狀態:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git status</span><br><span class="line">On branch master</span><br><span class="line"></span><br><span class="line">No commits yet  </span><br><span class="line"></span><br><span class="line">Untracked files:</span><br><span class="line">  (use <span class="string">"git add &lt;file&gt;..."</span> to include <span class="keyword">in</span> what will be committed)</span><br><span class="line">        .gitignore</span><br><span class="line">        _config.yml</span><br><span class="line">        package.json</span><br><span class="line">        scaffolds/</span><br><span class="line">        <span class="built_in">source</span>/</span><br><span class="line">        themes/</span><br><span class="line">        useful/</span><br><span class="line">        yarn.lock</span><br><span class="line"></span><br><span class="line">nothing added to commit but untracked files present (use <span class="string">"git add"</span> to track)</span><br></pre></td></tr></table></figure>

<h5 id="第一次提交"><a href="#第一次提交" class="headerlink" title="第一次提交"></a>第一次提交</h5><p>目前還沒有任何的提交(commits), 我們要做第一次提交，將目前專案的檔案存入 Git 儲存庫。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git add .</span><br><span class="line"></span><br><span class="line">$ git commit -m <span class="string">"Begin Project Hello Tainan"</span></span><br><span class="line"></span><br><span class="line">$ git <span class="built_in">log</span> --oneline</span><br><span class="line">fa0c917 (HEAD -&gt; master) Begin Project Hello Tainan</span><br></pre></td></tr></table></figure>

<h5 id="Git-中央儲存庫"><a href="#Git-中央儲存庫" class="headerlink" title="Git 中央儲存庫"></a>Git 中央儲存庫</h5><p>目前專案的 Git 儲存庫只存在本地端的電腦中，如果要與人共享或團隊開發，必須把 Git 儲存庫存入一個中央儲存區。這個中央儲存區可以在公司內部，也可以在雲端。這裡就要使用 GitHub 當中央儲存區與人共享、或協同合作共同開發這個專案。</p>
<ul>
<li>首先到 <a href="https://github.com/" target="_blank" rel="noopener">GitHub</a> 註冊一個帳號。</li>
</ul>
<img src="/2020/07/23/Hexo-Quickstart/hexo-0727-01.png" title="hello-tainan project">

<ul>
<li>登入後，在右上角選擇 New repository。</li>
</ul>
<img src="/2020/07/23/Hexo-Quickstart/hexo-0727-02.png" title="hello-tainan project">

<p>輸入儲存庫名稱，並選擇 Public 分享給所有人。在微軟併購 GitHub 之前 Private 儲存庫是要收費的，現在則已開放。目前我使用的是免費的方案，<a href="https://github.com/pricing" target="_blank" rel="noopener">這裡</a>可以查到收費標準。GitHub 也有提供企業方案。</p>
<img src="/2020/07/23/Hexo-Quickstart/hexo-0727-03.png" title="hello-tainan project">

<p>在新產生的 Public 儲存庫網址下，會有一些快速的指引你如何結合本地端的 Git 儲存庫。</p>
<p>我們在本地端已經有一個存在的 Git 儲存庫，但這個本地端 Git 儲存庫並不是一開始就從中央儲存庫複製(clone)下來的，所以它沒有遠端(remote)容器參照，我們必須手動建立本地端的儲存庫對 GitHub 儲存庫的遠端參照。這個參照名子通常會命名為 <strong>origin</strong>。</p>
<img src="/2020/07/23/Hexo-Quickstart/hexo-0727-04.png" title="hello-tainan project">

<p>回到專案目錄下。新增遠端參照，然後將本地端儲存庫推入(push)遠端儲存庫。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git remote add origin https://github.com/1184yang/hello-tainan.git</span><br><span class="line"></span><br><span class="line">$ git push -u origin master</span><br><span class="line">Enumerating objects: 119, <span class="keyword">done</span>.</span><br><span class="line">Counting objects: 100% (119/119), <span class="keyword">done</span>.</span><br><span class="line">Delta compression using up to 4 threads</span><br><span class="line">Compressing objects: 100% (108/108), <span class="keyword">done</span>.</span><br><span class="line">Writing objects: 100% (119/119), 554.83 KiB | 3.30 MiB/s, <span class="keyword">done</span>.</span><br><span class="line">Total 119 (delta 0), reused 0 (delta 0)</span><br><span class="line">To https://github.com/1184yang/hello-tainan.git</span><br><span class="line"> * [new branch]      master -&gt; master</span><br><span class="line">Branch <span class="string">'master'</span> <span class="built_in">set</span> up to track remote branch <span class="string">'master'</span> from <span class="string">'origin'</span>.</span><br></pre></td></tr></table></figure>

<p>重新載入 <a href="https://github.com/1184yang/hello-tainan" target="_blank" rel="noopener">https://github.com/1184yang/hello-tainan</a> 網頁。</p>
<img src="/2020/07/23/Hexo-Quickstart/hexo-0727-05.png" title="hello-tainan project">

<p>本地端的 Git 儲存庫已經上傳到 GitHub 的儲存庫。 右下角有一個按鈕可以新增 README 專案自述文件。</p>
<p>撰寫 README 使用的是 markdown 語法，下端會有提交按鈕。提交以後 README 內容會出現在網頁下端，這就是專案的自述文件。</p>
<img src="/2020/07/23/Hexo-Quickstart/hexo-0727-06.png" title="hello-tainan project">

<p>現在在本地端的專案目錄下可以用 <strong>git pull</strong> 將 GitHub 儲存庫的異動抓到本地端 Git 儲存庫。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git pull</span><br><span class="line">remote: Enumerating objects: 4, <span class="keyword">done</span>.</span><br><span class="line">remote: Counting objects: 100% (4/4), <span class="keyword">done</span>.</span><br><span class="line">remote: Compressing objects: 100% (3/3), <span class="keyword">done</span>.</span><br><span class="line">remote: Total 3 (delta 1), reused 0 (delta 0), pack-reused 0</span><br><span class="line">Unpacking objects: 100% (3/3), <span class="keyword">done</span>.</span><br><span class="line">From https://github.com/1184yang/hello-tainan</span><br><span class="line">   fa0c917..660d744  master     -&gt; origin/master</span><br><span class="line">Updating fa0c917..660d744</span><br><span class="line">Fast-forward</span><br><span class="line"> README.md | 5 +++++</span><br><span class="line"> 1 file changed, 5 insertions(+)</span><br><span class="line"> create mode 100644 README.md</span><br></pre></td></tr></table></figure>

<p> 現在可以在本地端修改 README.md，提交本地端儲存庫，然後 push 到 GitHub 儲存庫。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git add .</span><br><span class="line"></span><br><span class="line">$ git commit -m <span class="string">"修改 README.md"</span></span><br><span class="line">[master 36da9c2] 修改 README.md</span><br><span class="line"> 1 file changed, 2 insertions(+)</span><br><span class="line"></span><br><span class="line">$ git push origin master</span><br><span class="line">Enumerating objects: 5, <span class="keyword">done</span>.</span><br><span class="line">Counting objects: 100% (5/5), <span class="keyword">done</span>.</span><br><span class="line">Delta compression using up to 4 threads</span><br><span class="line">Compressing objects: 100% (3/3), <span class="keyword">done</span>.</span><br><span class="line">Writing objects: 100% (3/3), 386 bytes | 193.00 KiB/s, <span class="keyword">done</span>.</span><br><span class="line">Total 3 (delta 2), reused 0 (delta 0)</span><br><span class="line">remote: Resolving deltas: 100% (2/2), completed with 2 <span class="built_in">local</span> objects.</span><br><span class="line">remote:</span><br><span class="line">remote: GitHub found 1 vulnerability on 1184yang/hello-tainan<span class="string">'s default branch (1 moderate). To find out more, visit:</span></span><br><span class="line"><span class="string">remote:      https://github.com/1184yang/hello-tainan/network/alert/yarn.lock/minimist/open</span></span><br><span class="line"><span class="string">remote:</span></span><br><span class="line"><span class="string">To https://github.com/1184yang/hello-tainan.git</span></span><br><span class="line"><span class="string">   660d744..36da9c2  master -&gt; master</span></span><br></pre></td></tr></table></figure> 

<p>更新 <a href="https://github.com/1184yang/hello-tainan" target="_blank" rel="noopener">https://github.com/1184yang/hello-tainan</a> 專案網頁可以看到被更新後的 README 內容。</p>
<p>你可以比對本地端與 GitHub 儲存庫的提交編號。</p>
<img src="/2020/07/23/Hexo-Quickstart/hexo-0727-12.png" title="hello-tainan project">

<p>到這裡所描述的，都還沒有談到如何部屬 Hexo 部落格網頁，我們只將專案使用 Git 做版本控制，然後使用一個中央儲存區來共享、並可協同合作一個專案。</p>
<p>接下來就要用這個 Git 儲存庫來部署網頁。</p>
<h4 id="使用-GitHub-Pages-部署網頁"><a href="#使用-GitHub-Pages-部署網頁" class="headerlink" title="使用 GitHub Pages 部署網頁"></a>使用 GitHub Pages 部署網頁</h4><p>我們要使用 <a href="https://pages.github.com/" target="_blank" rel="noopener">GitHub Pages</a> 來部署我們的部落格網誌。</p>
<p>GitHub Pages 是 GitHub 提供的一個網頁寄存服務，於2008年推出。可以用於存放靜態網頁，包括部落格、項目文檔、甚至整本書。</p>
<ul>
<li>登入 GitHub，新增一個 Repository。</li>
</ul>
<img src="/2020/07/23/Hexo-Quickstart/hexo-0727-07.png" title="hello-tainan project">

<p>我們需要修改這個新增的 Repository 的設定。</p>
<img src="/2020/07/23/Hexo-Quickstart/hexo-0727-08.png" title="hello-tainan project">

<p>拉到網頁的底部，選擇一個主題(theme)。可以隨便選擇一個，因為最後會被 Hexo 的主題覆蓋掉。</p>
<img src="/2020/07/23/Hexo-Quickstart/hexo-0727-09.png" title="hello-tainan project">

<img src="/2020/07/23/Hexo-Quickstart/hexo-0727-10.png" title="hello-tainan project">

<p>在瀏覽器網址列輸入 <a href="https://username.github.io/" target="_blank" rel="noopener">https://username.github.io/</a>  (username 是你的 GitHub 帳號)，就能看到剛架好的 GitHub Pages 了。</p>
<img src="/2020/07/23/Hexo-Quickstart/hexo-0727-11.png" title="hello-tainan project">

<h5 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h5><ul>
<li>首先安裝 Hexo git 部署套件</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ yarn add hexo-deployer-git</span><br></pre></td></tr></table></figure>

<ul>
<li>接著修改 Hexo 站點(Site)配置文件 _config.yml。用你的 GitHub 帳戶名稱取代文中的 username。</li>
</ul>
<figure class="highlight yaml"><figcaption><span>_config.yml</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="comment"># URL</span></span><br><span class="line"><span class="comment">## If your site is put in a subdirectory, set url as 'http://yoursite.com/child' and root as '/child/'</span></span><br><span class="line"><span class="attr">url:</span> <span class="string">https://username.github.io/</span> </span><br><span class="line"><span class="attr">root:</span> <span class="string">/</span></span><br><span class="line"></span><br><span class="line"><span class="string">...</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Deployment</span></span><br><span class="line"><span class="comment">## Docs: https://hexo.io/docs/deployment.html</span></span><br><span class="line"><span class="attr">deploy:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">git</span></span><br><span class="line">  <span class="attr">repo:</span> <span class="string">https://github.com/username/username.github.io.git</span></span><br><span class="line">  <span class="attr">branch:</span> <span class="string">master</span></span><br><span class="line"></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure>

<ul>
<li>部署 Hexo</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo clean</span><br><span class="line">$ hexo generate</span><br><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>

<blockquote>
<ul>
<li>hexo clean &nbsp; &nbsp; &nbsp; 清除之前建立的靜態檔案。</li>
<li>hexo generate 建立靜態檔案。</li>
<li>hexo deploy &nbsp; &nbsp; 部署至 Github Pages。</li>
</ul>
</blockquote>
<p>瀏覽器網址列輸入 <a href="https://username.github.io/" target="_blank" rel="noopener">https://username.github.io/</a> (username 是你的 GitHub 帳號)，這就可以開始經營你的部落格了。</p>
<img src="/2020/07/23/Hexo-Quickstart/hexo-0728-01.png" title="hello-tainan project">

<p>透過 GitHub，現在我到哪裡都可以撰寫、發佈部落格。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://1184yang.github.io/2020/07/13/Sequential-Execution/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/1184yang.jpg">
      <meta itemprop="name" content="J.Y. Yang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/07/13/Sequential-Execution/" class="post-title-link" itemprop="url">Node.js 非同步控制流程模式 - 並行限制與循序執行</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2020-07-13 10:39:30" itemprop="dateCreated datePublished" datetime="2020-07-13T10:39:30+08:00">2020-07-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2020-07-25 10:23:30" itemprop="dateModified" datetime="2020-07-25T10:23:30+08:00">2020-07-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/JavaScript/" itemprop="url" rel="index"><span itemprop="name">JavaScript</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Oracle/" itemprop="url" rel="index"><span itemprop="name">Oracle</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/RabbitMQ/" itemprop="url" rel="index"><span itemprop="name">RabbitMQ</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>使用 RabbitMQ 時有時會碰到一個問題，例如從 RabbitMQ 即時接收到 50,000 筆資料要寫到 Oracle 資料庫，RabbitMQ 的消費模式速度非常快，如果沒有限制 Oracle 的 Connection 數量，他會需要 50,000 個 Oracle Connection，通常的結果會是資料庫崩溃，這種大量資料，你不能一筆一筆寫到資料庫，而要用批次處裡的方式，一個 connection 一次寫入 50,000 筆資料。Node.js 的 oracledb 程式庫就有提供 execute 與 executeMany 的方法。</p>
<p>但是 RabbitMQ 的 Playload 有大小的限制，不適合用來一次接收大數據的資料，因此你無法使用 executeMany 方法。通常會是即時的小數據資料，一個繁忙的系統，短時間幾萬筆資料也不是不可能。因此我們必須控制，當收到資料時控制可同時寫到資料庫的平行處理數量，這在 Oracle 的 oracledb 程式庫可以用 Connection Pool 來達成，在 Pool 設定最多 10 Connection，同時間大量的寫入就只能輪流使用這 10 個 Connection，其他的就必須等待，Oracle Connection Pool 內部有自己的 queue 機制。但太多的 queue，等待太久仍然會有 Timeout 的問題。</p>
<p>除了資料庫有這種問題外，只要牽涉到 I/O 都有可能遇到這個問題，例如網路。REST API 就是我們常會碰到的。</p>
<p>這個解決方案的概念就是來自於李玉華所碰到的問題。她會即時從 Oracle 一次送出多筆需求到 RabbitMQ，RabbitMQ 消費後經過一番複雜的處理然後會調用外界的 REST API。單筆處裡都不會有問題，但如果一次處理多筆，對方伺服器就會來不及反應，通常只會有一筆成功，其餘的都會失敗。所以我們要將從 RabbitMQ 接收到的資料，每筆送到 REST API 都可以有一些延遲的設定，避免對方伺服器來不及回應。</p>
<h4 id="Task-Queue"><a href="#Task-Queue" class="headerlink" title="Task Queue"></a>Task Queue</h4><figure class="highlight javascript"><figcaption><span>taskQueue.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TaskQueue</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(concurrency=1) &#123;</span><br><span class="line">    <span class="keyword">this</span>.concurrency = concurrency;</span><br><span class="line">    <span class="keyword">this</span>.running = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">this</span>.queue = [];</span><br><span class="line">    <span class="keyword">this</span>.pushTask = <span class="keyword">this</span>.pushTask.bind(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">this</span>.next = <span class="keyword">this</span>.next.bind(<span class="keyword">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  pushTask(task) &#123;</span><br><span class="line">    <span class="keyword">this</span>.queue.push(task);</span><br><span class="line">    <span class="keyword">this</span>.next();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  next() &#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="keyword">this</span>.running &lt; <span class="keyword">this</span>.concurrency &amp;&amp; <span class="keyword">this</span>.queue.length) &#123;</span><br><span class="line">      <span class="keyword">const</span> task = <span class="keyword">this</span>.queue.shift();</span><br><span class="line">      task(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.running--;</span><br><span class="line">        <span class="keyword">this</span>.next();</span><br><span class="line">      &#125;);</span><br><span class="line">      <span class="keyword">this</span>.running++;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = TaskQueue;</span><br></pre></td></tr></table></figure>

<p>這讓人很驚訝，短短的 27 行的程式碼，功能卻很強大。不限於用在這個例子，你可用在你需要的地方，包含 APEX 上。</p>
<p>這裡用了幾個 JavaScript 幾個重要的基本概念:</p>
<ul>
<li>函式是第一等公民(First class)</li>
<li>延續傳遞風格(Continuation-passing style)，簡稱 CPS</li>
<li>閉包（Closure）</li>
</ul>
<p>使用的方式很簡單，就是把你要處裡的工作依一定的簽章推入 Queue 中，Queue 會依照先進先出的方式逐一執行。</p>
<p>其中的 concurrency 則可以控制並行的數量，預設值是 1，就是一次處理一個工作，會依照先進先出的方式逐一執行，所以如果 concurrency 設為 1，則不管是同步還是非同步的工作，完成的時間也會依序。</p>
<p>concurrency 設為 2，則可以一次同時平行處理 2 筆。雖然也是依照先進先出的方式逐一執行，但如果是非同步的工作，完成的時間就比較難掌控了，因為它一次可以同時處理兩個工作，也許一個平行作業處理比較久，但另一個平行作業已經處理完好幾個工作了。</p>
<h4 id="應用測試"><a href="#應用測試" class="headerlink" title="應用測試"></a>應用測試</h4><p>先用一個簡單的例子來看看如何應用:</p>
<figure class="highlight javascript"><figcaption><span>run.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> TaskQueue = <span class="built_in">require</span>(<span class="string">'./taskQueue'</span>);</span><br><span class="line"><span class="keyword">const</span> runQueue = <span class="keyword">new</span> TaskQueue();</span><br><span class="line"><span class="keyword">const</span> series = [<span class="number">1000</span>, <span class="number">800</span>, <span class="number">600</span>, <span class="number">400</span>, <span class="number">200</span>, <span class="number">900</span>, <span class="number">700</span>, <span class="number">500</span>, <span class="number">300</span>, <span class="number">100</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> doSomething = <span class="function">(<span class="params">data, done</span>) =&gt;</span> &#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">Math</span>.random() &lt; <span class="number">0.2</span>) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`Data: <span class="subst">$&#123;data&#125;</span> ERROR!`</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`Data: <span class="subst">$&#123;data&#125;</span> successfully completed`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    done();</span><br><span class="line">  &#125;, data)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">series.forEach(<span class="function"><span class="params">value</span> =&gt;</span> &#123;</span><br><span class="line">  runQueue.pushTask(<span class="function">(<span class="params">done</span>) =&gt;</span> &#123;</span><br><span class="line">    doSomething(value, done);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>doSomething 是你要處裡的工作，使用 setTimeout 來模擬非同步的工作，函式參數除了你自己的資料參數外，另外需要有一個強迫性的參數，在這個例子中我們取名為 done，你可以取任和的名子。done 將會是個函式，當你的工作完成後需要調用它(第 12 行)，Queue 才會往下執行下一個工作。</p>
<p>這裡我們用 series 陣列模擬從 RabbitMQ 消費的資料，然後經過 doSomething 處理。第 17 行我們將 doSomething 及資料包裹在閉包中，然後將閉包 push 到 Queue 中。所以現在存在 Task Queue 中的其實是一個閉包，所以 queue 中應該會像:</p>
<figure class="highlight javascript"><figcaption><span>Task Queue</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  (done) =&gt; &#123; doSomething(value, done) &#125;,  <span class="comment">// value =&gt; 1000</span></span><br><span class="line">  (done) =&gt; &#123; doSomething(value, done) &#125;,  <span class="comment">// value =&gt; 800</span></span><br><span class="line">  (done) =&gt; &#123; doSomething(value, done) &#125;,  <span class="comment">// value =&gt; 600</span></span><br><span class="line">  ...</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>執行了 runQueue.pushTask( ) 後，taskQueue 會自動執行 Queue 中我們所推入的工作(Task)，taskQueue.js 中的第 17 行從 Queue 中取出先前 push 進去的 task，隨即執行 task，執行時會帶入一個引數(argument):</p>
<figure class="highlight javascript"><figcaption><span>done</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">() =&gt; &#123;</span><br><span class="line">  <span class="keyword">this</span>.running--;</span><br><span class="line">  <span class="keyword">this</span>.next();</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>這個引數是一個函式，也就是 done !!! 要記得，函式是第一等公民，與一般的資料型態沒有甚麼不同，可以是函式的引數，也可以從函式 return 出來。</p>
<figure class="highlight javascript"><figcaption><span>Run</span></figcaption><table><tr><td class="code"><pre><span class="line">$ node run</span><br><span class="line">Data: <span class="number">1000</span> successfully completed</span><br><span class="line">Data: <span class="number">800</span> successfully completed</span><br><span class="line">Data: <span class="number">600</span> ERROR!</span><br><span class="line">Data: <span class="number">400</span> successfully completed</span><br><span class="line">Data: <span class="number">200</span> successfully completed</span><br><span class="line">Data: <span class="number">900</span> successfully completed</span><br><span class="line">Data: <span class="number">700</span> successfully completed</span><br><span class="line">Data: <span class="number">500</span> successfully completed</span><br><span class="line">Data: <span class="number">300</span> successfully completed</span><br><span class="line">Data: <span class="number">100</span> successfully completed</span><br></pre></td></tr></table></figure>

<p>目前 concurrency 是預設的 1, 雖然推入的工作都是非同步的，但完成的時間也都按照推入的順序。</p>
<p>將 concurrency 改為 2 看看結果如何:</p>
<figure class="highlight javascript"><figcaption><span>Task Queue</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> TaskQueue = <span class="built_in">require</span>(<span class="string">'./taskQueue'</span>);</span><br><span class="line"><span class="keyword">const</span> runQueue = <span class="keyword">new</span> TaskQueue(<span class="number">2</span>);</span><br><span class="line">.....</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><figcaption><span>Task Queue</span></figcaption><table><tr><td class="code"><pre><span class="line">$ node run</span><br><span class="line">Data: <span class="number">800</span> successfully completed</span><br><span class="line">Data: <span class="number">1000</span> successfully completed</span><br><span class="line">Data: <span class="number">400</span> ERROR!</span><br><span class="line">Data: <span class="number">600</span> successfully completed</span><br><span class="line">Data: <span class="number">200</span> ERROR!</span><br><span class="line">Data: <span class="number">700</span> successfully completed</span><br><span class="line">Data: <span class="number">900</span> successfully completed</span><br><span class="line">Data: <span class="number">300</span> successfully completed</span><br><span class="line">Data: <span class="number">100</span> successfully completed</span><br><span class="line">Data: <span class="number">500</span> ERROR!</span><br></pre></td></tr></table></figure>

<p>因為同時可以平行處理兩筆工作，雖然是先進先出取出處理，但因工作都是非同步的關係，完成的順序就比較不能掌控了。</p>
<p>到現在的測試都還未延遲兩個工作間的間距，我們想讓前一個工作完成後，延遲一些時間再執行下一個工作。這只需要修改 doSomething 函式中調用 done( ) 的時間。</p>
<figure class="highlight javascript"><figcaption><span>run.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> doSomething = <span class="function">(<span class="params">data, done</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> next = <span class="function"><span class="params">()</span> =&gt;</span> setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> done(), <span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">Math</span>.random() &lt; <span class="number">0.2</span>) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`Data: <span class="subst">$&#123;data&#125;</span> ERROR!`</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`Data: <span class="subst">$&#123;data&#125;</span> successfully completed`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    next();</span><br><span class="line">  &#125;, data)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第 2 行使用 setTimeout 延遲調用 done( ) 的時間，延遲多久由你自己控制。就這樣解決了李玉華的問題。</p>
<h4 id="RabbitMQ-與-Oracle-Database-範例"><a href="#RabbitMQ-與-Oracle-Database-範例" class="headerlink" title="RabbitMQ 與 Oracle Database 範例"></a>RabbitMQ 與 Oracle Database 範例</h4><p>了解了基本運作，現在將它實際應用到 RabbitMQ 與 Oracle 資料庫上。RabbitMQ 與 Oracle 的抽象層在文章後端的原始碼中。</p>
<p>從基本的開始，先不用 taskQueue。</p>
<figure class="highlight javascript"><figcaption><span>receiveToOracle.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> rabbit = <span class="built_in">require</span>(<span class="string">'./rabbitmq'</span>);</span><br><span class="line"><span class="keyword">const</span> oradb = <span class="built_in">require</span>(<span class="string">'./database'</span>);</span><br><span class="line"></span><br><span class="line">rabbit.on(<span class="string">'ready'</span>, <span class="keyword">async</span> (&#123; receive &#125;) =&gt; &#123;</span><br><span class="line">  <span class="keyword">await</span> oradb.initialize();</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'rabbit and db initilized.'</span>);</span><br><span class="line"></span><br><span class="line">  receive(<span class="string">'demo-example'</span>, <span class="string">''</span>, (err, data, ack) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">console</span>.log(err);</span><br><span class="line">    &#125;  </span><br><span class="line">    doSomething(data, ack)</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">doSomething</span>(<span class="params">data, ack=f=&gt;f</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> empno = <span class="built_in">JSON</span>.parse(data).empno;</span><br><span class="line">  <span class="keyword">const</span> statement = <span class="string">"insert into demo_example select empno ||' '|| ename from emp where empno = :empno"</span>;</span><br><span class="line"> </span><br><span class="line">  oradb.doExecute(statement, [empno]).then(</span><br><span class="line">    result =&gt; &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`Result: <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(result)&#125;</span> at: <span class="subst">$&#123;<span class="keyword">new</span> <span class="built_in">Date</span>()&#125;</span>`</span>);</span><br><span class="line">      ack();</span><br><span class="line">    &#125;,</span><br><span class="line">    error =&gt; &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`Result: <span class="subst">$&#123;error.message&#125;</span> at: <span class="subst">$&#123;<span class="keyword">new</span> <span class="built_in">Date</span>()&#125;</span>`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>從 RabbitMQ 消費取的資料，依據資料從 EMP 資料表取得資料，然後新增到 DEMO_EXAMPLE 資料表。</p>
<figure class="highlight javascript"><figcaption><span>Receive to oracle</span></figcaption><table><tr><td class="code"><pre><span class="line">$ node receiveToOracle</span><br><span class="line">rabbit and db initilized.</span><br></pre></td></tr></table></figure>

<p>啟動以後就開始等待 RabbitMQ queue demo-example 的消費。現在送一些資料到 RabbitMQ 的 queue demo-example。</p>
<figure class="highlight javascript"><figcaption><span>sendToQueue.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> rabbit = <span class="built_in">require</span>(<span class="string">'./rabbitmq'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> data = [&#123; <span class="attr">empno</span>: <span class="number">7369</span> &#125;, &#123; <span class="attr">empno</span>: <span class="number">7566</span> &#125;, &#123; <span class="attr">empno</span>: <span class="number">7900</span> &#125;, &#123; <span class="attr">empno</span>: <span class="number">7654</span> &#125;, &#123; <span class="attr">empno</span>: <span class="number">7698</span> &#125;];</span><br><span class="line"></span><br><span class="line">rabbit.on(<span class="string">'ready'</span>, (&#123; sendToQueue &#125;) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> send = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">      data.forEach(<span class="function"><span class="params">value</span> =&gt;</span> &#123;</span><br><span class="line">        sendToQueue(<span class="string">'demo-example'</span>, <span class="built_in">JSON</span>.stringify(value));</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  send();</span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> send(), <span class="number">2000</span>);</span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> send(), <span class="number">3000</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>這裡每隔一秒送出一次，連續送出 3 次，一次 50 筆資料。</p>
<figure class="highlight javascript"><figcaption><span>Send to RabbitMQ queue</span></figcaption><table><tr><td class="code"><pre><span class="line">$ node sendToQueue</span><br></pre></td></tr></table></figure>

<p>回到消費者的終端畫面，很快的在約 3 秒內就消費完畢，寫入 Oracle 資料庫中了。</p>
<figure class="highlight javascript"><figcaption><span>Receive to oracle</span></figcaption><table><tr><td class="code"><pre><span class="line">$ node receiveToOracle</span><br><span class="line">rabbit and db initilized.</span><br><span class="line">Result: &#123;<span class="string">"lastRowid"</span>:<span class="string">"AAC8uRACgAAAJTuAAu"</span>,<span class="string">"rowsAffected"</span>:<span class="number">1</span>&#125; at: Tue Jul <span class="number">14</span> <span class="number">2020</span> <span class="number">08</span>:<span class="number">20</span>:<span class="number">46</span> GMT+<span class="number">0800</span> (GMT+<span class="number">08</span>:<span class="number">00</span>)</span><br><span class="line">Result: &#123;<span class="string">"lastRowid"</span>:<span class="string">"AAC8uRACgAAAJTvAAd"</span>,<span class="string">"rowsAffected"</span>:<span class="number">1</span>&#125; at: Tue Jul <span class="number">14</span> <span class="number">2020</span> <span class="number">08</span>:<span class="number">20</span>:<span class="number">46</span> GMT+<span class="number">0800</span> (GMT+<span class="number">08</span>:<span class="number">00</span>)</span><br><span class="line">Result: &#123;<span class="string">"lastRowid"</span>:<span class="string">"AAC8uRACgAAAJTwAAA"</span>,<span class="string">"rowsAffected"</span>:<span class="number">1</span>&#125; at: Tue Jul <span class="number">14</span> <span class="number">2020</span> <span class="number">08</span>:<span class="number">20</span>:<span class="number">46</span> GMT+<span class="number">0800</span> (GMT+<span class="number">08</span>:<span class="number">00</span>)</span><br><span class="line">Result: &#123;<span class="string">"lastRowid"</span>:<span class="string">"AAC8uRACgAAAJTsAAe"</span>,<span class="string">"rowsAffected"</span>:<span class="number">1</span>&#125; at: Tue Jul <span class="number">14</span> <span class="number">2020</span> <span class="number">08</span>:<span class="number">20</span>:<span class="number">46</span> GMT+<span class="number">0800</span> (GMT+<span class="number">08</span>:<span class="number">00</span>)</span><br><span class="line">.....</span><br></pre></td></tr></table></figure>

<p>因為這裡 Oracle 的 Connection Pool 最大值設為 10, Oracle 火力全開，使用了全部的 10 個 Connection。記得一定要用 Oracle Connection Pool，如果沒有用 Oracle Connection Pool，而直接使用 Oracle Connection，因為 RabbitMQ 非常的快，有可能 Oracle 會嘗試一次開 150 connections，如果是 10,000筆資料，Oracle Database 就崩潰了。</p>
<p>如果你打算使用 Oracle ORDS REST API，千萬千萬不要一次送太多資料，它會每個 Request 嘗試打開一個 connection，資料庫會崩潰!!! <strong>不要試，因為我做過!</strong></p>
<figure class="highlight javascript"><figcaption><span>Oracle Database connections</span></figcaption><table><tr><td class="code"><pre><span class="line">DEMO     <span class="number">40</span>   <span class="number">10</span> XXX\<span class="number">7</span>x0x0x4xP3  <span class="number">10857</span>    INACTIVE    <span class="number">3583</span> node.exe             node.exe</span><br><span class="line">         <span class="number">48</span>   <span class="number">11</span> XXX\<span class="number">7</span>x0x0x4xP3  <span class="number">10869</span>    INACTIVE    <span class="number">2521</span> node.exe             node.exe</span><br><span class="line">         <span class="number">41</span>   <span class="number">40</span> XXX\<span class="number">7</span>x0x0x4xP3  <span class="number">10859</span>    INACTIVE   <span class="number">29317</span> node.exe             node.exe</span><br><span class="line">         <span class="number">42</span>   <span class="number">68</span> XXX\<span class="number">7</span>x0x0x4xP3  <span class="number">10861</span>    INACTIVE   <span class="number">42469</span> node.exe             node.exe</span><br><span class="line">         <span class="number">45</span>  <span class="number">163</span> XXX\<span class="number">7</span>x0x0x4xP3  <span class="number">10863</span>    INACTIVE   <span class="number">49803</span> node.exe             node.exe</span><br><span class="line">         <span class="number">37</span>  <span class="number">166</span> XXX\<span class="number">7</span>x0x0x4xP3  <span class="number">10851</span>    INACTIVE   <span class="number">11951</span> node.exe             node.exe</span><br><span class="line">         <span class="number">38</span>  <span class="number">191</span> XXX\<span class="number">7</span>x0x0x4xP3  <span class="number">10853</span>    INACTIVE   <span class="number">53789</span> node.exe             node.exe</span><br><span class="line">         <span class="number">46</span>  <span class="number">194</span> XXX\<span class="number">7</span>x0x0x4xP3  <span class="number">10865</span>    INACTIVE   <span class="number">35991</span> node.exe             node.exe</span><br><span class="line">         <span class="number">47</span>  <span class="number">225</span> XXX\<span class="number">7</span>x0x0x4xP3  <span class="number">10867</span>    INACTIVE    <span class="number">3537</span> node.exe             node.exe</span><br><span class="line">         <span class="number">39</span>  <span class="number">230</span> XXX\<span class="number">7</span>x0x0x4xP3  <span class="number">10855</span>    INACTIVE    <span class="number">3133</span> node.exe             node.exe</span><br></pre></td></tr></table></figure>

<p>Oracle 會用輪流使用這 10 個 Connection Pool 中的 Connection，等待處裡的則會放入 Oracle Connection 的 queue 中。Connection queue 的預設等待時間 Timeout 是 60 秒，因此如果資料太多，有些就會出現 timeout 錯誤。</p>
<figure class="highlight javascript"><figcaption><span>timeout error</span></figcaption><table><tr><td class="code"><pre><span class="line">error: <span class="built_in">Error</span>: NJS<span class="number">-040</span>: connection request timeout. Request exceeded queueTimeout <span class="keyword">of</span> <span class="number">60000</span></span><br><span class="line">      at Timeout._onTimeout (I:\RabbitMQ\gittemp\rabbit-consume-delay\node_modules\oracledb\lib\pool.js:<span class="number">127</span>:<span class="number">18</span>)</span><br></pre></td></tr></table></figure>

<p>現在加入 taskQueue 來控制延遲。</p>
<figure class="highlight javascript"><figcaption><span>receiveToOracle.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> rabbit = <span class="built_in">require</span>(<span class="string">'./rabbitmq'</span>);</span><br><span class="line"><span class="keyword">const</span> oradb = <span class="built_in">require</span>(<span class="string">'./database'</span>);</span><br><span class="line"><span class="keyword">const</span> TaskQueue = <span class="built_in">require</span>(<span class="string">'./src/taskQueue'</span>);</span><br><span class="line"><span class="keyword">const</span> runQueue = <span class="keyword">new</span> TaskQueue();</span><br><span class="line"></span><br><span class="line">rabbit.on(<span class="string">'ready'</span>, <span class="keyword">async</span> (&#123; receive &#125;) =&gt; &#123;</span><br><span class="line">  <span class="keyword">await</span> oradb.initialize();</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'rabbit and db initilized.'</span>);</span><br><span class="line"></span><br><span class="line">  receive(<span class="string">'demo-example'</span>, <span class="string">''</span>, (err, data, ack) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">console</span>.log(err);</span><br><span class="line">    &#125;</span><br><span class="line">    runQueue.pushTask(<span class="function">(<span class="params">done</span>) =&gt;</span> &#123;</span><br><span class="line">      doSomething(data, ack, done);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">doSomething</span>(<span class="params">data, ack=f=&gt;f, done=f=&gt;f</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> empno = <span class="built_in">JSON</span>.parse(data).empno;</span><br><span class="line">  <span class="keyword">const</span> statement = <span class="string">"insert into demo_example select empno ||' '|| ename from emp where empno = :empno"</span>;</span><br><span class="line">  <span class="keyword">const</span> next = <span class="function"><span class="params">()</span> =&gt;</span> setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> done(), <span class="number">100</span>);</span><br><span class="line">  </span><br><span class="line">  oradb.doExecute(statement, [empno]).then(</span><br><span class="line">    result =&gt; &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`Result: <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(result)&#125;</span> at: <span class="subst">$&#123;<span class="keyword">new</span> <span class="built_in">Date</span>()&#125;</span>`</span>);</span><br><span class="line">      ack();</span><br><span class="line">      next();</span><br><span class="line">    &#125;,</span><br><span class="line">    error =&gt; &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`Result: <span class="subst">$&#123;error.message&#125;</span> at: <span class="subst">$&#123;<span class="keyword">new</span> <span class="built_in">Date</span>()&#125;</span>`</span>);</span><br><span class="line">      <span class="built_in">console</span>.log(error);</span><br><span class="line">      next();</span><br><span class="line">    &#125;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第 14 行將工作推入 Task Queue 中，在第 29 與 34 行延遲調用 done( )。 </p>
<figure class="highlight javascript"><figcaption><span>Receive to oracle</span></figcaption><table><tr><td class="code"><pre><span class="line">$ node receiveToOracle</span><br><span class="line">rabbit and db initilized.</span><br><span class="line">Result: &#123;<span class="string">"lastRowid"</span>:<span class="string">"AAC8vmACgAAAJTvAAA"</span>,<span class="string">"rowsAffected"</span>:<span class="number">1</span>&#125; at: Tue Jul <span class="number">14</span> <span class="number">2020</span> <span class="number">09</span>:<span class="number">28</span>:<span class="number">12</span> GMT+<span class="number">0800</span> (GMT+<span class="number">08</span>:<span class="number">00</span>)</span><br><span class="line">Result: &#123;<span class="string">"lastRowid"</span>:<span class="string">"AAC8vmACgAAAJTvAAB"</span>,<span class="string">"rowsAffected"</span>:<span class="number">1</span>&#125; at: Tue Jul <span class="number">14</span> <span class="number">2020</span> <span class="number">09</span>:<span class="number">28</span>:<span class="number">12</span> GMT+<span class="number">0800</span> (GMT+<span class="number">08</span>:<span class="number">00</span>)</span><br><span class="line">Result: &#123;<span class="string">"lastRowid"</span>:<span class="string">"AAC8vmACgAAAJTvAAC"</span>,<span class="string">"rowsAffected"</span>:<span class="number">1</span>&#125; at: Tue Jul <span class="number">14</span> <span class="number">2020</span> <span class="number">09</span>:<span class="number">28</span>:<span class="number">12</span> GMT+<span class="number">0800</span> (GMT+<span class="number">08</span>:<span class="number">00</span>)</span><br><span class="line">.....</span><br><span class="line">Result: &#123;<span class="string">"lastRowid"</span>:<span class="string">"AAC8vmACgAAAJTvACT"</span>,<span class="string">"rowsAffected"</span>:<span class="number">1</span>&#125; at: Tue Jul <span class="number">14</span> <span class="number">2020</span> <span class="number">09</span>:<span class="number">28</span>:<span class="number">27</span> GMT+<span class="number">0800</span> (GMT+<span class="number">08</span>:<span class="number">00</span>)</span><br><span class="line">Result: &#123;<span class="string">"lastRowid"</span>:<span class="string">"AAC8vmACgAAAJTvACU"</span>,<span class="string">"rowsAffected"</span>:<span class="number">1</span>&#125; at: Tue Jul <span class="number">14</span> <span class="number">2020</span> <span class="number">09</span>:<span class="number">28</span>:<span class="number">27</span> GMT+<span class="number">0800</span> (GMT+<span class="number">08</span>:<span class="number">00</span>)</span><br><span class="line">Result: &#123;<span class="string">"lastRowid"</span>:<span class="string">"AAC8vmACgAAAJTvACV"</span>,<span class="string">"rowsAffected"</span>:<span class="number">1</span>&#125; at: Tue Jul <span class="number">14</span> <span class="number">2020</span> <span class="number">09</span>:<span class="number">28</span>:<span class="number">27</span> GMT+<span class="number">0800</span> (GMT+<span class="number">08</span>:<span class="number">00</span>)</span><br></pre></td></tr></table></figure>

<p>在延遲 0.1 秒下，150 筆資料費了約 15 秒。顯然慢了許多。</p>
<p>現在測試一下大量資料，一次送入 50,000 筆，但是將 concurrency 將設為 5。</p>
<figure class="highlight javascript"><figcaption><span>receiveToOracle.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">const</span> runQueue = <span class="keyword">new</span> TaskQueue(<span class="number">5</span>);</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><figcaption><span>Oracle Database connections</span></figcaption><table><tr><td class="code"><pre><span class="line">DEMO     <span class="number">34</span>   <span class="number">67</span> XXX\<span class="number">7</span>x0x0x4xP3  <span class="number">26301</span>    INACTIVE   <span class="number">48553</span> node.exe             node.exe</span><br><span class="line">         <span class="number">36</span>  <span class="number">131</span> XXX\<span class="number">7</span>x0x0x4xP3  <span class="number">27394</span>    INACTIVE   <span class="number">21051</span> node.exe             node.exe</span><br><span class="line">         <span class="number">37</span>  <span class="number">163</span> XXX\<span class="number">7</span>x0x0x4xP3  <span class="number">27396</span>    INACTIVE   <span class="number">57175</span> node.exe             node.exe</span><br><span class="line">         <span class="number">39</span>  <span class="number">225</span> XXX\<span class="number">7</span>x0x0x4xP3  <span class="number">25052</span>    INACTIVE    <span class="number">3575</span> node.exe             node.exe</span><br></pre></td></tr></table></figure>

<p>這次沒有 Timeout Error，觀察 Oracle Connection Pool  一直都只開 3 ~ 4 個 Connection，延遲 0.1 秒對 Oracle 資料庫是綽綽有餘。</p>
<p>微服務少不了消息代理伺服器， RabbitMQ 與 Apache Kafka 不只提供了資料的一致性整合外，也可以當成系統的緩存區。假如有一個系統同時湧入幾萬個使用者，資料庫反應不及，可以利用 RabbitMQ 或 Apache Kafka 延遲資料的寫入，或者可以透過多個消費者作分流，分散系統的負載。熟悉它，就會有無限的功能應用。</p>
<h4 id="RabbitMQ-與-Oracle-資料庫抽象層"><a href="#RabbitMQ-與-Oracle-資料庫抽象層" class="headerlink" title="RabbitMQ 與 Oracle 資料庫抽象層"></a>RabbitMQ 與 Oracle 資料庫抽象層</h4><figure class="highlight javascript"><figcaption><span>database.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> oracledb = <span class="built_in">require</span>(<span class="string">'oracledb'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> dbconfig = &#123;</span><br><span class="line">  user: <span class="string">"xxxx"</span>,</span><br><span class="line">  password: <span class="string">""</span>xxxxxxxx,</span><br><span class="line">  connectString: <span class="string">"10.11.xx.xxx:1521/xxxx.xxx.com.tw"</span>,</span><br><span class="line">  poolMin: <span class="number">0</span>,</span><br><span class="line">  poolMax: <span class="number">10</span>,</span><br><span class="line">  poolIncrement: <span class="number">1</span>,</span><br><span class="line">  queueMax: <span class="number">-1</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">initialize</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> pool = <span class="keyword">await</span> oracledb.createPool(dbconfig);</span><br><span class="line">    </span><br><span class="line">    process.once(<span class="string">'SIGINT'</span>, () =&gt; &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'oracledb connection pool close.'</span>);</span><br><span class="line">      close();</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(err);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">close</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">await</span> oracledb.getPool().close();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(err);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">doExecute</span>(<span class="params">statement, binds = [], opts = &#123;&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(</span><br><span class="line">    <span class="keyword">async</span> (resolve, reject) =&gt; &#123;</span><br><span class="line">      <span class="keyword">let</span> conn;</span><br><span class="line">      opts.outFormat = oracledb.OBJECT;</span><br><span class="line">      opts.autoCommit = <span class="literal">true</span>;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        conn = <span class="keyword">await</span> oracledb.getConnection();</span><br><span class="line">        <span class="keyword">const</span> result = <span class="keyword">await</span> conn.execute(statement, binds, opts);</span><br><span class="line">        resolve(result);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">catch</span> (err) &#123; reject(&#123; <span class="attr">error</span>: err &#125;); &#125;</span><br><span class="line">      <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (conn) &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">await</span> conn.close();</span><br><span class="line">            <span class="comment">//console.log('ok');</span></span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">catch</span> (err) &#123; <span class="built_in">console</span>.log(err); &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">doExecuteMany</span>(<span class="params">statement, binds = [], opts = &#123;&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="keyword">async</span> (resolve, reject) =&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> conn;</span><br><span class="line">    opts.outFormat = oracledb.OBJECT;</span><br><span class="line">    opts.autoCommit = <span class="literal">true</span>;</span><br><span class="line">    opts.batchErrors = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      conn = <span class="keyword">await</span> oracledb.getConnection();</span><br><span class="line">      <span class="keyword">const</span> result = <span class="keyword">await</span> conn.executeMany(statement, binds, opts);</span><br><span class="line">      resolve(result);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (err) &#123; reject(err); &#125;</span><br><span class="line">    <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (conn) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123; <span class="keyword">await</span> conn.close(); &#125;</span><br><span class="line">        <span class="keyword">catch</span> (err) &#123; <span class="built_in">console</span>.log(err); &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports.initialize = initialize;</span><br><span class="line"><span class="built_in">module</span>.exports.close = close;</span><br><span class="line"><span class="built_in">module</span>.exports.doExecute = doExecute;</span><br><span class="line"><span class="built_in">module</span>.exports.doExecuteMany = doExecuteMany; </span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><figcaption><span>rabbitmq.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> EventEmitter = <span class="built_in">require</span>(<span class="string">'events'</span>).EventEmitter;</span><br><span class="line"><span class="keyword">const</span> amqp = <span class="built_in">require</span>(<span class="string">"amqplib"</span>);</span><br><span class="line"><span class="keyword">const</span> uuid = <span class="built_in">require</span>(<span class="string">'node-uuid'</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RabbitMQ</span> <span class="keyword">extends</span> <span class="title">EventEmitter</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>() &#123;</span><br><span class="line">    <span class="keyword">super</span>();</span><br><span class="line">    <span class="keyword">this</span>.url = <span class="string">"xxxxx:xxxxx@10.11.xx.xxx"</span>;</span><br><span class="line">    <span class="keyword">this</span>.channel = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">this</span>.exchange = <span class="string">"dummy.exchange"</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">this</span>.sendToQueue = <span class="keyword">this</span>.sendToQueue.bind(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">this</span>.publish = <span class="keyword">this</span>.publish.bind(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">this</span>.receive = <span class="keyword">this</span>.receive.bind(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">this</span>.initialize = <span class="keyword">this</span>.initialize.bind(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.initialize().then(<span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">this</span>.emit(<span class="string">'ready'</span>, &#123;</span><br><span class="line">      publish: <span class="keyword">this</span>.publish,</span><br><span class="line">      sendToQueue: <span class="keyword">this</span>.sendToQueue,</span><br><span class="line">      receive: <span class="keyword">this</span>.receive</span><br><span class="line">    &#125;));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  initialize() &#123;</span><br><span class="line">    <span class="keyword">return</span> amqp</span><br><span class="line">      .connect(<span class="string">`amqp://<span class="subst">$&#123;<span class="keyword">this</span>.url&#125;</span>`</span>)</span><br><span class="line">      .then(<span class="function"><span class="params">conn</span> =&gt;</span> &#123;</span><br><span class="line">        process.once(<span class="string">'SIGINT'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">          <span class="built_in">console</span>.log(<span class="string">'amqp connection close.'</span>);</span><br><span class="line">          conn.close();</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> conn.createChannel()</span><br><span class="line">      &#125;)</span><br><span class="line">      .then(<span class="function"><span class="params">channel</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.channel = channel;</span><br><span class="line">      &#125;)</span><br><span class="line">      .catch(<span class="built_in">console</span>.warn)</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  sendToQueue(queue, content) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.channel.sendToQueue(</span><br><span class="line">      queue,</span><br><span class="line">      <span class="keyword">new</span> Buffer.from(content),</span><br><span class="line">      &#123;</span><br><span class="line">        persistent: <span class="literal">true</span>,</span><br><span class="line">        headers: &#123;</span><br><span class="line">          messageId: uuid.v4(),</span><br><span class="line">          api: <span class="string">"Demo-sendToQueue-v1"</span>,</span><br><span class="line">          firstPublish: <span class="built_in">Date</span>.now()</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  publish(exchange, routingKey, content, delay=<span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.channel.publish(</span><br><span class="line">      exchange,</span><br><span class="line">      routingKey,</span><br><span class="line">      <span class="keyword">new</span> Buffer.from(content),</span><br><span class="line">      &#123;</span><br><span class="line">        persistent: <span class="literal">true</span>,</span><br><span class="line">        headers: &#123;</span><br><span class="line">          messageId: uuid(),</span><br><span class="line">          api: <span class="string">"Demo-publish-v1"</span>,</span><br><span class="line">          firstPublish: <span class="built_in">Date</span>.now()</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  receive(queue, routingKey, callback) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.channel.assertQueue(queue)</span><br><span class="line">      .then(<span class="function"><span class="params">q</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.channel.bindQueue(queue, <span class="keyword">this</span>.exchange, routingKey)</span><br><span class="line">      &#125;)</span><br><span class="line">      .then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.channel.consume(queue, msg =&gt; &#123;</span><br><span class="line">          <span class="keyword">let</span> data;</span><br><span class="line">          </span><br><span class="line">          <span class="keyword">if</span> (msg) &#123;</span><br><span class="line">            <span class="comment">// console.log(msg.properties.headers);</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">              data = msg.content.toString();</span><br><span class="line">              callback(<span class="literal">null</span>, data, () =&gt; <span class="keyword">this</span>.channel.ack(msg));</span><br><span class="line">            &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">              callback(err);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            callback(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'amqp consume error.'</span>));</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;, &#123; <span class="attr">noAck</span>: <span class="literal">false</span> &#125;);</span><br><span class="line">      &#125;)</span><br><span class="line">      .catch(<span class="built_in">console</span>.warn);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="keyword">new</span> RabbitMQ();</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://1184yang.github.io/2020/06/12/C-Entity-Framework-Core-2-0-and-PostgreSQL-Provider/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/1184yang.jpg">
      <meta itemprop="name" content="J.Y. Yang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/06/12/C-Entity-Framework-Core-2-0-and-PostgreSQL-Provider/" class="post-title-link" itemprop="url">C# Entity Framework Core 2.0 and PostgreSQL Provider</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2020-06-12 14:13:18" itemprop="dateCreated datePublished" datetime="2020-06-12T14:13:18+08:00">2020-06-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2020-07-25 10:23:30" itemprop="dateModified" datetime="2020-07-25T10:23:30+08:00">2020-07-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/C/" itemprop="url" rel="index"><span itemprop="name">C#</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PostgreSQL/" itemprop="url" rel="index"><span itemprop="name">PostgreSQL</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>上次用 <a href="/2020/06/04/C-Entity-Framework-Core-2-0-and-Oracle-Provider/">C# Entity Framework Core 2.0 與 Oracle Provider</a> 連結至 Oracle 資料庫。這次改用 PostgreSQL 開放式資料庫。所需要做的就是把 Oracle Provider 改用 PostgreSQL Provider。程式碼幾乎都不需要修改。</p>
<p>開始之前，稍微來了解一下 PostgreSQL。</p>
<h3 id="PostgreSQL"><a href="#PostgreSQL" class="headerlink" title="PostgreSQL"></a>PostgreSQL</h3><p>PostgreSQL 自稱是世界上最先進的開源資料庫。 它是一種企業級的關連式資料庫管理系統，與最佳非開源的專有資料庫系統 Oracle，Microsoft SQL Server 和 IBM DB2 相當。 PostgreSQL 的特殊之處在於它不只是資料庫，它也是一個應用程序平台。</p>
<p>PostgreSQL 很快。在基準測試中，PostgreSQL 可以超過或匹配許多其他開放式和專有資料庫的性能。 PostgreSQL 允許使用多種編程語言編寫存儲過程(Stored Procedure)與涵式。 除了 C，SQL 和 PL/pgSQL 的預設包裝語言外，還可以簡單的啟用對其他語言的支援，例如 PL/Perl、PL/Python、PL/V8 (PL/JavaScript)、PL/Ruby 和 PL/R。對多種語言的支援使您可以選擇能夠最好地解決當前問題的結構的語言。</p>
<p>例如，使用 R 進行統計和製圖，使用 Python 調用 Web Services，使用 Python SciPY 程式庫進行科學計算，使用 PL/V8 進行數據驗證，處理字符串和處理 JSON 數據。 更簡單的是，找到所需的開源自由可用的函數，找出其編寫的語言，在 PostgreSQL 中啟用該特定語言，然後復制代碼。</p>
<p>近年來，我們見證了 NoSQL 資料庫的興起（儘管其中很多可能都被炒作了）。儘管 PostgreSQL 從根本上來說是關係型的，但您會發現很多處理非關係型數據的工具。 PostgreSQL 的 ltree 擴展自遠古時代就已經存在並提供圖形支援。hstore 擴展允許您存儲鍵值對 (Key/Value pairs)。JSON 和 JSONB 類型允許存儲類似於 MongoDB 的文檔。在許多方面，PostgreSQL 甚至在該術語誕生之前就已採用 NoSQL！</p>
<p>這裡就從 Oracle 的資料映對，來快速了解 PostgreSQL，將 Oracle 的 DEPT 與 EMP 資料表轉到 PostgreSQL。</p>
<figure class="highlight sql"><figcaption><span>cr_dept.sql</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> dept</span><br><span class="line">(</span><br><span class="line">  deptno <span class="built_in">numeric</span>(<span class="number">4</span>,<span class="number">0</span>),</span><br><span class="line">  dname  <span class="built_in">varchar</span>(<span class="number">32</span>),</span><br><span class="line">  loc    <span class="built_in">varchar</span>(<span class="number">32</span>),</span><br><span class="line">  <span class="keyword">constraint</span> dept_pk primary <span class="keyword">key</span>(deptno)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><figcaption><span>cr_emp.sql</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> emp</span><br><span class="line">(</span><br><span class="line">  empno    <span class="built_in">numeric</span>(<span class="number">4</span>,<span class="number">0</span>),</span><br><span class="line">  ename    <span class="built_in">varchar</span>(<span class="number">32</span>),</span><br><span class="line">  job      <span class="built_in">varchar</span>(<span class="number">32</span>),</span><br><span class="line">  mgr      <span class="built_in">numeric</span>(<span class="number">4</span>,<span class="number">0</span>),</span><br><span class="line">  hiredate <span class="built_in">date</span>,</span><br><span class="line">  sal      <span class="built_in">numeric</span>(<span class="number">10</span>,<span class="number">2</span>),</span><br><span class="line">  comm     <span class="built_in">numeric</span>(<span class="number">10</span>,<span class="number">2</span>),</span><br><span class="line">  deptno   <span class="built_in">numeric</span>(<span class="number">4</span>,<span class="number">0</span>),</span><br><span class="line">  <span class="keyword">constraint</span> emp_pk primary <span class="keyword">key</span>(empno),</span><br><span class="line">  <span class="keyword">constraint</span> emp_dept_fk <span class="keyword">foreign</span> <span class="keyword">key</span> (deptno) <span class="keyword">references</span> dept(deptno),</span><br><span class="line">  <span class="keyword">constraint</span> emp_manager_fk <span class="keyword">foreign</span> <span class="keyword">key</span> (mgr) <span class="keyword">references</span> emp(empno)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">index</span> emp_deptno_ix <span class="keyword">on</span> emp(deptno);</span><br></pre></td></tr></table></figure>

<p>DDL 語法與 Oracle 幾乎一樣，只有資料型態不同，PostgreSQL 的 date 型態只存到日期，要匹配 Oracle 的 date 型態可改用 timestamp 資料型態。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment"># psql 類似 Oracle Sqlplus</span></span><br><span class="line">$ psql -V</span><br><span class="line">psql (PostgreSQL) 12.3 (Ubuntu 12.3-1.pgdg20.04+1)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 登入 PostgreSQL</span></span><br><span class="line">$ psql -U demo -W -d db01</span><br><span class="line">Password:</span><br><span class="line">psql (12.3 (Ubuntu 12.3-1.pgdg20.04+1))</span><br><span class="line">Type "<span class="keyword">help</span><span class="string">" for help.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">db01=&gt; \i cr_dept.sql</span></span><br><span class="line"><span class="string">CREATE TABLE</span></span><br><span class="line"><span class="string">db01=&gt; \i cr_emp.sql</span></span><br><span class="line"><span class="string">CREATE TABLE</span></span><br><span class="line"><span class="string">CREATE INDEX</span></span><br><span class="line"><span class="string">db01=&gt; \d emp</span></span><br><span class="line"><span class="string">                         Table "</span>demo.emp<span class="string">"</span></span><br><span class="line"><span class="string">  Column  |         Type          | Collation | Nullable | Default</span></span><br><span class="line"><span class="string">----------+-----------------------+-----------+----------+---------</span></span><br><span class="line"><span class="string"> empno    | numeric(4,0)          |           | not null |</span></span><br><span class="line"><span class="string"> ename    | character varying(32) |           |          |</span></span><br><span class="line"><span class="string"> job      | character varying(32) |           |          |</span></span><br><span class="line"><span class="string"> mgr      | numeric(4,0)          |           |          |</span></span><br><span class="line"><span class="string"> hiredate | date                  |           |          |</span></span><br><span class="line"><span class="string"> sal      | numeric(10,2)         |           |          |</span></span><br><span class="line"><span class="string"> comm     | numeric(10,2)         |           |          |</span></span><br><span class="line"><span class="string"> deptno   | numeric(4,0)          |           |          |</span></span><br><span class="line"><span class="string">Indexes:</span></span><br><span class="line"><span class="string">    "</span>emp_pk<span class="string">" PRIMARY KEY, btree (empno)</span></span><br><span class="line"><span class="string">    "</span>emp_deptno_ix<span class="string">" btree (deptno)</span></span><br><span class="line"><span class="string">Foreign-key constraints:</span></span><br><span class="line"><span class="string">    "</span>emp_dept_fk<span class="string">" FOREIGN KEY (deptno) REFERENCES dept(deptno)</span></span><br><span class="line"><span class="string">    "</span>emp_manager_fk<span class="string">" FOREIGN KEY (mgr) REFERENCES emp(empno)</span></span><br><span class="line"><span class="string">Referenced by:</span></span><br><span class="line"><span class="string">    TABLE "</span>emp<span class="string">" CONSTRAINT "</span>emp_manager_fk<span class="string">" FOREIGN KEY (mgr) REFERENCES emp(empno)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">db01=&gt;</span></span><br></pre></td></tr></table></figure>

<p>以下的 CSV 格式資料可以用 SQL Developer 從 Oracle 資料庫 export 出來。</p>
<figure class="highlight sql"><figcaption><span>dept.csv</span></figcaption><table><tr><td class="code"><pre><span class="line">10,"會計部","紐約"</span><br><span class="line">20,"RESEARCH","DALLAS"</span><br><span class="line">30,"SALES","CHICAGO"</span><br><span class="line">40,"OPERATIONS","BOSTON"</span><br><span class="line">70,"資訊部","台南 B4"</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><figcaption><span>emp.csv</span></figcaption><table><tr><td class="code"><pre><span class="line">7839,"KING","PRESIDENT",,1981-11-17,5000,,10</span><br><span class="line">7698,"BLAKE","MANAGER1",7839,1981-05-01,2850,101,30</span><br><span class="line">7782,"陳瑞","MANAGER",7902,1981-06-09,2400,,10</span><br><span class="line">7566,"陳賜珉","MANAGER",7839,1981-04-02,2975,,20</span><br><span class="line">7788,"SCOTT","ANALYST",7566,1982-12-09,45300,,20</span><br><span class="line">7902,"FORD","ANALYST",7566,1981-12-03,3000,,20</span><br><span class="line">7369,"SMITH","CLERK",7902,1980-12-17,8001,,20</span><br><span class="line">7499,"ALLEN","SALESMAN",7698,1981-02-20,1600,303,30</span><br><span class="line">7608,"馬小九","ANALYST",7788,2010-06-28,1000,100,40</span><br><span class="line">7654,"葉習堃","SALESMAN",7698,1981-09-28,1250,1400,30</span><br><span class="line">7844,"하찮고","SALESMAN",7698,1981-09-08,1500,,30</span><br><span class="line">7876,"ADAMS","CLERK",7788,1983-01-12,1100,,20</span><br><span class="line">7900,"JAMES","CLERK",7698,1981-12-03,94998,,30</span><br><span class="line">7934,"楊喆","CLERK",7902,1982-01-23,1500,,10</span><br><span class="line">9006,"李逸君","ANALYST",7788,2001-05-07,66666,,70</span><br><span class="line">7607,"バック","分析師",7788,2008-03-24,45000,100,70</span><br><span class="line">7609,"蔡大一","分析師",7788,2010-06-28,60000,,70</span><br><span class="line">9011,"文英蔡","總鋪師",7788,2018-08-28,77778,180,40</span><br><span class="line">8907,"牸祢","ANALYST",7566,1982-12-09,9002,,10</span><br></pre></td></tr></table></figure>

<p>將它 import 到 PostgreSQL。</p>
<figure class="highlight"><figcaption><span>import data</span></figcaption><table><tr><td class="code"><pre><span class="line">db01=&gt; \copy dept from 'dept.csv' with csv;</span><br><span class="line">COPY 5</span><br><span class="line">db01=&gt; \copy emp from 'emp.csv' with csv;</span><br><span class="line">COPY 19</span><br><span class="line">db01=&gt; select * from emp;</span><br><span class="line"> empno | ename  |    job    | mgr  |  hiredate  |   sal    |  comm   | deptno</span><br><span class="line"><span class="comment">-------+--------+-----------+------+------------+----------+---------+--------</span></span><br><span class="line">  7839 | KING   | PRESIDENT |      | 1981-11-17 |  5000.00 |         |     10</span><br><span class="line">  7698 | BLAKE  | MANAGER1  | 7839 | 1981-05-01 |  2850.00 |  101.00 |     30</span><br><span class="line">  7782 | 陳瑞  | MANAGER   | 7902 | 1981-06-09 |  2400.00 |         |     10</span><br><span class="line">  7566 | 陳賜珉 | MANAGER   | 7839 | 1981-04-02 |  2975.00 |         |     20</span><br><span class="line">  7788 | SCOTT  | ANALYST   | 7566 | 1982-12-09 | 45300.00 |         |     20</span><br><span class="line">  7902 | FORD   | ANALYST   | 7566 | 1981-12-03 |  3000.00 |         |     20</span><br><span class="line">  7369 | SMITH  | CLERK     | 7902 | 1980-12-17 |  8001.00 |         |     20</span><br><span class="line">  7499 | ALLEN  | SALESMAN  | 7698 | 1981-02-20 |  1600.00 |  303.00 |     30</span><br><span class="line">  7608 | 馬小九 | ANALYST   | 7788 | 2010-06-28 |  1000.00 |  100.00 |     40</span><br><span class="line">  7654 | 葉習堃 | SALESMAN  | 7698 | 1981-09-28 |  1250.00 | 1400.00 |     30</span><br><span class="line">  7844 | 하찮고 | SALESMAN  | 7698 | 1981-09-08 |  1500.00 |         |     30</span><br><span class="line">  7876 | ADAMS  | CLERK     | 7788 | 1983-01-12 |  1100.00 |         |     20</span><br><span class="line">  7900 | JAMES  | CLERK     | 7698 | 1981-12-03 | 94998.00 |         |     30</span><br><span class="line">  7934 | 楊喆   | CLERK     | 7902 | 1982-01-23 |  1500.00 |         |     10</span><br><span class="line">  9006 | 李逸君 | ANALYST   | 7788 | 2001-05-07 | 66666.00 |         |     70</span><br><span class="line">  7607 | バック | 分析師    | 7788 | 2008-03-24 | 45000.00 |  100.00 |     70</span><br><span class="line">  7609 | 蔡大一 | 分析師    | 7788 | 2010-06-28 | 60000.00 |         |     70</span><br><span class="line">  9011 | 文英蔡 | 總鋪師    | 7788 | 2018-08-28 | 77778.00 |  180.00 |     40</span><br><span class="line">  8907 | 牸祢   | ANALYST   | 7566 | 1982-12-09 |  9002.00 |         |     10</span><br><span class="line">(19 rows)</span><br><span class="line"></span><br><span class="line">db01=&gt;</span><br></pre></td></tr></table></figure>

<p>PostgreSQL 提供 JSON 和許多支援的功能。JSON 已成為 Web 應用程序中最流行的數據交換格式。也支援 JSONB 資料型態。</p>
<figure class="highlight sql"><figcaption><span>row_to_json</span></figcaption><table><tr><td class="code"><pre><span class="line">db01=&gt; select row_to_json(emp) as employee from emp;</span><br><span class="line"></span><br><span class="line">                                                          employee                                                          </span><br><span class="line"><span class="comment">-----------------------------------------------------------------------------------------------------------------------------</span></span><br><span class="line"> &#123;"empno":7839,"ename":"KING","job":"PRESIDENT","mgr":null,"hiredate":"1981-11-17","sal":5000.00,"comm":null,"deptno":10&#125;</span><br><span class="line"> &#123;"empno":7698,"ename":"BLAKE","job":"MANAGER1","mgr":7839,"hiredate":"1981-05-01","sal":2850.00,"comm":101.00,"deptno":30&#125;</span><br><span class="line"> &#123;"empno":7782,"ename":"陳瑞","job":"MANAGER","mgr":7902,"hiredate":"1981-06-09","sal":2400.00,"comm":null,"deptno":10&#125;</span><br><span class="line"> &#123;"empno":7566,"ename":"陳賜珉","job":"MANAGER","mgr":7839,"hiredate":"1981-04-02","sal":2975.00,"comm":null,"deptno":20&#125;</span><br><span class="line"> &#123;"empno":7788,"ename":"SCOTT","job":"ANALYST","mgr":7566,"hiredate":"1982-12-09","sal":45300.00,"comm":null,"deptno":20&#125;</span><br><span class="line"> &#123;"empno":7902,"ename":"FORD","job":"ANALYST","mgr":7566,"hiredate":"1981-12-03","sal":3000.00,"comm":null,"deptno":20&#125;</span><br><span class="line"> &#123;"empno":7369,"ename":"SMITH","job":"CLERK","mgr":7902,"hiredate":"1980-12-17","sal":8001.00,"comm":null,"deptno":20&#125;</span><br><span class="line"> &#123;"empno":7499,"ename":"ALLEN","job":"SALESMAN","mgr":7698,"hiredate":"1981-02-20","sal":1600.00,"comm":303.00,"deptno":30&#125;</span><br><span class="line"> &#123;"empno":7608,"ename":"馬小九","job":"ANALYST","mgr":7788,"hiredate":"2010-06-28","sal":1000.00,"comm":100.00,"deptno":40&#125;</span><br><span class="line"> &#123;"empno":7654,"ename":"葉習堃","job":"SALESMAN","mgr":7698,"hiredate":"1981-09-28","sal":1250.00,"comm":1400.00,"deptno":30&#125;</span><br><span class="line"> &#123;"empno":7844,"ename":"하찮고","job":"SALESMAN","mgr":7698,"hiredate":"1981-09-08","sal":1500.00,"comm":null,"deptno":30&#125;</span><br><span class="line"> &#123;"empno":7876,"ename":"ADAMS","job":"CLERK","mgr":7788,"hiredate":"1983-01-12","sal":1100.00,"comm":null,"deptno":20&#125;</span><br><span class="line"> &#123;"empno":7900,"ename":"JAMES","job":"CLERK","mgr":7698,"hiredate":"1981-12-03","sal":94998.00,"comm":null,"deptno":30&#125;</span><br><span class="line"> &#123;"empno":7934,"ename":"楊喆","job":"CLERK","mgr":7902,"hiredate":"1982-01-23","sal":1500.00,"comm":null,"deptno":10&#125;</span><br><span class="line"> &#123;"empno":9006,"ename":"李逸君","job":"ANALYST","mgr":7788,"hiredate":"2001-05-07","sal":66666.00,"comm":null,"deptno":70&#125;</span><br><span class="line"> &#123;"empno":7607,"ename":"バック","job":"分析師","mgr":7788,"hiredate":"2008-03-24","sal":45000.00,"comm":100.00,"deptno":70&#125;</span><br><span class="line"> &#123;"empno":7609,"ename":"蔡大一","job":"分析師","mgr":7788,"hiredate":"2010-06-28","sal":60000.00,"comm":null,"deptno":70&#125;</span><br><span class="line"> &#123;"empno":9011,"ename":"文英蔡","job":"總鋪師","mgr":7788,"hiredate":"2018-08-28","sal":77778.00,"comm":180.00,"deptno":40&#125;</span><br><span class="line"> &#123;"empno":8907,"ename":"牸祢","job":"ANALYST","mgr":7566,"hiredate":"1982-12-09","sal":9002.00,"comm":null,"deptno":10&#125;</span><br><span class="line">(19 rows)</span><br></pre></td></tr></table></figure>

<p>PostgreSQL 資料準備好了，回到 C#。</p>
<h4 id="C-EFCore-2-0-and-PostgreSQL-Provider"><a href="#C-EFCore-2-0-and-PostgreSQL-Provider" class="headerlink" title="C# EFCore 2.0 and PostgreSQL Provider"></a>C# EFCore 2.0 and PostgreSQL Provider</h4><p>開啟 VS Code 建立一個專案。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ &gt; dotnet new console --name PgEFCoreSample</span><br><span class="line"></span><br><span class="line">$ &gt; <span class="built_in">cd</span> PgEFCoreSample</span><br><span class="line"></span><br><span class="line">$ PgEFCoreSample&gt; dotnet run</span><br><span class="line">Hello World!</span><br></pre></td></tr></table></figure>

<p>首先要安裝專案需要的 NuGet Packages，這裡只需要將 Oracle Provider 換成 PostgreSQL Provider。這裡因用的 PostgreSQL Provider Npgsql.EntityFrameworkCore.PostgreSQL 版本比較新，所以也將 Microsoft EntityFramework Core 的版本更新。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ PgEFCoreSample&gt; dotnet add package Npgsql.EntityFrameworkCore.PostgreSQL --version 3.1.4 </span><br><span class="line"></span><br><span class="line">$ PgEFCoreSample&gt; dotnet add package Microsoft.EntityFrameworkCore.Design --version 3.1.4</span><br><span class="line"></span><br><span class="line">$ PgEFCoreSample&gt; dotnet add package Microsoft.EntityFrameworkCore.Relational --version 3.1.4</span><br><span class="line"></span><br><span class="line">$ PgEFCoreSample&gt; dotnet add package Microsoft.Extensions.Configuration.Json --version 3.1.4</span><br></pre></td></tr></table></figure>

<p>現在專案目錄下的 PgEFCoreSample.csproj 檔案應該如下:</p>
<figure class="highlight xml"><figcaption><span>PgEFCoreSample.csproj</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Project</span> <span class="attr">Sdk</span>=<span class="string">"Microsoft.NET.Sdk"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">PropertyGroup</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">OutputType</span>&gt;</span>Exe<span class="tag">&lt;/<span class="name">OutputType</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">TargetFramework</span>&gt;</span>netcoreapp3.1<span class="tag">&lt;/<span class="name">TargetFramework</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">PropertyGroup</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">ItemGroup</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">PackageReference</span> <span class="attr">Include</span>=<span class="string">"Microsoft.EntityFrameworkCore.Design"</span> <span class="attr">Version</span>=<span class="string">"3.1.4"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">IncludeAssets</span>&gt;</span>runtime; build; native; contentfiles; analyzers; buildtransitive<span class="tag">&lt;/<span class="name">IncludeAssets</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">PrivateAssets</span>&gt;</span>all<span class="tag">&lt;/<span class="name">PrivateAssets</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">PackageReference</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">PackageReference</span> <span class="attr">Include</span>=<span class="string">"Microsoft.EntityFrameworkCore.Relational"</span> <span class="attr">Version</span>=<span class="string">"3.1.4"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">PackageReference</span> <span class="attr">Include</span>=<span class="string">"Microsoft.Extensions.Configuration.Json"</span> <span class="attr">Version</span>=<span class="string">"3.1.4"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">PackageReference</span> <span class="attr">Include</span>=<span class="string">"Npgsql.EntityFrameworkCore.PostgreSQL"</span> <span class="attr">Version</span>=<span class="string">"3.1.4"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">ItemGroup</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">Project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>這裡也將 PostgreSQL 資料庫的連結資料放在 appsettings.json</p>
<figure class="highlight json"><figcaption><span>appsettings.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"Data"</span>: &#123;</span><br><span class="line">    <span class="attr">"DefaultConnection"</span>: &#123;</span><br><span class="line">      <span class="attr">"ConnectionString"</span>: <span class="string">"Host=10.11.xx.xxx;Database=db01;Username=xxx;Password=xxxxxxxxxx"</span> </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>PostgreSQL 資料庫位在我的 PC 虛擬機 Ubuntu Linux 上，只開放在上班時間。</p>
<h4 id="反向工程-Reverse-Engineering"><a href="#反向工程-Reverse-Engineering" class="headerlink" title="反向工程 (Reverse Engineering)"></a>反向工程 (Reverse Engineering)</h4><p>直接使用反向工程產生資料模型。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ PgEFCoreSample&gt; dotnet ef dbcontext scaffold <span class="string">"Host=10.11.xx.xxx;Database=db01;Username=xxxx;Password=xxxxxxxx"</span> Npgsql.EntityFrameworkCore.PostgreSQL --table emp --table dept -o Models -f </span><br></pre></td></tr></table></figure>

<p>它會在專案目錄下產生子目錄 Models 與 Dept.cs、Emp.cs 與 db01Context.cs。 這裡只要修改 db01Context.cs 的資料庫連結資料，讀取 appsettings.json 的設定。其他都不用動。</p>
<figure class="highlight csharp"><figcaption><span>Models/db01Context.cs</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> Microsoft.EntityFrameworkCore;</span><br><span class="line"><span class="keyword">using</span> Microsoft.EntityFrameworkCore.Metadata;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Extensions.Configuration;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Extensions.Configuration.Json;</span><br><span class="line">.....</span><br><span class="line">        optionsBuilder.UseNpgsql(GetConnectionString());</span><br><span class="line">.....</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">string</span> <span class="title">GetConnectionString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">      <span class="keyword">var</span> configurationBuilder = <span class="keyword">new</span> ConfigurationBuilder()</span><br><span class="line">        .SetBasePath(Directory.GetCurrentDirectory())</span><br><span class="line">        .AddJsonFile(<span class="string">"appsettings.json"</span>);</span><br><span class="line">      IConfiguration config = configurationBuilder.Build();</span><br><span class="line">      <span class="keyword">string</span> connectionString = config[<span class="string">"Data:DefaultConnection:ConnectionString"</span>];</span><br><span class="line">      <span class="keyword">return</span> connectionString;</span><br><span class="line">    &#125;</span><br><span class="line">.....</span><br></pre></td></tr></table></figure>

<h4 id="資料讀取"><a href="#資料讀取" class="headerlink" title="資料讀取"></a>資料讀取</h4><figure class="highlight csharp"><figcaption><span>program.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> PgEFCoreSample.Models;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">PgEFCoreSample</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="keyword">string</span>[] args</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">      Console.WriteLine(<span class="string">"Hello Tainan! 台南! PostgreSQL!"</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">using</span> (<span class="keyword">var</span> db = <span class="keyword">new</span> db01Context())</span><br><span class="line">      &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">"===== Departments =========="</span>);</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> dept <span class="keyword">in</span> db.Dept)</span><br><span class="line">        &#123;</span><br><span class="line">          Console.WriteLine(<span class="string">$"<span class="subst">&#123;dept.Deptno&#125;</span> <span class="subst">&#123;dept.Dname&#125;</span> <span class="subst">&#123;dept.Loc&#125;</span>"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Console.WriteLine(<span class="string">"===== Employees =========="</span>);</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> emp <span class="keyword">in</span> db.Emp)</span><br><span class="line">        &#123;</span><br><span class="line">          Console.WriteLine(<span class="string">$"<span class="subst">&#123;emp.Empno&#125;</span> <span class="subst">&#123;emp.Ename&#125;</span> <span class="subst">&#123;emp.Job&#125;</span> <span class="subst">&#123;emp.Mgr&#125;</span> <span class="subst">&#123;emp.Hiredate?.ToString(<span class="string">"yyyy-MM-ddTHH:mm:ss"</span>)&#125;</span> <span class="subst">&#123;emp.Sal&#125;</span> <span class="subst">&#123;emp.Comm&#125;</span> <span class="subst">&#123;emp.Deptno&#125;</span>"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ PgEFCoreSample&gt; dotnet run</span><br><span class="line">Hello Tainan! 台南! PostgreSQL!</span><br><span class="line">===== Departments ==========</span><br><span class="line">10 會計部 紐約</span><br><span class="line">20 RESEARCH DALLAS</span><br><span class="line">30 SALES CHICAGO</span><br><span class="line">40 OPERATIONS BOSTON</span><br><span class="line">70 資訊部 台南 B4</span><br><span class="line">===== Employees ==========</span><br><span class="line">7839 KING PRESIDENT  1981-11-17T00:00:00 5000.00  10</span><br><span class="line">.....</span><br></pre></td></tr></table></figure>

<p>這與使用 <a href="/2020/06/04/C-Entity-Framework-Core-2-0-and-Oracle-Provider/">Oracle Provider</a> 的程式碼，只有 <strong>db01Context</strong> 名稱不一樣，其他都一樣。你可以複製新增、修改、刪除與其它程式碼來試試看。更換資料庫，只要抽換掉資料庫的 Provider。</p>
<h4 id="PostgreSQL-Schema-範例"><a href="#PostgreSQL-Schema-範例" class="headerlink" title="PostgreSQL Schema 範例"></a>PostgreSQL Schema 範例</h4><p>這裡提供一個比較實用的 PostgreSQL Schema 範例，這原來是 Oracle 的 Schema。其實 DDL 都一樣，需要改的是資料型態。</p>
<img src="/2020/06/12/C-Entity-Framework-Core-2-0-and-PostgreSQL-Provider/ot-schema-061501.png" title="OT Schema">

<p>這裡是 DDL 範例與範例資料 <a href="/2020/06/12/C-Entity-Framework-Core-2-0-and-PostgreSQL-Provider/demo_ot_data.sql">demo_ot_data.sql</a>。</p>
<figure class="highlight sql"><figcaption><span>demo_ot_schema.sql</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> regions</span><br><span class="line">  (</span><br><span class="line">    region_id   <span class="built_in">INTEGER</span> <span class="keyword">GENERATED</span> <span class="keyword">BY</span> <span class="keyword">DEFAULT</span> <span class="keyword">AS</span> <span class="keyword">IDENTITY</span> (<span class="keyword">START</span> <span class="keyword">WITH</span> <span class="number">5</span>) PRIMARY <span class="keyword">KEY</span>,</span><br><span class="line">    region_name <span class="built_in">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span></span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> countries</span><br><span class="line">  (</span><br><span class="line">    country_id    <span class="built_in">CHAR</span>(<span class="number">2</span>) PRIMARY <span class="keyword">KEY</span>,</span><br><span class="line">    country_name  <span class="built_in">VARCHAR</span>(<span class="number">40</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">     region_id    <span class="built_in">INTEGER</span>,</span><br><span class="line">    <span class="keyword">CONSTRAINT</span> fk_countries_regions <span class="keyword">FOREIGN</span> <span class="keyword">KEY</span> (region_id)</span><br><span class="line">      <span class="keyword">REFERENCES</span> regions(region_id)</span><br><span class="line">      <span class="keyword">ON</span> <span class="keyword">DELETE</span> <span class="keyword">CASCADE</span></span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> locations</span><br><span class="line">  (</span><br><span class="line">    location_id <span class="built_in">INTEGER</span> <span class="keyword">GENERATED</span> <span class="keyword">BY</span> <span class="keyword">DEFAULT</span> <span class="keyword">AS</span> <span class="keyword">IDENTITY</span> (<span class="keyword">START</span> <span class="keyword">WITH</span> <span class="number">24</span>) PRIMARY <span class="keyword">KEY</span>,</span><br><span class="line">    address     <span class="built_in">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    postal_code <span class="built_in">VARCHAR</span>(<span class="number">20</span>),</span><br><span class="line">    city        <span class="built_in">VARCHAR</span>(<span class="number">50</span>),</span><br><span class="line">    state       <span class="built_in">VARCHAR</span>(<span class="number">50</span>),</span><br><span class="line">    country_id  <span class="built_in">CHAR</span>(<span class="number">2</span>),    </span><br><span class="line">    <span class="keyword">CONSTRAINT</span> fk_locations_countries <span class="keyword">FOREIGN</span> <span class="keyword">KEY</span> (country_id)</span><br><span class="line">      <span class="keyword">REFERENCES</span> countries(country_id) </span><br><span class="line">      <span class="keyword">ON</span> <span class="keyword">DELETE</span> <span class="keyword">CASCADE</span></span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> warehouses</span><br><span class="line">  (</span><br><span class="line">    warehouse_id   <span class="built_in">INTEGER</span> <span class="keyword">GENERATED</span> <span class="keyword">BY</span> <span class="keyword">DEFAULT</span> <span class="keyword">AS</span> <span class="keyword">IDENTITY</span> (<span class="keyword">START</span> <span class="keyword">WITH</span> <span class="number">10</span>) PRIMARY <span class="keyword">KEY</span>,</span><br><span class="line">    warehouse_name <span class="built_in">VARCHAR</span>(<span class="number">255</span>),</span><br><span class="line">    location_id    <span class="built_in">INTEGER</span>, </span><br><span class="line">    <span class="keyword">CONSTRAINT</span> fk_warehouses_locations </span><br><span class="line">      <span class="keyword">FOREIGN</span> <span class="keyword">KEY</span> (location_id)</span><br><span class="line">      <span class="keyword">REFERENCES</span> locations(location_id) </span><br><span class="line">      <span class="keyword">ON</span> <span class="keyword">DELETE</span> <span class="keyword">CASCADE</span></span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> employees</span><br><span class="line">  (</span><br><span class="line">    employee_id <span class="built_in">INTEGER</span> <span class="keyword">GENERATED</span> <span class="keyword">BY</span> <span class="keyword">DEFAULT</span> <span class="keyword">AS</span> <span class="keyword">IDENTITY</span> (<span class="keyword">START</span> <span class="keyword">WITH</span> <span class="number">108</span>) PRIMARY <span class="keyword">KEY</span>,</span><br><span class="line">    first_name  <span class="built_in">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    last_name   <span class="built_in">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    email       <span class="built_in">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    phone       <span class="built_in">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> ,</span><br><span class="line">    hire_date   <span class="built_in">TIMESTAMP</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>          ,</span><br><span class="line">    manager_id  <span class="built_in">INTEGER</span> ,</span><br><span class="line">    job_title   <span class="built_in">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    <span class="keyword">CONSTRAINT</span> fk_employees_manager </span><br><span class="line">        <span class="keyword">FOREIGN</span> <span class="keyword">KEY</span> (manager_id)</span><br><span class="line">        <span class="keyword">REFERENCES</span> employees(employee_id)</span><br><span class="line">        <span class="keyword">ON</span> <span class="keyword">DELETE</span> <span class="keyword">CASCADE</span></span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> product_categories</span><br><span class="line">  (</span><br><span class="line">    category_id <span class="built_in">INTEGER</span> <span class="keyword">GENERATED</span> <span class="keyword">BY</span> <span class="keyword">DEFAULT</span> <span class="keyword">AS</span> <span class="keyword">IDENTITY</span> (<span class="keyword">START</span> <span class="keyword">WITH</span> <span class="number">6</span>) PRIMARY <span class="keyword">KEY</span>,</span><br><span class="line">    category_name <span class="built_in">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span></span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> products</span><br><span class="line">  (</span><br><span class="line">    product_id <span class="built_in">INTEGER</span> <span class="keyword">GENERATED</span> <span class="keyword">BY</span> <span class="keyword">DEFAULT</span> <span class="keyword">AS</span> <span class="keyword">IDENTITY</span> (<span class="keyword">START</span> <span class="keyword">WITH</span> <span class="number">289</span>) PRIMARY <span class="keyword">KEY</span>,</span><br><span class="line">    product_name  <span class="built_in">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    description   <span class="built_in">VARCHAR</span>(<span class="number">2000</span>),</span><br><span class="line">    standard_cost <span class="built_in">NUMERIC</span>(<span class="number">9</span>, <span class="number">2</span>),</span><br><span class="line">    list_price    <span class="built_in">NUMERIC</span>(<span class="number">9</span>, <span class="number">2</span>),</span><br><span class="line">    category_id   <span class="built_in">INTEGER</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> ,</span><br><span class="line">    <span class="keyword">CONSTRAINT</span> fk_products_categories </span><br><span class="line">      <span class="keyword">FOREIGN</span> <span class="keyword">KEY</span> (category_id)</span><br><span class="line">      <span class="keyword">REFERENCES</span> product_categories(category_id) </span><br><span class="line">      <span class="keyword">ON</span> <span class="keyword">DELETE</span> <span class="keyword">CASCADE</span></span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> customers</span><br><span class="line">  (</span><br><span class="line">    customer_id  <span class="built_in">INTEGER</span> <span class="keyword">GENERATED</span> <span class="keyword">BY</span> <span class="keyword">DEFAULT</span> <span class="keyword">AS</span> <span class="keyword">IDENTITY</span> (<span class="keyword">START</span> <span class="keyword">WITH</span> <span class="number">320</span>) PRIMARY <span class="keyword">KEY</span>,</span><br><span class="line">    <span class="keyword">name</span>         <span class="built_in">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    address      <span class="built_in">VARCHAR</span>(<span class="number">255</span>),</span><br><span class="line">    website      <span class="built_in">VARCHAR</span>(<span class="number">255</span>),</span><br><span class="line">    credit_limit <span class="built_in">NUMERIC</span>(<span class="number">8</span>, <span class="number">2</span>)</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> contacts</span><br><span class="line">  (</span><br><span class="line">    contact_id  <span class="built_in">INTEGER</span> <span class="keyword">GENERATED</span> <span class="keyword">BY</span> <span class="keyword">DEFAULT</span> <span class="keyword">AS</span> <span class="keyword">IDENTITY</span> (<span class="keyword">START</span> <span class="keyword">WITH</span> <span class="number">320</span>) PRIMARY <span class="keyword">KEY</span>,</span><br><span class="line">    first_name  <span class="built_in">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    last_name   <span class="built_in">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    email       <span class="built_in">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    phone       <span class="built_in">VARCHAR</span>(<span class="number">20</span>),</span><br><span class="line">    customer_id <span class="built_in">INTEGER</span>,</span><br><span class="line">    <span class="keyword">CONSTRAINT</span> fk_contacts_customers </span><br><span class="line">      <span class="keyword">FOREIGN</span> <span class="keyword">KEY</span> (customer_id)</span><br><span class="line">      <span class="keyword">REFERENCES</span> customers(customer_id) </span><br><span class="line">      <span class="keyword">ON</span> <span class="keyword">DELETE</span> <span class="keyword">CASCADE</span></span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> orders</span><br><span class="line">  (</span><br><span class="line">    order_id    <span class="built_in">INTEGER</span> <span class="keyword">GENERATED</span> <span class="keyword">BY</span> <span class="keyword">DEFAULT</span> <span class="keyword">AS</span> <span class="keyword">IDENTITY</span> (<span class="keyword">START</span> <span class="keyword">WITH</span> <span class="number">106</span>) PRIMARY <span class="keyword">KEY</span>,</span><br><span class="line">    customer_id <span class="built_in">INTEGER</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    <span class="keyword">status</span>      <span class="built_in">VARCHAR</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    salesman_id <span class="built_in">INTEGER</span>,</span><br><span class="line">    order_date  <span class="built_in">TIMESTAMP</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    <span class="keyword">CONSTRAINT</span> fk_orders_customers </span><br><span class="line">      <span class="keyword">FOREIGN</span> <span class="keyword">KEY</span> (customer_id)</span><br><span class="line">      <span class="keyword">REFERENCES</span> customers(customer_id)</span><br><span class="line">      <span class="keyword">ON</span> <span class="keyword">DELETE</span> <span class="keyword">CASCADE</span>,</span><br><span class="line">    <span class="keyword">CONSTRAINT</span> fk_orders_employees </span><br><span class="line">      <span class="keyword">FOREIGN</span> <span class="keyword">KEY</span> (salesman_id)</span><br><span class="line">      <span class="keyword">REFERENCES</span> employees(employee_id) </span><br><span class="line">      <span class="keyword">ON</span> <span class="keyword">DELETE</span> <span class="keyword">SET</span> <span class="literal">NULL</span></span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> order_items</span><br><span class="line">  (</span><br><span class="line">    order_id   <span class="built_in">INTEGER</span>, </span><br><span class="line">    item_id    <span class="built_in">INTEGER</span>,</span><br><span class="line">    product_id <span class="built_in">INTEGER</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    quantity   <span class="built_in">NUMERIC</span>(<span class="number">8</span>, <span class="number">2</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    unit_price <span class="built_in">NUMERIC</span>(<span class="number">8</span>, <span class="number">2</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    <span class="keyword">CONSTRAINT</span> pk_order_items </span><br><span class="line">      PRIMARY <span class="keyword">KEY</span> (order_id, item_id),</span><br><span class="line">    <span class="keyword">CONSTRAINT</span> fk_order_items_products </span><br><span class="line">      <span class="keyword">FOREIGN</span> <span class="keyword">KEY</span> (product_id)</span><br><span class="line">      <span class="keyword">REFERENCES</span> products(product_id) </span><br><span class="line">      <span class="keyword">ON</span> <span class="keyword">DELETE</span> <span class="keyword">CASCADE</span>,</span><br><span class="line">    <span class="keyword">CONSTRAINT</span> fk_order_items_orders </span><br><span class="line">      <span class="keyword">FOREIGN</span> <span class="keyword">KEY</span> (order_id)</span><br><span class="line">      <span class="keyword">REFERENCES</span> orders(order_id) </span><br><span class="line">      <span class="keyword">ON</span> <span class="keyword">DELETE</span> <span class="keyword">CASCADE</span></span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> inventories</span><br><span class="line">  (</span><br><span class="line">    product_id   <span class="built_in">INTEGER</span>,</span><br><span class="line">    warehouse_id <span class="built_in">INTEGER</span>,</span><br><span class="line">    quantity     <span class="built_in">NUMERIC</span>(<span class="number">8</span>, <span class="number">0</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    <span class="keyword">CONSTRAINT</span> pk_inventories </span><br><span class="line">      PRIMARY <span class="keyword">KEY</span> (product_id, warehouse_id),</span><br><span class="line">    <span class="keyword">CONSTRAINT</span> fk_inventories_products </span><br><span class="line">      <span class="keyword">FOREIGN</span> <span class="keyword">KEY</span> (product_id)</span><br><span class="line">      <span class="keyword">REFERENCES</span> products(product_id) </span><br><span class="line">      <span class="keyword">ON</span> <span class="keyword">DELETE</span> <span class="keyword">CASCADE</span>,</span><br><span class="line">    <span class="keyword">CONSTRAINT</span> fk_inventories_warehouses </span><br><span class="line">      <span class="keyword">FOREIGN</span> <span class="keyword">KEY</span> (warehouse_id)</span><br><span class="line">      <span class="keyword">REFERENCES</span> warehouses(warehouse_id) </span><br><span class="line">      <span class="keyword">ON</span> <span class="keyword">DELETE</span> <span class="keyword">CASCADE</span></span><br><span class="line">  );</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left" aria-label="上一頁"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right" aria-label="下一頁"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目錄
        </li>
        <li class="sidebar-nav-overview">
          本站概要
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="J.Y. Yang"
      src="/images/1184yang.jpg">
  <p class="site-author-name" itemprop="name">J.Y. Yang</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">63</span>
          <span class="site-state-item-name">文章</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">分類</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/1184yang" title="GitHub → https://github.com/1184yang" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:1184yang@gmail.com" title="E-Mail → mailto:1184yang@gmail.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/1184yang" title="Twitter → https://twitter.com/1184yang" rel="noopener" target="_blank"><i class="fa fa-fw fa-twitter"></i>Twitter</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">J.Y. Yang</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/muse.js"></script>
<script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script>



  




  <script src="/js/local-search.js"></script>












  

  

</body>
</html>
