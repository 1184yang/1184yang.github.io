<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  

  
  <title></title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title">
<meta property="og:url" content="https://1184yang.github.io/index.html">
<meta property="og:site_name">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title">
  
    <link rel="alternate" href="/atom.xml" title type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo"></a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://1184yang.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-Sequential-Execution" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/07/13/Sequential-Execution/" class="article-date">
  <time datetime="2020-07-13T02:39:30.000Z" itemprop="datePublished">2020-07-13</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/JavaScript/">JavaScript</a>►<a class="article-category-link" href="/categories/Oracle/">Oracle</a>►<a class="article-category-link" href="/categories/RabbitMQ/">RabbitMQ</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/07/13/Sequential-Execution/">Node.js 非同步控制流程模式 - 並行限制與循序執行</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>使用 RabbitMQ 時有時會碰到一個問題，例如從 RabbitMQ 即時接收到 50,000 筆資料要寫到 Oracle 資料庫，RabbitMQ 的消費模式速度非常快，如果沒有限制 Oracle 的 Connection 數量，他會需要 50,000 個 Oracle Connection，通常的結果會是資料庫崩溃，這種大量資料，你不能一筆一筆寫到資料庫，而要用批次處裡的方式，一個 connection 一次寫入 50,000 筆資料。Node.js 的 oracledb 程式庫就有提供 execute 與 executeMany 的方法。</p>
<p>但是 RabbitMQ 的 Playload 有大小的限制，不適合用來一次接收大數據的資料，因此你無法使用 executeMany 方法。通常會是即時的小數據資料，一個繁忙的系統，短時間幾萬筆資料也不是不可能。因此我們必須控制，當收到資料時控制可同時寫到資料庫的平行處理數量，這在 Oracle 的 oracledb 程式庫可以用 Connection Pool 來達成，在 Pool 設定最多 10 Connection，同時間大量的寫入就只能輪流使用這 10 個 Connection，其他的就必須等待，Oracle Connection Pool 內部有自己的 queue 機制。但太多的 queue，等待太久仍然會有 Timeout 的問題。</p>
<p>除了資料庫有這種問題外，只要牽涉到 I/O 都有可能遇到這個問題，例如網路。REST API 就是我們常會碰到的。</p>
<p>這個解決方案的概念就是來自於李玉華所碰到的問題。她會即時從 Oracle 一次送出多筆需求到 RabbitMQ，RabbitMQ 消費後經過一番複雜的處理然後會調用外界的 REST API。單筆處裡都不會有問題，但如果一次處理多筆，對方伺服器就會來不及反應，通常只會有一筆成功，其餘的都會失敗。所以我們要將從 RabbitMQ 接收到的資料，每筆送到 REST API 都可以有一些延遲的設定，避免對方伺服器來不及回應。</p>
<h4 id="Task-Queue"><a href="#Task-Queue" class="headerlink" title="Task Queue"></a>Task Queue</h4><figure class="highlight javascript"><figcaption><span>taskQueue.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TaskQueue</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(concurrency=1) &#123;</span><br><span class="line">    <span class="keyword">this</span>.concurrency = concurrency;</span><br><span class="line">    <span class="keyword">this</span>.running = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">this</span>.queue = [];</span><br><span class="line">    <span class="keyword">this</span>.pushTask = <span class="keyword">this</span>.pushTask.bind(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">this</span>.next = <span class="keyword">this</span>.next.bind(<span class="keyword">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  pushTask(task) &#123;</span><br><span class="line">    <span class="keyword">this</span>.queue.push(task);</span><br><span class="line">    <span class="keyword">this</span>.next();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  next() &#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="keyword">this</span>.running &lt; <span class="keyword">this</span>.concurrency &amp;&amp; <span class="keyword">this</span>.queue.length) &#123;</span><br><span class="line">      <span class="keyword">const</span> task = <span class="keyword">this</span>.queue.shift();</span><br><span class="line">      task(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.running--;</span><br><span class="line">        <span class="keyword">this</span>.next();</span><br><span class="line">      &#125;);</span><br><span class="line">      <span class="keyword">this</span>.running++;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = TaskQueue;</span><br></pre></td></tr></table></figure>

<p>這讓人很驚訝，短短的 27 行的程式碼，功能卻很強大。不限於用在這個例子，你可用在你需要的地方，包含 APEX 上。</p>
<p>這裡用了幾個 JavaScript 幾個重要的基本概念:</p>
<ul>
<li>函式是第一等公民(First class)</li>
<li>延續傳遞風格(Continuation-passing style)，簡稱 CPS</li>
<li>閉包（Closure）</li>
</ul>
<p>使用的方式很簡單，就是把你要處裡的工作依一定的簽章推入 Queue 中，Queue 會依照先進先出的方式逐一執行。</p>
<p>其中的 concurrency 則可以控制並行的數量，預設值是 1，就是一次處理一個工作，會依照先進先出的方式逐一執行，所以如果 concurrency 設為 1，則不管是同步還是非同步的工作，完成的時間也會依序。</p>
<p>concurrency 設為 2，則可以一次同時平行處理 2 筆。雖然也是依照先進先出的方式逐一執行，但如果是非同步的工作，完成的時間就比較難掌控了，因為它一次可以同時處理兩個工作，也許一個平行作業處理比較久，但另一個平行作業已經處理完好幾個工作了。</p>
<h4 id="應用測試"><a href="#應用測試" class="headerlink" title="應用測試"></a>應用測試</h4><p>先用一個簡單的例子來看看如何應用:</p>
<figure class="highlight javascript"><figcaption><span>run.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> TaskQueue = <span class="built_in">require</span>(<span class="string">'./taskQueue'</span>);</span><br><span class="line"><span class="keyword">const</span> runQueue = <span class="keyword">new</span> TaskQueue();</span><br><span class="line"><span class="keyword">const</span> series = [<span class="number">1000</span>, <span class="number">800</span>, <span class="number">600</span>, <span class="number">400</span>, <span class="number">200</span>, <span class="number">900</span>, <span class="number">700</span>, <span class="number">500</span>, <span class="number">300</span>, <span class="number">100</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> doSomething = <span class="function">(<span class="params">data, done</span>) =&gt;</span> &#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">Math</span>.random() &lt; <span class="number">0.2</span>) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`Data: <span class="subst">$&#123;data&#125;</span> ERROR!`</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`Data: <span class="subst">$&#123;data&#125;</span> successfully completed`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    done();</span><br><span class="line">  &#125;, data)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">series.forEach(<span class="function"><span class="params">value</span> =&gt;</span> &#123;</span><br><span class="line">  runQueue.pushTask(<span class="function">(<span class="params">done</span>) =&gt;</span> &#123;</span><br><span class="line">    doSomething(value, done);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>doSomething 是你要處裡的工作，使用 setTimeout 來模擬非同步的工作，函式參數除了你自己的資料參數外，另外需要有一個強迫性的參數，在這個例子中我們取名為 done，你可以取任和的名子。done 將會是個函式，當你的工作完成後需要調用它(第 12 行)，Queue 才會往下執行下一個工作。</p>
<p>這裡我們用 series 陣列模擬從 RabbitMQ 消費的資料，然後經過 doSomething 處理。第 17 行我們將 doSomething 及資料包裹在閉包中，然後將閉包 push 到 Queue 中。所以現在存在 Task Queue 中的其實是一個閉包，所以 queue 中應該會像:</p>
<figure class="highlight javascript"><figcaption><span>Task Queue</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  (done) =&gt; &#123; doSomething(value, done) &#125;,  <span class="comment">// value =&gt; 1000</span></span><br><span class="line">  (done) =&gt; &#123; doSomething(value, done) &#125;,  <span class="comment">// value =&gt; 800</span></span><br><span class="line">  (done) =&gt; &#123; doSomething(value, done) &#125;,  <span class="comment">// value =&gt; 600</span></span><br><span class="line">  ...</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>執行了 runQueue.pushTask( ) 後，taskQueue 會自動執行 Queue 中我們所推入的工作(Task)，taskQueue.js 中的第 17 行從 Queue 中取出先前 push 進去的 task，隨即執行 task，執行時會帶入一個引數(argument):</p>
<figure class="highlight javascript"><figcaption><span>done</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">() =&gt; &#123;</span><br><span class="line">  <span class="keyword">this</span>.running--;</span><br><span class="line">  <span class="keyword">this</span>.next();</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>這個引數是一個函式，也就是 done !!! 要記得，函式是第一等公民，與一般的資料型態沒有甚麼不同，可以是函式的引數，也可以從函式 return 出來。</p>
<figure class="highlight javascript"><figcaption><span>Run</span></figcaption><table><tr><td class="code"><pre><span class="line">$ node run</span><br><span class="line">Data: <span class="number">1000</span> successfully completed</span><br><span class="line">Data: <span class="number">800</span> successfully completed</span><br><span class="line">Data: <span class="number">600</span> ERROR!</span><br><span class="line">Data: <span class="number">400</span> successfully completed</span><br><span class="line">Data: <span class="number">200</span> successfully completed</span><br><span class="line">Data: <span class="number">900</span> successfully completed</span><br><span class="line">Data: <span class="number">700</span> successfully completed</span><br><span class="line">Data: <span class="number">500</span> successfully completed</span><br><span class="line">Data: <span class="number">300</span> successfully completed</span><br><span class="line">Data: <span class="number">100</span> successfully completed</span><br></pre></td></tr></table></figure>

<p>目前 concurrency 是預設的 1, 雖然推入的工作都是非同步的，但完成的時間也都按照推入的順序。</p>
<p>將 concurrency 改為 2 看看結果如何:</p>
<figure class="highlight javascript"><figcaption><span>Task Queue</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> TaskQueue = <span class="built_in">require</span>(<span class="string">'./taskQueue'</span>);</span><br><span class="line"><span class="keyword">const</span> runQueue = <span class="keyword">new</span> TaskQueue(<span class="number">2</span>);</span><br><span class="line">.....</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><figcaption><span>Task Queue</span></figcaption><table><tr><td class="code"><pre><span class="line">$ node run</span><br><span class="line">Data: <span class="number">800</span> successfully completed</span><br><span class="line">Data: <span class="number">1000</span> successfully completed</span><br><span class="line">Data: <span class="number">400</span> ERROR!</span><br><span class="line">Data: <span class="number">600</span> successfully completed</span><br><span class="line">Data: <span class="number">200</span> ERROR!</span><br><span class="line">Data: <span class="number">700</span> successfully completed</span><br><span class="line">Data: <span class="number">900</span> successfully completed</span><br><span class="line">Data: <span class="number">300</span> successfully completed</span><br><span class="line">Data: <span class="number">100</span> successfully completed</span><br><span class="line">Data: <span class="number">500</span> ERROR!</span><br></pre></td></tr></table></figure>

<p>因為同時可以平行處理兩筆工作，雖然是先進先出取出處理，但因工作都是非同步的關係，完成的順序就比較不能掌控了。</p>
<p>到現在的測試都還未延遲兩個工作間的間距，我們想讓前一個工作完成後，延遲一些時間再執行下一個工作。這只需要修改 doSomething 函式中調用 done( ) 的時間。</p>
<figure class="highlight javascript"><figcaption><span>run.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> doSomething = <span class="function">(<span class="params">data, done</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> next = <span class="function"><span class="params">()</span> =&gt;</span> setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> done(), <span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">Math</span>.random() &lt; <span class="number">0.2</span>) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`Data: <span class="subst">$&#123;data&#125;</span> ERROR!`</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`Data: <span class="subst">$&#123;data&#125;</span> successfully completed`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    next();</span><br><span class="line">  &#125;, data)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第 2 行使用 setTimeout 延遲調用 done( ) 的時間，延遲多久由你自己控制。就這樣解決了李玉華的問題。</p>
<h4 id="RabbitMQ-與-Oracle-Database-範例"><a href="#RabbitMQ-與-Oracle-Database-範例" class="headerlink" title="RabbitMQ 與 Oracle Database 範例"></a>RabbitMQ 與 Oracle Database 範例</h4><p>了解了基本運作，現在將它實際應用到 RabbitMQ 與 Oracle 資料庫上。RabbitMQ 與 Oracle 的抽象層在文章後端的原始碼中。</p>
<p>從基本的開始，先不用 taskQueue。</p>
<figure class="highlight javascript"><figcaption><span>receiveToOracle.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> rabbit = <span class="built_in">require</span>(<span class="string">'./rabbitmq'</span>);</span><br><span class="line"><span class="keyword">const</span> oradb = <span class="built_in">require</span>(<span class="string">'./database'</span>);</span><br><span class="line"></span><br><span class="line">rabbit.on(<span class="string">'ready'</span>, <span class="keyword">async</span> (&#123; receive &#125;) =&gt; &#123;</span><br><span class="line">  <span class="keyword">await</span> oradb.initialize();</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'rabbit and db initilized.'</span>);</span><br><span class="line"></span><br><span class="line">  receive(<span class="string">'demo-example'</span>, <span class="string">''</span>, (err, data, ack) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">console</span>.log(err);</span><br><span class="line">    &#125;  </span><br><span class="line">    doSomething(data, ack)</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">doSomething</span>(<span class="params">data, ack=f=&gt;f</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> empno = <span class="built_in">JSON</span>.parse(data).empno;</span><br><span class="line">  <span class="keyword">const</span> statement = <span class="string">"insert into demo_example select empno ||' '|| ename from emp where empno = :empno"</span>;</span><br><span class="line"> </span><br><span class="line">  oradb.doExecute(statement, [empno]).then(</span><br><span class="line">    result =&gt; &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`Result: <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(result)&#125;</span> at: <span class="subst">$&#123;<span class="keyword">new</span> <span class="built_in">Date</span>()&#125;</span>`</span>);</span><br><span class="line">      ack();</span><br><span class="line">    &#125;,</span><br><span class="line">    error =&gt; &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`Result: <span class="subst">$&#123;error.message&#125;</span> at: <span class="subst">$&#123;<span class="keyword">new</span> <span class="built_in">Date</span>()&#125;</span>`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>從 RabbitMQ 消費取的資料，依據資料從 EMP 資料表取得資料，然後新增到 DEMO_EXAMPLE 資料表。</p>
<figure class="highlight javascript"><figcaption><span>Receive to oracle</span></figcaption><table><tr><td class="code"><pre><span class="line">$ node receiveToOracle</span><br><span class="line">rabbit and db initilized.</span><br></pre></td></tr></table></figure>

<p>啟動以後就開始等待 RabbitMQ queue demo-example 的消費。現在送一些資料到 RabbitMQ 的 queue demo-example。</p>
<figure class="highlight javascript"><figcaption><span>sendToQueue.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> rabbit = <span class="built_in">require</span>(<span class="string">'./rabbitmq'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> data = [&#123; <span class="attr">empno</span>: <span class="number">7369</span> &#125;, &#123; <span class="attr">empno</span>: <span class="number">7566</span> &#125;, &#123; <span class="attr">empno</span>: <span class="number">7900</span> &#125;, &#123; <span class="attr">empno</span>: <span class="number">7654</span> &#125;, &#123; <span class="attr">empno</span>: <span class="number">7698</span> &#125;];</span><br><span class="line"></span><br><span class="line">rabbit.on(<span class="string">'ready'</span>, (&#123; sendToQueue &#125;) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> send = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">      data.forEach(<span class="function"><span class="params">value</span> =&gt;</span> &#123;</span><br><span class="line">        sendToQueue(<span class="string">'demo-example'</span>, <span class="built_in">JSON</span>.stringify(value));</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  send();</span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> send(), <span class="number">2000</span>);</span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> send(), <span class="number">3000</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>這裡每隔一秒送出一次，連續送出 3 次，一次 50 筆資料。</p>
<figure class="highlight javascript"><figcaption><span>Send to RabbitMQ queue</span></figcaption><table><tr><td class="code"><pre><span class="line">$ node sendToQueue</span><br></pre></td></tr></table></figure>

<p>回到消費者的終端畫面，很快的在約 3 秒內就消費完畢，寫入 Oracle 資料庫中了。</p>
<figure class="highlight javascript"><figcaption><span>Receive to oracle</span></figcaption><table><tr><td class="code"><pre><span class="line">$ node receiveToOracle</span><br><span class="line">rabbit and db initilized.</span><br><span class="line">Result: &#123;<span class="string">"lastRowid"</span>:<span class="string">"AAC8uRACgAAAJTuAAu"</span>,<span class="string">"rowsAffected"</span>:<span class="number">1</span>&#125; at: Tue Jul <span class="number">14</span> <span class="number">2020</span> <span class="number">08</span>:<span class="number">20</span>:<span class="number">46</span> GMT+<span class="number">0800</span> (GMT+<span class="number">08</span>:<span class="number">00</span>)</span><br><span class="line">Result: &#123;<span class="string">"lastRowid"</span>:<span class="string">"AAC8uRACgAAAJTvAAd"</span>,<span class="string">"rowsAffected"</span>:<span class="number">1</span>&#125; at: Tue Jul <span class="number">14</span> <span class="number">2020</span> <span class="number">08</span>:<span class="number">20</span>:<span class="number">46</span> GMT+<span class="number">0800</span> (GMT+<span class="number">08</span>:<span class="number">00</span>)</span><br><span class="line">Result: &#123;<span class="string">"lastRowid"</span>:<span class="string">"AAC8uRACgAAAJTwAAA"</span>,<span class="string">"rowsAffected"</span>:<span class="number">1</span>&#125; at: Tue Jul <span class="number">14</span> <span class="number">2020</span> <span class="number">08</span>:<span class="number">20</span>:<span class="number">46</span> GMT+<span class="number">0800</span> (GMT+<span class="number">08</span>:<span class="number">00</span>)</span><br><span class="line">Result: &#123;<span class="string">"lastRowid"</span>:<span class="string">"AAC8uRACgAAAJTsAAe"</span>,<span class="string">"rowsAffected"</span>:<span class="number">1</span>&#125; at: Tue Jul <span class="number">14</span> <span class="number">2020</span> <span class="number">08</span>:<span class="number">20</span>:<span class="number">46</span> GMT+<span class="number">0800</span> (GMT+<span class="number">08</span>:<span class="number">00</span>)</span><br><span class="line">.....</span><br></pre></td></tr></table></figure>

<p>因為這裡 Oracle 的 Connection Pool 最大值設為 10, Oracle 火力全開，使用了全部的 10 個 Connection。記得一定要用 Oracle Connection Pool，如果沒有用 Oracle Connection Pool，而直接使用 Oracle Connection，因為 RabbitMQ 非常的快，有可能 Oracle 會嘗試一次開 150 connections，如果是 10,000筆資料，Oracle Database 就崩潰了。</p>
<p>如果你打算使用 Oracle ORDS REST API，千萬千萬不要一次送太多資料，它會每個 Request 嘗試打開一個 connection，資料庫會崩潰!!! <strong>不要試，因為我做過!</strong></p>
<figure class="highlight javascript"><figcaption><span>Oracle Database connections</span></figcaption><table><tr><td class="code"><pre><span class="line">DEMO     <span class="number">40</span>   <span class="number">10</span> PEC\<span class="number">76070049</span>P3  <span class="number">10857</span>    INACTIVE    <span class="number">3583</span> node.exe             node.exe</span><br><span class="line">         <span class="number">48</span>   <span class="number">11</span> PEC\<span class="number">76070049</span>P3  <span class="number">10869</span>    INACTIVE    <span class="number">2521</span> node.exe             node.exe</span><br><span class="line">         <span class="number">41</span>   <span class="number">40</span> PEC\<span class="number">76070049</span>P3  <span class="number">10859</span>    INACTIVE   <span class="number">29317</span> node.exe             node.exe</span><br><span class="line">         <span class="number">42</span>   <span class="number">68</span> PEC\<span class="number">76070049</span>P3  <span class="number">10861</span>    INACTIVE   <span class="number">42469</span> node.exe             node.exe</span><br><span class="line">         <span class="number">45</span>  <span class="number">163</span> PEC\<span class="number">76070049</span>P3  <span class="number">10863</span>    INACTIVE   <span class="number">49803</span> node.exe             node.exe</span><br><span class="line">         <span class="number">37</span>  <span class="number">166</span> PEC\<span class="number">76070049</span>P3  <span class="number">10851</span>    INACTIVE   <span class="number">11951</span> node.exe             node.exe</span><br><span class="line">         <span class="number">38</span>  <span class="number">191</span> PEC\<span class="number">76070049</span>P3  <span class="number">10853</span>    INACTIVE   <span class="number">53789</span> node.exe             node.exe</span><br><span class="line">         <span class="number">46</span>  <span class="number">194</span> PEC\<span class="number">76070049</span>P3  <span class="number">10865</span>    INACTIVE   <span class="number">35991</span> node.exe             node.exe</span><br><span class="line">         <span class="number">47</span>  <span class="number">225</span> PEC\<span class="number">76070049</span>P3  <span class="number">10867</span>    INACTIVE    <span class="number">3537</span> node.exe             node.exe</span><br><span class="line">         <span class="number">39</span>  <span class="number">230</span> PEC\<span class="number">76070049</span>P3  <span class="number">10855</span>    INACTIVE    <span class="number">3133</span> node.exe             node.exe</span><br></pre></td></tr></table></figure>

<p>Oracle 會用輪流使用這 10 個 Connection Pool 中的 Connection，等待處裡的則會放入 Oracle Connection 的 queue 中。Connection queue 的預設等待時間 Timeout 是 60 秒，因此如果資料太多，有些就會出現 timeout 錯誤。</p>
<figure class="highlight javascript"><figcaption><span>timeout error</span></figcaption><table><tr><td class="code"><pre><span class="line">error: <span class="built_in">Error</span>: NJS<span class="number">-040</span>: connection request timeout. Request exceeded queueTimeout <span class="keyword">of</span> <span class="number">60000</span></span><br><span class="line">      at Timeout._onTimeout (I:\RabbitMQ\gittemp\rabbit-consume-delay\node_modules\oracledb\lib\pool.js:<span class="number">127</span>:<span class="number">18</span>)</span><br></pre></td></tr></table></figure>

<p>現在加入 taskQueue 來控制延遲。</p>
<figure class="highlight javascript"><figcaption><span>receiveToOracle.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> rabbit = <span class="built_in">require</span>(<span class="string">'./rabbitmq'</span>);</span><br><span class="line"><span class="keyword">const</span> oradb = <span class="built_in">require</span>(<span class="string">'./database'</span>);</span><br><span class="line"><span class="keyword">const</span> TaskQueue = <span class="built_in">require</span>(<span class="string">'./src/taskQueue'</span>);</span><br><span class="line"><span class="keyword">const</span> runQueue = <span class="keyword">new</span> TaskQueue();</span><br><span class="line"></span><br><span class="line">rabbit.on(<span class="string">'ready'</span>, <span class="keyword">async</span> (&#123; receive &#125;) =&gt; &#123;</span><br><span class="line">  <span class="keyword">await</span> oradb.initialize();</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'rabbit and db initilized.'</span>);</span><br><span class="line"></span><br><span class="line">  receive(<span class="string">'demo-example'</span>, <span class="string">''</span>, (err, data, ack) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">console</span>.log(err);</span><br><span class="line">    &#125;</span><br><span class="line">    runQueue.pushTask(<span class="function">(<span class="params">done</span>) =&gt;</span> &#123;</span><br><span class="line">      doSomething(data, ack, done);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">doSomething</span>(<span class="params">data, ack=f=&gt;f, done=f=&gt;f</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> empno = <span class="built_in">JSON</span>.parse(data).empno;</span><br><span class="line">  <span class="keyword">const</span> statement = <span class="string">"insert into demo_example select empno ||' '|| ename from emp where empno = :empno"</span>;</span><br><span class="line">  <span class="keyword">const</span> next = <span class="function"><span class="params">()</span> =&gt;</span> setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> done(), <span class="number">100</span>);</span><br><span class="line">  </span><br><span class="line">  oradb.doExecute(statement, [empno]).then(</span><br><span class="line">    result =&gt; &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`Result: <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(result)&#125;</span> at: <span class="subst">$&#123;<span class="keyword">new</span> <span class="built_in">Date</span>()&#125;</span>`</span>);</span><br><span class="line">      ack();</span><br><span class="line">      next();</span><br><span class="line">    &#125;,</span><br><span class="line">    error =&gt; &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`Result: <span class="subst">$&#123;error.message&#125;</span> at: <span class="subst">$&#123;<span class="keyword">new</span> <span class="built_in">Date</span>()&#125;</span>`</span>);</span><br><span class="line">      <span class="built_in">console</span>.log(error);</span><br><span class="line">      next();</span><br><span class="line">    &#125;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第 14 行將工作推入 Task Queue 中，在第 29 與 34 行延遲調用 done( )。 </p>
<figure class="highlight javascript"><figcaption><span>Receive to oracle</span></figcaption><table><tr><td class="code"><pre><span class="line">$ node receiveToOracle</span><br><span class="line">rabbit and db initilized.</span><br><span class="line">Result: &#123;<span class="string">"lastRowid"</span>:<span class="string">"AAC8vmACgAAAJTvAAA"</span>,<span class="string">"rowsAffected"</span>:<span class="number">1</span>&#125; at: Tue Jul <span class="number">14</span> <span class="number">2020</span> <span class="number">09</span>:<span class="number">28</span>:<span class="number">12</span> GMT+<span class="number">0800</span> (GMT+<span class="number">08</span>:<span class="number">00</span>)</span><br><span class="line">Result: &#123;<span class="string">"lastRowid"</span>:<span class="string">"AAC8vmACgAAAJTvAAB"</span>,<span class="string">"rowsAffected"</span>:<span class="number">1</span>&#125; at: Tue Jul <span class="number">14</span> <span class="number">2020</span> <span class="number">09</span>:<span class="number">28</span>:<span class="number">12</span> GMT+<span class="number">0800</span> (GMT+<span class="number">08</span>:<span class="number">00</span>)</span><br><span class="line">Result: &#123;<span class="string">"lastRowid"</span>:<span class="string">"AAC8vmACgAAAJTvAAC"</span>,<span class="string">"rowsAffected"</span>:<span class="number">1</span>&#125; at: Tue Jul <span class="number">14</span> <span class="number">2020</span> <span class="number">09</span>:<span class="number">28</span>:<span class="number">12</span> GMT+<span class="number">0800</span> (GMT+<span class="number">08</span>:<span class="number">00</span>)</span><br><span class="line">.....</span><br><span class="line">Result: &#123;<span class="string">"lastRowid"</span>:<span class="string">"AAC8vmACgAAAJTvACT"</span>,<span class="string">"rowsAffected"</span>:<span class="number">1</span>&#125; at: Tue Jul <span class="number">14</span> <span class="number">2020</span> <span class="number">09</span>:<span class="number">28</span>:<span class="number">27</span> GMT+<span class="number">0800</span> (GMT+<span class="number">08</span>:<span class="number">00</span>)</span><br><span class="line">Result: &#123;<span class="string">"lastRowid"</span>:<span class="string">"AAC8vmACgAAAJTvACU"</span>,<span class="string">"rowsAffected"</span>:<span class="number">1</span>&#125; at: Tue Jul <span class="number">14</span> <span class="number">2020</span> <span class="number">09</span>:<span class="number">28</span>:<span class="number">27</span> GMT+<span class="number">0800</span> (GMT+<span class="number">08</span>:<span class="number">00</span>)</span><br><span class="line">Result: &#123;<span class="string">"lastRowid"</span>:<span class="string">"AAC8vmACgAAAJTvACV"</span>,<span class="string">"rowsAffected"</span>:<span class="number">1</span>&#125; at: Tue Jul <span class="number">14</span> <span class="number">2020</span> <span class="number">09</span>:<span class="number">28</span>:<span class="number">27</span> GMT+<span class="number">0800</span> (GMT+<span class="number">08</span>:<span class="number">00</span>)</span><br></pre></td></tr></table></figure>

<p>在延遲 0.1 秒下，150 筆資料費了約 15 秒。顯然慢了許多。</p>
<p>現在測試一下大量資料，一次送入 50,000 筆，但是將 concurrency 將設為 5。</p>
<figure class="highlight javascript"><figcaption><span>receiveToOracle.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">const</span> runQueue = <span class="keyword">new</span> TaskQueue(<span class="number">5</span>);</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><figcaption><span>Oracle Database connections</span></figcaption><table><tr><td class="code"><pre><span class="line">DEMO     <span class="number">34</span>   <span class="number">67</span> PEC\<span class="number">76070049</span>P3  <span class="number">26301</span>    INACTIVE   <span class="number">48553</span> node.exe             node.exe</span><br><span class="line">         <span class="number">36</span>  <span class="number">131</span> PEC\<span class="number">76070049</span>P3  <span class="number">27394</span>    INACTIVE   <span class="number">21051</span> node.exe             node.exe</span><br><span class="line">         <span class="number">37</span>  <span class="number">163</span> PEC\<span class="number">76070049</span>P3  <span class="number">27396</span>    INACTIVE   <span class="number">57175</span> node.exe             node.exe</span><br><span class="line">         <span class="number">39</span>  <span class="number">225</span> PEC\<span class="number">76070049</span>P3  <span class="number">25052</span>    INACTIVE    <span class="number">3575</span> node.exe             node.exe</span><br></pre></td></tr></table></figure>

<p>這次沒有 Timeout Error，觀察 Oracle Connection Pool  一直都只開 3 ~ 4 個 Connection，延遲 0.1 秒對 Oracle 資料庫是綽綽有餘。</p>
<p>微服務少不了消息代理伺服器， RabbitMQ 與 Apache Kafka 不只提供了資料的一致性整合外，也可以當成系統的緩存區。假如有一個系統同時湧入幾萬個使用者，資料庫反應不及，可以利用 RabbitMQ 或 Apache Kafka 延遲資料的寫入，或者可以透過多個消費者作分流，分散系統的負載。熟悉它，就會有無限的功能應用。</p>
<h4 id="RabbitMQ-與-Oracle-資料庫抽象層"><a href="#RabbitMQ-與-Oracle-資料庫抽象層" class="headerlink" title="RabbitMQ 與 Oracle 資料庫抽象層"></a>RabbitMQ 與 Oracle 資料庫抽象層</h4><figure class="highlight javascript"><figcaption><span>database.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> oracledb = <span class="built_in">require</span>(<span class="string">'oracledb'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> dbconfig = &#123;</span><br><span class="line">  user: <span class="string">"xxxx"</span>,</span><br><span class="line">  password: <span class="string">""</span>xxxxxxxx,</span><br><span class="line">  connectString: <span class="string">"10.11.xx.xxx:1521/xxxx.xxx.com.tw"</span>,</span><br><span class="line">  poolMin: <span class="number">0</span>,</span><br><span class="line">  poolMax: <span class="number">10</span>,</span><br><span class="line">  poolIncrement: <span class="number">1</span>,</span><br><span class="line">  queueMax: <span class="number">-1</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">initialize</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> pool = <span class="keyword">await</span> oracledb.createPool(dbconfig);</span><br><span class="line">    </span><br><span class="line">    process.once(<span class="string">'SIGINT'</span>, () =&gt; &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'oracledb connection pool close.'</span>);</span><br><span class="line">      close();</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(err);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">close</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">await</span> oracledb.getPool().close();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(err);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">doExecute</span>(<span class="params">statement, binds = [], opts = &#123;&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(</span><br><span class="line">    <span class="keyword">async</span> (resolve, reject) =&gt; &#123;</span><br><span class="line">      <span class="keyword">let</span> conn;</span><br><span class="line">      opts.outFormat = oracledb.OBJECT;</span><br><span class="line">      opts.autoCommit = <span class="literal">true</span>;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        conn = <span class="keyword">await</span> oracledb.getConnection();</span><br><span class="line">        <span class="keyword">const</span> result = <span class="keyword">await</span> conn.execute(statement, binds, opts);</span><br><span class="line">        resolve(result);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">catch</span> (err) &#123; reject(&#123; <span class="attr">error</span>: err &#125;); &#125;</span><br><span class="line">      <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (conn) &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">await</span> conn.close();</span><br><span class="line">            <span class="comment">//console.log('ok');</span></span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">catch</span> (err) &#123; <span class="built_in">console</span>.log(err); &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">doExecuteMany</span>(<span class="params">statement, binds = [], opts = &#123;&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="keyword">async</span> (resolve, reject) =&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> conn;</span><br><span class="line">    opts.outFormat = oracledb.OBJECT;</span><br><span class="line">    opts.autoCommit = <span class="literal">true</span>;</span><br><span class="line">    opts.batchErrors = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      conn = <span class="keyword">await</span> oracledb.getConnection();</span><br><span class="line">      <span class="keyword">const</span> result = <span class="keyword">await</span> conn.executeMany(statement, binds, opts);</span><br><span class="line">      resolve(result);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (err) &#123; reject(err); &#125;</span><br><span class="line">    <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (conn) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123; <span class="keyword">await</span> conn.close(); &#125;</span><br><span class="line">        <span class="keyword">catch</span> (err) &#123; <span class="built_in">console</span>.log(err); &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports.initialize = initialize;</span><br><span class="line"><span class="built_in">module</span>.exports.close = close;</span><br><span class="line"><span class="built_in">module</span>.exports.doExecute = doExecute;</span><br><span class="line"><span class="built_in">module</span>.exports.doExecuteMany = doExecuteMany; </span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><figcaption><span>rabbitmq.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> EventEmitter = <span class="built_in">require</span>(<span class="string">'events'</span>).EventEmitter;</span><br><span class="line"><span class="keyword">const</span> amqp = <span class="built_in">require</span>(<span class="string">"amqplib"</span>);</span><br><span class="line"><span class="keyword">const</span> uuid = <span class="built_in">require</span>(<span class="string">'node-uuid'</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RabbitMQ</span> <span class="keyword">extends</span> <span class="title">EventEmitter</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>() &#123;</span><br><span class="line">    <span class="keyword">super</span>();</span><br><span class="line">    <span class="keyword">this</span>.url = <span class="string">"xxxxx:xxxxx@10.11.xx.xxx"</span>;</span><br><span class="line">    <span class="keyword">this</span>.channel = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">this</span>.exchange = <span class="string">"dummy.exchange"</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">this</span>.sendToQueue = <span class="keyword">this</span>.sendToQueue.bind(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">this</span>.publish = <span class="keyword">this</span>.publish.bind(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">this</span>.receive = <span class="keyword">this</span>.receive.bind(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">this</span>.initialize = <span class="keyword">this</span>.initialize.bind(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.initialize().then(<span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">this</span>.emit(<span class="string">'ready'</span>, &#123;</span><br><span class="line">      publish: <span class="keyword">this</span>.publish,</span><br><span class="line">      sendToQueue: <span class="keyword">this</span>.sendToQueue,</span><br><span class="line">      receive: <span class="keyword">this</span>.receive</span><br><span class="line">    &#125;));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  initialize() &#123;</span><br><span class="line">    <span class="keyword">return</span> amqp</span><br><span class="line">      .connect(<span class="string">`amqp://<span class="subst">$&#123;<span class="keyword">this</span>.url&#125;</span>`</span>)</span><br><span class="line">      .then(<span class="function"><span class="params">conn</span> =&gt;</span> &#123;</span><br><span class="line">        process.once(<span class="string">'SIGINT'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">          <span class="built_in">console</span>.log(<span class="string">'amqp connection close.'</span>);</span><br><span class="line">          conn.close();</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> conn.createChannel()</span><br><span class="line">      &#125;)</span><br><span class="line">      .then(<span class="function"><span class="params">channel</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.channel = channel;</span><br><span class="line">      &#125;)</span><br><span class="line">      .catch(<span class="built_in">console</span>.warn)</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  sendToQueue(queue, content) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.channel.sendToQueue(</span><br><span class="line">      queue,</span><br><span class="line">      <span class="keyword">new</span> Buffer.from(content),</span><br><span class="line">      &#123;</span><br><span class="line">        persistent: <span class="literal">true</span>,</span><br><span class="line">        headers: &#123;</span><br><span class="line">          messageId: uuid.v4(),</span><br><span class="line">          api: <span class="string">"Demo-sendToQueue-v1"</span>,</span><br><span class="line">          firstPublish: <span class="built_in">Date</span>.now()</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  publish(exchange, routingKey, content, delay=<span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.channel.publish(</span><br><span class="line">      exchange,</span><br><span class="line">      routingKey,</span><br><span class="line">      <span class="keyword">new</span> Buffer.from(content),</span><br><span class="line">      &#123;</span><br><span class="line">        persistent: <span class="literal">true</span>,</span><br><span class="line">        headers: &#123;</span><br><span class="line">          messageId: uuid(),</span><br><span class="line">          api: <span class="string">"Demo-publish-v1"</span>,</span><br><span class="line">          firstPublish: <span class="built_in">Date</span>.now()</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  receive(queue, routingKey, callback) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.channel.assertQueue(queue)</span><br><span class="line">      .then(<span class="function"><span class="params">q</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.channel.bindQueue(queue, <span class="keyword">this</span>.exchange, routingKey)</span><br><span class="line">      &#125;)</span><br><span class="line">      .then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.channel.consume(queue, msg =&gt; &#123;</span><br><span class="line">          <span class="keyword">let</span> data;</span><br><span class="line">          </span><br><span class="line">          <span class="keyword">if</span> (msg) &#123;</span><br><span class="line">            <span class="comment">// console.log(msg.properties.headers);</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">              data = msg.content.toString();</span><br><span class="line">              callback(<span class="literal">null</span>, data, () =&gt; <span class="keyword">this</span>.channel.ack(msg));</span><br><span class="line">            &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">              callback(err);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            callback(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'amqp consume error.'</span>));</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;, &#123; <span class="attr">noAck</span>: <span class="literal">false</span> &#125;);</span><br><span class="line">      &#125;)</span><br><span class="line">      .catch(<span class="built_in">console</span>.warn);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="keyword">new</span> RabbitMQ();</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://1184yang.github.io/2020/07/13/Sequential-Execution/" data-id="ckcpzj96m001n80vz5r8rzl3f" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-C-Entity-Framework-Core-2-0-and-PostgreSQL-Provider" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/06/12/C-Entity-Framework-Core-2-0-and-PostgreSQL-Provider/" class="article-date">
  <time datetime="2020-06-12T06:13:18.000Z" itemprop="datePublished">2020-06-12</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/C/">C#</a>►<a class="article-category-link" href="/categories/PostgreSQL/">PostgreSQL</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/06/12/C-Entity-Framework-Core-2-0-and-PostgreSQL-Provider/">C# Entity Framework Core 2.0 and PostgreSQL Provider</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>上次用 <a href="/2020/06/04/C-Entity-Framework-Core-2-0-and-Oracle-Provider/">C# Entity Framework Core 2.0 與 Oracle Provider</a> 連結至 Oracle 資料庫。這次改用 PostgreSQL 開放式資料庫。所需要做的就是把 Oracle Provider 改用 PostgreSQL Provider。程式碼幾乎都不需要修改。</p>
<p>開始之前，稍微來了解一下 PostgreSQL。</p>
<h3 id="PostgreSQL"><a href="#PostgreSQL" class="headerlink" title="PostgreSQL"></a>PostgreSQL</h3><p>PostgreSQL 自稱是世界上最先進的開源資料庫。 它是一種企業級的關連式資料庫管理系統，與最佳非開源的專有資料庫系統 Oracle，Microsoft SQL Server 和 IBM DB2 相當。 PostgreSQL 的特殊之處在於它不只是資料庫，它也是一個應用程序平台。</p>
<p>PostgreSQL 很快。在基準測試中，PostgreSQL 可以超過或匹配許多其他開放式和專有資料庫的性能。 PostgreSQL 允許使用多種編程語言編寫存儲過程(Stored Procedure)與涵式。 除了 C，SQL 和 PL/pgSQL 的預設包裝語言外，還可以簡單的啟用對其他語言的支援，例如 PL/Perl、PL/Python、PL/V8 (PL/JavaScript)、PL/Ruby 和 PL/R。對多種語言的支援使您可以選擇能夠最好地解決當前問題的結構的語言。</p>
<p>例如，使用 R 進行統計和製圖，使用 Python 調用 Web Services，使用 Python SciPY 程式庫進行科學計算，使用 PL/V8 進行數據驗證，處理字符串和處理 JSON 數據。 更簡單的是，找到所需的開源自由可用的函數，找出其編寫的語言，在 PostgreSQL 中啟用該特定語言，然後復制代碼。</p>
<p>近年來，我們見證了 NoSQL 資料庫的興起（儘管其中很多可能都被炒作了）。儘管 PostgreSQL 從根本上來說是關係型的，但您會發現很多處理非關係型數據的工具。 PostgreSQL 的 ltree 擴展自遠古時代就已經存在並提供圖形支援。hstore 擴展允許您存儲鍵值對 (Key/Value pairs)。JSON 和 JSONB 類型允許存儲類似於 MongoDB 的文檔。在許多方面，PostgreSQL 甚至在該術語誕生之前就已採用 NoSQL！</p>
<p>這裡就從 Oracle 的資料映對，來快速了解 PostgreSQL，將 Oracle 的 DEPT 與 EMP 資料表轉到 PostgreSQL。</p>
<figure class="highlight sql"><figcaption><span>cr_dept.sql</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> dept</span><br><span class="line">(</span><br><span class="line">  deptno <span class="built_in">numeric</span>(<span class="number">4</span>,<span class="number">0</span>),</span><br><span class="line">  dname  <span class="built_in">varchar</span>(<span class="number">32</span>),</span><br><span class="line">  loc    <span class="built_in">varchar</span>(<span class="number">32</span>),</span><br><span class="line">  <span class="keyword">constraint</span> dept_pk primary <span class="keyword">key</span>(deptno)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><figcaption><span>cr_emp.sql</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> emp</span><br><span class="line">(</span><br><span class="line">  empno    <span class="built_in">numeric</span>(<span class="number">4</span>,<span class="number">0</span>),</span><br><span class="line">  ename    <span class="built_in">varchar</span>(<span class="number">32</span>),</span><br><span class="line">  job      <span class="built_in">varchar</span>(<span class="number">32</span>),</span><br><span class="line">  mgr      <span class="built_in">numeric</span>(<span class="number">4</span>,<span class="number">0</span>),</span><br><span class="line">  hiredate <span class="built_in">date</span>,</span><br><span class="line">  sal      <span class="built_in">numeric</span>(<span class="number">10</span>,<span class="number">2</span>),</span><br><span class="line">  comm     <span class="built_in">numeric</span>(<span class="number">10</span>,<span class="number">2</span>),</span><br><span class="line">  deptno   <span class="built_in">numeric</span>(<span class="number">4</span>,<span class="number">0</span>),</span><br><span class="line">  <span class="keyword">constraint</span> emp_pk primary <span class="keyword">key</span>(empno),</span><br><span class="line">  <span class="keyword">constraint</span> emp_dept_fk <span class="keyword">foreign</span> <span class="keyword">key</span> (deptno) <span class="keyword">references</span> dept(deptno),</span><br><span class="line">  <span class="keyword">constraint</span> emp_manager_fk <span class="keyword">foreign</span> <span class="keyword">key</span> (mgr) <span class="keyword">references</span> emp(empno)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">index</span> emp_deptno_ix <span class="keyword">on</span> emp(deptno);</span><br></pre></td></tr></table></figure>

<p>DDL 語法與 Oracle 幾乎一樣，只有資料型態不同，PostgreSQL 的 date 型態只存到日期，要匹配 Oracle 的 date 型態可改用 timestamp 資料型態。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment"># psql 類似 Oracle Sqlplus</span></span><br><span class="line">$ psql -V</span><br><span class="line">psql (PostgreSQL) 12.3 (Ubuntu 12.3-1.pgdg20.04+1)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 登入 PostgreSQL</span></span><br><span class="line">$ psql -U demo -W -d db01</span><br><span class="line">Password:</span><br><span class="line">psql (12.3 (Ubuntu 12.3-1.pgdg20.04+1))</span><br><span class="line">Type "<span class="keyword">help</span><span class="string">" for help.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">db01=&gt; \i cr_dept.sql</span></span><br><span class="line"><span class="string">CREATE TABLE</span></span><br><span class="line"><span class="string">db01=&gt; \i cr_emp.sql</span></span><br><span class="line"><span class="string">CREATE TABLE</span></span><br><span class="line"><span class="string">CREATE INDEX</span></span><br><span class="line"><span class="string">db01=&gt; \d emp</span></span><br><span class="line"><span class="string">                         Table "</span>demo.emp<span class="string">"</span></span><br><span class="line"><span class="string">  Column  |         Type          | Collation | Nullable | Default</span></span><br><span class="line"><span class="string">----------+-----------------------+-----------+----------+---------</span></span><br><span class="line"><span class="string"> empno    | numeric(4,0)          |           | not null |</span></span><br><span class="line"><span class="string"> ename    | character varying(32) |           |          |</span></span><br><span class="line"><span class="string"> job      | character varying(32) |           |          |</span></span><br><span class="line"><span class="string"> mgr      | numeric(4,0)          |           |          |</span></span><br><span class="line"><span class="string"> hiredate | date                  |           |          |</span></span><br><span class="line"><span class="string"> sal      | numeric(10,2)         |           |          |</span></span><br><span class="line"><span class="string"> comm     | numeric(10,2)         |           |          |</span></span><br><span class="line"><span class="string"> deptno   | numeric(4,0)          |           |          |</span></span><br><span class="line"><span class="string">Indexes:</span></span><br><span class="line"><span class="string">    "</span>emp_pk<span class="string">" PRIMARY KEY, btree (empno)</span></span><br><span class="line"><span class="string">    "</span>emp_deptno_ix<span class="string">" btree (deptno)</span></span><br><span class="line"><span class="string">Foreign-key constraints:</span></span><br><span class="line"><span class="string">    "</span>emp_dept_fk<span class="string">" FOREIGN KEY (deptno) REFERENCES dept(deptno)</span></span><br><span class="line"><span class="string">    "</span>emp_manager_fk<span class="string">" FOREIGN KEY (mgr) REFERENCES emp(empno)</span></span><br><span class="line"><span class="string">Referenced by:</span></span><br><span class="line"><span class="string">    TABLE "</span>emp<span class="string">" CONSTRAINT "</span>emp_manager_fk<span class="string">" FOREIGN KEY (mgr) REFERENCES emp(empno)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">db01=&gt;</span></span><br></pre></td></tr></table></figure>

<p>以下的 CSV 格式資料可以用 SQL Developer 從 Oracle 資料庫 export 出來。</p>
<figure class="highlight sql"><figcaption><span>dept.csv</span></figcaption><table><tr><td class="code"><pre><span class="line">10,"會計部","紐約"</span><br><span class="line">20,"RESEARCH","DALLAS"</span><br><span class="line">30,"SALES","CHICAGO"</span><br><span class="line">40,"OPERATIONS","BOSTON"</span><br><span class="line">70,"資訊部","永康 B4"</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><figcaption><span>emp.csv</span></figcaption><table><tr><td class="code"><pre><span class="line">7839,"KING","PRESIDENT",,1981-11-17,5000,,10</span><br><span class="line">7698,"BLAKE","MANAGER1",7839,1981-05-01,2850,101,30</span><br><span class="line">7782,"楊瑞","MANAGER",7902,1981-06-09,2400,,10</span><br><span class="line">7566,"楊瑞珉","MANAGER",7839,1981-04-02,2975,,20</span><br><span class="line">7788,"SCOTT","ANALYST",7566,1982-12-09,45300,,20</span><br><span class="line">7902,"FORD","ANALYST",7566,1981-12-03,3000,,20</span><br><span class="line">7369,"SMITH","CLERK",7902,1980-12-17,8001,,20</span><br><span class="line">7499,"ALLEN","SALESMAN",7698,1981-02-20,1600,303,30</span><br><span class="line">7608,"馬小九","ANALYST",7788,2010-06-28,1000,100,40</span><br><span class="line">7654,"葉習堃","SALESMAN",7698,1981-09-28,1250,1400,30</span><br><span class="line">7844,"하찮고","SALESMAN",7698,1981-09-08,1500,,30</span><br><span class="line">7876,"ADAMS","CLERK",7788,1983-01-12,1100,,20</span><br><span class="line">7900,"JAMES","CLERK",7698,1981-12-03,94998,,30</span><br><span class="line">7934,"楊喆","CLERK",7902,1982-01-23,1500,,10</span><br><span class="line">9006,"林羿君","ANALYST",7788,2001-05-07,66666,,70</span><br><span class="line">7607,"バック","分析師",7788,2008-03-24,45000,100,70</span><br><span class="line">7609,"蔡大一","分析師",7788,2010-06-28,60000,,70</span><br><span class="line">9011,"文英蔡","總鋪師",7788,2018-08-28,77778,180,40</span><br><span class="line">8907,"牸祢","ANALYST",7566,1982-12-09,9002,,10</span><br></pre></td></tr></table></figure>

<p>將它 import 到 PostgreSQL。</p>
<figure class="highlight"><figcaption><span>import data</span></figcaption><table><tr><td class="code"><pre><span class="line">db01=&gt; \copy dept from 'dept.csv' with csv;</span><br><span class="line">COPY 5</span><br><span class="line">db01=&gt; \copy emp from 'emp.csv' with csv;</span><br><span class="line">COPY 19</span><br><span class="line">db01=&gt; select * from emp;</span><br><span class="line"> empno | ename  |    job    | mgr  |  hiredate  |   sal    |  comm   | deptno</span><br><span class="line"><span class="comment">-------+--------+-----------+------+------------+----------+---------+--------</span></span><br><span class="line">  7839 | KING   | PRESIDENT |      | 1981-11-17 |  5000.00 |         |     10</span><br><span class="line">  7698 | BLAKE  | MANAGER1  | 7839 | 1981-05-01 |  2850.00 |  101.00 |     30</span><br><span class="line">  7782 | 楊瑞  | MANAGER   | 7902 | 1981-06-09 |  2400.00 |         |     10</span><br><span class="line">  7566 | 楊瑞珉 | MANAGER   | 7839 | 1981-04-02 |  2975.00 |         |     20</span><br><span class="line">  7788 | SCOTT  | ANALYST   | 7566 | 1982-12-09 | 45300.00 |         |     20</span><br><span class="line">  7902 | FORD   | ANALYST   | 7566 | 1981-12-03 |  3000.00 |         |     20</span><br><span class="line">  7369 | SMITH  | CLERK     | 7902 | 1980-12-17 |  8001.00 |         |     20</span><br><span class="line">  7499 | ALLEN  | SALESMAN  | 7698 | 1981-02-20 |  1600.00 |  303.00 |     30</span><br><span class="line">  7608 | 馬小九 | ANALYST   | 7788 | 2010-06-28 |  1000.00 |  100.00 |     40</span><br><span class="line">  7654 | 葉習堃 | SALESMAN  | 7698 | 1981-09-28 |  1250.00 | 1400.00 |     30</span><br><span class="line">  7844 | 하찮고 | SALESMAN  | 7698 | 1981-09-08 |  1500.00 |         |     30</span><br><span class="line">  7876 | ADAMS  | CLERK     | 7788 | 1983-01-12 |  1100.00 |         |     20</span><br><span class="line">  7900 | JAMES  | CLERK     | 7698 | 1981-12-03 | 94998.00 |         |     30</span><br><span class="line">  7934 | 楊喆   | CLERK     | 7902 | 1982-01-23 |  1500.00 |         |     10</span><br><span class="line">  9006 | 林羿君 | ANALYST   | 7788 | 2001-05-07 | 66666.00 |         |     70</span><br><span class="line">  7607 | バック | 分析師    | 7788 | 2008-03-24 | 45000.00 |  100.00 |     70</span><br><span class="line">  7609 | 蔡大一 | 分析師    | 7788 | 2010-06-28 | 60000.00 |         |     70</span><br><span class="line">  9011 | 文英蔡 | 總鋪師    | 7788 | 2018-08-28 | 77778.00 |  180.00 |     40</span><br><span class="line">  8907 | 牸祢   | ANALYST   | 7566 | 1982-12-09 |  9002.00 |         |     10</span><br><span class="line">(19 rows)</span><br><span class="line"></span><br><span class="line">db01=&gt;</span><br></pre></td></tr></table></figure>

<p>PostgreSQL 提供 JSON 和許多支援的功能。JSON 已成為 Web 應用程序中最流行的數據交換格式。也支援 JSONB 資料型態。</p>
<figure class="highlight sql"><figcaption><span>row_to_json</span></figcaption><table><tr><td class="code"><pre><span class="line">db01=&gt; select row_to_json(emp) as employee from emp;</span><br><span class="line"></span><br><span class="line">                                                          employee                                                          </span><br><span class="line"><span class="comment">-----------------------------------------------------------------------------------------------------------------------------</span></span><br><span class="line"> &#123;"empno":7839,"ename":"KING","job":"PRESIDENT","mgr":null,"hiredate":"1981-11-17","sal":5000.00,"comm":null,"deptno":10&#125;</span><br><span class="line"> &#123;"empno":7698,"ename":"BLAKE","job":"MANAGER1","mgr":7839,"hiredate":"1981-05-01","sal":2850.00,"comm":101.00,"deptno":30&#125;</span><br><span class="line"> &#123;"empno":7782,"ename":"楊瑞","job":"MANAGER","mgr":7902,"hiredate":"1981-06-09","sal":2400.00,"comm":null,"deptno":10&#125;</span><br><span class="line"> &#123;"empno":7566,"ename":"楊瑞珉","job":"MANAGER","mgr":7839,"hiredate":"1981-04-02","sal":2975.00,"comm":null,"deptno":20&#125;</span><br><span class="line"> &#123;"empno":7788,"ename":"SCOTT","job":"ANALYST","mgr":7566,"hiredate":"1982-12-09","sal":45300.00,"comm":null,"deptno":20&#125;</span><br><span class="line"> &#123;"empno":7902,"ename":"FORD","job":"ANALYST","mgr":7566,"hiredate":"1981-12-03","sal":3000.00,"comm":null,"deptno":20&#125;</span><br><span class="line"> &#123;"empno":7369,"ename":"SMITH","job":"CLERK","mgr":7902,"hiredate":"1980-12-17","sal":8001.00,"comm":null,"deptno":20&#125;</span><br><span class="line"> &#123;"empno":7499,"ename":"ALLEN","job":"SALESMAN","mgr":7698,"hiredate":"1981-02-20","sal":1600.00,"comm":303.00,"deptno":30&#125;</span><br><span class="line"> &#123;"empno":7608,"ename":"馬小九","job":"ANALYST","mgr":7788,"hiredate":"2010-06-28","sal":1000.00,"comm":100.00,"deptno":40&#125;</span><br><span class="line"> &#123;"empno":7654,"ename":"葉習堃","job":"SALESMAN","mgr":7698,"hiredate":"1981-09-28","sal":1250.00,"comm":1400.00,"deptno":30&#125;</span><br><span class="line"> &#123;"empno":7844,"ename":"하찮고","job":"SALESMAN","mgr":7698,"hiredate":"1981-09-08","sal":1500.00,"comm":null,"deptno":30&#125;</span><br><span class="line"> &#123;"empno":7876,"ename":"ADAMS","job":"CLERK","mgr":7788,"hiredate":"1983-01-12","sal":1100.00,"comm":null,"deptno":20&#125;</span><br><span class="line"> &#123;"empno":7900,"ename":"JAMES","job":"CLERK","mgr":7698,"hiredate":"1981-12-03","sal":94998.00,"comm":null,"deptno":30&#125;</span><br><span class="line"> &#123;"empno":7934,"ename":"楊喆","job":"CLERK","mgr":7902,"hiredate":"1982-01-23","sal":1500.00,"comm":null,"deptno":10&#125;</span><br><span class="line"> &#123;"empno":9006,"ename":"林羿君","job":"ANALYST","mgr":7788,"hiredate":"2001-05-07","sal":66666.00,"comm":null,"deptno":70&#125;</span><br><span class="line"> &#123;"empno":7607,"ename":"バック","job":"分析師","mgr":7788,"hiredate":"2008-03-24","sal":45000.00,"comm":100.00,"deptno":70&#125;</span><br><span class="line"> &#123;"empno":7609,"ename":"蔡大一","job":"分析師","mgr":7788,"hiredate":"2010-06-28","sal":60000.00,"comm":null,"deptno":70&#125;</span><br><span class="line"> &#123;"empno":9011,"ename":"文英蔡","job":"總鋪師","mgr":7788,"hiredate":"2018-08-28","sal":77778.00,"comm":180.00,"deptno":40&#125;</span><br><span class="line"> &#123;"empno":8907,"ename":"牸祢","job":"ANALYST","mgr":7566,"hiredate":"1982-12-09","sal":9002.00,"comm":null,"deptno":10&#125;</span><br><span class="line">(19 rows)</span><br></pre></td></tr></table></figure>

<p>PostgreSQL 資料準備好了，回到 C#。</p>
<h4 id="C-EFCore-2-0-and-PostgreSQL-Provider"><a href="#C-EFCore-2-0-and-PostgreSQL-Provider" class="headerlink" title="C# EFCore 2.0 and PostgreSQL Provider"></a>C# EFCore 2.0 and PostgreSQL Provider</h4><p>開啟 VS Code 建立一個專案。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ &gt; dotnet new console --name PgEFCoreSample</span><br><span class="line"></span><br><span class="line">$ &gt; <span class="built_in">cd</span> PgEFCoreSample</span><br><span class="line"></span><br><span class="line">$ PgEFCoreSample&gt; dotnet run</span><br><span class="line">Hello World!</span><br></pre></td></tr></table></figure>

<p>首先要安裝專案需要的 NuGet Packages，這裡只需要將 Oracle Provider 換成 PostgreSQL Provider。這裡因用的 PostgreSQL Provider Npgsql.EntityFrameworkCore.PostgreSQL 版本比較新，所以也將 Microsoft EntityFramework Core 的版本更新。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ PgEFCoreSample&gt; dotnet add package Npgsql.EntityFrameworkCore.PostgreSQL --version 3.1.4 </span><br><span class="line"></span><br><span class="line">$ PgEFCoreSample&gt; dotnet add package Microsoft.EntityFrameworkCore.Design --version 3.1.4</span><br><span class="line"></span><br><span class="line">$ PgEFCoreSample&gt; dotnet add package Microsoft.EntityFrameworkCore.Relational --version 3.1.4</span><br><span class="line"></span><br><span class="line">$ PgEFCoreSample&gt; dotnet add package Microsoft.Extensions.Configuration.Json --version 3.1.4</span><br></pre></td></tr></table></figure>

<p>現在專案目錄下的 PgEFCoreSample.csproj 檔案應該如下:</p>
<figure class="highlight xml"><figcaption><span>PgEFCoreSample.csproj</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Project</span> <span class="attr">Sdk</span>=<span class="string">"Microsoft.NET.Sdk"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">PropertyGroup</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">OutputType</span>&gt;</span>Exe<span class="tag">&lt;/<span class="name">OutputType</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">TargetFramework</span>&gt;</span>netcoreapp3.1<span class="tag">&lt;/<span class="name">TargetFramework</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">PropertyGroup</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">ItemGroup</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">PackageReference</span> <span class="attr">Include</span>=<span class="string">"Microsoft.EntityFrameworkCore.Design"</span> <span class="attr">Version</span>=<span class="string">"3.1.4"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">IncludeAssets</span>&gt;</span>runtime; build; native; contentfiles; analyzers; buildtransitive<span class="tag">&lt;/<span class="name">IncludeAssets</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">PrivateAssets</span>&gt;</span>all<span class="tag">&lt;/<span class="name">PrivateAssets</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">PackageReference</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">PackageReference</span> <span class="attr">Include</span>=<span class="string">"Microsoft.EntityFrameworkCore.Relational"</span> <span class="attr">Version</span>=<span class="string">"3.1.4"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">PackageReference</span> <span class="attr">Include</span>=<span class="string">"Microsoft.Extensions.Configuration.Json"</span> <span class="attr">Version</span>=<span class="string">"3.1.4"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">PackageReference</span> <span class="attr">Include</span>=<span class="string">"Npgsql.EntityFrameworkCore.PostgreSQL"</span> <span class="attr">Version</span>=<span class="string">"3.1.4"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">ItemGroup</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">Project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>這裡也將 PostgreSQL 資料庫的連結資料放在 appsettings.json</p>
<figure class="highlight json"><figcaption><span>appsettings.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"Data"</span>: &#123;</span><br><span class="line">    <span class="attr">"DefaultConnection"</span>: &#123;</span><br><span class="line">      <span class="attr">"ConnectionString"</span>: <span class="string">"Host=10.11.xx.xxx;Database=db01;Username=xxx;Password=xxxxxxxxxx"</span> </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>PostgreSQL 資料庫位在我的 PC 虛擬機 Ubuntu Linux 上，只開放在上班時間。</p>
<h4 id="反向工程-Reverse-Engineering"><a href="#反向工程-Reverse-Engineering" class="headerlink" title="反向工程 (Reverse Engineering)"></a>反向工程 (Reverse Engineering)</h4><p>直接使用反向工程產生資料模型。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ PgEFCoreSample&gt; dotnet ef dbcontext scaffold <span class="string">"Host=10.11.xx.xxx;Database=db01;Username=xxxx;Password=xxxxxxxx"</span> Npgsql.EntityFrameworkCore.PostgreSQL --table emp --table dept -o Models -f </span><br></pre></td></tr></table></figure>

<p>它會在專案目錄下產生子目錄 Models 與 Dept.cs、Emp.cs 與 db01Context.cs。 這裡只要修改 db01Context.cs 的資料庫連結資料，讀取 appsettings.json 的設定。其他都不用動。</p>
<figure class="highlight csharp"><figcaption><span>Models/db01Context.cs</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> Microsoft.EntityFrameworkCore;</span><br><span class="line"><span class="keyword">using</span> Microsoft.EntityFrameworkCore.Metadata;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Extensions.Configuration;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Extensions.Configuration.Json;</span><br><span class="line">.....</span><br><span class="line">        optionsBuilder.UseNpgsql(GetConnectionString());</span><br><span class="line">.....</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">string</span> <span class="title">GetConnectionString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">      <span class="keyword">var</span> configurationBuilder = <span class="keyword">new</span> ConfigurationBuilder()</span><br><span class="line">        .SetBasePath(Directory.GetCurrentDirectory())</span><br><span class="line">        .AddJsonFile(<span class="string">"appsettings.json"</span>);</span><br><span class="line">      IConfiguration config = configurationBuilder.Build();</span><br><span class="line">      <span class="keyword">string</span> connectionString = config[<span class="string">"Data:DefaultConnection:ConnectionString"</span>];</span><br><span class="line">      <span class="keyword">return</span> connectionString;</span><br><span class="line">    &#125;</span><br><span class="line">.....</span><br></pre></td></tr></table></figure>

<h4 id="資料讀取"><a href="#資料讀取" class="headerlink" title="資料讀取"></a>資料讀取</h4><figure class="highlight csharp"><figcaption><span>program.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> PgEFCoreSample.Models;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">PgEFCoreSample</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="keyword">string</span>[] args</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">      Console.WriteLine(<span class="string">"Hello Tainan! 台南! PostgreSQL!"</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">using</span> (<span class="keyword">var</span> db = <span class="keyword">new</span> db01Context())</span><br><span class="line">      &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">"===== Departments =========="</span>);</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> dept <span class="keyword">in</span> db.Dept)</span><br><span class="line">        &#123;</span><br><span class="line">          Console.WriteLine(<span class="string">$"<span class="subst">&#123;dept.Deptno&#125;</span> <span class="subst">&#123;dept.Dname&#125;</span> <span class="subst">&#123;dept.Loc&#125;</span>"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Console.WriteLine(<span class="string">"===== Employees =========="</span>);</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> emp <span class="keyword">in</span> db.Emp)</span><br><span class="line">        &#123;</span><br><span class="line">          Console.WriteLine(<span class="string">$"<span class="subst">&#123;emp.Empno&#125;</span> <span class="subst">&#123;emp.Ename&#125;</span> <span class="subst">&#123;emp.Job&#125;</span> <span class="subst">&#123;emp.Mgr&#125;</span> <span class="subst">&#123;emp.Hiredate?.ToString(<span class="string">"yyyy-MM-ddTHH:mm:ss"</span>)&#125;</span> <span class="subst">&#123;emp.Sal&#125;</span> <span class="subst">&#123;emp.Comm&#125;</span> <span class="subst">&#123;emp.Deptno&#125;</span>"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ PgEFCoreSample&gt; dotnet run</span><br><span class="line">Hello Tainan! 台南! PostgreSQL!</span><br><span class="line">===== Departments ==========</span><br><span class="line">10 會計部 紐約</span><br><span class="line">20 RESEARCH DALLAS</span><br><span class="line">30 SALES CHICAGO</span><br><span class="line">40 OPERATIONS BOSTON</span><br><span class="line">70 資訊部 永康 B4</span><br><span class="line">===== Employees ==========</span><br><span class="line">7839 KING PRESIDENT  1981-11-17T00:00:00 5000.00  10</span><br><span class="line">.....</span><br></pre></td></tr></table></figure>

<p>這與使用 <a href="/2020/06/04/C-Entity-Framework-Core-2-0-and-Oracle-Provider/">Oracle Provider</a> 的程式碼，只有 <strong>db01Context</strong> 名稱不一樣，其他都一樣。你可以複製新增、修改、刪除與其它程式碼來試試看。更換資料庫，只要抽換掉資料庫的 Provider。</p>
<h4 id="PostgreSQL-Schema-範例"><a href="#PostgreSQL-Schema-範例" class="headerlink" title="PostgreSQL Schema 範例"></a>PostgreSQL Schema 範例</h4><p>這裡提供一個比較實用的 PostgreSQL Schema 範例，這原來是 Oracle 的 Schema。其實 DDL 都一樣，需要改的是資料型態。</p>
<img src="/2020/06/12/C-Entity-Framework-Core-2-0-and-PostgreSQL-Provider/ot-schema-061501.png" title="OT Schema">

<p>這裡是 DDL 範例與範例資料 <a href="/2020/06/12/C-Entity-Framework-Core-2-0-and-PostgreSQL-Provider/demo_ot_data.sql">demo_ot_data.sql</a>。</p>
<figure class="highlight sql"><figcaption><span>demo_ot_schema.sql</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> regions</span><br><span class="line">  (</span><br><span class="line">    region_id   <span class="built_in">INTEGER</span> <span class="keyword">GENERATED</span> <span class="keyword">BY</span> <span class="keyword">DEFAULT</span> <span class="keyword">AS</span> <span class="keyword">IDENTITY</span> (<span class="keyword">START</span> <span class="keyword">WITH</span> <span class="number">5</span>) PRIMARY <span class="keyword">KEY</span>,</span><br><span class="line">    region_name <span class="built_in">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span></span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> countries</span><br><span class="line">  (</span><br><span class="line">    country_id    <span class="built_in">CHAR</span>(<span class="number">2</span>) PRIMARY <span class="keyword">KEY</span>,</span><br><span class="line">    country_name  <span class="built_in">VARCHAR</span>(<span class="number">40</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">     region_id    <span class="built_in">INTEGER</span>,</span><br><span class="line">    <span class="keyword">CONSTRAINT</span> fk_countries_regions <span class="keyword">FOREIGN</span> <span class="keyword">KEY</span> (region_id)</span><br><span class="line">      <span class="keyword">REFERENCES</span> regions(region_id)</span><br><span class="line">      <span class="keyword">ON</span> <span class="keyword">DELETE</span> <span class="keyword">CASCADE</span></span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> locations</span><br><span class="line">  (</span><br><span class="line">    location_id <span class="built_in">INTEGER</span> <span class="keyword">GENERATED</span> <span class="keyword">BY</span> <span class="keyword">DEFAULT</span> <span class="keyword">AS</span> <span class="keyword">IDENTITY</span> (<span class="keyword">START</span> <span class="keyword">WITH</span> <span class="number">24</span>) PRIMARY <span class="keyword">KEY</span>,</span><br><span class="line">    address     <span class="built_in">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    postal_code <span class="built_in">VARCHAR</span>(<span class="number">20</span>),</span><br><span class="line">    city        <span class="built_in">VARCHAR</span>(<span class="number">50</span>),</span><br><span class="line">    state       <span class="built_in">VARCHAR</span>(<span class="number">50</span>),</span><br><span class="line">    country_id  <span class="built_in">CHAR</span>(<span class="number">2</span>),    </span><br><span class="line">    <span class="keyword">CONSTRAINT</span> fk_locations_countries <span class="keyword">FOREIGN</span> <span class="keyword">KEY</span> (country_id)</span><br><span class="line">      <span class="keyword">REFERENCES</span> countries(country_id) </span><br><span class="line">      <span class="keyword">ON</span> <span class="keyword">DELETE</span> <span class="keyword">CASCADE</span></span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> warehouses</span><br><span class="line">  (</span><br><span class="line">    warehouse_id   <span class="built_in">INTEGER</span> <span class="keyword">GENERATED</span> <span class="keyword">BY</span> <span class="keyword">DEFAULT</span> <span class="keyword">AS</span> <span class="keyword">IDENTITY</span> (<span class="keyword">START</span> <span class="keyword">WITH</span> <span class="number">10</span>) PRIMARY <span class="keyword">KEY</span>,</span><br><span class="line">    warehouse_name <span class="built_in">VARCHAR</span>(<span class="number">255</span>),</span><br><span class="line">    location_id    <span class="built_in">INTEGER</span>, </span><br><span class="line">    <span class="keyword">CONSTRAINT</span> fk_warehouses_locations </span><br><span class="line">      <span class="keyword">FOREIGN</span> <span class="keyword">KEY</span> (location_id)</span><br><span class="line">      <span class="keyword">REFERENCES</span> locations(location_id) </span><br><span class="line">      <span class="keyword">ON</span> <span class="keyword">DELETE</span> <span class="keyword">CASCADE</span></span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> employees</span><br><span class="line">  (</span><br><span class="line">    employee_id <span class="built_in">INTEGER</span> <span class="keyword">GENERATED</span> <span class="keyword">BY</span> <span class="keyword">DEFAULT</span> <span class="keyword">AS</span> <span class="keyword">IDENTITY</span> (<span class="keyword">START</span> <span class="keyword">WITH</span> <span class="number">108</span>) PRIMARY <span class="keyword">KEY</span>,</span><br><span class="line">    first_name  <span class="built_in">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    last_name   <span class="built_in">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    email       <span class="built_in">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    phone       <span class="built_in">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> ,</span><br><span class="line">    hire_date   <span class="built_in">TIMESTAMP</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>          ,</span><br><span class="line">    manager_id  <span class="built_in">INTEGER</span> ,</span><br><span class="line">    job_title   <span class="built_in">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    <span class="keyword">CONSTRAINT</span> fk_employees_manager </span><br><span class="line">        <span class="keyword">FOREIGN</span> <span class="keyword">KEY</span> (manager_id)</span><br><span class="line">        <span class="keyword">REFERENCES</span> employees(employee_id)</span><br><span class="line">        <span class="keyword">ON</span> <span class="keyword">DELETE</span> <span class="keyword">CASCADE</span></span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> product_categories</span><br><span class="line">  (</span><br><span class="line">    category_id <span class="built_in">INTEGER</span> <span class="keyword">GENERATED</span> <span class="keyword">BY</span> <span class="keyword">DEFAULT</span> <span class="keyword">AS</span> <span class="keyword">IDENTITY</span> (<span class="keyword">START</span> <span class="keyword">WITH</span> <span class="number">6</span>) PRIMARY <span class="keyword">KEY</span>,</span><br><span class="line">    category_name <span class="built_in">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span></span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> products</span><br><span class="line">  (</span><br><span class="line">    product_id <span class="built_in">INTEGER</span> <span class="keyword">GENERATED</span> <span class="keyword">BY</span> <span class="keyword">DEFAULT</span> <span class="keyword">AS</span> <span class="keyword">IDENTITY</span> (<span class="keyword">START</span> <span class="keyword">WITH</span> <span class="number">289</span>) PRIMARY <span class="keyword">KEY</span>,</span><br><span class="line">    product_name  <span class="built_in">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    description   <span class="built_in">VARCHAR</span>(<span class="number">2000</span>),</span><br><span class="line">    standard_cost <span class="built_in">NUMERIC</span>(<span class="number">9</span>, <span class="number">2</span>),</span><br><span class="line">    list_price    <span class="built_in">NUMERIC</span>(<span class="number">9</span>, <span class="number">2</span>),</span><br><span class="line">    category_id   <span class="built_in">INTEGER</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> ,</span><br><span class="line">    <span class="keyword">CONSTRAINT</span> fk_products_categories </span><br><span class="line">      <span class="keyword">FOREIGN</span> <span class="keyword">KEY</span> (category_id)</span><br><span class="line">      <span class="keyword">REFERENCES</span> product_categories(category_id) </span><br><span class="line">      <span class="keyword">ON</span> <span class="keyword">DELETE</span> <span class="keyword">CASCADE</span></span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> customers</span><br><span class="line">  (</span><br><span class="line">    customer_id  <span class="built_in">INTEGER</span> <span class="keyword">GENERATED</span> <span class="keyword">BY</span> <span class="keyword">DEFAULT</span> <span class="keyword">AS</span> <span class="keyword">IDENTITY</span> (<span class="keyword">START</span> <span class="keyword">WITH</span> <span class="number">320</span>) PRIMARY <span class="keyword">KEY</span>,</span><br><span class="line">    <span class="keyword">name</span>         <span class="built_in">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    address      <span class="built_in">VARCHAR</span>(<span class="number">255</span>),</span><br><span class="line">    website      <span class="built_in">VARCHAR</span>(<span class="number">255</span>),</span><br><span class="line">    credit_limit <span class="built_in">NUMERIC</span>(<span class="number">8</span>, <span class="number">2</span>)</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> contacts</span><br><span class="line">  (</span><br><span class="line">    contact_id  <span class="built_in">INTEGER</span> <span class="keyword">GENERATED</span> <span class="keyword">BY</span> <span class="keyword">DEFAULT</span> <span class="keyword">AS</span> <span class="keyword">IDENTITY</span> (<span class="keyword">START</span> <span class="keyword">WITH</span> <span class="number">320</span>) PRIMARY <span class="keyword">KEY</span>,</span><br><span class="line">    first_name  <span class="built_in">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    last_name   <span class="built_in">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    email       <span class="built_in">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    phone       <span class="built_in">VARCHAR</span>(<span class="number">20</span>),</span><br><span class="line">    customer_id <span class="built_in">INTEGER</span>,</span><br><span class="line">    <span class="keyword">CONSTRAINT</span> fk_contacts_customers </span><br><span class="line">      <span class="keyword">FOREIGN</span> <span class="keyword">KEY</span> (customer_id)</span><br><span class="line">      <span class="keyword">REFERENCES</span> customers(customer_id) </span><br><span class="line">      <span class="keyword">ON</span> <span class="keyword">DELETE</span> <span class="keyword">CASCADE</span></span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> orders</span><br><span class="line">  (</span><br><span class="line">    order_id    <span class="built_in">INTEGER</span> <span class="keyword">GENERATED</span> <span class="keyword">BY</span> <span class="keyword">DEFAULT</span> <span class="keyword">AS</span> <span class="keyword">IDENTITY</span> (<span class="keyword">START</span> <span class="keyword">WITH</span> <span class="number">106</span>) PRIMARY <span class="keyword">KEY</span>,</span><br><span class="line">    customer_id <span class="built_in">INTEGER</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    <span class="keyword">status</span>      <span class="built_in">VARCHAR</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    salesman_id <span class="built_in">INTEGER</span>,</span><br><span class="line">    order_date  <span class="built_in">TIMESTAMP</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    <span class="keyword">CONSTRAINT</span> fk_orders_customers </span><br><span class="line">      <span class="keyword">FOREIGN</span> <span class="keyword">KEY</span> (customer_id)</span><br><span class="line">      <span class="keyword">REFERENCES</span> customers(customer_id)</span><br><span class="line">      <span class="keyword">ON</span> <span class="keyword">DELETE</span> <span class="keyword">CASCADE</span>,</span><br><span class="line">    <span class="keyword">CONSTRAINT</span> fk_orders_employees </span><br><span class="line">      <span class="keyword">FOREIGN</span> <span class="keyword">KEY</span> (salesman_id)</span><br><span class="line">      <span class="keyword">REFERENCES</span> employees(employee_id) </span><br><span class="line">      <span class="keyword">ON</span> <span class="keyword">DELETE</span> <span class="keyword">SET</span> <span class="literal">NULL</span></span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> order_items</span><br><span class="line">  (</span><br><span class="line">    order_id   <span class="built_in">INTEGER</span>, </span><br><span class="line">    item_id    <span class="built_in">INTEGER</span>,</span><br><span class="line">    product_id <span class="built_in">INTEGER</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    quantity   <span class="built_in">NUMERIC</span>(<span class="number">8</span>, <span class="number">2</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    unit_price <span class="built_in">NUMERIC</span>(<span class="number">8</span>, <span class="number">2</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    <span class="keyword">CONSTRAINT</span> pk_order_items </span><br><span class="line">      PRIMARY <span class="keyword">KEY</span> (order_id, item_id),</span><br><span class="line">    <span class="keyword">CONSTRAINT</span> fk_order_items_products </span><br><span class="line">      <span class="keyword">FOREIGN</span> <span class="keyword">KEY</span> (product_id)</span><br><span class="line">      <span class="keyword">REFERENCES</span> products(product_id) </span><br><span class="line">      <span class="keyword">ON</span> <span class="keyword">DELETE</span> <span class="keyword">CASCADE</span>,</span><br><span class="line">    <span class="keyword">CONSTRAINT</span> fk_order_items_orders </span><br><span class="line">      <span class="keyword">FOREIGN</span> <span class="keyword">KEY</span> (order_id)</span><br><span class="line">      <span class="keyword">REFERENCES</span> orders(order_id) </span><br><span class="line">      <span class="keyword">ON</span> <span class="keyword">DELETE</span> <span class="keyword">CASCADE</span></span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> inventories</span><br><span class="line">  (</span><br><span class="line">    product_id   <span class="built_in">INTEGER</span>,</span><br><span class="line">    warehouse_id <span class="built_in">INTEGER</span>,</span><br><span class="line">    quantity     <span class="built_in">NUMERIC</span>(<span class="number">8</span>, <span class="number">0</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    <span class="keyword">CONSTRAINT</span> pk_inventories </span><br><span class="line">      PRIMARY <span class="keyword">KEY</span> (product_id, warehouse_id),</span><br><span class="line">    <span class="keyword">CONSTRAINT</span> fk_inventories_products </span><br><span class="line">      <span class="keyword">FOREIGN</span> <span class="keyword">KEY</span> (product_id)</span><br><span class="line">      <span class="keyword">REFERENCES</span> products(product_id) </span><br><span class="line">      <span class="keyword">ON</span> <span class="keyword">DELETE</span> <span class="keyword">CASCADE</span>,</span><br><span class="line">    <span class="keyword">CONSTRAINT</span> fk_inventories_warehouses </span><br><span class="line">      <span class="keyword">FOREIGN</span> <span class="keyword">KEY</span> (warehouse_id)</span><br><span class="line">      <span class="keyword">REFERENCES</span> warehouses(warehouse_id) </span><br><span class="line">      <span class="keyword">ON</span> <span class="keyword">DELETE</span> <span class="keyword">CASCADE</span></span><br><span class="line">  );</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://1184yang.github.io/2020/06/12/C-Entity-Framework-Core-2-0-and-PostgreSQL-Provider/" data-id="ckcpzj959000280vzhdehn6ls" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-C-Entity-Framework-Core-2-0-and-Oracle-Provider" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/06/04/C-Entity-Framework-Core-2-0-and-Oracle-Provider/" class="article-date">
  <time datetime="2020-06-03T23:37:09.000Z" itemprop="datePublished">2020-06-04</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/C/">C#</a>►<a class="article-category-link" href="/categories/Oracle/">Oracle</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/06/04/C-Entity-Framework-Core-2-0-and-Oracle-Provider/">C# Entity Framework Core 2.0 and Oracle Provider</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Entity Framework Core (EF Core) 是一個提供了實體、關係映射的架構，通過它們，可以創建映射到資料庫的類型，使用 LINQ 創建資料庫查詢、新增和更新物件，把它們寫入資料庫。</p>
<p>Entity Framework 經過多年的改變，Entity Framework Core (EF Core) 已完全重寫了。不僅可以在 Windows 上使用，也可以在 Linux 和 Mac 上使用。他支持關聯式資料庫和 NoSQL 數據存儲。</p>
<p>這裡要使用 EF Core 建立一個簡單的模型讀寫來自 Oracle 資料庫 DEPT 與 EMP 資料表的資料，所以這裡會有 Dept 與 Emp 兩個類型映射到 Oracle 資料庫的這兩個資料表。把資料寫入資料庫，讀取、更新和刪除它們。</p>
<p>我使用 Visual Studio Code 開發，所以你的機器必須安裝 <a href="https://dotnet.microsoft.com/download" target="_blank" rel="noopener">.NET Core SDK</a>。你如果要使用 EF Core 的<a href="https://docs.microsoft.com/zh-tw/ef/core/managing-schemas/scaffolding?tabs=dotnet-core-cli" target="_blank" rel="noopener">反向工程</a>，則還必須安裝<a href="https://docs.microsoft.com/zh-tw/ef/core/miscellaneous/cli/dotnet" target="_blank" rel="noopener">Entity Framework Core 工具參考 - .NET CLI</a>。</p>
<p>反向工程可以幫你把資料庫的資料表(Table)產生 C# 的類型與映射，開始先不談反向工程，以免失焦及複雜化，後面再來補充說明。</p>
<p>開啟 VS Code 建立一個專案。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ &gt; dotnet --version</span><br><span class="line">3.1.201</span><br><span class="line"></span><br><span class="line">$ &gt; dotnet new console --name OracleEFCoreSample</span><br><span class="line">The template <span class="string">"Console Application"</span> was created successfully.</span><br><span class="line"></span><br><span class="line">Processing post-creation actions...</span><br><span class="line">Running <span class="string">'dotnet restore'</span> on OracleEFCoreSample\OracleEFCoreSample.csproj...</span><br><span class="line">  I:\u01\projects\OracleEFCoreSample\OracleEFCoreSample.csproj 的還原於 238.4 ms 完成。</span><br><span class="line"></span><br><span class="line">Restore succeeded.</span><br><span class="line"></span><br><span class="line">$ &gt; <span class="built_in">cd</span> OracleEFCoreSample</span><br><span class="line"></span><br><span class="line">$ OracleEFCoreSample&gt; dotnet run</span><br><span class="line">Hello World!</span><br></pre></td></tr></table></figure>

<p>這就開始了，直接使用 VS Code 打開 OracleEFCoreSample 專案目錄，首先要安裝專案需要的 NuGet Packages，可以到 <a href="https://www.nuget.org/packages/" target="_blank" rel="noopener">NuGet Gallery</a> 尋找，注意不要裝錯版本。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ OracleEFCoreSample&gt; dotnet add package Oracle.EntityFrameworkCore --version 2.19.70</span><br><span class="line"></span><br><span class="line">$ OracleEFCoreSample&gt; dotnet add package Microsoft.EntityFrameworkCore.Design --version 2.2.6</span><br><span class="line"></span><br><span class="line">$ OracleEFCoreSample&gt; dotnet add package Microsoft.EntityFrameworkCore.Relational --version 2.2.6</span><br><span class="line"></span><br><span class="line">$ OracleEFCoreSample&gt; dotnet add package Microsoft.Extensions.Configuration.Json --version 3.1.4</span><br></pre></td></tr></table></figure>

<p>現在專案目錄下的 OracleEFCoreSample.csproj 檔案應該如下:</p>
<figure class="highlight xml"><figcaption><span>OracleEFCoreSample.csproj</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Project</span> <span class="attr">Sdk</span>=<span class="string">"Microsoft.NET.Sdk"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">PropertyGroup</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">OutputType</span>&gt;</span>Exe<span class="tag">&lt;/<span class="name">OutputType</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">TargetFramework</span>&gt;</span>netcoreapp3.1<span class="tag">&lt;/<span class="name">TargetFramework</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">PropertyGroup</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">ItemGroup</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">PackageReference</span> <span class="attr">Include</span>=<span class="string">"Microsoft.EntityFrameworkCore.Design"</span> <span class="attr">Version</span>=<span class="string">"2.2.6"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">PackageReference</span> <span class="attr">Include</span>=<span class="string">"Microsoft.EntityFrameworkCore.Relational"</span> <span class="attr">Version</span>=<span class="string">"2.2.6"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">PackageReference</span> <span class="attr">Include</span>=<span class="string">"Microsoft.Extensions.Configuration.Json"</span> <span class="attr">Version</span>=<span class="string">"3.1.4"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">PackageReference</span> <span class="attr">Include</span>=<span class="string">"Oracle.EntityFrameworkCore"</span> <span class="attr">Version</span>=<span class="string">"2.19.70"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">ItemGroup</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">Project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>一切就緒，首先在專案目錄下開一個 JSON 檔案 appsettings.json， 將專案程式的設定放在此，目前要放的是 Oracle 資料庫的 ConnectionString。</p>
<figure class="highlight json"><figcaption><span>appsettings.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"Data"</span>: &#123;</span><br><span class="line">    <span class="attr">"DefaultConnection"</span>: &#123;</span><br><span class="line">      <span class="attr">"ConnectionString"</span>: <span class="string">"User Id=xxxx;Password=xxxxxxxx;Data Source=10.11.xx.xxx:1522/xxxx.xxx.com.tw;Connection Timeout=600;min pool size=0;connection lifetime=18000;PERSIST SECURITY INFO=True;"</span> </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="創建模型"><a href="#創建模型" class="headerlink" title="創建模型"></a>創建模型</h4><p>這裡要定義兩個實體類型 Dept 與 Emp，分別映射到 Oracle 資料庫 DEPT 與 EMP 資料表。</p>
<p>在專案目錄下建立一個子目錄 Models 來擺放 Dept.cs 與 Emp.cs。</p>
<figure class="highlight csharp"><figcaption><span>Models/Dept.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">OracleEFCoreSample.Models</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">partial</span> <span class="keyword">class</span> <span class="title">Dept</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Dept</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">      Emp = <span class="keyword">new</span> HashSet&lt;Emp&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> Deptno &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> Dname &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> Loc &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">virtual</span> ICollection&lt;Emp&gt; Emp &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 Oracle 資料庫中，DEPT 與 EMP 有 FOREIGN KEY Constraint 的關係，在這個類型中也可以表現出這種 Master-Detail 關係，如果無此需求，可以省略。其實我們只需要第 13、14 與 15 行三個 Deptno、Dname 與 Loc 屬性就可以。</p>
<p>這裡這個 Dept 類型除了三個基本屬性外，Emp 可以把屬於這個部門的員工放進來。</p>
<figure class="highlight csharp"><figcaption><span>Models/Emp.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">OracleEFCoreSample.Models</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">partial</span> <span class="keyword">class</span> <span class="title">Emp</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Emp</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">      InverseMgrNavigation = <span class="keyword">new</span> HashSet&lt;Emp&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> Empno &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> Ename &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> Job &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span>? Mgr &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> DateTime? Hiredate &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">double</span>? Sal &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">double</span>? Comm &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span>? Deptno &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">virtual</span> Dept DeptnoNavigation &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">virtual</span> Emp MgrNavigation &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">virtual</span> ICollection&lt;Emp&gt; InverseMgrNavigation &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>EMP 資料表有兩個 FOREIGN KEY Constraint，一個是 Deptno 參照到 DEPT 的 Deptno，另外一個是 Mgr 參照到自己的 Empno。一樣你如果不需要這些關聯，可以只要 13 ~ 20 行的 8 個屬性就可以。型別後面的 ? 號，表示這是個 Nullable value types。 </p>
<p>除了 8 個基本屬性外， DeptnoNavigation 可以把部門資料放進來，MgrNavigation 可以把主管資料放進來，而如果是主管，可以把部屬資料放入 InverseMgrNavigation。 </p>
<p>這兩個型別只是單純的 C# 類別型態定義，與 Oracle 資料庫資料表還看不出映射關係，EF Code 使用了三個概念來定義模型 : 約定、注釋和流利 API(Fluent API)。</p>
<p>按照約定，有些事情會自動發生。例如，用 Id 前綴命名 int 或 Guid 類型的屬性，會將該屬性映射到資料庫的主鍵。例如 EmpId 屬性會自動映射到資料表的主鍵 EmpId。但我們的 Oracle 資料表主鍵通常不會遵守這種規則，所以這裡要用另外一種映射到資料表的約定 : 使用上下文的屬性名 (Fluent API)。</p>
<h4 id="創建上下文-Context"><a href="#創建上下文-Context" class="headerlink" title="創建上下文 (Context)"></a>創建上下文 (Context)</h4><p>這裡要創建另一個 DemoContext 類，透過這個類實現了與 Oracle 資料庫表 DEPT 與 EMP 的關係。這個類派生自基類 DbContext。DemoContext 類定義了 DbSet<dept> 與 DbSet<emp> 的 Dept 與 Emp 屬性。</emp></dept></p>
<p>透過 DbContext 派生類的 OnModelCreating 方法使用流利 API。Entity 方法返回一個 EntityTypeBuilder，允許自定義實體，把它映射到特定的資料庫表名(Table)、定義鍵(Key)和索引(Indexes)。</p>
<p>EntityTypeBuilder 定義了一個 Property 方法來配置屬性。Property 方法返回一個 PropertyBuilder，它允許用最大長度、需要的設置和 SQL 類型配置屬性。</p>
<p>要定義一對多映射，EntityTypeBuilder 定義了映射方法。方法 HasMany 與 WithOne 結合，HasMany 需要與 WithOne 鏈接起來。</p>
<p>方法 HasOne 需要和 WithMany 或 WithOne 鏈接起來。鏈接 HasOne 與 WithMany，會定義一對多關聯；鏈接 HasOne 與 WithOne，定義一對一關係。 </p>
<figure class="highlight csharp"><figcaption><span>Models/DemoContext.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> Microsoft.EntityFrameworkCore;</span><br><span class="line"><span class="keyword">using</span> Microsoft.EntityFrameworkCore.Metadata;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Extensions.Configuration;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Extensions.Configuration.Json;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">OracleEFCoreSample.Models</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">partial</span> <span class="keyword">class</span> <span class="title">DemoContext</span> : <span class="title">DbContext</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">virtual</span> DbSet&lt;Dept&gt; Dept &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">virtual</span> DbSet&lt;Emp&gt; Emp &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnConfiguring</span>(<span class="params">DbContextOptionsBuilder optionsBuilder</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">      <span class="keyword">if</span> (!optionsBuilder.IsConfigured)</span><br><span class="line">      &#123; </span><br><span class="line">        optionsBuilder.UseOracle(GetConnectionString(), options =&gt; </span><br><span class="line">          options.UseOracleSQLCompatibility(<span class="string">"11"</span>)</span><br><span class="line">        );</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnModelCreating</span>(<span class="params">ModelBuilder modelBuilder</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">      modelBuilder.HasAnnotation(<span class="string">"ProductVersion"</span>, <span class="string">"2.2.6-servicing-10079"</span>)</span><br><span class="line">          .HasAnnotation(<span class="string">"Relational:DefaultSchema"</span>, <span class="string">"DEMO"</span>);</span><br><span class="line"></span><br><span class="line">      modelBuilder.Entity&lt;Dept&gt;(entity =&gt;</span><br><span class="line">      &#123;</span><br><span class="line">        entity.HasKey(e =&gt; e.Deptno)</span><br><span class="line">                  .HasName(<span class="string">"SYS_C0036617"</span>);</span><br><span class="line"></span><br><span class="line">        entity.ToTable(<span class="string">"DEPT"</span>);</span><br><span class="line"></span><br><span class="line">        entity.HasIndex(e =&gt; e.Deptno)</span><br><span class="line">                  .HasName(<span class="string">"SYS_C0036617"</span>)</span><br><span class="line">                  .IsUnique();</span><br><span class="line"></span><br><span class="line">        entity.Property(e =&gt; e.Deptno).HasColumnName(<span class="string">"DEPTNO"</span>);</span><br><span class="line"></span><br><span class="line">        entity.Property(e =&gt; e.Dname)</span><br><span class="line">                  .HasColumnName(<span class="string">"DNAME"</span>)</span><br><span class="line">                  .HasColumnType(<span class="string">"VARCHAR2"</span>)</span><br><span class="line">                  .HasMaxLength(<span class="number">14</span>);</span><br><span class="line"></span><br><span class="line">        entity.Property(e =&gt; e.Loc)</span><br><span class="line">                  .HasColumnName(<span class="string">"LOC"</span>)</span><br><span class="line">                  .HasColumnType(<span class="string">"VARCHAR2"</span>)</span><br><span class="line">                  .HasMaxLength(<span class="number">13</span>);</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      modelBuilder.Entity&lt;Emp&gt;(entity =&gt;</span><br><span class="line">      &#123;</span><br><span class="line">        entity.HasKey(e =&gt; e.Empno)</span><br><span class="line">                  .HasName(<span class="string">"EMP_PK"</span>);</span><br><span class="line"></span><br><span class="line">        entity.ToTable(<span class="string">"EMP"</span>);</span><br><span class="line"></span><br><span class="line">        entity.HasIndex(e =&gt; e.Empno)</span><br><span class="line">                  .HasName(<span class="string">"EMP_PK"</span>)</span><br><span class="line">                  .IsUnique();</span><br><span class="line"></span><br><span class="line">        entity.HasIndex(e =&gt; e.Ename)</span><br><span class="line">                  .HasName(<span class="string">"EMP_IDX1"</span>);</span><br><span class="line"></span><br><span class="line">        entity.Property(e =&gt; e.Empno).HasColumnName(<span class="string">"EMPNO"</span>);</span><br><span class="line"></span><br><span class="line">        entity.Property(e =&gt; e.Comm)</span><br><span class="line">                  .HasColumnName(<span class="string">"COMM"</span>)</span><br><span class="line">                  .HasColumnType(<span class="string">"FLOAT"</span>);</span><br><span class="line"></span><br><span class="line">        entity.Property(e =&gt; e.Deptno)</span><br><span class="line">                  .HasColumnName(<span class="string">"DEPTNO"</span>);</span><br><span class="line"></span><br><span class="line">        entity.Property(e =&gt; e.Ename)</span><br><span class="line">                  .HasColumnName(<span class="string">"ENAME"</span>)</span><br><span class="line">                  .HasColumnType(<span class="string">"VARCHAR2"</span>)</span><br><span class="line">                  .HasMaxLength(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">        entity.Property(e =&gt; e.Hiredate)</span><br><span class="line">                  .HasColumnName(<span class="string">"HIREDATE"</span>)</span><br><span class="line">                  .HasColumnType(<span class="string">"DATE"</span>);</span><br><span class="line"></span><br><span class="line">        entity.Property(e =&gt; e.Job)</span><br><span class="line">                  .HasColumnName(<span class="string">"JOB"</span>)</span><br><span class="line">                  .HasColumnType(<span class="string">"VARCHAR2"</span>)</span><br><span class="line">                  .HasMaxLength(<span class="number">9</span>);</span><br><span class="line"></span><br><span class="line">        entity.Property(e =&gt; e.Mgr).HasColumnName(<span class="string">"MGR"</span>);</span><br><span class="line"></span><br><span class="line">        entity.Property(e =&gt; e.Sal)</span><br><span class="line">                  .HasColumnName(<span class="string">"SAL"</span>)</span><br><span class="line">                  .HasColumnType(<span class="string">"FLOAT"</span>);</span><br><span class="line"></span><br><span class="line">        entity.HasOne(d =&gt; d.DeptnoNavigation)</span><br><span class="line">                  .WithMany(p =&gt; p.Emp)</span><br><span class="line">                  .HasForeignKey(d =&gt; d.Deptno)</span><br><span class="line">                  .HasConstraintName(<span class="string">"SYS_C0036621"</span>);</span><br><span class="line"></span><br><span class="line">        entity.HasOne(d =&gt; d.MgrNavigation)</span><br><span class="line">                  .WithMany(p =&gt; p.InverseMgrNavigation)</span><br><span class="line">                  .HasForeignKey(d =&gt; d.Mgr)</span><br><span class="line">                  .HasConstraintName(<span class="string">"SYS_C0036620"</span>);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">string</span> <span class="title">GetConnectionString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">      <span class="keyword">var</span> configurationBuilder = <span class="keyword">new</span> ConfigurationBuilder()</span><br><span class="line">        .SetBasePath(Directory.GetCurrentDirectory())</span><br><span class="line">        .AddJsonFile(<span class="string">"appsettings.json"</span>);</span><br><span class="line">      IConfiguration config = configurationBuilder.Build();</span><br><span class="line">      <span class="keyword">string</span> connectionString = config[<span class="string">"Data:DefaultConnection:ConnectionString"</span>];</span><br><span class="line">      <span class="keyword">return</span> connectionString;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>DemoContext 是資料庫映射的關鍵，聰明的你就對照著資料庫慢慢斟酌，GetConnectionString 方法則會從 appsettings.json 抓取 Oracle 資料庫的 ConnectionString。 這會用在第 19 行。</p>
<p>同時要注意第 20 行，因為我們的資料庫大部分還是 11g，所以要在 options 中加上 UseOracleSQLCompatibility(“11”)，否則會有很多地方會掛掉。 建議趕快升級到 12c(以上)。</p>
<h4 id="讀取資料庫"><a href="#讀取資料庫" class="headerlink" title="讀取資料庫"></a>讀取資料庫</h4><p>可以讀取資料庫了。</p>
<figure class="highlight csharp"><figcaption><span>Program.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> OracleEFCoreSample.Models;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">OracleEFCoreSample</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="keyword">string</span>[] args</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">      Console.WriteLine(<span class="string">"Hello Tainan! Hi 台南"</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">using</span> (<span class="keyword">var</span> db = <span class="keyword">new</span> DemoContext())</span><br><span class="line">      &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">"===== Departments =========="</span>);</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> dept <span class="keyword">in</span> db.Dept)</span><br><span class="line">        &#123;</span><br><span class="line">          Console.WriteLine(<span class="string">$"<span class="subst">&#123;dept.Deptno&#125;</span> <span class="subst">&#123;dept.Dname&#125;</span> <span class="subst">&#123;dept.Loc&#125;</span>"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Console.WriteLine(<span class="string">"===== Employees =========="</span>);</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> emp <span class="keyword">in</span> db.Emp)</span><br><span class="line">        &#123;</span><br><span class="line">          Console.WriteLine(<span class="string">$"<span class="subst">&#123;emp.Empno&#125;</span> <span class="subst">&#123;emp.Ename&#125;</span> <span class="subst">&#123;emp.Job&#125;</span> <span class="subst">&#123;emp.Mgr&#125;</span> <span class="subst">&#123;emp.Hiredate?.ToString(<span class="string">"yyyy-MM-ddTHH:mm:ss"</span>)&#125;</span> <span class="subst">&#123;emp.Sal&#125;</span> <span class="subst">&#123;emp.Comm&#125;</span> <span class="subst">&#123;emp.Deptno&#125;</span>"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ OracleEFCoreSample&gt; dotnet run</span><br><span class="line">Hello Tainan! Hi 台南</span><br><span class="line">===== Departments ==========</span><br><span class="line">10 會計部 紐約</span><br><span class="line">20 RESEARCH DALLAS</span><br><span class="line">30 SALES 永康</span><br><span class="line">40 OPERATIONS BOSTON</span><br><span class="line">70 資訊部 永康 B4</span><br><span class="line">60 開發部 台南</span><br><span class="line">===== Employees ==========</span><br><span class="line">7839 KING PRESIDENT  1981-11-17T00:00:00 5000  10</span><br><span class="line">7698 BLAKE MANAGER1 7839 1981-05-01T00:00:00 2850 101 30</span><br><span class="line">7782 楊瑞 MANAGER 7902 1981-06-09T00:00:00 2400  10</span><br><span class="line">7566 楊瑞? MANAGER 7839 1981-04-02T00:00:00 2975  20</span><br><span class="line">7788 SCOTT ANALYST 7566 1982-12-09T00:00:00 45300  20</span><br><span class="line">7902 FORD ANALYST 7566 1981-12-03T00:00:00 3000  20</span><br><span class="line">7369 SMITH CLERK 7902 1980-12-17T00:00:00 8001  20</span><br><span class="line">7499 ALLEN SALESMAN 7698 1981-02-20T00:00:00 1600 303 30</span><br><span class="line">7608 馬小九 ANALYST 7788 2010-06-28T00:00:00 1000 100 40</span><br><span class="line">7654 葉習? SALESMAN 7698 1981-09-28T00:00:00 1250 1400 30</span><br><span class="line">7844 ??? SALESMAN 7698 1981-09-08T00:00:00 1500  30</span><br><span class="line">7876 ADAMS CLERK 7788 1983-01-12T00:00:00 1100  20</span><br><span class="line">7900 JAMES CLERK 7698 1981-12-03T00:00:00 94998  30</span><br><span class="line">7934 楊? CLERK 7902 1982-01-23T00:00:00 1500  10</span><br><span class="line">9006 林羿君 ANALYST 7788 2001-05-07T00:00:00 66666  70</span><br><span class="line">7607 ??? 分析師 7788 2008-03-24T00:00:00 45000 100 70</span><br><span class="line">7609 蔡大一 分析師 7788 2010-06-28T00:00:00 60000  70</span><br><span class="line">9011 文英蔡 總鋪師 7788 2018-08-28T00:00:00 77778 180 40</span><br><span class="line">8907 牸? ANALYST 7566 1982-12-09T00:00:00 9002  10</span><br></pre></td></tr></table></figure>

<p>模型建立好，讀取資料就這麼簡單，加入 LINQ 看看。</p>
<figure class="highlight csharp"><figcaption><span>Program.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> (<span class="keyword">var</span> db = <span class="keyword">new</span> DemoContext())</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">var</span> employees = db.Emp</span><br><span class="line">    .Where(e =&gt; e.Deptno == <span class="number">10</span> || e.Deptno == <span class="number">30</span>)</span><br><span class="line">    .OrderBy(e =&gt; e.Deptno)</span><br><span class="line">    .ThenBy(e =&gt; e.Empno);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">foreach</span> (<span class="keyword">var</span> e <span class="keyword">in</span> employees)</span><br><span class="line">  &#123;</span><br><span class="line">    Console.WriteLine(<span class="string">$"<span class="subst">&#123;e.Empno&#125;</span> <span class="subst">&#123;e.Ename&#125;</span> <span class="subst">&#123;e.Job&#125;</span> <span class="subst">&#123;e.Mgr&#125;</span> <span class="subst">&#123;e.Hiredate?.ToString(<span class="string">"yyyy-MM-ddTHH:mm:ss"</span>)&#125;</span> <span class="subst">&#123;e.Sal&#125;</span> <span class="subst">&#123;e.Comm&#125;</span> <span class="subst">&#123;e.Deptno&#125;</span>"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>現在將 Master-Detail 資料關聯起來，DEPT 對 EMP 是一對多的關係。</p>
<figure class="highlight csharp"><figcaption><span>Program.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> (<span class="keyword">var</span> db = <span class="keyword">new</span> DemoContext())</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">var</span> employees = db.Emp.ToList();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">foreach</span> (<span class="keyword">var</span> dept <span class="keyword">in</span> db.Dept)</span><br><span class="line">  &#123;</span><br><span class="line">    dept.Emp = employees.Where(d =&gt; d.Deptno == dept.Deptno).ToList();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> department = db.Dept.Where(d =&gt; d.Deptno == <span class="number">20</span>).FirstOrDefault();</span><br><span class="line">  Console.WriteLine(<span class="string">$"=== <span class="subst">&#123;department.Deptno&#125;</span> <span class="subst">&#123;department.Dname&#125;</span> <span class="subst">&#123;department.Loc&#125;</span> ==="</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">foreach</span> (<span class="keyword">var</span> e <span class="keyword">in</span> department.Emp)</span><br><span class="line">  &#123;</span><br><span class="line">    Console.WriteLine(<span class="string">$"<span class="subst">&#123;e.Empno&#125;</span> <span class="subst">&#123;e.Ename&#125;</span> <span class="subst">&#123;e.Job&#125;</span> <span class="subst">&#123;e.Mgr&#125;</span> <span class="subst">&#123;e.Hiredate?.ToString(<span class="string">"yyyy-MM-ddTHH:mm:ss"</span>)&#125;</span> <span class="subst">&#123;e.Sal&#125;</span> <span class="subst">&#123;e.Comm&#125;</span> <span class="subst">&#123;e.Deptno&#125;</span>"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ OracleEFCoreSample&gt; dotnet run</span><br><span class="line">Hello Tainan! Hi 台南</span><br><span class="line">=== 20 RESEARCH DALLAS ===</span><br><span class="line">7566 楊瑞? MANAGER 7839 1981-04-02T00:00:00 2975  20</span><br><span class="line">7788 SCOTT ANALYST 7566 1982-12-09T00:00:00 45300  20</span><br><span class="line">7902 FORD ANALYST 7566 1981-12-03T00:00:00 3000  20</span><br><span class="line">7369 SMITH CLERK 7902 1980-12-17T00:00:00 8001  20</span><br><span class="line">7876 ADAMS CLERK 7788 1983-01-12T00:00:00 1100  20</span><br></pre></td></tr></table></figure>

<p>主管與部屬關係。</p>
<figure class="highlight csharp"><figcaption><span>Program.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> (<span class="keyword">var</span> db = <span class="keyword">new</span> DemoContext())</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">var</span> employees = db.Emp.ToList();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> managers = employees.GroupBy(e =&gt; e.Mgr)</span><br><span class="line">    .Select(grp =&gt; grp.FirstOrDefault())</span><br><span class="line">    .Select(e =&gt; <span class="keyword">new</span> &#123; Manager = e.Mgr ?? e.Empno &#125;);</span><br><span class="line"></span><br><span class="line">  Emp manager = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">foreach</span> (<span class="keyword">var</span> m <span class="keyword">in</span> managers)</span><br><span class="line">  &#123;</span><br><span class="line">    manager = employees.Where(e =&gt; e.Empno == m.Manager).FirstOrDefault();</span><br><span class="line">    manager.InverseMgrNavigation = employees.Where(e =&gt; e.Mgr == manager.Empno).ToList();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  manager = employees.Where(e =&gt; e.Empno == <span class="number">7788</span>).FirstOrDefault();</span><br><span class="line">  Console.WriteLine(<span class="string">$"=== <span class="subst">&#123;manager.Empno&#125;</span> <span class="subst">&#123;manager.Ename&#125;</span> ==="</span>);</span><br><span class="line">  <span class="keyword">foreach</span> (<span class="keyword">var</span> e <span class="keyword">in</span> manager.InverseMgrNavigation)</span><br><span class="line">  &#123;</span><br><span class="line">    Console.WriteLine(<span class="string">$"<span class="subst">&#123;e.Empno&#125;</span> <span class="subst">&#123;e.Ename&#125;</span> <span class="subst">&#123;e.Job&#125;</span> <span class="subst">&#123;e.Mgr&#125;</span> <span class="subst">&#123;e.Hiredate?.ToString(<span class="string">"yyyy-MM-ddTHH:mm:ss"</span>)&#125;</span> <span class="subst">&#123;e.Sal&#125;</span> <span class="subst">&#123;e.Comm&#125;</span> <span class="subst">&#123;e.Deptno&#125;</span>"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ OracleEFCoreSample&gt; dotnet run</span><br><span class="line">Hello Tainan! Hi 台南</span><br><span class="line">=== 7788 SCOTT ===</span><br><span class="line">7608 馬小九 ANALYST 7788 2010-06-28T00:00:00 1000 100 40</span><br><span class="line">7876 ADAMS CLERK 7788 1983-01-12T00:00:00 1100  20</span><br><span class="line">9006 林羿君 ANALYST 7788 2001-05-07T00:00:00 66666  70</span><br><span class="line">7607 ??? 分析師 7788 2008-03-24T00:00:00 45000 100 70</span><br><span class="line">7609 蔡大一 分析師 7788 2010-06-28T00:00:00 60000  70</span><br><span class="line">9011 文英蔡 總鋪師 7788 2018-08-28T00:00:00 77778 180 40</span><br></pre></td></tr></table></figure>

<h4 id="新增紀錄"><a href="#新增紀錄" class="headerlink" title="新增紀錄"></a>新增紀錄</h4><p>Add 方法把 Emp 物件添加到 DemoContext 上下文中，還沒有寫入資料庫中，SaveChanges 方法把 Emp 物件寫入資料庫。</p>
<figure class="highlight csharp"><figcaption><span>Program.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> (<span class="keyword">var</span> db = <span class="keyword">new</span> DemoContext())</span><br><span class="line">&#123;</span><br><span class="line">   db.Emp.Add(<span class="keyword">new</span> Emp </span><br><span class="line">   &#123;</span><br><span class="line">     Empno = <span class="number">9588</span>,</span><br><span class="line">     Ename = <span class="string">"C#範例"</span>,</span><br><span class="line">     Job = <span class="string">"ANALYST"</span>,</span><br><span class="line">     Mgr = <span class="number">7566</span>,</span><br><span class="line">     Hiredate = DateTime.Now,</span><br><span class="line">     Sal = <span class="number">23000</span>,</span><br><span class="line">     Comm = <span class="number">100</span>,</span><br><span class="line">     Deptno = <span class="number">40</span></span><br><span class="line">   &#125;</span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">int</span> records = db.SaveChanges();</span><br><span class="line">  Console.WriteLine(<span class="string">$"<span class="subst">&#123;records&#125;</span> records saved to database."</span>); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>還可以用 AddRange 一次寫入多個物件。</p>
<figure class="highlight csharp"><figcaption><span>Program.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> (<span class="keyword">var</span> db = <span class="keyword">new</span> DemoContext())</span><br><span class="line">&#123;</span><br><span class="line">   db.Emp.AddRange(</span><br><span class="line">     <span class="keyword">new</span> Emp </span><br><span class="line">     &#123;</span><br><span class="line">       Empno = <span class="number">9681</span>,</span><br><span class="line">       Ename = <span class="string">"C#範例2"</span>,</span><br><span class="line">       Job = <span class="string">"ANALYST"</span>,</span><br><span class="line">       Mgr = <span class="number">7566</span>,</span><br><span class="line">       Hiredate = DateTime.Now,</span><br><span class="line">       Sal = <span class="number">13000</span>,</span><br><span class="line">       Comm = <span class="number">130</span>,</span><br><span class="line">       Deptno = <span class="number">10</span></span><br><span class="line">     &#125;,</span><br><span class="line">     <span class="keyword">new</span> Emp</span><br><span class="line">     &#123;</span><br><span class="line">       Empno = <span class="number">9682</span>,</span><br><span class="line">       Ename = <span class="string">"C#範例3"</span>,</span><br><span class="line">       Job = <span class="string">"ANALYST"</span>,</span><br><span class="line">       Mgr = <span class="number">7566</span>,</span><br><span class="line">       Hiredate = DateTime.Now,</span><br><span class="line">       Sal = <span class="number">33000</span>,</span><br><span class="line">       Comm = <span class="number">330</span>,</span><br><span class="line">       Deptno = <span class="number">20</span></span><br><span class="line">     &#125;</span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">int</span> records = db.SaveChanges();</span><br><span class="line">  Console.WriteLine(<span class="string">$"<span class="subst">&#123;records&#125;</span> records saved to database."</span>); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="更新紀錄"><a href="#更新紀錄" class="headerlink" title="更新紀錄"></a>更新紀錄</h4><figure class="highlight csharp"><figcaption><span>Program.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> (<span class="keyword">var</span> db = <span class="keyword">new</span> DemoContext())</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">int</span> records = <span class="number">0</span>;  </span><br><span class="line">  <span class="keyword">var</span> employee = db.Emp.Where(e =&gt; e.Empno == <span class="number">9588</span>).FirstOrDefault();</span><br><span class="line">  <span class="keyword">if</span> (employee != <span class="literal">null</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    employee.Comm = <span class="number">500</span>;  </span><br><span class="line">    records = db.SaveChanges();</span><br><span class="line">  &#125; </span><br><span class="line">  Console.WriteLine(<span class="string">$"<span class="subst">&#123;records&#125;</span> records updated."</span>); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="刪除紀錄"><a href="#刪除紀錄" class="headerlink" title="刪除紀錄"></a>刪除紀錄</h4><figure class="highlight csharp"><figcaption><span>Program.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> (<span class="keyword">var</span> db = <span class="keyword">new</span> DemoContext())</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">int</span> records = <span class="number">0</span>;  </span><br><span class="line">  <span class="keyword">var</span> employee = db.Emp.Where(e =&gt; e.Empno == <span class="number">9588</span>).FirstOrDefault();</span><br><span class="line">  <span class="keyword">if</span> (employee != <span class="literal">null</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    db.Emp.Remove(employee);</span><br><span class="line">    records = db.SaveChanges();</span><br><span class="line">  &#125; </span><br><span class="line">  Console.WriteLine(<span class="string">$"<span class="subst">&#123;records&#125;</span> records deleted from database."</span>); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以用 RemoveRange 刪除多筆資料。</p>
<figure class="highlight csharp"><figcaption><span>Program.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> (<span class="keyword">var</span> db = <span class="keyword">new</span> DemoContext())</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">var</span> employees = db.Emp.Where(e =&gt; e.Empno == <span class="number">9681</span> || e.Empno == <span class="number">9682</span>);</span><br><span class="line">  db.Emp.RemoveRange(employees);</span><br><span class="line">  <span class="keyword">int</span> records = db.SaveChanges();       </span><br><span class="line">  Console.WriteLine(<span class="string">$"<span class="subst">&#123;records&#125;</span> records deleted from database."</span>); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>物件關係映射工具，如 EF Core，並不適用於所有場景。例如一次刪除很多資料或所有的資料就沒有那麼高效能，使用單個 SQL 語句可以刪除所有資料，會比每一個紀錄使用一個 DELETE 語句效能高得多。 </p>
<h4 id="反向工程-Reverse-Engineering"><a href="#反向工程-Reverse-Engineering" class="headerlink" title="反向工程 (Reverse Engineering)"></a>反向工程 (Reverse Engineering)</h4><p>在反向工程之前，您必須安裝 <a href="https://docs.microsoft.com/zh-tw/ef/core/miscellaneous/cli/dotnet" target="_blank" rel="noopener">CLI</a> 工具。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ &gt; dotnet tool install --global dotnet-ef</span><br></pre></td></tr></table></figure>

<p>然後在你的專案目錄下執行反向工程，下面會產生 DEPT 與 EMP 的反向工程。 它會在專案目錄下產生子目錄 Models 與 Dept.cs、Emp.cs 與 ModelContext.cs。 先前例子的 Dept.cs、Emp.cs 與 DemoContext.cs 有經過修正，可以對照看看，尤其是 Emp.Sal 屬性的型別。 </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ OracleEFCoreSample&gt; dotnet ef dbcontext scaffold <span class="string">"User Id=xxxx;Password=xxxxxxxx;Data Source=10.11.xx.xxx:1522/xxxx.xxx.com.tw;Connection Timeout=600;min pool size=0;connection lifetime=18000;PERSIST SECURITY INFO=True;"</span> Oracle.EntityFrameworkCore --table EMP --table DEPT -o Models -f</span><br></pre></td></tr></table></figure>

<p>下面則是 Schema 的所有資料表。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ OracleEFCoreSample&gt; dotnet ef dbcontext scaffold <span class="string">"User Id=xxxx;Password=xxxxxxxx;Data Source=10.11.xx.xxx:1522/xxxx.xxx.com.tw;Connection Timeout=600;min pool size=0;connection lifetime=18000;PERSIST SECURITY INFO=True;"</span> Oracle.EntityFrameworkCore -o Models -f</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://1184yang.github.io/2020/06/04/C-Entity-Framework-Core-2-0-and-Oracle-Provider/" data-id="ckcpzj954000080vzls3vx1zl" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Kafka-RabbitMQ-Electron" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/06/02/Kafka-RabbitMQ-Electron/" class="article-date">
  <time datetime="2020-06-01T23:42:41.000Z" itemprop="datePublished">2020-06-02</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Apache-Kafka/">Apache Kafka</a>►<a class="article-category-link" href="/categories/JavaScript/">JavaScript</a>►<a class="article-category-link" href="/categories/RabbitMQ/">RabbitMQ</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/06/02/Kafka-RabbitMQ-Electron/">Apache Kafka 與 Electron-RabbitMQ Notification</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>上回用 Electron 與 RabbitMQ 寫了可以釘選在 Windonws Desktop 托盤上的應用程式 <a href="/2020/05/21/Electron-Notification-Buzzer/">桌面應用程式 Electron-RabbitMQ Notification</a>。</p>
<img src="/2020/06/02/Kafka-RabbitMQ-Electron/electron-052111.png" title="Application Architecture">

<p>有各種管道可以發送訊息，現在就來看看如何在 Apache Kafka 消費成功或失敗時發送即時訊息到這個 Notification 應用程式。</p>
<p>這是一個 Apache Kafka 消費者，這裡用 Node.js，所以可以用 Node.js 的 RabbitMQ 的程式庫 amqplib，但只要發送訊息到 RabbitMQ，可以直接使用 GraphQL API 會比較單純。</p>
<p>這裡會送到 RabbitMQ 的 Exchange <strong>electron.notification.admin</strong>，Routing Key 則是 <strong>dba</strong>。你可想成，這裡要將訊息發送給 <strong>admin</strong> 群組下的子群組 <strong>dba</strong>。 下面的 Queue 則綁定了這個 Exchange 與 Routing Key。</p>
<img src="/2020/06/02/Kafka-RabbitMQ-Electron/electron-060201.png" title="RabbitMQ Queue">

<figure class="highlight javascript"><figcaption><span>kafka2rabbit-api-notification.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> kafka = <span class="built_in">require</span>(<span class="string">'kafka-node'</span>);</span><br><span class="line"><span class="keyword">const</span> fetch = <span class="built_in">require</span>(<span class="string">'node-fetch'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Consumer = kafka.Consumer;</span><br><span class="line"><span class="keyword">const</span> client = <span class="keyword">new</span> kafka.KafkaClient(&#123;<span class="attr">kafkaHost</span>: <span class="string">'10.11.xx.xxx:9093'</span>&#125;);</span><br><span class="line"><span class="keyword">const</span> offset = <span class="keyword">new</span> kafka.Offset(client);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> topic = <span class="string">'testing'</span>;</span><br><span class="line"><span class="keyword">const</span> partition = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">offset.fetchLatestOffsets([topic], <span class="function"><span class="keyword">function</span> (<span class="params">err, offsets</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (err) <span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> lastestOffset = offsets[topic][partition];</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`lastest Offset: <span class="subst">$&#123;lastestOffset&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line">  consumer = <span class="keyword">new</span> Consumer(</span><br><span class="line">    client,</span><br><span class="line">    [</span><br><span class="line">      &#123;</span><br><span class="line">        topic: topic,</span><br><span class="line">        partition: partition,</span><br><span class="line">        offset: lastestOffset - <span class="number">1</span></span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">//groupId: "demo-employees-group-1",</span></span><br><span class="line">      fromOffset: <span class="literal">true</span>,</span><br><span class="line">      autoCommit: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  consumer.on(<span class="string">'message'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">message</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(message);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> data = &#123;</span><br><span class="line">      title: <span class="string">'Kafka Consumer'</span>,</span><br><span class="line">      content: <span class="string">`Kafka Topic: <span class="subst">$&#123;message.topic&#125;</span>`</span>,</span><br><span class="line">      description: [</span><br><span class="line">        <span class="string">`Offset: <span class="subst">$&#123;message.offset&#125;</span>`</span>,</span><br><span class="line">        <span class="string">`highWaterOffset: <span class="subst">$&#123;message.highWaterOffset&#125;</span>`</span>,</span><br><span class="line">        <span class="string">`timestamp: <span class="subst">$&#123;message.timestamp&#125;</span>`</span></span><br><span class="line">      ],</span><br><span class="line">      created: (<span class="keyword">new</span> <span class="built_in">Date</span>()).toString(),</span><br><span class="line">      <span class="keyword">from</span>: <span class="string">'Apache Consumer'</span>,</span><br><span class="line">      link: &#123;</span><br><span class="line">        text: <span class="string">'Go Kafka'</span>,</span><br><span class="line">        url: <span class="string">'http://10.11.xx.xxx:3030'</span></span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    sendToExchange(data);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  consumer.on(<span class="string">'error'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(err);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> data = &#123;</span><br><span class="line">      title: <span class="string">'Kafka Consumer Error'</span>,</span><br><span class="line">      content: <span class="string">`Kafka Topic: <span class="subst">$&#123;err.message&#125;</span>`</span>,</span><br><span class="line">      created: (<span class="keyword">new</span> <span class="built_in">Date</span>()).toString(),</span><br><span class="line">      <span class="keyword">from</span>: <span class="string">'Apache Consumer'</span>,</span><br><span class="line">      type: <span class="string">'urgent'</span>,</span><br><span class="line">      link: &#123;</span><br><span class="line">        text: <span class="string">'Go Kafka'</span>,</span><br><span class="line">        url: <span class="string">'http://10.11.xx.xxx:3030'</span></span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    sendToExchange(data);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  consumer.on(<span class="string">'offsetOutOfRange'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(err);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sendToExchange</span>(<span class="params">value</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> url = <span class="string">"http://10.11.xx.xxx:x000/v1/graphql"</span>;</span><br><span class="line">  <span class="keyword">const</span> exchange = <span class="string">"electron.notification.admin"</span>;</span><br><span class="line">  <span class="keyword">const</span> routingKey = <span class="string">"dba"</span>;</span><br><span class="line">  <span class="keyword">const</span> query = <span class="string">`mutation sendToExchange(</span></span><br><span class="line"><span class="string">    $exchange: String!,</span></span><br><span class="line"><span class="string">    $routingKey: String,</span></span><br><span class="line"><span class="string">    $message: String!) &#123;</span></span><br><span class="line"><span class="string">      sendToExchange(exchange: $exchange, routingKey: $routingKey,  message: $message)</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  `</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> message = <span class="built_in">JSON</span>.stringify(&#123; ...value, <span class="attr">created</span>: (<span class="keyword">new</span> <span class="built_in">Date</span>()).toString() &#125;);</span><br><span class="line"></span><br><span class="line">  fetch(url, &#123;</span><br><span class="line">    method: <span class="string">"POST"</span>,</span><br><span class="line">    headers: &#123;</span><br><span class="line">      <span class="string">"Content-Type"</span>: <span class="string">"application/json"</span>,</span><br><span class="line">      <span class="string">"Accept"</span>: <span class="string">"application/json"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    body: <span class="built_in">JSON</span>.stringify(&#123;</span><br><span class="line">      query: query,</span><br><span class="line">      variables: &#123; exchange, routingKey, message &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">    .then(<span class="function"><span class="params">r</span> =&gt;</span> r.json())</span><br><span class="line">    .then(<span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`data returned: <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(data)&#125;</span>`</span>);</span><br><span class="line">    &#125;)</span><br><span class="line">    .catch(<span class="function"><span class="params">err</span> =&gt;</span> <span class="built_in">console</span>.log(err.message));</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li><p>第 11 行 fetchLatestOffsets 方法可以抓取到這個 Topic 的最後 Offset，我們可以從這個 Offset 開始消費，這會跟第 28 行的 fromOffset 設定為 false 是一樣的，會從新進來的消息開始消費。</p>
</li>
<li><p>第 23 行的 offset 現在設為 lastestOffset - 1，所以會從上次已消費的最後一筆開始，可視你的需求調整。</p>
</li>
<li><p>第 28 行 fromOffset 因為我們有提供 offset，所以這裡要設為 true。</p>
</li>
<li><p>第 52、70 行當 Apache Kafka 消費成功或失敗時發送訊息。</p>
</li>
<li><p>第 78 行是發送訊息到 RabbitMQ API 的函式 sendToExchange。</p>
</li>
<li><p>第 80 行發送的 RabbitMQ Exchange <strong>electron.notification.admin</strong>。</p>
</li>
<li><p>第 81 行定義 Routing Key <strong>dba</strong>。</p>
</li>
</ul>
<p>這裡的 Apache Kafka Topic <strong>testing</strong> 每小時會從 Oracle 資料庫發送訊息到這個 Apache Kafka Topic，消費完成後再轉發通知到 RabbitMQ 的 Exchange <strong>electron.notification.admin</strong>。</p>
<img src="/2020/06/02/Kafka-RabbitMQ-Electron/electron-060202.png" title="Electron Notification">

<p>看起來我們好像繞了一圈，你如要用微服務架構 (Microservices)，這就是不可少的架構與技術。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://1184yang.github.io/2020/06/02/Kafka-RabbitMQ-Electron/" data-id="ckcpzj96d001g80vz6mi6q50v" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Electron-Notification-Buzzer" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/05/21/Electron-Notification-Buzzer/" class="article-date">
  <time datetime="2020-05-20T23:57:51.000Z" itemprop="datePublished">2020-05-21</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/JavaScript/">JavaScript</a>►<a class="article-category-link" href="/categories/RabbitMQ/">RabbitMQ</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/05/21/Electron-Notification-Buzzer/">Desktop 桌面應用程式 Electron-RabbitMQ Notification</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>這是一個 Windows 作業系統下的 Desktop 應用程式，可以實際上線應用的即時訊息通知應用。這是在 Windows 10 下開發的，用到的軟體版本比較新，Windows 10 以下沒有測試過，也沒有壓力測試。這是 Windows 作業系統的 Desktop 應用程式，無法用在行動裝置下運作。</p>
<p>應用程式啟動後，會釘選在 Windows 右下角的托盤(Tray)上。</p>
<img src="/2020/05/21/Electron-Notification-Buzzer/electron-052102.png" title="Windows Tray">

<p>我的 Windows 還沒有合法版權，有個浮水印，有點模糊。當有通知 (Notification) 時，Windows 的右下角會馬上顯示通知。</p>
<img src="/2020/05/21/Electron-Notification-Buzzer/electron-052101.png" title="Windows Notification">

<p>如果還沒打開應用程式的顯示畫面，可以按托盤上的圖示 <img src="/2020/05/21/Electron-Notification-Buzzer/coffee-6.ico" title="Icon"> 通知訊息會儲存在客戶端的 IndexDB 資料庫，你可以查看，也可以清除不再需要的訊息。操作很簡單，不須多做描述。</p>
<img src="/2020/05/21/Electron-Notification-Buzzer/electron-052103.png" title="Buzzer Application">

<h3 id="安裝"><a href="#安裝" class="headerlink" title="安裝"></a>安裝</h3><p>應用程式放在 XXX000(\XXXXXFS01)Y:\INSTALL\Electron\Buzzer-win32-x64-v101.zip，複製到你的硬碟，然後解壓縮。</p>
<img src="/2020/05/21/Electron-Notification-Buzzer/electron-052104.png" title="Buzzer Application">

<p>可以直接執行 Buzzer.exe。 這裡將建立一個桌面捷徑，可以從桌面啟動。</p>
<p>通常托盤上的應用程式都會在使用者登入時自動執行。 按 Windows 標誌鍵 + R 開啟執行視窗，輸入 shell:startup，然後選取 [確定]。</p>
<img src="/2020/05/21/Electron-Notification-Buzzer/electron-052105.png" title="run startup">

<p>這會開啟 [啟動] 資料夾。</p>
<img src="/2020/05/21/Electron-Notification-Buzzer/electron-052106.png" title="startup directory">

<p>將剛剛產生的桌面捷徑拖拉到這個目錄中，下次你重新登入後，這個應用程式就會自動啟動。加入啟動目錄後，你可以從工作管理員中確認。</p>
<img src="/2020/05/21/Electron-Notification-Buzzer/electron-052107.png" title="startup directory">

<h3 id="發送訊息"><a href="#發送訊息" class="headerlink" title="發送訊息"></a>發送訊息</h3><p>首先發送一個最簡單的訊息，先從瀏覽器開始。將下列程式碼複製到瀏覽器執行。</p>
<p>將第 9 行的 queue 改為<strong>你的登入帳號</strong>，不要通通送到我這裡，並確認你的 Buzzer 應用程式已啟動。</p>
<figure class="highlight javascript"><figcaption><span>sendSimple.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> data =</span><br><span class="line">&#123;</span><br><span class="line">  title: <span class="string">'簡單的通知標頭'</span>,</span><br><span class="line">  content: <span class="string">'這是從瀏覽器發出的簡單訊息 ༼ つ ◕_◕ ༽つ。'</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">producer</span>(<span class="params">value</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> url = <span class="string">"http://10.11.xx.xxx:x000/v1/graphql"</span>;</span><br><span class="line">  <span class="keyword">const</span> queue = <span class="string">"electron.notification.7x0x0x4x"</span>;</span><br><span class="line">  <span class="keyword">const</span> query = <span class="string">`mutation sendToQueue(</span></span><br><span class="line"><span class="string">    $queue: String!, </span></span><br><span class="line"><span class="string">    $message: String!) &#123;</span></span><br><span class="line"><span class="string">      sendToQueue(queue: $queue, message: $message)</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  `</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> message = <span class="built_in">JSON</span>.stringify(&#123; ...value, <span class="attr">created</span>: (<span class="keyword">new</span> <span class="built_in">Date</span>()).toString() &#125;);</span><br><span class="line"></span><br><span class="line">  fetch(url, &#123;</span><br><span class="line">    method: <span class="string">"POST"</span>,</span><br><span class="line">    headers: &#123;</span><br><span class="line">      <span class="string">"Content-Type"</span>: <span class="string">"application/json"</span>,</span><br><span class="line">      <span class="string">"Accept"</span>: <span class="string">"application/json"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    body: <span class="built_in">JSON</span>.stringify(&#123;</span><br><span class="line">      query: query,</span><br><span class="line">      variables: &#123; queue, message &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">    .then(<span class="function"><span class="params">r</span> =&gt;</span> r.json())</span><br><span class="line">    .then(<span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`data returned: <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(data)&#125;</span>`</span>);</span><br><span class="line">    &#125;)</span><br><span class="line">    .catch(<span class="function"><span class="params">err</span> =&gt;</span> <span class="built_in">console</span>.log(err.message));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">producer(data);</span><br></pre></td></tr></table></figure>

<p>Windows 視窗右下角應該馬上會出現通知訊息。</p>
<img src="/2020/05/21/Electron-Notification-Buzzer/electron-052108.png" title="send simple data">

<p>打開應用程式視窗，訊息也會同時儲存在客戶端。這裡客戶端使用的是 IndexDB。</p>
<img src="/2020/05/21/Electron-Notification-Buzzer/electron-052110.png" title="send simple data">

<h3 id="應用程式架構"><a href="#應用程式架構" class="headerlink" title="應用程式架構"></a>應用程式架構</h3><p>送出簡單的訊息，再看更多的範例之前，先來看看應用程式的架構。</p>
<img src="/2020/05/21/Electron-Notification-Buzzer/electron-052111.png" title="Application Architecture">

<p>除了 Web App 可從瀏覽器透過 GraphQL API 發送訊息到 RabbitMQ，也可從 Oracle PL/SQL、任何有安裝 Curl 程式的裝置與任何的軟體語言，透過 GraphQL API 發送訊息到 RabbitMQ。也可以直接透過任何語言的 AMQP 程式庫連結 RabbitMQ 發送訊息。客戶端的 Electron 則直接透過 Node.js 的 amqplib 程式庫直接連結 RabbitMQ 消費訊息(Consume)。Electron 應用程式一啟動就回連結 RabbitMQ。架構不是很複雜，但可以創造無限的應用空間。  </p>
<p>之前的文章 <a href="/2019/07/09/RabbitMQ-with-C/">RabbitMQ with C#</a> 有介紹過 RabbitMQ，可以參考一下它的基本的運作方式。</p>
<h3 id="發送訊息範例"><a href="#發送訊息範例" class="headerlink" title="發送訊息範例"></a>發送訊息範例</h3><p>除了先前簡單的發送通知，以下則提供不同的發送範例。發出通知的基本訊息資料結構可以如下。</p>
<figure class="highlight javascript"><figcaption><span>data.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  title: <span class="string">'歡迎使用即時訊息通知'</span>,</span><br><span class="line">  content: <span class="string">'這是使用 Node.js Electron 開發的應用程序，是一個 Desktop 桌面應用程序。'</span>,</span><br><span class="line">  link: &#123;</span><br><span class="line">    text: <span class="string">'瞭解更多 Electron ...'</span>,</span><br><span class="line">    url: <span class="string">'https://www.electronjs.org/'</span></span><br><span class="line">  &#125;,</span><br><span class="line">  description: [</span><br><span class="line">    <span class="string">'使用 Node.js、Electron 與 React 開發。'</span>,</span><br><span class="line">    <span class="string">'使用 RabbitMQ 即時訊息代理。'</span>,</span><br><span class="line">    <span class="string">'可以從瀏覽器透過 GraphQL API 發送訊息。'</span>,</span><br><span class="line">    <span class="string">'可以使用 Oracle PL/SQL 發送訊息。'</span>,</span><br><span class="line">    <span class="string">'可以從作業系統使用 Node.js 或 Curl 發送訊息。'</span>,</span><br><span class="line">    <span class="string">'訊息使用 IndexDB 儲存在使用者端。'</span></span><br><span class="line">  ],</span><br><span class="line">  created: (<span class="keyword">new</span> <span class="built_in">Date</span>()).toString(),</span><br><span class="line">  <span class="keyword">from</span>: <span class="string">'Hello Tainan'</span>,</span><br><span class="line">  type: <span class="string">'info'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>除了 title 與 content 是必須的，其他都是可選的。</p>
<ul>
<li>link 可以設定對外的連結，將會開啟預設的瀏覽器。</li>
<li>description 是陣列，可以是一些條列式的訊息。</li>
<li>type 則只有 ‘urgent’ 會有不同的標頭圖示。</li>
</ul>
<h3 id="透過-GraphQL-API"><a href="#透過-GraphQL-API" class="headerlink" title="透過 GraphQL API"></a>透過 GraphQL API</h3><p>這是專門為 RabbitMQ 發送訊息的 GraphQL API，所有管道都可以透過此 API 發送訊息，首先是 Web App 從瀏覽器發送範例，APEX 就是此類型。</p>
<ul>
<li><strong>從 Web App 發送給特定的消費者</strong></li>
</ul>
<p>記得修改第 24 行的 queue 改為接收者的 AD 登入帳號。第 28 行直接發送到 RabbitMQ 的 Queue，也就是特定的消費者。</p>
<figure class="highlight javascript"><figcaption><span>sendToQueueApi.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fetch = (<span class="keyword">typeof</span> <span class="built_in">window</span> === <span class="string">'undefined'</span>) ? <span class="built_in">require</span>(<span class="string">'node-fetch'</span>) : <span class="built_in">window</span>.fetch;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> data =</span><br><span class="line">&#123;</span><br><span class="line">  title: <span class="string">'React 函式庫 宣告式'</span>,</span><br><span class="line">  content: <span class="string">'React 讓實作互動式的使用者界面變得一點也不痛苦。你只要在你的應用程式中為每個情境設計一個簡單的 view，React 就會在資料變更時有效率的自動更新並 render 有異動的元件。'</span>,</span><br><span class="line">  link: &#123;</span><br><span class="line">    text: <span class="string">'讀取更多 React 函式庫細節'</span>,</span><br><span class="line">    url: <span class="string">'https://zh-hant.reactjs.org/'</span></span><br><span class="line">  &#125;,</span><br><span class="line">  description: [</span><br><span class="line">    <span class="string">'宣告式的 view 讓你更容易預測你的程式的行為，同時也較為容易除錯。'</span>,</span><br><span class="line">    <span class="string">'首先實作一個擁有 state 的獨立 component，然後組合他們建立複雜的使用者介面。'</span>,</span><br><span class="line">    <span class="string">'這是透過 GraphQL API 傳送的'</span></span><br><span class="line">  ],</span><br><span class="line">  created: (<span class="keyword">new</span> <span class="built_in">Date</span>()).toString(),</span><br><span class="line">  <span class="keyword">from</span>: <span class="string">'GraphQL API'</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">producer(data);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">producer</span>(<span class="params">value</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> url = <span class="string">"http://10.11.xx.xxx:x000/v1/graphql"</span>;</span><br><span class="line">  <span class="keyword">const</span> queue = <span class="string">"electron.notification.7x0x0x4x"</span>;</span><br><span class="line">  <span class="keyword">const</span> query = <span class="string">`mutation sendToQueue(</span></span><br><span class="line"><span class="string">    $queue: String!, </span></span><br><span class="line"><span class="string">    $message: String!) &#123;</span></span><br><span class="line"><span class="string">      sendToQueue(queue: $queue, message: $message)</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  `</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> message = <span class="built_in">JSON</span>.stringify(&#123; ...value, <span class="attr">created</span>: (<span class="keyword">new</span> <span class="built_in">Date</span>()).toString() &#125;);</span><br><span class="line"></span><br><span class="line">  fetch(url, &#123;</span><br><span class="line">    method: <span class="string">"POST"</span>,</span><br><span class="line">    headers: &#123;</span><br><span class="line">      <span class="string">"Content-Type"</span>: <span class="string">"application/json"</span>,</span><br><span class="line">      <span class="string">"Accept"</span>: <span class="string">"application/json"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    body: <span class="built_in">JSON</span>.stringify(&#123;</span><br><span class="line">      query: query,</span><br><span class="line">      variables: &#123; queue, message &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">    .then(<span class="function"><span class="params">r</span> =&gt;</span> r.json())</span><br><span class="line">    .then(<span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`data returned: <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(data)&#125;</span>`</span>);</span><br><span class="line">    &#125;)</span><br><span class="line">    .catch(<span class="function"><span class="params">err</span> =&gt;</span> <span class="built_in">console</span>.log(err.message));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>從 Web App 發送給所有的消費者</strong></li>
</ul>
<p>第 26 行直接發送到 RabbitMQ 的 Exchange <em>electron.notification</em>， 則可以發送給所有的綁定這個 Exchange 的 Queue。預設上，這個 Electron 應用程式的所有 Queue 都會綁定到這個 Exchange <em>electron.notification</em>。</p>
<figure class="highlight javascript"><figcaption><span>sendToExchangeApi.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fetch = (<span class="keyword">typeof</span> <span class="built_in">window</span> === <span class="string">'undefined'</span>) ? <span class="built_in">require</span>(<span class="string">'node-fetch'</span>) : <span class="built_in">window</span>.fetch;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> data =</span><br><span class="line">&#123;</span><br><span class="line">  title: <span class="string">'React 函式庫 宣告式'</span>,</span><br><span class="line">  content: <span class="string">'React 讓實作互動式的使用者界面變得一點也不痛苦。你只要在你的應用程式中為每個情境設計一個簡單的 view，React 就會在資料變更時有效率的自動更新並 render 有異動的元件。'</span>,</span><br><span class="line">  link: &#123;</span><br><span class="line">    text: <span class="string">'讀取更多 React 函式庫細節'</span>,</span><br><span class="line">    url: <span class="string">'https://zh-hant.reactjs.org/'</span></span><br><span class="line">  &#125;,</span><br><span class="line">  description: [</span><br><span class="line">    <span class="string">'宣告式的 view 讓你更容易預測你的程式的行為，同時也較為容易除錯。'</span>,</span><br><span class="line">    <span class="string">'首先實作一個擁有 state 的獨立 component，然後組合他們建立複雜的使用者介面。'</span>,</span><br><span class="line">    <span class="string">'這是透過 GraphQL API 傳送的'</span></span><br><span class="line">  ],</span><br><span class="line">  created: (<span class="keyword">new</span> <span class="built_in">Date</span>()).toString(),</span><br><span class="line">  <span class="keyword">from</span>: <span class="string">'GraphQL API'</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">producer(data);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">producer</span>(<span class="params">value</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> url = <span class="string">"http://10.11.xx.xxx:x000/v1/graphql"</span>;</span><br><span class="line">  <span class="keyword">const</span> exchange = <span class="string">"electron.notification"</span>;</span><br><span class="line">  <span class="keyword">const</span> routingKey = <span class="string">""</span>;</span><br><span class="line">  <span class="keyword">const</span> query = <span class="string">`mutation sendToExchange(</span></span><br><span class="line"><span class="string">    $exchange: String!, </span></span><br><span class="line"><span class="string">    $routingKey: String,  </span></span><br><span class="line"><span class="string">    $message: String!) &#123;</span></span><br><span class="line"><span class="string">      sendToExchange(exchange: $exchange, routingKey: $routingKey,  message: $message)</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  `</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> message = <span class="built_in">JSON</span>.stringify(&#123; ...value, <span class="attr">created</span>: (<span class="keyword">new</span> <span class="built_in">Date</span>()).toString() &#125;);</span><br><span class="line"></span><br><span class="line">  fetch(url, &#123;</span><br><span class="line">    method: <span class="string">"POST"</span>,</span><br><span class="line">    headers: &#123;</span><br><span class="line">      <span class="string">"Content-Type"</span>: <span class="string">"application/json"</span>,</span><br><span class="line">      <span class="string">"Accept"</span>: <span class="string">"application/json"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    body: <span class="built_in">JSON</span>.stringify(&#123;</span><br><span class="line">      query: query,</span><br><span class="line">      variables: &#123; exchange, routingKey, message &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">    .then(<span class="function"><span class="params">r</span> =&gt;</span> r.json())</span><br><span class="line">    .then(<span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`data returned: <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(data)&#125;</span>`</span>);</span><br><span class="line">    &#125;)</span><br><span class="line">    .catch(<span class="function"><span class="params">err</span> =&gt;</span> <span class="built_in">console</span>.log(err.message));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<ul>
<li><strong>從 Node.js 發送</strong></li>
</ul>
<p>以上兩個範例也可以從 Node.js 發送。首先安裝 npm node-fetch 程式庫，程式碼則不需更改。程式碼的第一行會自動判斷不同的環境使用不同的 fetch 程式庫。JavaScript 與 Node.js 可共用程式碼。</p>
<figure class="highlight javascript"><figcaption><span>sendToQueueApi.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fetch = (<span class="keyword">typeof</span> <span class="built_in">window</span> === <span class="string">'undefined'</span>) ? <span class="built_in">require</span>(<span class="string">'node-fetch'</span>) : <span class="built_in">window</span>.fetch;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><figcaption><span>sendToQueueApi.js</span></figcaption><table><tr><td class="code"><pre><span class="line">$ node sendToQueueApi</span><br><span class="line">data returned: &#123;<span class="string">"data"</span>:&#123;<span class="string">"sendToQueue"</span>:<span class="string">"true"</span>&#125;&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>從 Oracle PL/SQL 發送</strong></li>
</ul>
<p>從 Oracle 發送訊息最麻煩的就是 JSON 的組合，如何將資料組合成 JSON 格式，常常讓我非常沮喪，盡快將 Oracle 資料庫升級是解決的方法。這裡則是範例，希望能有些幫助。 </p>
<p>首先送到<strong>單一的消費者</strong>。你需要修改的主要在 32 ~ 49 行之間，當然也不要忘了第 9 行的 l_queue。</p>
<figure class="highlight sql"><figcaption><span>oracle_pls_sendtoqueue</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Publish to RabbitMQ Queue</span></span><br><span class="line"><span class="comment">--</span></span><br><span class="line"><span class="keyword">declare</span></span><br><span class="line">  l_http_request  Utl_Http.req;</span><br><span class="line">  l_http_response Utl_Http.resp;</span><br><span class="line">  l_url       varchar2(255) := 'http://10.11.xx.xxx:x000/v1/graphql';</span><br><span class="line">  l_buffer    varchar2(32767);</span><br><span class="line">  l_item      varchar2(1024);</span><br><span class="line">  l_queue     varchar2(32) := 'electron.notification.7x0x0x4x';</span><br><span class="line">  l_messages  varchar2(32767);</span><br><span class="line">  l_query     varchar2(32767);</span><br><span class="line"></span><br><span class="line">  function message(empno_in in number)</span><br><span class="line">    return varchar2</span><br><span class="line">  is</span><br><span class="line">    rec            emp%rowtype;</span><br><span class="line">    l_title        varchar2(100);</span><br><span class="line">    l_content      varchar2(1024);</span><br><span class="line">    l_description  varchar2(1024);</span><br><span class="line">    l_link         varchar2(1024);</span><br><span class="line">    l_link_text    varchar2(100);</span><br><span class="line">    l_link_url     varchar2(100);</span><br><span class="line">    l_type         varchar2(10) := 'urgent';</span><br><span class="line">    l_from         varchar2(20) := 'Oracle Lx00 Demo';</span><br><span class="line">    l_message      varchar2(1024);</span><br><span class="line">  <span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">select</span> * <span class="keyword">into</span> rec</span><br><span class="line">      <span class="keyword">from</span> emp</span><br><span class="line">     <span class="keyword">where</span> empno = empno_in;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">     l_title := '這是員工 ' || rec.ename || ' 資料';</span><br><span class="line"></span><br><span class="line">     l_content := '員工: ' || rec.empno || ' Name: ' || rec.ename || ' Job: ' || rec.job ||</span><br><span class="line">                  ' Hiredate: ' || to_char(sysdate,'yyyy-mm-dd"T"hh24:mi:ss') || ' Salary: ' || rec.sal ||</span><br><span class="line">                  ' Comm: ' || rec.comm || ' Department: ' || rec.deptno;</span><br><span class="line"></span><br><span class="line">     l_description := '['||</span><br><span class="line">                      '\"員工: ' ||rec.empno||' '||rec.ename||' '||rec.job||'\",'||</span><br><span class="line">                      '\"薪資: ' ||(rec.sal + nvl(rec.comm,0))||'\",'||</span><br><span class="line">                      '\"到職日: ' ||to_char(rec.hiredate,'yyyy-mm-dd"T"hh24:mi:ss')||'\"'||</span><br><span class="line">                      ']';</span><br><span class="line"></span><br><span class="line">     l_link_text := '讀取更多';</span><br><span class="line">     l_link_url := 'http://10.11.26.201:8080/ords/demo/employee/' || rec.empno;</span><br><span class="line">     l_link := '&#123;'||</span><br><span class="line">               '\"text\":' ||'\"'||l_link_text||'\",'||</span><br><span class="line">               '\"url\":'  ||'\"'||l_link_url||'\"'||</span><br><span class="line">               '&#125;';</span><br><span class="line"></span><br><span class="line">    l_message := '"&#123;'||</span><br><span class="line">                 '\"title\":'     ||'\"'||l_title||'\",'||</span><br><span class="line">                 '\"content\":'   ||'\"'||l_content||'\",'||</span><br><span class="line">                 '\"description\":'   ||l_description||','||</span><br><span class="line">                 '\"link\":'   ||l_link||','||</span><br><span class="line">                 '\"created\":'||'\"'||to_char(sysdate,'yyyy-mm-dd"T"hh24:mi:ss')||'\",'||</span><br><span class="line">                 '\"from\":'   ||'\"'||l_from||'\",'||</span><br><span class="line">                 '\"type\":'     ||'\"'||l_type||'\"'||</span><br><span class="line">                 '&#125;"';</span><br><span class="line"></span><br><span class="line">    return l_message;</span><br><span class="line">  exception</span><br><span class="line">    when no_data_found</span><br><span class="line">    then</span><br><span class="line">      return '"&#123;&#125;"';</span><br><span class="line">  <span class="keyword">end</span>;</span><br><span class="line"><span class="comment">-- main body</span></span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  <span class="keyword">for</span> rec <span class="keyword">in</span> (<span class="keyword">select</span> <span class="keyword">rownum</span>, empno <span class="keyword">from</span> emp <span class="keyword">where</span> empno = <span class="number">7788</span>)</span><br><span class="line">  <span class="keyword">loop</span></span><br><span class="line">    l_item := message(rec.empno);</span><br><span class="line">    l_messages := l_messages||case rec.rownum when 1 then '' else ',' <span class="keyword">end</span>||l_item;</span><br><span class="line">  <span class="keyword">end</span> <span class="keyword">loop</span>;</span><br><span class="line"></span><br><span class="line">  l_query := '&#123;"query":"mutation sendToQueue($queue: String!, $message: String!)' ||</span><br><span class="line">             ' &#123;\n  sendToQueue(queue: $queue, message: $message)\n&#125;",' ||</span><br><span class="line">             '"variables":&#123;"queue":"' || l_queue || '","message":' || l_messages ||'&#125;&#125;';</span><br><span class="line"></span><br><span class="line">  dbms_output.put_line(l_query);</span><br><span class="line"></span><br><span class="line">  l_http_request := utl_http.begin_request(l_url, 'POST','HTTP/1.1');</span><br><span class="line">  utl_http.set_header(l_http_request, 'user-agent', 'mozilla/4.0');</span><br><span class="line">  utl_http.set_header(l_http_request, 'content-type', 'application/json; charset=utf-8');</span><br><span class="line">  utl_http.set_header(l_http_request, 'Content-Length', lengthb(l_query));</span><br><span class="line">  utl_http.set_body_charset(l_http_request, charset =&gt; 'utf-8');</span><br><span class="line">  utl_http.write_text(l_http_request, l_query);</span><br><span class="line">  l_http_response := utl_http.get_response(l_http_request);</span><br><span class="line"></span><br><span class="line">  <span class="comment">-- process the response from the HTTP call</span></span><br><span class="line">  <span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">loop</span></span><br><span class="line">      utl_http.read_line(l_http_response, l_buffer);</span><br><span class="line">      dbms_output.put_line(l_buffer);</span><br><span class="line">    <span class="keyword">end</span> <span class="keyword">loop</span>;</span><br><span class="line">    utl_http.end_response(l_http_response);</span><br><span class="line">  exception</span><br><span class="line">    when utl_http.end_of_body</span><br><span class="line">    then</span><br><span class="line">      utl_http.end_response(l_http_response);</span><br><span class="line">    <span class="keyword">end</span>;</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line">/</span><br></pre></td></tr></table></figure>

<p>以下則是送到 RabbitMQ Exchange，這可以發送到多個消費者。</p>
<figure class="highlight sql"><figcaption><span>oracle_pls_sendtoexchange</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Publish to RabbitMQ Exchange </span></span><br><span class="line"><span class="comment">--</span></span><br><span class="line"><span class="keyword">declare</span></span><br><span class="line">  l_http_request  Utl_Http.req;</span><br><span class="line">  l_http_response Utl_Http.resp;</span><br><span class="line">  l_url          varchar2(255) := 'http://10.11.xx.xxx:x000/v1/graphql';</span><br><span class="line">  l_buffer       varchar2(32767);</span><br><span class="line">  l_item         varchar2(1024);</span><br><span class="line">  l_exchange     varchar2(32) := 'electron.notification';</span><br><span class="line">  l_routing_key  varchar2(32) := '';</span><br><span class="line">  l_messages     varchar2(32767);</span><br><span class="line">  l_query        varchar2(32767);</span><br><span class="line"></span><br><span class="line">  function message(empno_in in number)</span><br><span class="line">    return varchar2</span><br><span class="line">  is</span><br><span class="line">    rec            emp%rowtype;</span><br><span class="line">    l_title        varchar2(100);</span><br><span class="line">    l_content      varchar2(1024);</span><br><span class="line">    l_description  varchar2(1024);</span><br><span class="line">    l_link         varchar2(1024);</span><br><span class="line">    l_link_text    varchar2(100);</span><br><span class="line">    l_link_url     varchar2(100);</span><br><span class="line">    l_type         varchar2(10) := 'info';</span><br><span class="line">    l_from         varchar2(20) := 'Oracle Lx00 Demo';</span><br><span class="line">    l_message varchar2(1024);</span><br><span class="line">  <span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">select</span> * <span class="keyword">into</span> rec</span><br><span class="line">      <span class="keyword">from</span> emp</span><br><span class="line">     <span class="keyword">where</span> empno = empno_in;</span><br><span class="line"></span><br><span class="line">     l_title := '這是員工 ' || rec.ename || ' 資料';</span><br><span class="line"></span><br><span class="line">     l_content := '員工: ' || rec.empno || ' Name: ' || rec.ename || ' Job: ' || rec.job ||</span><br><span class="line">                  ' Hiredate: ' || to_char(sysdate,'yyyy-mm-dd"T"hh24:mi:ss') || ' Salary: ' || rec.sal ||</span><br><span class="line">                  ' Comm: ' || rec.comm || ' Department: ' || rec.deptno;</span><br><span class="line"></span><br><span class="line">     l_description := '['||</span><br><span class="line">                      '\"員工: ' ||rec.empno||' '||rec.ename||' '||rec.job||'\",'||</span><br><span class="line">                      '\"薪資: ' ||(rec.sal + nvl(rec.comm,0))||'\",'||</span><br><span class="line">                      '\"到職日: ' ||to_char(rec.hiredate,'yyyy-mm-dd"T"hh24:mi:ss')||'\"'||</span><br><span class="line">                      ']';</span><br><span class="line"></span><br><span class="line">     l_link_text := '讀取更多';</span><br><span class="line">     l_link_url := 'http://10.11.xx.xxx:x0x0/ords/demo/employee/' || rec.empno;</span><br><span class="line">     l_link := '&#123;'||</span><br><span class="line">               '\"text\":' ||'\"'||l_link_text||'\",'||</span><br><span class="line">               '\"url\":'  ||'\"'||l_link_url||'\"'||</span><br><span class="line">               '&#125;';</span><br><span class="line"></span><br><span class="line">     l_message := '"&#123;'||</span><br><span class="line">                  '\"title\":' ||'\"'||l_title||'\",'||</span><br><span class="line">                  '\"content\":' ||'\"'||l_content||'\",'||</span><br><span class="line">                  '\"description\":' ||l_description||','||</span><br><span class="line">                  '\"link\":' ||l_link||','||</span><br><span class="line">                  '\"created\":'||'\"'||to_char(sysdate,'yyyy-mm-dd"T"hh24:mi:ss')||'\",'||</span><br><span class="line">                  '\"from\":' ||'\"'||l_from||'\",'||</span><br><span class="line">                  '\"type\":' ||'\"'||l_type||'\"'||</span><br><span class="line">                  '&#125;"';</span><br><span class="line"></span><br><span class="line">    return l_message;</span><br><span class="line">  exception</span><br><span class="line">    when no_data_found</span><br><span class="line">    then</span><br><span class="line">      return '"&#123;&#125;"';</span><br><span class="line">  <span class="keyword">end</span>;</span><br><span class="line"><span class="comment">-- main body</span></span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  <span class="keyword">for</span> rec <span class="keyword">in</span> (<span class="keyword">select</span> <span class="keyword">rownum</span>, empno <span class="keyword">from</span> emp <span class="keyword">where</span> empno = <span class="number">7788</span>)</span><br><span class="line">  <span class="keyword">loop</span></span><br><span class="line">    l_item := message(rec.empno);</span><br><span class="line">    l_messages := l_messages||case rec.rownum when 1 then '' else ',' <span class="keyword">end</span>||l_item;</span><br><span class="line">  <span class="keyword">end</span> <span class="keyword">loop</span>;</span><br><span class="line"></span><br><span class="line">  l_query := '&#123;"query":"mutation sendToExchange($exchange: String!, $routingKey: String, $message: String!)'||</span><br><span class="line">             ' &#123;\n  sendToExchange(exchange: $exchange, routingKey: $routingKey, message: $message)\n&#125;",'||</span><br><span class="line">             '"variables":&#123;"exchange":"'||l_exchange||'","routingKey":"'||l_routing_key||'","message":'|| l_messages||'&#125;&#125;';</span><br><span class="line"></span><br><span class="line">  <span class="comment">--dbms_output.put_line(l_query);</span></span><br><span class="line"></span><br><span class="line">  l_http_request := utl_http.begin_request(l_url, 'POST','HTTP/1.1');</span><br><span class="line">  utl_http.set_header(l_http_request, 'user-agent', 'mozilla/4.0');</span><br><span class="line">  utl_http.set_header(l_http_request, 'content-type', 'application/json; charset=utf-8');</span><br><span class="line">  utl_http.set_header(l_http_request, 'Content-Length', lengthb(l_query));</span><br><span class="line">  utl_http.set_body_charset(l_http_request, charset =&gt; 'utf-8');</span><br><span class="line">  utl_http.write_text(l_http_request, l_query);</span><br><span class="line">  l_http_response := utl_http.get_response(l_http_request);</span><br><span class="line"></span><br><span class="line">  <span class="comment">-- process the response from the HTTP call</span></span><br><span class="line">  <span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">loop</span></span><br><span class="line">      utl_http.read_line(l_http_response, l_buffer);</span><br><span class="line">      dbms_output.put_line(l_buffer);</span><br><span class="line">    <span class="keyword">end</span> <span class="keyword">loop</span>;</span><br><span class="line">    utl_http.end_response(l_http_response);</span><br><span class="line">  exception</span><br><span class="line">    when utl_http.end_of_body</span><br><span class="line">    then</span><br><span class="line">      utl_http.end_response(l_http_response);</span><br><span class="line">    <span class="keyword">end</span>;</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line">/</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>從有安裝 Curl 的裝置發送</strong></li>
</ul>
<figure class="highlight bash"><figcaption><span>curl</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl <span class="string">'http://10.11.xx.xxx:x000/v1/graphql'</span> \</span><br><span class="line">     -H <span class="string">'Content-Type: application/json'</span> \</span><br><span class="line">     --data <span class="string">'&#123;"query":"mutation sendToQueue($queue: String!, $message: String!) &#123;sendToQueue(queue: $queue, message: $message)&#125;","variables":&#123;"queue":"electron.notification.7x0x0x4x","message":"&#123;\"title\":\"歡迎使用即時訊息通知\",\"content\":\"這是使用 Node.js Electron 開發的應用程序，是一個 Desktop 桌面應用程序。\",\"created\":\"Fri May 22 2020 11:26:13 GMT+0800 (GMT+08:00)\"&#125;"&#125;&#125;'</span></span><br></pre></td></tr></table></figure>

<p>透過 GraphQL API 幾乎可以包含所有的發送。也可使用各程式語言的 AMQP 程式庫直接連結 RabbitMQ Server。</p>
<h3 id="直接使用程式語言-AMQP-程式庫"><a href="#直接使用程式語言-AMQP-程式庫" class="headerlink" title="直接使用程式語言 AMQP 程式庫"></a>直接使用程式語言 AMQP 程式庫</h3><p>以下是 Node.js 的範例，C# 則請參考 <a href="/2019/07/09/RabbitMQ-with-C/">RabbitMQ with C#</a>。 </p>
<h4 id="使用-Node-js-amqplib-程式庫"><a href="#使用-Node-js-amqplib-程式庫" class="headerlink" title="使用 Node.js amqplib 程式庫"></a>使用 Node.js amqplib 程式庫</h4><p>首先我將一些基礎的工作抽象化，這包含了 RabbitMQ 開始的 Connection 等初始化工作，這個抽象化物件包含了，訊息的製造(Producer)與訊息的消費(Consumer)方法。其餘的就比較簡單了。</p>
<p>這裡會用到兩個 npm Node.js 程式包，amqplib 與 node-uuid。amqplib 是 RabbitMQ 的驅動程式，node-uuid 則會用來將每個送來的訊息設定一個唯一的編號，這可以用來追蹤訊息的流動。</p>
<figure class="highlight bash"><figcaption><span>shell</span></figcaption><table><tr><td class="code"><pre><span class="line">$ yarn add amqplib</span><br><span class="line"></span><br><span class="line">$ yarn add node-uuid</span><br></pre></td></tr></table></figure>

<p>以下是抽象層程式碼。</p>
<figure class="highlight javascript"><figcaption><span>rabbitmq.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> EventEmitter = <span class="built_in">require</span>(<span class="string">'events'</span>).EventEmitter;</span><br><span class="line"><span class="keyword">const</span> amqp = <span class="built_in">require</span>(<span class="string">"amqplib"</span>);</span><br><span class="line"><span class="keyword">const</span> uuid = <span class="built_in">require</span>(<span class="string">'node-uuid'</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RabbitMQ</span> <span class="keyword">extends</span> <span class="title">EventEmitter</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>() &#123;</span><br><span class="line">    <span class="keyword">super</span>();</span><br><span class="line">    <span class="keyword">this</span>.url = <span class="string">"10.11.xx.xxx"</span>;</span><br><span class="line">    <span class="keyword">this</span>.channel = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">this</span>.exchange = <span class="string">"electron.notification"</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">this</span>.sendToQueue = <span class="keyword">this</span>.sendToQueue.bind(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">this</span>.publish = <span class="keyword">this</span>.publish.bind(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">this</span>.receive = <span class="keyword">this</span>.receive.bind(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">this</span>.initialize = <span class="keyword">this</span>.initialize.bind(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.initialize().then(<span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">this</span>.emit(<span class="string">'ready'</span>, &#123;</span><br><span class="line">      publish: <span class="keyword">this</span>.publish,</span><br><span class="line">      sendToQueue: <span class="keyword">this</span>.sendToQueue,</span><br><span class="line">      receive: <span class="keyword">this</span>.receive</span><br><span class="line">    &#125;));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  initialize() &#123;</span><br><span class="line">    <span class="keyword">return</span> amqp</span><br><span class="line">      .connect(<span class="string">`amqp://<span class="subst">$&#123;<span class="keyword">this</span>.url&#125;</span>`</span>)</span><br><span class="line">      .then(<span class="function"><span class="params">conn</span> =&gt;</span> &#123;</span><br><span class="line">        process.once(<span class="string">'SIGINT'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">          <span class="built_in">console</span>.log(<span class="string">'amqp connection close.'</span>);</span><br><span class="line">          conn.close();</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> conn.createChannel()</span><br><span class="line">      &#125;)</span><br><span class="line">      .then(<span class="function"><span class="params">channel</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.channel = channel;</span><br><span class="line">      &#125;)</span><br><span class="line">      .catch(<span class="built_in">console</span>.warn)</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  sendToQueue(queue, content) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.channel.sendToQueue(</span><br><span class="line">      queue,</span><br><span class="line">      <span class="keyword">new</span> Buffer.from(content),</span><br><span class="line">      &#123;</span><br><span class="line">        persistent: <span class="literal">true</span>,</span><br><span class="line">        headers: &#123;</span><br><span class="line">          messageId: uuid.v4(),</span><br><span class="line">          api: <span class="string">"Electron-sendToQueue-v1"</span>,</span><br><span class="line">          firstPublish: <span class="built_in">Date</span>.now()</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  publish(exchange, routingKey, content) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.channel.publish(</span><br><span class="line">      exchange,</span><br><span class="line">      routingKey,</span><br><span class="line">      <span class="keyword">new</span> Buffer.from(content),</span><br><span class="line">      &#123;</span><br><span class="line">        persistent: <span class="literal">true</span>,</span><br><span class="line">        headers: &#123;</span><br><span class="line">          messageId: uuid(),</span><br><span class="line">          api: <span class="string">"Electron-publish-v1"</span>,</span><br><span class="line">          firstPublish: <span class="built_in">Date</span>.now()</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  receive(queue, routingKey, callback) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.channel.assertQueue(queue)</span><br><span class="line">      .then(<span class="function"><span class="params">q</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.channel.bindQueue(queue, <span class="keyword">this</span>.exchange, routingKey)</span><br><span class="line">      &#125;)</span><br><span class="line">      .then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.channel.consume(queue, msg =&gt; &#123;</span><br><span class="line">          <span class="keyword">let</span> data;</span><br><span class="line">          <span class="keyword">if</span> (msg) &#123;</span><br><span class="line">            <span class="comment">// console.log(msg.properties.headers);</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">              data = msg.content.toString();</span><br><span class="line">              callback(<span class="literal">null</span>, data);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">              <span class="built_in">console</span>.log(msg.content.toString());</span><br><span class="line">              callback(err);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">this</span>.channel.ack(msg);</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            callback(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'amqp consume error.'</span>));</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;)</span><br><span class="line">      .catch(<span class="built_in">console</span>.warn);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="keyword">new</span> RabbitMQ();</span><br></pre></td></tr></table></figure>

<p>這個抽象層使用了 EventEmitter，所產生的實例會是一個可觀察物件 (Observable)，第 44 行除了送出訊息本身外，還加了一個訊息標頭，可用來追蹤訊息的流程 (45 ~ 52)。</p>
<p>要注意的是第 72 行 receive 方法，這是一個消費者(Consume)，第 73 行如果 queue 已存在，則返回 queue, 如果不存在則會新建一個 RabbitMQ 的 queue。</p>
<p>第 75 行預設會將這個 queue 綁定到 <em>electron.notification</em> Exchange。所以如果第一次使用這個 Electron 應用程式，就會以登入的 AD 帳號產生一個 RabbitMQ 的 queue，例如，electron.notification.7x0x0x4x，預設綁定到 RabbitMQ <em>electron.notification</em> Exchange。這也就是說每個 <em>electron.notification.xxxxxxxx</em> queue 都會是 <em>electron.notification</em> Exchange 的成員，送到 Exchange <em>electron.notification</em> 的訊息都會轉發送到每個成員。 </p>
<p>註解的第 81 行，則是額外加入的訊息標頭。</p>
<p>其他的就簡單了。 送給特定的人:</p>
<figure class="highlight javascript"><figcaption><span>sendToQueue.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> rabbit = <span class="built_in">require</span>(<span class="string">'./rabbitmq'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> message = <span class="built_in">JSON</span>.stringify(</span><br><span class="line">  &#123;</span><br><span class="line">    title: <span class="string">'請假單已核准'</span>,</span><br><span class="line">    content: <span class="string">'請注意這是流程簽核系統所發出通知 編號 ： 202005182717332'</span>,</span><br><span class="line">    description: [</span><br><span class="line">      <span class="string">'請假者: 7x0x0x4x 林小明'</span>,</span><br><span class="line">      <span class="string">'職務代理人: 8x0x0x1x 陳大華'</span>,</span><br><span class="line">      <span class="string">'假別: 01 特別假'</span>,</span><br><span class="line">      <span class="string">'請假日期: 2020-05-18 04:00 PM~2020-05-18 04:30 PM'</span>,</span><br><span class="line">      <span class="string">'請假時數: .5'</span>,</span><br><span class="line">      <span class="string">'請假事由: 因事'</span></span><br><span class="line">    ],</span><br><span class="line">    created: (<span class="keyword">new</span> <span class="built_in">Date</span>()).toString(),</span><br><span class="line">    <span class="keyword">from</span>: <span class="string">'Send To Queue'</span>,</span><br><span class="line">    link: &#123;</span><br><span class="line">      text: <span class="string">'讀取更多'</span>,</span><br><span class="line">      url: <span class="string">'http://xxxxxf3n06.xxx.com.tw:7x8x/pls/yx2x/f?p=109:2'</span></span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">rabbit.on(<span class="string">'ready'</span>, (&#123; sendToQueue &#125;) =&gt; &#123;</span><br><span class="line">  sendToQueue(<span class="string">'electron.notification.7x0x0x4x'</span>, message);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>送給所有人:</p>
<figure class="highlight javascript"><figcaption><span>publish.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> rabbit = <span class="built_in">require</span>(<span class="string">'./rabbitmq'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> message = <span class="built_in">JSON</span>.stringify(</span><br><span class="line">  &#123;</span><br><span class="line">    title: <span class="string">'歡迎使用即時訊息通知'</span>,</span><br><span class="line">    content: <span class="string">'這是使用 Node.js Electron 開發的應用程序，是一個 Desktop 桌面應用程序。'</span>,</span><br><span class="line">    link: &#123;</span><br><span class="line">      text: <span class="string">'瞭解更多 Electron ...'</span>,</span><br><span class="line">      url: <span class="string">'https://www.electronjs.org/'</span></span><br><span class="line">    &#125;,</span><br><span class="line">    description: [</span><br><span class="line">      <span class="string">'使用 Node.js、Electron 與 React 開發。'</span>,</span><br><span class="line">      <span class="string">'使用 RabbitMQ 即時訊息代理。'</span>,</span><br><span class="line">      <span class="string">'可以從瀏覽器透過 GraphQL API 發送訊息。'</span>,</span><br><span class="line">      <span class="string">'可以使用 Oracle PL/SQL 發送訊息。'</span>,</span><br><span class="line">      <span class="string">'可以從作業系統使用 Node.js 或 Curl 發送訊息。'</span>,</span><br><span class="line">      <span class="string">'訊息使用 IndexDB 儲存在使用者端。'</span></span><br><span class="line">    ],</span><br><span class="line">    created: (<span class="keyword">new</span> <span class="built_in">Date</span>()).toString(),</span><br><span class="line">    <span class="keyword">from</span>: <span class="string">'Hello Tainan'</span>,</span><br><span class="line">    type: <span class="string">'info'</span></span><br><span class="line">  &#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">rabbit.on(<span class="string">'ready'</span>, (&#123; publish &#125;) =&gt; &#123;</span><br><span class="line">  publish(<span class="string">'electron.notification'</span>, <span class="string">''</span>, message);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>其他的程式語言可參考 <a href="https://www.rabbitmq.com/getstarted.html" target="_blank" rel="noopener">RabbitMQ Tutorials</a>。</p>
<h3 id="群組"><a href="#群組" class="headerlink" title="群組"></a>群組</h3><p>我沒有在這個 Electron 應用程式中設定群組，我不想讓應用程式架構太複雜。但這並不表示我們不能在這個訊息通知有群組的功能。</p>
<p>這可用 RabbitMQ 來達成，甚至群組還可以細分子群組。</p>
<img src="/2020/05/21/Electron-Notification-Buzzer/electron-052201.png" title="RabbitMQ Exchange">

<p>建立 electron.notification.hrs Exchange。注意這個 Exchange type 是 direct。</p>
<img src="/2020/05/21/Electron-Notification-Buzzer/electron-052202.png" title="RabbitMQ Queue">

<p>這個 electron.notification.90060023 則有 3 個 Exchange Bindings，下列送出的訊息這個 Queue 都會收到:</p>
<ul>
<li>直接送給 Queue electron.notification.9x0x0x2x。</li>
<li>送給 Exchange electron.notification，Routing Key 是 ‘’。</li>
<li>送給 Exchange election.notification.hrs， Routing Key 是 ‘’。</li>
<li>送給 Exchange election.notification.hrs， Routing Key 是 ‘admin’。</li>
</ul>
<figure class="highlight javascript"><figcaption><span>publish.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">rabbit.on(<span class="string">'ready'</span>, (&#123; publish &#125;) =&gt; &#123;</span><br><span class="line">  publish(<span class="string">'electron.notification.hrs'</span>, <span class="string">'admin'</span>, message);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>所以上面送出的訊息意思就是，只有群組 hrs 下的子群組 admin 才會收到訊息。</p>
<p>群組成員可以用 RabbitMQ 管理介面查到。</p>
<img src="/2020/05/21/Electron-Notification-Buzzer/electron-052203.png" title="RabbitMQ Queue">

<p>RabbitMQ 功能強大，又提供友善的管理介面，有銀行業的加持，可以善加利用。希望這個 Electron 應用程式能引起各位的應用思考，常常聽到同仁有分散式資料整合的困擾， GraphQL API 與 RabbitMQ 創造了無限的空間。</p>
<p>使用 APEX 建立一個使用者發送訊息的 UI 介面，你就可以利用這個 Electron 應用程式，創造一個對談應用程式。</p>
<h4 id="原始程式碼"><a href="#原始程式碼" class="headerlink" title="原始程式碼"></a>原始程式碼</h4><p>這裡是程式碼，有興趣的可以看看，我使用的編輯器是 Visual Studio Code。Visual Studio Code 也是用 Electron 開發的。</p>
<figure class="highlight bash"><figcaption><span>source</span></figcaption><table><tr><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> z:\dba\git\depot\electron-react-rabbit.git your_directory</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cd</span> your-directory</span><br><span class="line"></span><br><span class="line">$ yarn install</span><br><span class="line"></span><br><span class="line">$ yarn start</span><br></pre></td></tr></table></figure>

<p>開發環境是 Node.js + Election + React + Babel.js + Webpack。</p>
<p>開發完打包:</p>
<figure class="highlight bash"><figcaption><span>source</span></figcaption><table><tr><td class="code"><pre><span class="line">$ yarn package</span><br></pre></td></tr></table></figure>

<p>它會產生 out 目錄，裡面就是最後上線的程式碼。也就是我們之前解壓縮後的目錄。</p>
<p>祝 健康快樂， Coding 愉快。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://1184yang.github.io/2020/05/21/Electron-Notification-Buzzer/" data-id="ckcpzj95k000b80vzf2baea3g" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Electron-React-Quickstart" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/05/08/Electron-React-Quickstart/" class="article-date">
  <time datetime="2020-05-08T06:22:22.000Z" itemprop="datePublished">2020-05-08</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/JavaScript/">JavaScript</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/05/08/Electron-React-Quickstart/">桌面應用 Electron React Quickstart</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>之前曾經使用 NW.js 與 Vue.js 開發一套可離線應用的桌面應用程序，資料存在客戶端的 localStorege 中，這裡我則用 Electron 搭配 React 建立了一個基本的開發架構，有興趣使用此架構的同仁可以很快的開始。</p>
<p>這裡客戶端我使用 React 程式庫取代了 Vue.js，因為我可以用同樣的 React 元件，透過 <a href="https://reactnative.dev/" target="_blank" rel="noopener">React Native</a> 就可打造原生移動裝置的應用程序。React Native 僅僅需要使用一種編程語言 JavaScript ，同一個開發團隊就可以建構 Android、iOS 應用程序。其他的跨平台解決方案 PhoneGap、Cordova 和 Ionic 雖然也是可行，但在用戶體驗與性能上表現卻不佳。React Native 的亮點就在於它的性能無損，與使用 Objective-C、Swift 或 Java 建構的原生移動應用程序相比，性能沒有明顯的差異。</p>
<p>近年來，原生移動開發變得越來越昂貴，因此能夠開發跨平台應用程序的工程師越來愈搶手，React Native 僅僅使用單一主流框架就可以開發桌面、Web 以及移動應用程序，值得讓我們思考與組織架構的調整。開發團隊使用同一種技術可以簡化協同合作和共享，因此生產力也會提升。</p>
<p>這裡我們則先用 Electron 與 React 來建立桌上型應用程序。除了基本的架構範例可以作為專案的開始範本，我也建立了一個基本的展示範例，除了使用 Electron、React 外加 IndexDB 將資料存在客戶端。我將此兩個範例都打包成 git  Repository，因此你除了要安裝 Visual Studio Code 外，也需要安裝 Git。</p>
<ul>
<li>electron-react-quickstart.git</li>
<li>electron-react-idb-sample.git</li>
</ul>
<p>這裡就從第一個基本架構開始。</p>
<h3 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h3><p>首先用 Git 複製範例，打開 Visual Studio Code, 開啟一個終端螢幕，我電腦的 Z: 是指向 VOL111(\PECYKFS01)。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">I:\u01\projects&gt;git clone Z:\DBA\Git\Depot\electron-react-quickstart.git</span><br></pre></td></tr></table></figure>

<p>然後用 Visual Studio Code 開啟目錄 electron-react-quickstart 開始安裝程式庫。這裡我要用 Yarn 來取代 npm 管理 JavaScript 套件。 Yarn 是 Facebook 與 Exponent、 Google、Tilde 所合作開發的套件管理工具，其功能與 npm 相同，但 npm 最為人詬病的是安裝速度很慢、安裝相依套件沒有順序性，而 Yarn 不但解決了這些問題，還加入了方便的 Cache 機制使套件均只要下載一次，多個專案若使用相同套件時不必重新下載。 官方也表示 Yarn 是快速、安全、可靠的，且能支援多系統。</p>
<p>所以首先要先安裝 <a href="https://classic.yarnpkg.com/zh-Hant/docs/install/#windows-stable" target="_blank" rel="noopener">Yarn</a>。可以測試一下:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">I:\u01\projects\electron-react-quickstart&gt;yarn --version</span><br><span class="line">1.22.4</span><br></pre></td></tr></table></figure>

<p>在你的 electron-react-quickstart 目錄下開始安裝所需要的程式庫:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">I:\u01\projects\electron-react-quickstart&gt;yarn install </span><br></pre></td></tr></table></figure>

<p>安裝完成就可以開啟應用程序:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">I:\u01\projects\electron-react-quickstart&gt;yarn start </span><br></pre></td></tr></table></figure>

<p>這裡是基本應用程序的畫面:</p>
<img src="/2020/05/08/Electron-React-Quickstart/electron-051101.png" title="Hello Tainan">

<p>以下則是專案的目錄結構:</p>
<img src="/2020/05/08/Electron-React-Quickstart/electron-051102.png" title="Hello Tainan">

<p>這個專案的程式碼都在 src 目錄中。使用 webpack 為開發及打包工具。簡單的來看看這幾段程式碼，可以從 package.json 的設定找到這個專案程序的入口點:</p>
<figure class="highlight"><figcaption><span>package.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"name"</span>: <span class="string">"fire-sale"</span>,</span><br><span class="line">  <span class="attr">"productName"</span>: <span class="string">"FireSale"</span>,</span><br><span class="line">  <span class="attr">"version"</span>: <span class="string">"1.0.0"</span>,</span><br><span class="line">  <span class="attr">"description"</span>: <span class="string">"My Electron application description"</span>,</span><br><span class="line marked">  <span class="attr">"main"</span>: <span class="string">".webpack/main"</span>,</span><br><span class="line">  <span class="attr">"scripts"</span>: &#123;</span><br><span class="line">    <span class="attr">"start"</span>: <span class="string">"electron-forge start"</span>,</span><br><span class="line">    <span class="attr">"package"</span>: <span class="string">"electron-forge package"</span>,</span><br><span class="line">    <span class="attr">"make"</span>: <span class="string">"electron-forge make"</span>,</span><br><span class="line">    <span class="attr">"publish"</span>: <span class="string">"electron-forge publish"</span>,</span><br><span class="line">    <span class="attr">"lint"</span>: <span class="string">"echo \"No linting configured\""</span></span><br><span class="line">  &#125;,</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure>

<p>第 6 行 “main”: “.webpack/main” 是這個專案程序的入口點，但這是經過 webpack 轉譯後的入口點，真正的入口點是對照到 src 目錄下的 main.js 程式檔。</p>
<figure class="highlight"><figcaption><span>package.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">"entryPoints": [</span><br><span class="line">  &#123;</span><br><span class="line marked">    <span class="attr">"html"</span>: <span class="string">"./src/index.html"</span>,</span><br><span class="line marked">    <span class="attr">"js"</span>: <span class="string">"./src/renderer.js"</span>,</span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"main_window"</span></span><br><span class="line">  &#125;</span><br><span class="line">] </span><br></pre></td></tr></table></figure>

<p>package.json 的第 56,57 行則是 Electron 的習慣性基本的命名程式檔，簡單的看一下 Electron 的基本架構:</p>
<img src="/2020/05/08/Electron-React-Quickstart/electron-051103.png" title="Electron multiprocess architecture">

<blockquote>
<p><em>The main process</em></p>
<blockquote>
<p>Main process 有幾個重要職責。它可以回應應用程序生命週期事件，例如啟動，退出，準備退出，進入後台，進入前台等等，Main process 還負責與本機操作系統 API 進行通信。 如果要顯示一個對話框以打開或保存文件，就得從 Main process 進行操作。 </p>
</blockquote>
</blockquote>
<blockquote>
<p><em>Renderer processes</em></p>
<blockquote>
<p>Main process 可以使用 Electron 的 Browser-Window 模塊創建和銷毀 Renderer process。 Renderer process 可以加載網頁以顯示客戶端的 GUI。 每個進程都利用 Chronium 的多進程架構，並在其自己的線程(Thread)上運行。 然後，這些頁面可以加載其他 JavaScript 文件並在此線程中執行代碼。 與普通網頁不同，您可以從 Renderer process 訪問所有 Node API，從而可以使用本機模塊和較低級別的系統功能溝通。</p>
</blockquote>
</blockquote>
<figure class="highlight javascript"><figcaption><span>main.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; app, BrowserWindow &#125; = <span class="built_in">require</span>(<span class="string">'electron'</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">require</span>(<span class="string">'electron-squirrel-startup'</span>)) &#123;</span><br><span class="line">  app.quit();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> createWindow = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> mainWindow = <span class="keyword">new</span> BrowserWindow(&#123;</span><br><span class="line">    width: <span class="number">800</span>,</span><br><span class="line">    height: <span class="number">600</span>,</span><br><span class="line">    webPreferences: &#123;</span><br><span class="line">      nodeIntegration: <span class="literal">true</span></span><br><span class="line">    &#125;,</span><br><span class="line">    show: <span class="literal">false</span>,</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  mainWindow.loadURL(MAIN_WINDOW_WEBPACK_ENTRY);</span><br><span class="line"></span><br><span class="line">  mainWindow.once(<span class="string">'ready-to-show'</span>, () =&gt; &#123;</span><br><span class="line">    mainWindow.show();</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// mainWindow.webContents.openDevTools();</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">app.on(<span class="string">'ready'</span>, createWindow);</span><br><span class="line"></span><br><span class="line">app.on(<span class="string">'window-all-closed'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (process.platform !== <span class="string">'darwin'</span>) &#123;</span><br><span class="line">    app.quit();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.on(<span class="string">'activate'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (BrowserWindow.getAllWindows().length === <span class="number">0</span>) &#123;</span><br><span class="line">    createWindow();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>第 18 行的 MAIN_WINDOW_WEBPACK_ENTRY 是 webpack 特殊的全域變數，預設值是在前面 package.json 中設定的 “./src/index.html”，index.html 則會自動載入 “./src/renderer.js” </p>
<figure class="highlight html"><figcaption><span>index.html</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Hello Tainan!<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"application"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"loading"</span>&gt;</span>Loading…<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><figcaption><span>renderer.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; render &#125; <span class="keyword">from</span> <span class="string">'react-dom'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'./index.css'</span>;</span><br><span class="line"></span><br><span class="line">render(</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;h1&gt;💖 Hello World! Hello 台南!!&lt;<span class="regexp">/h1&gt;</span></span><br><span class="line"><span class="regexp">    &lt;p&gt;Welcome to your Electron application.&lt;/</span>p&gt;</span><br><span class="line">  &lt;<span class="regexp">/div&gt;, </span></span><br><span class="line"><span class="regexp">  document.getElementById('application')</span></span><br><span class="line"><span class="regexp">);</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">console.log('👋 此消息使用 webpack 透過 "renderer.js" 發出 👀');</span></span><br></pre></td></tr></table></figure>

<p>這裡使用 React 與 ReactDOM 來渲染客戶端的 GUI，這裡使用 render 方法創建客戶端的 UI，其中使用了 React 的 JSX。JSX 是 JavaScript 的語法擴展，與 XML 有點類似。雖然不用 JSX 也可以建構 React 組件，但是 JSX 能夠使 React 更易於閱讀和維護。JSX 初看可能有些奇怪，但功能非常強大，深得廣大開發者的青睞。</p>
<p>第 3 行使用 import 直接載入 css 檔案，這是因為透過 webpack 的轉譯，可以不用透過 html 的 link 標籤，webpack 會將 css 直接轉譯為 javascript，最終則與其它程式檔打包成為一個單一的程式檔，這通常會命名為 bundle.js。  </p>
<p>最後我們設計的應用程序必須打包讓使用者更容易安裝使用，webpack 將負責此工作。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">I:\u01\projects\electron-react-quickstart&gt;yarn run package</span><br></pre></td></tr></table></figure>

<p>完成後在專案目錄下會產生一個 out 子目錄:</p>
<img src="/2020/05/08/Electron-React-Quickstart/electron-051104.png" title="Electron multiprocess architecture">

<p>可以從檔案總管中直接執行 FireSale.exe，這個執行檔名稱也是在 package.json 中 “productName”: “FireSale” 定義的:</p>
<img src="/2020/05/08/Electron-React-Quickstart/electron-051105.png" title="Electron multiprocess architecture">

<p>因為這是 Electron 應用程序，沒有 Web 伺服器，所以你必須將整個目錄打包成 zip 檔，讓使用下載解壓縮後直接執行 exe 檔。</p>
<p>下次再來探索另外一個範例 electron-react-idb-sample.git，將可以學到更多的 Electron 與 React。並看看如何將資料儲存在客戶端。</p>
<p>祝 Coding 愉快，身體健康。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://1184yang.github.io/2020/05/08/Electron-React-Quickstart/" data-id="ckcpzj95e000780vzifbm5u9e" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Dotnet-core-DI" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/04/24/Dotnet-core-DI/" class="article-date">
  <time datetime="2020-04-24T02:37:37.000Z" itemprop="datePublished">2020-04-24</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/C/">C#</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/04/24/Dotnet-core-DI/">C# 教育訓練 .NET core 依賴注入 (Dependency Injection)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>.NET Core 支援依賴注入(Dependency Injection, DI)的設計模式，這是一種用於在類(Class)及其依賴項之間實現控制反轉（IoC）的技術。</p>
<p>依賴項注入允許從類的外部注入依賴項，因此注入依賴項的類只需要知道一個協定(通常是 C# 介面，Interface)。這個類可以遵守這個介面的協議而獨立於其物件的創建。</p>
<p>依賴注入並不一定需要依賴注入容器(Dependency Injection Container)，但使用容器有助於管理依賴項。當依賴注入容器管理的服務列表越來越長時，就可以看到容器的優點。ASP.NET Core 和 Entity Framework Core 使用 Microsoft.Extensions.DependencyInjection 作為容器來管理所有的依賴項，以此管理數百個服務。所以王智民老師才會特別講解依賴注入。</p>
<p>儘管依賴注入和依賴注入容器在非常小的應用程序中會增加複雜性，但是一旦應用程序變得更大，需要多個服務，依賴注入就會顯示它的效益，降低應用程序的複雜性，並促進非緊密綁定的實現(鬆散耦合)。</p>
<p>到此，觀念還是很抽象，這裡就從一個<strong>不使用依賴注入</strong>的小應用程式開始；隨後將它轉換為使用依賴注入並使用注入依賴容器的應用程序。</p>
<h3 id="使用沒有依賴注入的服務"><a href="#使用沒有依賴注入的服務" class="headerlink" title="使用沒有依賴注入的服務"></a>使用沒有依賴注入的服務</h3><p>開啟 VS Code，首先建立一個 .NET Core Console 專案</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ dotnet new console --name MyDI</span><br></pre></td></tr></table></figure>

<p>使用 VS Code 切換到新建立的 .NET Core 專案目錄 MyDI。開啟一個終端螢幕輸入 <strong>dotnet run</strong> 測試一下。我們就可以開始了。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ dotnet run</span><br><span class="line">Hello World!</span><br></pre></td></tr></table></figure>

<p>先在專案目錄下開兩個子目錄 Services 與 Controllers 分別擺放不同功能型態的程式碼。在 Services 下建立 GreetingService.cs，在 Controllers 下是 HomeController.cs。 程式碼都很短，不要用複製貼上，自己 Coding，享受一下 Coding 的樂趣。</p>
<img src="/2020/04/24/Dotnet-core-DI/dotnet-di-113328.png" title="MyDI 專案目錄">

<p>這個 GreetingService 類定義了返回字符串的 Greet 方法。</p>
<figure class="highlight csharp"><figcaption><span>Services/GreetingService.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">MyDI.Services</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">GreetingService</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">string</span> <span class="title">Greet</span>(<span class="params"><span class="keyword">string</span> name</span>)</span> =&gt; <span class="string">$"Hello Tainan, 哈囉，<span class="subst">&#123;name&#125;</span>"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>HomeController 類使用了這個 GreetingService 服務。</p>
<figure class="highlight csharp"><figcaption><span>Controllers/HomeController.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> MyDI.Services;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">MyDI.Controllers</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">HomeController</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">string</span> <span class="title">Hello</span>(<span class="params"><span class="keyword">string</span> name</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">var</span> service = <span class="keyword">new</span> GreetingService();</span><br><span class="line">            <span class="keyword">return</span> service.Greet(name); </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>現在看看 Program 類的 Main( ) 方法。</p>
<figure class="highlight csharp"><figcaption><span>Program.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> MyDI.Controllers;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">MyDI</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="keyword">string</span>[] args</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">var</span> controller = <span class="keyword">new</span> HomeController();</span><br><span class="line">            <span class="keyword">string</span> result = controller.Hello(<span class="string">"Emily"</span>);</span><br><span class="line">            Console.WriteLine(result);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>現在跑跑看。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ dotnet run</span><br><span class="line"></span><br><span class="line">Hello Tainan, 哈囉，Emily</span><br></pre></td></tr></table></figure>

<p>這有甚麼問題嗎? HomeController 與 GreetingService 是緊密耦合的。要用不同的實現取代 HomeController 中的 GreetingService 並不容易。</p>
<p>現在用另一個 SayHelloService 服務來取代原先的 GreetingService 看看會需要動到哪些程式碼。</p>
<p>在目錄 Services 下建立 SayHelloService 類，這裡用 SayHello 方法返回一個字符串。</p>
<figure class="highlight csharp"><figcaption><span>Services/SayHelloService.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">MyDI.Services</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SayHelloService</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">string</span> <span class="title">SayHello</span>(<span class="params"><span class="keyword">string</span> name</span>)</span> =&gt; <span class="string">$"Say 哈囉，<span class="subst">&#123;name&#125;</span>, Hello Tainan!"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>要用 SayHelloService 取代 GreetingService 現在必需要直接修改 HomeController。</p>
<figure class="highlight csharp"><figcaption><span>Controllers/HomeController.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> MyDI.Services;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">MyDI.Controllers</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">HomeController</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">string</span> <span class="title">Hello</span>(<span class="params"><span class="keyword">string</span> name</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">var</span> service = <span class="keyword">new</span> SayHelloService();</span><br><span class="line">            <span class="keyword">return</span> service.SayHello(name); </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>這裡修改了第 9 與 10 行，改使用 SayHelloService 服務。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ dotnet run</span><br><span class="line"></span><br><span class="line">Say 哈囉，Emily, Hello Tainan!</span><br></pre></td></tr></table></figure>

<p>在這個簡單的例子中看起來也還好，並不是很複雜。 但這裡的服務都只是返回字符串的簡單服務，一般的應用程序通常更複雜，要修改的也更多，有些還會有一些相互的牽扯，最怕的是有些還不知道藏在哪裡，要等到出問題才會知道。現在改用依賴注入，看看會有甚麼不同。</p>
<h3 id="使用依賴注入"><a href="#使用依賴注入" class="headerlink" title="使用依賴注入"></a>使用依賴注入</h3><p>現在要讓 HomeController 獨立於 GreetingService 與 SayHelloService 的實現，當要變更服務時，不用再直接修改 HomeController 類。為此，我們必須訂立一個協定，讓這些服務遵守，這裡要用一個 IGreetingService 介面(Interface)來定義 HomeController 所需要的功能，IGreetingService 介面就是一個協定。在專案目錄下建一個子目錄 Interfaces 擺放介面程式碼 IGreetingService.cs  </p>
<figure class="highlight csharp"><figcaption><span>Interfaces/IGreetingService.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">MyDI.Interfaces</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IGreetingService</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">string</span> <span class="title">Greet</span>(<span class="params"><span class="keyword">string</span> name</span>)</span>; </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在這個 IGreetingService 介面中，目前只有一個協議 Greet 方法。現在 GreetingService 與 SayHelloService 都必須遵守這個協定，也就是都要實現這個 Greet 方法。</p>
<figure class="highlight csharp"><figcaption><span>Services/GreetingService.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> MyDI.Interfaces;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">MyDI.Services</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">GreetingService</span> : <span class="title">IGreetingService</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">string</span> <span class="title">Greet</span>(<span class="params"><span class="keyword">string</span> name</span>)</span> =&gt; <span class="string">$"Hello Tainan, 哈囉，<span class="subst">&#123;name&#125;</span>"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight csharp"><figcaption><span>Services/SayHelloService.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> MyDI.Interfaces;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">MyDI.Services</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SayHelloService</span> : <span class="title">IGreetingService</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">string</span> <span class="title">Greet</span>(<span class="params"><span class="keyword">string</span> name</span>)</span> =&gt; <span class="string">$"Say 哈囉，<span class="subst">&#123;name&#125;</span>, Hello Tainan!"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">string</span> <span class="title">SayHello</span>(<span class="params"><span class="keyword">string</span> name</span>)</span> =&gt; <span class="string">$"Say 哈囉，<span class="subst">&#123;name&#125;</span>, Hello Tainan!"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>SayHelloService 原先並沒有 Greet 方法，因此必須實作，這裡將舊的 SayHello( ) 方法留著，萬一有人使用了緊密耦合。</p>
<p>HomeController 現在只需要對一個物件的引用，該物件會實現介面 IGreetingService 中的所有協議。這個物件會用 HomeController 的建構式函式(Constructor)注入，分配給私有字段(private filed)，通過方法 Hello 來使用。</p>
<figure class="highlight csharp"><figcaption><span>Controllers/HomeController.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> MyDI.Interfaces;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">MyDI.Controllers</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">HomeController</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> IGreetingService _greetingService;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">HomeController</span>(<span class="params">IGreetingService greetingService</span>)</span> &#123;</span><br><span class="line">            _greetingService = greetingService ?? <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(greetingService));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">string</span> <span class="title">Hello</span>(<span class="params"><span class="keyword">string</span> name</span>)</span> =&gt; _greetingService.Greet(name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第 10 行是 HomeController 的建構函式，參數型態是 IGreetingService 介面，因此只要能實現 IGreetingService 介面的物件都可以由此注入。HomeController 則透過 Hello 方法來使用這個注入物件的 Greet 方法。　</p>
<p>在這個實現中，HomeController 類利用了控制反轉(Inversion of Control, IoC)的設計原理。HomeController 並沒有像以前那樣直接實例化 GreetingService 或 SayHelloService。相反的，定義由 HomeController 使用具體類的控件從外部注入，也就是透過 HomeController 的建構函式從外部注入。換句話說，控制是反轉的。HomeController 不能直接決定自己要用哪個服務，而是由外界決定 HomeController 該用哪個服務。反轉控制也被稱為好萊塢原則：不要給我們打電話，我們會給你打電話(don’t call us, we’ll call you)。</p>
<p>HomeController 類並沒有依賴 IGreetingService 介面的具體實作，而是可以使用實現了介面 IGreetingService 的任何類。所以這裡可以使用 GreetingService 與 SayHelloService 類，因這兩個類都具體實作了 IGreetingService 介面。</p>
<p>現在，需要從外部注入依賴項，將具體的實現傳遞給 HomeController 類的建構函式。</p>
<figure class="highlight csharp"><figcaption><span>Program.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> MyDI.Controllers;</span><br><span class="line"><span class="keyword">using</span> MyDI.Services;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">MyDI</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="keyword">string</span>[] args</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">var</span> controller = <span class="keyword">new</span> HomeController(<span class="keyword">new</span> GreetingService());</span><br><span class="line">            <span class="keyword">string</span> result = controller.Hello(<span class="string">"Emily"</span>);</span><br><span class="line">            Console.WriteLine(result);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>第 11 行使用建構函式注入的依賴注入模式實現了控制反轉的設計原則。這稱為建構函式注入，因為介面是在建構函式中注入的。所以這裡需要注入一個依賴項物件來創建一個 HomeController 實例。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ dotnet run</span><br><span class="line"></span><br><span class="line">Hello Tainan, 哈囉，Emily</span><br></pre></td></tr></table></figure>

<p>現在注入不同的服務，更改第 11 行注入不同的依賴項:</p>
<figure class="highlight csharp"><figcaption><span>Program.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">            <span class="keyword">var</span> controller = <span class="keyword">new</span> HomeController(<span class="keyword">new</span> SayHelloService());</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ dotnet run</span><br><span class="line"></span><br><span class="line">Say 哈囉，Emily, Hello Tainan!</span><br></pre></td></tr></table></figure>

<p>到此，我們已完成了依賴注入的改寫。這個範例程序非常小，唯一需要注入的是一個實現協定 IGreetingService 介面的類。 這個類在實例化的同時實例化了 HomeController。</p>
<p>到目前為止我們已經實現了依賴注入，但還沒有使用容器來管理這些依賴項。在實際應用程序中，需要處理許多介面與實現，還需要共享實例，最好的方法還是使用依賴注入容器來管理所有的依賴項。</p>
<h3 id="使用-NET-Core-DI-容器"><a href="#使用-NET-Core-DI-容器" class="headerlink" title="使用 .NET Core DI 容器"></a>使用 .NET Core DI 容器</h3><p>依賴注入不一定需要使用依賴注入容器，但容器有助於管理依賴項，這裡要使用 Microsoft.Extensions.DependencyInjection 作為容器來管理所有依賴項。</p>
<p>首先需要安裝 Microsoft.Extensions.DependencyInjection。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ dotnet add package Microsoft.Extensions.DependencyInjection</span><br></pre></td></tr></table></figure>

<p>在依賴注入容器中，可以在應用程式中有一個位置，在其中定義甚麼協定(介面 Interface)映射到哪個特定的實現(具體的類 Class)上。還可以指定是應該將服務作為一個單例(Singleton)來使用，還是應該在每次使用時創建一個新實例(Transient)。</p>
<p>首先在 Program 類中定義 RegisterService 方法。在這裡，實例化一個新的 ServiceCollection 物件，ServiceCollection 就在 Microsoft.Extensions.DependencyInjection 名稱空間中，使用 ServiceCollection 的擴展方法 AddSingleton 與 AddTransient 來註冊 DI 容器需要知道的類型，範例中我們將 GreetingService 與 HomeController 都註冊在容器中，這樣允許從容器中檢索 HomeController。</p>
<p>當請求 IGreetingService 介面時，會實例化 GreetingService 類。HomeController 本身沒有實現介面。通過這個 DI 容器配置，當請求 HomeController 時，DI 容器會時例化 HomeController。</p>
<p>DI 容器配置還定義了服務的生命週期，使用 AddSingleton 與 AddTransient 方法指定服務的生命週期信息。對於 GreetingService，使用 AddSingleton 註冊，因此請求 IGreetingService 時總是返回相同的實例。這和 HomeController 不同， HomeControler，使用 AddTransient 註冊，每次請求檢索 HomeController 時，則都會創建一個新的實例。</p>
<figure class="highlight csharp"><figcaption><span>Program.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Extensions.DependencyInjection;</span><br><span class="line"><span class="keyword">using</span> MyDI.Controllers;</span><br><span class="line"><span class="keyword">using</span> MyDI.Services;</span><br><span class="line"><span class="keyword">using</span> MyDI.Interfaces;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">MyDI</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="keyword">string</span>[] args</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">using</span> (ServiceProvider container = RegisterServices())</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> controller = container.GetRequiredService&lt;HomeController&gt;();</span><br><span class="line">                <span class="keyword">string</span> result = controller.Hello(<span class="string">"Emily"</span>);</span><br><span class="line">                Console.WriteLine(result);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">static</span> ServiceProvider <span class="title">RegisterServices</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">            <span class="keyword">var</span> services = <span class="keyword">new</span> ServiceCollection();</span><br><span class="line">            services.AddSingleton&lt;IGreetingService, GreetingService&gt;();</span><br><span class="line">            services.AddTransient&lt;HomeController&gt;();</span><br><span class="line">            <span class="keyword">return</span> services.BuildServiceProvider();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第 21 行新增靜態方法 RegisterService( )。<br>第 23、24 行註冊 GreetingService 與 HomeController。<br>第 25 行調用 BuildServiceProvider，這會返回一個 ServiceProvider 物件，該物件可以用來訪問已註冊的服務。</p>
<p>再來要修改 Main 方法來調用 RegisterService 方法以便在容器中註冊。</p>
<p>第 13 行允許直接訪問 ServiceProvider 的 Dispose 方法，所以這裡使用 using 語句。<br>第 15 行調用 ServiceProvider 的 GetRequiredService 方法來取得對 HomeController 實例的引用。</p>
<p>啟動應用程序時，在 GetRequiredService 方法的請求下，DI 容器將創建 HomeController 類的實例。HomeController 的建構函式需要一個實現 IGreetingService 的物件。這個介面 IGreetingService 也有在容器中註冊，在此它會返回 GreetingService 物件。GreetingService 類有一個預設的建構函式，因此容器可以創建一個實例，並將該實例傳遞給 HomeController 的建構函式。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ dotnet run</span><br><span class="line"></span><br><span class="line">Hello Tainan, 哈囉，Emily</span><br></pre></td></tr></table></figure>

<p>現在改註冊另外一個 SayHelloService 服務。</p>
<figure class="highlight csharp"><figcaption><span>Program.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> ...</span><br><span class="line"> <span class="function"><span class="keyword">static</span> ServiceProvider <span class="title">RegisterServices</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">     <span class="keyword">var</span> services = <span class="keyword">new</span> ServiceCollection();</span><br><span class="line">     <span class="comment">// services.AddSingleton&lt;IGreetingService, GreetingService&gt;();</span></span><br><span class="line">     services.AddSingleton&lt;IGreetingService, SayHelloService&gt;();</span><br><span class="line">     services.AddTransient&lt;HomeController&gt;();</span><br><span class="line">     <span class="keyword">return</span> services.BuildServiceProvider();</span><br><span class="line"> &#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ dotnet run</span><br><span class="line"></span><br><span class="line">Say 哈囉，Emily, Hello Tainan!</span><br></pre></td></tr></table></figure>

<p>如果同時註冊 GreetingService 與 SayHelloService 那又會如何? 如果多次將相同的介面協議添加到服務集合(ServiceCollection)中，最後一個註冊的介面協議就會從容器中獲得介面。</p>
<h3 id="ASP-NET-Core-Startup"><a href="#ASP-NET-Core-Startup" class="headerlink" title="ASP.NET Core Startup"></a>ASP.NET Core Startup</h3><p>ASP.NET Core 提供內建服務容器 IServiceProvider。服務會在應用程式的 Startup.ConfigureServices 方法中註冊。</p>
<p>ASP.NET Core 的應用程式啟動使用 Startup 類別，其依慣例命名為 Startup。 Startup 類別可設定服務和應用程式的要求管線。</p>
<p>Startup 類別選擇性地包含 ConfigureServices 方法來設定應用程式的服務，服務透過依賴項注入 (DI)，在應用中使用 ConfigureServices 來註冊和使用。 </p>
<p>另外 Startup 類也包含 Configure 方法來建立應用程式的要求處理管線(Pipeline，Middlewares)。</p>
<p>瞭解了依賴注入 (Dependency Injection) 與依賴注入容器，應該可以更理解王智民老師的教育訓練課程中的有關 MVC 控制器內依賴注入。</p>
<p>祝，Coding 快樂!</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://1184yang.github.io/2020/04/24/Dotnet-core-DI/" data-id="ckcpzj95d000580vz12x4eu9d" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Train0416-with-C" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/04/17/Train0416-with-C/" class="article-date">
  <time datetime="2020-04-17T00:28:32.000Z" itemprop="datePublished">2020-04-17</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/C/">C#</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/04/17/Train0416-with-C/">C# 教育訓練 using Visual Studio Code</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>終於開始今年的技術性教育訓練了，有了新的學習標的總是讓我很興奮，有幸王智民老師有了精闢的講解，收穫良多。</p>
<p>我是老派的軟體工程師，也因為工作環境，文書編輯器一直是必備的工具，有時需要用到 GUI 介面的開發工具光安裝就讓人頭痛。 Oracle SQL Developer 如非必要總不會打開，至今 Oracle SQL Developer 對我還是很陌生，SQL Plus 是我的最愛。</p>
<p>安裝一個 Visual Studio 需要 20-50 GB 的可用空間，喔! 也許有人的硬碟就爆掉了，在 Windows 環境 C 硬碟千萬要留大一些，如果可以選擇就不要將軟體工具裝在 C 槽。這裡是使用 Visual Studio Code 開發 .NET 專案的簡介，希望能對各位有些幫助。</p>
<p>這裡就用 Visual Studio Code 將王智民老師第一堂課的程式碼走一次，但我使用的是較新的版本 .NET Core 3.1。因為 .NET Core 2.2 已於去年就 EOL 了。</p>
<h2 id="安裝"><a href="#安裝" class="headerlink" title="安裝"></a>安裝</h2><p>首先要安裝  <a href="https://code.visualstudio.com/" target="_blank" rel="noopener">Visual Studio Code</a> 與 <a href="https://dotnet.microsoft.com/download" target="_blank" rel="noopener">.Net Code SDK</a>。 記得要安裝 SDK 版。</p>
<p>這裡有一些快速指引 Visual Studio Code <a href="https://code.visualstudio.com/docs/languages/csharp" target="_blank" rel="noopener">Working with C#</a>，最好也把 VS Code 的兩個 C# Extensions 安裝起來: </p>
<img src="/2020/04/17/Train0416-with-C/train-080914.png" title="MyWeb 專案目錄">

<p>安裝完成後，開啟 VSCode，打開一個終端視窗或命令提示字元輸入: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dotnet --version</span><br></pre></td></tr></table></figure>

<p>如果一卻正常會返回 .NET Code 的版本訊息，那我們就可以開始了。</p>
<p>往後我們常會用到 donnet 指令，例如建立解決方案、建立專案、安裝 NuGet Packages、或顯示本機的一些 .NET 設定例如:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dotnet nuget locals all --list</span><br></pre></td></tr></table></figure>

<p>可以顯示本機安裝 NuGet Packages 的目錄。</p>
<h4 id="解決方案與專案設定"><a href="#解決方案與專案設定" class="headerlink" title="解決方案與專案設定"></a>解決方案與專案設定</h4><p>我們先在電腦裡面用一個空的資料夾建立 TrainSample 的 .NET 解決方案。然後使用 VSCode 打開解決方案資料夾 TrainSample，開啟一個終端視窗，我們需要用 dotnet 初始化解決方案，確定位於 TrainSample 目錄中:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dotnet new sln</span><br></pre></td></tr></table></figure>

<p>範本 “Solution File” 建立成功後，目錄下會產生一個 TrainSample.sln 檔案。</p>
<p>接著我們要在這個解決方案目錄下產生專案 MyWeb。你可以使用 <strong>dotnet new –help</strong> 查詢 SDK 所提供的各類專案的基本初始範本，這裡我們會建立一個空的 web 基本範本: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dotnet new web --name MyWeb </span><br></pre></td></tr></table></figure>

<p>這會在解決方案目錄下產生 MyWeb 專案目錄，接下來我們就要切換到 MyWeb 目錄，開始我們的程式旅途了。</p>
<img src="/2020/04/17/Train0416-with-C/train-095625.png" title="MyWeb 專案目錄">

<p>這是 MyWeb 專案目錄初始的目錄架構，包含專案的設定檔 MyWeb.csproj 及基本範例的程式碼，就從這裡開始。首先啟動專案看看這個範例的結果。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dotnet run </span><br></pre></td></tr></table></figure>

<p>啟動後有一些訊息</p>
<img src="/2020/04/17/Train0416-with-C/train-095626.png" title="MyWeb 專案目錄">

<p>打開瀏覽器看看結果:</p>
<img src="/2020/04/17/Train0416-with-C/train-095627.png" title="MyWeb 專案目錄">

<p>這裡當執行 <strong>dotnet run</strong> 時，其實 .NET 事先會執行 <strong>dotnet build</strong> 打包的工作，會產生編譯後的執行檔，可以在專案目錄的 bin 子目錄下發現 MyWeb.exe、MyWeb.dll 等檔案，你可以從檔案總管中直接打開 MyWeb.exe。</p>
<img src="/2020/04/17/Train0416-with-C/train-095630.png" title="MyWeb 專案目錄">

<p>首先看一下專案設定檔 MyWeb.csproj。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;Project Sdk=&quot;Microsoft.NET.Sdk.Web&quot;&gt;</span><br><span class="line"></span><br><span class="line">  &lt;PropertyGroup&gt;</span><br><span class="line">    &lt;TargetFramework&gt;netcoreapp3.1&lt;/TargetFramework&gt;</span><br><span class="line">  &lt;/PropertyGroup&gt;</span><br><span class="line"></span><br><span class="line">&lt;/Project&gt;</span><br></pre></td></tr></table></figure>

<p>目前就這樣，紀錄的東西不多，往後如果專案需要安裝 Packages，將會記錄在這裡。 第一堂課所需要 Packages 都已內含不用再另行安裝。</p>
<p>我們就先把未來會用到的 Oracle Package 安裝起來看看。我們可以到 <a href="https://www.nuget.org/" target="_blank" rel="noopener">NuGet Gallery</a> 尋找需要的 Packages。</p>
<img src="/2020/04/17/Train0416-with-C/train-095628.png" title="MyWeb 專案目錄">

<p>這裡需要 .NET Core 的版本。</p>
<img src="/2020/04/17/Train0416-with-C/train-095629.png" title="MyWeb 專案目錄">

<p>將指令複製到你的 VS Code 終端螢幕:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dotnet add package Oracle.ManagedDataAccess.Core --version 2.19.60</span><br></pre></td></tr></table></figure>

<p>安裝成功後將會更新 MyWeb.csproj，多了一個 ItemGroup。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;ItemGroup&gt;</span><br><span class="line">  &lt;PackageReference Include=&quot;Oracle.ManagedDataAccess.Core&quot; Version=&quot;2.19.60&quot; /&gt;</span><br><span class="line">&lt;/ItemGroup&gt;</span><br></pre></td></tr></table></figure>

<p>可以觀察一下安裝 Package 的訊息。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">  Writing C:\Users\76070049\AppData\Local\Temp\tmpBD4F.tmp</span><br><span class="line">info : 正在將套件 &apos;Oracle.ManagedDataAccess.Core&apos; 的 PackageReference 新增至專案 &apos;I:\C#\TrainSample\MyWeb\MyWeb.csproj&apos;。</span><br><span class="line">info : 正在還原 I:\C#\TrainSample\MyWeb\MyWeb.csproj 的封裝...</span><br><span class="line">info :   GET https://api.nuget.org/v3-flatcontainer/oracle.manageddataaccess.core/index.json</span><br><span class="line">info :   OK https://api.nuget.org/v3-flatcontainer/oracle.manageddataaccess.core/index.json 710 毫秒</span><br><span class="line">info :   GET https://api.nuget.org/v3-flatcontainer/oracle.manageddataaccess.core/2.19.60/oracle.manageddataaccess.core.2.19.60.nupkge.2.19.60.nupkg                                                                                                       .2.19.60.nupkg 720 毫秒</span><br><span class="line">info :   OK https://api.nuget.org/v3-flatcontainer/oracle.manageddataaccess.core/2.19.60/oracle.manageddataaccess.core.2.19.60.nupkg 720 毫秒</span><br><span class="line">info : 正在安裝 Oracle.ManagedDataAccess.Core 2.19.60。                                                               \MyWeb.csproj&apos;。</span><br><span class="line">info : 套件 &apos;Oracle.ManagedDataAccess.Core&apos; 與專案 &apos;I:\C#\TrainSample\MyWeb\MyWeb.csproj&apos; 中的所有架構相容。</span><br><span class="line">info : 已將套件 &apos;Oracle.ManagedDataAccess.Core&apos; 版本 &apos;2.19.60&apos; 的 PackageReference 新增至檔案 &apos;I:\C#\TrainSample\MyWeb\MyWeb.csproj&apos;。</span><br><span class="line">info : 正在認可還原...</span><br><span class="line">info : 正在將資產檔案寫入磁碟。路徑: I:\C#\TrainSample\MyWeb\obj\project.assets.json</span><br><span class="line">log  : I:\C#\TrainSample\MyWeb\MyWeb.csproj 的還原於 3.98 sec 完成。</span><br></pre></td></tr></table></figure>

<p>注意這裡會直接上網下載安裝，如果你無法安裝，有可能是你的電腦被禁止上網，注意最近<strong>資訊部的 SSL 政策</strong>。</p>
<p>有沒有發覺 Packages 的原始碼並沒有安裝在專案目錄中，這與 Node.js 不同，你可以用先前提到的 <strong>dotnet nuget locals all –list</strong> 查詢 NuGet Packages 的目錄。</p>
<h3 id="開始"><a href="#開始" class="headerlink" title="開始"></a>開始</h3><p>當我們下了 <strong>dotnet run</strong>，.NET 會搜尋有 Main 方法的程式碼，這就是專案的入口點，慣例都會是 Program.cs。修改之前你可以看一下，比較特別的是使用泛型 <em>webBuilder.UseStartup&lt;Startup&gt;( );</em> 來啟動 Web Server。</p>
<figure class="highlight csharp"><figcaption><span>Program.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Hosting;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Extensions.Configuration;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Extensions.Hosting;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Extensions.Logging;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">MyWeb</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="keyword">string</span>[] args</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            MyOutput(<span class="string">"(Main) Application start..."</span>);</span><br><span class="line">            </span><br><span class="line">            CreateHostBuilder(args).Build().Run();</span><br><span class="line">            </span><br><span class="line">            MyOutput(<span class="string">"(Main) Application end..."</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IHostBuilder <span class="title">CreateHostBuilder</span>(<span class="params"><span class="keyword">string</span>[] args</span>)</span> =&gt;</span><br><span class="line">            Host.CreateDefaultBuilder(args)</span><br><span class="line">                .ConfigureWebHostDefaults(webBuilder =&gt;</span><br><span class="line">                &#123;</span><br><span class="line">                    webBuilder.UseStartup&lt;Startup&gt;();</span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">MyOutput</span>(<span class="params"><span class="keyword">string</span> message</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">$"[<span class="subst">&#123;DateTime.Now.ToString(<span class="string">"yyyy/MM/dd HH:mm:ss"</span>)&#125;</span>] <span class="subst">&#123;message&#125;</span>"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>第 30 行加入 MyOutput 靜態方法，這裡沒有使用 Debug 模組，在 VS Code 中開啟 Debug output 比較麻煩，這裡直接使用系統的終端螢幕顯示。</li>
<li>第 27 行使用泛型啟動 Web Server 比較特殊，也因此可以用同一個方法啟動不同類型的 Web Server。也可以直接使用方法鏈接改變預設的的 Web Server 與監聽的 Port。</li>
</ul>
<figure class="highlight csharp"><figcaption><span>Program.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IHostBuilder <span class="title">CreateHostBuilder</span>(<span class="params"><span class="keyword">string</span>[] args</span>)</span> =&gt;</span><br><span class="line">    Host.CreateDefaultBuilder(args)</span><br><span class="line">        .ConfigureWebHostDefaults(webBuilder =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            webBuilder</span><br><span class="line">              .UseStartup&lt;Startup&gt;()</span><br><span class="line">              .UseKestrel()</span><br><span class="line">              .UseUrls(<span class="string">"http://localhost:3000"</span>);</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure>

<ul>
<li>第 7 行可以不要，預設值本來就是 Kestrel。</li>
<li>第 8 行直接改變監聽的 Port。</li>
</ul>
<p>這裡直接使用泛型啟動 Startup 類別，現在來看看 Startup.cs。</p>
<figure class="highlight csharp"><figcaption><span>Startup.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Builder;</span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Hosting;</span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Http;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Extensions.DependencyInjection;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Extensions.Hosting;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">MyWeb</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Startup</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// This method gets called by the runtime. Use this method to add services to the container.</span></span><br><span class="line">        <span class="comment">// For more information on how to configure your application, visit https://go.microsoft.com/fwlink/?LinkID=398940</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ConfigureServices</span>(<span class="params">IServiceCollection services</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// This method gets called by the runtime. Use this method to configure the HTTP request pipeline.</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Configure</span>(<span class="params">IApplicationBuilder app, IWebHostEnvironment env</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span> (env.IsDevelopment())</span><br><span class="line">            &#123;</span><br><span class="line">                app.UseDeveloperExceptionPage();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            app.UseRouting();</span><br><span class="line"></span><br><span class="line">            app.UseEndpoints(endpoints =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                endpoints.MapGet(<span class="string">"/"</span>, <span class="keyword">async</span> context =&gt;</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">await</span> context.Response.WriteAsync(<span class="string">"Hello World!"</span>);</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>這裡使用的方法與上課的程式碼有些不同，但觀念是一樣的。</p>
<ul>
<li>第 22 行使用了不同的 IWebHostEnvironment Interface，但用法一樣。</li>
<li>第 31 行用 app.UseEndPoints 定義 HTTP Endpoints，可以直接在此加入另外一個端點。</li>
</ul>
<figure class="highlight csharp"><figcaption><span>Startup.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">app.UseEndpoints(endpoints =&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        endpoints.MapGet(<span class="string">"/"</span>, <span class="keyword">async</span> context =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">await</span> context.Response.WriteAsync(<span class="string">"Hello World!"</span>);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        endpoints.MapGet(<span class="string">"/tainan"</span>, <span class="keyword">async</span> context =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">await</span> context.Response.WriteAsync(<span class="string">"Hello Tainan! 哈囉，台南!"</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>

<img src="/2020/04/17/Train0416-with-C/train-095631.png" title="MyWeb 專案目錄">

<p>這是最基本的端點設定，稍後再來看 Middlewares。現在則來看看 Application LifeTime 流程。以下是加入 Application Lifttime 的程式碼，試著自己 Coding，不要用複製/貼上，否則你不會發現魔鬼。</p>
<figure class="highlight csharp"><figcaption><span>Startup.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Threading;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Builder;</span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Hosting;</span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Http;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Extensions.DependencyInjection;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Extensions.Hosting;</span><br><span class="line"><span class="keyword">using</span> IHostApplicationLifetime = Microsoft.Extensions.Hosting.IHostApplicationLifetime;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">MyWeb</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Startup</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Startup</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">            Program.MyOutput(<span class="string">"Startup Contructor called."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// This method gets called by the runtime. Use this method to add services to the container.</span></span><br><span class="line">        <span class="comment">// For more information on how to configure your application, visit https://go.microsoft.com/fwlink/?LinkID=398940</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ConfigureServices</span>(<span class="params">IServiceCollection services</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Program.MyOutput(<span class="string">"Startup.ConfigureServices called."</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// This method gets called by the runtime. Use this method to configure the HTTP request pipeline.</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Configure</span>(<span class="params">IApplicationBuilder app, IWebHostEnvironment env, IHostApplicationLifetime appLifetime</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span> (env.IsDevelopment())</span><br><span class="line">            &#123;</span><br><span class="line">                app.UseDeveloperExceptionPage();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            appLifetime.ApplicationStarted.Register(() =&gt;</span><br><span class="line">            &#123;               </span><br><span class="line">                Program.MyOutput(<span class="string">"ApplicationLifetime - Started."</span>);</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            appLifetime.ApplicationStopping.Register(() =&gt;</span><br><span class="line">            &#123;   </span><br><span class="line">                Program.MyOutput(<span class="string">"ApplicationLifetime - Stopping."</span>);</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            appLifetime.ApplicationStopped.Register(() =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                Thread.Sleep(<span class="number">5</span> * <span class="number">1000</span>);   </span><br><span class="line">                Program.MyOutput(<span class="string">"ApplicationLifetime - Stopped."</span>);</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            app.UseRouting();</span><br><span class="line"></span><br><span class="line">            app.UseEndpoints(endpoints =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                endpoints.MapGet(<span class="string">"/"</span>, <span class="keyword">async</span> context =&gt;</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">await</span> context.Response.WriteAsync(<span class="string">"Hello World!"</span>);</span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line">                endpoints.MapGet(<span class="string">"/tainan"</span>, <span class="keyword">async</span> context =&gt;</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">await</span> context.Response.WriteAsync(<span class="string">"Hello Tainan! 哈囉，台南!"</span>);</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> thread = <span class="keyword">new</span> Thread(<span class="keyword">new</span> ThreadStart(() =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                Thread.Sleep(<span class="number">5</span> * <span class="number">1000</span>);</span><br><span class="line">                Program.MyOutput(<span class="string">"Trigger stop WebHost."</span>);</span><br><span class="line">                appLifetime.StopApplication();</span><br><span class="line">            &#125;));</span><br><span class="line">            </span><br><span class="line">            thread.Start();</span><br><span class="line"></span><br><span class="line">            Program.MyOutput(<span class="string">"Startup Configure - Called."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>第 4 行加入 System.Threading 命名空間，因為第 66 行會用到 Thread 類別。</li>
<li>第 11 行加入了一個別名(Alias) IHostApplicationLifetime 因舊的 IApplicationLifetime 已遭廢棄，這裡又同時有兩個 Package 都含有 IHostApplicationLifetime 介面，這裡用一個 Alias 直接指名。IHostApplicationLifetime 會用在第 28 行。 </li>
<li>第 28 行加入新的 IWebHostEnvironment 與 Microsoft.Extensions.Hosting.IHostApplicationLifetime 介面，舊的 IHostingEnvironment 與 IApplicationLifetime 已遭廢棄。</li>
<li>第 35 ~ 49 行、66 ~ 73 行沒有不同。</li>
</ul>
<p>執行結果應該會是:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[2020/04/17 15:19:54] (Main) Application start...</span><br><span class="line">[2020/04/17 15:19:54] Startup Contructor called.</span><br><span class="line">[2020/04/17 15:19:54] Startup.ConfigureServices called.</span><br><span class="line">[2020/04/17 15:19:54] Startup Configure - Called</span><br><span class="line">[2020/04/17 15:19:54] ApplicationLifetime - Started</span><br><span class="line">info: Microsoft.Hosting.Lifetime[0]</span><br><span class="line">      Now listening on: http://localhost:3000</span><br><span class="line">info: Microsoft.Hosting.Lifetime[0]</span><br><span class="line">      Application started. Press Ctrl+C to shut down.</span><br><span class="line">info: Microsoft.Hosting.Lifetime[0]</span><br><span class="line">      Hosting environment: Development</span><br><span class="line">info: Microsoft.Hosting.Lifetime[0]</span><br><span class="line">      Content root path: I:\C#\TrainSample\MyWeb</span><br><span class="line">[2020/04/17 15:19:59] Trigger stop WebHost</span><br><span class="line">[2020/04/17 15:19:59] ApplicationLifetime - Stopping</span><br><span class="line">info: Microsoft.Hosting.Lifetime[0]</span><br><span class="line">      Application is shutting down...</span><br><span class="line">[2020/04/17 15:20:04] ApplicationLifetime - Stopped</span><br><span class="line">[2020/04/17 15:20:04] (Main) Application end...</span><br></pre></td></tr></table></figure>

<p>接著就要來看 Middlewares，在這之前將 66 ~ 73 行程式碼加上註解，否則每次啟動後 5 秒鐘 Web Server 就自動下架了。</p>
<figure class="highlight csharp"><figcaption><span>Startup.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// var thread = new Thread(new ThreadStart(() =&gt;</span></span><br><span class="line"><span class="comment">// &#123;</span></span><br><span class="line"><span class="comment">//     Thread.Sleep(5 * 1000);</span></span><br><span class="line"><span class="comment">//     Program.MyOutput("Trigger stop WebHost.");</span></span><br><span class="line"><span class="comment">//     appLifetime.StopApplication();</span></span><br><span class="line"><span class="comment">// &#125;));</span></span><br><span class="line">        </span><br><span class="line"><span class="comment">// thread.Start();</span></span><br></pre></td></tr></table></figure>

<h3 id="Middlewares"><a href="#Middlewares" class="headerlink" title="Middlewares"></a>Middlewares</h3><p>使用 Middlewares 可讓程式碼更有彈性及模組化，可以使用 IApplicationBuilder 介面的 Use 方法註冊。首先我們使用 app.Use( ) 直接在 Startup.cs 中註冊一個 Middleware，但直接在 Startup.cs 中加入 Middleware 程式碼不是好的習慣，會讓程式碼太過龐大很難維護，稍後我們會將 Middlewares 模組化。但我們先來了解 Middlewares 的基本概念。</p>
<figure class="highlight csharp"><figcaption><span>Startup.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">app.Use(<span class="keyword">async</span> (context, next) =&gt; </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (context.Request.Path == <span class="string">"/tainan"</span>)</span><br><span class="line">          <span class="keyword">await</span> context.Response.WriteAsync(<span class="string">"ASP.Net Core Rocks! Tainan! \n"</span>);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">await</span> next();</span><br><span class="line">            <span class="keyword">await</span> context.Response.WriteAsync(<span class="string">"Powered by ASP.NET Core \n"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    app.UseRouting();</span><br><span class="line"></span><br><span class="line">    app.UseEndpoints(endpoints =&gt;</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>

<p>在第 50 行的地方插入這幾行程式碼註冊一個 Middleware，這裡插在 app.UseEndpoints 之前。使用 HttpContext.Request 物件的 Path 屬性取得 Url Path，如果是 /tainan 就回應一段字串，否則執行 next( ) 然後再返回一段字串。現在可以實際來看看它的結果。</p>
<img src="/2020/04/17/Train0416-with-C/train-080908.png" title="MyWeb Middlewares">

<p>先看左邊的圖示 Url Path 是 /tainan，它的結果如我們程式碼返回的字串，然後就結束了。後面的 endpoints.MapGet(“/tainan” …) 並沒有執行，因為我們沒有呼叫 next( ) 繼續往下執行。</p>
<p>右邊則是 / 根 Path，因為呼叫 next( )，所以先執行 endpoints.MapGet(“/“ …) 返回 “Hello World!”, 然後返回呼叫它的地方繼續往下執行，返回 “Powered by ASP.NET Core” 字串。</p>
<p>Middlewares 的位置順序很重要，我們將這段 Middleware 程式碼移到 app.UseEndpoints(endpoints =&gt; …) 後面，然後重新啟動。</p>
<figure class="highlight csharp"><figcaption><span>Startup.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">app.UseEndpoints(endpoints =&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        endpoints.MapGet(<span class="string">"/"</span>, <span class="keyword">async</span> context =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">await</span> context.Response.WriteAsync(<span class="string">"Hello World!"</span>);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        endpoints.MapGet(<span class="string">"/tainan"</span>, <span class="keyword">async</span> context =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">await</span> context.Response.WriteAsync(<span class="string">"Hello Tainan! 哈囉，台南!"</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    app.Use(<span class="keyword">async</span> (context, next) =&gt; </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (context.Request.Path == <span class="string">"/tainan"</span>)</span><br><span class="line">          <span class="keyword">await</span> context.Response.WriteAsync(<span class="string">"ASP.Net Core Rocks! Tainan! \n"</span>);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">await</span> next();</span><br><span class="line">            <span class="keyword">await</span> context.Response.WriteAsync(<span class="string">"Powered by ASP.NET Core \n"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>

<img src="/2020/04/17/Train0416-with-C/train-080909.png" title="MyWeb Middlewares">

<p>現在這個 Middleware 毫無作用。</p>
<p>將它回復到原地方。先前談過將所有 Middlewares 都放在同一個程式碼將很難維護，也很難重複利用，通常都必須模組化程式碼，就來加入一段模組化的 Middleware。</p>
<p>首先在專案目錄下建立子目錄 Middlewares，然後在 Middlewares 目錄按滑鼠右鍵，選擇 “New C# Class”， 你必須安裝 VS Code C# 與 C# Extensions 的 EXTENSIONS。</p>
<img src="/2020/04/17/Train0416-with-C/train-080910.png" title="MyWeb Middlewares">

<p>這兩個 Extensions 是在安裝 .NET 時就會建議的套件。</p>
<img src="/2020/04/17/Train0416-with-C/train-080911.png" title="MyWeb Middlewares">

<p>以下是新的 FirstMiddleware 型態。</p>
<figure class="highlight csharp"><figcaption><span>FirstMiddleware.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Http;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">MyWeb.Middlewares</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">FirstMiddleware</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">private</span> <span class="keyword">readonly</span> RequestDelegate _next; </span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="title">FirstMiddleware</span>(<span class="params">RequestDelegate next</span>) </span></span><br><span class="line"><span class="function"></span>      &#123;</span><br><span class="line">        _next = next;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">Invoke</span>(<span class="params">HttpContext context</span>)</span></span><br><span class="line"><span class="function"></span>      &#123;</span><br><span class="line">        <span class="keyword">await</span> context.Response.WriteAsync(<span class="string">$"<span class="subst">&#123;<span class="keyword">nameof</span>(FirstMiddleware)&#125;</span> IN. \n"</span>);</span><br><span class="line">        <span class="keyword">await</span> _next(context);</span><br><span class="line">        <span class="keyword">await</span> context.Response.WriteAsync(<span class="string">$"<span class="subst">&#123;<span class="keyword">nameof</span>(FirstMiddleware)&#125;</span> OUT. \n"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>程式碼與上課的教材沒甚麼差異。現在可以將它加入 Startup.cs。</p>
<figure class="highlight csharp"><figcaption><span>FirstMiddleware.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">using</span> MyWeb.Middlewares;</span><br><span class="line">...</span><br><span class="line">            app.UseMiddleware&lt;FirstMiddleware&gt;();</span><br><span class="line"></span><br><span class="line">            app.Use(<span class="keyword">async</span> (context, next) =&gt; </span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (context.Request.Path == <span class="string">"/tainan"</span>)</span><br><span class="line">                  <span class="keyword">await</span> context.Response.WriteAsync(<span class="string">"ASP.Net Core Rocks! Tainan! \n"</span>);</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">await</span> next();</span><br><span class="line">                    <span class="keyword">await</span> context.Response.WriteAsync(<span class="string">"Powered by ASP.NET Core \n"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>第 4 行使用 app.UseMiddleware( ) 泛型加入 FirstMiddleware，注意它的位置，將它放在先前 Middleware 之前。</p>
<img src="/2020/04/17/Train0416-with-C/train-080912.png" title="MyWeb Middlewares">

<p>也可以用 C# 擴充方法將 FirstMiddleware 包裝成靜態方法。新建一個子目錄來擺這些  Extensions，然後在這個目錄下建一個新的類別 CustomMiddlewareExtension。</p>
<figure class="highlight csharp"><figcaption><span>CustomMiddlewareExtension.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Builder;</span><br><span class="line"><span class="keyword">using</span> MyWeb.Middlewares;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">MyWeb.Extensions</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">CustomMiddlewareExtension</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IApplicationBuilder <span class="title">UseFirstMiddleware</span>(<span class="params"><span class="keyword">this</span> IApplicationBuilder builder</span>)</span></span><br><span class="line"><span class="function"></span>      &#123;</span><br><span class="line">        <span class="keyword">return</span> builder.UseMiddleware&lt;FirstMiddleware&gt;();</span><br><span class="line">      &#125;        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>現在修改 Startup.cs 改用 CustomMiddlewareExtension。</p>
<figure class="highlight csharp"><figcaption><span>CustomMiddlewareExtension.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="comment">// using MyWeb.Middlewares;</span></span><br><span class="line"><span class="keyword">using</span> MyWeb.Extensions;</span><br><span class="line">...</span><br><span class="line">            <span class="comment">// app.UseMiddleware&lt;FirstMiddleware&gt;();</span></span><br><span class="line">            app.UseFirstMiddleware();</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>這將會有相同的結果，最後的 VS Code 專案目錄結構如下，注意對照一下 namespace 的習慣命名，你也可以將所有的 namespace 都改為與 Program.cs 一樣的 MyWeb，這樣你就不用使用 using import MyWeb.Middlewares namespace，但這似乎不是好的模組命名架構。</p>
<img src="/2020/04/17/Train0416-with-C/train-080913.png" title="MyWeb Middlewares">

<p>祝 有個愉快的 Coding 與學習!</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://1184yang.github.io/2020/04/17/Train0416-with-C/" data-id="ckcpzj96o001s80vz5uyiw6vk" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-GraphQL-API-9" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/12/17/GraphQL-API-9/" class="article-date">
  <time datetime="2019-12-17T01:14:16.000Z" itemprop="datePublished">2019-12-17</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/GraphQL/">GraphQL</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/12/17/GraphQL-API-9/">建立 GraphQL API (9)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="Cache-伺服端快取"><a href="#Cache-伺服端快取" class="headerlink" title="Cache 伺服端快取"></a>Cache 伺服端快取</h3><p>在高負載的應用程式中，快取經常扮演著關鍵性的角色，而且幾乎在網路上四處可見。從網頁、圖片與樣式表等靜態資源，以及資料庫查詢結果這類純粹的資料，都經常會涉及到快取的使用。</p>
<p>快取模式在伺服器端，可以緩解硬體 I/O 問題，在客戶端則可緩解網路 I/O 問題。我們在 <a href="/useful/nodejs.pdf" target="_blank">Node.js 教育訓練</a>中學到的伺服器端的快取機制，就可以拿來應用。</p>
<p>首先我們來看看會產生效能問題的地方，我們看下面這個 GraphQL query:</p>
<figure class="highlight"><figcaption><span>GraphQL query listEmployees</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">query listEmployees &#123;</span><br><span class="line">  totalEmployees</span><br><span class="line">  allEmployees &#123;</span><br><span class="line">    empno</span><br><span class="line">    ename</span><br><span class="line">    hiredate</span><br><span class="line">    income</span><br><span class="line">    department &#123;</span><br><span class="line">      dname</span><br><span class="line">      loc</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在這個 GraphQL query listEmployees 中的 allEmployees 你會發覺問題應會出現在 department 的邊(edge)連結上，看一下他的解析函式，我們在第 7 行它從資料庫實際返回資料的地方加入一個 console.log 來偵測它的行為:</p>
<figure class="highlight javascript"><figcaption><span>resolvers/employee.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">Employee: &#123;</span><br><span class="line">  department: <span class="function">(<span class="params">parent, args, &#123; orademo &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> orademo.department</span><br><span class="line">      .findByDeptno(parent.deptno)</span><br><span class="line">      .then(<span class="function"><span class="params">result</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(result.rows[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">return</span> result.rows[<span class="number">0</span>]</span><br><span class="line">      &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure>

<p>現在重新從客戶端的 GraphQL Playground 執行 listEmployees query，你可以從伺服器端的終端螢幕上看到:</p>
<figure class="highlight javascript"><figcaption><span>GraphQL Server console.log</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#123; <span class="attr">deptno</span>: <span class="number">10</span>, <span class="attr">dname</span>: <span class="string">'會計部'</span>, <span class="attr">loc</span>: <span class="string">'紐約'</span> &#125;</span><br><span class="line">&#123; <span class="attr">deptno</span>: <span class="number">30</span>, <span class="attr">dname</span>: <span class="string">'SALES'</span>, <span class="attr">loc</span>: <span class="string">'CHICAGO'</span> &#125;</span><br><span class="line">&#123; <span class="attr">deptno</span>: <span class="number">10</span>, <span class="attr">dname</span>: <span class="string">'會計部'</span>, <span class="attr">loc</span>: <span class="string">'紐約'</span> &#125;</span><br><span class="line">&#123; <span class="attr">deptno</span>: <span class="number">20</span>, <span class="attr">dname</span>: <span class="string">'RESEARCH'</span>, <span class="attr">loc</span>: <span class="string">'DALLAS'</span> &#125;</span><br><span class="line">&#123; <span class="attr">deptno</span>: <span class="number">20</span>, <span class="attr">dname</span>: <span class="string">'RESEARCH'</span>, <span class="attr">loc</span>: <span class="string">'DALLAS'</span> &#125;</span><br><span class="line">&#123; <span class="attr">deptno</span>: <span class="number">20</span>, <span class="attr">dname</span>: <span class="string">'RESEARCH'</span>, <span class="attr">loc</span>: <span class="string">'DALLAS'</span> &#125;</span><br><span class="line">&#123; <span class="attr">deptno</span>: <span class="number">30</span>, <span class="attr">dname</span>: <span class="string">'SALES'</span>, <span class="attr">loc</span>: <span class="string">'CHICAGO'</span> &#125;</span><br><span class="line">&#123; <span class="attr">deptno</span>: <span class="number">20</span>, <span class="attr">dname</span>: <span class="string">'RESEARCH'</span>, <span class="attr">loc</span>: <span class="string">'DALLAS'</span> &#125;</span><br><span class="line">&#123; <span class="attr">deptno</span>: <span class="number">30</span>, <span class="attr">dname</span>: <span class="string">'SALES'</span>, <span class="attr">loc</span>: <span class="string">'CHICAGO'</span> &#125;</span><br><span class="line">&#123; <span class="attr">deptno</span>: <span class="number">40</span>, <span class="attr">dname</span>: <span class="string">'OPERATIONS'</span>, <span class="attr">loc</span>: <span class="string">'BOSTON'</span> &#125;</span><br><span class="line">&#123; <span class="attr">deptno</span>: <span class="number">30</span>, <span class="attr">dname</span>: <span class="string">'SALES'</span>, <span class="attr">loc</span>: <span class="string">'CHICAGO'</span> &#125;</span><br><span class="line">&#123; <span class="attr">deptno</span>: <span class="number">20</span>, <span class="attr">dname</span>: <span class="string">'RESEARCH'</span>, <span class="attr">loc</span>: <span class="string">'DALLAS'</span> &#125;</span><br><span class="line">&#123; <span class="attr">deptno</span>: <span class="number">10</span>, <span class="attr">dname</span>: <span class="string">'會計部'</span>, <span class="attr">loc</span>: <span class="string">'紐約'</span> &#125;</span><br><span class="line">&#123; <span class="attr">deptno</span>: <span class="number">30</span>, <span class="attr">dname</span>: <span class="string">'SALES'</span>, <span class="attr">loc</span>: <span class="string">'CHICAGO'</span> &#125;</span><br><span class="line">&#123; <span class="attr">deptno</span>: <span class="number">70</span>, <span class="attr">dname</span>: <span class="string">'資訊部'</span>, <span class="attr">loc</span>: <span class="string">'永康 B4'</span> &#125;</span><br><span class="line">&#123; <span class="attr">deptno</span>: <span class="number">70</span>, <span class="attr">dname</span>: <span class="string">'資訊部'</span>, <span class="attr">loc</span>: <span class="string">'永康 B4'</span> &#125;</span><br><span class="line">&#123; <span class="attr">deptno</span>: <span class="number">40</span>, <span class="attr">dname</span>: <span class="string">'OPERATIONS'</span>, <span class="attr">loc</span>: <span class="string">'BOSTON'</span> &#125;</span><br><span class="line">&#123; <span class="attr">deptno</span>: <span class="number">70</span>, <span class="attr">dname</span>: <span class="string">'資訊部'</span>, <span class="attr">loc</span>: <span class="string">'永康 B4'</span> &#125;</span><br><span class="line">&#123; <span class="attr">deptno</span>: <span class="number">10</span>, <span class="attr">dname</span>: <span class="string">'會計部'</span>, <span class="attr">loc</span>: <span class="string">'紐約'</span> &#125;</span><br></pre></td></tr></table></figure>

<p>這裡有 19 筆員工，因此對資料庫送出了 19 次的要求，資料庫執行了 19 次的查詢，但我們其實只有 5 個部門，所以有 14 次的資料庫讀取操作是重複的，如果你有幾萬個員工，那會怎麼樣? 這是利用快取模式最好的地方，讓我們將快取機制加進來。</p>
<p>首先將 <a href="/useful/nodejs.pdf" target="_blank">Node.js 教育訓練文件</a>拿出來複習一下，這裡會用到文件第 98 頁的 Promise 快取模式。為了保留原始的程式碼，我們產生一個新的 resolvers/employee-cache.js 程式檔，把快取機制加進來。</p>
<p>在非同步控制流程模式裡，承諾(Promise)能夠大幅簡化非同步程式碼，不過在處理批次及快取處理時，它也能夠提供不錯的助益。若回想一下，承諾有兩項特性能夠讓我們加以應用</p>
<blockquote>
<ul>
<li>多個 then( ) 監聽器可附加至相同的承諾。</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>then( ) 監聽器保證只會被呼叫一次，並且即便是在承諾已解析(resolved)後才附加，也依然可以運作。不僅如此，then() 也保證一定以非同步的方式被呼叫。</li>
</ul>
</blockquote>
<p>前述的第一項特性便是在批次處理請求時所需要的，而第二項特性即表示承諾已經是已解析值的快取，也就能夠自然以一致的非同步方式，回傳快取值。基於以上設想，這就表示以承諾來實現批次及快取處理，是相當簡單明瞭的。</p>
<figure class="highlight javascript"><figcaption><span>resolvers/employee-cache.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> cache = &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  Query: &#123;</span><br><span class="line">    totalEmployees: <span class="function">(<span class="params">parent, args, &#123; orademo &#125;</span>) =&gt;</span></span><br><span class="line">      orademo.employee.findAll().then(<span class="function"><span class="params">result</span> =&gt;</span> result.rows.length),</span><br><span class="line">    allEmployees: <span class="function">(<span class="params">parent, args, &#123; orademo &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> orademo.employee.findAll()</span><br><span class="line">        .then(<span class="function"><span class="params">result</span> =&gt;</span> result.rows );</span><br><span class="line">    &#125;  </span><br><span class="line">  &#125;, </span><br><span class="line">  Employee: &#123;</span><br><span class="line">    department: <span class="function">(<span class="params">parent, args, &#123; orademo &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (cache[parent.deptno]) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">`cache hit =&gt; <span class="subst">$&#123;parent.deptno&#125;</span>:<span class="subst">$&#123;parent.empno&#125;</span>`</span>);</span><br><span class="line">        <span class="keyword">return</span> cache[parent.deptno];</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      cache[parent.deptno] = orademo.department</span><br><span class="line">        .findByDeptno(parent.deptno)</span><br><span class="line">        .then(<span class="function"><span class="params">result</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="built_in">console</span>.log(<span class="string">`<span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(result.rows[<span class="number">0</span>])&#125;</span> =&gt; <span class="subst">$&#123;parent.deptno&#125;</span>:<span class="subst">$&#123;parent.empno&#125;</span>`</span>);</span><br><span class="line">          setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123; <span class="keyword">delete</span> cache[parent.deptno] &#125;, <span class="number">30</span> * <span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">          <span class="keyword">return</span> result.rows[<span class="number">0</span>]</span><br><span class="line">        &#125;).catch (<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">delete</span> cache[parent.deptno];</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> cache[parent.deptno];</span><br><span class="line">    &#125;,</span><br><span class="line">    income: <span class="function">(<span class="params">parent</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">let</span> sal = !<span class="built_in">isNaN</span>(<span class="built_in">parseFloat</span>(parent.sal)) ? <span class="built_in">parseFloat</span>(parent.sal) : <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">let</span> comm = !<span class="built_in">isNaN</span>(<span class="built_in">parseFloat</span>(parent.comm)) ? <span class="built_in">parseFloat</span>(parent.comm) : <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">return</span> sal + comm;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>在這個例子中我們將使用記憶體存儲快取，第一行我們使用一個物件 cache 當成快取。</p>
</li>
<li><p>我們在第 13 行 department 解析函式中我們加入了快取模式。第 19 行我們對相同部門的資料庫查詢(使用 Promise)存入快取中，這在第 14 行中檢查這個相同部門的 Promise 快取是否已存在，如果存在，則可直接使用這個相同的 Promise，不用再對資料庫提出相同的要求。</p>
</li>
<li><p>第 23 行加入了一個到期時間機制，30 秒後會自動刪除快取。</p>
</li>
</ul>
<p>在這裡，當承諾解析時，設定快取清除時間為 30 秒，並回傳資料庫返回的結果 ，將這個結果傳遞給附加在承諾上的其它 then( ) 監聽器。</p>
<p>然後要修改 resolvers/index.js 改用 employee-cache.js 解析函式。</p>
<figure class="highlight javascript"><figcaption><span>resolvers/index.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">const</span> employeeResolvers = <span class="built_in">require</span>(<span class="string">'./employee-cache'</span>);</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>重新啟動 GraphQL 伺服器後，重新執行 query listEmployees，伺服器端的終端螢幕將可以看到快取機制的運作。</p>
<figure class="highlight"><figcaption><span>query allEmployees GraphQL server console</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">cache hit =&gt; 10:7782</span><br><span class="line">cache hit =&gt; 20:7788</span><br><span class="line">cache hit =&gt; 20:7902</span><br><span class="line">cache hit =&gt; 20:7369</span><br><span class="line">cache hit =&gt; 30:7499</span><br><span class="line">cache hit =&gt; 30:7654</span><br><span class="line">cache hit =&gt; 30:7844</span><br><span class="line">cache hit =&gt; 20:7876</span><br><span class="line">cache hit =&gt; 30:7900</span><br><span class="line">cache hit =&gt; 10:7934</span><br><span class="line">cache hit =&gt; 70:7607</span><br><span class="line">cache hit =&gt; 70:7609</span><br><span class="line">cache hit =&gt; 40:9011</span><br><span class="line">cache hit =&gt; 10:8907</span><br><span class="line">&#123; deptno: 10, dname: '會計部', loc: '紐約' &#125;</span><br><span class="line">&#123; deptno: 30, dname: 'SALES', loc: 'CHICAGO' &#125;</span><br><span class="line">&#123; deptno: 20, dname: 'RESEARCH', loc: 'DALLAS' &#125;</span><br><span class="line">&#123; deptno: 40, dname: 'OPERATIONS', loc: 'BOSTON' &#125;</span><br><span class="line">&#123; deptno: 70, dname: '資訊部', loc: '永康 B4' &#125;</span><br></pre></td></tr></table></figure>

<p>這裡我們只對資料庫讀取了 5 次，其他則來自快取。</p>
<p>這種快取方便又優雅，但是它是使用記憶體來儲存快取，與 GraphQL 伺服器共用約 1.5G 的記憶體，如果你的快取非常大，就不適合了。要想辦法將快取移出伺服器，最佳的選擇就是 <a href="https://redis.io/" target="_blank" rel="noopener">Redis</a>。</p>
<h4 id="使用-Redis-實作快取模式"><a href="#使用-Redis-實作快取模式" class="headerlink" title="使用 Redis 實作快取模式"></a>使用 Redis 實作快取模式</h4><p>使用 Redis 實作快取可以解決記憶體的問題，也可以跨不同的 GraphQL 伺服器共享快取機制。最好在專案開始就要考慮效能的問題，將快取模式加進來。當然最好的選擇就是 Redis。</p>
<p>我們要新增一個解析函式檔來實作 Redis Cache 模式，resolvers/employee-redis.js。但在這之前我們要先做一個 Redis 操作的抽象層。</p>
<p>首先要安裝 node_redis 套件，這是一個 Redis 客戶端套件:</p>
<figure class="highlight shell"><figcaption><span>redis install</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install redis --save</span><br></pre></td></tr></table></figure>

<p>在 models 子目錄下新建程式檔 models/redisCache.js:</p>
<figure class="highlight javascript"><figcaption><span>models/redisCache.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> redis = <span class="built_in">require</span>(<span class="string">"redis"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> client = redis.createClient(&#123;</span><br><span class="line">  host: <span class="string">"10.11.25.137"</span>,</span><br><span class="line">  port: <span class="number">6379</span>,</span><br><span class="line">  password: <span class="string">"iscat"</span>,</span><br><span class="line">  db: <span class="number">0</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> cachePrefix = <span class="string">"graphql:orademo:cache:"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">RedisCache</span>(<span class="params">cacheName, expire = <span class="number">30</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>._cache = cachePrefix + cacheName + <span class="string">':'</span>;</span><br><span class="line">  <span class="keyword">this</span>._expire = expire;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">RedisCache.prototype.set = <span class="function"><span class="keyword">function</span>(<span class="params">item, value</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> _this = <span class="keyword">this</span>;</span><br><span class="line">    client.set(_this._cache + item, value, <span class="string">"EX"</span>, _this._expire, (err, result ) =&gt; &#123;</span><br><span class="line">      <span class="keyword">if</span> (err) <span class="keyword">return</span> reject(err);</span><br><span class="line">       </span><br><span class="line">      <span class="keyword">return</span> resolve(result);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">RedisCache.prototype.get = <span class="function"><span class="keyword">function</span>(<span class="params">item</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> _this = <span class="keyword">this</span>;</span><br><span class="line">    client.get(_this._cache + item, (err, result) =&gt; &#123;</span><br><span class="line">      <span class="keyword">if</span> (err) <span class="keyword">return</span> reject(err);</span><br><span class="line">  </span><br><span class="line">      <span class="keyword">return</span> resolve(result);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">RedisCache.prototype.quit = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  client.quit();</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = RedisCache;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>第 10 行將會是 Redis key 的一部分，稍後我們會看實際存儲到 Redis 時 key 樣子。在 Redis 生態圈習慣上使用冒號 ( : ) 來分隔名稱的不同部分，以此來構建命名空間 (namespace)。</p>
</li>
<li><p>第 12 行 RedisCache 是一個建構式，expire 引數可以訂到期时间，預設值是 30 秒。30 秒一到 Redis 將自動清除資料。</p>
</li>
<li><p>第 17 行 set 方法會將資料存入 Redis。如果原來的鍵(key)已存在，則會將舊資料(value)蓋掉。存入時可同時設定到期時間。</p>
</li>
<li><p>第 28 行 get 方法可以從 Redis 依鍵(key)取出資料，如果資料不存在(鍵不存在)會返回 null 值。</p>
</li>
</ul>
<p>接著我們將這個抽象層應用在 resolvers/employee-redis.js 中。</p>
<figure class="highlight javascript"><figcaption><span>resolvers/employee-redis.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> RedisCache = <span class="built_in">require</span>(<span class="string">"../models/redisCache"</span>);</span><br><span class="line"><span class="keyword">const</span> cache = <span class="keyword">new</span> RedisCache(<span class="string">'department'</span>, <span class="number">30</span>);</span><br><span class="line"><span class="keyword">const</span> queues = &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  Query: &#123;</span><br><span class="line">    totalEmployees: <span class="function">(<span class="params">parent, args, &#123; orademo &#125;</span>) =&gt;</span></span><br><span class="line">      orademo.employee.findAll().then(<span class="function"><span class="params">result</span> =&gt;</span> result.rows.length),</span><br><span class="line">    allEmployees: <span class="function">(<span class="params">parent, args, &#123; orademo &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> orademo.employee.findAll()</span><br><span class="line">        .then(<span class="function"><span class="params">result</span> =&gt;</span> result.rows );</span><br><span class="line">    &#125;  </span><br><span class="line">  &#125;, </span><br><span class="line">  Employee: &#123;</span><br><span class="line">    department: <span class="keyword">async</span> (&#123; deptno, empno &#125;, args, &#123; orademo &#125;) =&gt; &#123;</span><br><span class="line">      <span class="keyword">let</span> value = <span class="keyword">await</span> cache.get(deptno);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (value) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">`cache hit:  <span class="subst">$&#123;value&#125;</span> =&gt; <span class="subst">$&#123;deptno&#125;</span>:<span class="subst">$&#123;empno&#125;</span>`</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">JSON</span>.parse(value);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (queues[deptno]) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">`Batching operation: <span class="subst">$&#123;deptno&#125;</span>:<span class="subst">$&#123;empno&#125;</span>:queues:<span class="subst">$&#123;<span class="built_in">Object</span>.keys(queues).length&#125;</span>`</span>);</span><br><span class="line">        <span class="keyword">return</span> queues[deptno];</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      queues[deptno] = orademo.department</span><br><span class="line">        .findByDeptno(deptno)</span><br><span class="line">        .then(<span class="function"><span class="params">result</span> =&gt;</span> &#123;</span><br><span class="line">          cache.set(deptno, <span class="built_in">JSON</span>.stringify(result.rows[<span class="number">0</span>]))</span><br><span class="line">            .then(<span class="function">(<span class="params">ack</span>) =&gt;</span> &#123;</span><br><span class="line">              <span class="built_in">console</span>.log(<span class="string">`<span class="subst">$&#123;ack&#125;</span>: <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(result.rows[<span class="number">0</span>])&#125;</span>`</span>);</span><br><span class="line">              process.nextTick(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">delete</span> queues[deptno];</span><br><span class="line">              &#125;);</span><br><span class="line">            &#125;);</span><br><span class="line">          <span class="keyword">return</span> result.rows[<span class="number">0</span>];</span><br><span class="line">        &#125;).catch (<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">delete</span> queues[deptno];</span><br><span class="line">        &#125;);</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">return</span> queues[deptno];</span><br><span class="line">    &#125;,</span><br><span class="line">    income: <span class="function">(<span class="params">parent</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">let</span> sal = !<span class="built_in">isNaN</span>(<span class="built_in">parseFloat</span>(parent.sal)) ? <span class="built_in">parseFloat</span>(parent.sal) : <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">let</span> comm = !<span class="built_in">isNaN</span>(<span class="built_in">parseFloat</span>(parent.comm)) ? <span class="built_in">parseFloat</span>(parent.comm) : <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">return</span> sal + comm;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>第 2 行使用 RedisCache 建構式建立一個 department 快取，這是個 Redis cache。</p>
</li>
<li><p>第 3 行我們要搭配記憶體快取一起使用。這會在記憶體中存儲一些 Promise 的快取。<br>在非同步控制流程模式裡，對資料庫發出的請求，併不會等待資料的回覆，所以當 GraphQL 伺服器對資料庫發出所有的請求時，有可能資料庫都尚未回覆，Redis 中也不會有快取的資料，所以如果不將已經請求過的相同請求(相同部門的請求)存入記憶體快取，就會造成資料庫的重複請求，所以這裡要搭配前面例子記憶體的 Promise 快取，攔截對資料庫的重複請求。一旦資料從資料庫返回並存入 Redis 快取，就會將記憶體中的 Promise 快取消除，之後的請求就會從 Redis 快取取得資料。使用變數 queues 當成記憶體快取。</p>
</li>
<li><p>第 16 行第一優先從 Redis 快取取得資料，如果快取不存在 Redis 會返回 null 值。</p>
</li>
<li><p>第 23 行則是攔截已經送出但尚未回覆的相同資料庫請求，如果存在則直接返回 queues 記憶體快取中相同的 Promise。</p>
</li>
<li><p>第 28 行則是實際對資料庫發出請求的地方，31 行在實際資料返回後將資料存入 Redis 快取中，接著在 35 行刪除記憶體中的 Promise 快取。</p>
</li>
</ul>
<p>現在修改 resolvers/index.js :</p>
<figure class="highlight javascript"><figcaption><span>resolvers/index.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">const</span> employeeResolvers = <span class="built_in">require</span>(<span class="string">'./employee-redis'</span>);</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>從新啟動 GraphQL 伺服器後，重新送出先前的 GraphQL listEmployees query:</p>
<figure class="highlight"><figcaption><span>GraphQL query listEmployees</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">query listEmployees &#123;</span><br><span class="line">  totalEmployees</span><br><span class="line">  allEmployees &#123;</span><br><span class="line">    empno</span><br><span class="line">    ename</span><br><span class="line">    hiredate</span><br><span class="line">    income</span><br><span class="line">    department &#123;</span><br><span class="line">      dname</span><br><span class="line">      loc</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>現在可從 GraphQL 伺服器終端螢幕上看到:</p>
<figure class="highlight javascript"><figcaption><span>GraphQL Server console</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Batching operation: <span class="number">10</span>:<span class="number">7782</span>:queues:<span class="number">2</span></span><br><span class="line">Batching operation: <span class="number">20</span>:<span class="number">7788</span>:queues:<span class="number">3</span></span><br><span class="line">Batching operation: <span class="number">20</span>:<span class="number">7902</span>:queues:<span class="number">3</span></span><br><span class="line">Batching operation: <span class="number">20</span>:<span class="number">7369</span>:queues:<span class="number">3</span></span><br><span class="line">Batching operation: <span class="number">30</span>:<span class="number">7499</span>:queues:<span class="number">3</span></span><br><span class="line">Batching operation: <span class="number">30</span>:<span class="number">7654</span>:queues:<span class="number">4</span></span><br><span class="line">Batching operation: <span class="number">30</span>:<span class="number">7844</span>:queues:<span class="number">4</span></span><br><span class="line">Batching operation: <span class="number">20</span>:<span class="number">7876</span>:queues:<span class="number">4</span></span><br><span class="line">Batching operation: <span class="number">30</span>:<span class="number">7900</span>:queues:<span class="number">4</span></span><br><span class="line">Batching operation: <span class="number">10</span>:<span class="number">7934</span>:queues:<span class="number">4</span></span><br><span class="line">Batching operation: <span class="number">70</span>:<span class="number">7607</span>:queues:<span class="number">5</span></span><br><span class="line">Batching operation: <span class="number">70</span>:<span class="number">7609</span>:queues:<span class="number">5</span></span><br><span class="line">Batching operation: <span class="number">40</span>:<span class="number">9011</span>:queues:<span class="number">5</span></span><br><span class="line">Batching operation: <span class="number">10</span>:<span class="number">8907</span>:queues:<span class="number">5</span></span><br><span class="line">OK: &#123;<span class="string">"deptno"</span>:<span class="number">10</span>,<span class="string">"dname"</span>:<span class="string">"會計部"</span>,<span class="string">"loc"</span>:<span class="string">"紐約"</span>&#125;</span><br><span class="line">OK: &#123;<span class="string">"deptno"</span>:<span class="number">30</span>,<span class="string">"dname"</span>:<span class="string">"SALES"</span>,<span class="string">"loc"</span>:<span class="string">"CHICAGO"</span>&#125;</span><br><span class="line">OK: &#123;<span class="string">"deptno"</span>:<span class="number">40</span>,<span class="string">"dname"</span>:<span class="string">"OPERATIONS"</span>,<span class="string">"loc"</span>:<span class="string">"BOSTON"</span>&#125;</span><br><span class="line">OK: &#123;<span class="string">"deptno"</span>:<span class="number">20</span>,<span class="string">"dname"</span>:<span class="string">"RESEARCH"</span>,<span class="string">"loc"</span>:<span class="string">"DALLAS"</span>&#125;</span><br><span class="line">OK: &#123;<span class="string">"deptno"</span>:<span class="number">70</span>,<span class="string">"dname"</span>:<span class="string">"資訊部"</span>,<span class="string">"loc"</span>:<span class="string">"永康 B4"</span>&#125;</span><br></pre></td></tr></table></figure>

<p>因為我們只有 5 個不同的部門，所以只有最後 5 個 OK 是實際從資料庫返回併寫入 Redis 快取時發出的訊息，前面 14 個 Batching operation 則是從記憶體快取中發出的，這裡都沒有用到 Redis 快取，因為資料還來不及寫入 Redis 快取，GraphQL 伺服器就都已經發出所有的請求了。</p>
<p>但是你如果在 30 秒鐘內再從 GraphQL Playground 發出第二次 listEmployees query，則 GraphQL 伺服器的終端螢幕會是:</p>
<figure class="highlight javascript"><figcaption><span>GraphQL Server console</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">cache hit:  &#123;<span class="string">"deptno"</span>:<span class="number">10</span>,<span class="string">"dname"</span>:<span class="string">"會計部"</span>,<span class="string">"loc"</span>:<span class="string">"紐約"</span>&#125; =&gt; <span class="number">10</span>:<span class="number">7839</span></span><br><span class="line">cache hit:  &#123;<span class="string">"deptno"</span>:<span class="number">30</span>,<span class="string">"dname"</span>:<span class="string">"SALES"</span>,<span class="string">"loc"</span>:<span class="string">"CHICAGO"</span>&#125; =&gt; <span class="number">30</span>:<span class="number">7698</span></span><br><span class="line">cache hit:  &#123;<span class="string">"deptno"</span>:<span class="number">10</span>,<span class="string">"dname"</span>:<span class="string">"會計部"</span>,<span class="string">"loc"</span>:<span class="string">"紐約"</span>&#125; =&gt; <span class="number">10</span>:<span class="number">7782</span></span><br><span class="line">cache hit:  &#123;<span class="string">"deptno"</span>:<span class="number">20</span>,<span class="string">"dname"</span>:<span class="string">"RESEARCH"</span>,<span class="string">"loc"</span>:<span class="string">"DALLAS"</span>&#125; =&gt; <span class="number">20</span>:<span class="number">7566</span></span><br><span class="line">cache hit:  &#123;<span class="string">"deptno"</span>:<span class="number">20</span>,<span class="string">"dname"</span>:<span class="string">"RESEARCH"</span>,<span class="string">"loc"</span>:<span class="string">"DALLAS"</span>&#125; =&gt; <span class="number">20</span>:<span class="number">7788</span></span><br><span class="line">cache hit:  &#123;<span class="string">"deptno"</span>:<span class="number">20</span>,<span class="string">"dname"</span>:<span class="string">"RESEARCH"</span>,<span class="string">"loc"</span>:<span class="string">"DALLAS"</span>&#125; =&gt; <span class="number">20</span>:<span class="number">7902</span></span><br><span class="line">cache hit:  &#123;<span class="string">"deptno"</span>:<span class="number">20</span>,<span class="string">"dname"</span>:<span class="string">"RESEARCH"</span>,<span class="string">"loc"</span>:<span class="string">"DALLAS"</span>&#125; =&gt; <span class="number">20</span>:<span class="number">7369</span></span><br><span class="line">cache hit:  &#123;<span class="string">"deptno"</span>:<span class="number">30</span>,<span class="string">"dname"</span>:<span class="string">"SALES"</span>,<span class="string">"loc"</span>:<span class="string">"CHICAGO"</span>&#125; =&gt; <span class="number">30</span>:<span class="number">7499</span></span><br><span class="line">cache hit:  &#123;<span class="string">"deptno"</span>:<span class="number">40</span>,<span class="string">"dname"</span>:<span class="string">"OPERATIONS"</span>,<span class="string">"loc"</span>:<span class="string">"BOSTON"</span>&#125; =&gt; <span class="number">40</span>:<span class="number">7608</span></span><br><span class="line">cache hit:  &#123;<span class="string">"deptno"</span>:<span class="number">30</span>,<span class="string">"dname"</span>:<span class="string">"SALES"</span>,<span class="string">"loc"</span>:<span class="string">"CHICAGO"</span>&#125; =&gt; <span class="number">30</span>:<span class="number">7654</span></span><br><span class="line">cache hit:  &#123;<span class="string">"deptno"</span>:<span class="number">30</span>,<span class="string">"dname"</span>:<span class="string">"SALES"</span>,<span class="string">"loc"</span>:<span class="string">"CHICAGO"</span>&#125; =&gt; <span class="number">30</span>:<span class="number">7844</span></span><br><span class="line">cache hit:  &#123;<span class="string">"deptno"</span>:<span class="number">20</span>,<span class="string">"dname"</span>:<span class="string">"RESEARCH"</span>,<span class="string">"loc"</span>:<span class="string">"DALLAS"</span>&#125; =&gt; <span class="number">20</span>:<span class="number">7876</span></span><br><span class="line">cache hit:  &#123;<span class="string">"deptno"</span>:<span class="number">30</span>,<span class="string">"dname"</span>:<span class="string">"SALES"</span>,<span class="string">"loc"</span>:<span class="string">"CHICAGO"</span>&#125; =&gt; <span class="number">30</span>:<span class="number">7900</span></span><br><span class="line">cache hit:  &#123;<span class="string">"deptno"</span>:<span class="number">10</span>,<span class="string">"dname"</span>:<span class="string">"會計部"</span>,<span class="string">"loc"</span>:<span class="string">"紐約"</span>&#125; =&gt; <span class="number">10</span>:<span class="number">7934</span></span><br><span class="line">cache hit:  &#123;<span class="string">"deptno"</span>:<span class="number">70</span>,<span class="string">"dname"</span>:<span class="string">"資訊部"</span>,<span class="string">"loc"</span>:<span class="string">"永康 B4"</span>&#125; =&gt; <span class="number">70</span>:<span class="number">9006</span></span><br><span class="line">cache hit:  &#123;<span class="string">"deptno"</span>:<span class="number">70</span>,<span class="string">"dname"</span>:<span class="string">"資訊部"</span>,<span class="string">"loc"</span>:<span class="string">"永康 B4"</span>&#125; =&gt; <span class="number">70</span>:<span class="number">7607</span></span><br><span class="line">cache hit:  &#123;<span class="string">"deptno"</span>:<span class="number">70</span>,<span class="string">"dname"</span>:<span class="string">"資訊部"</span>,<span class="string">"loc"</span>:<span class="string">"永康 B4"</span>&#125; =&gt; <span class="number">70</span>:<span class="number">7609</span></span><br><span class="line">cache hit:  &#123;<span class="string">"deptno"</span>:<span class="number">40</span>,<span class="string">"dname"</span>:<span class="string">"OPERATIONS"</span>,<span class="string">"loc"</span>:<span class="string">"BOSTON"</span>&#125; =&gt; <span class="number">40</span>:<span class="number">9011</span></span><br><span class="line">cache hit:  &#123;<span class="string">"deptno"</span>:<span class="number">10</span>,<span class="string">"dname"</span>:<span class="string">"會計部"</span>,<span class="string">"loc"</span>:<span class="string">"紐約"</span>&#125; =&gt; <span class="number">10</span>:<span class="number">8907</span></span><br></pre></td></tr></table></figure>

<p>這裡全部從 Redis 快取中取得了資料，完全沒有對 Oracle Database 發出請求。</p>
<p>從 Redis 中可以查詢這些快取資料:</p>
<figure class="highlight shell"><figcaption><span>Redis using redis-cli</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; scan 0 match graphql*</span><br><span class="line">1) "0"</span><br><span class="line">2) 1) "graphql:orademo:cache:department:40"</span><br><span class="line">   2) "graphql:orademo:cache:department:10"</span><br><span class="line">   3) "graphql:orademo:cache:department:70"</span><br><span class="line">   4) "graphql:orademo:cache:department:30"</span><br><span class="line">   5) "graphql:orademo:cache:department:20"</span><br><span class="line">127.0.0.1:6379&gt; get graphql:orademo:cache:department:20</span><br><span class="line">"&#123;\"deptno\":20,\"dname\":\"RESEARCH\",\"loc\":\"DALLAS\"&#125;"</span><br><span class="line">127.0.0.1:6379&gt; ttl graphql:orademo:cache:department:20</span><br><span class="line">(integer) 16</span><br><span class="line">127.0.0.1:6379&gt; exists graphql:orademo:cache:department:20</span><br><span class="line">(integer) 0</span><br></pre></td></tr></table></figure>

<p>“graphql:orademo:cache:department:20” 就是我們設定的鍵(key)，第 8 行用鍵取出設定的值，這裡我們存入的是 JSON 字符串。第 10 行可以使用 ttl 在鍵過期前查看剩餘的時間，等待 16 秒後可以使用 exists 判斷鍵是否還存在，這時將會返回 0。</p>
<p>在 Redis 生態圈習慣上使用冒號 ( : ) 來分隔名稱的不同部分，以此來構建命名空間 (namespace)。另外還有一些常見的分隔符，例如句號 ( . )、斜線 ( / )，有些人甚至還會使用管道符號 ( | )，無論使用哪個符號來做分隔符，都要保持分隔符號的一致性。</p>
<p>存在 Redis 的快取可以在各不同的伺服器中分享，是伺服端快取模式的最佳選擇。</p>
<p>過 30 秒後再度查詢，資料已不見了，Redis 會幫我們管理這個到期時間策略。</p>
<figure class="highlight shell"><figcaption><span>Redis using redis-cli</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; scan 0 match graphql*</span><br><span class="line">1) "0"</span><br><span class="line">2) (empty list or set)</span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure>

<p>Redis 是一個速度非常快的非關聯式資料庫 (no-relational database)，它可以存儲鍵 (key) 與 5 種不同類型的值 (value) 之間的映射 (mapping)， 可以將存儲在記憶體的鍵值對數據持久化 (persistence) 到硬碟，可以使用複製來擴展讀取的性能，還可以使用客戶端分片 (client-side sharding) 來擴展寫入的性能。這裡我們只用到一種型態的值 String，存儲的是 JSON 格式字串。</p>
<p>Redis 的數據結構致力於幫助用戶解決問題，而不會像其他資料庫那樣，要求用戶扭曲問題來適應資料庫。Redis 是一個可以用來解決問題的工具，它既擁有其他資料庫不具備的數據結構，又擁有記憶體存儲 ( 這使的 Redis 速度非常快 )、遠程 ( 這使的 Redis 可以與多個客戶端和伺服器進行連接 )、持久化 ( 這使的 Redis 在重啟之後仍然保持重啟之前的數據 ) 和可擴展性 ( 透過主從複製和分片 ) 等多個特性，這使的我們可以以熟悉的方式為各種不同的問題構建解決方案。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://1184yang.github.io/2019/12/17/GraphQL-API-9/" data-id="ckcpzj95w000u80vzljdgvhev" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-GraphQL-API-8" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/12/09/GraphQL-API-8/" class="article-date">
  <time datetime="2019-12-09T02:31:35.000Z" itemprop="datePublished">2019-12-09</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/GraphQL/">GraphQL</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/12/09/GraphQL-API-8/">建立 GraphQL API (8)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="使用-Oracle-資料庫"><a href="#使用-Oracle-資料庫" class="headerlink" title="使用 Oracle 資料庫"></a>使用 Oracle 資料庫</h3><p>Oracle 還是目前我們使用的主要資料庫，以下會是使用 Oracle 資料庫的範例，還是使用 EMP 與 DEPT。</p>
<p>我們從 models 開始，這裡將會設定 Oracle 資料庫的連結與及資料表的 API。在專案目錄 models 中新增 oradb.config.js:</p>
<figure class="highlight javascript"><figcaption><span>models/oradb.config.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  user: <span class="string">"demo"</span>,</span><br><span class="line">  password: <span class="string">"demo426"</span>,</span><br><span class="line">  connectString: <span class="string">"10.11.25.139:1522/lx26.pec.com.tw"</span>,</span><br><span class="line">  poolMin: <span class="number">0</span>,</span><br><span class="line">  poolMax: <span class="number">2</span>,</span><br><span class="line">  poolIncrement: <span class="number">1</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>這裡直接使用 Oracle connection pool，可依需求調整，這裡使用 demo SCHEMA。</p>
<p>接下來是資料庫的抽象層，oradb.database.js，這與之前 Node.js 教育訓練 REST API 的程式碼相同:</p>
<figure class="highlight javascript"><figcaption><span>models/oradb.database.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> oracledb = <span class="built_in">require</span>(<span class="string">'oracledb'</span>);</span><br><span class="line"><span class="keyword">const</span> dbConfig = <span class="built_in">require</span>(<span class="string">'./oradb.config'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">initialize</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">await</span> oracledb.createPool(dbConfig);</span><br><span class="line">  &#125; <span class="keyword">catch</span>(err) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(err.message);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">close</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">await</span> oracledb.getPool().close(<span class="number">10</span>);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    <span class="built_in">console</span>.error(err.message);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">doExecute</span>(<span class="params">statement, binds = [], opts = &#123;&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="keyword">async</span> (resolve, reject) =&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> conn;</span><br><span class="line"></span><br><span class="line">    opts.outFormat = oracledb.OBJECT;</span><br><span class="line">    opts.autoCommit = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      conn = <span class="keyword">await</span> oracledb.getConnection();</span><br><span class="line">      <span class="keyword">const</span> result = <span class="keyword">await</span> conn.execute(statement, binds, opts);</span><br><span class="line">      resolve(result);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">      reject(err);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (conn) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="keyword">await</span> conn.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">          <span class="built_in">console</span>.log(err);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">doExecuteMany</span>(<span class="params">statement, binds = [], opts = &#123;&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="keyword">async</span> (resolve, reject) =&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> conn;</span><br><span class="line"></span><br><span class="line">    opts.outFormat = oracledb.OBJECT;</span><br><span class="line">    opts.autoCommit = <span class="literal">true</span>;</span><br><span class="line">    opts.batchErrors = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      conn = <span class="keyword">await</span> oracledb.getConnection();</span><br><span class="line">      <span class="keyword">const</span> result = <span class="keyword">await</span> conn.executeMany(statement, binds, opts);</span><br><span class="line">      resolve(result);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">      reject(err);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (conn) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="keyword">await</span> conn.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">          <span class="built_in">console</span>.log(err);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  initialize,</span><br><span class="line">  close,</span><br><span class="line">  doExecute,</span><br><span class="line">  doExecuteMany</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>


<p>這抽象層可重複用在個別的資料表 API 中。</p>
<figure class="highlight plain"><figcaption><span>models/orademo.department.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br></pre></td><td class="code"><pre><span class="line">const oracledb = require(&quot;oracledb&quot;);</span><br><span class="line">const oradb = require(&quot;./oradb.database&quot;);</span><br><span class="line">const &#123; setValue, toLowerCaseKeys &#125; = require(&quot;./helpers/utils&quot;);</span><br><span class="line"></span><br><span class="line">function findAll() &#123;</span><br><span class="line">  const statement = &quot;select * from dept&quot;;</span><br><span class="line"></span><br><span class="line">  return oradb</span><br><span class="line">    .doExecute(statement)</span><br><span class="line">    .then(result =&gt; toLowerCaseKeys(result))</span><br><span class="line">    .catch(err =&gt; &#123;</span><br><span class="line">      throw err;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function findByDeptno(deptno) &#123;</span><br><span class="line">  if (!deptno) &#123;</span><br><span class="line">    return Promise.reject(new Error(&quot;Invalid input&quot;));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  const binds = [];</span><br><span class="line">  const statement = &quot;select * from dept where deptno = :deptno&quot;;</span><br><span class="line">  binds.push(deptno);</span><br><span class="line"></span><br><span class="line">  return oradb</span><br><span class="line">    .doExecute(statement, binds)</span><br><span class="line">    .then(result =&gt; toLowerCaseKeys(result))</span><br><span class="line">    .catch(err =&gt; &#123;</span><br><span class="line">      throw err;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function add(data) &#123;</span><br><span class="line">  const statement = `</span><br><span class="line">    INSERT INTO dept (deptno, dname, loc)</span><br><span class="line">      VALUES(:deptno, :dname, :loc)</span><br><span class="line">      RETURNING deptno INTO :id</span><br><span class="line">  `;</span><br><span class="line"></span><br><span class="line">  return new Promise(async (resolve, reject) =&gt; &#123;</span><br><span class="line">    if (typeof data !== &quot;object&quot;) &#123;</span><br><span class="line">      reject(new Error(&quot;Input must be an valid object&quot;));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    let result;</span><br><span class="line">    let binds = &#123;</span><br><span class="line">      deptno: setValue(data[&quot;deptno&quot;]),</span><br><span class="line">      dname: setValue(data[&quot;dname&quot;]),</span><br><span class="line">      loc: setValue(data[&quot;loc&quot;]),</span><br><span class="line">      id: &#123;</span><br><span class="line">        type: oracledb.STRING,</span><br><span class="line">        dir: oracledb.BIND_OUT</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">      result = await oradb.doExecute(statement, binds);</span><br><span class="line">      resolve(result);</span><br><span class="line">    &#125; catch (err) &#123;</span><br><span class="line">      reject(err);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function update(deptno, data) &#123;</span><br><span class="line">  const statement = `</span><br><span class="line">    UPDATE dept d</span><br><span class="line">       SET d.dname = :dname,</span><br><span class="line">           d.loc = :loc</span><br><span class="line">     WHERE d.deptno = :deptno</span><br><span class="line">    RETURNING ROWID INTO :rid</span><br><span class="line">  `;</span><br><span class="line"></span><br><span class="line">  return new Promise(async (resolve, reject) =&gt; &#123;</span><br><span class="line">    if (!deptno) &#123;</span><br><span class="line">      reject(new Error(&quot;Invalid deptno&quot;));</span><br><span class="line">    &#125;</span><br><span class="line">    if (typeof data !== &quot;object&quot;) &#123;</span><br><span class="line">      reject(new Error(&quot;Input must be an valid object&quot;));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    let result;</span><br><span class="line">    let binds = &#123;</span><br><span class="line">      deptno: setValue(deptno),</span><br><span class="line">      dname: setValue(data[&quot;dname&quot;]),</span><br><span class="line">      loc: setValue(data[&quot;loc&quot;]),</span><br><span class="line">      rid: &#123;</span><br><span class="line">        type: oracledb.STRING,</span><br><span class="line">        dir: oracledb.BIND_OUT</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">      result = await oradb.doExecute(statement, binds);</span><br><span class="line">      resolve(result);</span><br><span class="line">    &#125; catch (err) &#123;</span><br><span class="line">      reject(err);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function remove(deptno) &#123;</span><br><span class="line">  const statement = `</span><br><span class="line">    DELETE FROM dept</span><br><span class="line">     WHERE deptno = :deptno</span><br><span class="line">    RETURNING deptno INTO :id</span><br><span class="line">  `;</span><br><span class="line"></span><br><span class="line">  return new Promise(async (resolve, reject) =&gt; &#123;</span><br><span class="line">    if (!deptno) &#123;</span><br><span class="line">      reject(new Error(&quot;Invalid deptno&quot;));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    let result;</span><br><span class="line">    let binds = &#123;</span><br><span class="line">      deptno: setValue(deptno),</span><br><span class="line">      id: &#123;</span><br><span class="line">        type: oracledb.STRING,</span><br><span class="line">        dir: oracledb.BIND_OUT</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">      result = await oradb.doExecute(statement, binds);</span><br><span class="line">      resolve(result);</span><br><span class="line">    &#125; catch (err) &#123;</span><br><span class="line">      reject(err);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function upsert(data) &#123;</span><br><span class="line">  const statement = `</span><br><span class="line">    MERGE INTO dept d</span><br><span class="line">    USING (select :deptno as deptno,</span><br><span class="line">                  :dname as dname,</span><br><span class="line">                  :loc as loc</span><br><span class="line">             from dual) p</span><br><span class="line">    ON (d.deptno = p.deptno)</span><br><span class="line">    WHEN MATCHED THEN</span><br><span class="line">      UPDATE SET d.dname = p.dname,</span><br><span class="line">                 d.loc = p.loc</span><br><span class="line">    WHEN NOT MATCHED THEN</span><br><span class="line">      INSERT (d.deptno, d.dname, d.loc)</span><br><span class="line">      VALUES (p.deptno, p.dname, p.loc)</span><br><span class="line">  `;</span><br><span class="line"></span><br><span class="line">  return new Promise(async (resolve, reject) =&gt; &#123;</span><br><span class="line">    if (typeof data !== &quot;object&quot;) &#123;</span><br><span class="line">      reject(new Error(&quot;Input must be an array&quot;));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (data instanceof Array &amp;&amp; data.length &gt; 0) &#123;</span><br><span class="line">      let result;</span><br><span class="line">      let binds = [];</span><br><span class="line"></span><br><span class="line">      data.forEach(value =&gt; &#123;</span><br><span class="line">        let item = &#123;</span><br><span class="line">          deptno: setValue(value[&quot;deptno&quot;]),</span><br><span class="line">          dname: setValue(value[&quot;dname&quot;]),</span><br><span class="line">          loc: setValue(value[&quot;loc&quot;])</span><br><span class="line">        &#125;;</span><br><span class="line">        binds.push(item);</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      try &#123;</span><br><span class="line">        result = await oradb.doExecuteMany(statement, binds);</span><br><span class="line">        resolve(result);</span><br><span class="line">      &#125; catch (err) &#123;</span><br><span class="line">        reject(err);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      reject(new Error(&quot;Input must be an array&quot;));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module.exports = &#123;</span><br><span class="line">  findAll,</span><br><span class="line">  findByDeptno,</span><br><span class="line">  add,</span><br><span class="line">  update,</span><br><span class="line">  remove,</span><br><span class="line">  upsert</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>Oracle 的 oracledb 驅動程式返回的 JSON 格式資料，屬性都會是大寫型態，這裡使用了一個 toLowerCaseKeys 函式將它全部轉為小寫，這個函式放在 helpers/utils 程式碼中，裡面還包含一些常會用到的小程式碼，在這裡大部份都不會用到，但可留著參考。</p>
<figure class="highlight javascript"><figcaption><span>models/helpers/utils.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> crypto = <span class="built_in">require</span>(<span class="string">"crypto"</span>);</span><br><span class="line"></span><br><span class="line">exports.trim = <span class="function">(<span class="params">str</span>) =&gt;</span> str.replace(<span class="regexp">/^\s*|\s*$/g</span>, <span class="string">''</span>);</span><br><span class="line"></span><br><span class="line">exports.setValue = <span class="function">(<span class="params">val</span>) =&gt;</span> val || <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">exports.isNull = isNull;</span><br><span class="line"></span><br><span class="line">exports.isNotNull = negate(isNull);</span><br><span class="line"></span><br><span class="line">exports.isUndefined = <span class="function"><span class="params">val</span> =&gt;</span> val === <span class="literal">undefined</span>;</span><br><span class="line"></span><br><span class="line">exports.isEmpty = <span class="function"><span class="params">s</span> =&gt;</span> !s || !s.trim();</span><br><span class="line"></span><br><span class="line">exports.isObject = <span class="function">(<span class="params">val</span>) =&gt;</span> val &amp;&amp; <span class="keyword">typeof</span> val === <span class="string">'object'</span>;</span><br><span class="line"></span><br><span class="line">exports.isArray = <span class="function">(<span class="params">val</span>) =&gt;</span> val &amp;&amp; <span class="built_in">Array</span>.isArray(val);</span><br><span class="line"></span><br><span class="line">exports.isNumber = <span class="function">(<span class="params">val</span>) =&gt;</span> <span class="keyword">typeof</span> val === <span class="string">'number'</span> &amp;&amp; val === <span class="built_in">Number</span>(val) &amp;&amp; <span class="built_in">Number</span>.isFinite(val);</span><br><span class="line"></span><br><span class="line">exports.validNumber = <span class="function"><span class="params">val</span> =&gt;</span> !<span class="built_in">isNaN</span>(<span class="built_in">parseFloat</span>(val)) ? <span class="built_in">parseFloat</span>(val) : <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">exports.normalize = <span class="function">(<span class="params">str</span>) =&gt;</span> str.replace(<span class="regexp">/\-/g</span>, <span class="string">''</span>);</span><br><span class="line"></span><br><span class="line">exports.isValid = <span class="function">(<span class="params">str</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span>(str.length === <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Status(<span class="literal">false</span>, <span class="string">'Invalid input. Expected non-empty value!'</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Status(<span class="literal">true</span>, <span class="string">'Success!'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">exports.toLowerCaseKeys = toLowerCaseKeys;</span><br><span class="line"></span><br><span class="line">exports.checksum = checksum;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">toLowerCaseKeys</span> (<span class="params">obj</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> newObj, value;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> <span class="built_in">Array</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> obj.map(<span class="function"><span class="params">value</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> value === <span class="string">"object"</span>) &#123;</span><br><span class="line">        value = toLowerCaseKeys(value);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> value;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    newObj = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">Object</span>.keys(obj).forEach(<span class="function"><span class="params">origKey</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">let</span> newKey = (origKey.toLowerCase() || origKey).toString();</span><br><span class="line">      value = obj[origKey];</span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        value <span class="keyword">instanceof</span> <span class="built_in">Array</span> ||</span><br><span class="line">        (value !== <span class="literal">null</span> &amp;&amp; value.constructor === <span class="built_in">Object</span>)</span><br><span class="line">      ) &#123;</span><br><span class="line">        value = toLowerCaseKeys(value);</span><br><span class="line">      &#125;</span><br><span class="line">      newObj[newKey] = value;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> newObj;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checksum</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> string = <span class="built_in">Object</span>.keys(obj)</span><br><span class="line">    .sort()</span><br><span class="line">    .map(<span class="function"><span class="params">prop</span> =&gt;</span> <span class="built_in">String</span>(obj[prop]))</span><br><span class="line">    .join(<span class="string">""</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> crypto</span><br><span class="line">    .createHash(<span class="string">"sha1"</span>)</span><br><span class="line">    .update(string)</span><br><span class="line">    .digest(<span class="string">"hex"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isNull</span>(<span class="params">val</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span>  val === <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">negate</span>(<span class="params">func</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> !func.apply(<span class="literal">null</span>, <span class="built_in">arguments</span>);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Status</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(status, message) &#123;</span><br><span class="line">    <span class="keyword">this</span>._status = status;</span><br><span class="line">    <span class="keyword">this</span>._message = messge;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">get</span> status() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>._status;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">get</span> message() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>._message;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以下則是 EMP API:</p>
<figure class="highlight javascript"><figcaption><span>models/orademo.employee.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> oracledb = <span class="built_in">require</span>(<span class="string">'oracledb'</span>);</span><br><span class="line"><span class="keyword">const</span> oradb = <span class="built_in">require</span>(<span class="string">'./oradb.database'</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; setValue, toLowerCaseKeys &#125; = <span class="built_in">require</span>(<span class="string">'./helpers/utils'</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">findAll</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> statement = <span class="string">"select * from emp"</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> oradb.doExecute(statement)</span><br><span class="line">    .then(<span class="function"><span class="params">result</span> =&gt;</span> toLowerCaseKeys(result))</span><br><span class="line">    .catch(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">throw</span> err;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">findByEmpno</span> (<span class="params">empno</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!empno) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Promise</span>.reject(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"Invalid input"</span>));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> binds = [];</span><br><span class="line">  <span class="keyword">const</span> statement = <span class="string">"select * from emp where empno = :empno"</span>;</span><br><span class="line">  binds.push(empno);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> oradb.doExecute(statement, binds)</span><br><span class="line">    .then(<span class="function">(<span class="params">result</span>) =&gt;</span> toLowerCaseKeys(result))</span><br><span class="line">    .catch(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">throw</span> err</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">findByDeptno</span> (<span class="params">deptno</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!deptno) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Promise</span>.reject(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"Invalid input"</span>));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> binds = [];</span><br><span class="line">  <span class="keyword">const</span> statement = <span class="string">"select * from emp where deptno = :deptno"</span>;</span><br><span class="line">  binds.push(deptno);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> oradb.doExecute(statement, binds)</span><br><span class="line">    .then(<span class="function">(<span class="params">result</span>) =&gt;</span> toLowerCaseKeys(result))</span><br><span class="line">    .catch(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">throw</span> err</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> statement = <span class="string">`</span></span><br><span class="line"><span class="string">    INSERT INTO emp</span></span><br><span class="line"><span class="string">                (empno, ename, job, mgr, hiredate, sal, comm, deptno)</span></span><br><span class="line"><span class="string">         VALUES (:empno, :ename, :job, :mgr, to_date(:hiredate,'yyyy-mm-dd"T"hh24:mi:ss'), :sal, :comm, :deptno)</span></span><br><span class="line"><span class="string">    RETURNING empno INTO :id</span></span><br><span class="line"><span class="string">  `</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="keyword">async</span> (resolve, reject) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> data !== <span class="string">"object"</span>) &#123;</span><br><span class="line">      reject(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"Input must be an valid object"</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> result;</span><br><span class="line">    <span class="keyword">let</span> binds = &#123;</span><br><span class="line">      empno: setValue(data[<span class="string">"empno"</span>]),</span><br><span class="line">      ename: setValue(data[<span class="string">"ename"</span>]),</span><br><span class="line">      job: setValue(data[<span class="string">"job"</span>]),</span><br><span class="line">      mgr: setValue(data[<span class="string">"mgr"</span>]),</span><br><span class="line">      hiredate: setValue(data[<span class="string">"hiredate"</span>]),</span><br><span class="line">      sal: setValue(data[<span class="string">"sal"</span>]),</span><br><span class="line">      comm: setValue(data[<span class="string">"comm"</span>]),</span><br><span class="line">      deptno: setValue(data[<span class="string">"deptno"</span>]),</span><br><span class="line">      id: &#123;</span><br><span class="line">        type: oracledb.STRING,</span><br><span class="line">        dir: oracledb.BIND_OUT</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      result = <span class="keyword">await</span> oradb.doExecute(statement, binds);</span><br><span class="line">      resolve(result);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">      reject(err);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">update</span>(<span class="params">empno, data</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> statement = <span class="string">`</span></span><br><span class="line"><span class="string">    UPDATE emp e</span></span><br><span class="line"><span class="string">       SET e.ename = :ename,</span></span><br><span class="line"><span class="string">           e.job = :job,</span></span><br><span class="line"><span class="string">           e.mgr = :mgr,</span></span><br><span class="line"><span class="string">           e.hiredate = to_date(:hiredate,'yyyy-mm-dd"T"hh24:mi:ss'),</span></span><br><span class="line"><span class="string">           e.sal = :sal,</span></span><br><span class="line"><span class="string">           e.comm = :comm,</span></span><br><span class="line"><span class="string">           e.deptno = :deptno</span></span><br><span class="line"><span class="string">     WHERE e.empno = :empno</span></span><br><span class="line"><span class="string">    RETURNING ROWID INTO :rid</span></span><br><span class="line"><span class="string">  `</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="keyword">async</span> (resolve, reject) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (!empno) &#123;</span><br><span class="line">      reject(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"Invalid empno"</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> data !== <span class="string">"object"</span>) &#123;</span><br><span class="line">      reject(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"Input must be an valid object"</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> result;</span><br><span class="line">    <span class="keyword">let</span> binds = &#123;</span><br><span class="line">      empno: setValue(empno),</span><br><span class="line">      ename: setValue(data[<span class="string">"ename"</span>]),</span><br><span class="line">      job: setValue(data[<span class="string">"job"</span>]),</span><br><span class="line">      mgr: setValue(data[<span class="string">"mgr"</span>]),</span><br><span class="line">      hiredate: setValue(data[<span class="string">"hiredate"</span>]),</span><br><span class="line">      sal: setValue(data[<span class="string">"sal"</span>]),</span><br><span class="line">      comm: setValue(data[<span class="string">"comm"</span>]),</span><br><span class="line">      deptno: setValue(data[<span class="string">"deptno"</span>]),</span><br><span class="line">      rid: &#123;</span><br><span class="line">        type: oracledb.STRING,</span><br><span class="line">        dir: oracledb.BIND_OUT</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      result = <span class="keyword">await</span> oradb.doExecute(statement, binds);</span><br><span class="line">      resolve(result);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">      reject(err);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">remove</span>(<span class="params">empno</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> statement = <span class="string">`</span></span><br><span class="line"><span class="string">    DELETE FROM emp</span></span><br><span class="line"><span class="string">     WHERE empno = :empno</span></span><br><span class="line"><span class="string">    RETURNING empno INTO :id</span></span><br><span class="line"><span class="string">  `</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="keyword">async</span> (resolve, reject) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (!empno) &#123;</span><br><span class="line">      reject(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"Invalid empno"</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> result;</span><br><span class="line">    <span class="keyword">let</span> binds = &#123;</span><br><span class="line">      empno: setValue(empno),</span><br><span class="line">      id: &#123;</span><br><span class="line">        type: oracledb.STRING,</span><br><span class="line">        dir: oracledb.BIND_OUT</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      result = <span class="keyword">await</span> oradb.doExecute(statement, binds);</span><br><span class="line">      resolve(result);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">      reject(err);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">upsert</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> statement = <span class="string">`</span></span><br><span class="line"><span class="string">    MERGE INTO emp e</span></span><br><span class="line"><span class="string">    USING (select :empno as empno,</span></span><br><span class="line"><span class="string">                  :ename as ename,</span></span><br><span class="line"><span class="string">                  :job as job,</span></span><br><span class="line"><span class="string">                  :mgr as mgr,</span></span><br><span class="line"><span class="string">                  to_date(:hiredate,'yyyy-mm-dd"T"hh24:mi:ss') as hiredate,</span></span><br><span class="line"><span class="string">                  :sal as sal,</span></span><br><span class="line"><span class="string">                  :comm as comm,</span></span><br><span class="line"><span class="string">                  :deptno as deptno</span></span><br><span class="line"><span class="string">             from dual) p</span></span><br><span class="line"><span class="string">    ON (e.empno = p.empno)</span></span><br><span class="line"><span class="string">    WHEN MATCHED THEN</span></span><br><span class="line"><span class="string">      UPDATE SET e.ename = p.ename,</span></span><br><span class="line"><span class="string">                 e.job = p.job,</span></span><br><span class="line"><span class="string">                 e.mgr = p.mgr,</span></span><br><span class="line"><span class="string">                 e.hiredate = p.hiredate,</span></span><br><span class="line"><span class="string">                 e.sal = p.sal,</span></span><br><span class="line"><span class="string">                 e.comm = p.comm,</span></span><br><span class="line"><span class="string">                 e.deptno = p.deptno</span></span><br><span class="line"><span class="string">    WHEN NOT MATCHED THEN</span></span><br><span class="line"><span class="string">      INSERT (e.empno, e.ename, e.job, e.mgr, e.hiredate, e.sal, e.comm, e.deptno)</span></span><br><span class="line"><span class="string">      VALUES (p.empno, p.ename, p.job, p.mgr, p.hiredate, p.sal, p.comm, p.deptno)</span></span><br><span class="line"><span class="string">  `</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="keyword">async</span> (resolve, reject) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> data !== <span class="string">"object"</span>) &#123;</span><br><span class="line">      reject(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"Input must be an array"</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (data <span class="keyword">instanceof</span> <span class="built_in">Array</span> &amp;&amp; data.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">let</span> result;</span><br><span class="line">      <span class="keyword">let</span> binds = [];</span><br><span class="line"></span><br><span class="line">      data.forEach(<span class="function"><span class="params">value</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> item = &#123;</span><br><span class="line">          empno: setValue(value[<span class="string">"empno"</span>]),</span><br><span class="line">          ename: setValue(value[<span class="string">"ename"</span>]),</span><br><span class="line">          job: setValue(value[<span class="string">"job"</span>]),</span><br><span class="line">          mgr: setValue(value[<span class="string">"mgr"</span>]),</span><br><span class="line">          hiredate: setValue(value[<span class="string">"hiredate"</span>]),</span><br><span class="line">          sal: setValue(value[<span class="string">"sal"</span>]),</span><br><span class="line">          comm: setValue(value[<span class="string">"comm"</span>]),</span><br><span class="line">          deptno: setValue(value[<span class="string">"deptno"</span>]),</span><br><span class="line">        &#125;</span><br><span class="line">        binds.push(item);</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        result = <span class="keyword">await</span> oradb.doExecuteMany(statement, binds);</span><br><span class="line">        resolve(result);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">        reject(err);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      reject(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"Input must be an array"</span>));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  findAll,</span><br><span class="line">  findByEmpno,</span><br><span class="line">  findByDeptno,</span><br><span class="line">  add,</span><br><span class="line">  update,</span><br><span class="line">  remove,</span><br><span class="line">  upsert</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>現在可以來測試看看了:</p>
<figure class="highlight javascript"><figcaption><span>models/helpers/orademo-test.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> oradb = <span class="built_in">require</span>(<span class="string">'../oradb.database'</span>);</span><br><span class="line"><span class="keyword">const</span> department = <span class="built_in">require</span>(<span class="string">'../orademo.department'</span>);</span><br><span class="line"></span><br><span class="line">(<span class="keyword">async</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">await</span> oradb.initialize();</span><br><span class="line">    </span><br><span class="line">    department.findAll()</span><br><span class="line">      .then(<span class="function"><span class="params">result</span> =&gt;</span> <span class="built_in">console</span>.log(result.rows))</span><br><span class="line">      .catch(<span class="function"><span class="params">err</span> =&gt;</span> <span class="built_in">console</span>.log(err));</span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(err);</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">await</span> oradb.close();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>

<p>第 6 行連結到資料庫，我們使用 Oracle Connection Pool，稍後我們會在啟動 GraphQL 伺服器時，馬上初始化資料庫的 Connection Pool。 測試順利的話應該會有如下的回應:</p>
<figure class="highlight javascript"><figcaption><span>results</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ node orademo-test</span><br><span class="line"></span><br><span class="line">[</span><br><span class="line">  &#123; <span class="attr">deptno</span>: <span class="number">10</span>, <span class="attr">dname</span>: <span class="string">'會計部'</span>, <span class="attr">loc</span>: <span class="string">'紐約'</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">deptno</span>: <span class="number">20</span>, <span class="attr">dname</span>: <span class="string">'RESEARCH'</span>, <span class="attr">loc</span>: <span class="string">'DALLAS'</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">deptno</span>: <span class="number">30</span>, <span class="attr">dname</span>: <span class="string">'SALES'</span>, <span class="attr">loc</span>: <span class="string">'CHICAGO'</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">deptno</span>: <span class="number">40</span>, <span class="attr">dname</span>: <span class="string">'OPERATIONS'</span>, <span class="attr">loc</span>: <span class="string">'BOSTON'</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">deptno</span>: <span class="number">70</span>, <span class="attr">dname</span>: <span class="string">'資訊部'</span>, <span class="attr">loc</span>: <span class="string">'永康 B4'</span> &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>現在我們使用一個程式碼將兩個 API 併接起來。</p>
<figure class="highlight javascript"><figcaption><span>models/orademo.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">exports.employee = <span class="built_in">require</span>(<span class="string">'./orademo.employee'</span>);</span><br><span class="line">exports.department = <span class="built_in">require</span>(<span class="string">'./orademo.department'</span>);</span><br></pre></td></tr></table></figure>

<p>接著要修改 GraphQL 伺服器的啟動程式 index.js，初始化 Oracle 資料庫的 Connection Pool 連結。使用 Connection Pool 網路連結效能較佳，而且可以控制對資料庫的連結數量。初始化 Oracle Connection 的程式碼與之前用於 Node.js Express 相同，可參考 <a href="/useful/nodejs.pdf" target="_blank">Node.js 教育訓練文件</a> 第 287 頁。</p>
<figure class="highlight javascript"><figcaption><span>index.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; createServer &#125; = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">"express"</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; ApolloServer, PubSub &#125; = <span class="built_in">require</span>(<span class="string">"apollo-server-express"</span>);</span><br><span class="line"><span class="keyword">const</span> cors = <span class="built_in">require</span>(<span class="string">'cors'</span>);</span><br><span class="line"><span class="keyword">const</span> db = <span class="built_in">require</span>(<span class="string">'./models/dbs'</span>);</span><br><span class="line"><span class="keyword">const</span> orademo = <span class="built_in">require</span>(<span class="string">'./models/orademo'</span>);</span><br><span class="line"><span class="keyword">const</span> userService = <span class="built_in">require</span>(<span class="string">'./services/user.service'</span>);</span><br><span class="line"><span class="keyword">const</span> typeDefs = <span class="built_in">require</span>(<span class="string">'./schema'</span>);</span><br><span class="line"><span class="keyword">const</span> resolvers = <span class="built_in">require</span>(<span class="string">'./resolvers'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Initialize Oracle Database connection pool */</span></span><br><span class="line"><span class="keyword">const</span> oradb = <span class="built_in">require</span>(<span class="string">'./models/oradb.database'</span>);</span><br><span class="line"><span class="keyword">const</span> dbConfig = <span class="built_in">require</span>(<span class="string">'./models/oradb.config'</span>);</span><br><span class="line"><span class="keyword">const</span> defaultThreadPoolSize = <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">process.env.UV_THREADPOOL_SIZE = dbConfig.poolMax + defaultThreadPoolSize;</span><br><span class="line"></span><br><span class="line">dbInitialize();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = express();</span><br><span class="line">app.use(cors());</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> context = <span class="keyword">async</span> (&#123; req, connection &#125;) =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> currentUser = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> token = req</span><br><span class="line">      ? req.headers.authorization.split(<span class="string">" "</span>)[<span class="number">1</span>]</span><br><span class="line">      : connection.context.Authorization.split(<span class="string">" "</span>)[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> payload = token &amp;&amp; userService.jwtVerify(token);</span><br><span class="line">    currentUser = payload &amp;&amp; (<span class="keyword">await</span> db.users.findOne(payload.appLogin));</span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    currentUser = <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    db,</span><br><span class="line">    orademo,</span><br><span class="line">    userService,</span><br><span class="line">    currentUser,</span><br><span class="line">    pubsub</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> pubsub = <span class="keyword">new</span> PubSub();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> server = <span class="keyword">new</span> ApolloServer(&#123;</span><br><span class="line">  typeDefs,</span><br><span class="line">  resolvers,</span><br><span class="line">  context</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">server.applyMiddleware(&#123; app &#125;);</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">"/"</span>, (req, res) =&gt; res.end(<span class="string">"Welcome to the GraphQL Sample API"</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> httpServer = createServer(app);</span><br><span class="line">server.installSubscriptionHandlers(httpServer);</span><br><span class="line"></span><br><span class="line">httpServer.listen(&#123; <span class="attr">port</span>: <span class="number">4000</span> &#125;, () =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(</span><br><span class="line">    <span class="string">`GraphQL Server running @ http://localhost:4000<span class="subst">$&#123;server.graphqlPath&#125;</span>`</span></span><br><span class="line">  );</span><br><span class="line">  <span class="built_in">console</span>.log(</span><br><span class="line">    <span class="string">`GraphQL Subscriptions running @ ws://localhost:4000<span class="subst">$&#123;server.subscriptionsPath&#125;</span>`</span></span><br><span class="line">  );</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">process.on(<span class="string">"SIGTERM"</span>, () =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"Received SIGTERM"</span>);</span><br><span class="line">  dbClose();</span><br><span class="line">&#125;);</span><br><span class="line">process.on(<span class="string">"SIGINT"</span>, () =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"Received SIGINT"</span>);</span><br><span class="line">  dbClose();</span><br><span class="line">&#125;);</span><br><span class="line">process.on(<span class="string">"uncaughtException"</span>, err =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"Uncaught exception"</span>);</span><br><span class="line">  <span class="built_in">console</span>.log(err);</span><br><span class="line">  dbClose(err);</span><br><span class="line">&#125;);</span><br><span class="line">process.on(<span class="string">"unhandledRejection"</span>, (reason, promise) =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.error(<span class="string">"Unhandled Rejection at: "</span>, promise, <span class="string">" reason: "</span>, reason);</span><br><span class="line">  dbClose(reason);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">dbInitialize</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"Initializing database"</span>);</span><br><span class="line">    <span class="keyword">await</span> oradb.initialize();</span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    <span class="built_in">console</span>.error(err);</span><br><span class="line">    process.exit(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">dbClose</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> error = err;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"Close database connection pool"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">await</span> oradb.close();</span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"Encountered error"</span>, err);</span><br><span class="line">    error = error || err;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (error) &#123;</span><br><span class="line">    process.exit(<span class="number">1</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    process.exit(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>第 6 行加入 orademo API。</p>
</li>
<li><p>第 12 ~ 18 行初始化 Oracle Database connection pool。UV_THREADPOOL_SIZE 必須在使用 threadpool 的第一個調用之前設置。 這是 因為 threadpool 是在第一次使用時創建的，一旦創建，它的大小是固定的。</p>
</li>
<li><p>第 39 行將 orademo 加入 GraphQL context。這將會用在 GraphQL Resolvers 解析函式。</p>
</li>
<li><p>第 70 行以後加上幾個 Signal 監聽器,當 Node.js process 收到這些信號時，將會發出 Signal Events，收到這些事件時關閉 Oracle Database connection pool。</p>
</li>
</ul>
<p>現在可以開始設計 GraphQL Query 了，從 Schema 開始:</p>
<figure class="highlight javascript"><figcaption><span>schema/department.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; gql &#125; = <span class="built_in">require</span>(<span class="string">"apollo-server-express"</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = gql<span class="string">`</span></span><br><span class="line"><span class="string">  extend type Query &#123;</span></span><br><span class="line"><span class="string">    totalDepartments: Int</span></span><br><span class="line"><span class="string">    allDepartments: [Department]</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">type Department &#123;</span></span><br><span class="line"><span class="string">  deptno: ID!</span></span><br><span class="line"><span class="string">  dname: String</span></span><br><span class="line"><span class="string">  loc: String</span></span><br><span class="line"><span class="string">  employees(job: String): [Employee!]!</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">`</span>;</span><br></pre></td></tr></table></figure>

<p>第 13 行這裡加入了一個邊(edge)的連結，employees 欄位是資料庫中沒有的欄位，而且他可以接受一個引數 job。返回的則是一個 Employee 型態的陣列，Employee 型態會在稍後定義。</p>
<figure class="highlight javascript"><figcaption><span>schema/employee.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; gql &#125; = <span class="built_in">require</span>(<span class="string">"apollo-server-express"</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = gql<span class="string">`</span></span><br><span class="line"><span class="string">  extend type Query &#123;</span></span><br><span class="line"><span class="string">    totalEmployees: Int!</span></span><br><span class="line"><span class="string">    allEmployees: [Employee!]!</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  type Employee &#123;</span></span><br><span class="line"><span class="string">    empno: ID!</span></span><br><span class="line"><span class="string">    ename: String</span></span><br><span class="line"><span class="string">    job: String</span></span><br><span class="line"><span class="string">    mgr: Int</span></span><br><span class="line"><span class="string">    hiredate: DateTime</span></span><br><span class="line"><span class="string">    sal: Float</span></span><br><span class="line"><span class="string">    comm: Float</span></span><br><span class="line"><span class="string">    income: Float</span></span><br><span class="line"><span class="string">    department: Department</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">`</span>;</span><br></pre></td></tr></table></figure>

<p>這裡第 17 與 18 行也是資料庫中沒有的欄位，income 在資料庫中不存在， department 則是個邊連結。這裡的 Schema 欄位都用小寫格式，從 Oracle API 中的資料屬性也都必須是小寫，否則<strong>預設的解析函式</strong>將無法解析。</p>
<p>記得要修改 schema/index.js 將新的 Schema 併接進來。</p>
<figure class="highlight javascript"><figcaption><span>schema/index.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> employeeSchema = <span class="built_in">require</span>(<span class="string">'./employee'</span>);</span><br><span class="line"><span class="keyword">const</span> departmentSchema = <span class="built_in">require</span>(<span class="string">'./department'</span>);</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = [</span><br><span class="line">  linkSchema, </span><br><span class="line">  userSchema, </span><br><span class="line">  employeeSchema, </span><br><span class="line">  departmentSchema, </span><br><span class="line">  photoSchema, </span><br><span class="line">  photoConnectionSchema, </span><br><span class="line">  subscriptionSchema</span><br><span class="line">];</span><br></pre></td></tr></table></figure>

<p>再來就是實作解析函式了:</p>
<figure class="highlight javascript"><figcaption><span>resolvers/department.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  Query: &#123;</span><br><span class="line">    totalDepartments: <span class="function">(<span class="params">parent, args, &#123; orademo &#125;</span>) =&gt;</span></span><br><span class="line">      orademo.department.findAll().then(<span class="function"><span class="params">result</span> =&gt;</span> result.rows.length ),</span><br><span class="line">    allDepartments: <span class="function">(<span class="params">parent, args, &#123; orademo &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> orademo.department.findAll()</span><br><span class="line">      .then(<span class="function"><span class="params">result</span> =&gt;</span> result.rows );</span><br><span class="line">    &#125;  </span><br><span class="line">  &#125;, </span><br><span class="line">  Department: &#123;</span><br><span class="line">    employees: <span class="function">(<span class="params">parent, &#123; job &#125;, &#123; orademo &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> orademo.employee</span><br><span class="line">        .findByDeptno(parent.deptno)</span><br><span class="line">        .then(<span class="function"><span class="params">result</span> =&gt;</span> &#123; </span><br><span class="line">          <span class="keyword">if</span> (<span class="keyword">typeof</span> job === <span class="string">'string'</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> result.rows.filter(<span class="function"><span class="params">value</span> =&gt;</span> value.job === job);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">return</span> result.rows</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>第 11 行 employees 欄位是資料庫中沒有的欄位，所以這裏要實作他的客製解析函式，他可選擇性的接受一個引數 job，可過濾職位型態。</p>
<figure class="highlight javascript"><figcaption><span>resolvers/employee.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  Query: &#123;</span><br><span class="line">    totalEmployees: <span class="function">(<span class="params">parent, args, &#123; orademo &#125;</span>) =&gt;</span></span><br><span class="line">      orademo.employee.findAll().then(<span class="function"><span class="params">result</span> =&gt;</span> result.rows.length),</span><br><span class="line">    allEmployees: <span class="function">(<span class="params">parent, args, &#123; orademo &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> orademo.employee.findAll()</span><br><span class="line">        .then(<span class="function"><span class="params">result</span> =&gt;</span> result.rows );</span><br><span class="line">    &#125;  </span><br><span class="line">  &#125;, </span><br><span class="line">  Employee: &#123;</span><br><span class="line">    department: <span class="function">(<span class="params">parent, args, &#123; orademo &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> orademo.department</span><br><span class="line">        .findByDeptno(parent.deptno)</span><br><span class="line">        .then(<span class="function"><span class="params">result</span> =&gt;</span> result.rows[<span class="number">0</span>] );</span><br><span class="line">    &#125;,</span><br><span class="line">    income: <span class="function">(<span class="params">parent</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">let</span> sal = !<span class="built_in">isNaN</span>(<span class="built_in">parseFloat</span>(parent.sal)) ? <span class="built_in">parseFloat</span>(parent.sal) : <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">let</span> comm = !<span class="built_in">isNaN</span>(<span class="built_in">parseFloat</span>(parent.comm)) ? <span class="built_in">parseFloat</span>(parent.comm) : <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">return</span> sal + comm;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>這裡則客製了兩個解析函式 department 與 income。記得也要將新增的兩個 resolvers 併接起來:</p>
<figure class="highlight javascript"><figcaption><span>resolvers/index.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">const</span> employeeResolvers = <span class="built_in">require</span>(<span class="string">'./employee'</span>);</span><br><span class="line"><span class="keyword">const</span> departmentResolvers = <span class="built_in">require</span>(<span class="string">'./department'</span>);</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = [</span><br><span class="line">  userResolvers, </span><br><span class="line">  photoResolvers,</span><br><span class="line">  employeeResolvers, </span><br><span class="line">  departmentResolvers,</span><br><span class="line">  photoConnectionResolvers, </span><br><span class="line">  subscriptionResolvers</span><br><span class="line">];</span><br></pre></td></tr></table></figure>

<p>可以測試 Query 了。</p>
<figure class="highlight plain"><figcaption><span>query departments</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">query departments &#123;</span><br><span class="line">  totalDepartments</span><br><span class="line">  allDepartments &#123;</span><br><span class="line">    dname</span><br><span class="line">    deptno</span><br><span class="line">    loc </span><br><span class="line">    employees</span><br><span class="line">    &#123;</span><br><span class="line">      ename</span><br><span class="line">      job</span><br><span class="line">      income</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>可以在 employees 欄位選擇性的加入 job 引數:</p>
<figure class="highlight plain"><figcaption><span>query departments</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">query departments &#123;</span><br><span class="line">  totalDepartments</span><br><span class="line">  allDepartments &#123;</span><br><span class="line">    dname</span><br><span class="line">    deptno</span><br><span class="line">    loc </span><br><span class="line">    employees(job: &quot;MANAGER&quot;)</span><br><span class="line">    &#123;</span><br><span class="line">      ename</span><br><span class="line">      job</span><br><span class="line">      income</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>這裡我只想知道主管是誰。</p>
<p>一樣可以測試一下 employee 查詢:</p>
<figure class="highlight plain"><figcaption><span>query employees</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">query Employees &#123;</span><br><span class="line">  totalEmployees</span><br><span class="line">  allEmployees &#123;</span><br><span class="line">    empno</span><br><span class="line">    ename</span><br><span class="line">    hiredate</span><br><span class="line">    income</span><br><span class="line">    department &#123;</span><br><span class="line">      dname</span><br><span class="line">      loc</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>這個 query 應該沒甚麼問題，他可以透過 department 欄位實作資料的連結，這在 GraphQL 中我們稱為 “邊” (Edges)，這與 SQL 裡的 join類似。在 SQL 中 join 越多，效能就會愈差，GraphQL 當然也不會有例外。GraphQL 也可以嵌套的連結，多層的嵌套可能會凍結伺服器的效能，要仔細評估一下。</p>
<p style="text-align: right;">接續下一篇 <a href="/2019/12/17/GraphQL-API-9/" title="建立 GraphQL API (9)">建立 GraphQL API (9)</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://1184yang.github.io/2019/12/09/GraphQL-API-8/" data-id="ckcpzj95u000r80vzl3ekia5y" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Apache-Kafka/">Apache Kafka</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/C/">C#</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/GraphQL/">GraphQL</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/JavaScript/">JavaScript</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Oracle/">Oracle</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/PostgreSQL/">PostgreSQL</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/RabbitMQ/">RabbitMQ</a></li></ul>
    </div>
  </div>


  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">July 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">June 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">May 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/07/13/Sequential-Execution/">Node.js 非同步控制流程模式 - 並行限制與循序執行</a>
          </li>
        
          <li>
            <a href="/2020/06/12/C-Entity-Framework-Core-2-0-and-PostgreSQL-Provider/">C# Entity Framework Core 2.0 and PostgreSQL Provider</a>
          </li>
        
          <li>
            <a href="/2020/06/04/C-Entity-Framework-Core-2-0-and-Oracle-Provider/">C# Entity Framework Core 2.0 and Oracle Provider</a>
          </li>
        
          <li>
            <a href="/2020/06/02/Kafka-RabbitMQ-Electron/">Apache Kafka 與 Electron-RabbitMQ Notification</a>
          </li>
        
          <li>
            <a href="/2020/05/21/Electron-Notification-Buzzer/">Desktop 桌面應用程式 Electron-RabbitMQ Notification</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 J.Y. Yang<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>