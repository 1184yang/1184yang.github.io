<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.9.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=EB Garamond:300,300italic,400,400italic,700,700italic|Cinzel Decorative:300,300italic,400,400italic,700,700italic|Noto Serif TC:300,300italic,400,400italic,700,700italic|Source Code Pro:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"1184yang.github.io","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12,"onmobile":true},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title">
<meta property="og:url" content="https://1184yang.github.io/index.html">
<meta property="og:site_name">
<meta property="og:locale" content="zh-TW">
<meta name="twitter:card" content="summary">
<meta name="twitter:title">

<link rel="canonical" href="https://1184yang.github.io/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-TW'
  };
</script>

  <title></title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切換導航欄">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title"></h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首頁</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>歸檔</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分類</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜尋
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜尋..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

  <a href="https://github.com/1184yang?tab=repositories" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://1184yang.github.io/2021/03/22/Asynchronously-initialized-module/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/1184yang.jpg">
      <meta itemprop="name" content="J.Y. Yang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/03/22/Asynchronously-initialized-module/" class="post-title-link" itemprop="url">Asynchronously initialized module (非同步初始化模塊)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2021-03-22 09:34:23" itemprop="dateCreated datePublished" datetime="2021-03-22T09:34:23+08:00">2021-03-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2021-05-19 10:18:15" itemprop="dateModified" datetime="2021-05-19T10:18:15+08:00">2021-05-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/JavaScript/" itemprop="url" rel="index"><span itemprop="name">JavaScript</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>在 Node.js 模塊系統的基本屬性 require( )是同步工作的，且 module.exports 不能設置為非同步。在 Node.js 核心模塊和許多 npm 軟件包中有些存在有同步 API 的主要原因之一，是在提供一種方便的替代方法，而這個替代方法主要用於<strong>初始化</strong>任務，而不是要取代原有的非同步 API 。</p>
<p>不幸的是，這並不總是可能的。 同步 API 可能並不總是可取得，尤其是對於在使用網絡組件的初始化階段，例如，執行握手協議(handshake protoclos)或檢索配置參數(configuration parameters)。 許多中間件系統的資料庫驅動程序和客戶端(例如消息隊列 message queues)也都有初始化階段的情況。</p>
<h3 id="經典解決方案"><a href="#經典解決方案" class="headerlink" title="經典解決方案"></a>經典解決方案</h3><p>讓我們舉個例子：一個名為 db 的模塊，該模塊連接到遠程資料庫。 只有在完成與資料庫伺服器的連接和握手之後，db 模塊才能接受請求。 在這種情況下，我們通常有兩個選擇：</p>
<ul>
<li>在開始使用模塊之前，確保已對其進行了初始化，否則需等待其初始化。 每當我們要在非同步模塊上調用操作時，都必須完成此過程：</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> db = <span class="built_in">require</span>(<span class="string">'aDb'</span>);   <span class="comment">//非同步模塊</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> <span class="title">findAll</span>(<span class="params">type, callback</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (db.connected) &#123;  <span class="comment">//is it initialized?</span></span><br><span class="line">    runFind();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    db.once(<span class="string">'connected'</span>, runFind);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">runFind</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    db.findAll(type, callback);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>使用 Dependency Injection（DI）而不是直接使用非同步模塊。這樣做，我們可以延遲某些模塊的初始化，直到它們的非同步依賴關係被完全初始化為止。 這種技術將管理模塊初始化的複雜性轉移到了另一個組件（通常是父組件）上。 在以下示例中，此組件是 app.js：</li>
</ul>
<figure class="highlight javascript"><figcaption><span>app.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> db = <span class="built_in">require</span>(<span class="string">'aDB'</span>);  <span class="comment">//非同步模塊</span></span><br><span class="line"><span class="keyword">const</span> findAllFactory = <span class="built_in">require</span>(<span class="string">'./findAll'</span>);</span><br><span class="line"></span><br><span class="line">db.on(<span class="string">'connected'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> findAll = findAllFactory(db);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><figcaption><span>findAll.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">db</span>) </span>&#123;</span><br><span class="line">  <span class="comment">//db is guaranteed to be initialized</span></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">findAll</span>(<span class="params">type, callback</span>) </span>&#123;</span><br><span class="line">    db.findAll(type, callback)</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第一種選擇將涉及大量的代碼數量，可能不會是好的選擇。另外，使用 DI 的第二個選項有時也不可取，在大型專案中，它可能很快變得過於復雜，尤其是如果手動完成並使用非同步初始化的模塊。</p>
<p>但是，我們將看到，還有第三種選擇，它使我們能夠輕鬆地將模塊與其依賴項的初始化狀態隔離開來。</p>
<h3 id="預初始化隊列-Preinitialization-queues"><a href="#預初始化隊列-Preinitialization-queues" class="headerlink" title="預初始化隊列(Preinitialization queues)"></a>預初始化隊列(Preinitialization queues)</h3><p>使模塊與依賴項的初始化狀態脫鉤的簡單模式包括使用隊列(queues)和命令模式(Command pattern)。 這個想法是保存尚未初始化的模塊所接收的所有操作(operations)，然後在完成所有初始化步驟後立即執行它們。</p>
<h5 id="實現非同步初始化的模塊"><a href="#實現非同步初始化的模塊" class="headerlink" title="實現非同步初始化的模塊"></a>實現非同步初始化的模塊</h5><p>為了展示這種簡單而有效的技術，讓我們構建一個小型測試應用程序； 沒什麼花哨的，只是可以驗證我們假設的東西，讓我們從創建一個非同步初始化的模塊 asyncModule.js 開始；稍後，我們將會將它實際用在 Oracle 資料庫上。</p>
<figure class="highlight javascript"><figcaption><span>asyncModule.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> asyncModule = <span class="built_in">module</span>.exports;</span><br><span class="line"></span><br><span class="line">asyncModule.initialized = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">asyncModule.initialize = <span class="function">(<span class="params">callback</span>) =&gt;</span> &#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    asyncModule.initialized = <span class="literal">true</span>;</span><br><span class="line">    callback();</span><br><span class="line">  &#125;, <span class="number">10000</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">asyncModule.tellMeSomething = <span class="function">(<span class="params">callback</span>) =&gt;</span> &#123;</span><br><span class="line">  process.nextTick(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>(!asyncModule.initialized) &#123;</span><br><span class="line">      <span class="keyword">return</span> callback(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"I don't have anythins to say right now"</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    callback(<span class="literal">null</span>, <span class="string">`Current time is: <span class="subst">$&#123;<span class="keyword">new</span> <span class="built_in">Date</span>()&#125;</span>`</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>在前面的代碼中，asynModule 嘗試展示非同步初始化的模塊的工作方式。它公開了 initialize( )方法，該方法在延遲 10 秒後將初始化變數設置為 true 並通知其 callback（對於實際情況來說 10 秒是很長的時間） 應用程序，但是對我們來說，可以突顯出任何的 race conditions）。另一個方法 tellMeSomething( ) 返回當前時間，但是如果模塊尚未初始化，則會產生錯誤。</p>
<p>下一步是根據我們剛剛創建的服務創建另一個模塊。 讓我們考慮一下在一個名為 routes.js 的文件中實現的簡單 HTTP 請求處理程序：</p>
<figure class="highlight javascript"><figcaption><span>routes.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> asyncModule = <span class="built_in">require</span>(<span class="string">'./asyncModule'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports.say = <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  asyncModule.tellMeSomething(<span class="function">(<span class="params">err, something</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">      res.writeHead(<span class="number">500</span>);</span><br><span class="line">      <span class="keyword">return</span> res.end(<span class="string">`Error: <span class="subst">$&#123;err.message&#125;</span>`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    res.writeHead(<span class="number">200</span>);</span><br><span class="line">    res.end(<span class="string">`I say: <span class="subst">$&#123;something&#125;</span>`</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>處理程序調用 asyncModule的tellMeSomething( )方法，然後將結果寫入 HTTP 回應中。 如我們所看到的，我們沒有對 asyncModule 的初始化狀態執行任何檢查，可以想像，這可能將導致問題。</p>
<p>現在，讓我們創建一個非常基本的 HTTP 服務器，僅使用核心 http 模塊。</p>
<figure class="highlight javascript"><figcaption><span>app.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"><span class="keyword">const</span> routes = <span class="built_in">require</span>(<span class="string">'./routes'</span>);</span><br><span class="line"><span class="keyword">const</span> asyncModule = <span class="built_in">require</span>(<span class="string">'./asyncModule'</span>);</span><br><span class="line"></span><br><span class="line">asyncModule.initialize(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Async module initialized.'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">http.createServer(<span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span>(req.method === <span class="string">'GET'</span> &amp;&amp; req.url === <span class="string">'/say'</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> routes.say(req, res);</span><br><span class="line">  &#125;</span><br><span class="line">  res.writeHead(<span class="number">404</span>);</span><br><span class="line">  res.end(<span class="string">'Not found'</span>);</span><br><span class="line">&#125;).listen(<span class="number">8000</span>, () =&gt; <span class="built_in">console</span>.log(<span class="string">'Started'</span>));</span><br></pre></td></tr></table></figure>

<p>前面的小模塊是我們應用程序的入口，它所做的只是觸發 asyncModule 的初始化，並創建一個 HTTP 服務器，該服務器利用我們先前創建的 routes.say( ) 的請求處理程序。</p>
<p>現在，我們可以像往常一樣通過執行 app.js 模塊來嘗試啟動服務器。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> node app.js</span></span><br></pre></td></tr></table></figure>

<p>服務器啟動後，我們可以嘗試使用瀏覽器訪問 URL <a href="http://localhost:8000/say" target="_blank" rel="noopener">http://localhost:8000/say</a> ，並查看 asyncModule 的返回結果。</p>
<blockquote>
<blockquote>
<p><strong>Error: I don’t have anythins to say right now</strong></p>
</blockquote>
</blockquote>
<p>這意味著 asyncModule 尚未初始化，但我們仍然嘗試使用它。根據非同步初始化的 Module 的實現細節，我們可能會收到一個錯誤，丟失重要信息甚至崩潰整個應用程序。</p>
<p>通常，必須完全避免剛剛描述的情況。在大多數情況下，初始化可能非常快速，不必擔心幾個失敗的請求，甚至在實踐中它可能永遠不會發生。但是，對於旨在自動擴展的高負載應用程序和雲服務器，這兩種不太可能發生錯誤的假設都必須完全避免。</p>
<h4 id="用預初始化隊列包裝模塊"><a href="#用預初始化隊列包裝模塊" class="headerlink" title="用預初始化隊列包裝模塊"></a>用預初始化隊列包裝模塊</h4><p>為了增加伺務器的穩健性，我們現在將重構它。我們將對尚未初始化而在 asyncModule 上調用的所有操作進行隊列化(queue)，直到準備好處理它們時再將隊列刷新。 這看起來像是 State 模式的絕佳應用！ 我們將需要兩種狀態，</p>
<ul>
<li>一種狀態是在模塊尚未初始化時將所有操作送入隊列。</li>
<li>另一種狀態是在初始化完成後將隊列中的每個操作直接執行原始 asyncModule 模塊中的操作。</li>
</ul>
<p>通常，我們沒有機會修改非同步模塊的代碼。 因此，要添加我們的隊列層，我們將需要圍繞原始 asyncModule 模塊創建一個代理 Proxy。</p>
<p>讓我們創建一個名為 asyncModuleWrapper.js 的新檔案，然後開始逐段構建它。 我們需要做的第一件事是創建<em>將操作委託給活動狀態的物件</em>：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> asyncModule = <span class="built_in">require</span>(<span class="string">'./asyncModule'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> asyncModuleWrapper = <span class="built_in">module</span>.exports;</span><br><span class="line"></span><br><span class="line">asyncModuleWrapper.initialized = <span class="literal">false</span>;</span><br><span class="line">asyncModuleWrapper.initialize = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  activeState.initialize.apply(activeState, <span class="built_in">arguments</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">asyncModuleWrapper.tellMeSomething = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  activeState.tellMeSomething.apply(activeState, <span class="built_in">arguments</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>在前面的代碼中，asyncModuleWrapper 簡單地將其每個方法委託給當前活動狀態(currently active state)。 從 notInitializedState 開始，讓我們看看這兩種狀態的樣子：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> pending = [];</span><br><span class="line"><span class="keyword">let</span> notInitializedState = &#123;</span><br><span class="line">  initialize: <span class="function"><span class="keyword">function</span> (<span class="params">callback</span>) </span>&#123;</span><br><span class="line">    asyncModule.initialize(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      asyncModuleWrapper.initalized = <span class="literal">true</span>;</span><br><span class="line">      activeState = initializedState;</span><br><span class="line">      </span><br><span class="line">      pending.forEach(<span class="function"><span class="params">req</span> =&gt;</span> &#123;</span><br><span class="line">        asyncModule[req.method].apply(<span class="literal">null</span>, req.args);</span><br><span class="line">      &#125;);</span><br><span class="line">      pending = [];</span><br><span class="line">      callback();</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  tellMeSomething: <span class="function"><span class="keyword">function</span> (<span class="params">callback</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> pending.push(&#123;</span><br><span class="line">      method: <span class="string">'tellMeSomething'</span>,</span><br><span class="line">      args: <span class="built_in">arguments</span></span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>當調用 initialize( )方法時，我們觸發原始 asyncModule 模塊的初始化(第 16 行)，並提供回調代理。 這使我們的包裝器知道何時初始化了原始模塊，並因此觸發了以下操作：</p>
<ol>
<li>第 18 行使用流程中的下一個狀態物件 initializedState 更新 activeState 變數。</li>
<li>第 20 行執行之前存儲在 pending 隊列中的所有操作指令。</li>
<li>第 24 行調用原始回調(callback)。</li>
</ol>
<p>開始時由於模塊尚未初始化，因此此狀態(notInitializedState)的 tellMeSomething( )方法簡單地創建一個新的 Command 物件將其添加到 pending 隊列的操作中。</p>
<p>此時，當原始 asyncModule 模塊尚未初始化時，模式應該已經很清楚了，我們的包裝器簡單地將所有接收到的請求送入 pending 隊列排隊。 然後，當通知我們初始化已完成時，我們將執行所有排隊的操作，然後將內部狀態切換為 initializedState。讓我們看看包裝的最後一部分是什麼樣子：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> initializedState = asyncModule;</span><br></pre></td></tr></table></figure>

<p>毫不奇怪，initializedState 物件只是對原始 asyncModule 的引用！ 實際上，初始化完成後，我們可以安全地將任何請求直接路由到原始模塊。 不需要什麼 Proxy 代理了。</p>
<p>最後，我們必須設置啟動這個模組的初始活動狀態，該狀態當然是 notInitializedState：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> activeState = notInitializedState;</span><br></pre></td></tr></table></figure>

<p>現在，我們可以嘗試再次啟動測試服務器，但首先，請不要忘記用新的 asyncModuleWrapper 物件替換對原始 asyncModule 模塊的引用； 這必須修改 app.js 和 routes.js 模塊。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">const</span> asyncModule = <span class="built_in">require</span>(<span class="string">'./asyncModuleWrapper'</span>);</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>完成此操作後，如果嘗試再次向服務器發送請求，我們將看到在 asyncModule 模塊尚未初始化的時間內，請求不會失敗； 相反，它們將等待直到初始化完成，然後才實際執行。 我們可以肯定地這是一個更加穩健的伺服器。</p>
<p>現在，我們的服務器可以在啟動後立即開始接受請求，並保證這些請求不會因其模塊的初始化狀態而失敗。 我們能夠獲得此結果，而無需使用 DI 或進行冗長且易於出錯的檢查來驗證非同步混淆的狀態。</p>
<h3 id="應用實例"><a href="#應用實例" class="headerlink" title="應用實例"></a>應用實例</h3><p>這種模式，如果模塊是非同步初始化的，將所有操作送入隊列，直到模塊完全初始化為止。許多資料庫驅動程序和 ORM 程式庫都使用該模式。不必等待資料庫的連接就可以發送查詢，因為每個操作都會先存到隊列中，然後在與資料庫的連接完全建立後再執行。</p>
<h4 id="Oracle-應用實例"><a href="#Oracle-應用實例" class="headerlink" title="Oracle 應用實例"></a>Oracle 應用實例</h4><p>這裡使用 Oracle XE，可以設定多個 Oracle Connection Pools。建議盡量使用 Connection Pools，效能較好，同時可以控制連線的數量。直接使用 Connection 方式，當同時湧入大量的需求，資料庫有可能就會崩潰。</p>
<figure class="highlight javascript"><figcaption><span>dbconfig.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  xepdb1: &#123;</span><br><span class="line">    user: <span class="string">"demo"</span>,</span><br><span class="line">    password: <span class="string">"demo6460"</span>,</span><br><span class="line">    connectString: <span class="string">"localhost:1521/xepdb1"</span>,</span><br><span class="line">    poolAlias: <span class="string">'xepdb1demo'</span>,</span><br><span class="line">    poolMin: <span class="number">2</span>,</span><br><span class="line">    poolMax: <span class="number">5</span>,</span><br><span class="line">    poolIncrement: <span class="number">1</span>,</span><br><span class="line">    queueMax: <span class="number">-1</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>這裡將 Oracle 資料庫驅動程式 node-oracledb 包裝在我們的模塊中。這與之前的 asyncModuleWrapper 模塊有相同的概念。這個模塊也分為兩種狀態，一種狀態是在模塊尚未初始化時將所有操作送入隊列，另一種狀態是在初始化完成後將每個操作直接執行原始 oracledb 模塊中的操作。</p>
<figure class="highlight javascript"><figcaption><span>database.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; EventEmitter &#125; = <span class="built_in">require</span>(<span class="string">'events'</span>);</span><br><span class="line"><span class="keyword">const</span> oracledb = <span class="built_in">require</span>(<span class="string">'oracledb'</span>);</span><br><span class="line"><span class="keyword">const</span> dbconfig = <span class="built_in">require</span>(<span class="string">'./dbconfig'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> METHODS_REQUIRING_CONNECTION = [<span class="string">'doExecute'</span>, <span class="string">'doExecuteMany'</span>];</span><br><span class="line"><span class="keyword">const</span> deactivate = <span class="built_in">Symbol</span>(<span class="string">'deactivate'</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">InitializedState</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(db) &#123;</span><br><span class="line">    <span class="keyword">this</span>.dbsPool = db.dbsPool;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> doExecute(poolAlias, statement, binds = [], opts = &#123;&#125;) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="keyword">async</span> (resolve, reject) =&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> conn;</span><br><span class="line">        opts.outFormat = oracledb.OBJECT;</span><br><span class="line">        opts.autoCommit = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          conn = <span class="keyword">await</span> oracledb.getConnection(<span class="keyword">this</span>.dbsPool[poolAlias]);</span><br><span class="line">          <span class="keyword">const</span> result = <span class="keyword">await</span> conn.execute(statement, binds, opts);</span><br><span class="line">          resolve(result);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (err) &#123; reject(&#123; <span class="attr">error</span>: err &#125;); &#125;</span><br><span class="line">        <span class="keyword">finally</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (conn) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">              <span class="keyword">await</span> conn.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (err) &#123; </span><br><span class="line">              <span class="built_in">console</span>.log(err);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> doExecuteMany(poolAlias, statement, binds = [], opts = &#123;&#125;) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="keyword">async</span> (resolve, reject) =&gt; &#123;</span><br><span class="line">      <span class="keyword">let</span> conn;</span><br><span class="line">      opts.outFormat = oracledb.OBJECT;</span><br><span class="line">      opts.autoCommit = <span class="literal">true</span>;</span><br><span class="line">      opts.batchErrors = <span class="literal">true</span>;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        conn = <span class="keyword">await</span> oracledb.getConnection(<span class="keyword">this</span>.dbsPool[poolAlias]);</span><br><span class="line">        <span class="keyword">const</span> result = <span class="keyword">await</span> conn.executeMany(statement, binds, opts);</span><br><span class="line">        resolve(result);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">catch</span> (err) &#123; reject(err); &#125;</span><br><span class="line">      <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (conn) &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123; </span><br><span class="line">            <span class="keyword">await</span> conn.close();</span><br><span class="line">          &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">            <span class="built_in">console</span>.log(err);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">QueuingState</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(db) &#123;</span><br><span class="line">    <span class="keyword">this</span>.db = db;</span><br><span class="line">    <span class="keyword">this</span>.commandsQueue = [];</span><br><span class="line"></span><br><span class="line">    METHODS_REQUIRING_CONNECTION.forEach(<span class="function"><span class="params">methodName</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>[methodName] = <span class="function"><span class="keyword">function</span> (<span class="params">...args</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'Command queued:'</span>, methodName, args);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">const</span> command = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">            db[methodName](...args)</span><br><span class="line">              .then(resolve, reject);</span><br><span class="line">          &#125;;</span><br><span class="line">          <span class="keyword">this</span>.commandsQueue.push(command);</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  [deactivate]() &#123;</span><br><span class="line">    <span class="keyword">this</span>.commandsQueue.forEach(<span class="function"><span class="params">command</span> =&gt;</span> command());</span><br><span class="line">    <span class="keyword">this</span>.commandsQueue = [];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DB</span> <span class="keyword">extends</span> <span class="title">EventEmitter</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>() &#123;</span><br><span class="line">    <span class="keyword">super</span>();</span><br><span class="line">    <span class="keyword">this</span>.dbsPool = &#123;&#125;;</span><br><span class="line">    <span class="keyword">this</span>.state = <span class="keyword">new</span> QueuingState(<span class="keyword">this</span>);</span><br><span class="line">  &#125; </span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> initialize() &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> db <span class="keyword">of</span> <span class="built_in">Object</span>.keys(dbconfig)) &#123;</span><br><span class="line">        <span class="keyword">let</span> config = dbconfig[db];</span><br><span class="line">        <span class="keyword">this</span>.dbsPool[config.poolAlias] = <span class="keyword">await</span> oracledb.createPool(config);</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">this</span>.initialized = <span class="literal">true</span>;</span><br><span class="line">      <span class="keyword">this</span>.emit(<span class="string">'initialized'</span>);</span><br><span class="line">      <span class="keyword">const</span> oldState = <span class="keyword">this</span>.state;</span><br><span class="line">      <span class="keyword">this</span>.state = <span class="keyword">new</span> InitializedState(<span class="keyword">this</span>);</span><br><span class="line">      oldState[deactivate] &amp;&amp; oldState[deactivate]();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(err);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> doExecute(poolAlias, statement, binds = [], opts = &#123;&#125;) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.state.doExecute(poolAlias, statement, binds, opts);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> doExecuteMany(poolAlias, statement, binds = [], opts = &#123;&#125;) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.state.doExecuteMany(poolAlias, statement, binds, opts);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> close() &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> db <span class="keyword">of</span> <span class="built_in">Object</span>.keys(dbconfig)) &#123;</span><br><span class="line">        <span class="keyword">await</span> oracledb.getPool(dbconfig[db].poolAlias).close();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(err);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="keyword">new</span> DB();</span><br></pre></td></tr></table></figure>

<p>第 8 行的 InitializedState 類與第 62 行的 QueuingState 類分別代表初始化完成後與尚未初始化的兩種狀態。</p>
<p>第 87 行的 DB 類是維一對外揭露的類，在建構式中第 91 行，開始是處於尚未初始化的 QueuingState。在這個狀態下，把所有的需求操作都送入 commandsQueue 陣列中，尚未實際調用資料庫驅動程式對資料庫提出需求，因為此時尚未完成 Connection Pools 的創建。</p>
<p>第 94 行 initialize( ) 方法開始創建 Oracle Connection Pools，在創建 Connection Pools 完成後，在第 104 行將狀態切換到初始化完成後的 InitializedState。在這之後所有的需求操作都會直接調用資料庫驅動程式 oracledb 對資料庫提出需求，不再需要使用 QueuingState。</p>
<p>先來測試看看，第 3 行在開始初始化時，我們並沒有等到 Connection Pools 完成，主程式就繼續往下執行，馬上對資料庫提出需求操作。</p>
<figure class="highlight javascript"><figcaption><span>simpleTest.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> oradb = <span class="built_in">require</span>(<span class="string">'./database'</span>);</span><br><span class="line"></span><br><span class="line">oradb.initialize();</span><br><span class="line">oradb.on(<span class="string">'initialized'</span>, () =&gt; <span class="built_in">console</span>.log(<span class="string">'Database initialized.'</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> statement = <span class="string">'select * from emp where empno = :empno'</span>;</span><br><span class="line"></span><br><span class="line">doExecute(<span class="string">"xepdb1demo"</span>, statement, [<span class="number">7788</span>]);</span><br><span class="line">doExecute(<span class="string">"xepdb1demo"</span>, statement, [<span class="number">7934</span>]);</span><br><span class="line"><span class="comment">//employees();</span></span><br><span class="line"></span><br><span class="line">setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  doExecute(<span class="string">"xepdb1demo"</span>, statement, [<span class="number">7782</span>]);</span><br><span class="line">  doExecute(<span class="string">"xepdb1demo"</span>, statement, [<span class="number">7876</span>]);</span><br><span class="line">&#125;, <span class="number">500</span>);</span><br><span class="line"></span><br><span class="line">setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> oradb.close(), <span class="number">30000</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">doExecute</span>(<span class="params">dbpool, statement, binds</span>) </span>&#123;  </span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> oradb.doExecute(dbpool, statement, binds);</span><br><span class="line">    <span class="built_in">console</span>.log(result);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(err);</span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">doExecuteMany</span>(<span class="params">dbpool, statement, binds</span>) </span>&#123;  </span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> oradb.doExecuteMany(dbpool, statement, binds);</span><br><span class="line">    <span class="built_in">console</span>.log(result);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(err);</span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">employees</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> dbpool = <span class="string">"xepdb1demo"</span>;</span><br><span class="line">  <span class="keyword">const</span> statement = <span class="string">'select * from emp'</span>;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> oradb.doExecute(dbpool, statement);</span><br><span class="line">    <span class="built_in">console</span>.log(result);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(err);</span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>現在將它實際應用在伺服器上，讓我們創建一個非常基本的 HTTP 服務器來使用 Oracle Database。</p>
<figure class="highlight javascript"><figcaption><span>routes.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> oradb = <span class="built_in">require</span>(<span class="string">'./database'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports.listEmployees = <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> dbpool = <span class="string">"xepdb1demo"</span>;</span><br><span class="line">  <span class="keyword">const</span> statement = <span class="string">'select * from emp'</span>;</span><br><span class="line"></span><br><span class="line">  oradb.doExecute(dbpool, statement)</span><br><span class="line">    .then(<span class="function"><span class="params">result</span> =&gt;</span> &#123;</span><br><span class="line">      res.writeHead(<span class="number">200</span>, &#123;<span class="string">'Content-Type'</span>: <span class="string">'application/json; charset=utf8'</span>&#125;);</span><br><span class="line">      res.end(<span class="built_in">JSON</span>.stringify(result));</span><br><span class="line">    &#125;)</span><br><span class="line">    .catch(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">      res.writeHead(<span class="number">500</span>);</span><br><span class="line">      <span class="keyword">return</span> res.end(<span class="string">`Error: <span class="subst">$&#123;err.message&#125;</span>`</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><figcaption><span>app.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"><span class="keyword">const</span> routes = <span class="built_in">require</span>(<span class="string">'./routes'</span>);</span><br><span class="line"><span class="keyword">const</span> oradb = <span class="built_in">require</span>(<span class="string">'./database'</span>);</span><br><span class="line"></span><br><span class="line">oradb.initialize();</span><br><span class="line">oradb.on(<span class="string">'initialized'</span>, () =&gt; <span class="built_in">console</span>.log(<span class="string">'Database initialized.'</span>));</span><br><span class="line"></span><br><span class="line">http.createServer(<span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span>(req.method === <span class="string">'GET'</span> &amp;&amp; req.url === <span class="string">'/employees'</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> routes.listEmployees(req, res);</span><br><span class="line">  &#125;</span><br><span class="line">  res.writeHead(<span class="number">404</span>);</span><br><span class="line">  res.end(<span class="string">'Not found'</span>);</span><br><span class="line">&#125;).listen(<span class="number">8000</span>, () =&gt; <span class="built_in">console</span>.log(<span class="string">'Started'</span>));</span><br></pre></td></tr></table></figure>

<p>That is it.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://1184yang.github.io/2021/02/23/VS-Code-Remote-Development-using-SSH/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/1184yang.jpg">
      <meta itemprop="name" content="J.Y. Yang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/02/23/VS-Code-Remote-Development-using-SSH/" class="post-title-link" itemprop="url">VS Code Remote Development using SSH</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>
              

              <time title="創建時間：2021-02-23 14:06:03 / 修改時間：18:26:43" itemprop="dateCreated datePublished" datetime="2021-02-23T14:06:03+08:00">2021-02-23</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>通常我們使用 Node.js 開發的專案最後都會將它佈署到 Linux 伺服器上，而 Linux 伺服器通常都不會安裝 GUI 操作介面，有時想要簡單的&gt;更改檔案的內容，對於 vi 又不熟悉，實在是大費周章。這裡就示範如何使用 Windows 上的 VS Code 連線到 Linux 伺服器，直接修改 Linux 伺服器上的檔案。如有必要，也可直接下 Linux 指令。</p>
<h3 id="VS-Code-Remote-SSH-Extension"><a href="#VS-Code-Remote-SSH-Extension" class="headerlink" title="VS Code Remote-SSH Extension"></a>VS Code Remote-SSH Extension</h3><p>這裡要使用的是 VS Code 的 Remote-SSH Extension。</p>
<img src="/2021/02/23/VS-Code-Remote-Development-using-SSH/20210223-01.png" title="Remote-SSH Extension">

<p>安裝了 Remote-SSH Extension 之後 VS Code 的左下角會出現一個符號。</p>
<img src="/2021/02/23/VS-Code-Remote-Development-using-SSH/20210223-02.png" title="Remote-SSH Extension">

<p>按一下這個符號，VS Code 上方會出現所要選擇使用的功能。</p>
<img src="/2021/02/23/VS-Code-Remote-Development-using-SSH/20210223-03.png" title="Remote-SSH Extension">

<p>這裡選擇 <strong>Remote-SSH: Connect to Host…</strong> 這會開啟另外一個 Window 視窗，然後要求你輸入使用者與伺服器名稱。</p>
<img src="/2021/02/23/VS-Code-Remote-Development-using-SSH/20210223-04.png" title="Remote-SSH Extension">

<p>如果 VS Code 無法自動檢測到您要連接的服務器的類型，會要求您手動選擇類型。</p>
<img src="/2021/02/23/VS-Code-Remote-Development-using-SSH/20210223-13.png" title="Remote-SSH Extension">

<p>輸入密碼。</p>
<img src="/2021/02/23/VS-Code-Remote-Development-using-SSH/20210223-05.png" title="Remote-SSH Extension">

<p>如果連線成功，左下角的 Status 將會出現連線的伺服器。</p>
<img src="/2021/02/23/VS-Code-Remote-Development-using-SSH/20210223-06.png" title="Remote-SSH Extension">

<p>現在你可以使用 VS Code 打開文件夾。</p>
<img src="/2021/02/23/VS-Code-Remote-Development-using-SSH/20210223-07.png" title="Remote-SSH Extension">

<p>選擇文件夾，然後按 OK。</p>
<img src="/2021/02/23/VS-Code-Remote-Development-using-SSH/20210223-08.png" title="Remote-SSH Extension">

<p>每次選擇一個新的文件夾都會要求你再度輸入密碼。</p>
<img src="/2021/02/23/VS-Code-Remote-Development-using-SSH/20210223-09.png" title="Remote-SSH Extension">

<p>現在你可以像使用 Local 端的檔案夾一樣，使用 VS Code 編輯檔案。</p>
<img src="/2021/02/23/VS-Code-Remote-Development-using-SSH/20210223-10.png" title="Remote-SSH Extension">

<p>你也可以開啟一個終端螢幕。</p>
<img src="/2021/02/23/VS-Code-Remote-Development-using-SSH/20210223-11.png" title="Remote-SSH Extension">

<p>可以使用這個終端螢幕下 Linux 伺服器指令，就像使用 Putty 連到 Linux 伺服器一樣。</p>
<img src="/2021/02/23/VS-Code-Remote-Development-using-SSH/20210223-12.png" title="Remote-SSH Extension">

<p>要離線請選擇 File &gt; Close Remote Connection。</p>
<img src="/2021/02/23/VS-Code-Remote-Development-using-SSH/20210223-14.png" title="Remote-SSH Extension">

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://1184yang.github.io/2020/12/28/Oracle-Advanced-Queuing-Using-Node-js/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/1184yang.jpg">
      <meta itemprop="name" content="J.Y. Yang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/12/28/Oracle-Advanced-Queuing-Using-Node-js/" class="post-title-link" itemprop="url">Oracle Advanced Queuing Using Node.js</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2020-12-28 13:47:18" itemprop="dateCreated datePublished" datetime="2020-12-28T13:47:18+08:00">2020-12-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2021-02-20 07:28:37" itemprop="dateModified" datetime="2021-02-20T07:28:37+08:00">2021-02-20</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/JavaScript/" itemprop="url" rel="index"><span itemprop="name">JavaScript</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Oracle/" itemprop="url" rel="index"><span itemprop="name">Oracle</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>是的! 你沒有看錯標題。Oracle AQ 也跨出了資料庫。在 node-oracledb 4.0 中引入了用於 AQ 的 Node-oracledb API。</p>
<p>Oracle AQ 的運作已有一段時間了，基本運作方式大家都很熟了，這裡直接看範例，讓 AQ 走出 Oracle 資料庫。</p>
<h3 id="Create-and-Start-Queue"><a href="#Create-and-Start-Queue" class="headerlink" title="Create and Start Queue"></a>Create and Start Queue</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* For the data we want to queue */</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> <span class="keyword">REPLACE</span> <span class="keyword">TYPE</span> demo_msg_type <span class="keyword">AS</span> <span class="keyword">OBJECT</span> (</span><br><span class="line">  subject  <span class="built_in">VARCHAR2</span>(<span class="number">30</span>),</span><br><span class="line">  <span class="built_in">text</span>     <span class="built_in">VARCHAR2</span>(<span class="number">100</span>)</span><br><span class="line">)</span><br><span class="line">/</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Create and start a queue</span></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line"> DBMS_AQADM.CREATE_QUEUE_TABLE(</span><br><span class="line">   QUEUE_TABLE        =&gt;  <span class="string">'DEMO.DEMO_MSG_QUEUE_TAB'</span>,</span><br><span class="line">   QUEUE_PAYLOAD_TYPE =&gt;  <span class="string">'DEMO.DEMO_MSG_TYPE'</span>);</span><br><span class="line"></span><br><span class="line"> DBMS_AQADM.CREATE_QUEUE(</span><br><span class="line">   QUEUE_NAME         =&gt;  'DEMO.DEMO_MSG_QUEUE',</span><br><span class="line">   QUEUE_TABLE        =&gt;  'DEMO.DEMO_MSG_QUEUE_TAB');</span><br><span class="line"></span><br><span class="line"> DBMS_AQADM.START_QUEUE(</span><br><span class="line">   QUEUE_NAME         =&gt; 'DEMO.DEMO_MSG_QUEUE',</span><br><span class="line">   ENQUEUE            =&gt; TRUE);</span><br><span class="line"><span class="keyword">END</span>;</span><br><span class="line">/</span><br></pre></td></tr></table></figure>

<h3 id="Enqueue"><a href="#Enqueue" class="headerlink" title="Enqueue"></a>Enqueue</h3><figure class="highlight js"><figcaption><span>demo-enq.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> oracledb = <span class="built_in">require</span>(<span class="string">'oracledb'</span>);</span><br><span class="line"><span class="keyword">const</span> dbConfig = &#123;</span><br><span class="line">  user: <span class="string">"demo"</span>,</span><br><span class="line">  password: <span class="string">"secret"</span>,</span><br><span class="line">  connectString: <span class="string">"10.11.25.139:1522/db99.example.com"</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> queueName = <span class="string">"DEMO_MSG_QUEUE"</span>;</span><br><span class="line"></span><br><span class="line">enqueue();</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">enqueue</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> connection;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    connection = <span class="keyword">await</span> oracledb.getConnection(dbConfig); </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">const</span> queue = <span class="keyword">await</span> connection.getQueue(queueName, &#123; <span class="attr">payloadType</span>: <span class="string">"DEMO.DEMO_MSG_TYPE"</span> &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> message = <span class="keyword">new</span> queue.payloadTypeClass(</span><br><span class="line">      &#123;</span><br><span class="line">        SUBJECT: <span class="string">"Node.js AQ 範例"</span>,</span><br><span class="line">        TEXT: <span class="string">`Hello Tainan, 台南! <span class="subst">$&#123;<span class="built_in">Date</span>()&#125;</span>`</span></span><br><span class="line">      &#125;</span><br><span class="line">    );</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`Enqueuing:  <span class="subst">$&#123;message&#125;</span>`</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">await</span> queue.enqOne(message);</span><br><span class="line">    <span class="keyword">await</span> connection.commit();</span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    <span class="built_in">console</span>.error(err);</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (connection) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">await</span> connection.close();</span><br><span class="line">      &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">        <span class="built_in">console</span>.error(err);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Dequeue"><a href="#Dequeue" class="headerlink" title="Dequeue"></a>Dequeue</h3><figure class="highlight js"><figcaption><span>demo-deq.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> oracledb = <span class="built_in">require</span>(<span class="string">'oracledb'</span>);</span><br><span class="line"><span class="keyword">const</span> dbConfig = &#123;</span><br><span class="line">  user: <span class="string">"demo"</span>,</span><br><span class="line">  password: <span class="string">"secret"</span>,</span><br><span class="line">  connectString: <span class="string">"10.11.25.139:1522/db99.example.com"</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> queueName = <span class="string">"DEMO_MSG_QUEUE"</span>;</span><br><span class="line"></span><br><span class="line">dequeue();</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">dequeue</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> connection;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    connection = <span class="keyword">await</span> oracledb.getConnection(dbConfig); </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">const</span> queue = <span class="keyword">await</span> connection.getQueue(queueName, &#123; <span class="attr">payloadType</span>: <span class="string">"DEMO.DEMO_MSG_TYPE"</span> &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> msg = <span class="keyword">await</span> queue.deqOne();</span><br><span class="line">    <span class="keyword">if</span> (msg) &#123;</span><br><span class="line">      <span class="comment">// do something here.</span></span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'Dequeued: '</span> + msg.payload);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> connection.commit();</span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    <span class="built_in">console</span>.error(err);</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (connection) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">await</span> connection.close();</span><br><span class="line">      &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">        <span class="built_in">console</span>.error(err);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>現在可以傳送資料了。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> node demo-enq</span></span><br><span class="line">Enqueuing:  [DEMO.DEMO_MSG_TYPE] &#123;</span><br><span class="line">  SUBJECT: 'Node.js AQ 範例',</span><br><span class="line">  TEXT: 'Hello Tainan, 台南! Tue Dec 29 2020 09:52:19 GMT+0800 (GMT+08:00)'</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接收資料:</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> node demo-deq</span></span><br><span class="line">Dequeued: [DEMO.DEMO_MSG_TYPE] &#123;</span><br><span class="line">  SUBJECT: 'Node.js AQ 範例',</span><br><span class="line">  TEXT: 'Hello Tainan, 台南! Tue Dec 29 2020 09:52:19 GMT+0800 (GMT+08:00)'</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果你先 run dequeue， 預設情況下，deqOne( ) 將等待直到接收到消息。</p>
<p>這裡的 dequeue 一次接收一筆資料，我們也可以註冊一個 notification。</p>
<h3 id="Register-notification"><a href="#Register-notification" class="headerlink" title="Register notification"></a>Register notification</h3><p>這裡的 Notification 就像 Apache Kafka 與 RabbitMQ 的 Consumer 一樣。註冊方式與使用 Oracle CQN 一樣，細節請參考 <a href="/2020/12/25/Oracle-CQN-Using-Node-js/">Oracle CQN Using Node.js</a>。註冊時一樣要設定事件處理程式 (Notification handler) 一般都稱呼為 Callback 函數。這觀念與使用 PL/SQL 是一樣的。</p>
<figure class="highlight js"><figcaption><span>demo-notify.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> oracledb = <span class="built_in">require</span>(<span class="string">'oracledb'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> dbConfig = &#123;</span><br><span class="line">  user: <span class="string">"demo"</span>,</span><br><span class="line">  password: <span class="string">"secret"</span>,</span><br><span class="line">  connectString: <span class="string">"10.11.25.139:1522/db99.example.com"</span>,</span><br><span class="line">  poolAlias: <span class="string">'db99demo'</span>,</span><br><span class="line">  poolMin: <span class="number">1</span>,</span><br><span class="line">  poolMax: <span class="number">2</span>,</span><br><span class="line">  poolIncrement: <span class="number">1</span>,</span><br><span class="line">  queueMax: <span class="number">-1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">startup();  </span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">startup</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">await</span> oracledb.createPool(dbConfig);  </span><br><span class="line">    </span><br><span class="line">    registerAndNotify(); </span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(err);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">registerAndNotify</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> config = &#123;</span><br><span class="line">    user: dbConfig.user,</span><br><span class="line">    password: dbConfig.password,</span><br><span class="line">    connectString: dbConfig.connectString,</span><br><span class="line">    events: <span class="literal">true</span>     <span class="comment">/* 與使用 CQN 一樣，必須為 true, 預設值 false */</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> queueName = <span class="string">"DEMO_MSG_QUEUE"</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> subscrOptions = &#123;</span><br><span class="line">    namespace: oracledb.SUBSCR_NAMESPACE_AQ,</span><br><span class="line">    callback: notifyCallback,     <span class="comment">/* 事件處理程式 (Notification handler) 一般都稱呼為 Callback 函數 */</span></span><br><span class="line">    timeout: <span class="number">600</span>                  <span class="comment">/* 因是測試，設定 600 秒後會自動撤銷註冊 */</span></span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> connection;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    connection = <span class="keyword">await</span> oracledb.getConnection(config); </span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> connection.subscribe(queueName, subscrOptions);     <span class="comment">/* 調用 subscribe() 註冊 */</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"AQ notification created..."</span>);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    <span class="built_in">console</span>.error(err);</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (connection) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">await</span> connection.close();     <span class="comment">/* 註完冊後，就可以關閉這個 connection */</span></span><br><span class="line">      &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">        <span class="built_in">console</span>.error(err);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">notifyCallback</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"event type:"</span>, event.type);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (event.type == oracledb.SUBSCR_EVENT_TYPE_DEREG) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"Deregistration has taken place..."</span>);     <span class="comment">/* Subscription closed or timeout */</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    connection = <span class="keyword">await</span> oracledb.getConnection(dbConfig.poolAlias);  <span class="comment">/* 使用先前創建的 connection pool */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> queue = <span class="keyword">await</span> connection.getQueue(event.queueName, &#123; <span class="attr">payloadType</span>: <span class="string">"DEMO.DEMO_MSG_TYPE"</span> &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> msg = <span class="keyword">await</span> queue.deqOne();</span><br><span class="line">    <span class="keyword">if</span> (msg) &#123;</span><br><span class="line">      <span class="comment">// do something here.</span></span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'Dequeued: '</span> + msg.payload);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">await</span> connection.commit();     <span class="comment">/* 成功處理後，記得要 commit，才會從 Queue 移除 */</span></span><br><span class="line">  &#125; </span><br><span class="line">  <span class="keyword">catch</span> (err) &#123; <span class="built_in">console</span>.log(err) &#125;</span><br><span class="line">  <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (connection) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">await</span> connection.close();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">catch</span> (err) &#123; <span class="built_in">console</span>.log(err); &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">process</span><br><span class="line">  .on(<span class="string">'SIGTERM'</span>, () =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"\nTerminating"</span>);</span><br><span class="line">    oracledb.getPool(dbConfig.poolAlias).close();</span><br><span class="line">    process.exit(<span class="number">0</span>);</span><br><span class="line">  &#125;)</span><br><span class="line">  .on(<span class="string">'SIGINT'</span>, () =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"\nTerminating"</span>);</span><br><span class="line">    oracledb.getPool(dbConfig.poolAlias).close();</span><br><span class="line">    process.exit(<span class="number">0</span>);</span><br><span class="line">  &#125;)</span><br><span class="line">  .on(<span class="string">'unhandledRejection'</span>, err =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"\nUnhandledRejection exception"</span>);</span><br><span class="line">    oracledb.getPool(dbConfig.poolAlias).close();</span><br><span class="line">    <span class="built_in">console</span>.log(err);</span><br><span class="line">    process.exit(<span class="number">1</span>);</span><br><span class="line">  &#125;)</span><br><span class="line">  .on(<span class="string">'uncaughtException'</span>, err =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"\nUncaught exception"</span>);</span><br><span class="line">    oracledb.getPool(dbConfig.poolAlias).close();</span><br><span class="line">    <span class="built_in">console</span>.log(err);</span><br><span class="line">    process.exit(<span class="number">1</span>);</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>

<p>現在啟動 notification，它會一直等待接收消息。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> node demo-notify</span></span><br><span class="line">AQ notification created...</span><br></pre></td></tr></table></figure>

<p>Enqueue 一筆資料:</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> node demo-enq</span></span><br><span class="line">Enqueuing:  [DEMO.DEMO_MSG_TYPE] &#123;</span><br><span class="line">  SUBJECT: 'Node.js AQ 範例',</span><br><span class="line">  TEXT: 'Hello Tainan, 台南! Tue Dec 29 2020 10:33:36 GMT+0800 (GMT+08:00)'</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>事件處理程式馬上收到消息，然後繼續等待消息。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> node demo-notify</span></span><br><span class="line">AQ notification created...</span><br><span class="line">Dequeued: [DEMO.DEMO_MSG_TYPE] &#123;</span><br><span class="line">  SUBJECT: 'Node.js AQ 範例',</span><br><span class="line">  TEXT: 'Hello Tainan, 台南! Tue Dec 29 2020 10:33:36 GMT+0800 (GMT+08:00)'</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>現在從 Oracle 資料庫使用 PLSQL Enqueue 一筆資料。</p>
<figure class="highlight shell"><figcaption><span>demo_msg_enqueue.sql</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">CREATE OR REPLACE PROCEDURE demo_msg_enqueue( msg_in IN VARCHAR2 )</span><br><span class="line">AS</span><br><span class="line">  enqueue_options    DBMS_AQ.ENQUEUE_OPTIONS_T;</span><br><span class="line">  message_properties DBMS_AQ.MESSAGE_PROPERTIES_T;</span><br><span class="line">  message_handle     RAW(16);</span><br><span class="line">  message            DEMO.DEMO_MSG_TYPE;</span><br><span class="line">BEGIN</span><br><span class="line">  message := DEMO.DEMO_MSG_TYPE('Node.js AQ 範例 from PLSQL',  msg_in || ' ' ||  TO_CHAR(sysdate, 'yyyy-mm-dd hh24:mi:ss'));</span><br><span class="line"></span><br><span class="line">  DBMS_AQ.ENQUEUE(</span><br><span class="line">    queue_name         =&gt; 'DEMO.DEMO_MSG_QUEUE',</span><br><span class="line">    enqueue_options    =&gt; enqueue_options,</span><br><span class="line">    message_properties =&gt; message_properties,</span><br><span class="line">    payload            =&gt; message,</span><br><span class="line">    msgid              =&gt; message_handle</span><br><span class="line">  );</span><br><span class="line">END;</span><br><span class="line">/</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><figcaption><span>demo_msg_enqueue.sql</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">SQL&gt;</span><span class="bash"> <span class="built_in">exec</span> demo_msg_enqueue(<span class="string">'Hello Tainan, 台南!'</span>);</span></span><br><span class="line"></span><br><span class="line">PL/SQL procedure successfully completed.</span><br><span class="line"></span><br><span class="line"><span class="meta">SQL&gt;</span><span class="bash"> commit;</span></span><br><span class="line"></span><br><span class="line">Commit complete.</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> node demo-notify</span></span><br><span class="line">AQ notification created...</span><br><span class="line">Dequeued: [DEMO.DEMO_MSG_TYPE] &#123;</span><br><span class="line">  SUBJECT: 'Node.js AQ 範例',</span><br><span class="line">  TEXT: 'Hello Tainan, 台南! Tue Dec 29 2020 10:33:36 GMT+0800 (GMT+08:00)'</span><br><span class="line">&#125;</span><br><span class="line">Dequeued: [DEMO.DEMO_MSG_TYPE] &#123;</span><br><span class="line">  SUBJECT: 'Node.js AQ 範例 from PLSQL',</span><br><span class="line">  TEXT: 'Hello Tainan, 台南! 2020-12-29 10:46:52'</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>現在你可以即時的將資料庫外的資料用 Node.js enqueue，然後用 PLSQL dequeue 傳入 Oracle 資料庫。相反的，可以用 PLSQL enqueue，然後使用 Node.js dequeue 即時的讓資料庫內的資料傳出資料庫。</p>
<p>Oracle 努力的讓資料庫裡的物件 (Things) 能與外界的物件溝通，使用傳統的 UTL_HTTP 在組合 JSON 格式的資料，實在是一種夢靨。現在你有了另一種選擇了。</p>
<p>除了 Apache Kafka、RabbitMQ 之外，你又多了一些選擇可以讓 Oracle 資料庫中的物件 (Things) 即時 (Read-Time) 的走出 Oracle 資料庫。你一定得試試看!</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://1184yang.github.io/2020/12/25/Oracle-CQN-Using-Node-js/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/1184yang.jpg">
      <meta itemprop="name" content="J.Y. Yang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/12/25/Oracle-CQN-Using-Node-js/" class="post-title-link" itemprop="url">Oracle CQN Using Node.js</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2020-12-25 13:09:38" itemprop="dateCreated datePublished" datetime="2020-12-25T13:09:38+08:00">2020-12-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2021-02-20 07:28:37" itemprop="dateModified" datetime="2021-02-20T07:28:37+08:00">2021-02-20</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/JavaScript/" itemprop="url" rel="index"><span itemprop="name">JavaScript</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Oracle/" itemprop="url" rel="index"><span itemprop="name">Oracle</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>WoT (Web of Things) 是 IoT (Internet of Things 物聯網) 的 Application 層，就是使用 Web 技術來打造 application。也就是說，IoT + Web-enabled technologies 就是 WoT。對 WoT 來說，最重要的觀念，就是以 URL 來表示 IoT 裝置；為 IoT 加入 URL 的觀念，就是 Google 提出的 Physical Web 計畫。</p>
<p>未來每個物件 (Objects) 全部都會和 Web 結合, 而首要條件就是所謂的 Things 必須是可以和 Web 溝通的裝置, 這些智慧裝置之間也能透過 Web 標準來互相溝通。WoT 重點在於使用 Web 的軟體標準和框架, 例如 REST, HTTP 和 URI 來建立應用程式以及服務, 並和其他裝置做溝通, 簡單來說就是日常生活所有的東西都可以存取 Web, 就是 WoT 的精隨。</p>
<p>除了能夠相互溝通，時間性當然也很重要，Real-time 數據越來越受歡迎。基本思路很簡單：<br>當物件發生變化時，任何查看物件數據的客戶端都應立即能看得到異動。最初，在 Web 應用程式中模擬 real-time 數據的唯一方法是從瀏覽器每隔一段固定的時間不斷循環的從 Web 服務器抓取資料 (Polling)。 這通常很複雜，難以擴大應用。WebSocket，改變了這種狀況，這是一種以高效率的方式在瀏覽器和 Web 服務器之間提供雙向通信的協議。</p>
<p>Oracle Database 的 UTL_HTTP 是傳統上與外界 Web 溝通的方式，後來加入了 ORDS，努力的讓資料庫裡的物件 (Things) 能與外界的物件溝通，但這仍無法主動的通知資料庫內資料的異動，你可以使用 Trigger 加上 AQ，但這些微的資料庫資料變化仍很難跨出資料庫，Continuous Query Notification (CQN) 則改變了這個狀況。</p>
<p>之前介紹了 <a href="/2020/12/24/Oracle-CQN/">Oracle Continuous Query Notification (CQN)</a>，使用 PL/SQL API 為事件處理程式 (Handler)。Oracle 在 Node.js 的程式庫 node-oracledb 則使其功能更強大，它讓 CQN 跨出了 Oracle 資料庫。</p>
<p>基本觀念及使用與 PL/SQL API 一樣。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* Notification Handler 通常稱 為 callback */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">demoCallback</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(event);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 註冊 Query 與 callback 函數。註冊後，Node.js 程式會一直等待資料庫發出的事件通知 */</span></span><br><span class="line">connection.subscribe(<span class="string">'demosub'</span>, &#123;</span><br><span class="line">  sql: <span class="string">"SELECT sal, comm FROM emp WHERE deptno = 10"</span>,</span><br><span class="line">  callback: demoCallback,</span><br><span class="line">  qos: oracledb.SUBSCR_QOS_QUERY | oracledb.SUBSCR_QOS_ROWIDS</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>相較於使用 Kafka 或 RabbitMQ，node-oracledb 的 CQN API，不需另外架構 Server，只需在一台不會關機的機器上啟動你的 Node.js Client 程式，就像 Kafka 或 RabbitMQ Consumer 一樣。</p>
<p>另外當然需要 JavaScript 技術，JavaScript 在這股 WoT 的潮流中佔有非常重要的地位，強烈建議，除了 PL/SQL，JavaScript 是你現在必須要熟悉的技術。</p>
<h3 id="範例"><a href="#範例" class="headerlink" title="範例"></a>範例</h3><p>程式碼看起來有點長，因為要示範的關係，將所有程式碼放在一個資料檔上，你可以將它模組化。</p>
<p>首先你需要建立一個 Node.js 專案資料夾，然後安裝 oracle <a href="https://github.com/oracle/node-oracledb" target="_blank" rel="noopener">node-oracledb</a>。</p>
<figure class="highlight javascript"><figcaption><span>demo-cqn.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> oracledb = <span class="built_in">require</span>(<span class="string">'oracledb'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> dbConfig = &#123;</span><br><span class="line">  user: <span class="string">"demo"</span>,</span><br><span class="line">  password: <span class="string">"secret"</span>,</span><br><span class="line">  connectString: <span class="string">"10.11.25.139:1522/db99.example.com"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> oradb = database();    <span class="comment">/* 這可以模組化，用來創建個 Oracle connection pool, 與執行 statement 的 API */</span></span><br><span class="line"></span><br><span class="line">startup();     <span class="comment">/* 啟動後 Node.js process 就會一直等待事件的通知，直到 Timeout (如果有設定) */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">startup</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">await</span> oradb.initialize();     <span class="comment">/* Create Oracle Connection Pool */</span></span><br><span class="line">  <span class="keyword">await</span> registerQuery();        <span class="comment">/* 註冊 CQN Query */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">registerQuery</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> config = &#123;</span><br><span class="line">    ...dbConfig,</span><br><span class="line">    events: <span class="literal">true</span>     <span class="comment">/* 使用 CQN subscribe events 模式必須為 true, 預設值 false */</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> options = &#123;</span><br><span class="line">    sql: <span class="string">'SELECT sal, comm FROM emp where deptno = 10'</span>,     <span class="comment">/* 要註冊的 Query */</span></span><br><span class="line">    callback: demoCallback,     <span class="comment">/* 事件處理程式 (Notification handler) 一般都稱呼為 Callback 函數 */</span></span><br><span class="line">    timeout: <span class="number">600</span>,               <span class="comment">/* 因是測試，設定 600 秒後會自動撤銷註冊 */</span></span><br><span class="line">    qos: oracledb.SUBSCR_QOS_QUERY | oracledb.SUBSCR_QOS_ROWIDS     <span class="comment">/* 註冊為 QRCN，加上 QOS_ROWIDS，事件物件才會包含 rowid */</span></span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> connection;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    connection = <span class="keyword">await</span> oracledb.getConnection(config);    <span class="comment">/* 註冊時的 Connection 設定不一樣，使用一般的 Connection */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> connection.subscribe(<span class="string">'demosub'</span>, options);       <span class="comment">/* 調用 subscribe() 註冊 */</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"Subscription created..."</span>);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    <span class="built_in">console</span>.error(err);</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (connection) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">await</span> connection.close();     <span class="comment">/* 註完冊後，就可以關閉這個 connection，資料庫會創建一個 OCI API 通道用來回呼你的 Callback 函數 */</span></span><br><span class="line">      &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">        <span class="built_in">console</span>.error(err);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 事件處理程式 (Notification handler) 一般都稱呼為 Callback 函數</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">demoCallback</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> statement = <span class="string">'select * from emp where rowid = :rid'</span>;     <span class="comment">/* 事件物件(Event Object) 只會回傳受影響資料行的 rowid，這裡將使用此 rowid 實際到資料庫讀取資料 */</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"event type:"</span>, event.type);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (event.type == oracledb.SUBSCR_EVENT_TYPE_DEREG) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"Deregistration has taken place..."</span>);     <span class="comment">/* Subscription closed or timeout */</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 解析事件物件，讀取所需的資料。</span></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"event database name:"</span>, event.dbName);</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"event transaction id:"</span>, event.txId);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> queries = event.queries || [&#123; <span class="attr">tables</span>: event.tables &#125;];     <span class="comment">/* OCN 與 QRCN 回傳的事件物件屬性不太一樣 */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> query <span class="keyword">of</span> queries) &#123;</span><br><span class="line">    <span class="keyword">const</span> tables = query.tables;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> table <span class="keyword">of</span> tables) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`--&gt; Table Name: <span class="subst">$&#123;table.name&#125;</span>`</span>);</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`--&gt; Table Operation: <span class="subst">$&#123;operationName(table.operation)&#125;</span> Rows=<span class="subst">$&#123;table.rows.length&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (table.rows) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">const</span> row <span class="keyword">of</span> table.rows) &#123;</span><br><span class="line">          <span class="built_in">console</span>.log(<span class="string">`--&gt; --&gt; Row Rowid: <span class="subst">$&#123;row.rowid&#125;</span>`</span>);     <span class="comment">/* 受影響的單筆資料 */</span></span><br><span class="line">          <span class="built_in">console</span>.log(<span class="string">`--&gt; --&gt; Row Operation: <span class="subst">$&#123;operationName(row.operation)&#125;</span>`</span>);</span><br><span class="line">          </span><br><span class="line">          <span class="comment">// 用 rowid 到資料庫讀取詳細的資料，這理應是你的應用程式感興趣的地方。</span></span><br><span class="line">          <span class="comment">// 這裡的 connection 使用的是先前創建的 connection pool。這裡千萬要避免使用一般的 connection，</span></span><br><span class="line">          <span class="comment">// 如果同時收到大量的資料，產生大量的 connections，資料庫有可能就掛掉了。</span></span><br><span class="line">          <span class="comment">// 使用 connection pool 效能較佳，又可限制 connection 數量。</span></span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> &#123; rows &#125; = <span class="keyword">await</span> oradb.doExecute(statement, [row.rowid]);</span><br><span class="line">            <span class="built_in">console</span>.log(rows);</span><br><span class="line">          &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">            <span class="built_in">console</span>.log(err);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="built_in">console</span>.log(<span class="built_in">Array</span>(<span class="number">61</span>).join(<span class="string">"-"</span>));</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="built_in">Array</span>(<span class="number">61</span>).join(<span class="string">"="</span>));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 非必要，只為好看些</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">operationName</span>(<span class="params">operation</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> operationName;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span> (operation) &#123;</span><br><span class="line">    <span class="keyword">case</span> oracledb.CQN_OPCODE_INSERT:</span><br><span class="line">      operatonName = <span class="string">'Records Inserted'</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> oracledb.CQN_OPCODE_UPDATE:</span><br><span class="line">      operatonName = <span class="string">'Records Updated'</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> oracledb.CQN_OPCODE_DELETE:</span><br><span class="line">      operatonName = <span class="string">'Records Deteled'</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> oracledb.CQN_OPCODE_ALTER:</span><br><span class="line">      operatonName = <span class="string">'Table Altered'</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> oracledb.CQN_OPCODE_DROP:</span><br><span class="line">      operatonName = <span class="string">'Table Dropped'</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      operatonName = <span class="string">'Unknown Operation'</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> operatonName;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 抽象化資料庫層</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">database</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> config = &#123;</span><br><span class="line">    ...dbConfig,</span><br><span class="line">    poolAlias: <span class="string">'db99demo'</span>,</span><br><span class="line">    poolMin: <span class="number">1</span>,</span><br><span class="line">    poolMax: <span class="number">2</span>,</span><br><span class="line">    poolIncrement: <span class="number">1</span>,</span><br><span class="line">    queueMax: <span class="number">-1</span></span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">initialize</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">await</span> oracledb.createPool(config);     <span class="comment">/* 創建 Connection Pool */</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(err);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">close</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      oracledb.getPool(config.poolAlias).close();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(err);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">doExecute</span>(<span class="params">statement, binds = [], opts = &#123;&#125;</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(</span><br><span class="line">      <span class="keyword">async</span> (resolve, reject) =&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> connection;</span><br><span class="line">        opts.outFormat = oracledb.OBJECT;</span><br><span class="line">        opts.autoCommit = <span class="literal">true</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          connection = <span class="keyword">await</span> oracledb.getConnection(config.poolAlias);     <span class="comment">/* 使用 Connection Pool */</span></span><br><span class="line">          <span class="keyword">const</span> result = <span class="keyword">await</span> connection.execute(statement, binds, opts);</span><br><span class="line">          resolve(result);</span><br><span class="line">        &#125; </span><br><span class="line">        <span class="keyword">catch</span> (err) &#123; reject(&#123; <span class="attr">error</span>: err &#125;); &#125;</span><br><span class="line">        <span class="keyword">finally</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (connection) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">              <span class="keyword">await</span> connection.close();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (err) &#123; <span class="built_in">console</span>.log(err); &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    initialize,</span><br><span class="line">    close,</span><br><span class="line">    doExecute</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">process</span><br><span class="line">  .on(<span class="string">'SIGTERM'</span>, () =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"\nTerminating"</span>);</span><br><span class="line">    oradb.close();</span><br><span class="line">    process.exit(<span class="number">0</span>);</span><br><span class="line">  &#125;)</span><br><span class="line">  .on(<span class="string">'SIGINT'</span>, () =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"\nTerminating"</span>);</span><br><span class="line">    oradb.close();</span><br><span class="line">    process.exit(<span class="number">0</span>);</span><br><span class="line">  &#125;)</span><br><span class="line">  .on(<span class="string">'uncaughtException'</span>, err =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"\nUncaught exception"</span>);</span><br><span class="line">    oradb.close();</span><br><span class="line">    <span class="built_in">console</span>.log(err);</span><br><span class="line">    process.exit(<span class="number">1</span>);</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>

<h4 id="啟動"><a href="#啟動" class="headerlink" title="啟動"></a>啟動</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> node demo-cqn</span></span><br><span class="line">Subscription created...</span><br></pre></td></tr></table></figure>

<p>啟動並註冊後，Node.js process 會等待通知事件，並呼叫 Callback 函數。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">SQL&gt; select regid, callback, table_name, timeout from user_change_notification_regs;</span><br><span class="line"></span><br><span class="line">  REGID CALLBACK                                          TABLE_NAME    TIMEOUT</span><br><span class="line"><span class="comment">------- ------------------------------------------------- ---------- ----------</span></span><br><span class="line">   1536 net8://(ADDRESS=(PROTOCOL=tcp)(HOST=10.11.100.30) DEMO.EMP          200</span><br><span class="line">        (PORT=49919))?PR=0</span><br></pre></td></tr></table></figure>

<p>資料庫會用 OCI API net8://(ADDRESS=(PROTOCOL=tcp)(HOST=10.11.100.30)(PORT=49919))?PR=0 回呼你的 Node.js callback 函數。所以你 Client 端程式的機器及 port 要保持暢通。TIMEOUT 顯示這個註冊的查詢還剩多少時間就會 timeout。如果註冊時沒有設定 timeout，這裡的值會是非常大的數字 4294967295。那你可能必須手動使用 DBMS_CQ_NOTIFICATION.DEREGISTER 註銷註冊的 Query。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">SQL&gt; select * from user_cq_notification_queries;</span><br><span class="line"></span><br><span class="line"> QUERYID QUERYTEXT                                                      REGID</span><br><span class="line"><span class="comment">-------- ------------------------------------------------------------ -------</span></span><br><span class="line">      71  <span class="keyword">SELECT</span> DEMO.EMP.SAL , DEMO.EMP.COMM  <span class="keyword">FROM</span> DEMO.EMP  <span class="keyword">WHERE</span> D    <span class="number">1536</span></span><br><span class="line">         EMO.EMP.DEPTNO  = <span class="number">10</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">SQL&gt; update emp set comm = comm + 1 where empno = 7934;</span><br><span class="line"></span><br><span class="line">1 row updated.</span><br><span class="line"></span><br><span class="line">SQL&gt; commit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">Commit</span> complete.</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">$ node demo-cqn</span><br><span class="line">Subscription created...</span><br><span class="line">event type: 7</span><br><span class="line">event database name: lx26</span><br><span class="line">event transaction id: &lt;Buffer 06 00 0d 00 f4 a3 0a 00&gt;</span><br><span class="line"><span class="comment">--&gt; Table Name: DEMO.EMP</span></span><br><span class="line"><span class="comment">--&gt; Table Operation: Records Updated Rows=1</span></span><br><span class="line"><span class="comment">--&gt; --&gt; Row Rowid: AACzQEAAEAAACAXAAN</span></span><br><span class="line"><span class="comment">--&gt; --&gt; Row Operation: Records Updated</span></span><br><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    EMPNO: 7934,</span><br><span class="line">    ENAME: '楊喆',</span><br><span class="line">    JOB: 'CLERK',</span><br><span class="line">    MGR: 7902,</span><br><span class="line">    HIREDATE: 1982-01-22T16:00:00.000Z,</span><br><span class="line">    SAL: 1500,</span><br><span class="line">    COMM: 13,</span><br><span class="line">    DEPTNO: 10</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br><span class="line"><span class="comment">------------------------------------------------------------</span></span><br><span class="line">============================================================</span><br></pre></td></tr></table></figure>

<p>在 WoT 與 Real-time 的潮流中，Kafka 受到了非常多得關注，RabbitMQ 也有銀行界的加持，有幸為公司導入了這兩個架構，今又有 Oracle CQN 可以選擇，如何應用，應該看應用的範圍與規模，Kafka 與 RabbitMQ 可以是資訊策略的一環，CQN 則適合單打獨鬥，它不需要另外架構 Server，但他只適合用於較小量的資料異動，千萬不要用於大量資料的處理；Kafka 則彈性的多，它可處理一天多達 Petabyte 的資料。RabbitMQ 則有較佳的 GUI 管理介面。不管如何，都可以讓你有些新思維。</p>
<p><strong>Go Real-time!</strong></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://1184yang.github.io/2020/12/24/Oracle-CQN/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/1184yang.jpg">
      <meta itemprop="name" content="J.Y. Yang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/12/24/Oracle-CQN/" class="post-title-link" itemprop="url">Oracle Continuous Query Notification (CQN)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2020-12-24 13:47:00" itemprop="dateCreated datePublished" datetime="2020-12-24T13:47:00+08:00">2020-12-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2021-02-20 07:28:37" itemprop="dateModified" datetime="2021-02-20T07:28:37+08:00">2021-02-20</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Oracle/" itemprop="url" rel="index"><span itemprop="name">Oracle</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Continuous Query Notification (CQN) 允許應用程式向資料庫註冊一些查詢 (Queries)，如果與註冊的查詢 (Query) 有相關的物件 (Object) 或會影響註冊的查詢的結果 (Result set)，資料庫就會觸發事件，通知註冊的事件處理程式 (Notification handler)。</p>
<p>這有兩種模式:</p>
<ol>
<li><p>Object change notification (OCN)<br>如果查詢(Query)註冊為<strong>物件更改</strong>通知 (OCN)，則只要一段交易 (transaction) 更改了查詢引用 (references) 和提交(commit) 的物件，資料庫就會通知應用程式。</p>
</li>
<li><p>Query result change notification (QRCN)<br>如果查詢註冊為<strong>結果更改</strong>通知 (QRCN)，則只要交易更改影響了查詢結果並提交，資料庫就會通知應用程式。</p>
</li>
</ol>
<p>這些一個或多個查詢的列表與通知類型 (OCN 或 QRCN) 需向 CQN 註冊，並提供通知處理程式 (Notification handler)。您可以使用 PL/SQL 或調用 Oracle OCI。如果使用 PL/SQL，則通知處理程式就是資料庫中的 PL/SQL stored procedure; 如果您使用 OCI，則通知處理程式會是客戶端 C 回調程式 (callback procedure)。除了使用 C，Node.js 的 Oracle Library node-oracledb 也支援 CQN。也就是說，當資料庫觸發此事件，就可即時反應在資料庫外端的應用程式。</p>
<h4 id="Object-change-notification-OCN"><a href="#Object-change-notification-OCN" class="headerlink" title="Object change notification (OCN)"></a>Object change notification (OCN)</h4><p>如果應用程式註冊查詢 (Query) 為物件更改通知 (OCN)，則只要交易更改與註冊的 Query 有關聯的物件並提交，資料庫就會向應用程式發送 OCN，這只關心物件是否被更改，而不管查詢的結果是否發生更改。</p>
<p>例如，如果應用程式在將下面的查詢示例註冊為 OCN，並且用戶提交更改 EMP，則資料庫會向應用程式發送 OCN，即使更改的資料沒有滿足查詢的條件（例如，如果 deptno = 30）。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> empno, sal</span><br><span class="line">  <span class="keyword">from</span> emp</span><br><span class="line"> <span class="keyword">where</span> deptno = <span class="number">10</span></span><br><span class="line">/</span><br></pre></td></tr></table></figure>

<h4 id="Query-result-change-notification-QRCN"><a href="#Query-result-change-notification-QRCN" class="headerlink" title="Query result change notification (QRCN)"></a>Query result change notification (QRCN)</h4><p>如果應用程式註冊查詢為查詢結果更改通知 (QRCN)，則只要交易更改而影響了註冊的查詢結果並提交，資料庫就會向應用程式發送 QRCN。</p>
<p>例如，如果應用程式在將下面的查詢示例註冊查詢為 QRCN，則只有在查詢結果集發生變化時，資料庫才會向應用程式發送 QRCN; 也就是說，如果其中一個 DML 語句提交：</p>
<ul>
<li>INSERT 或 DELETE 滿足查詢條件 (deptno = 10)。</li>
<li>UPDATE 欄位 empno 或 sal 且滿足查詢條件 (deptno = 10) 的資料。</li>
<li>UPDATE 欄位 deptno，將其值從 10 以外的值更改為 10，造成將該行 (row) 添加到結果集中。</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> empno, sal</span><br><span class="line">  <span class="keyword">from</span> emp</span><br><span class="line"> <span class="keyword">where</span> deptno = <span class="number">10</span></span><br><span class="line">/</span><br></pre></td></tr></table></figure>

<p>預設的通知類型是 OCN。如果要注冊為 QRCN，可在 CQ_NOTIFICATION$_REG_INFO 的 QOSFLAGS 屬性中指定 QOS_QUERY。這我們會在後面的範例看到。</p>
<p>使用 QRCN，您可以選擇保證模式 (guaranteed mode 預設) 或盡力而為模式 (best-effort mode)。</p>
<ul>
<li><p>Guaranteed Mode<br>在保證模式下，只有在保證查詢結果集發生變化時，資料庫才會向應用程式發送 QRCN。例如，假設某個應用程式註冊了下面的查詢為 QRCN，員工 7839 歸屬在部門 10，並且執行了這些 UPDATE 語句。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> empno, sal</span><br><span class="line">  <span class="keyword">from</span> emp</span><br><span class="line"> <span class="keyword">where</span> deptno = <span class="number">10</span></span><br><span class="line">/</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> emp <span class="keyword">SET</span> sal = sal + <span class="number">10</span> <span class="keyword">WHERE</span> empno = <span class="number">7839</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">UPDATE</span> emp <span class="keyword">SET</span> sal = sal – <span class="number">10</span> <span class="keyword">WHERE</span> empno = <span class="number">7839</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br></pre></td></tr></table></figure>

<p>上面的<strong>交易</strong>中的每個 UPDATE 語句都會更改查詢結果集，但<strong>整個交易</strong>對查詢結果集沒有影響; 因此，資料庫不會向應用程序發送 QRCN。</p>
<p>在保證模式下，某些查詢對於 QRCN 而言會過於復雜。</p>
</li>
<li><p>Best-Effort Mode<br>某些查詢對於保證模式而言過於復雜，則可以在 QRCN 下註冊為盡力而為模式，CQN 會創建並註冊它們的簡單版本 (simpler versions)。</p>
<p>例中的查詢對於保證模式下的 QRCN 而言過於復雜，因為它包含聚合函數 SUM。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">sum</span>(sal) <span class="keyword">FROM</span> emp <span class="keyword">WHERE</span> deptno = <span class="number">20</span>;</span><br></pre></td></tr></table></figure>

<p>在盡力而為模式下，CQN 在此示例中註冊了這個更簡單的查詢版本。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> sal <span class="keyword">FROM</span> emp <span class="keyword">WHERE</span> deptno = <span class="number">20</span>;</span><br></pre></td></tr></table></figure>

<p>每當原始查詢的結果發生變化時，其更簡單版本的結果也會發生變化; 因此，簡化中不會丟失任何通知。但是，簡化可能會導致誤報，因為較簡單版本的結果可能會在原始查詢的結果不變 ( sum(sal) 的結果沒變 ) 時更改。</p>
<p>如果是多表查詢 (join)，則會更複雜，所以盡量簡單，不要註冊太複雜的查詢!</p>
</li>
</ul>
<h3 id="實作範例"><a href="#實作範例" class="headerlink" title="實作範例"></a>實作範例</h3><h5 id="需要的權限"><a href="#需要的權限" class="headerlink" title="需要的權限"></a>需要的權限</h5><figure class="highlight"><table><tr><td class="code"><pre><span class="line">SQL&gt; grant change notification to demo;</span><br><span class="line"></span><br><span class="line">SQL&gt; grant execute on dbms_cq_notification to demo;</span><br></pre></td></tr></table></figure>

<p>創建 notifications Table 用來儲存範例子中觸發的通知。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> notifications (</span><br><span class="line">  <span class="keyword">id</span>                 <span class="built_in">NUMBER</span>,</span><br><span class="line">  message            <span class="built_in">VARCHAR2</span>(<span class="number">4000</span>),</span><br><span class="line">  notification_date  <span class="built_in">DATE</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">SEQUENCE</span> notifications_seq;</span><br><span class="line"></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> notifications</span><br><span class="line">  <span class="keyword">ADD</span> <span class="keyword">CONSTRAINT</span> notifications_pk PRIMARY <span class="keyword">KEY</span>(<span class="keyword">id</span>);</span><br></pre></td></tr></table></figure>


<h4 id="事件處理程式-Notification-handler"><a href="#事件處理程式-Notification-handler" class="headerlink" title="事件處理程式 (Notification handler)"></a>事件處理程式 (Notification handler)</h4><p>Notification Handler 就像 AQ 的 notify 程式，通常稱為事件處理器，當事件發生時的處理程式。在 JavaScript 通常則稱為 callback 函數。當事件發生時，CQN 會發出一個事件物件 (Event Object)，內容包含事件的一些訊息，事件處理器必須有一參數承接此事件物件。</p>
<h5 id="事件物件-Event-Object"><a href="#事件物件-Event-Object" class="headerlink" title="事件物件 (Event Object)"></a>事件物件 (Event Object)</h5><p>CQN 會發出 CQ_NOTIFICATION $ _DESCRIPTOR 類型的事件物件。 事件處理程式可以在 CQ_NOTIFICATION $ _DESCRIPTOR 物件的屬性中找到資料庫更改的詳細信息。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">SQL&gt; desc CQ_NOTIFICATION$_DESCRIPTOR</span><br><span class="line"> Name                                                  Null?    Type</span><br><span class="line"> <span class="comment">----------------------------------------------------- -------- ------------------------------------</span></span><br><span class="line"> REGISTRATION_ID                                                NUMBER</span><br><span class="line"> TRANSACTION_ID                                                 RAW(8)</span><br><span class="line"> DBNAME                                                         VARCHAR2(30)</span><br><span class="line"> EVENT_TYPE                                                     NUMBER</span><br><span class="line"> NUMTABLES                                                      NUMBER</span><br><span class="line"> TABLE_DESC_ARRAY                                               SYS.CHNF$_TDESC_ARRAY</span><br><span class="line"> QUERY_DESC_ARRAY    </span><br></pre></td></tr></table></figure>

<p> CQ_NOTIFICATION $ _DESCRIPTOR 類型包含另外兩個屬性:</p>
<ul>
<li>TABLE_DESC_ARRAY，該屬性包含一個類型為 CQ_NOTIFICATION $ _TABLE 的表描述符。</li>
<li>QUERY_DESC_ARRAY，該屬性包含一個類型為 CQ_NOTIFICATION $ _QUERY 的結果集更改描述符。</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">SQL&gt; desc CQ_NOTIFICATION$_TABLE</span><br><span class="line">Name                                                  Null?    Type</span><br><span class="line"><span class="comment">----------------------------------------------------- -------- ------------------------------------</span></span><br><span class="line">OPFLAGS                                                        NUMBER</span><br><span class="line">TABLE_NAME                                                     VARCHAR2(64)</span><br><span class="line">NUMROWS                                                        NUMBER</span><br><span class="line">ROW_DESC_ARRAY                                                 SYS.CHNF$_RDESC_ARRAY</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">SQL&gt; desc CQ_NOTIFICATION$_QUERY</span><br><span class="line"> Name                                                  Null?    Type</span><br><span class="line"> <span class="comment">----------------------------------------------------- -------- ------------------------------------</span></span><br><span class="line"> QUERYID                                                        NUMBER</span><br><span class="line"> QUERYOP                                                        NUMBER</span><br><span class="line"> TABLE_DESC_ARRAY                                           SYS.CHNF$_QDESC_ARRAY</span><br></pre></td></tr></table></figure>

<p>如果在註冊過程中指定了 ROWID 選項，則 CQ_NOTIFICATION $ _TABLE 類型具有 ROW_DESC_ARRAY 屬性，其類型為 CQ_NOTIFICATION $ _ROW，其中包含已更改行的 ROWID。 如果在 CQ_NOTIFICATION $ _TABLE 物件的 OPFLAGS 字段中設置了 ALL_ROWS，則 ROWID 信息不可用。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">SQL&gt; desc CQ_NOTIFICATION$_ROW</span><br><span class="line"> Name                                                  Null?    Type</span><br><span class="line"> <span class="comment">----------------------------------------------------- -------- ------------------------------------</span></span><br><span class="line"> OPFLAGS                                                        NUMBER</span><br><span class="line"> ROW_ID                                                         VARCHAR2(2000)</span><br></pre></td></tr></table></figure>

<h5 id="處理程式"><a href="#處理程式" class="headerlink" title="處理程式"></a>處理程式</h5><p>瞭解了事件物件，可以開始創建事件處理程式:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">or</span> <span class="keyword">replace</span> <span class="keyword">PROCEDURE</span> notifications_handler (</span><br><span class="line">  ntfnds <span class="keyword">IN</span> CQ_NOTIFICATION$_DESCRIPTOR     <span class="comment">/* 事件物件 (Event Object) 參數 */</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">IS</span></span><br><span class="line">  l_regid           <span class="built_in">NUMBER</span>;</span><br><span class="line">  l_table_name      VARCHAR2(60);</span><br><span class="line">  l_event_type      NUMBER;</span><br><span class="line">  l_numtables       NUMBER;</span><br><span class="line">  l_operation_type  NUMBER;</span><br><span class="line">  l_operation_name  VARCHAR2(30);</span><br><span class="line">  l_numrows         NUMBER;</span><br><span class="line">  l_row_id          VARCHAR2(2000);</span><br><span class="line">  l_numqueries      NUMBER;</span><br><span class="line">  l_qid             NUMBER;</span><br><span class="line">  l_qop             NUMBER;</span><br><span class="line">  l_message         VARCHAR2(4000) := NULL;</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">  l_regid := ntfnds.registration_id;</span><br><span class="line">  l_event_type := ntfnds.event_type;</span><br><span class="line"></span><br><span class="line">  l_numqueries := 0;</span><br><span class="line"></span><br><span class="line">  IF (l_event_type = DBMS_CQ_NOTIFICATION.EVENT_QUERYCHANGE) THEN   <span class="comment">/* 這程式將只處理 QRCN event type 7 */</span></span><br><span class="line">    l_numqueries := ntfnds.query_desc_array.count;                  <span class="comment">/* 註冊的 Query 數 */</span></span><br><span class="line"></span><br><span class="line">    FOR i IN 1..l_numqueries LOOP     <span class="comment">/* loop over queries */</span></span><br><span class="line">      l_qid := ntfnds.query_desc_array(i).queryid;</span><br><span class="line">      l_qop := ntfnds.query_desc_array(i).queryop;</span><br><span class="line"></span><br><span class="line">      l_numtables := 0;</span><br><span class="line">      l_numtables := ntfnds.query_desc_array(i).table_desc_array.count;   <span class="comment">/* 每個 Query 所牽涉的 Table 數 */</span></span><br><span class="line"></span><br><span class="line">      FOR j IN 1..l_numtables LOOP    <span class="comment">/* loop over tables */</span></span><br><span class="line">        l_table_name :=</span><br><span class="line">          ntfnds.query_desc_array(i).table_desc_array(j).table_name;</span><br><span class="line">        l_operation_type :=</span><br><span class="line">          ntfnds.query_desc_array(i).table_desc_array(j).Opflags;        <span class="comment">/* Insert、Update or ... */</span></span><br><span class="line"></span><br><span class="line">        IF (bitand(l_operation_type, DBMS_CQ_NOTIFICATION.ALL_ROWS) = 0) THEN</span><br><span class="line">          l_numrows := ntfnds.query_desc_array(i).table_desc_array(j).numrows;  <span class="comment">/* 影響的筆數 */</span></span><br><span class="line">        ELSE</span><br><span class="line">          l_numrows := 0;  <span class="comment">/* ROWID info not available 注冊 Query 時如果沒有要求 ROWID，筆數將會是 0  */</span></span><br><span class="line">        <span class="keyword">END</span> <span class="keyword">IF</span>;</span><br><span class="line"></span><br><span class="line">        CASE              <span class="comment">/* 這只是讓資料好看些，非必要。*/</span></span><br><span class="line">          WHEN BITAND(l_operation_type, DBMS_CQ_NOTIFICATION.INSERTOP) != 0 THEN</span><br><span class="line">            l_operation_name := 'Records Inserted';</span><br><span class="line">          WHEN BITAND(l_operation_type, DBMS_CQ_NOTIFICATION.UPDATEOP) != 0 THEN</span><br><span class="line">            l_operation_name := 'Records Updated';</span><br><span class="line">          WHEN BITAND(l_operation_type, DBMS_CQ_NOTIFICATION.DELETEOP) != 0 THEN</span><br><span class="line">            l_operation_name := 'Records Deleted';</span><br><span class="line">          WHEN BITAND(l_operation_type, DBMS_CQ_NOTIFICATION.ALTEROP) != 0 THEN</span><br><span class="line">            l_operation_name := 'Table Altered';</span><br><span class="line">          WHEN BITAND(l_operation_type, DBMS_CQ_NOTIFICATION.DROPOP) != 0 THEN</span><br><span class="line">            l_operation_name := 'Table Dropped';</span><br><span class="line">          WHEN BITAND(l_operation_type, DBMS_CQ_NOTIFICATION.UNKNOWNOP) != 0 THEN</span><br><span class="line">            l_operation_name := 'Unknown Operation';</span><br><span class="line">          ELSE</span><br><span class="line">            l_operation_name := '?';</span><br><span class="line">        <span class="keyword">END</span> <span class="keyword">CASE</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* l_numrows Table 所影響的筆數 */</span></span><br><span class="line">        l_message := 'QueryID:' || l_qid ||' Table (' || l_table_name || ') - ' || l_operation_name || '. Rows=' || l_numrows;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">INSERT</span> <span class="keyword">INTO</span> notifications (<span class="keyword">id</span>, message, notification_date)</span><br><span class="line">               <span class="keyword">VALUES</span> (notifications_seq.NEXTVAL, l_message, <span class="keyword">SYSDATE</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Body of loop does not run when l_numrows is zero. */</span></span><br><span class="line">        FOR k IN 1..l_numrows LOOP     <span class="comment">/* loop over rows */</span></span><br><span class="line">          <span class="comment">/* 影響的每筆及它的 ROWID。可使用 ROWID 讀取該筆資料，這應是你需要處理的地方。*/</span></span><br><span class="line">          l_row_id := ntfnds.query_desc_array(i).table_desc_array(j).row_desc_array(k).row_id;</span><br><span class="line"></span><br><span class="line">          l_message := 'QueryID:' || l_qid ||' Table (' || l_table_name || ') - RowID:' || l_row_id;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">INSERT</span> <span class="keyword">INTO</span> notifications (<span class="keyword">id</span>, message, notification_date)</span><br><span class="line">                 <span class="keyword">VALUES</span> (notifications_seq.NEXTVAL, l_message, <span class="keyword">SYSDATE</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">END</span> <span class="keyword">LOOP</span>;    <span class="comment">/* loop over rows */</span></span><br><span class="line">      <span class="keyword">END</span> <span class="keyword">LOOP</span>;      <span class="comment">/* loop over tables */</span></span><br><span class="line">    <span class="keyword">END</span> <span class="keyword">LOOP</span>;        <span class="comment">/* loop over queries */</span></span><br><span class="line">  <span class="keyword">END</span> <span class="keyword">IF</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">COMMIT</span>;</span><br><span class="line"><span class="keyword">END</span>;</span><br><span class="line">/ </span><br></pre></td></tr></table></figure>

<h4 id="註冊查詢-Query"><a href="#註冊查詢-Query" class="headerlink" title="註冊查詢 (Query)"></a>註冊查詢 (Query)</h4><p>有了事件處理程式，就可以註冊所要偵測的 Queries。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DECLARE</span></span><br><span class="line">  reginfo   CQ_NOTIFICATION$_REG_INFO;</span><br><span class="line">  mgr_id    NUMBER;</span><br><span class="line">  dept_id   NUMBER;</span><br><span class="line">  v_cursor  SYS_REFCURSOR;</span><br><span class="line">  regid     NUMBER;</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">  reginfo := cq_notification$_reg_info (</span><br><span class="line">    <span class="string">'notifications_handler'</span>,            <span class="comment">/* 事件處理程式 */</span></span><br><span class="line">    DBMS_CQ_NOTIFICATION.QOS_QUERY      <span class="comment">/* QOS_QUERY 表示註冊為 QRCN */</span></span><br><span class="line">    + DBMS_CQ_NOTIFICATION.QOS_ROWIDS,  <span class="comment">/* QOS_ROWIDS 發出的事件物件才會包含每筆資料的 ROWID，處理程式才抓得到所影響的單筆詳細資料 */</span></span><br><span class="line">    <span class="number">0</span>,                                  <span class="comment">/* registration persists until unregistered */</span></span><br><span class="line">    <span class="number">0</span>,                                  <span class="comment">/* notify on all operations */</span></span><br><span class="line">    <span class="number">0</span>                                   <span class="comment">/* notify immediately */</span></span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Create registration. */</span></span><br><span class="line">  regid := DBMS_CQ_NOTIFICATION.new_reg_start(reginfo);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 註冊的 Query，當所有會影響此段 Query 結果的異動，都會觸發事件發出通知(Notification)。</span></span><br><span class="line"><span class="comment">     這裡可以註冊多段的 Query。 */</span></span><br><span class="line">  OPEN v_cursor FOR</span><br><span class="line">    <span class="keyword">SELECT</span> dbms_cq_notification.CQ_NOTIFICATION_QUERYID, sal, comm</span><br><span class="line">      <span class="keyword">FROM</span> DEMO.EMP</span><br><span class="line">     <span class="keyword">WHERE</span> deptno = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">  CLOSE v_cursor;</span><br><span class="line"></span><br><span class="line">  DBMS_CQ_NOTIFICATION.reg_end;</span><br><span class="line"><span class="keyword">END</span>;</span><br><span class="line">/</span><br></pre></td></tr></table></figure>

<p>註冊的 Query 牽涉到 Emp Table 的 sal、comm 與 deptno 欄位。</p>
<ul>
<li>查詢已經註冊的事件處理程式:</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> regid, table_name, callback</span><br><span class="line">  <span class="keyword">from</span> user_change_notification_regs</span><br><span class="line">/</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">     REGID TABLE_NAME           CALLBACK</span><br><span class="line"><span class="comment">---------- -------------------- ----------------------------------------</span></span><br><span class="line">      1231 DEMO.EMP             plsql://notifications_handler?PR=0</span><br></pre></td></tr></table></figure>

<ul>
<li>查詢已經註冊的 Queries:</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> queryid, querytext, regid</span><br><span class="line">  <span class="keyword">from</span> user_cq_notification_queries</span><br><span class="line">/</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">QUERYID QUERYTEXT                                                         REGID</span><br><span class="line"><span class="comment">------- ------------------------------------------------------------ ----------</span></span><br><span class="line">     48  <span class="keyword">SELECT</span> DEMO.EMP.SAL , DEMO.EMP.COMM  <span class="keyword">FROM</span> DEMO.EMP  <span class="keyword">WHERE</span> D       <span class="number">1231</span></span><br><span class="line">        EMO.EMP.DEPTNO  = <span class="number">10</span></span><br></pre></td></tr></table></figure>

<ul>
<li>可以用此註銷註冊的 Query:</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SQL&gt; exec DBMS_CQ_NOTIFICATION.DEREGISTER(regid =&gt; 1231);</span><br></pre></td></tr></table></figure>

<h4 id="實際運作"><a href="#實際運作" class="headerlink" title="實際運作"></a>實際運作</h4><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">SQL&gt; select * from notifications;</span><br><span class="line"></span><br><span class="line">no rows selected</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">SQL&gt; select * from emp where empno in (7608, 7934);</span><br><span class="line"></span><br><span class="line">  EMPNO ENAME      JOB            MGR HIREDATE        SAL   COMM  DEPTNO</span><br><span class="line"><span class="comment">------- ---------- ---------- ------- ------------ ------ ------ -------</span></span><br><span class="line">   7608 馬小九      ANALYST       7788 28-JUN-10      1000    100      40</span><br><span class="line">   7934 楊喆        CLERK         7902 23-JAN-82      1500             10</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">SQL&gt;  update emp set comm = 99 where empno in (7608, 7934);</span><br><span class="line"></span><br><span class="line">2 rows updated.           <span class="comment">/* 異動兩筆資料，但只有一筆會影響註冊 Query 的結果 */</span></span><br><span class="line"></span><br><span class="line">SQL&gt; commit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">Commit</span> complete.</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">SQL&gt; select * from notifications;</span><br><span class="line">   </span><br><span class="line">   <span class="comment">/* 註冊 Query 時如果沒有 QOS_ROWIDS, ID 261 Rows=0, ID 262 則不會存在 */</span></span><br><span class="line">   </span><br><span class="line">   ID MESSAGE                                                      NOTIFICATION_DATE</span><br><span class="line"><span class="comment">----- ------------------------------------------------------------ -------------------</span></span><br><span class="line">  261 QueryID:48 Table (DEMO.EMP) - Records Updated. Rows=1        2020-12-25 08:27:48</span><br><span class="line">  262 QueryID:48 Table (DEMO.EMP) - RowID:AACzQEAAEAAACAXAAN       2020-12-25 08:27:48</span><br><span class="line">      <span class="comment">/* 只觸發一筆資料的 notification */</span></span><br><span class="line"></span><br><span class="line">SQL&gt; select * from emp where rowid = 'AACzQEAAEAAACAXAAN';</span><br><span class="line"></span><br><span class="line">  EMPNO ENAME      JOB            MGR HIREDATE               SAL   COMM  DEPTNO</span><br><span class="line"><span class="comment">------- ---------- ---------- ------- ------------------- ------ ------ -------</span></span><br><span class="line">   7934 楊喆       CLERK         7902 1982-01-23 00:00:00   1500     99      10</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">SQL&gt; select * from emp where empno = 7934;</span><br><span class="line"></span><br><span class="line">  EMPNO ENAME      JOB            MGR HIREDATE               SAL   COMM  DEPTNO</span><br><span class="line"><span class="comment">------- ---------- ---------- ------- ------------------- ------ ------ -------</span></span><br><span class="line">   7934 楊喆       CLERK         7902 1982-01-23 00:00:00   1500     99      10</span><br><span class="line"></span><br><span class="line">SQL&gt; update emp set comm = 99 where empno = 7934;</span><br><span class="line"></span><br><span class="line">1 row updated.</span><br><span class="line"></span><br><span class="line">SQL&gt; commit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">Commit</span> complete.                    <span class="comment">/* 這個異動沒有影響註冊 Query 的結果 */</span></span><br><span class="line">                                    <span class="comment">/* 沒有觸發 notification 事件 */</span></span><br><span class="line"><span class="keyword">SQL</span>&gt; <span class="keyword">select</span> * <span class="keyword">from</span> notifications;</span><br><span class="line"></span><br><span class="line">   ID MESSAGE                                                      NOTIFICATION_DATE</span><br><span class="line"><span class="comment">----- ------------------------------------------------------------ -------------------</span></span><br><span class="line">  261 QueryID:48 Table (DEMO.EMP) - Records Updated. Rows=1        2020-12-25 08:27:48</span><br><span class="line">  262 QueryID:48 Table (DEMO.EMP) - RowID:AACzQEAAEAAACAXAAN       2020-12-25 08:27:48</span><br></pre></td></tr></table></figure>

<figure class="highlight"><table><tr><td class="code"><pre><span class="line">SQL&gt; update emp set deptno = 20 where empno = 7934;</span><br><span class="line"></span><br><span class="line">1 row updated.         <span class="comment">/* 將部門由 10 改為 20 */</span></span><br><span class="line">                       <span class="comment">/* 觸發了 notification 事件 */</span></span><br><span class="line">SQL&gt; commit;           </span><br><span class="line"></span><br><span class="line"><span class="keyword">Commit</span> complete.</span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span>&gt; <span class="keyword">select</span> * <span class="keyword">from</span> notifications;</span><br><span class="line"></span><br><span class="line">     ID MESSAGE                                                      NOTIFICATION_DATE</span><br><span class="line"><span class="comment">------- ------------------------------------------------------------ -------------------</span></span><br><span class="line">    261 QueryID:48 Table (DEMO.EMP) - Records Updated. Rows=1        2020-12-25 08:27:48</span><br><span class="line">    262 QueryID:48 Table (DEMO.EMP) - RowID:AACzQEAAEAAACAXAAN       2020-12-25 08:27:48</span><br><span class="line">=&gt;  263 QueryID:48 Table (DEMO.EMP) - Records Updated. Rows=1        2020-12-25 09:05:12</span><br><span class="line">=&gt;  264 QueryID:48 Table (DEMO.EMP) - RowID:AACzQEAAEAAACAXAAN       2020-12-25 09:05:12 </span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">SQL&gt; insert into emp values(9099, '李小明', 'CLERK', 7698, sysdate, 23100, null, 10);</span><br><span class="line"></span><br><span class="line">1 row created.</span><br><span class="line"></span><br><span class="line">SQL&gt; commit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">Commit</span> complete.</span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span>&gt; <span class="keyword">select</span> * <span class="keyword">from</span> notifications;</span><br><span class="line"></span><br><span class="line">     ID MESSAGE                                                      NOTIFICATION_DATE</span><br><span class="line"><span class="comment">------- ------------------------------------------------------------ -------------------</span></span><br><span class="line">    261 QueryID:48 Table (DEMO.EMP) - Records Updated. Rows=1        2020-12-25 08:27:48</span><br><span class="line">    262 QueryID:48 Table (DEMO.EMP) - RowID:AACzQEAAEAAACAXAAN       2020-12-25 08:27:48</span><br><span class="line">    263 QueryID:48 Table (DEMO.EMP) - Records Updated. Rows=1        2020-12-25 09:05:12</span><br><span class="line">    264 QueryID:48 Table (DEMO.EMP) - RowID:AACzQEAAEAAACAXAAN       2020-12-25 09:05:12</span><br><span class="line">=&gt;  265 QueryID:48 Table (DEMO.EMP) - Records Inserted. Rows=1       2020-12-25 09:15:55</span><br><span class="line">=&gt;  266 QueryID:48 Table (DEMO.EMP) - RowID:AACzQEAAEAAACAVAAB       2020-12-25 09:15:55</span><br><span class="line"></span><br><span class="line">SQL&gt; select * from emp where rowid = 'AACzQEAAEAAACAVAAB';</span><br><span class="line"></span><br><span class="line">  EMPNO ENAME      JOB            MGR HIREDATE               SAL   COMM  DEPTNO</span><br><span class="line"><span class="comment">------- ---------- ---------- ------- ------------------- ------ ------ -------</span></span><br><span class="line">   9099 李小明     CLERK         7698 2020-12-25 09:15:52  23100             10</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">SQL&gt; delete emp where empno = 9099;</span><br><span class="line"></span><br><span class="line">1 row deleted.</span><br><span class="line"></span><br><span class="line">SQL&gt; commit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">Commit</span> complete.</span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span>&gt; <span class="keyword">select</span> * <span class="keyword">from</span> notifications;</span><br><span class="line"></span><br><span class="line">     ID MESSAGE                                                      NOTIFICATION_DATE</span><br><span class="line"><span class="comment">------- ------------------------------------------------------------ -------------------</span></span><br><span class="line">    261 QueryID:48 Table (DEMO.EMP) - Records Updated. Rows=1        2020-12-25 08:27:48</span><br><span class="line">    262 QueryID:48 Table (DEMO.EMP) - RowID:AACzQEAAEAAACAXAAN       2020-12-25 08:27:48</span><br><span class="line">    263 QueryID:48 Table (DEMO.EMP) - Records Updated. Rows=1        2020-12-25 09:05:12</span><br><span class="line">    264 QueryID:48 Table (DEMO.EMP) - RowID:AACzQEAAEAAACAXAAN       2020-12-25 09:05:12</span><br><span class="line">    265 QueryID:48 Table (DEMO.EMP) - Records Inserted. Rows=1       2020-12-25 09:15:55</span><br><span class="line">    266 QueryID:48 Table (DEMO.EMP) - RowID:AACzQEAAEAAACAVAAB       2020-12-25 09:15:55</span><br><span class="line">=&gt;  267 QueryID:48 Table (DEMO.EMP) - Records Deleted. Rows=1        2020-12-25 09:19:00</span><br><span class="line">=&gt;  268 QueryID:48 Table (DEMO.EMP) - RowID:AACzQEAAEAAACAVAAB       2020-12-25 09:19:00</span><br><span class="line"></span><br><span class="line">8 rows selected.</span><br><span class="line"></span><br><span class="line">SQL&gt; select * from emp where rowid = 'AACzQEAAEAAACAVAAB';</span><br><span class="line"></span><br><span class="line">no rows selected</span><br></pre></td></tr></table></figure>

<p>現在來看複雜一點的:</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">SQL&gt; truncate table notifications;</span><br><span class="line"></span><br><span class="line">Table truncated.</span><br><span class="line"></span><br><span class="line">SQL&gt; select empno, ename, comm, deptno from emp where deptno = 10;</span><br><span class="line"></span><br><span class="line">  EMPNO ENAME        COMM  DEPTNO</span><br><span class="line"><span class="comment">------- ---------- ------ -------</span></span><br><span class="line">   7839 KING                   10</span><br><span class="line">   7782 楊建華                  10</span><br><span class="line">   7934 楊喆           99      10</span><br><span class="line">   8907 牸祢                   10</span><br><span class="line"></span><br><span class="line">SQL&gt; update emp set comm = 99 where deptno = 10;</span><br><span class="line"></span><br><span class="line">4 rows updated.   <span class="comment">/* update 4 筆資料 */</span></span><br><span class="line"></span><br><span class="line">SQL&gt; commit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">Commit</span> complete.</span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span>&gt; <span class="keyword">select</span> * <span class="keyword">from</span> notifications;</span><br><span class="line">    </span><br><span class="line"><span class="comment">/* 只有觸發 3 筆資料的 notification */</span></span><br><span class="line"></span><br><span class="line">   ID MESSAGE                                                      NOTIFICATION_DATE</span><br><span class="line"><span class="comment">----- ------------------------------------------------------------ -------------------</span></span><br><span class="line">  275 QueryID:48 Table (DEMO.EMP) - Records Updated. Rows=3        2020-12-25 09:32:15</span><br><span class="line">  276 QueryID:48 Table (DEMO.EMP) - RowID:AACzQEAAEAAACAXAAA       2020-12-25 09:32:15</span><br><span class="line">  277 QueryID:48 Table (DEMO.EMP) - RowID:AACzQEAAEAAACAXAAC       2020-12-25 09:32:15</span><br><span class="line">  278 QueryID:48 Table (DEMO.EMP) - RowID:AACzQEAAEAAACAXAAS       2020-12-25 09:32:15</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">SQL&gt; truncate table notifications;</span><br><span class="line"></span><br><span class="line">Table truncated.</span><br><span class="line"></span><br><span class="line">SQL&gt; select * from emp where empno = 7934;</span><br><span class="line"></span><br><span class="line">  EMPNO ENAME      JOB            MGR HIREDATE               SAL   COMM  DEPTNO</span><br><span class="line"><span class="comment">------- ---------- ---------- ------- ------------------- ------ ------ -------</span></span><br><span class="line">   7934 楊喆       CLERK         7902 1982-01-23 00:00:00   1500     99      10</span><br><span class="line"></span><br><span class="line">SQL&gt; update emp set comm = comm + 10 where empno = 7934;</span><br><span class="line"></span><br><span class="line">1 row updated.</span><br><span class="line"></span><br><span class="line">SQL&gt; update emp set comm = comm - 10 where empno = 7934;</span><br><span class="line"></span><br><span class="line">1 row updated.</span><br><span class="line"></span><br><span class="line">SQL&gt; commit;             /* 同一個交易 (Transaction) 沒有改變註冊 Query 的結果 */</span><br><span class="line"></span><br><span class="line"><span class="keyword">Commit</span> complete.</span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span>&gt; <span class="keyword">select</span> * <span class="keyword">from</span> notifications;</span><br><span class="line"></span><br><span class="line">no rows selected        <span class="comment">/* 沒有觸發 notification 事件 */</span></span><br></pre></td></tr></table></figure>

<p>測試完，註銷:</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">SQL&gt; exec DBMS_CQ_NOTIFICATION.DEREGISTER(regid =&gt; 1231);</span><br><span class="line"></span><br><span class="line">PL/SQL procedure successfully completed.</span><br><span class="line"></span><br><span class="line">SQL&gt; select regid, table_name, callback</span><br><span class="line">  2  from user_change_notification_regs</span><br><span class="line">  3  /</span><br><span class="line"></span><br><span class="line">no rows selected</span><br><span class="line"></span><br><span class="line">SQL&gt; select queryid, querytext, regid</span><br><span class="line">  2  from user_cq_notification_queries</span><br><span class="line">  3  /</span><br><span class="line"></span><br><span class="line">no rows selected</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://1184yang.github.io/2020/12/23/Oracle-Streaming-Table-Functions/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/1184yang.jpg">
      <meta itemprop="name" content="J.Y. Yang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/12/23/Oracle-Streaming-Table-Functions/" class="post-title-link" itemprop="url">Oracle Streaming Table Functions</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2020-12-23 13:58:45" itemprop="dateCreated datePublished" datetime="2020-12-23T13:58:45+08:00">2020-12-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2021-02-20 07:28:37" itemprop="dateModified" datetime="2021-02-20T07:28:37+08:00">2021-02-20</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Oracle/" itemprop="url" rel="index"><span itemprop="name">Oracle</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Table function 可以像 SELECT 語句的 FROM 子句中的 Table 一樣使用的函數。 Table function 的一個常見用法是像資料流 (stream data) 一樣，直接從一個來源進程傳輸或轉換到下一個流程，而中間不需有暫存的過程。以這種方式使用的 table function 稱為 Streaming table function。這種技術最常用於數據倉儲，作為提取 (extract)，轉換 (transform) 和加載 (load) ETL 操作的一部分。</p>
<p>之前面我們展示了 <a href="/2020/12/22/Oracle-Table-Functions/">Table function</a> 的概述。 現在則來看看創建 Streaming table function 所需的基本步驟。</p>
<p>在深入了解詳細細節之前，我們看一下 Streaming table function 功能示例:</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> tickers</span><br><span class="line">  <span class="keyword">SELECT</span> *</span><br><span class="line">    <span class="keyword">FROM</span> <span class="keyword">TABLE</span> (doubled (<span class="keyword">CURSOR</span> (<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> stocks)))</span><br><span class="line">/</span><br></pre></td></tr></table></figure>

<p>這裡發生了什麼？ 讓我們從內到外逐步來看:</p>
<table>
<thead>
<tr>
<th>Code</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>SELECT * FROM stocks</td>
<td>獲取 stocks TABLE 中的所有的 rows</td>
</tr>
<tr>
<td>CURSOR ( )</td>
<td>使用 CURSOR 表達式創建指向結果集 (result set) 的 <strong>cursor 變數</strong></td>
</tr>
<tr>
<td>( )</td>
<td>將 cursor 變數傳遞給 doubled table function</td>
</tr>
<tr>
<td>doubled ( )</td>
<td>執行 doubled 函數的轉換並返回結果集</td>
</tr>
<tr>
<td>SELECT * FROM TABLE ( … )</td>
<td>SQL 引擎將從 doubled 函數返回的結果集轉換為關係的行和列集(relational set of rows and columns)</td>
</tr>
<tr>
<td>INSERT INTO tickers</td>
<td>將這些行插入到 tickers TABLE 中</td>
</tr>
</tbody></table>
<p>有時（通常？），您需要在資料流式處理過程 (Streaming process) 中執行多個轉換。沒問題，您可以串聯多個 Table function 的調用：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> tickers</span><br><span class="line">  <span class="keyword">SELECT</span> *</span><br><span class="line">    <span class="keyword">FROM</span> <span class="keyword">TABLE</span> (transform2 (</span><br><span class="line">                 <span class="keyword">CURSOR</span> (<span class="keyword">SELECT</span> *</span><br><span class="line">                           <span class="keyword">FROM</span> <span class="keyword">TABLE</span> (transform1 (</span><br><span class="line">                                        <span class="keyword">CURSOR</span> (<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> stocks</span><br><span class="line">    ))))))</span><br><span class="line">/</span><br></pre></td></tr></table></figure>

<h3 id="範例"><a href="#範例" class="headerlink" title="範例"></a>範例</h3><p>要將數據從一個 Table 轉換到另一個 Table，我們需要 Table 和這些 Table 中的數據。在此例，從 stocks Table 開始，每筆資料 (row) 包含每個股票代碼的開盤價和收盤價。這裡有 <a href="/useful/demo_stocks.sql" target="_blank">Stocks 資料範本</a>。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> stocks (</span><br><span class="line">  ticker         <span class="built_in">VARCHAR2</span>(<span class="number">20</span>),</span><br><span class="line">  trade_date     <span class="built_in">DATE</span>,</span><br><span class="line">  opening_price  <span class="built_in">NUMBER</span>,</span><br><span class="line">  closing_price  <span class="built_in">NUMBER</span></span><br><span class="line">)</span><br><span class="line">/</span><br></pre></td></tr></table></figure>

<p>這裡的轉換很簡單: 將 stocks Table 中的每一筆資料 (row)， 拆開成為 tickers Table 的兩筆資料 (將開盤價和收盤價拆為兩筆):</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> tickers (</span><br><span class="line">  ticker     <span class="built_in">VARCHAR2</span>(<span class="number">20</span>),</span><br><span class="line">  pricedate  <span class="built_in">DATE</span>,</span><br><span class="line">  pricetype  <span class="built_in">VARCHAR2</span>(<span class="number">1</span>),</span><br><span class="line">  price      <span class="built_in">NUMBER</span></span><br><span class="line">)</span><br><span class="line">/</span><br></pre></td></tr></table></figure>

<p>在繼續之前，必須要指出，對於這個特定的轉換 (從 stocks 中的一行到 tickers 的兩行) 並不需要一個 Table function 來完成工作。你可以使用 INSERT ALL 兩次插入代碼:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">ALL</span></span><br><span class="line">  <span class="keyword">INTO</span> tickers (ticker, pricedate, pricetype, price)</span><br><span class="line">    <span class="keyword">VALUES</span> (ticker, trade_date, <span class="string">'O'</span>, opening_price)</span><br><span class="line">  <span class="keyword">INTO</span> tickers (ticker, pricedate, pricetype, price)</span><br><span class="line">    <span class="keyword">VALUES</span> (ticker, trade_date, <span class="string">'C'</span>, closing_price)</span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> stocks</span><br><span class="line">/</span><br></pre></td></tr></table></figure>

<p>你也可以使用 UNPIVOT:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> tickers (ticker, pricedate, pricetype, price)</span><br><span class="line"><span class="keyword">SELECT</span> *</span><br><span class="line">  <span class="keyword">FROM</span> stocks <span class="keyword">UNPIVOT</span> ( price</span><br><span class="line">                <span class="keyword">FOR</span> price_type</span><br><span class="line">                 <span class="keyword">IN</span> (opening_price <span class="keyword">AS</span> <span class="string">'O'</span>, closing_price <span class="keyword">AS</span> <span class="string">'C'</span>))</span><br><span class="line">/</span><br></pre></td></tr></table></figure>

<p>SQL 是一種非常強大的語言。你的轉換很可能在純 SQL 中就可行，那就應該避免使用 Table function。但是，如果轉換需要使用處理邏輯 (因此需要 PL/SQL)，或者如果 SQL 語法無法完成，則 Table function 提供了一種強大，直接的方式來完成工作。在此，假設轉換要復雜得多，並且需要使用 Table function。</p>
<p>之前關於 Table function 所示，當你需要一個 Table function 返回的集合中每個元素(行)含多個欄位數據時，而不僅僅是一個字符串或數字，那你就需要創建一個物件類型 (Object type) 以及這些物件類型的集合類型 (Nested table type)。</p>
<p>在這裡的示例中，要將 stocks 的數據移動到 stickers ，因此我需要一個 “看起來像” stickers table 的物件類型。理想情況下，應該創建一個像下面的集合類型:</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TYPE</span> tickers_nt <span class="keyword">AS</span> <span class="keyword">TABLE</span> <span class="keyword">OF</span> tickers%ROWTYPE</span><br><span class="line">/</span><br></pre></td></tr></table></figure>

<p>但是 %ROWTYPE 是 PL/SQL 聲明屬性，SQL 引擎不認得該屬性，因此該語句會失敗:</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">PLS-00329: schema-level type has illegal reference to TICKERS</span><br></pre></td></tr></table></figure>

<p>因此我們不能在 Schema level 下使用 tickers％ROWTYPE 必須另外創建一個物件類型。</p>
<p>替代的，需要創建了一個模仿 stickers Table 結構的物件類型，如下所示:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TYPE</span> ticker_ot</span><br><span class="line">  <span class="keyword">AUTHID</span> DEFINER <span class="keyword">IS</span> <span class="keyword">OBJECT</span></span><br><span class="line">(</span><br><span class="line">  ticker     <span class="built_in">VARCHAR2</span>(<span class="number">20</span>),</span><br><span class="line">  pricedate  <span class="built_in">DATE</span>,</span><br><span class="line">  pricetype  <span class="built_in">VARCHAR2</span>(<span class="number">1</span>),</span><br><span class="line">  price      <span class="built_in">NUMBER</span></span><br><span class="line">)</span><br><span class="line">/</span><br></pre></td></tr></table></figure>

<p>然後創建這些物件類型的集合類型 (Nested table type):</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TYPE</span> tickers_nt <span class="keyword">AS</span> <span class="keyword">TABLE</span> <span class="keyword">OF</span> ticker_ot</span><br><span class="line">/</span><br></pre></td></tr></table></figure>

<p>現在這個 tickers_nt 集合類型裡的每個元素 (row) 長的就像 ticker_ot 物件類型。與 tickers Table 看起來一模一樣。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">SQL&gt; desc tickers_nt;</span><br><span class="line"> tickers_nt TABLE OF TICKER_OT</span><br><span class="line"> Name                                      Null?    Type</span><br><span class="line"> <span class="comment">----------------------------------------- -------- ----------------------------</span></span><br><span class="line"> TICKER                                             VARCHAR2(20)</span><br><span class="line"> PRICEDATE                                          DATE</span><br><span class="line"> PRICETYPE                                          VARCHAR2(1)</span><br><span class="line"> PRICE                                              NUMBER</span><br><span class="line"></span><br><span class="line">SQL&gt; desc tickers;</span><br><span class="line"> Name                                      Null?    Type</span><br><span class="line"> <span class="comment">----------------------------------------- -------- ----------------------------</span></span><br><span class="line"> TICKER                                             VARCHAR2(20)</span><br><span class="line"> PRICEDATE                                          DATE</span><br><span class="line"> PRICETYPE                                          VARCHAR2(1)</span><br><span class="line"> PRICE                                              NUMBER</span><br></pre></td></tr></table></figure>

<p>這裡打算在 Table function 使用資料流式的處理(Streaming process)。 意思是將從 SQL 傳遞一組數據 (rows and columns）到 table function。為此，需要定義一個強型態 (strong) 的 REF CURSOR 類型，該類型將用作接受 SQL 語句內數據集的<strong>函數參數</strong>的數據類型。</p>
<p>在下面的 Package specification 中，創建了兩個強型態 REF CURSOR 類型，一個用於 stocks table 中的 row，另一個用於 tickers table。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> <span class="keyword">REPLACE</span> <span class="keyword">PACKAGE</span> stock_mgr</span><br><span class="line">  <span class="keyword">AUTHID</span> DEFINER</span><br><span class="line"><span class="keyword">IS</span></span><br><span class="line">  <span class="keyword">TYPE</span> stocks_rc <span class="keyword">IS</span> <span class="keyword">REF</span> <span class="keyword">CURSOR</span>     <span class="comment">/* 這裡有 RETURN 特定的物件類型，是一個強型態 Strong REF CURSOR type */</span></span><br><span class="line">    <span class="keyword">RETURN</span> stocks%ROWTYPE;         <span class="comment">/* 可以不定義 RETURN，則會是弱型態 Weak REF CURSOR type */</span></span><br><span class="line">  </span><br><span class="line">  TYPE tickers_rc IS REF CURSOR</span><br><span class="line">    RETURN tickers%ROWTYPE;</span><br><span class="line"><span class="keyword">END</span> stock_mgr;</span><br><span class="line">/</span><br></pre></td></tr></table></figure>

<h5 id="CURSOR-和-REF-CURSOR-之間的區別"><a href="#CURSOR-和-REF-CURSOR-之間的區別" class="headerlink" title="CURSOR 和 REF CURSOR 之間的區別"></a>CURSOR 和 REF CURSOR 之間的區別</h5><p>從最基本的技術層面上講，它們是相同的。“正常”PLSQL CURSOR 在定義中是靜態的 (static)。REF CURSOR 可以動態的打開或基於邏輯動態的打開。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DECLARE</span></span><br><span class="line">  <span class="keyword">TYPE</span> rc <span class="keyword">IS</span> <span class="keyword">REF</span> <span class="keyword">CURSOR</span>;                       <span class="comment">/* 弱型態 CURSOR */</span></span><br><span class="line">  </span><br><span class="line">  CURSOR c IS <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> dual;              <span class="comment">/* 靜態的 (static) */</span></span><br><span class="line">  </span><br><span class="line">  l_cursor rc;</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">  <span class="keyword">IF</span> (TO_CHAR(<span class="keyword">SYSDATE</span>, <span class="string">'dd'</span>) = <span class="number">30</span>) <span class="keyword">THEN</span>       <span class="comment">/* 弱型態 REF CURSUR 可以是 */</span></span><br><span class="line">    <span class="keyword">OPEN</span> l_cursor <span class="keyword">FOR</span> <span class="string">'SELECT * FROM emp'</span>;    <span class="comment">/* static SQL 或 dynamic SQL statement*/</span></span><br><span class="line">  ELSIF (TO_CHAR(SYSDATE, 'dd') = 29) THEN</span><br><span class="line">    OPEN l_cursor FOR <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> dept;</span><br><span class="line">  ELSE</span><br><span class="line">    OPEN l_cursor FOR <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> dual;</span><br><span class="line">  <span class="keyword">END</span> <span class="keyword">IF</span>;</span><br><span class="line">  </span><br><span class="line">  OPEN C;</span><br><span class="line"><span class="keyword">END</span>;</span><br><span class="line">/</span><br></pre></td></tr></table></figure>

<ul>
<li>無論運行多少次，CURSOR c  始終是 “SELECT * FROM dual”。 REF CURSOR 則可以是任何東西，而且可以是 static SQL 或 dynamic SQL statement。</li>
<li>REF CURSOR 可以返回 (return) 給客戶端。 CURSOR 無法返回給客戶端。</li>
<li>CURSOR 可以是全域的 (global), 可以定義在 SQL 中；REF CURSOR 不能，它只能定義在子程式中 (你不能定義它們在 PROCEDURE / FUNCTION 的外面)。</li>
<li>REF CURSOR 可作為參數在子程式中傳遞，CURSOR 不能。</li>
<li>Static SQL (不使用 REF CURSOR) 效率較佳。</li>
<li>REF CURSOR 的使用應侷限於:<ul>
<li>將結果集返回給客戶端</li>
<li>當沒有其他有效的手段來實現目標時也就是說，您首先應使用靜態 SQL (實際上使用 implicit cursors)，只在必要時才使用 REF CURSOR。</li>
</ul>
</li>
</ul>
<p>使用 REF CURSOR 類型聲明的變數就是 CURSOR 變數 (cursor variable)。在 PL/SQL 中，可以這樣使用：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DECLARE</span></span><br><span class="line">  l_cursor stock_mgr.stocks_rc;             <span class="comment">/* stock_mgr.stocks_rc 是一個強型態的 REF CURSOR 類型 */</span></span><br><span class="line">  </span><br><span class="line">  l_stock stocks%ROWTYPE;</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">  <span class="keyword">OPEN</span> l_cursor <span class="keyword">FOR</span> <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> stocks;   <span class="comment">/* 強型態的 REF CURSOR 要使用 static SQL statement */</span></span><br><span class="line">                                            <span class="comment">/* 不能使用 dynamic SQL statement */</span></span><br><span class="line">  LOOP</span><br><span class="line">    FETCH l_cursor INTO l_stock;</span><br><span class="line">  </span><br><span class="line">    EXIT WHEN l_cursor%NOTFOUND;</span><br><span class="line">  <span class="keyword">END</span> <span class="keyword">LOOP</span>;</span><br><span class="line">  </span><br><span class="line">  CLOSE l_cursor;</span><br><span class="line"><span class="keyword">END</span>;</span><br><span class="line">/</span><br></pre></td></tr></table></figure>

<p>您可以對 cursor 變數使用所有常用的 cursor attributes 和 operators: FETCH，%FOUND，CLOSE 等。</p>
<p>但後面會看到，在 SQL 的 streaming table function 使用此 REF CURSOR 類型的方式會有所不同。</p>
<p>Streaming table function 和“普通”Table function 之間的主要區別是 streaming table function 的參數至少一個是 CURSOR 類型的變數。 Table function 可以有多個 CURSOR 變數的輸入和其他類型的其他參數，如字符串或日期。 在此的 streaming table function，將只使用單個 CURSOR 變數參數。</p>
<p>通常，Streaming table function 的流程是:</p>
<ol>
<li>從 CURSOR 變數中獲取一行。</li>
<li>處裡每一行的轉換應用。</li>
<li>將轉換後的數據放入集合中。</li>
<li>完成後返回集合。</li>
</ol>
<p>現在讓我們看看這個模式是如何在 doubled function 中展開的，將一筆 stocks table 的 row 拆解成兩筆 tickers rows 。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> <span class="keyword">REPLACE</span> <span class="keyword">FUNCTION</span> doubled (rows_in stock_mgr.stocks_rc)</span><br><span class="line">  <span class="keyword">RETURN</span> tickers_nt</span><br><span class="line">  <span class="keyword">AUTHID</span> DEFINER</span><br><span class="line"><span class="keyword">IS</span></span><br><span class="line">  <span class="keyword">TYPE</span> stocks_aat <span class="keyword">IS</span> <span class="keyword">TABLE</span> <span class="keyword">OF</span> stocks%ROWTYPE <span class="keyword">INDEX</span> <span class="keyword">BY</span> PLS_INTEGER;</span><br><span class="line">  </span><br><span class="line">  l_stocks stocks_aat;</span><br><span class="line">  </span><br><span class="line">  l_doubled tickers_nt := tickers_nt();</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">  <span class="keyword">LOOP</span></span><br><span class="line">    <span class="keyword">FETCH</span> rows_in <span class="keyword">BULK</span> <span class="keyword">COLLECT</span> <span class="keyword">INTO</span> l_stocks <span class="keyword">LIMIT</span> <span class="number">100</span>;  </span><br><span class="line">    EXIT WHEN l_stocks.COUNT = 0;</span><br><span class="line">    </span><br><span class="line">    FOR l_row IN 1 .. l_stocks.COUNT</span><br><span class="line">    LOOP</span><br><span class="line">      l_doubled.EXTEND;</span><br><span class="line">      l_doubled(l_doubled.LAST) := ticker_ot( l_stocks(l_row).ticker,</span><br><span class="line">                                              l_stocks(l_row).trade_date,</span><br><span class="line">                                              'O',</span><br><span class="line">                                              l_stocks (l_row).opening_price</span><br><span class="line">                                            );</span><br><span class="line">     </span><br><span class="line">      l_doubled.EXTEND;</span><br><span class="line">      l_doubled(l_doubled.LAST) := ticker_ot( l_stocks (l_row).ticker,</span><br><span class="line">                                              l_stocks (l_row).trade_date,</span><br><span class="line">                                              'C',</span><br><span class="line">                                              l_stocks (l_row).closing_price</span><br><span class="line">                                            );</span><br><span class="line">    <span class="keyword">END</span> <span class="keyword">LOOP</span>;</span><br><span class="line">  <span class="keyword">END</span> <span class="keyword">LOOP</span>;</span><br><span class="line">  CLOSE rows_in;</span><br><span class="line">  </span><br><span class="line">  RETURN l_doubled;</span><br><span class="line"><span class="keyword">END</span>;</span><br><span class="line">/</span><br></pre></td></tr></table></figure>

<ul>
<li>第 1 行，使用 Package stock_mgr 中定義的 REF CURSOR 類型。因為要從 stocks Table 中取出資料，所以使用 stocks_rc 類型。</li>
<li>第 2 行，返回一組集合，其中 tickers_nt 類型每個元素看起來就像 tickers Table 中的 row。</li>
<li>第 7 行，聲明一個關聯陣列 (Associative array) 來保存從 rows_in 游標變數中獲取的 rows (因使用 BULK COLLECT 所以需要)。</li>
<li>第 9 行，l_doubled 是一個 local 變數，儲存要返回 SELECT 語句的資料。</li>
<li>第 12 ~ 13 行，啟動一個簡單的循環從 rows_in 游標變數中獲取 row。CURSOR 表達式會自動 Open 這個游標變數。使用 BULK COLLECT 功能每次提取 100 rows。避免沒有效率的逐行處理。當關聯陣列為空時退出循環。</li>
<li>第 15 行，取出關聯陣列每個 row。</li>
<li>第 17 ~ 22 行，使用 EXTEND 在 nested table 的末尾添加另一個元素，然後將 tickers 物件放入集合中新的最後一個索引值。</li>
<li>第 24 ~ 29 行，添加另一個元素，因為我們將一筆拆成兩筆。</li>
<li>第 32 行，現在已經獲取了所有的 row，關閉游標變數。 注意：此步驟是可選的。當使用 CURSOR 表達式傳入結果集時， cursor 將在函數終止時自動關閉。</li>
<li>第 34 行返回結果集。</li>
</ul>
<p>在這個例子中的 FETCH-BULK COLLECT-LIMIT，使用了值 100 作為 LIMIT 子句。這是一個不錯的預設值。但是，如果您正在處理極大量的 rows 並希望從函數中獲得更好的性能，則可以嘗試更大的 LIMIT 值。但請注意，這會消耗更多的 PGA 記憶體，並且在某些時候，由於記憶體消耗過多，程式碼將會變慢。您可將 LIMIT 值作為參數傳遞，以便能夠在不重新編譯函數的情況下改變執行的性能，如:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> <span class="keyword">REPLACE</span> <span class="keyword">FUNCTION</span> doubled (</span><br><span class="line">  rows_in stock_mgr.stocks_rc, limit_in <span class="built_in">INTEGER</span> <span class="keyword">DEFAULT</span> <span class="number">100</span>)</span><br><span class="line">  ...</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">  <span class="keyword">LOOP</span></span><br><span class="line">    <span class="keyword">FETCH</span> rows_in <span class="keyword">BULK</span> <span class="keyword">COLLECT</span> <span class="keyword">INTO</span> l_stocks <span class="keyword">LIMIT</span> limit_in;</span><br><span class="line">    EXIT WHEN l_stocks.COUNT = 0;</span><br><span class="line">...</span><br><span class="line">  <span class="keyword">END</span>;</span><br><span class="line">/</span><br></pre></td></tr></table></figure>

<p>現在可以來處裡一些 Streaming 的作業了。這裡有 <a href="/useful/demo_stocks.sql" target="_blank">Stocks 資料範本</a>。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">SQL&gt; select count(*) from stocks;</span><br><span class="line"></span><br><span class="line">  COUNT(*)</span><br><span class="line"><span class="comment">----------</span></span><br><span class="line">      1000</span><br><span class="line"></span><br><span class="line">SQL&gt; select count(*) from tickers;</span><br><span class="line"></span><br><span class="line">  COUNT(*)</span><br><span class="line"><span class="comment">----------</span></span><br><span class="line">         0</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> tickers</span><br><span class="line">  <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="keyword">TABLE</span>(doubled (<span class="keyword">CURSOR</span> (<span class="keyword">SELECT</span> * <span class="keyword">from</span> stocks)))</span><br><span class="line">/</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">SQL&gt; select count(*) from tickers;</span><br><span class="line"></span><br><span class="line">  COUNT(*)</span><br><span class="line"><span class="comment">----------</span></span><br><span class="line">      2000</span><br></pre></td></tr></table></figure>

<p>這裡只展示了一個步驟的資料流轉換串接，你可以再建多個 steaming table function，做多步驟的資料流轉換串接。執行的時候就像:</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> *</span><br><span class="line">  <span class="keyword">FROM</span> <span class="keyword">TABLE</span> ( another (<span class="keyword">CURSOR</span> ( <span class="keyword">SELECT</span> *</span><br><span class="line">    <span class="keyword">FROM</span> <span class="keyword">TABLE</span> ( doubled (<span class="keyword">CURSOR</span> ( <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> stocks <span class="keyword">where</span> ticker = <span class="string">'1500'</span>))))))</span><br></pre></td></tr></table></figure>

<p>Streaming table function 在數據倉儲 ETL 操作中扮演著至關重要的角色。Oracle Database 透過實現 PL/SQL CURSOR 變數和 CURSOR 表達式，使構建此類函數變得容易。</p>
<p>請記住，由 Streaming table function 返回的集合將消耗 PGA 記憶體，因此通過 CURSOR 變數傳遞到函數如果是非常大的數據集可能會導致記憶體耗用錯誤。那能做些什麼？</p>
<p>那就得將 streaming table function 轉為 <a href="/2020/12/23/Oracle-Pipelined-Table-Functions/">pipelined streaming table function</a>。</p>
<p>現在讓我們創建 doubled 函數的 Pipelined table function 版本。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> <span class="keyword">REPLACE</span> <span class="keyword">FUNCTION</span> doubled_pl (rows_in stock_mgr.stocks_rc)</span><br><span class="line">  <span class="keyword">RETURN</span> tickers_nt</span><br><span class="line">  <span class="keyword">PIPELINED</span></span><br><span class="line">  <span class="keyword">AUTHID</span> DEFINER</span><br><span class="line"><span class="keyword">IS</span></span><br><span class="line">  <span class="keyword">TYPE</span> stocks_aat <span class="keyword">IS</span> <span class="keyword">TABLE</span> <span class="keyword">OF</span> stocks%ROWTYPE <span class="keyword">INDEX</span> <span class="keyword">BY</span> PLS_INTEGER;</span><br><span class="line">  </span><br><span class="line">  l_stocks stocks_aat;</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">  <span class="keyword">LOOP</span></span><br><span class="line">    <span class="keyword">FETCH</span> rows_in <span class="keyword">BULK</span> <span class="keyword">COLLECT</span> <span class="keyword">INTO</span> l_stocks <span class="keyword">LIMIT</span> <span class="number">100</span>;</span><br><span class="line">    EXIT WHEN l_stocks.COUNT = 0;</span><br><span class="line">    </span><br><span class="line">    FOR l_row IN 1 .. l_stocks.COUNT</span><br><span class="line">    LOOP</span><br><span class="line">      PIPE ROW (ticker_ot( l_stocks(l_row).ticker,</span><br><span class="line">                           l_stocks(l_row).trade_date,</span><br><span class="line">                           'O',</span><br><span class="line">                           l_stocks(l_row).opening_price)</span><br><span class="line">                         );</span><br><span class="line">      </span><br><span class="line">      PIPE ROW (ticker_ot( l_stocks(l_row).ticker,</span><br><span class="line">                           l_stocks(l_row).trade_date,</span><br><span class="line">                           'C',</span><br><span class="line">                           l_stocks (l_row).closing_price)</span><br><span class="line">                         );</span><br><span class="line">    <span class="keyword">END</span> <span class="keyword">LOOP</span>;</span><br><span class="line">  <span class="keyword">END</span> <span class="keyword">LOOP</span>;</span><br><span class="line">  </span><br><span class="line">  RETURN;</span><br><span class="line"><span class="keyword">END</span>;</span><br><span class="line">/   </span><br></pre></td></tr></table></figure>

<ul>
<li>第 3 行，加了 PIPELINED 關鍵字。</li>
<li>第 16 行，使用 PIPE ROW <strong>立即</strong>將該數據發送回調用查詢。所以不會有阻塞或記憶體消耗的問題，這對大量的 ETL 數據處裡很重要。</li>
<li>第 30 行 RETURN 之前你不需要顯式關閉 CURSOR 變數(rows_in); 當 Table function 終止時，Oracle 資料庫將自動關閉使用 CURSOR 表達式創建的 CURSOR 變數。</li>
<li>第 30 行，只返回控制，沒有其它數據。數據已經都用 PIPE ROW 送出了。</li>
</ul>
<p>現在我們來看看有使用 pipelined 與沒有使用 pipelined 的區別。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">SQL&gt; select count(*) from stocks;</span><br><span class="line"></span><br><span class="line">  COUNT(*)</span><br><span class="line"><span class="comment">----------</span></span><br><span class="line">    256000</span><br><span class="line"></span><br><span class="line">SQL&gt; set timing on</span><br><span class="line">SQL&gt; SELECT * FROM TABLE (doubled (CURSOR (SELECT * FROM stocks)))</span><br><span class="line">  2  WHERE ROWNUM &lt; 10;</span><br><span class="line"></span><br><span class="line">TICKER               PRICEDATE          P      PRICE</span><br><span class="line"><span class="comment">-------------------- ------------------ - ----------</span></span><br><span class="line">1001                 24-OCT-18          O         48</span><br><span class="line">1001                 24-OCT-18          C         43</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">9 rows selected.</span><br><span class="line"></span><br><span class="line">Elapsed: 00:00:02.06</span><br><span class="line">SQL&gt; SELECT * FROM TABLE (doubled_pl (CURSOR (SELECT * FROM stocks)))</span><br><span class="line">  2  WHERE ROWNUM &lt; 10;</span><br><span class="line"></span><br><span class="line">TICKER               PRICEDATE          P      PRICE</span><br><span class="line"><span class="comment">-------------------- ------------------ - ----------</span></span><br><span class="line">1001                 24-OCT-18          O         48</span><br><span class="line">1001                 24-OCT-18          C         43</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">9 rows selected.</span><br><span class="line"></span><br><span class="line">Elapsed: 00:00:00.01</span><br></pre></td></tr></table></figure>

<ul>
<li><p>使用非 pipelined 版本，我必須等待 256000 行轉換加倍到 512000 行 (同樣消耗大量的 PGA 記憶體)。然後將所有這些行傳遞回 SELECT 語句，此時 SQL 引擎說：“好吧，我只想要前 9 個” 並拋棄其餘的行。</p>
</li>
<li><p>使用 pipelined 版本的回應時間明顯縮短，清楚地 SELECT 語句能夠跟踪函數立即返回的行。只要傳回 9 行，SQL 引擎就會終止 Pipelined table function 的執行 (WHEN NO_DATA_NEEDED)。這只會終止函數，但不會終止調用它的 SELECT 語句。</p>
</li>
</ul>
<p>現在試試沒有 WHERE 條件句。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">SQL&gt; SELECT count(*) FROM TABLE (doubled (CURSOR (SELECT * FROM stocks)));</span><br><span class="line"></span><br><span class="line">  COUNT(*)</span><br><span class="line"><span class="comment">----------</span></span><br><span class="line">    512000</span><br><span class="line"></span><br><span class="line">Elapsed: 00:00:02.06</span><br><span class="line">SQL&gt; SELECT count(*) FROM TABLE (doubled_pl (CURSOR (SELECT * FROM stocks)));</span><br><span class="line"></span><br><span class="line">  COUNT(*)</span><br><span class="line"><span class="comment">----------</span></span><br><span class="line">    512000</span><br><span class="line"></span><br><span class="line">Elapsed: 00:00:00.51</span><br></pre></td></tr></table></figure>

<p>即使沒有 WHERE 條件 pipelined 版本也明顯得快很多，這是因為減少耗用大量 PGA 記憶體的 I/O，如果 PGA 不夠用而需用到 Temporary Tablespace ，則影響更大。</p>
<p>從記憶體的角度來看，非 Pipelined table function 比 pipelined 版本消耗更多的 PGA 記憶體。 這結果應該是完全合理的，因為我們不需要聲明並使用函數所需暫存返回的資料集合。</p>
<p>在使用 APEX 時有些複雜的資料常會使用 APEX Collection，這不僅效能不好，也常是 Oracle 資料庫效能不佳的原因，建議您試試 Table Function!</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://1184yang.github.io/2020/12/23/Oracle-Pipelined-Table-Functions/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/1184yang.jpg">
      <meta itemprop="name" content="J.Y. Yang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/12/23/Oracle-Pipelined-Table-Functions/" class="post-title-link" itemprop="url">Oracle Pipelined Table Functions</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2020-12-23 07:50:18" itemprop="dateCreated datePublished" datetime="2020-12-23T07:50:18+08:00">2020-12-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2021-02-20 07:28:37" itemprop="dateModified" datetime="2021-02-20T07:28:37+08:00">2021-02-20</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Oracle/" itemprop="url" rel="index"><span itemprop="name">Oracle</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>由 <a href="/2020/12/22/Oracle-Table-Functions/">Table function</a> 返回的集合將消耗 PGA 記憶體，因此函數如果產生非常大的數據集可能會導致記憶體耗用錯誤。那能做些什麼？</p>
<p>那就得將 table function 轉為 <strong>pipelined table function</strong>。</p>
<p>Pipelined table function 是一種特別的 table function，它透過<strong>管道 (pipe)</strong> 在函數完成<strong>所有</strong>處理之前，將數據以函數所生成的形式返回 (RETURN) 給調用的查詢語句。</p>
<p>在深入 Pipelined table function 的實現和應用之前，了解這個述語句的不一樣非常重要。 PL/SQL 不是多線程語言 (Multithread)。通常，當調用 PL/SQL 區塊（anonymous、nested、procedure、function 等）時，該 session 的進一步處理將 “等候(on hold)”（或暫停 - suspended），直到該 PL/SQL 區塊將控制權返回給調用區塊的宿主(host)，該宿主有可能是另一個 PL/SQL 區塊，SQL 語句或 Java 等主機語言。</p>
<p>一般的（非 pipelined） table function 都以這種方式作業。每次在 FROM 子句中調用 table function 時，SQL 引擎必須等到函數執行 RETURN 語句才能將集合傳遞回 SELECT 語句以轉換為行和列。</p>
<p>此種阻塞行為可能會對 SELECT 語句的整體性能產生負面影響，尤其是在數據倉儲的 ETL 操作中。 此外，隨著每個元素添加到 table function 中的集合中，消耗了越來越多的 PGA 記憶體。 對於非常大的數據集，這可能導致進一步的性能下降，甚至錯誤。</p>
<p>Pipelined table function 解決了這兩個問題(性能與記憶體)。讓我們透過一個非常簡單的一般的 Table function 和一個非常簡單的 pipelined table function 來開始我們對它的了解。</p>
<p>首先，創建一個 Schema-level 包含單一字符串的 nested table 類型。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> <span class="keyword">REPLACE</span> <span class="keyword">TYPE</span> strings_t <span class="keyword">IS</span> <span class="keyword">TABLE</span> <span class="keyword">OF</span> <span class="built_in">VARCHAR2</span> (<span class="number">100</span>)</span><br><span class="line">/</span><br></pre></td></tr></table></figure>

<p>接下來，編譯一個 table function，該函數返回一個 strings_t 類型的 nested table，其中只包含一筆資料內含一個字符串:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> <span class="keyword">REPLACE</span> <span class="keyword">FUNCTION</span> strings</span><br><span class="line">  <span class="keyword">RETURN</span> strings_t</span><br><span class="line">  <span class="keyword">AUTHID</span> DEFINER</span><br><span class="line"><span class="keyword">IS</span></span><br><span class="line">  l_strings strings_t := strings_t (<span class="string">'壹貳叁'</span>);</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">  <span class="keyword">RETURN</span> l_strings;</span><br><span class="line"><span class="keyword">END</span>;</span><br><span class="line">/</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">COLUMN_VALUE</span> my_string <span class="keyword">FROM</span> <span class="keyword">TABLE</span> (strings())</span><br><span class="line">/</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">MY_STRING</span><br><span class="line"><span class="comment">----------------------------------------------------------------------------------</span></span><br><span class="line">壹貳叁</span><br></pre></td></tr></table></figure>

<p>現在創建同一個 table function 的 pipelined 版本。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> <span class="keyword">REPLACE</span> <span class="keyword">FUNCTION</span> strings_pl</span><br><span class="line">  <span class="keyword">RETURN</span> strings_t</span><br><span class="line">  <span class="keyword">PIPELINED</span></span><br><span class="line">  <span class="keyword">AUTHID</span> DEFINER</span><br><span class="line"><span class="keyword">IS</span></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">  <span class="keyword">PIPE</span> <span class="keyword">ROW</span>(<span class="string">'壹貳叁'</span>);</span><br><span class="line">  RETURN;</span><br><span class="line"><span class="keyword">END</span>;</span><br><span class="line">/</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">COLUMN_VALUE</span> my_string <span class="keyword">FROM</span> <span class="keyword">TABLE</span> (strings_pl())</span><br><span class="line">/</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">MY_STRING</span><br><span class="line"><span class="comment">----------------------------------------------------------------------------------</span></span><br><span class="line">壹貳叁</span><br></pre></td></tr></table></figure>

<p>我們看到了相同的結果。</p>
<p>現在讓我們探討這個一般的 table function 和 pipelined table function 中的代碼之間的差異：</p>
<img src="/2020/12/23/Oracle-Pipelined-Table-Functions/20201223-01.png" title="Pipelined Table Function">

<p>一般的 Table function 和 Pipelined table function 之間還有另一個很大的區別:一般的 Table function 可以在 PL/SQL 中調用，但 Pipelined table function <strong>只能在 SELECT 語句</strong>中調用。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DECLARE</span></span><br><span class="line">  l_strings strings_t := strings_t ();</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">  l_strings := strings_pl ();  <span class="comment">/* 這行不通的 */</span></span><br><span class="line"><span class="keyword">END</span>;</span><br><span class="line">/</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">PLS-00653: aggregate/table functions are not allowed in PL/SQL scope</span><br></pre></td></tr></table></figure>

<p>這應該是完全意料中的。因為 PL/SQL 不是多線程 (Multithread) 語言，所以它不能接受在函數終止執行之前 PIPE 回來的數據。也因此，在 Pipelined table function 功能中，它不會有阻塞或記憶體消耗的問題。它與一般的 Table function 的基本差異：</p>
<ol>
<li>添加 PIPELINED 關鍵字到函數標頭。</li>
<li>使用 PIPE ROW 將數據發送回調用的 SELECT 語句，而不是將數據添加到 local 的集合。</li>
<li>函數只返回控制，沒有其它的數據。</li>
</ol>
<p>現在看一個比較實際的應用，這裡要將 emp Table 的每一筆資料依薪資 (sal) 與獎金 (comm) 拆成兩筆:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> <span class="keyword">REPLACE</span> <span class="keyword">TYPE</span> employee_ot</span><br><span class="line">  <span class="keyword">AUTHID</span> DEFINER</span><br><span class="line">  <span class="keyword">IS</span> <span class="keyword">OBJECT</span></span><br><span class="line">(</span><br><span class="line">  empno        <span class="built_in">NUMBER</span>(<span class="number">4</span>),</span><br><span class="line">  ename        <span class="built_in">VARCHAR2</span>(<span class="number">10</span>),</span><br><span class="line">  income_type  <span class="built_in">CHAR</span>(<span class="number">1</span>),</span><br><span class="line">  income_value <span class="built_in">NUMBER</span>(<span class="number">7</span>,<span class="number">2</span>),</span><br><span class="line">  dname        <span class="built_in">VARCHAR2</span>(<span class="number">14</span>)</span><br><span class="line">)</span><br><span class="line">/</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> <span class="keyword">REPLACE</span> <span class="keyword">TYPE</span> employee_nt <span class="keyword">IS</span> <span class="keyword">TABLE</span> <span class="keyword">OF</span> employee_ot</span><br><span class="line">/</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> <span class="keyword">REPLACE</span> <span class="keyword">FUNCTION</span> employee_pl(deptno_in <span class="built_in">NUMBER</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>)</span><br><span class="line">  <span class="keyword">RETURN</span> employee_nt</span><br><span class="line">  <span class="keyword">PIPELINED</span></span><br><span class="line">  <span class="keyword">AUTHID</span> DEFINER</span><br><span class="line"><span class="keyword">IS</span></span><br><span class="line">  <span class="keyword">CURSOR</span> c1 <span class="keyword">IS</span></span><br><span class="line">    <span class="keyword">SELECT</span> e.empno, e.ename, e.sal, e.comm, d.dname</span><br><span class="line">      <span class="keyword">FROM</span> emp e, dept d</span><br><span class="line">     <span class="keyword">WHERE</span> e.deptno = d.deptno</span><br><span class="line">       <span class="keyword">AND</span> e.deptno = <span class="keyword">coalesce</span>(deptno_in, e.deptno)</span><br><span class="line">     <span class="keyword">ORDER</span> <span class="keyword">BY</span> e.empno;</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">  <span class="keyword">FOR</span> rec <span class="keyword">IN</span> c1</span><br><span class="line">  <span class="keyword">LOOP</span></span><br><span class="line">    <span class="keyword">PIPE</span> <span class="keyword">ROW</span>(employee_ot(rec.empno, rec.ename, <span class="string">'S'</span>, rec.sal, rec.dname));</span><br><span class="line">    PIPE ROW(employee_ot(rec.empno, rec.ename, 'C', rec.comm, rec.dname));</span><br><span class="line">  <span class="keyword">END</span> <span class="keyword">LOOP</span>;</span><br><span class="line">  </span><br><span class="line">  RETURN;</span><br><span class="line"><span class="keyword">END</span>;</span><br><span class="line">/</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">table</span>(employee_pl(<span class="number">30</span>));</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">     EMPNO ENAME      I INCOME_VALUE DNAME</span><br><span class="line"><span class="comment">---------- ---------- - ------------ --------------</span></span><br><span class="line">      7499 ALLEN      S         1600 SALES</span><br><span class="line">      7499 ALLEN      C          303 SALES</span><br><span class="line">      7654 葉習堃      S         1250 SALES</span><br><span class="line">      7654 葉習堃      C         1400 SALES</span><br><span class="line">      7698 BLAKE      S         2850 SALES</span><br><span class="line">      7698 BLAKE      C          101 SALES</span><br><span class="line">      7844 하찮고      S         1500 SALES</span><br><span class="line">      7844 하찮고      C              SALES</span><br><span class="line">      7900 JAMES      S        94998 SALES</span><br><span class="line">      7900 JAMES      C              SALES</span><br><span class="line"></span><br><span class="line">10 rows selected.</span><br></pre></td></tr></table></figure>

<h5 id="NO-DATA-NEEDED"><a href="#NO-DATA-NEEDED" class="headerlink" title="NO_DATA_NEEDED"></a>NO_DATA_NEEDED</h5><p>有時候需要在所有行被傳回之前終止 Pipelined table function，就像下面例子:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">table</span>(employee_pl()) <span class="keyword">where</span> <span class="keyword">rownum</span> &lt; <span class="number">5</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">     EMPNO ENAME      I INCOME_VALUE DNAME</span><br><span class="line"><span class="comment">---------- ---------- - ------------ --------------</span></span><br><span class="line">      7369 SMITH      S         8001 RESEARCH</span><br><span class="line">      7369 SMITH      C              RESEARCH</span><br><span class="line">      7499 ALLEN      S         1600 SALES</span><br><span class="line">      7499 ALLEN      C          303 SALES</span><br></pre></td></tr></table></figure>

<p>where rownum &lt; 5 將會在接收到 4 筆資料後引發資料庫 NO_DATA_NEEDED 異常。這將終止函數，但不會終止調用它的 SELECT 語句。因此，在大多數情況下，你不必擔心此 NO_DATA_NEEDED 異常。</p>
<p>但如果滿足以下任一條件，則需要特別去處理此異常：</p>
<ul>
<li>在包含 PIPE ROW 語句的區塊中包含 OTHERS 異常處理程序。</li>
<li>提供 PIPE ROW 語句的代碼必須有一些清理的程序。 通常，清理過程會釋放代碼不再需要的資源。</li>
</ul>
<p>讓我們更詳細地探討這種行為。在上面示例中，我只 SELECT 了 4 行，因此 Oracle 資料庫引發了 NO_DATA_NEEDED 而終止了函數的執行，但沒有引發異常。</p>
<p>現在在原函數只添加一個 OTHERS 異常處理程序。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> <span class="keyword">REPLACE</span> <span class="keyword">FUNCTION</span> employee_pl(deptno_in <span class="built_in">NUMBER</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>)</span><br><span class="line">  <span class="keyword">RETURN</span> employee_nt</span><br><span class="line">  <span class="keyword">PIPELINED</span></span><br><span class="line">  <span class="keyword">AUTHID</span> DEFINER</span><br><span class="line"><span class="keyword">IS</span></span><br><span class="line">  <span class="keyword">CURSOR</span> c1 <span class="keyword">IS</span></span><br><span class="line">    <span class="keyword">SELECT</span> e.empno, e.ename, e.sal, e.comm, d.dname</span><br><span class="line">      <span class="keyword">FROM</span> emp e, dept d</span><br><span class="line">     <span class="keyword">WHERE</span> e.deptno = d.deptno</span><br><span class="line">       <span class="keyword">AND</span> e.deptno = <span class="keyword">coalesce</span>(deptno_in, e.deptno)</span><br><span class="line">     <span class="keyword">ORDER</span> <span class="keyword">BY</span> e.empno;</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">  <span class="keyword">FOR</span> rec <span class="keyword">IN</span> c1</span><br><span class="line">  <span class="keyword">LOOP</span></span><br><span class="line">    <span class="keyword">PIPE</span> <span class="keyword">ROW</span>(employee_ot(rec.empno, rec.ename, <span class="string">'S'</span>, rec.sal, rec.dname));</span><br><span class="line">    PIPE ROW(employee_ot(rec.empno, rec.ename, 'C', rec.comm, rec.dname));</span><br><span class="line">  <span class="keyword">END</span> <span class="keyword">LOOP</span>;</span><br><span class="line">  </span><br><span class="line">  RETURN;</span><br><span class="line">EXCEPTION</span><br><span class="line">  WHEN OTHERS</span><br><span class="line">  THEN</span><br><span class="line">    DBMS_OUTPUT.put_line('Error: ' || SQLERRM);</span><br><span class="line">    RAISE;  </span><br><span class="line"><span class="keyword">END</span>;</span><br><span class="line">/</span><br></pre></td></tr></table></figure>

<p>在包含 PIPE ROW 語句的區塊中包含 OTHERS 異常處理程序。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> serveroutput <span class="keyword">on</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">table</span>(employee_pl()) <span class="keyword">where</span> <span class="keyword">rownum</span> &lt; <span class="number">5</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">      EMPNO ENAME      I INCOME_VALUE DNAME</span><br><span class="line"><span class="comment">---------- ---------- - ------------ --------------</span></span><br><span class="line">      7369 SMITH      S         8001 RESEARCH</span><br><span class="line">      7369 SMITH      C              RESEARCH</span><br><span class="line">      7499 ALLEN      S         1600 SALES</span><br><span class="line">      7499 ALLEN      C          303 SALES</span><br><span class="line"></span><br><span class="line">Error: ORA-06548: no more rows needed</span><br></pre></td></tr></table></figure>

<p>如這裡顯示的，NO_DATA_NEEDED 錯誤被 OTHERS 處理程序捕獲，並且重新 RAISE， 但這不會在 SELECT 語句中顯示為錯誤。但是，採用這種方法的問題在於，您的 OTHERS 處理程序可能需要包含特定的清理代碼，這些代碼對於意外故障有意義，但不適用於數據管道的提前終止。 因此，建議您單獨為 NO_DATA_NEEDED 包含一個特定的處理程序。</p>
<p>在下面的代碼中，展示 NO_DATA_FOUND 和 NO_DATA_NEEDED 在 Pipelined table function 中預設是從從調用的查詢中被 “隱藏”，但其他異常 (如 PROGRAM_ERROR) 則會導致 SQL 語句的終止。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> <span class="keyword">REPLACE</span> <span class="keyword">FUNCTION</span> strings (err_in <span class="keyword">IN</span> <span class="built_in">VARCHAR2</span>)</span><br><span class="line">  <span class="keyword">RETURN</span> strings_t</span><br><span class="line">  <span class="keyword">PIPELINED</span></span><br><span class="line">  <span class="keyword">AUTHID</span> DEFINER</span><br><span class="line"><span class="keyword">IS</span></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">  <span class="keyword">PIPE</span> <span class="keyword">ROW</span> (<span class="number">1</span>);</span><br><span class="line">  </span><br><span class="line">  CASE err_in</span><br><span class="line">    WHEN 'no_data_found'</span><br><span class="line">    THEN</span><br><span class="line">      RAISE NO_DATA_FOUND;</span><br><span class="line">    WHEN 'no_data_needed'</span><br><span class="line">    THEN</span><br><span class="line">      RAISE NO_DATA_NEEDED;</span><br><span class="line">    WHEN 'program_error'</span><br><span class="line">    THEN</span><br><span class="line">      RAISE PROGRAM_ERROR;</span><br><span class="line">  <span class="keyword">END</span> <span class="keyword">CASE</span>;</span><br><span class="line">  </span><br><span class="line">  RETURN;</span><br><span class="line"><span class="keyword">END</span>;</span><br><span class="line">/</span><br></pre></td></tr></table></figure>

<p>這段程式碼中我們故意引發錯誤，觀察 SQL 的回應。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">SQL&gt; select COLUMN_VALUE my_string from table(strings('no_data_found'));</span><br><span class="line"></span><br><span class="line">MY_STRING</span><br><span class="line"><span class="comment">--------------------------------------- /* NO_DATA_FOUND 錯誤被 SQL 隱藏了 */</span></span><br><span class="line">1</span><br><span class="line"></span><br><span class="line">SQL&gt; select COLUMN_VALUE my_string from table(strings('no_data_needed'));</span><br><span class="line"></span><br><span class="line">MY_STRING</span><br><span class="line"><span class="comment">--------------------------------------- /* NO_DATA_NEEDED 錯誤被 SQL 隱藏了 */</span></span><br><span class="line">1</span><br><span class="line"></span><br><span class="line">SQL&gt; select COLUMN_VALUE my_string from table(strings('program_error'));</span><br><span class="line">ERROR:</span><br><span class="line">ORA-06501: PL/SQL: program error        <span class="comment">/* 其它的異常會導致 SQL 語句的終止 */</span></span><br><span class="line">ORA-06512: at "DEMO.STRINGS", line 18</span><br><span class="line"></span><br><span class="line">no rows selected</span><br></pre></td></tr></table></figure>

<p>關於 NO_DATA_NEEDED 的基本要點是不要擔心，除非你在 Pipelined table function 中提供 WHEN OTHERS 處理程序。在這種情況下，請確保單獨為 NO_DATA_NEEDED 提供處理程序，只需使用 RAISE 語句重新引用該異常即可 (即 RAISE NO_DATA_NEEDED)。</p>
<p>Pipelined table function 在 PL/SQL 中是一個比較特殊的東西。它們在函數完成之前就將數據傳遞回調用的查詢。 RETURN 除了返回控制之外，它們不會傳回任何數據。而你不能在 PL/SQL 本身內調用 Pipelined table function ，只能從 SELECT 語句的 FROM 子句中調用。</p>
<p>但是那些奇怪的功能反映了這種特殊功能的強大：與普通 (非 Pipelined) Table function 相比，性能提高不少，更減少了記憶體的消耗。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://1184yang.github.io/2020/12/22/Oracle-Table-Functions/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/1184yang.jpg">
      <meta itemprop="name" content="J.Y. Yang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/12/22/Oracle-Table-Functions/" class="post-title-link" itemprop="url">Oracle Table Functions</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2020-12-22 13:02:12" itemprop="dateCreated datePublished" datetime="2020-12-22T13:02:12+08:00">2020-12-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2021-02-20 07:28:37" itemprop="dateModified" datetime="2021-02-20T07:28:37+08:00">2021-02-20</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Oracle/" itemprop="url" rel="index"><span itemprop="name">Oracle</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>甚麼是 Table Function? 就是 Function 用起來就像 Table。PL/SQL Function 有什麼作用? </p>
<h3 id="Function"><a href="#Function" class="headerlink" title="Function"></a>Function</h3><p>Function 可以返回一個值。 該值可以是純量值，例如字符串:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> <span class="keyword">REPLACE</span> <span class="keyword">FUNCTION</span> longer_string (</span><br><span class="line">  string_in <span class="keyword">IN</span> <span class="built_in">VARCHAR2</span>, to_length_in <span class="keyword">IN</span> <span class="built_in">INTEGER</span>)</span><br><span class="line">  <span class="keyword">RETURN</span> <span class="built_in">VARCHAR2</span></span><br><span class="line">  <span class="keyword">AUTHID</span> DEFINER</span><br><span class="line"><span class="keyword">IS</span></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">  <span class="keyword">RETURN</span> RPAD (string_in, to_length_in, <span class="string">'x'</span>);</span><br><span class="line"><span class="keyword">END</span>;</span><br><span class="line">/</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">SQL&gt; select longer_string('Hello Tainan!', 20) as hello from dual;</span><br><span class="line"></span><br><span class="line">HELLO</span><br><span class="line"><span class="comment">--------------------------------------------------------------------------------</span></span><br><span class="line">Hello Tainan!xxxxxxx</span><br></pre></td></tr></table></figure>

<p>Function 還可以返回更複雜的數據類型，例如，記錄(record)、甚至集合(collection)。為了展示這一點，首先聲明一個 Schema-level 的 Nested table 類型:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> <span class="keyword">REPLACE</span> <span class="keyword">TYPE</span> strings_t <span class="keyword">IS</span> <span class="keyword">TABLE</span> <span class="keyword">OF</span> <span class="built_in">VARCHAR2</span>(<span class="number">100</span>)</span><br><span class="line">/</span><br></pre></td></tr></table></figure>

<p>然後定義一個 function，該 function 返回該類型 (strings_t) 的隨機生成的字符串 (varchar2) 的集合 (collection):</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> <span class="keyword">REPLACE</span> <span class="keyword">FUNCTION</span> random_strings (</span><br><span class="line">  count_in <span class="keyword">IN</span> <span class="built_in">INTEGER</span>)</span><br><span class="line">  <span class="keyword">RETURN</span> strings_t</span><br><span class="line">  <span class="keyword">AUTHID</span> DEFINER</span><br><span class="line"><span class="keyword">IS</span></span><br><span class="line">  l_strings strings_t := strings_t();</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">  l_strings.EXTEND(count_in);</span><br><span class="line"></span><br><span class="line">  FOR indx IN 1 .. count_in</span><br><span class="line">  LOOP</span><br><span class="line">    l_strings(indx) := DBMS_RANDOM.string('u', 10);</span><br><span class="line">  <span class="keyword">END</span> <span class="keyword">LOOP</span>;</span><br><span class="line"></span><br><span class="line">  RETURN l_strings;</span><br><span class="line"><span class="keyword">END</span>;</span><br><span class="line">/</span><br></pre></td></tr></table></figure>

<p>這是一個<strong>返回集合的函數</strong>，我們可以將它當成 Table Function 使用，這意思是，您可以使用 SELECT 語句查詢函數返回值的內容，就像使用一般的 Table 一樣。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">SQL&gt; select * from table(random_strings(5));</span><br><span class="line"></span><br><span class="line">COLUMN_VALUE</span><br><span class="line"><span class="comment">--------------------------------------------------------------------------------</span></span><br><span class="line">HLSFIPLIWX</span><br><span class="line">ITYWJXMWBD</span><br><span class="line">OTPGAWXFGG</span><br><span class="line">HMNQCQIPKL</span><br><span class="line">EPNLHKYJEG</span><br></pre></td></tr></table></figure>

<p>當然你也可以將它當成一般普通的函式這樣用:</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">SQL&gt; select random_strings(5) from dual;</span><br><span class="line"></span><br><span class="line">RANDOM_STRINGS(5)</span><br><span class="line"><span class="comment">--------------------------------------------------------------------------------</span></span><br><span class="line">STRINGS_T('XJNABIIQLO', 'WTVKOLJHMT', 'JQMOPVDOQE', 'DUOUHJUVHO', 'FFJFVTBWTT')</span><br></pre></td></tr></table></figure>

<p>但在 Oracle 資料庫中這樣的資料可能不是你要的。</p>
<h3 id="Table-Functions"><a href="#Table-Functions" class="headerlink" title="Table Functions"></a>Table Functions</h3><p>Table function 可用在以下的情況中:</p>
<ul>
<li><p>合併 Tables 的數據資料<br>您無法或很難單純的使用 SQL 的功能來獲得一些答案。則可使用 TABLE 子句和 Table Function 來實現。</p>
</li>
<li><p>以程式的方式建構要傳遞到主機環境的數據集<br>您的網頁需要顯示一些數據。 然而，這些數據需要一些複雜的整合。一般的情況，您需要執行一些過程代碼來構造數據集，然後將構造的數據存入一個暫存的 Table (Temporary Table) 中，然後執行 SELECT。但是使用 Table function，您可以立即將數據傳遞到網頁，而<strong>無需任何暫存的處理過程</strong>。</p>
</li>
<li><p>模擬可參數化的 View (parameterized view)<br>Oracle database 不支援真正的參數化的 View，如</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> <span class="keyword">REPLACE</span> <span class="keyword">VIEW</span> my_view (param1_in <span class="keyword">IN</span> <span class="built_in">INTEGER</span>) ...</span><br></pre></td></tr></table></figure>

<p>您可以使用 system contexts 實現類似的效果，在 WHERE 子句調用 SYS_CONTEXT 函數以從 session 中獲取參數值。</p>
<p>但您也可以使用 Table function 接受參數來模擬可參數化的 View。</p>
</li>
<li><p>限制開發人員對 Tables 的使用權限<br>如果要嚴格遵循資料庫的資料安全準則，使用者和開發人員都無法直接訪問 Table，即使是 SELECT 權限！ 對於非查詢 DML (插入，更新，刪除），一值都建議打包成 PL/SQL Package 來執行這些操作。對於查詢 (SELECT)，則可以通過使用 Table function 來實現對 Table 查詢的完全控制。 您不必授予 Table 的 SELECT 權限，而是授予 Table function 的 EXECUTE 權限。</p>
</li>
<li><p>執行 Data warehouse 的資料轉換<br>數據倉儲環境中的一個常見要求是執行轉換 (Transformation)，通常都是從一個 Table 轉換到另一個 Table，如圖:</p>
<img src="/2020/12/22/Oracle-Table-Functions/2020-12-22-01.png" title="Table Function">

<p>一種特殊類型的 Table function ，稱為 <strong>Streaming table function</strong>，可以簡潔優雅的支援這些轉換並兼具高性能。</p>
</li>
</ul>
<p>現在我們看看如何使用 random_strings 函數，既可以作為 PL/SQL 中的 “普通” 函數，也可以作為 Table function。</p>
<p>在下面的 PL/SQL 程式碼中，調用 random_strings 函數，然後使用 DBMS_OUTPUT.PUT_LINE 顯示生成的字符串:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> serveroutput <span class="keyword">on</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">DECLARE</span></span><br><span class="line">  l_strings strings_t := random_strings(<span class="number">5</span>);</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">  <span class="keyword">FOR</span> indx <span class="keyword">IN</span> <span class="number">1</span> .. l_strings.COUNT</span><br><span class="line">  <span class="keyword">LOOP</span></span><br><span class="line">    DBMS_OUTPUT.put_line(l_strings(indx));</span><br><span class="line">  <span class="keyword">END</span> <span class="keyword">LOOP</span>;</span><br><span class="line"><span class="keyword">END</span>;</span><br><span class="line">/</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">RNOOEODDOH</span><br><span class="line">LJNWHIUVJA</span><br><span class="line">LFLHRCCURN</span><br><span class="line">ROUGNTXSQU</span><br><span class="line">RJKRTXKGCK</span><br><span class="line"></span><br><span class="line">PL/SQL procedure successfully completed.</span><br></pre></td></tr></table></figure>

<p>現在直接在 SELECT 語句中調用該函數：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">COLUMN_VALUE</span> my_string</span><br><span class="line">  <span class="keyword">FROM</span> <span class="keyword">TABLE</span> (random_strings(<span class="number">5</span>))</span><br><span class="line">/</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">MY_STRING</span><br><span class="line"><span class="comment">--------------------------------------------------------------------------------</span></span><br><span class="line">BKYEWJPQJW</span><br><span class="line">CVSINZCLPX</span><br><span class="line">CLFUSFDWOU</span><br><span class="line">MEEQSNYKXW</span><br><span class="line">PANIDFINDJ</span><br></pre></td></tr></table></figure>

<p><strong>這就是 Table function !</strong></p>
<p>Oracle 資料庫中的 SQL 引擎在 table function 方面為我們做了大部分繁重工作。在 SELECT 語句的 TABLE 子句中調用函數時，SQL 引擎會將函數返回的數據集轉換為關係結果集 (Relational result set)。然後就可以像從 Table 或 View 中的結果集那樣操縱該結果集。</p>
<p>當集合類型的每個元素都是<strong>單純的量值</strong>時（如上面的 strings_t 的情況），該結果集的單個 Column 的名稱將自動設置為 COLUMN_VALUE。 當然，您可以使用 column alias 更改它。</p>
<p>當我們從函數返回一個<strong>集合 (collection)</strong> 時，集合裡面的每個元素 (row) 不會像前面例子，只含單獨的一個欄位(column)，我們需要像 Table 中的每筆資料一樣含有許多的 columns，要達到此目地我們就必須使用物件來達到此目的:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> <span class="keyword">REPLACE</span> <span class="keyword">TYPE</span> two_strings_ot</span><br><span class="line">  <span class="keyword">AUTHID</span> DEFINER </span><br><span class="line">  <span class="keyword">IS</span> <span class="keyword">OBJECT</span></span><br><span class="line">(</span><br><span class="line">  string1 <span class="built_in">VARCHAR2</span>(<span class="number">10</span>),</span><br><span class="line">  string2 <span class="built_in">VARCHAR2</span>(<span class="number">10</span>)</span><br><span class="line">)</span><br><span class="line">/</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> <span class="keyword">REPLACE</span> <span class="keyword">TYPE</span> two_strings_nt <span class="keyword">IS</span> <span class="keyword">TABLE</span> <span class="keyword">OF</span> two_strings_ot</span><br><span class="line">/</span><br></pre></td></tr></table></figure>

<p>現在我們可以使用這兩個類型:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> <span class="keyword">REPLACE</span> <span class="keyword">FUNCTION</span> three_pairs</span><br><span class="line">  <span class="keyword">RETURN</span> two_strings_nt</span><br><span class="line">  <span class="keyword">AUTHID</span> DEFINER</span><br><span class="line"><span class="keyword">IS</span></span><br><span class="line">  l_strings two_strings_nt;</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">  <span class="keyword">RETURN</span> two_strings_nt(</span><br><span class="line">    two_strings_ot(<span class="string">'a'</span>, <span class="string">'b'</span>),</span><br><span class="line">    two_strings_ot(<span class="string">'c'</span>, <span class="string">'d'</span>),</span><br><span class="line">    two_strings_ot(<span class="string">'e'</span>, <span class="string">'f'</span>)</span><br><span class="line">  );</span><br><span class="line"><span class="keyword">END</span>;</span><br><span class="line">/</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="keyword">TABLE</span> (three_pairs())</span><br><span class="line">/</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">STRING1    STRING2</span><br><span class="line"><span class="comment">---------- ----------</span></span><br><span class="line">a          b</span><br><span class="line">c          d</span><br><span class="line">e          f</span><br></pre></td></tr></table></figure>

<p>一旦在 TABLE 子句中嵌入了函數調用，就可以像使用 Table 或 inline view 中的結果集一樣使用結果集。你可以 join 該集合，可以將 columns 使用於 WHERE 子句中，也可以使用集合運算符 (set operator)。 </p>
<p>以下是使用 three_pairs 函數以及一般 Table 的例子。首先我們需要一個簡單的一般 Table：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> string_pairs (</span><br><span class="line">  string1   <span class="built_in">VARCHAR2</span>(<span class="number">10</span>),</span><br><span class="line">  string2   <span class="built_in">VARCHAR2</span>(<span class="number">10</span>)</span><br><span class="line">)</span><br><span class="line">/</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">  <span class="keyword">INSERT</span> <span class="keyword">INTO</span> string_pairs <span class="keyword">VALUES</span> (<span class="string">'a'</span>, <span class="string">'bb'</span>);</span><br><span class="line">  <span class="keyword">INSERT</span> <span class="keyword">INTO</span> string_pairs <span class="keyword">VALUES</span> (<span class="string">'cc'</span>, <span class="string">'dd'</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">COMMIT</span>;</span><br><span class="line"><span class="keyword">END</span>;</span><br><span class="line">/</span><br></pre></td></tr></table></figure>

<p>現在使用 UNION ALL 集合運算符(set operator)，組合 Table 和 Table function:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> string_pairs</span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="keyword">TABLE</span> (three_pairs())</span><br><span class="line">/</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">STRING1    STRING2</span><br><span class="line"><span class="comment">---------- ----------</span></span><br><span class="line">a          bb</span><br><span class="line">cc         dd</span><br><span class="line">a          b</span><br><span class="line">c          d</span><br><span class="line">e          f</span><br></pre></td></tr></table></figure>

<p>接下來，將 Table 和 Table function join 在一起:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> t.string1 string1, t.string2 t_string2, tf.string2 tf_string2</span><br><span class="line">  <span class="keyword">FROM</span> string_pairs t, </span><br><span class="line">       <span class="keyword">TABLE</span> (three_pairs()) tf</span><br><span class="line"> <span class="keyword">WHERE</span> t.string1 = tf.string1</span><br><span class="line"> <span class="keyword">ORDER</span> <span class="keyword">BY</span> string1</span><br><span class="line">/</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">STRING1  T_STRING2  TF_STRING2</span><br><span class="line"><span class="comment">---------- ---------- ----------</span></span><br><span class="line">a          bb         b</span><br></pre></td></tr></table></figure>

<p>甚至可以隱藏使用 Table function，將它放在 View 中:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> <span class="keyword">REPLACE</span> <span class="keyword">VIEW</span> three_pairs_v</span><br><span class="line"><span class="keyword">AS</span></span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="keyword">TABLE</span> (three_pairs())</span><br><span class="line">/</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> t.string1 string1, t.string2 t_string2, tf.string2 tf_string2</span><br><span class="line">  <span class="keyword">FROM</span> string_pairs t, </span><br><span class="line">       three_pairs_v tf</span><br><span class="line"> <span class="keyword">WHERE</span> t.string1 = tf.string1</span><br><span class="line"> <span class="keyword">ORDER</span> <span class="keyword">BY</span> string1</span><br><span class="line">/</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">STRING1  T_STRING2  TF_STRING2</span><br><span class="line"><span class="comment">---------- ---------- ----------</span></span><br><span class="line">a          bb         b</span><br></pre></td></tr></table></figure>

<p>Table function 為資料庫開發人員提供了靈活性和功能性。 你可以使用 Table function 將 SQL 功能與 PL/SQL 的過程控制相結合，以應對各種挑戰。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://1184yang.github.io/2020/11/17/AWS-AppSync/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/1184yang.jpg">
      <meta itemprop="name" content="J.Y. Yang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/11/17/AWS-AppSync/" class="post-title-link" itemprop="url">AWS AppSync GraphQL API 身份驗證與授權</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2020-11-17 08:15:14" itemprop="dateCreated datePublished" datetime="2020-11-17T08:15:14+08:00">2020-11-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2020-12-24 18:13:30" itemprop="dateModified" datetime="2020-12-24T18:13:30+08:00">2020-12-24</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/JavaScript/" itemprop="url" rel="index"><span itemprop="name">JavaScript</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/AWS/" itemprop="url" rel="index"><span itemprop="name">AWS</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>之前，我們學習了 GraphQL 並創建了一個基本的 GraphQL API。 在此示例中，我們將擴展這些概念，使用 AWS AppSync 創建一個音樂節應用程序。</p>
<p>此應用程序將會有以下內容：</p>
<ul>
<li>Amazon DynamoDB Tables，將用於存儲節目和表演廳。</li>
<li>GraphQL API 用於創建、讀取、更新、刪除、和列出節目和表演廳。</li>
<li>只有管理員才能創建、更新、或刪除節目或表演廳。</li>
<li>所有用戶都應該能夠查看節目和表演廳。</li>
<li>節目與表演廳之間的關連。</li>
<li>用戶應該能夠查看所有節目以及查看節目的詳細信息。</li>
</ul>
<h3 id="GraphQL、AppSync-API-和-React-Router"><a href="#GraphQL、AppSync-API-和-React-Router" class="headerlink" title="GraphQL、AppSync API 和 React Router"></a>GraphQL、AppSync API 和 React Router</h3><p>首先，我們將介紹如何為 GraphQL 類型 (Type) 之間的關係建模；如何在 GraphQL 類型和字段 (fields) 上實現授權規則；如何為 AppSync API 啟用多種授權模式，以及如何使用 React Router 啟用路由參數。</p>
<h4 id="GraphQL-類型之間的關係"><a href="#GraphQL-類型之間的關係" class="headerlink" title="GraphQL 類型之間的關係"></a>GraphQL 類型之間的關係</h4><p>創建 GraphQL API 或任何 API 時，了解數據之間的建模關係非常重要，例如，我們正在構建的應用程序將具有以下兩種類型：</p>
<ul>
<li>Stage<br>這類型將保存各個表演廳的信息，包括表演廳名稱、和表演廳 ID。 每個表演廳也都會有許多相關的節目。  </li>
<li>Performance<br>這個類型將保存各個節目的信息，包括表演者、節目簡介、演出的表演廳、和表演時間。</li>
</ul>
<p>對於這類型的 API，理想情況下，至少要具有以下的存取模式：</p>
<ul>
<li>查詢單個表演廳和該表演廳的節目</li>
<li>查詢所有表演廳以及每個表演廳的節目。</li>
<li>查詢個別的表演節目和相應的表演廳。</li>
<li>查詢所有的表演節目和相應的表演廳。</li>
</ul>
<p>現在的問題是，您如何啟用這些不同的關係和存取模式？ 在我們的案例中，如何使用像 DynamoDB 這樣的 NoSQL 數據庫來做到這一點？ 有兩種方法可以實現此目的：</p>
<ul>
<li>透過使用主鍵，排序鍵和本地次要索引(local secondary indexes)的組合，使 DynamoDB 中的數據模式化，從而可以使用單個表(single table)執行所有這些存取模式。 為了與 AppSync 配合使用，這必須手動並從頭開始編寫和維護所有解析器邏輯。</li>
<li>直接在 GraphQL resolvers 解析器級別啟用這些關係。 因為我們使用的是 GraphQL，GraphQL 啟用了按字段解析器(per-field resolvers)，所以可以做到這一點。 為了更好地理解這一點，讓我們看一下將要使用的 Stage 類型。</li>
</ul>
<h5 id="Stage-type-in-GraphQL"><a href="#Stage-type-in-GraphQL" class="headerlink" title="Stage type in GraphQL"></a>Stage type in GraphQL</h5><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Stage &#123;</span><br><span class="line">  id: ID!</span><br><span class="line">  name: <span class="built_in">String</span>!</span><br><span class="line">  performances: [Performance]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>當為此類型創建一個或多個解析器時，以下是一個示例操作鏈。假設在請求表演廳和相對應的節目時會發生這種情況：</p>
<ol>
<li>主要的 Stage GraphQL 解析器將使用 Stage ID 從數據庫中的 Stage 表中檢索表演廳的信息。</li>
<li>Stage 類型的 performances 字段將具有其自己的 GraphQL 解析器。該解析器使用 Stage ID 透過使用 GSI 查詢數據庫來檢索相關的節目，僅返回與該表演廳 ID 相關的節目。</li>
</ol>
<blockquote>
<blockquote>
<p><strong>Global secondary indexes(GSIs)</strong> 允許我們添加可用於查詢表並啟用其他數據存取模式的其他索引。DynamoDB 和 NoSQL 數據庫最強大的功能之一通常是建立其他索引，以實現多種存取模式 (DynamoDB 最多可擁有 20 個 GSIs)。這就像關聯式數據庫中的 indexes 與相關的 constraints (foreign key、unique index 等)。</p>
</blockquote>
</blockquote>
<h5 id="GraphQL-Transform-connection"><a href="#GraphQL-Transform-connection" class="headerlink" title="GraphQL Transform: @connection"></a>GraphQL Transform: @connection</h5><p>在之前，我們使用了 GraphQL Transform 程式庫的 @model 指令來搭建整個後端，包括解析器、數據庫和其他 GraphQL schema。 GraphQL Transform 是一個程式庫，這些指令不是 GraphQL SDL 的一部分，它使我們可以 “裝飾(decorate)” GraphQL schema，並添加其他功能。</p>
<p>這裡，我們將介紹幾個新的指令，包括 @connection，它使我們能夠僅用幾行代碼建立這些關係模式所需要的解析器。</p>
<h4 id="多重身份驗證類型"><a href="#多重身份驗證類型" class="headerlink" title="多重身份驗證類型"></a>多重身份驗證類型</h4><p>在之前，我們使用 API key 作為身份驗證類型創建了 GraphQL API。 這在某些情況下是很好的，例如當你想讓應用程序的所有用戶都可以使用 GraphQL 查詢時。</p>
<p>除了 API key 外，AppSync 支援四種主要的身份驗證方法：</p>
<ul>
<li>The API key<br>使用 API key 時，要在發出 HTTP 請求時，在 header 以 x-api-key 的形式發送 API key。 如果使用 Amplify 客戶端，則會自動發送。</li>
<li>Amazon Cognito user pools<br>在這個範例，我們要使用 Amazon Cognito 的身份驗證託管服務。 使用 Amazon Cognito，我們可以針對 API 本身以及 GraphQL 類型和字段的存取，做進階的權限和群組的控管。</li>
<li>OpenID Connect<br>OpenID Connect 使你能夠使用自己的身份驗證提供者。因此，如果你喜歡其他身份驗證服務(如 Auth0)，或者你的公司具有自己的身份驗證方式，則仍可以使用它來對 AppSync API 進行身份驗證。</li>
<li>IAM<br>AWS IAM 類型會在 GraphQL API 上使用 AWS Signature Version 4 簽章過程。您可以使用 Cognito identity pools 中未經身份驗證的 IAM 角色給予 public 的存取權限，這會比使用 API key 啟用 public 的存取權限更安全。</li>
</ul>
<p>這裡，我們將結合使用 API key 和 Amazon Cognito 為 API 提供的多種身份驗證類型，從而實現公共讀取和私有存取的權限控管。</p>
<h4 id="授權"><a href="#授權" class="headerlink" title="授權"></a>授權</h4><p>使用 GraphQL Transform 程式庫，我們還可以使用 @auth 指令為 API 定義不同的授權規則。</p>
<p>使用 @auth，我們可以定義不同類型的規則，例如：</p>
<ul>
<li>允許所有用戶創建和讀取，但僅允許創建項目的所有者可以更新和刪除。</li>
<li>只允許特定群組的用戶能夠創建，更新或刪除。</li>
<li>只允許所有用戶都能讀取，但不能執行任何其他操作。</li>
<li>上述規則的組合。</li>
</ul>
<p>在這理，我們將構建的應用程序將支援私有存取和公共的讀取。此外，我們還需要對這些規則進行更多的控管。我們需要支援以下內容：</p>
<ul>
<li>經過身份驗證而且是 Amazon Cagnito Admin 群組的用戶，將能夠執行所有操作：創建、讀取、更新、和刪除。</li>
<li>未經身份驗證的用戶將有權訪問，但只能讀取。</li>
</ul>
<h4 id="使用-GSI-的自定義數據存取模式"><a href="#使用-GSI-的自定義數據存取模式" class="headerlink" title="使用 GSI 的自定義數據存取模式"></a>使用 GSI 的自定義數據存取模式</h4><p>DynamoDB 最強大的功能之一是，每個表允許 20 個額外的 GSI。 透過使用 GSI 或 GSI + sort key 的組合(也可以將其視為 filter key)，你可以為數據創建極其靈活而強大的數據存取模式。 GraphQL Transform 程式庫具有 @key 指令，可輕鬆為 @model 類型配置自定義的索引結構。</p>
<p>我們將使用 @key 在 Performance 表上將表演廳 ID 設置為 GSI 以創建存取模式。這樣將使我們能夠在單個 GraphQL 查詢中讀取表演廳及其相關的節目表。</p>
<p>現在瞭解了技能概述；讓我們開始構建應用程序。</p>
<h3 id="開始構建-APP"><a href="#開始構建-APP" class="headerlink" title="開始構建 APP"></a>開始構建 APP</h3><p>首先，我們將創建新的 React 專案，安裝依賴項，初始化新的 Amplify 應用程序以及透過 CLI 添加功能。</p>
<h5 id="創建-React-專案："><a href="#創建-React-專案：" class="headerlink" title="創建 React 專案："></a>創建 React 專案：</h5><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">yarn create react-app festivalapp</span><br><span class="line"></span><br><span class="line">cd festivalapp</span><br><span class="line"></span><br><span class="line">yarn add aws-amplify antd @aws-amplify/ui-react react-router-dom</span><br></pre></td></tr></table></figure>

<h5 id="初始化一個新的-Amplify-專案："><a href="#初始化一個新的-Amplify-專案：" class="headerlink" title="初始化一個新的 Amplify 專案："></a>初始化一個新的 Amplify 專案：</h5><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">amplify init</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 請按照步驟為專案命名，環境名稱並設置預設的文本編輯器。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 接受其他所有設置的預設值，然後選擇你的 AWS Profile。</span></span><br></pre></td></tr></table></figure>

<h4 id="建立後端"><a href="#建立後端" class="headerlink" title="建立後端"></a>建立後端</h4><p>我們將添加的第一個功能是身份驗證。 此應用程序將需要具有基本的身份驗證，以及 Lambda 觸發器，使我們可以在用戶註冊確認後，動態的將一組預定義的用戶添加到 Admin 群組中。</p>
<h5 id="Authentication"><a href="#Authentication" class="headerlink" title="Authentication"></a>Authentication</h5><p>使用 auth 類別添加 Cognito 身份驗證：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">amplify add auth</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"> Do you want to use the default authentication and security configuration? Default configuration</span><br><span class="line"> How do you want users to be able to sign in? Username   </span><br><span class="line"> Do you want to configure advanced settings? Yes, I want to make some additional changes.</span><br><span class="line"> What attributes are required for signing up? Email</span><br><span class="line"> Do you want to enable any of the following capabilities? Add User to Group</span><br><span class="line">? Enter the name of the group to which users will be added. Admin</span><br><span class="line">? Do you want to edit your add-to-group function now? Yes</span><br></pre></td></tr></table></figure>

<p>使用以下代碼更新函式，並設定 adminEmails 陣列，這個陣列就是預定義的 Admin 群組用戶：</p>
<figure class="highlight javascript"><figcaption><span>amplify/backend/function/&lt;function_name&gt;/src/add-to-group.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> aws = <span class="built_in">require</span>(<span class="string">'aws-sdk'</span>);</span><br><span class="line"></span><br><span class="line">exports.handler = <span class="keyword">async</span> (event, context, callback) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> cognitoProvider = <span class="keyword">new</span> aws.CognitoIdentityServiceProvider(&#123; <span class="attr">apiVersion</span>: <span class="string">'2016-04-18'</span> &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> isAdmin = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">const</span> adminEmails = [<span class="string">'user1@somedomain.com'</span>, <span class="string">'user2@somedomain.com'</span>];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (adminEmails.indexOf(event.request.userAttributes.email) !== <span class="number">-1</span>) &#123;</span><br><span class="line">    isAdmin = <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> groupParams = &#123;</span><br><span class="line">    UserPoolId: event.userPoolId,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> userParams = &#123;</span><br><span class="line">    UserPoolId: event.userPoolId,</span><br><span class="line">    Username: event.userName,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (isAdmin) &#123;</span><br><span class="line">    groupParams.GroupName = <span class="string">'Admin'</span>;</span><br><span class="line">    userParams.GroupName = <span class="string">'Admin'</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">await</span> cognitoProvider.getGroup(groupParams).promise();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      <span class="keyword">await</span> cognitoProvider.createGroup(groupParams).promise();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">await</span> cognitoProvider.adminAddUserToGroup(userParams).promise();</span><br><span class="line">      callback(<span class="literal">null</span>, event);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      callback(e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    callback(<span class="literal">null</span>, event)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>現在，身份驗證服務已設置完畢，我們可以繼續下一步：創建 AppSync API。</p>
<h5 id="The-AppSync-API"><a href="#The-AppSync-API" class="headerlink" title="The AppSync API"></a>The AppSync API</h5><p>接下來，我們將創建 AppSync GraphQL API。 請記住，對於此 API，我們需要為公共和受保護的存取啟用多種身份驗證類型，所有這些都可以由 CLI 啟用。</p>
<p>我們將使用 api 類別添加 AppSync API：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">amplify add api</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">? Please select from one of the below mentioned services: GraphQL</span><br><span class="line">? Provide API name: festivalapi</span><br><span class="line">? Choose the default authorization type for the API Amazon Cognito User Pool</span><br><span class="line">Use a Cognito user pool configured as a part of this project.</span><br><span class="line">? Do you want to configure advanced settings for the GraphQL API Yes, I want to make some additional changes.</span><br><span class="line">? Configure additional auth types? Yes</span><br><span class="line">? Choose the additional authorization types you want to configure for the API API key</span><br><span class="line">API key configuration</span><br><span class="line">? Enter a description for the API key: public</span><br><span class="line">? After how many days from now the API key should expire (1-365): 365</span><br><span class="line">? Configure conflict detection? No</span><br><span class="line">? Do you have an annotated GraphQL schema? No</span><br><span class="line">? Choose a schema template: Single object with fields (e.g., “Todo” with ID, name, description)</span><br><span class="line">? Do you want to edit the schema now? (y/N) Yes</span><br></pre></td></tr></table></figure>

<p>我們將使用的 GraphQL schema 有兩個主要類型: Stage 和 Performance。</p>
<figure class="highlight ts"><figcaption><span>amplify/backend/api/festivalapi/schema.graphql</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Stage <span class="meta">@model</span></span><br><span class="line">  <span class="meta">@auth</span>(rules: [</span><br><span class="line">    &#123; allow: <span class="keyword">public</span>, operations: [read] &#125;,</span><br><span class="line">    &#123; allow: groups, groups: [<span class="string">"Admin"</span>] &#125;</span><br><span class="line">  ])</span><br><span class="line">&#123;</span><br><span class="line">  id: ID!</span><br><span class="line">  name: <span class="built_in">String</span>!</span><br><span class="line">  performances: [Performance] <span class="meta">@connection</span>(keyName: <span class="string">"byStageId"</span>, fields: [<span class="string">"id"</span>])</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Performance <span class="meta">@model</span></span><br><span class="line">  <span class="meta">@key</span>(name: <span class="string">"byStageId"</span>, fields: [<span class="string">"performanceStageId"</span>])</span><br><span class="line">  <span class="meta">@auth</span>(rules: [</span><br><span class="line">    &#123; allow: <span class="keyword">public</span>, operations: [read] &#125;,</span><br><span class="line">    &#123; allow: groups, groups: [<span class="string">"Admin"</span>] &#125;</span><br><span class="line">  ])</span><br><span class="line">&#123;</span><br><span class="line">  id: ID!</span><br><span class="line">  performanceStageId: ID!</span><br><span class="line">  productId: ID</span><br><span class="line">  performer: <span class="built_in">String</span>!</span><br><span class="line">  imageUrl: <span class="built_in">String</span></span><br><span class="line">  description: <span class="built_in">String</span>!</span><br><span class="line">  time: <span class="built_in">String</span></span><br><span class="line">  stage: Stage <span class="meta">@connection</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>讓我們看看我們使用的指令及其工作方式。</p>
<ul>
<li><p>@auth<br>首先，@auth 指令允許我們傳入一個陣列的身份驗證規則。 每個規則都有一個 allow 字段(必要)以及其他元數據(可選)，包括諸如指定身份驗證提供者(如果它與預設授權類型不同)之類的事情。</p>
<p>在 Stage 和 Performance 類型中，我們使用了兩種授權類型，一種用於群組存取 (groups)，另一種用於公共存取 (public)。 對於 public，我們還設置 operations 陣列。 該陣列應包含我們要在 API 上啟用的操作的列表。 如果未列出任何操作，則預設情況下將啟用所有操作。</p>
</li>
<li><p>@key<br>@key 指令使我們能夠添加 DynamoDB 表的 GSI 和對鍵進行排序。 在這個架構中，我們創建了一個名為 byStageId 的鍵，該鍵將允許我們使用 Performance 表上的 performanceStageId 字段按表演廳的 ID 查詢 Performance 表中的節目。 Stage 類型上的 performances 字段的解析器將使用該表演廳的 ID 來讀取該表演廳的所有節目。</p>
</li>
<li><p>@connection<br>@connection 指令允許我們對類型之間的關係進行建模。 可以創建的關係類型可以是: 一對多、多對一、或多對多。 在此示例中，我們創建了兩個關係。</p>
<ul>
<li>表演廳與節目之間的關係(一個表演廳有很多表演節目)</li>
<li>節目與表演廳之間的關係(表演節目僅屬於一個表演廳)</li>
</ul>
</li>
</ul>
<h5 id="部署服務"><a href="#部署服務" class="headerlink" title="部署服務"></a>部署服務</h5><p>配置了所有服務之後，我們就可以部署後端了：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">amplify push</span><br></pre></td></tr></table></figure>

<p>部署完成後，你可以隨時查詢 Amplify 專案狀態:</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">amplify status</span><br><span class="line"></span><br><span class="line">Current Environment: pecftadev</span><br><span class="line"></span><br><span class="line">| Category | Resource name                       | Operation | Provider plugin   |</span><br><span class="line">| -------- | ----------------------------------- | --------- | ----------------- |</span><br><span class="line">| Function | festivalapp0ed53a88PostConfirmation | No Change | awscloudformation |</span><br><span class="line">| Auth     | festivalapp0ed53a88                 | No Change | awscloudformation |</span><br><span class="line">| Api      | festivalapi                         | No Change | awscloudformation |</span><br><span class="line"></span><br><span class="line">GraphQL endpoint: ... </span><br><span class="line">GraphQL API KEY: ...</span><br></pre></td></tr></table></figure>

<p>服務已部署，我們可以開始編寫客戶端代碼。</p>
<h4 id="建立前端"><a href="#建立前端" class="headerlink" title="建立前端"></a>建立前端</h4><p>我們要做的第一件事是在 src 目錄中創建此應用程序所需的程式檔：</p>
<p>  Container.js、Footer.js、Nav.js、Admin.js、Router.js、Performance.js 、與 Home.js。</p>
<p>下一步是打開 src/index.js 添加 Amplify 配置，導入 Ant Design 樣式，並用即將創建的 Router 組件替換主要組件。 </p>
<figure class="highlight jsx"><figcaption><span>src/index.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"><span class="keyword">import</span> ReactDOM <span class="keyword">from</span> <span class="string">'react-dom'</span></span><br><span class="line"><span class="keyword">import</span> Router <span class="keyword">from</span> <span class="string">'./Router'</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">'antd/dist/antd.css'</span></span><br><span class="line"><span class="keyword">import</span> Amplify <span class="keyword">from</span> <span class="string">'aws-amplify'</span></span><br><span class="line"><span class="keyword">import</span> config <span class="keyword">from</span> <span class="string">'./aws-exports'</span></span><br><span class="line">Amplify.configure(config)</span><br><span class="line"></span><br><span class="line">ReactDOM.render(</span><br><span class="line">  &lt;Router /&gt;,  </span><br><span class="line">  <span class="built_in">document</span>.getElementById(<span class="string">'root'</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h5 id="Container"><a href="#Container" class="headerlink" title="Container"></a>Container</h5><p>現在，讓我們創建一個 Container 組件，該組件將用作<strong>可重用的組件</strong>，為我們的視圖添加間距與樣式：</p>
<figure class="highlight jsx"><figcaption><span>src/Container.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Container = <span class="function">(<span class="params">&#123; children &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div style=&#123;container&#125;&gt;</span><br><span class="line">      &#123; children &#125;</span><br><span class="line">    &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">  )</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">const container = &#123;</span></span><br><span class="line"><span class="regexp">  padding: '30px 40px',</span></span><br><span class="line"><span class="regexp">  minHeight: 'calc(100vh - 120px)'</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">export default Container</span></span><br></pre></td></tr></table></figure>

<h5 id="Footer"><a href="#Footer" class="headerlink" title="Footer"></a>Footer</h5><p>這裡，我們將創建 Footer 組件，該組件也是一個可重用的組件，以添加基本的頁腳，並提供一個鏈接，使管理員可以註冊和登錄：</p>
<figure class="highlight jsx"><figcaption><span>src/Footer.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"><span class="keyword">import</span> &#123; Link &#125; <span class="keyword">from</span> <span class="string">'react-router-dom'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Footer = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div style=&#123;footerStyle&#125;&gt;</span><br><span class="line">      &lt;Link to=<span class="string">"/admin"</span>&gt;</span><br><span class="line">        Admins</span><br><span class="line">      &lt;<span class="regexp">/Link&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>div&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> footerStyle = &#123;</span><br><span class="line">  borderTop: <span class="string">'1px solid #ddd'</span>,</span><br><span class="line">  display: <span class="string">'flex'</span>,</span><br><span class="line">  alignItems: <span class="string">'center'</span>,</span><br><span class="line">  padding: <span class="number">20</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> Footer</span><br></pre></td></tr></table></figure>

<h5 id="Nav"><a href="#Nav" class="headerlink" title="Nav"></a>Nav</h5><p>現在，打開 src/Nav.js 創建基本的應用程序導航。 只有一個鏈接：回到主視圖的鏈接，其中將列出所有表演廳和節目表：</p>
<figure class="highlight jsx"><figcaption><span>src/Nav.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"><span class="keyword">import</span> &#123; Link &#125; <span class="keyword">from</span> <span class="string">'react-router-dom'</span></span><br><span class="line"><span class="keyword">import</span> &#123; Menu &#125; <span class="keyword">from</span> <span class="string">'antd'</span></span><br><span class="line"><span class="keyword">import</span> &#123; HomeOutlined &#125; <span class="keyword">from</span> <span class="string">'@ant-design/icons'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Nav = <span class="function">(<span class="params">&#123; current &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;Menu selectedKeys=&#123;[current]&#125; mode=<span class="string">"horizontal"</span>&gt;</span><br><span class="line">        &lt;Menu.Item key=<span class="string">'home'</span>&gt;</span><br><span class="line">          &lt;Link to=&#123;<span class="string">'/'</span>&#125;&gt;</span><br><span class="line">            &lt;HomeOutlined /&gt;Home</span><br><span class="line">          &lt;<span class="regexp">/Link&gt;</span></span><br><span class="line"><span class="regexp">        &lt;/</span>Menu.Item&gt;</span><br><span class="line">      &lt;<span class="regexp">/Menu&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>div&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> Nav</span><br></pre></td></tr></table></figure>

<h5 id="Admin"><a href="#Admin" class="headerlink" title="Admin"></a>Admin</h5><p>將創建的 Admin 組件僅做三件事：允許用戶註冊、登錄、和登出。 該組件是為管理員提供一種註冊方法，以便他們可以隨後以管理員身份創建和管理 API。</p>
<p>請記住，當某人註冊時，如果在 Lambda 觸發器中驗證了他們的電子郵件，則他們將在註冊後被置於 Admin 群組中。 然後，他們將能夠執行 GraphQL mutations 操作來創建、更新、和刪除表演廳和節目。</p>
<p>如果你需要更新諸如 GraphQL schema 或 Lambda 函式之類的後端代碼，可以先在本地端進行更改，然後執行 amplify push 將更改部署到後端。</p>
<figure class="highlight js"><figcaption><span>src/Admin.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"><span class="keyword">import</span> &#123; withAuthenticator, AmplifySignOut &#125; <span class="keyword">from</span> <span class="string">'@aws-amplify/ui-react'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Admin = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;h1 style=&#123;titleStyle&#125;&gt;Admin&lt;<span class="regexp">/h1&gt;</span></span><br><span class="line"><span class="regexp">      &lt;AmplifySignOut /</span>&gt;</span><br><span class="line">    &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">  )</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">const titleStyle = &#123;</span></span><br><span class="line"><span class="regexp">  fontWeight: 'normal',</span></span><br><span class="line"><span class="regexp">  margin: '0px 0px 10px 0px'</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">export default withAuthenticator(Admin)</span></span><br></pre></td></tr></table></figure>

<h5 id="Router"><a href="#Router" class="headerlink" title="Router"></a>Router</h5><figure class="highlight jsx"><figcaption><span>src/Router.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; useState, useEffect &#125; <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"><span class="keyword">import</span> &#123; HashRouter, Switch, Route &#125; <span class="keyword">from</span> <span class="string">'react-router-dom'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> Home <span class="keyword">from</span> <span class="string">'./Home'</span></span><br><span class="line"><span class="keyword">import</span> Admin <span class="keyword">from</span> <span class="string">'./Admin'</span></span><br><span class="line"><span class="keyword">import</span> Nav <span class="keyword">from</span> <span class="string">'./Nav'</span></span><br><span class="line"><span class="keyword">import</span> Footer <span class="keyword">from</span> <span class="string">'./Footer'</span></span><br><span class="line"><span class="keyword">import</span> Container <span class="keyword">from</span> <span class="string">'./Container'</span></span><br><span class="line"><span class="keyword">import</span> Performance <span class="keyword">from</span> <span class="string">'./Performance'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Router = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> [current, setCurrent] = useState(<span class="string">'home'</span>)</span><br><span class="line"></span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    setRoute()</span><br><span class="line">    <span class="built_in">window</span>.addEventListener(<span class="string">'hashchange'</span>, setRoute)</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">window</span>.removeEventListener(<span class="string">'hashchange'</span>, setRoute)    </span><br><span class="line">  &#125;, [])</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">setRoute</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> location = <span class="built_in">window</span>.location.href.split(<span class="string">'/'</span>)</span><br><span class="line">    <span class="keyword">const</span> pathname = location[location.length - <span class="number">1</span>]</span><br><span class="line">    setCurrent(pathname ? pathname : <span class="string">'home'</span>)  </span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;HashRouter&gt;</span><br><span class="line">      &lt;Nav current=&#123;current&#125; /&gt;</span><br><span class="line">      &lt;Container&gt;</span><br><span class="line">        &lt;Switch&gt;</span><br><span class="line">          &lt;Route exact path=<span class="string">"/"</span> component=&#123;Home&#125; /&gt;</span><br><span class="line">          &lt;Route exact path=<span class="string">"/performance/:id"</span> component=&#123;Performance&#125; /&gt;</span><br><span class="line">          &lt;Route exact path=<span class="string">"/admin"</span> component=&#123;Admin&#125; /&gt;</span><br><span class="line">        &lt;<span class="regexp">/Switch&gt;</span></span><br><span class="line"><span class="regexp">      &lt;/</span>Container&gt;</span><br><span class="line">      &lt;Footer /&gt;</span><br><span class="line">    &lt;<span class="regexp">/HashRouter&gt;</span></span><br><span class="line"><span class="regexp">  )</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">export default Router</span></span><br></pre></td></tr></table></figure>

<p>在此組件中，我們將路由器與持久性 UI 組件 Container 和 Footer 結合在一起。</p>
<p>這個應用程序具有三個路由：</p>
<ul>
<li>Home<br>這是呈現表演廳和節目的主要路由。</li>
<li>Performance<br>這是呈現個別的節目和節目細節的路由。</li>
<li>Admin<br>這是將為管理員提供 註冊/登錄 頁面的路由。</li>
</ul>
<p>在 Performance 路由中，你將看到我們使用的路由如下：</p>
<pre><code>/performance/:id</code></pre><p>這是使用 URL 參數的方式，符合此路由將使我們能夠在組件本身中使用這個參數。 這很有用，透過路由參數使我們能夠使用節目的 <strong>id</strong> 來獲取節目的詳細信息。 路由參數還使我們能夠輕鬆構建支援深層鏈接的應用程序。</p>
<h5 id="Performance"><a href="#Performance" class="headerlink" title="Performance"></a>Performance</h5><figure class="highlight jsx"><figcaption><span>src/Performance.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; useState, useEffect &#125; <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"><span class="keyword">import</span> &#123; useParams &#125; <span class="keyword">from</span> <span class="string">'react-router-dom'</span></span><br><span class="line"><span class="keyword">import</span> &#123; getPerformance &#125; <span class="keyword">from</span> <span class="string">'./graphql/queries'</span></span><br><span class="line"><span class="keyword">import</span> &#123; API &#125; <span class="keyword">from</span> <span class="string">'aws-amplify'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Performance = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> [performance, setPerformance] = useState(<span class="literal">null</span>)</span><br><span class="line">  <span class="keyword">const</span> [loading, setLoading] = useState(<span class="literal">true</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> &#123; id &#125; = useParams()</span><br><span class="line">  </span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    fetchPerformanceInfo()</span><br><span class="line">  &#125;, [])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">fetchPerformanceInfo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> performanceInfo = <span class="keyword">await</span> API.graphql(&#123;</span><br><span class="line">        query: getPerformance,</span><br><span class="line">        variables: &#123; id &#125;,</span><br><span class="line">        authMode: <span class="string">'API_KEY'</span></span><br><span class="line">      &#125;)</span><br><span class="line">      setPerformance(performanceInfo.data.getPerformance)</span><br><span class="line">      setLoading(<span class="literal">false</span>)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'error fetching performance info...'</span>, err)</span><br><span class="line">      setLoading(<span class="literal">false</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;p&gt;節目資訊&lt;<span class="regexp">/p&gt;</span></span><br><span class="line"><span class="regexp">      &#123; loading &amp;&amp; &lt;h3&gt;Loading...&lt;/</span>h3&gt; &#125;</span><br><span class="line">      &#123;</span><br><span class="line">        performance &amp;&amp; (</span><br><span class="line">          &lt;div&gt;</span><br><span class="line">            &lt;h1&gt;&#123;performance.performer&#125;&lt;<span class="regexp">/h1&gt;</span></span><br><span class="line"><span class="regexp">            &lt;h3&gt;&#123;performance.time&#125;&lt;/</span>h3&gt;</span><br><span class="line">            &lt;p&gt;&#123;performance.description&#125;&lt;<span class="regexp">/p&gt;</span></span><br><span class="line"><span class="regexp">          &lt;/</span>div&gt;</span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">    &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">  )</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">export default Performance</span></span><br></pre></td></tr></table></figure>

<p>這個組件的 render 方法非常基礎。 它只是呈現演出者、時間、和描述。 關於此組件的重點在於我們如何獲取該信息。</p>
<ol>
<li>我們使用 useState 掛鉤創建兩個狀態：loading (預設為 true) 和 performance (預設為 null)。 我們還創建了一個名為 id 的變數，該變數使用 React Router 中的 useParams 獲取路由參數 id 的值。</li>
<li>加載組件時，我們使用 useEffect 掛鉤立即調用 fetchPerformanceInfo 函式。</li>
<li>fetchPerformanceInfo 函式使用路由參數中的 id 來調用 AppSync API。 這裡的 API 調用使用 API.graphql，傳入 variables，query 和 authMode。 預設情況下，這裡的 API 使用 Cognito User Pools 作為身份驗證模式。 每當我們想覆蓋此預設 (例如在這裡的情況下進行 public API 調用) 時，我們需要在 API 調用本身中指定 authMode。</li>
<li>從 API 返回數據後，我們調用 setLoading 和 setPerformance 來更新 UI 以呈現從 API 返回的數據。</li>
</ol>
<h5 id="Home"><a href="#Home" class="headerlink" title="Home"></a>Home</h5><p>現在，讓我們創建最後一個組件，Home 組件：</p>
<figure class="highlight jsx"><figcaption><span>src/Home.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; useState, useEffect &#125; <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"><span class="keyword">import</span> &#123; API &#125; <span class="keyword">from</span> <span class="string">'aws-amplify'</span></span><br><span class="line"><span class="keyword">import</span> &#123; listStages &#125; <span class="keyword">from</span> <span class="string">'./graphql/queries'</span></span><br><span class="line"><span class="keyword">import</span> &#123; Link &#125; <span class="keyword">from</span> <span class="string">'react-router-dom'</span></span><br><span class="line"><span class="keyword">import</span> &#123; List &#125; <span class="keyword">from</span> <span class="string">'antd'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Home = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> [stages, setStages] = useState([])</span><br><span class="line">  <span class="keyword">const</span> [loading, setLoading] = useState(<span class="literal">true</span>)</span><br><span class="line">  </span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    getStages()</span><br><span class="line">  &#125;, [])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">getStages</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> apiData = <span class="keyword">await</span> API.graphql(&#123;</span><br><span class="line">        query: listStages,</span><br><span class="line">        authMode: <span class="string">'API_KEY'</span></span><br><span class="line">      &#125;)</span><br><span class="line">      <span class="keyword">const</span> &#123; <span class="attr">data</span>: &#123; <span class="attr">listStages</span>: &#123; items &#125;&#125;&#125; = apiData</span><br><span class="line">      setStages(items)</span><br><span class="line">      setLoading(<span class="literal">false</span>)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'error fetching stages list...'</span>, err)</span><br><span class="line">      setLoading(<span class="literal">false</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;h1 style=&#123;heading&#125;&gt;表演廳院&lt;<span class="regexp">/h1&gt;</span></span><br><span class="line"><span class="regexp">      &#123; loading &amp;&amp; &lt;h2&gt;Loading...&lt;/</span>h2&gt; &#125;</span><br><span class="line">      &#123;</span><br><span class="line">        stages.map(<span class="function"><span class="params">stage</span> =&gt;</span> (</span><br><span class="line">          &lt;div key=&#123;stage.id&#125; style=&#123;stageInfo&#125;&gt;</span><br><span class="line">            &lt;p style=&#123;infoHeading&#125;&gt;&#123;stage.name&#125;&lt;<span class="regexp">/p&gt;</span></span><br><span class="line"><span class="regexp">            &lt;p style=&#123;infoTitle&#125;&gt;節目表&lt;/</span>p&gt;</span><br><span class="line">            &lt;List </span><br><span class="line">              itemLayout=<span class="string">"horizontal"</span></span><br><span class="line">              dataSource=&#123;stage.performances.items&#125;</span><br><span class="line">              renderItem=&#123;performance =&gt; (</span><br><span class="line">                &lt;List.Item&gt;</span><br><span class="line">                  &lt;List.Item.Meta </span><br><span class="line">                    title=&#123;&lt;Link style=&#123;performerInfo&#125; </span><br><span class="line">                                 to=&#123;<span class="string">`/performance/<span class="subst">$&#123;performance.id&#125;</span>`</span>&#125;</span><br><span class="line">                            &gt;&#123; performance.performer &#125;&lt;<span class="regexp">/Link&gt;</span></span><br><span class="line"><span class="regexp">                          &#125;</span></span><br><span class="line"><span class="regexp">                    description=&#123;performance.time&#125;</span></span><br><span class="line"><span class="regexp">                  /</span>&gt;</span><br><span class="line">                &lt;<span class="regexp">/List.Item&gt;</span></span><br><span class="line"><span class="regexp">              )&#125;</span></span><br><span class="line"><span class="regexp">            /</span>&gt;</span><br><span class="line">          &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">        ))</span></span><br><span class="line"><span class="regexp">      &#125;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>div&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> heading = &#123; <span class="attr">fontSize</span>: <span class="number">44</span>, <span class="attr">fontWeight</span>: <span class="number">300</span>, <span class="attr">marginBottom</span>: <span class="number">5</span> &#125;</span><br><span class="line"><span class="keyword">const</span> stageInfo = &#123; <span class="attr">padding</span>: <span class="string">'20px 0px 10px'</span>, <span class="attr">borderBottom</span>: <span class="string">'2px solid #ddd'</span> &#125;</span><br><span class="line"><span class="keyword">const</span> infoTitle = &#123; <span class="attr">fontWeight</span>: <span class="string">'bold'</span>, <span class="attr">fontSize</span>: <span class="number">18</span> &#125;</span><br><span class="line"><span class="keyword">const</span> infoHeading = &#123; <span class="attr">fontSize</span>: <span class="number">30</span>, <span class="attr">marginBottom</span>: <span class="number">5</span> &#125;</span><br><span class="line"><span class="keyword">const</span> performerInfo = &#123; <span class="attr">fontSize</span>: <span class="number">24</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> Home</span><br></pre></td></tr></table></figure>

<p>這個組件中的邏輯實際上與我們在 Performance 組件中所做的非常相似。</p>
<p>現在，應用程序已完成，但還有一件事。 因為我們為 performances 解析器創建了自定義存取模式，所以我們需要更新 listStages 查詢定義，以便也能返回與表演廳相關的節目表。 為此，使用以下命令更新 listStages 查詢：</p>
<figure class="highlight ts"><figcaption><span>src/graphql/queries.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> listStages = <span class="comment">/* GraphQL */</span> <span class="string">`</span></span><br><span class="line"><span class="string">  query ListStages(</span></span><br><span class="line"><span class="string">    $filter: ModelStageFilterInput</span></span><br><span class="line"><span class="string">    $limit: Int</span></span><br><span class="line"><span class="string">    $nextToken: String</span></span><br><span class="line"><span class="string">  ) &#123;</span></span><br><span class="line"><span class="string">    listStages(filter: $filter, limit: $limit, nextToken: $nextToken) &#123;</span></span><br><span class="line"><span class="string">      items &#123;</span></span><br><span class="line"><span class="string">        id</span></span><br><span class="line"><span class="string">        name</span></span><br><span class="line"><span class="string">        createdAt</span></span><br><span class="line"><span class="string">        updatedAt</span></span><br><span class="line"><span class="string">        performances &#123;</span></span><br><span class="line"><span class="string">          items &#123;</span></span><br><span class="line"><span class="string">            id</span></span><br><span class="line"><span class="string">            time</span></span><br><span class="line"><span class="string">            performer</span></span><br><span class="line"><span class="string">            description</span></span><br><span class="line"><span class="string">          &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">      nextToken</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">`</span>;</span><br></pre></td></tr></table></figure>

<p>現在，我們可以加入一些數據。 啟動應用程序並註冊一個管理員用戶：</p>
<pre><code>yarn start</code></pre><p>單擊頁腳中的 Admins 鏈接進行註冊。</p>
<p>我們在這應用程序範例中沒有建立可以創建，更新或刪除表演廳與節目的 UI 介面，所以我們要直接使用 AWS AppSync 控制台來加入一些數據。註冊一個管理員用戶後，打開 AppSync 控制台：</p>
<pre><code>amplify console api</code></pre><p>選擇 GraphQL。</p>
<p>在控制台的 Queries 面板中，您需要單擊 <strong>Login with User Pools</strong> 然後用剛創建的用戶的 username 和 password 登錄。 當提示你輸入 ClientID 時，請使用專案的 src/aws-exports.js 文件中的 aws_user_pools_web_client_id。</p>
<p>接下來在 AppSync 控制台的 Queries 面板中，創建表演廳和節目：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">mutation createStage &#123;</span><br><span class="line">  createStage(input: &#123;</span><br><span class="line">    id: &quot;stage-1&quot;</span><br><span class="line">    name: &quot;音樂廳&quot;</span><br><span class="line">  &#125;) &#123;</span><br><span class="line">    id name</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mutation createPerformance &#123;</span><br><span class="line">  createPerformance(input: &#123;</span><br><span class="line">    performanceStageId: &quot;stage-1&quot;</span><br><span class="line">    performer: &quot;小提琴家胡乃元&quot;</span><br><span class="line">    description: &quot;與大師有約　聽見不凡聲響。活躍於國內外藝術季及演出的對位室內樂團，邀請比利時伊莉莎白女王國際音樂大賽首獎得主–小提琴家胡乃元，演奏經典的布魯赫《第一號小提琴協奏曲》&quot;</span><br><span class="line">    time: &quot;2020/11/29 (日) 15:00&quot;</span><br><span class="line">  &#125;) &#123;</span><br><span class="line">    id performer description</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>現在，我們的數據庫具有一些數據，我們應該能夠在我們的應用程序中查看它，並在主畫面和節目詳細資訊畫面視圖之間切換導航。</p>
<img src="/2020/11/17/AWS-AppSync/20201119-01.png" title="AWS AppSync">

<p>在這個範例中學到了幾點：</p>
<ul>
<li>GraphQL Transform 指令使你能夠向 GraphQL API 添加強大的功能，例如身份驗證規則，關係和用於其他數據存取模式的自定義索引。</li>
<li>@auth 指令允許你傳入規則陣列以定義類型和字段的授權規則。</li>
<li>@connection 指令使你可以對 GraphQL 類型之間的關係進行建模。</li>
<li>@key 指令使你能夠為自定義數據存取模式定義自定義索引並增強現有關係。</li>
<li>當創建具有多種授權類型的 API 時，進行 API 調用時會使用預設的主要授權類型。 如果需要覆蓋主要授權類型時，可以使用 API 類 authMode 參數傳遞你要使用的授權類型。</li>
</ul>
<p>我們完成了一個 Serverless 的應用程序，而且幾乎沒有寫到伺服端的程式碼。也不需要擔心認證、授權、與資料庫的維護、安全、與效能問題。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://1184yang.github.io/2020/11/11/AWS-Offline-Apps-with-Amplify-DataStore/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/1184yang.jpg">
      <meta itemprop="name" content="J.Y. Yang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/11/11/AWS-Offline-Apps-with-Amplify-DataStore/" class="post-title-link" itemprop="url">AWS Offline Apps with Amplify DataStore</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2020-11-11 14:50:56" itemprop="dateCreated datePublished" datetime="2020-11-11T14:50:56+08:00">2020-11-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2020-12-24 18:13:30" itemprop="dateModified" datetime="2020-12-24T18:13:30+08:00">2020-12-24</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/JavaScript/" itemprop="url" rel="index"><span itemprop="name">JavaScript</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/AWS/" itemprop="url" rel="index"><span itemprop="name">AWS</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>Offline first</strong> 是一種軟件開發方法，開發人員可以構建應用程序的核心功能，以在有或沒有 Internet 連接的情況下正常運行。借助 Offline first 方法，數據可以在本地端寫入終端用戶的設備上，並定期上傳和復製到雲中。</p>
<p>Offline first 策略的一個重要目標是在互聯網連接速度慢或不存在時為終端用戶提供一致的用戶體驗(UX)。該體系結構將數據和應用程序邏輯推送到網絡邊緣(network edge)，並且大多數處理都在終端用戶的設備上進行。</p>
<blockquote>
<blockquote>
<p>將所有裝置產生的資料傳送至集中式資料中心，或傳送至雲端，會造成頻寬及延遲問題。<strong>邊緣運算(Edge computing)</strong>提供更有效率的替代方案：在更接近資料建立的位置處理及分析資料。因為不需將資料傳送到雲端或資料中心進行處理，因此大幅減少延遲現象。邊緣運算 － 以及 5G 網路上的行動式邊緣運算 － 能提供更快更全面的資料分析、產生更深入的洞察、具有更快的回應時間，以及改善客戶體驗。而終端用戶端的計算機也可視為<strong>網絡邊緣(network edge)</strong>。</p>
</blockquote>
</blockquote>
<p>這種方法不僅確保了應用程序的核心功能在沒有可靠的網絡連接的情況下仍能正常工作，而且還為移動用戶提供了電池資源和頻寬的更有效利用。對於旅行和體驗互聯網覆蓋盲區的終端用戶而言，這一點尤其重要。</p>
<h3 id="AWS-Offline-Apps"><a href="#AWS-Offline-Apps" class="headerlink" title="AWS Offline Apps"></a>AWS Offline Apps</h3><p>到目前為止，我們已經使用了 REST API 和 GraphQL API。 在使用 GraphQL API 時，我們在本地端使用 API class 直接調用 GraphQL API 的 <em>mutations</em> 和 <em>queries</em>。</p>
<p>Amplify 還支援另一種與 AppSync 互動的 API：<strong>Amplify DataStore</strong>。 與一般的 GraphQL API 比較，DataStore 具有一些不同的方法。</p>
<p>DataStore 引入了客戶端 SDK(client-side SDK)，它允許你使用本地端存儲引擎(local storage engine)進行讀寫操作，並保留這些數據。(例如使用，Web 的 IndexDB 和用於 iOS 和 Android 的 SQLite)。然後，DataStore 會自動將本地端數據透過 GraphQL API 同步到遠端存儲。記得我們也曾經使用 PouchDB 與 CouchDB 做過本地端與遠端數據的同步。這裡則是 DataStore 本地端自動透過 GraphQL API 同步到雲端的存儲。</p>
<p>使用 DataStore SDK，你只需直接執行 save、update 和 delete 之類的操作，即可直接寫入 DataStore 本身。 DataStore 可以為你處理其他所有事情：當你有 Internet 網路連接時，它會將數據同步到雲中；如果你離線時，則將會保留在 queue 中，在下次連線時將其同步到雲中。</p>
<p>DataStore 有三種內置的衝突解決策略來為您處理衝突檢測和解決方式:</p>
<ul>
<li>AutoMerge<br>在運行時檢查 GraphQL 類型的物件信息，以執行合併操作 (建議的選項)。</li>
<li>Optimistic concurrency<br>傳入的記錄將與資料庫中最後寫入的項目進行版本檢查。</li>
<li>Custom<br>使用 Lambda 函式將所需的自定義合併或拒絕更新業務邏輯寫入流程。</li>
</ul>
<h3 id="Amplify-DataStore"><a href="#Amplify-DataStore" class="headerlink" title="Amplify DataStore"></a>Amplify DataStore</h3><p>Amplify DataStore 是以下各項的組合：</p>
<ul>
<li>AppSync GraphQL API</li>
<li>本地端存儲庫和同步引擎，也可以離線保存數據</li>
<li>用於與本地端存儲庫互動的客戶端 SDK。</li>
<li>啟用特殊的同步 GraphQL 解析器(由 Amplify CLI 自動產生的)，可在伺服器上實現複雜的衝突檢測和衝突解決。</li>
</ul>
<h4 id="Amplify-DataStore-概觀"><a href="#Amplify-DataStore-概觀" class="headerlink" title="Amplify DataStore 概觀"></a>Amplify DataStore 概觀</h4><p>開始使用 DataStore 時，仍然可以像創建一般的 API 一樣。 主要區別是，在創建 API 時，在 Amplify CLI 的進階設置中啟用 <strong>conflict detection</strong> 衝突檢測。</p>
<p>創建 GraphQL API 後接著要在客戶端上啟用 DataStore，我們需要為 DataStore 創建資料模型以用於與存儲庫互動。這只需依據已經存在的 GraphQL schema 定義，並執行 <strong>amplify codegen models</strong> CLI 構建命令，即可輕鬆實現。</p>
<h4 id="Amplify-DataStore-Operations"><a href="#Amplify-DataStore-Operations" class="headerlink" title="Amplify DataStore Operations"></a>Amplify DataStore Operations</h4><table>
<thead>
<tr>
<th>Operation</th>
<th>Commands</th>
</tr>
</thead>
<tbody><tr>
<td>Import the model and <br>DataStore API</td>
<td>import { DataStore } from ‘@aws-amplify/datastore’<br>import { Message } from ‘./models’</td>
</tr>
<tr>
<td>Saving data</td>
<td>await DataStore.save(<br>&nbsp;&nbsp;&nbsp;&nbsp;new Message({<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;title: ‘Hello Tainan’,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sender: ‘Emily’<br>&nbsp;&nbsp;&nbsp;&nbsp;})<br>)</td>
</tr>
<tr>
<td>Reading data</td>
<td>const messages = await DataStore.query(Message)</td>
</tr>
<tr>
<td>Deleting data</td>
<td>const message = await DataStore.query(Message, ‘123’)<br>DataStore.delete(message)</td>
</tr>
<tr>
<td>Updating data</td>
<td>const message = await DataStore.query(Message, ‘123)<br>await DataStore.save(<br>&nbsp;&nbsp;&nbsp;&nbsp;Message.copyOf(message, updated =&gt; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;updated.title = ‘My new title’<br>&nbsp;&nbsp;&nbsp;&nbsp;})<br>)</td>
</tr>
<tr>
<td>Observing/subscribing to<br>changes in data for real-time<br>functionality</td>
<td>const subscription = DataStore<br>&nbsp;&nbsp;&nbsp;&nbsp;.observe(Message)<br>&nbsp;&nbsp;&nbsp;&nbsp;.subscribe(msg =&gt; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;console.log(msg.model, msg.opType, msg.element)<br>&nbsp;&nbsp;});</td>
</tr>
</tbody></table>
<h4 id="DataStore-Predicates"><a href="#DataStore-Predicates" class="headerlink" title="DataStore Predicates"></a>DataStore Predicates</h4><p>你可以使用 GraphQL 類型上定義的字段(field)以及 DynamoDB 支援的條件謂詞對數據存儲應用過濾器：</p>
<pre><code>Strings: eq | ne | le | lt | ge | gt | contains | notContains | beginsWith | between

Numbers: eq | ne | le | lt | ge | gt | between

Lists: contains | notContains</code></pre><p>例如，如果要獲取 title 包含 “Hello” 的所有訊息的列表:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> messages = <span class="keyword">await</span> DataStore</span><br><span class="line">  .query(Message, m =&gt; m.title(<span class="string">'contains'</span>, <span class="string">'Hello'</span>))</span><br></pre></td></tr></table></figure>

<p>也可以將多個條件謂詞鏈接到一個操作中：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> message = <span class="keyword">await</span> DataStore</span><br><span class="line">  .query(Message, m =&gt; m.title(<span class="string">'contains'</span>, <span class="string">'Hello'</span>).sender(<span class="string">'eq'</span>, <span class="string">'Emily'</span>))</span><br></pre></td></tr></table></figure>

<p>這些條件謂詞使你可以透過多種方式從本地數據中檢索不同的選擇集。以這種方式，你無需將整個資料經過網路下載到客戶端然後再檢索整個集合和過濾，直接可以快速的從本地存儲中精確查詢所需的數據。</p>
<h3 id="Building-an-Offline-and-Real-Time-App-with-Amplify-DataStore"><a href="#Building-an-Offline-and-Real-Time-App-with-Amplify-DataStore" class="headerlink" title="Building an Offline and Real-Time App with Amplify DataStore"></a>Building an Offline and Real-Time App with Amplify DataStore</h3><p>了解了基本的運作方式，我們要來實作一個應用程序。這個應用程序的用戶可以創建一條新消息，所有其他用戶將即時收到該消息。如果用戶離線，他們將能夠繼續創建消息，一旦他們重新連上線，這些消息將自動同步到雲端，並且也將會同步取得其他用戶在這段時間所創建的所有消息。而其他用戶也會即時收到你同步到雲端的新消息。</p>
<img src="/2020/11/11/AWS-Offline-Apps-with-Amplify-DataStore/20201112-001.png" title="AWS Offline and Real-Time App">

<p>我們的應用將執行三種類型的 DataStore API 操作：</p>
<ul>
<li>save<br>使用 DataStore 創建一個新項目，將項目保存在本地端，並在背後執行 GraphQL mutation。</li>
<li>query<br>從本地數據存儲中讀取，返回單個項目或列表 (陣列)，並在背後執行 GraphQL query。</li>
<li>observe<br>監聽本地數據存儲中的更改(創建，更新，刪除)，並在背後執行 GraphQL subscription。</li>
</ul>
<h4 id="1-Creating-the-Base-Project"><a href="#1-Creating-the-Base-Project" class="headerlink" title="1. Creating the Base Project"></a>1. Creating the Base Project</h4><p>我們要做的第一件事是創建 React 專案：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">yarn create react-app rtmessageboard</span><br><span class="line"></span><br><span class="line">cd rtmessageboard</span><br><span class="line"></span><br><span class="line">yarn add @aws-amplify/core @aws-amplify/datastore antd react-color</span><br></pre></td></tr></table></figure>

<p>接下來，初始化一個新的 Amplify 專案：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">amplify init</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 請按照步驟為專案命名，環境名稱並設置預設的文本編輯器。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 接受其他所有設置的預設值，然後選擇你的 AWS Profile。</span></span><br></pre></td></tr></table></figure>

<h4 id="2-Creating-the-API"><a href="#2-Creating-the-API" class="headerlink" title="2. Creating the API"></a>2. Creating the API</h4><p>現在，我們將創建 AppSync GraphQL API：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">amplify add api</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">? Please select from one of the below mentioned services: GraphQL</span><br><span class="line">? Provide API name: rtmessageboard</span><br><span class="line">? Choose the default authorization type for the API API key</span><br><span class="line">? Enter a description for the API key: public</span><br><span class="line">? After how many days from now the API key should expire (1-365): 365</span><br><span class="line">? Do you want to configure advanced settings for the GraphQL API Yes, I want to make some additional changes.</span><br><span class="line">? Configure additional auth types? No</span><br><span class="line">? Configure conflict detection? Yes</span><br><span class="line">? Select the default resolution strategy Auto Merge</span><br><span class="line">? Do you have an annotated GraphQL schema? No</span><br><span class="line">? Choose a schema template: Single object with fields (e.g., “Todo” with ID, name, description)</span><br><span class="line">? Do you want to edit the schema now? Yes</span><br></pre></td></tr></table></figure>

<p>更改 GraphQL schema：</p>
<figure class="highlight plain"><figcaption><span>amplify/backend/api/rtmessageboard/schema.graphql</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">type Message @model &#123;</span><br><span class="line">  id: ID!</span><br><span class="line">  title: String!</span><br><span class="line">  color: String</span><br><span class="line">  image: String</span><br><span class="line">  createdAt: String</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>現在，我們已經創建了 GraphQL API，並且已經有了一個 GraphQL schema，我們就可以用這個 GraphQL schema 創建本地 DataStore API 所需的資料模型(models)。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">amplify codegen models</span><br></pre></td></tr></table></figure>

<p>這將在我們的專案中創建一個名為 models 的新文件夾。 使用此文件夾中的模型，我們可以開始與 DataStore API 進行互動。</p>
<p>部署 API：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">amplify push --y</span><br></pre></td></tr></table></figure>

<h4 id="3-客戶端代碼"><a href="#3-客戶端代碼" class="headerlink" title="3. 客戶端代碼"></a>3. 客戶端代碼</h4><p>首先，打開 src/index.js 在最後一行 import 下面添加以下代碼來配置 Amplify 應用：</p>
<figure class="highlight javascript"><figcaption><span>src/index.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">'antd/dist/antd.css'</span></span><br><span class="line"><span class="keyword">import</span> Amplify <span class="keyword">from</span> <span class="string">'@aws-amplify/core'</span></span><br><span class="line"><span class="keyword">import</span> config <span class="keyword">from</span> <span class="string">'./aws-exports'</span></span><br><span class="line">Amplify.configure(config)</span><br></pre></td></tr></table></figure>

<p>接下來，打開 src/App.js 並使用以下代碼進行更新:</p>
<figure class="highlight javascript"><figcaption><span>src/App.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; useState, useEffect &#125; <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"><span class="keyword">import</span> &#123; SketchPicker &#125; <span class="keyword">from</span> <span class="string">'react-color'</span></span><br><span class="line"><span class="keyword">import</span> &#123; Input, Button &#125; <span class="keyword">from</span> <span class="string">'antd'</span></span><br><span class="line"><span class="keyword">import</span> &#123; DataStore &#125; <span class="keyword">from</span> <span class="string">'@aws-amplify/datastore'</span></span><br><span class="line"><span class="keyword">import</span> &#123; Message &#125; <span class="keyword">from</span> <span class="string">'./models'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> initialState = &#123;<span class="attr">color</span>: <span class="string">'#000000'</span>, <span class="attr">title</span>: <span class="string">''</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">App</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [formState, updateFormState] = useState(initialState)</span><br><span class="line">  <span class="keyword">const</span> [messages, updateMessages] = useState([])</span><br><span class="line">  <span class="keyword">const</span> [showPicker, updateShowPicker] = useState(<span class="literal">false</span>)</span><br><span class="line">  </span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    fetchMessages()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> subscription = DataStore</span><br><span class="line">      .observe(Message)</span><br><span class="line">      .subscribe(<span class="function"><span class="params">()</span> =&gt;</span> fetchMessages())</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> subscription.unsubscribe()</span><br><span class="line">  &#125;, [])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">fetchMessages</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> messages = <span class="keyword">await</span> DataStore.query(Message)</span><br><span class="line">    updateMessages(messages)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">onChange</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (e.hex) &#123;</span><br><span class="line">      updateFormState(&#123; ...formState, <span class="attr">color</span>: e.hex &#125;)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      updateFormState(&#123; ...formState, [e.target.name]: e.target.value &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">createMessage</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!formState.title) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> DataStore.save(<span class="keyword">new</span> Message(&#123; ...formState &#125;))</span><br><span class="line">    updateFormState(initialState)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">deleteMessage</span>(<span class="params">id</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> message = <span class="keyword">await</span> DataStore.query(Message, id)</span><br><span class="line">    DataStore.delete(message)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div style=&#123;container&#125;&gt;</span><br><span class="line">      &lt;h1 style=&#123;heading&#125;&gt;Real Time Message Board&lt;<span class="regexp">/h1&gt;</span></span><br><span class="line"><span class="regexp">      &lt;Input </span></span><br><span class="line"><span class="regexp">        onChange=&#123;onChange&#125;</span></span><br><span class="line"><span class="regexp">        name="title"</span></span><br><span class="line"><span class="regexp">        placeholder="Message title"</span></span><br><span class="line"><span class="regexp">        value=&#123;formState.title&#125;</span></span><br><span class="line"><span class="regexp">        style=&#123;input&#125;</span></span><br><span class="line"><span class="regexp">      /</span>&gt;</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;Button</span><br><span class="line">          onClick=&#123;() =&gt; updateShowPicker(!showPicker)&#125;</span><br><span class="line">          style=&#123;button&#125;</span><br><span class="line">        &gt;切換顏色選擇器&lt;<span class="regexp">/Button&gt;</span></span><br><span class="line"><span class="regexp">        &lt;p&gt;Color:</span></span><br><span class="line"><span class="regexp">          &lt;span style=&#123;&#123;fontWeight: 'bold', color: formState.color&#125;&#125;&gt;</span></span><br><span class="line"><span class="regexp">            &#123;formState.color&#125;</span></span><br><span class="line"><span class="regexp">          &lt;/</span>span&gt;</span><br><span class="line">        &lt;<span class="regexp">/p&gt;</span></span><br><span class="line"><span class="regexp">      &lt;/</span>div&gt;</span><br><span class="line">      &#123;</span><br><span class="line">        showPicker &amp;&amp; (</span><br><span class="line">          &lt;SketchPicker </span><br><span class="line">            color=&#123;formState.color&#125;</span><br><span class="line">            onChange=&#123;onChange&#125;</span><br><span class="line">          /&gt;</span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">      &lt;Button type=<span class="string">"primary"</span> onClick=&#123;createMessage&#125;&gt;Create Message&lt;<span class="regexp">/Button&gt;</span></span><br><span class="line"><span class="regexp">      &#123;</span></span><br><span class="line"><span class="regexp">        messages.map(message =&gt; (</span></span><br><span class="line"><span class="regexp">          &lt;div </span></span><br><span class="line"><span class="regexp">            key=&#123;message.id&#125;</span></span><br><span class="line"><span class="regexp">            style=&#123;&#123;...messageStyle, backgroundColor: message.color&#125;&#125;</span></span><br><span class="line"><span class="regexp">            onDoubleClick=&#123;() =&gt; deleteMessage(message.id)&#125;</span></span><br><span class="line"><span class="regexp">          &gt;</span></span><br><span class="line"><span class="regexp">            &lt;div style=&#123;messageBg&#125;&gt;</span></span><br><span class="line"><span class="regexp">              &lt;p style=&#123;messageTitle&#125;&gt;&#123;message.title&#125;&lt;/</span>p&gt;</span><br><span class="line">            &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">          &lt;/</span>div&gt;</span><br><span class="line">        ))</span><br><span class="line">      &#125;</span><br><span class="line">    &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">const container = &#123; width: '100%', padding: 40, maxWidth: 900 &#125;</span></span><br><span class="line"><span class="regexp">const input = &#123; marginBottom: 10 &#125;</span></span><br><span class="line"><span class="regexp">const button = &#123; marginBottom: 10 &#125;</span></span><br><span class="line"><span class="regexp">const heading = &#123; fontWeight: 'normal', fontSize: 40 &#125;</span></span><br><span class="line"><span class="regexp">const messageBg = &#123; backgroundColor: 'white' &#125;</span></span><br><span class="line"><span class="regexp">const messageStyle = &#123; padding: '10px', marginTop: 7, borderRadius: 4 &#125;</span></span><br><span class="line"><span class="regexp">const messageTitle = &#123; margin: 0, padding: 9, fontSize: 20 &#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">export default App;</span></span><br></pre></td></tr></table></figure>

<p>讓我們看一下這個組件中重要的部分：</p>
<ol>
<li>我們從 Amplify 導入 DataStore API 以及導入 Message 資料模型</li>
<li>我們使用 useState 掛鉤創建三個組件狀態(Component state)：<ul>
<li>formState<br>這個物件管理表單的狀態，包括將用於顯示消息的 title 與背景顏色的 color。</li>
<li>messages<br>這將管理從 DataStore 提取的消息陣列。</li>
<li>showPicker<br>這將管理一個 Boolean 值，該 Boolean 值將切換顯示或隱藏顏色選擇器，以填充消息的 color 值。</li>
</ul>
</li>
<li>當組件加載時在 useEffect 掛鉤中我們調用 fetchMessages 函式獲取所有消息，並調用 DataStore.observe 創建一個訂閱以偵聽消息更新。當訂閱被觸發時，我們再次調用 fetchMessages 函式以獲取最新的數據來更新應用程序。</li>
<li>fetchMessages 函式調用 DataStore.query，然後使用返回的消息陣列更新組件狀態。</li>
<li>onChange 處理程序處理表單的輸入以及顏色選擇器的更新。</li>
<li>在 createMessage 中，我們首先檢查 title 以確保有值。 如果是，使用 DataStore.save 存儲消息，然後重置表單狀態。</li>
<li>在 deleteMessage 中先用 DataStore.query 取得要刪除的消息，然後使用 DataStore.delete 刪除它。</li>
</ol>
<p>這裡使用 DataStore SDK，你只需直接執行 save、update 和 delete 之類的操作，直接寫入 DataStore 本身。 DataStore 可以為你處理其他所有事情：當你有 Internet 網路連接時，它會將數據同步到雲中；如果你離線時，則將會保留在 queue 中，在下次連線時將其同步到雲中。</p>
<p>啟動應用程序，讓我們測試看看:</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">yarn start</span><br></pre></td></tr></table></figure>

<h4 id="4-測試遠端同步與離線功能"><a href="#4-測試遠端同步與離線功能" class="headerlink" title="4. 測試遠端同步與離線功能"></a>4. 測試遠端同步與離線功能</h4><p>首先在正常連線下創建新的消息，然後觀察本地端的存儲與雲端的存儲。</p>
<img src="/2020/11/11/AWS-Offline-Apps-with-Amplify-DataStore/20201112-003.png" title="AWS Offline and Real-Time App">

<p>要觀察雲端的存儲，請在 AWS 控制台中打開 AppSync API，然後選擇 Data Sources -&gt; MessageTable:</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">amplify console api</span><br></pre></td></tr></table></figure>

<img src="/2020/11/11/AWS-Offline-Apps-with-Amplify-DataStore/20201112-002.png" title="AWS Offline and Real-Time App">

<p>現在，嘗試離線，創建新的消息，觀察兩端的存儲，然後重新連線，再度觀察兩端的存儲。 您應該注意到，當重新連線時，該應用程序在離線時所創建的有消息都同步到雲端的資料庫中。</p>
<img src="/2020/11/11/AWS-Offline-Apps-with-Amplify-DataStore/20201112-004.png" title="AWS Offline and Real-Time App">

<h4 id="5-測試-Real-Time-功能"><a href="#5-測試-Real-Time-功能" class="headerlink" title="5. 測試 Real-Time 功能"></a>5. 測試 Real-Time 功能</h4><p>要測試 Read-Time 即時功能，請打開另一個瀏覽器窗口，或另外找一台電腦開啟瀏覽器窗口。 然後在一個窗口中創建一個新項目，並在另一窗口中查看 UI 介面是否自動更新。也觀察一下離線和重新連線時，即時功能會如何運作。</p>
<p>在此示例中，請注意以下幾點：</p>
<ul>
<li>Amplify 支持兩種不同的 API 與 AppSync 進行互動：API class 以及 DataStore。</li>
<li>使用 DataStore 時，不再需要直接使用 HTTP API 發送請求。 相反的，直接寫入本地端存儲引擎，然後 DataStore 會負責與雲端之間的同步。</li>
<li>預設情況下，Amplify DataStore 使用離線(offline)工作。</li>
<li>這裡，你也學到了基本的 Offline first 與 Edge computing。</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一頁"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目錄
        </li>
        <li class="sidebar-nav-overview">
          本站概要
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="J.Y. Yang"
      src="/images/1184yang.jpg">
  <p class="site-author-name" itemprop="name">J.Y. Yang</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">63</span>
          <span class="site-state-item-name">文章</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">分類</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/1184yang" title="GitHub → https://github.com/1184yang" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:1184yang@gmail.com" title="E-Mail → mailto:1184yang@gmail.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/1184yang" title="Twitter → https://twitter.com/1184yang" rel="noopener" target="_blank"><i class="fa fa-fw fa-twitter"></i>Twitter</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">J.Y. Yang</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/muse.js"></script>
<script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script>



  




  <script src="/js/local-search.js"></script>












  

  

</body>
</html>
