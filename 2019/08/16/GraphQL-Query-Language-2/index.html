<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.9.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=EB Garamond:300,300italic,400,400italic,700,700italic|Cinzel Decorative:300,300italic,400,400italic,700,700italic|Noto Serif TC:300,300italic,400,400italic,700,700italic|Source Code Pro:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"1184yang.github.io","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12,"onmobile":true},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="Fragment你可以將操作的定義及 fragment 放入 GraphQL 查詢文件。fragment 是可在多個操作中重複使用的選擇組(SelectionSet)。我們回到 Snowtooth 的 GraphQL Playground 介面，看一下這個 query: 123456789101112131415161718192021222324query &amp;#123;  Lift(id: &amp;q">
<meta property="og:type" content="article">
<meta property="og:title" content="GraphQL 查詢語言 (2)">
<meta property="og:url" content="https://1184yang.github.io/2019/08/16/GraphQL-Query-Language-2/index.html">
<meta property="og:site_name">
<meta property="og:description" content="Fragment你可以將操作的定義及 fragment 放入 GraphQL 查詢文件。fragment 是可在多個操作中重複使用的選擇組(SelectionSet)。我們回到 Snowtooth 的 GraphQL Playground 介面，看一下這個 query: 123456789101112131415161718192021222324query &amp;#123;  Lift(id: &amp;q">
<meta property="og:locale" content="zh-TW">
<meta property="og:updated_time" content="2020-07-17T08:46:16.054Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="GraphQL 查詢語言 (2)">
<meta name="twitter:description" content="Fragment你可以將操作的定義及 fragment 放入 GraphQL 查詢文件。fragment 是可在多個操作中重複使用的選擇組(SelectionSet)。我們回到 Snowtooth 的 GraphQL Playground 介面，看一下這個 query: 123456789101112131415161718192021222324query &amp;#123;  Lift(id: &amp;q">

<link rel="canonical" href="https://1184yang.github.io/2019/08/16/GraphQL-Query-Language-2/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-TW'
  };
</script>

  <title>GraphQL 查詢語言 (2) | </title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切換導航欄">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title"></h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首頁</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>歸檔</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分類</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜尋
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜尋..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

  <a href="https://github.com/1184yang?tab=repositories" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://1184yang.github.io/2019/08/16/GraphQL-Query-Language-2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/1184yang.jpg">
      <meta itemprop="name" content="J.Y. Yang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          GraphQL 查詢語言 (2)
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2019-08-16 07:49:36" itemprop="dateCreated datePublished" datetime="2019-08-16T07:49:36+08:00">2019-08-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2020-07-17 16:46:16" itemprop="dateModified" datetime="2020-07-17T16:46:16+08:00">2020-07-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/GraphQL/" itemprop="url" rel="index"><span itemprop="name">GraphQL</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h3 id="Fragment"><a href="#Fragment" class="headerlink" title="Fragment"></a>Fragment</h3><p>你可以將操作的定義及 <strong>fragment</strong> 放入 GraphQL 查詢文件。fragment 是可在多個操作中重複使用的選擇組(SelectionSet)。我們回到 <a href="http://snowtooth.moonhighway.com" target="_blank" rel="noopener">Snowtooth 的 GraphQL Playground 介面</a>，看一下這個 query:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">query &#123;</span><br><span class="line">  Lift(id: &quot;jazz-cat&quot;) &#123;</span><br><span class="line">    name</span><br><span class="line">    status</span><br><span class="line">    capacity</span><br><span class="line">    night</span><br><span class="line">    elevationGain</span><br><span class="line">    trailAccess &#123;</span><br><span class="line">      name</span><br><span class="line">      difficulty</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  Trail(id: &quot;river-run&quot;) &#123;</span><br><span class="line">    name</span><br><span class="line">    difficulty</span><br><span class="line">    accessedByLifts &#123;</span><br><span class="line">      name</span><br><span class="line">      status</span><br><span class="line">      capacity</span><br><span class="line">      night</span><br><span class="line">      elevationGain</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>這個查詢請求的是 Jazz Cat 纜車與 River Run 雪道的資訊。Lift 的選擇組裡有 name、status、capacity、night 與 elevationGain。我們想要取得的 River Run 雪道資訊有一些欄位與 Lift 型態的欄位相同。我們可以建立一個 fragment 來協助減少 query 重複的地方:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">fragment liftInfo on Lift &#123;</span><br><span class="line">  name</span><br><span class="line">  status</span><br><span class="line">  capacity</span><br><span class="line">  night</span><br><span class="line">  elevationGain</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我們用 fragment 關鍵字來建立 fragment。fragment 是屬於特定型態的選擇組，所以你必須在 fragment 的定義中指定它所屬的型態。這個範例的 fragment 稱為 liftInfo，它是 Lift 型態的選擇組。</p>
<p>當我們要在另一個選擇組中加入 liftInfo fragment 欄位時，可在 fragment 名詞前面加上三個句點:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">query &#123;</span><br><span class="line">  Lift(id: &quot;jazz-cat&quot;) &#123;</span><br><span class="line">    ...liftInfo</span><br><span class="line">    trailAccess &#123;</span><br><span class="line">      name</span><br><span class="line">      difficulty</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  Trail(id: &quot;river-run&quot;) &#123;</span><br><span class="line">    name</span><br><span class="line">    difficulty</span><br><span class="line">    accessedByLifts &#123;</span><br><span class="line">      ...liftInfo</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fragment liftInfo on Lift &#123;</span><br><span class="line">  name</span><br><span class="line">  status</span><br><span class="line">  capacity</span><br><span class="line">  night</span><br><span class="line">  elevationGain</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>這種語法類似 JavaScript 的 spread 運算子。這三個句點可讓 GraphQL 將 fragment 的欄位指派給當前的選擇組。在這個範例中，我們在 query 的兩個地方使用同一個 fragment 來選擇 name、status、capacity、night 與 elevationGain。</p>
<p>我們無法將 liftInfo fragment 加入 Trail 選擇組，因為 liftInfo 只定義了 Lift 型態的欄位。我們可以加入另一個雪道 Trail 型態欄位的 fragment trailInfo:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">query &#123;</span><br><span class="line">  Lift(id: &quot;jazz-cat&quot;) &#123;</span><br><span class="line">    ...liftInfo</span><br><span class="line">    trailAccess &#123;</span><br><span class="line">      ...trailInfo</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  Trail(id: &quot;river-run&quot;) &#123;</span><br><span class="line">    ...trailInfo</span><br><span class="line">    groomed</span><br><span class="line">    trees</span><br><span class="line">    night</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fragment trailInfo on Trail &#123;</span><br><span class="line">  name</span><br><span class="line">  difficulty</span><br><span class="line">  accessedByLifts &#123;</span><br><span class="line">    ...liftInfo</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fragment liftInfo on Lift &#123;</span><br><span class="line">  name</span><br><span class="line">  status</span><br><span class="line">  capacity</span><br><span class="line">  night</span><br><span class="line">  elevationGain</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在這個範例中，我們建立了一個稱為 trailInfo 的 fragment，並在 query 的兩個地方使用它。我們也在 trailInfo fragment 中使用 liftInfo fragment 來選擇與它連接的纜椅資料。你可以視需求建立任意數量的 fragment，並交換使用它們。在 River Run Trail query 使用的選擇組中，我們將 fragment 與想要選擇的、關於 River Run 雪道的其他資料結合。你可以一併使用 fragment 與選擇組的其他欄位，也可以在單個選擇組中結合多個屬於同樣型態的 fragment:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">query &#123;</span><br><span class="line">  allTrails &#123;</span><br><span class="line">    ...trailStatus</span><br><span class="line">    ...trailDetails</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fragment trailStatus on Trail &#123;</span><br><span class="line">  name</span><br><span class="line">  status</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fragment trailDetails on Trail &#123;</span><br><span class="line">  groomed</span><br><span class="line">  trees</span><br><span class="line">  night</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>fragment 有個很棒的優點在於，你只需要修改一個 fragment，就可以修改在許多不同的 query 裡面的選擇組:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">fragment liftInfo on Lift &#123;</span><br><span class="line">  name</span><br><span class="line">  status</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>這樣修改 liftInfo fragment 的選擇組會讓使用這個 fragment 的每一個 query 選擇較少的資料。</p>
<h3 id="變動-Mutation"><a href="#變動-Mutation" class="headerlink" title="變動 Mutation"></a>變動 Mutation</h3><p>到目前為止，我們已討論許多關於讀取資料的事情了。我們用 query 來描述在 GraphQL 中發生的所有讀取。若要寫入新資料，就要使用 <em>mutation</em> (變動)。mutation 的定義類似 query ，它們都有名稱，也可以擁有 “可回傳物件型態或純量型態的選擇組” ，不同之處在於 mutation 可執行一些影響後端資料狀態的修改。</p>
<p>例如，這是個很危險的 mutation:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mutation burnItDown &#123;</span><br><span class="line">  deleteAllData</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Mutation 是一種根物件型態</strong>。API 的 schema 定義了這個型態可用的欄位 (field)。上述的 Mutation API 擁有強大的威力，可清除所有的資料，它實作了一個 deleteAllData 的欄位，當所有資料都被成功的刪除，這個欄位會回傳一個純量型態: true，或者如果出錯了，會回傳 false。資料究竟會不會被刪除是藉由實作這個 API 來決定。</p>
<p>我們來看另外一個範例，這次我們要創造一些東西，而不是摧毀東西:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mutation createSong &#123;</span><br><span class="line">  addSong(title: &quot;No Scrubs&quot;, numberOne: true, performerName: &quot;TLC&quot;) &#123;</span><br><span class="line">    id</span><br><span class="line">    title</span><br><span class="line">    numberOne</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我們可以使用這個範例來創建新歌曲，利用引數將 title、numberOne 狀態與 performerName 傳給這個 mutation 之後，它會將這首新歌加入資料庫。如果這個 mutation 欄位 addSong 會回傳物件，你就要在這個 mutation 後面加入一個選擇組。在本例中，mutation 完成後會回傳 Song 型態的物件，裡面有剛才創建的歌曲的資料。我們可以在 mutation 後面選擇新歌的 id、title 與 numberOne 狀態的選擇組:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"data"</span>: &#123;</span><br><span class="line">    <span class="attr">"addSong"</span>: &#123;</span><br><span class="line">      <span class="attr">"id"</span>: <span class="string">"Saca534f4bb1de07cb6d73ae"</span>,</span><br><span class="line">      <span class="attr">"title"</span>: <span class="string">"No Scrubs"</span>,</span><br><span class="line">      <span class="attr">"numberOne"</span>: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面是這個 mutation 可能的回應。如果出錯，這個 mutation 會在 JSON 回應裡面回傳錯誤，而不是新建的 Song 物件。</p>
<p>我們也可以使用 mutation 來更改既有的資料。當我們想要更改 Snowtooth 的纜椅狀態時，也可以使用 mutation:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mutation closeLift &#123;</span><br><span class="line">  setLiftStatus(id: &quot;jazz-cat&quot; status: CLOSED) &#123;</span><br><span class="line">    name</span><br><span class="line">    status</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>這個 mutation 將 Jazz Cat 纜椅的狀態從 open 改成 closed。我們可以在 mutation 後面的選擇組裡面選擇被更改的 Lift 的欄位。在此，我們取得被改變的纜椅的 name，以及更新後的 status。</p>
<h3 id="使用查詢變數"><a href="#使用查詢變數" class="headerlink" title="使用查詢變數"></a>使用查詢變數</h3><p>現在我們已經會使用 mutation 引數傳送新字串值來更改資料了，另一種做法是使用輸入<strong>變數</strong>，以變數取代 query 內的靜態值可讓我們可以傳入動態值。在 addSong mutation，我們要用變數名稱來取代字串，在 GraphQL 中，變數必定以 <strong>$</strong> 字元開頭:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mutation createSong($title:String! $numberOne:Boolean $by:String!) &#123;</span><br><span class="line">  addSong(title:$title, numberOne:$numberOne, performerName:$by) &#123;</span><br><span class="line">    id</span><br><span class="line">    title</span><br><span class="line">    numberOne</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我們將靜態值換成 $variable，接著宣告的 mutation 可接收 $variable。GraphiQL 與 Playground 都有一個 Query Variables 視窗 (左下角，可把空間往上拉大)，我們在這裡用 JSON 物件來傳送輸入資料，務必用正確的變數名稱作為 JSON 鍵:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"title"</span>: <span class="string">"No Scrubs"</span>,</span><br><span class="line">  <span class="attr">"numberOne"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">"by"</span>: <span class="string">"TLC"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>當你傳送引數資料時，變數的功能很強大，它不但可讓你的 mutation 在測試的過程中更有條理，當你連接用戶端介面時，使用動態輸入也有很大的幫助。</p>
<h3 id="訂閱-Subscription"><a href="#訂閱-Subscription" class="headerlink" title="訂閱 Subscription"></a>訂閱 Subscription</h3><p>GraphQL 的第三種操作類型是訂閱 (<em>subscription</em>)。有時用戶端想要取得伺服器傳送的即時更新。訂閱可讓我們監聽 GraphQL API 的即時資料變更。</p>
<p>GraphQL 的訂閱功能來自 Facebook 的實際使用案例。這個團隊想要在不重新整理網頁的情況下，顯示關於貼文獲得的贊 (Live Likes)數量的即時資訊。Live Likes 是以訂閱來製作的及時使用案例。每一個用戶端都會訂閱 like 事件，並即時看到 like 的更新。</p>
<p>如同 mutation 與 query，<strong>subscription 是一種根型態</strong>。你必須在 API schema 的 subscription 型態下的欄位中定義用戶端可以監聽的資料變更。編寫 GraphQL query 來監聽 subscription 的做法類似定義其它操作的方式。</p>
<p>例如，在 Snowtooth 中，我們可以用 subscription 監聽任何纜椅狀態的變動:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">subscription &#123;</span><br><span class="line">  liftStatusChange &#123;</span><br><span class="line">    name</span><br><span class="line">    capacity</span><br><span class="line">    status</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>當我們執行這個 subscription 時，會用 WebSocket 來監聽纜椅狀態的改變。請留意，在 GraphQL Playground 按下播放按鈕後不會立刻收到回傳的資料。當 subscription 被送到伺服器時，這個 subscription 會監聽資料的任何改變。</p>
<p>如果你想要看到 subscription 收到資料，就必須做出改變。你必須打開一個新視窗或標籤，用 mutation 來傳送改變。 如果使用的是 GraphQL Playground，視窗上端可以直接打開一個新標簽來加入 mutation。 我們在新視窗或標籤送一個改變纜椅狀態的 mutation:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mutation closeLift &#123;</span><br><span class="line">  setLiftStatus(id: &quot;astra-express&quot; status: HOLD) &#123;</span><br><span class="line">    name</span><br><span class="line">    status</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>回到 subscription 的視窗，將會收到被更新的資料，以及資料被送到 subscription 的時間。</p>
<p>與 query 和 mutation 不同的是，subscription 會保持開啟。接下來每當有纜椅的狀態改變時，新的資料就會被推送到這個 subscription。若要停止監聽狀態的變動，你必須取消 subscription。當你使用 GraphQL Playground 時，只要按下停止按鈕即可。不幸的是，用 GraphiQL 來取消 subscription 唯一的做法是關閉運行該 subscription 的瀏覽器標籤。</p>
<h3 id="自我查詢-Introspection"><a href="#自我查詢-Introspection" class="headerlink" title="自我查詢 Introspection"></a>自我查詢 Introspection</h3><p>自我查詢 (introspection)是 GraphQL 最強大的功能之一。自我查詢是指查詢目前的 API 的 schema。自我查詢是將這些精心建構的 GraphQL 文件加入 GraphiQL 與 Playground 介面的方式。</p>
<p>你可以傳送 query 給每一個 “可回傳特定 API 的 schema 資料” 的 GraphQL API。例如，如果你要知道可在 Snowtooth 中使用哪種 GraphQL 型態，可以執行 __schema query 來查看該資訊:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">query &#123;</span><br><span class="line">  __schema &#123;</span><br><span class="line">    types &#123;</span><br><span class="line">      name</span><br><span class="line">      description</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>當你執行這個 query 時，可以看到這個 API 可用的每一個型態，包括根型態、自訂型態，甚至純量型態。如果你想要查看特定型態的資料，可執行 __type query，並用引數來傳送想要查詢的型態名稱:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">query liftDetails &#123;</span><br><span class="line">  __type(name:&quot;Lift&quot;) &#123;</span><br><span class="line">    name</span><br><span class="line">    fields &#123;</span><br><span class="line">      name</span><br><span class="line">      description</span><br><span class="line">      type &#123;</span><br><span class="line">        name</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>這種自我查詢功能可讓你看到 Lift 型態可供查詢的所有欄位。當你想要瞭解新的 GraphQL API 時，找出根型態提供哪些欄位是很好的做法:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">query roots &#123;</span><br><span class="line">  __schema &#123;</span><br><span class="line">    queryType &#123;</span><br><span class="line">      ...typeFields</span><br><span class="line">    &#125;</span><br><span class="line">    mutationType &#123;</span><br><span class="line">      ...typeFields</span><br><span class="line">    &#125;</span><br><span class="line">    subscriptionType &#123;</span><br><span class="line">      ...typeFields</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fragment typeFields on __Type &#123;</span><br><span class="line">  name</span><br><span class="line">  fields &#123;</span><br><span class="line">    name</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>自我查詢會遵循 GraphQL 查詢語言的規則。我們用 fragment 來簡化上述的 query，並查詢每個根型態的名稱與它們提供的欄位。自我查詢可讓用戶端知道目前的 API schema 如何運作。</p>
<h3 id="抽象語法樹-Abstract-syntax-tree-AST"><a href="#抽象語法樹-Abstract-syntax-tree-AST" class="headerlink" title="抽象語法樹 (Abstract syntax tree, AST)"></a>抽象語法樹 (Abstract syntax tree, AST)</h3><p>query 文件是個字串。當我們傳送 query 給 GraphQL API 時，字串會被解析成<strong>抽象語法樹</strong>，並在操作執行之前進行驗證。抽象語法樹 AST 是一種代表 query 的階層式物件，是個含有內嵌欄位的物件，裡面的欄位代表 GraphQL query 的細節。</p>
<p>解析程序的第一個步驟是將字串解析成一堆較小的片段，這個步驟包括將關鍵字、引數，甚至括號與冒號解析成單獨的標記，這個程序稱為<strong>詞法分析</strong> (lexing 或 lexical analysis)。接下來將詞法分析後的 query 解析成 AST。使用 AST 可讓動態修改與驗證 query 的工作輕鬆許多。</p>
<p>例如，你的 query 一開始是 GraphQL 文件。文件至少有一個<strong>定義</strong>，也可能有一串定義。定義只有可能是兩種型態之一: <strong>OperationDefinition</strong> 與 <strong>FragmentDefinition</strong>。下面的文件範例有三個定義: 兩項操作 (Operation) 與一個 fragment:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">query jazzCatStatus &#123;</span><br><span class="line">  Lift(id: &quot;jazz-cat&quot;) &#123;</span><br><span class="line">    name</span><br><span class="line">    night</span><br><span class="line">    elevationGain</span><br><span class="line">    trailAccess &#123;</span><br><span class="line">      name</span><br><span class="line">      difficulty</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mutation closeLift($lift: ID!) &#123;</span><br><span class="line">  setLiftStatus(id: $lift, status: CLOSED) &#123;</span><br><span class="line">    ...liftStatus</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fragment liftStatus on Lift &#123;</span><br><span class="line">  name</span><br><span class="line">  status</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>一個 OperationDefinition 只能含有三種操作型態之一: <strong>mutation</strong>、<strong>query</strong> 或 <strong>subscription</strong>。每一個操作定義都有 <strong>OperationType</strong> 與 <strong>SelectionSet</strong>。</p>
<p>在每一個操作後面的大括號內都有該操作的 SelectionSet，它們就是我們用引數來查詢的欄位。例如，Lift 欄位是 jazzCatStatus query 的 SelectionSet，而 setLiftStatus 欄位是 closeLift mutation 的選擇組。</p>
<p>選擇組可嵌套在另一個選擇組裡。jazzCatStatus query 有三個嵌套的選擇組。第一個 SelectionSet 含有 Lift 欄位。在它裡面有個 SelectionSet 含有 name、night、elevationGain 與 trailAccess 欄位。在 trailAccess 欄位內有另一個 SelectionSet，含有每個雪道的 name 與 difficulty 欄位。</p>
<p>GraphQL 可遍歷這個 AST 並且用 GraphQL 語言與目前的 schema 來驗證它的細節。如果查詢語言的語法是正確的，且 schema 含有我們請求的欄位與型態，該操作就會執行。如果情況不是如此，就會回傳特定的錯誤。</p>
<p>AST 是 GraphQL 很重要的成分。每一項操作都會被解析成 AST，以便對它進行驗證並最終執行它。</p>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2019/08/06/GraphQL-Query-Language-1/" rel="prev" title="GraphQL 查詢語言 (1)">
      <i class="fa fa-chevron-left"></i> GraphQL 查詢語言 (1)
    </a></div>
      <div class="post-nav-item">
    <a href="/2019/08/21/GraphQL-Schema-Design-1/" rel="next" title="GraphQL Schema 設計 (1)">
      GraphQL Schema 設計 (1) <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目錄
        </li>
        <li class="sidebar-nav-overview">
          本站概要
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#Fragment"><span class="nav-number">1.</span> <span class="nav-text">Fragment</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#變動-Mutation"><span class="nav-number">2.</span> <span class="nav-text">變動 Mutation</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用查詢變數"><span class="nav-number">3.</span> <span class="nav-text">使用查詢變數</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#訂閱-Subscription"><span class="nav-number">4.</span> <span class="nav-text">訂閱 Subscription</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#自我查詢-Introspection"><span class="nav-number">5.</span> <span class="nav-text">自我查詢 Introspection</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#抽象語法樹-Abstract-syntax-tree-AST"><span class="nav-number">6.</span> <span class="nav-text">抽象語法樹 (Abstract syntax tree, AST)</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="J.Y. Yang"
      src="/images/1184yang.jpg">
  <p class="site-author-name" itemprop="name">J.Y. Yang</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">63</span>
          <span class="site-state-item-name">文章</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">分類</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/1184yang" title="GitHub → https://github.com/1184yang" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:1184yang@gmail.com" title="E-Mail → mailto:1184yang@gmail.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/1184yang" title="Twitter → https://twitter.com/1184yang" rel="noopener" target="_blank"><i class="fa fa-fw fa-twitter"></i>Twitter</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">J.Y. Yang</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/muse.js"></script>
<script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script>



  




  <script src="/js/local-search.js"></script>












  

  

</body>
</html>
