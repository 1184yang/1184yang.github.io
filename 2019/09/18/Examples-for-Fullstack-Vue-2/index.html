<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.9.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=EB Garamond:300,300italic,400,400italic,700,700italic|Cinzel Decorative:300,300italic,400,400italic,700,700italic|Noto Serif TC:300,300italic,400,400italic,700,700italic|Source Code Pro:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"1184yang.github.io","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12,"onmobile":true},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="此範例，將介紹如何在 Vue.js 中實現基於角色的授權/訪問控制(role based authorization/access control)的示例。 將從伺服器端開始，單頁應用程式 SPA 的伺服器端在客戶端下載 index.html 檔案後，似乎就沒甚麼事情了，如果不是很複雜的系統，我們可以用它兼作 API 伺服器。這個範例我們就將它兼作為伺服器端認證的 API，我們將在此伺服器上實作身">
<meta property="og:type" content="article">
<meta property="og:title" content="Fullstack Vue 實作範例 - Authorization">
<meta property="og:url" content="https://1184yang.github.io/2019/09/18/Examples-for-Fullstack-Vue-2/index.html">
<meta property="og:site_name">
<meta property="og:description" content="此範例，將介紹如何在 Vue.js 中實現基於角色的授權/訪問控制(role based authorization/access control)的示例。 將從伺服器端開始，單頁應用程式 SPA 的伺服器端在客戶端下載 index.html 檔案後，似乎就沒甚麼事情了，如果不是很複雜的系統，我們可以用它兼作 API 伺服器。這個範例我們就將它兼作為伺服器端認證的 API，我們將在此伺服器上實作身">
<meta property="og:locale" content="zh-TW">
<meta property="og:image" content="https://1184yang.github.io/2019/09/18/Examples-for-Fullstack-Vue-2/not-found.png">
<meta property="og:image" content="https://1184yang.github.io/2019/09/18/Examples-for-Fullstack-Vue-2/express-1.png">
<meta property="og:image" content="https://1184yang.github.io/2019/09/18/Examples-for-Fullstack-Vue-2/middleware.png">
<meta property="og:image" content="https://1184yang.github.io/2019/09/18/Examples-for-Fullstack-Vue-2/public.png">
<meta property="og:image" content="https://1184yang.github.io/2019/09/18/Examples-for-Fullstack-Vue-2/auth.png">
<meta property="og:image" content="https://1184yang.github.io/2019/09/18/Examples-for-Fullstack-Vue-2/auth2.png">
<meta property="og:updated_time" content="2020-07-25T02:23:30.409Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Fullstack Vue 實作範例 - Authorization">
<meta name="twitter:description" content="此範例，將介紹如何在 Vue.js 中實現基於角色的授權/訪問控制(role based authorization/access control)的示例。 將從伺服器端開始，單頁應用程式 SPA 的伺服器端在客戶端下載 index.html 檔案後，似乎就沒甚麼事情了，如果不是很複雜的系統，我們可以用它兼作 API 伺服器。這個範例我們就將它兼作為伺服器端認證的 API，我們將在此伺服器上實作身">
<meta name="twitter:image" content="https://1184yang.github.io/2019/09/18/Examples-for-Fullstack-Vue-2/not-found.png">

<link rel="canonical" href="https://1184yang.github.io/2019/09/18/Examples-for-Fullstack-Vue-2/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-TW'
  };
</script>

  <title>Fullstack Vue 實作範例 - Authorization | </title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切換導航欄">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title"></h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首頁</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>歸檔</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分類</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜尋
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜尋..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

  <a href="https://github.com/1184yang?tab=repositories" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://1184yang.github.io/2019/09/18/Examples-for-Fullstack-Vue-2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/1184yang.jpg">
      <meta itemprop="name" content="J.Y. Yang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Fullstack Vue 實作範例 - Authorization
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2019-09-18 11:03:40" itemprop="dateCreated datePublished" datetime="2019-09-18T11:03:40+08:00">2019-09-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2020-07-25 10:23:30" itemprop="dateModified" datetime="2020-07-25T10:23:30+08:00">2020-07-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/JavaScript/" itemprop="url" rel="index"><span itemprop="name">JavaScript</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>此範例，將介紹如何在 Vue.js 中實現基於角色的授權/訪問控制(role based authorization/access control)的示例。</p>
<p>將從伺服器端開始，單頁應用程式 SPA 的伺服器端在客戶端下載 index.html 檔案後，似乎就沒甚麼事情了，如果不是很複雜的系統，我們可以用它兼作 API 伺服器。這個範例我們就將它兼作為伺服器端認證的 API，我們將在此伺服器上實作身份驗證服務 API。正式應用上可以使用 GraphQL 將認證與一般的 API 整合，只需將此範例認證 API 改為指向 GraphQL 即可，除此，客戶端不需甚麼變動。</p>
<h3 id="原始碼"><a href="#原始碼" class="headerlink" title="原始碼"></a>原始碼</h3><p>這個範例可以當成 Web Application 的起始架構，程式碼可以使用 git 或複製壓縮檔取得:</p>
<ul>
<li>如果你有安裝 git，可以用 git clone 取得程式碼，我的 Z: 虛擬硬碟是指向 XXX111。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> Z:\DBA\Git\Depot\vue-demo-sample-auth.git</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> vue-demo-sample-auth</span><br><span class="line"></span><br><span class="line">npm install</span><br><span class="line"></span><br><span class="line">npm start</span><br></pre></td></tr></table></figure>

<ul>
<li>如果沒有安裝 git，可從 XXX111:\DBA\Oracle Training\Xyang\Source\vue-demo-sample-auth.zip 取得壓縮檔，解壓縮後:</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npm install</span><br><span class="line"></span><br><span class="line">npm start</span><br></pre></td></tr></table></figure>

<p>如果要用在正試環境時，記得將 package.json 的屬性 start 改為用 Node.js 啟動:</p>
<figure class="highlight"><figcaption><span>package.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">"scripts": &#123;</span><br><span class="line">  "start": "node ./bin/www"</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<p>如果你想跟著稍後的實作細節自己建立程式碼，可以複製<a href="/2019/09/09/Examples-for-Fullstack-Vue-1/">Fullstack Vue 實作範例 (1)</a>作為起始架構，跟著實作。</p>
<h3 id="實作細節"><a href="#實作細節" class="headerlink" title="實作細節"></a>實作細節</h3><p>以下則是詳細的過程及說明。</p>
<h3 id="伺服器端"><a href="#伺服器端" class="headerlink" title="伺服器端"></a>伺服器端</h3><h4 id="HTML5-歷史模式"><a href="#HTML5-歷史模式" class="headerlink" title="HTML5 歷史模式"></a>HTML5 歷史模式</h4><p>以 Vue.js 建立的 SPA App 通常只使用一個瀏覽器可以訪問的索引檔案，例如 index.html，而網址導航(網頁切換)，通常透過客戶端的 Vue Router 來達成。預設的情況下， Vue Router 使用 URL 雜湊來儲存路徑，要在你的網站中存取 /about，你要輸入 http://&lt;你的網站&gt;.com/#/about。不過，幾乎所有現行的瀏覽器都支援 HTML5 history API 。有了它，開發者無須重載新網頁就可以更新 URL，網址也會更好看。</p>
<figure class="highlight plain"><figcaption><span>public/router.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">const router = new VueRouter(&#123;</span><br><span class="line">  mode: history,</span><br><span class="line">  routes: [</span><br><span class="line">    &#123; path: &apos;/&apos;, component: PageHome&#125;,</span><br><span class="line">    &#123; path: &apos;/about&apos;, component: PageAbout &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>在第 2 行我們可以把 Vue Router 設為 HTML5 history API。 現在，若你直接用瀏覽器連到 http://&lt;你的網站&gt;.com/about，你會看到 …404 網頁:</p>
<img src="/2019/09/18/Examples-for-Fullstack-Vue-2/not-found.png" title="Not Found">

<p>在 SPA 中使用 HTML 5 history API 除了讓客戶端的程式碼去抓完整的路徑之外，你還需要告訴伺服器在回應每一次它無法識別的要求時，要回傳那一個 HTML 網頁，在 express 上，我們需要安裝一個套件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save connect-history-api-fallback</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><figcaption><span>app.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">const</span> history = <span class="built_in">require</span>(<span class="string">"connect-history-api-fallback"</span>);</span><br><span class="line">...</span><br><span class="line">app.use(history());</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>但是因為我們想讓此 express 兼作 API 伺服器，這樣的設定將會把 express 的伺服器端路由全部攔截，因此必須加入一些條件，讓它跳過一些路由:</p>
<figure class="highlight javascript"><figcaption><span>app.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">app.use(history(&#123;</span><br><span class="line">  rewrites: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">from</span>: <span class="regexp">/^\/api\/.*$/</span>,</span><br><span class="line">      to: <span class="function">(<span class="params">context</span>) =&gt;</span> context.parsedUrl.pathname</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;));</span><br></pre></td></tr></table></figure>

<p>這個設定可以讓它通過以 <strong>/api/*</strong> 開頭的所有路由，我們就可設定如下的認證 API。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.use(&apos;/api/v1/users&apos;, usersRouter);</span><br></pre></td></tr></table></figure>

<p>以下會是伺服器端完成後的專案目錄架構，客戶端的程式碼都放在 public 目錄下，public 目錄也是 express 伺服器的靜態檔案服務的根目錄:</p>
<img src="/2019/09/18/Examples-for-Fullstack-Vue-2/express-1.png" title="Not Found">

<h4 id="伺服器端身份驗證-API"><a href="#伺服器端身份驗證-API" class="headerlink" title="伺服器端身份驗證 API"></a>伺服器端身份驗證 API</h4><p>我們將建立 3 使用者服務 API，並對這些 API 實作權限控管:</p>
<ul>
<li><strong>/api/v1/users</strong> 需要有管理者權限，才可以取得所有使用使用者的資料。</li>
<li><strong>/api/v1/users/:id</strong> 只有目前登入者有權限取得自己的資料。</li>
<li><strong>/api/v1/authenticate</strong> 登入認證用，不須有權限的控管。</li>
</ul>
<p>為了將焦點放在架構上，我們將使用者資料直接放在一個 JavaScript 陣列上，正式上線的系統應該將它移到資料庫上。</p>
<figure class="highlight javascript"><figcaption><span>services/users.data.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = [</span><br><span class="line">  &#123;</span><br><span class="line">    id: <span class="number">1</span>,</span><br><span class="line">    username: <span class="string">"admin"</span>,</span><br><span class="line">    password: <span class="string">"$2b$10$JSxCrnRLV1Ypc6P.thx29O4M1hePOyBX4V8hGn0yXOl2FRq5996oi"</span>, <span class="comment">// admin</span></span><br><span class="line">    displayName: <span class="string">"Administrator"</span>,</span><br><span class="line">    roles: [<span class="string">"admin"</span>]</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    id: <span class="number">2</span>,</span><br><span class="line">    username: <span class="string">"user"</span>,</span><br><span class="line">    password: <span class="string">"$2b$10$KRW4hJpiDt3BIusPY2bQNOrKh7QuxWT8m2YSt9Q9b.aixSPv.tCDG"</span>, <span class="comment">// user</span></span><br><span class="line">    displayName: <span class="string">"User One"</span>,</span><br><span class="line">    roles: [<span class="string">"user"</span>]</span><br><span class="line">  &#125;,</span><br><span class="line">  ...</span><br><span class="line">];</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><figcaption><span>services/user.service.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> bcrypt = <span class="built_in">require</span>(<span class="string">"bcryptjs"</span>);</span><br><span class="line"><span class="keyword">const</span> jwt = <span class="built_in">require</span>(<span class="string">"jsonwebtoken"</span>);</span><br><span class="line"><span class="keyword">const</span> jwtSecretKey = <span class="string">"gJ3Lck9rb5yZ6T8i66dcsuFeoYJ6x"</span>;</span><br><span class="line"><span class="keyword">const</span> users = <span class="built_in">require</span>(<span class="string">"./users.data"</span>);</span><br><span class="line"></span><br><span class="line">exports.authenticate = <span class="function">(<span class="params">username, password</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> username !== <span class="string">"string"</span> || <span class="keyword">typeof</span> password !== <span class="string">"string"</span>) &#123;</span><br><span class="line">      reject(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"Username or password is incorrect"</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> user = users.find(</span><br><span class="line">      u =&gt; u.username === username &amp;&amp; validPassword(password, u.password)</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!user) &#123;</span><br><span class="line">      reject(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"Username or password is incorrect"</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> token = jwt.sign(</span><br><span class="line">      &#123;</span><br><span class="line">        id: user.id,</span><br><span class="line">        username: user.username,</span><br><span class="line">        roles: user.roles</span><br><span class="line">      &#125;,</span><br><span class="line">      jwtSecretKey,</span><br><span class="line">      &#123; <span class="attr">expiresIn</span>: <span class="string">"12h"</span> &#125;</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    resolve(&#123;</span><br><span class="line">      id: user.id,</span><br><span class="line">      displayName: user.displayName,</span><br><span class="line">      roles: user.roles,</span><br><span class="line">      token: token</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">exports.jwtVerify = <span class="function">(<span class="params">token</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (!token) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"Authentication failed"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> payload;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    payload = jwt.verify(token, jwtSecretKey);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    <span class="keyword">if</span> (err.name === <span class="string">"TokenExpiredError"</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"Token Expired"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"Authentication failed"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> payload;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">exports.allUsers = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> rows = users.map(<span class="function"><span class="params">u</span> =&gt;</span> (&#123;</span><br><span class="line">      id: u.id,</span><br><span class="line">      username: u.username,</span><br><span class="line">      displayName: u.displayName,</span><br><span class="line">      roles: u.roles</span><br><span class="line">    &#125;));</span><br><span class="line"></span><br><span class="line">    resolve(rows);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">exports.findById = <span class="function">(<span class="params">id</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!id) &#123;</span><br><span class="line">      reject(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"User not found"</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> user = users.find(<span class="function"><span class="params">x</span> =&gt;</span> x.id === id);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!user) &#123;</span><br><span class="line">      reject(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"User not found"</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    resolve(&#123;</span><br><span class="line">      id: user.id,</span><br><span class="line">      username: user.username,</span><br><span class="line">      displayName: user.displayName,</span><br><span class="line">      roles: user.roles</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">exports.findRole = <span class="function">(<span class="params">role, roles</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (!roles || roles.indexOf(role) == <span class="number">-1</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">exports.setPassword = <span class="function"><span class="params">password</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> bcrypt.hashSync(password, <span class="number">10</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> validPassword = <span class="function">(<span class="params">password, hash</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> bcrypt.compareSync(password, hash);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>這裡使用兩個套件，bcryptjs  與 jsonwebtoken。bcryptjs 用來作密碼的加密與密碼的比對，jsonwebtoken 用來產生加密的 Token 與解密。</p>
<p>其中最重要的兩個函式，authenticate( ) 與 jwtVerify( )。authenticate( ) 用來作登入認證，在第 20 行，當認證成功，它會產生 token，token 會包含使用者的 id、username 與 roles。token 會加密，並下傳到客戶端，當客戶端要訪問伺服器端的 API 時，必須都要附帶此 token 作權限控管。這裡的 token 有效性設定為 12 小時，可視需要修改。</p>
<p>第 30 行是當認證成功時傳給客戶端的使用者物件，除了 token 還另外含有 id、displayName 與 roles，你應該有注意到，token 裡也含有 roles 的資訊，這要區分兩者有不同的用途，token 裡的 roles 是用來作伺服器端 API 的權限控管，另外下傳使用者物件中的 roles 則可提供 SPA 客戶端作基本的客戶端路由(或頁面)控管，你不能只控管客戶端的權限，伺服器端的 API 安全控管更加重要。</p>
<p>jwtVerify( ) 函式則是用來解開 token 加密的資料，客戶端在訪問伺服器端 API 時都必須附帶此 token，依 token 中的 id 與 roles 作權限的控管。</p>
<p>其它的服務 allUsers、findById 直接抓取陣列，雖然都是同步的，但我還是用 Promise 使用非同步的方式，方便以後改為用資料庫存儲使用者資料，也讓所有的服務都一致使用非同步存取，以免混淆。</p>
<h4 id="Express-中間件-Middleware"><a href="#Express-中間件-Middleware" class="headerlink" title="Express 中間件 (Middleware)"></a>Express 中間件 (Middleware)</h4><p>接下來我們來看如何使用 express 的中間件 (Middleware)來保護資料。</p>
<p>如果沒有中間件，你必須在一個函式中處理一個請求 (Request) 的所有事情，使用中間件則可將一個複雜的處理函式模組化，不僅較好維護、較為彈性，可用性也較佳。</p>
<p>當 Express 接收到一個 Request 要求時，Request 物件將會經過一個中間件堆疊，然後透過 Response 物件回應給客戶端，堆疊中的每個中間件隨時有可能會結束這個流程直接回應給客戶端。所以我們可以在堆疊中插入我們的認證機制中間件，成功則繼續堆疊的運作，失敗就直接回應給客戶端，不繼續往下流程。這是一個強大的功能，也是 Express 運作的基石。</p>
<img src="/2019/09/18/Examples-for-Fullstack-Vue-2/middleware.png" title="Express Middleware">

<h4 id="Authorize-middleware"><a href="#Authorize-middleware" class="headerlink" title="Authorize middleware"></a>Authorize middleware</h4><p>首先來處理權限控管中間件:</p>
<figure class="highlight javascript"><figcaption><span>middlewares/authorize.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; jwtVerify, findRole &#125; = <span class="built_in">require</span>(<span class="string">"../services/user.service"</span>);</span><br><span class="line"></span><br><span class="line">exports.authorize = <span class="function">(<span class="params">role</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> [ validateToken(), isRole(role) ];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">exports.isCurrentUser = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> [ validateToken(), currentUser() ];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">validateToken</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> token;</span><br><span class="line">    <span class="keyword">let</span> payload;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!req.headers.authorization) &#123;</span><br><span class="line">      <span class="keyword">return</span> res.status(<span class="number">401</span>).json(&#123; <span class="attr">message</span>: <span class="string">"You are not authorized"</span> &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    token = req.headers.authorization.split(<span class="string">" "</span>)[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!token) &#123;</span><br><span class="line">      <span class="keyword">return</span> res.status(<span class="number">401</span>).json(&#123; <span class="attr">message</span>: <span class="string">"You are not authorized"</span> &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      payload = jwtVerify(token);</span><br><span class="line">      req.currentUser = payload;</span><br><span class="line">      next();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">      <span class="keyword">if</span> (err.name === <span class="string">"TokenExpiredError"</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> res.status(<span class="number">401</span>).json(&#123; <span class="attr">message</span>: err.message &#125;);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> res.status(<span class="number">401</span>).json(&#123; <span class="attr">message</span>: err.message &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isRole</span>(<span class="params">role</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!req.currentUser) &#123;</span><br><span class="line">      <span class="keyword">return</span> res.status(<span class="number">401</span>).json(&#123; <span class="attr">message</span>: <span class="string">"You are not authorized"</span> &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!role || findRole(role, req.currentUser.roles)) &#123;</span><br><span class="line">      next();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      res.status(<span class="number">401</span>).json(&#123; <span class="attr">message</span>: <span class="string">"You are not authorized"</span> &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">currentUser</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!req.currentUser) &#123;</span><br><span class="line">      <span class="keyword">return</span> res.status(<span class="number">401</span>).json(&#123; <span class="attr">message</span>: <span class="string">"You are not authorized"</span> &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> id = !<span class="built_in">isNaN</span>(req.params.id) ? <span class="built_in">parseInt</span>(req.params.id) : <span class="literal">undefined</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (id === req.currentUser.id || findRole(<span class="string">"admin"</span>, req.currentUser.roles)) &#123;</span><br><span class="line">      next();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      res.status(<span class="number">401</span>).json(&#123; <span class="attr">message</span>: <span class="string">"You are not authorized"</span> &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Express 中間件函式有一定的標準格式:</p>
<figure class="highlight javascript"><figcaption><span>middleware standard</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">myMiddleware</span>(<span class="params">request, response, next</span>) </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  next();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>中間件可接受 3 個參數，當你的處理函式處理完畢後，呼叫 next( ) 來呼叫堆疊中的下一個中間件。</p>
<ul>
<li>第 11 行 validateToken 中間件專門處理 token 的權限，包括每個 Request 有沒有附帶 token、token 是不是我們發出的合法 token 與 token 是否過期。</li>
<li>第 16 行判斷 Request 物件的 headers 有沒有 authorization 屬性，客戶端的每個 Request headers 都必須將 token 附在這個屬性上。</li>
<li>第 26 行如果是合法的 token，會將它解密，並將資料附加到 Request 物件上的屬性 currentUser 上，這是一個自建的新屬性，將會隨著 Request 物件傳給下個中間件，下遊的中間件都可從 Request 物件參考到這個自建的屬性。</li>
<li>第 29 行呼叫 next( ) 函式，才會往下執行中間件堆疊的下一個中間件。</li>
<li>第 31 行判斷 token 是否已過期。</li>
</ul>
<p>isRole 與 currentUser 也都是標準的中間件函式格式，你需要甚麼權限控管就依此範例加上去。</p>
<p>最後則看我們 export 出去的中間件 authorize 與 isCurrentUser，它們返回的都是一個中間件陣列，它們是有順序的，可依需求組合你需要的權限控管，這太棒了。</p>
<h4 id="Users-service"><a href="#Users-service" class="headerlink" title="Users service"></a>Users service</h4><p>可以開始建立實際的 Users services API 了，API 裡的函式實際上也是使用中間件的格式，但我們把這種中間件放在 controllers 目錄中，可以與其它有共用且有專们目的的中間件區分。</p>
<figure class="highlight javascript"><figcaption><span>controllers/user.controller.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; authenticate, allUsers, findById &#125; = <span class="built_in">require</span>(<span class="string">"../services/user.service"</span>);</span><br><span class="line"></span><br><span class="line">exports.allUsers = <span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">  allUsers()</span><br><span class="line">    .then( <span class="function"><span class="params">users</span> =&gt;</span> res.status(<span class="number">200</span>).json( &#123; <span class="attr">items</span>: users &#125;))</span><br><span class="line">    .catch(<span class="function"><span class="params">err</span> =&gt;</span> res.status(<span class="number">404</span>).json(&#123; <span class="attr">message</span>: err.message &#125;));</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">exports.getUser = <span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> id = !<span class="built_in">isNaN</span>(req.params.id) ? <span class="built_in">parseInt</span>(req.params.id) : <span class="literal">undefined</span>;</span><br><span class="line"></span><br><span class="line">  findById(id)</span><br><span class="line">    .then(<span class="function"><span class="params">user</span> =&gt;</span> res.status(<span class="number">200</span>).json(user))</span><br><span class="line">    .catch(<span class="function"><span class="params">err</span> =&gt;</span> res.status(<span class="number">404</span>).json(&#123; <span class="attr">message</span>: err.message &#125;));</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">exports.authenticate = <span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> username = req.body.username;</span><br><span class="line">  <span class="keyword">const</span> password = req.body.password;</span><br><span class="line"></span><br><span class="line">  authenticate(username, password)</span><br><span class="line">    .then(<span class="function"><span class="params">user</span> =&gt;</span> res.status(<span class="number">200</span>).json(user))</span><br><span class="line">    .catch(<span class="function"><span class="params">err</span> =&gt;</span> res.status(<span class="number">401</span>).json(&#123; <span class="attr">message</span>: err.message &#125;));</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>allUsers 與 getUser 將會使用在 HTTP GET 方法，authenticate 用於登入認證，會使用 HTTP POST 方法。<br>第 10 行用 req.params.id 可以取得路由參數，例如， /api/v1/users/:id。<br>第 18 行可以從 HTTP POST 的 Request 物件 body 屬性取得客戶端送來的資料。</p>
<p>Users 的路由設定現在看起來就很簡潔了。</p>
<figure class="highlight javascript"><figcaption><span>routes/users.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">const</span> router = express.Router();</span><br><span class="line"><span class="keyword">const</span> &#123; allUsers, getUser, authenticate &#125; = <span class="built_in">require</span>(<span class="string">'../controllers/user.controller'</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; authorize, isCurrentUser &#125; = <span class="built_in">require</span>(<span class="string">'../middlewares/authorize'</span>);</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">'/'</span>,  authorize(<span class="string">'admin'</span>), allUsers);</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">"/:id"</span>, isCurrentUser(), getUser);</span><br><span class="line"></span><br><span class="line">router.post(<span class="string">"/authenticate"</span>, authenticate);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = router;</span><br></pre></td></tr></table></figure>

<p>這裡的路由就是一連串的中間件堆疊組合了，前面兩個路由 / 與 /:id 分別有用 authorize( ) 與 isCurrentUser( ) 保護，登入用的 /authenticate 則不需要權限控管。注意這裡的中間件是有順序性的。</p>
<p>現在當你拜訪 /api/v1/users API 時，必須要有管理者身份。拜訪 /api/v1/users/:id 則只能是登入者本身。</p>
<p>以下則是伺服器端最終 app.js 的程式碼，這裡我多加了一個 cors 套件，雖然在此範例不需要，但如果是一般的 REST API 伺服器都會需要。</p>
<p>重新啟動伺服器，你的 SPA 伺服器就 OK 了，Go!</p>
<figure class="highlight javascript"><figcaption><span>app.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> createError = <span class="built_in">require</span>(<span class="string">'http-errors'</span>);</span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">const</span> cookieParser = <span class="built_in">require</span>(<span class="string">'cookie-parser'</span>);</span><br><span class="line"><span class="keyword">const</span> logger = <span class="built_in">require</span>(<span class="string">'morgan'</span>);</span><br><span class="line"><span class="keyword">const</span> cors = <span class="built_in">require</span>(<span class="string">'cors'</span>);</span><br><span class="line"><span class="keyword">const</span> history = <span class="built_in">require</span>(<span class="string">"connect-history-api-fallback"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> indexRouter = <span class="built_in">require</span>(<span class="string">'./routes/index'</span>);</span><br><span class="line"><span class="keyword">const</span> usersRouter = <span class="built_in">require</span>(<span class="string">'./routes/users'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = express();</span><br><span class="line"></span><br><span class="line"><span class="comment">// view engine setup</span></span><br><span class="line">app.set(<span class="string">'views'</span>, path.join(__dirname, <span class="string">'views'</span>));</span><br><span class="line">app.set(<span class="string">'view engine'</span>, <span class="string">'ejs'</span>);</span><br><span class="line"></span><br><span class="line">app.use(logger(<span class="string">'dev'</span>));</span><br><span class="line">app.use(express.json());</span><br><span class="line">app.use(history(&#123;</span><br><span class="line">  rewrites: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">from</span>: <span class="regexp">/^\/api\/.*$/</span>,</span><br><span class="line">      to: <span class="function">(<span class="params">context</span>) =&gt;</span> context.parsedUrl.pathname</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;));</span><br><span class="line">app.use(express.urlencoded(&#123; <span class="attr">extended</span>: <span class="literal">false</span> &#125;));</span><br><span class="line">app.use(cookieParser());</span><br><span class="line">app.use(express.static(path.join(__dirname, <span class="string">'public'</span>)));</span><br><span class="line">app.use(cors());</span><br><span class="line"></span><br><span class="line">app.use(<span class="string">'/'</span>, indexRouter);</span><br><span class="line">app.use(<span class="string">'/api/v1/users'</span>, usersRouter);</span><br><span class="line"></span><br><span class="line"><span class="comment">// catch 404 and forward to error handler</span></span><br><span class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  next(createError(<span class="number">404</span>));</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// error handler</span></span><br><span class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">err, req, res, next</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// set locals, only providing error in development</span></span><br><span class="line">  res.locals.message = err.message;</span><br><span class="line">  res.locals.error = req.app.get(<span class="string">'env'</span>) === <span class="string">'development'</span> ? err : &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// render the error page</span></span><br><span class="line">  res.status(err.status || <span class="number">500</span>);</span><br><span class="line">  res.render(<span class="string">'error'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = app;</span><br></pre></td></tr></table></figure>

<h4 id="客戶端-Vue-SPA"><a href="#客戶端-Vue-SPA" class="headerlink" title="客戶端 Vue SPA"></a>客戶端 Vue SPA</h4><p>客戶端的資源都放在伺服器的 public 目錄下，如果你用的是 Vue Cli 打包後的目錄 dist，可將整個 dist 目錄複製到伺服器端，然後取代掉 public 目錄下的所有資源。你可以有另外一種選擇，就是將 express 的靜態檔案服務的根目錄改為 dist 目錄，取代原先的 public 目錄。</p>
<p>以下會是客戶端完成後的目錄架構:</p>
<img src="/2019/09/18/Examples-for-Fullstack-Vue-2/public.png" title="Express Middleware">

<p>大部分的程式碼都在 public/javascripts 目錄下，components 與 views 目錄放的是 Vue 組件，services 目錄則是與後端 REST API 的連結，helpers 目錄擺放一些不好歸屬但共用的一些模組，Vue 的一些起始程式碼，index.html、main.js、router.js 與 App.vue.js 根組件直接就放在 public 目錄下。如果你使用 Vue Cli 則模組的寫法與 import 的方式會不一樣，請自行修改。</p>
<h4 id="客戶端的-REST-API-Services"><a href="#客戶端的-REST-API-Services" class="headerlink" title="客戶端的 REST API Services"></a>客戶端的 REST API Services</h4><p>首先從 helpers.js 程式碼開始:</p>
<figure class="highlight javascript"><figcaption><span>public/javascripts/helpers/helpers.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> _helpers = <span class="function">(<span class="params">(</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> config = &#123;</span><br><span class="line">    apiUrl: <span class="string">`http://<span class="subst">$&#123;location.host&#125;</span>/api/v1`</span></span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">handleResponse</span>(<span class="params">response</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> response.text().then(<span class="function"><span class="params">text</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> data = text &amp;&amp; <span class="built_in">JSON</span>.parse(text);</span><br><span class="line">      <span class="keyword">if</span> (!response.ok) &#123;</span><br><span class="line">        <span class="keyword">if</span> ([<span class="number">401</span>, <span class="number">403</span>].indexOf(response.status) !== <span class="number">-1</span>) &#123;</span><br><span class="line">          authenticationService.logout();</span><br><span class="line">          <span class="comment">//location.reload(true);</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">const</span> error = (data &amp;&amp; data.message) || response.statusText;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">Promise</span>.reject(error);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> data;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> requestOptions = &#123;</span><br><span class="line">    <span class="keyword">get</span>() &#123;</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        method: <span class="string">"GET"</span>,</span><br><span class="line">        ...headers()</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;,</span><br><span class="line">    post(body) &#123;</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        method: <span class="string">"POST"</span>,</span><br><span class="line">        ...headers(),</span><br><span class="line">        body: <span class="built_in">JSON</span>.stringify(body)</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;,</span><br><span class="line">    patch(body) &#123;</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        method: <span class="string">"PATCH"</span>,</span><br><span class="line">        ...headers(),</span><br><span class="line">        body: <span class="built_in">JSON</span>.stringify(body)</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;,</span><br><span class="line">    put(body) &#123;</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        method: <span class="string">"PUT"</span>,</span><br><span class="line">        ...headers(),</span><br><span class="line">        body: <span class="built_in">JSON</span>.stringify(body)</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="keyword">delete</span>() &#123;</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        method: <span class="string">"DELETE"</span>,</span><br><span class="line">        ...headers()</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">headers</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> currentUser = authenticationService.currentUserValue || &#123;&#125;;</span><br><span class="line">    <span class="keyword">const</span> authHeader = currentUser.token</span><br><span class="line">      ? &#123; <span class="attr">Authorization</span>: <span class="string">"Bearer "</span> + currentUser.token &#125;</span><br><span class="line">      : &#123;&#125;;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      headers: &#123;</span><br><span class="line">        ...authHeader,</span><br><span class="line">        <span class="string">"Content-Type"</span>: <span class="string">"application/json"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    config,</span><br><span class="line">    requestOptions,</span><br><span class="line">    handleResponse,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>

<p>_helpers 模組擺放的是一些使用 REST API 服務時會用到的共用程式碼，把它包裝起來讓連結 REST API 時方便一點。</p>
<p>handleResponse( ) 函式處理從 API 返回的資料，第 11 行有個 authenticationService 物件，這稍後我們會討論到。authenticationService 負責登入、登出及登入者狀態的維護，是這個範例的核心。這裡當 API 認證失敗時(Response 返回狀態是 401 或 403)會呼叫 authenticationService.logout( )，強迫使用者登出，這意味著，任何從伺服器端 API 只要返回 401 或 403 狀態，都會強迫客戶端登出，這包括不合法的 API 攫取。稍後我們會看到 logout( ) 函式作了些甚麼。</p>
<p>requestOptions 物件則會依據 HTTP 方法設定 HTTP Request 所需的一些可選的引數 (Arguments)，每個方法都會再呼叫 headers() 函式。</p>
<p>headers( ) 函式每次都會從 authenticationService.currentUserValue 取得目前的登入者(如果尚未登入則會是 null 值)，取得他們的 token，將這個 token 附在每個 HTTP Request 的 HTTP Headers 上，伺服器端才能依這個 token 給予授權的資料。這就是基本的 SPA 與 API 的認證、授權機制。</p>
<h4 id="Authentication-Service"><a href="#Authentication-Service" class="headerlink" title="Authentication Service"></a>Authentication Service</h4><p>authenticationService 是這個範例的重點，大部分的 Vue SPA 都會使用 Vuex 來實作認證機制與認證使用者的狀態管理，但在這個範例我要借用 Angular 的認證及狀態管理機制。使用的則是 <a href="https://rxjs-dev.firebaseapp.com/" target="_blank" rel="noopener">RxJS</a> 程式庫。</p>
<p>RxJS 是一個使用可觀察序列 (Observable sequences)組成<strong>異步</strong>和基於<strong>事件</strong>的程式庫。它是所有 SPA 架構的核心，不熟悉沒關係，這裡只會用到它其中的一項功能 BehaviorSubject，它很適合用來管理使用者登入狀態。</p>
<p>BehaviorSubject 是一種觀察者模式 (Observer Pattern)，基本的觀察者模式定義是:</p>
<blockquote><p><strong>定義物件(稱為主體 subject)於狀態改變時，能夠通知多個觀察者(或稱監聽者)</strong></p>
</blockquote>

<p>但 BehaviorSubject 除了在狀態改變時可以發送與監聽信息之外，它還能夠存儲當下的狀態，而不是單純的只是事件發送，也就是說如果有一個新的訂閱，我們希望主體 (Subject) 能立即給出最新狀態，而不是要等到下次的狀態改變。也因為它有存儲目前的狀態，所以也可直接取得它當下的狀態，而無須透過訂閱。</p>
<figure class="highlight javascript"><figcaption><span>public/javascripts/services/authentication.service.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> authenticationService = <span class="function">(<span class="params">(</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; BehaviorSubject &#125; = rxjs;</span><br><span class="line">  <span class="keyword">const</span> &#123; config, requestOptions, handleResponse &#125; = _helpers;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> currentUserSubject = <span class="keyword">new</span> BehaviorSubject(</span><br><span class="line">    <span class="built_in">JSON</span>.parse(localStorage.getItem(<span class="string">"currentUser"</span>))</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">login</span>(<span class="params">username, password</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> fetch(<span class="string">`<span class="subst">$&#123;config.apiUrl&#125;</span>/users/authenticate`</span>,</span><br><span class="line">      requestOptions.post(&#123; username, password &#125;)</span><br><span class="line">    ).then(handleResponse)</span><br><span class="line">     .then(<span class="function"><span class="params">user</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (user.roles &amp;&amp; <span class="built_in">Array</span>.isArray(user.roles)) &#123;</span><br><span class="line">          user.isAdmin = user.roles.indexOf(<span class="string">"admin"</span>) !== <span class="number">-1</span> ? <span class="literal">true</span> : <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        localStorage.setItem(<span class="string">"currentUser"</span>, <span class="built_in">JSON</span>.stringify(user));</span><br><span class="line">        currentUserSubject.next(user);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">      &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">logout</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    localStorage.removeItem(<span class="string">"currentUser"</span>);</span><br><span class="line">    currentUserSubject.next(<span class="literal">null</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    login,</span><br><span class="line">    logout,</span><br><span class="line">    currentUser: currentUserSubject.asObservable(),</span><br><span class="line">    <span class="keyword">get</span> currentUserValue() &#123; <span class="keyword">return</span> currentUserSubject.value; &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>

<p>因為 BehaviorSubject 會存儲當下的狀態，所已使用 BehaviorSubject 建構式創建一個 currentUserSubject 實例時，必須要給它一個初始值，這裡會從 localStorage 讀取目前登入者的資料，如果沒有登入者則會是 null 值。</p>
<p>login( ) 函式會到伺服器端 API 執行認證，如果認證失敗，先前的 handleResponse( ) 函式會攔截，並呼叫這裡的 logout( ) 函式 ( authenticationService.logout( ) ); 如果成功，則會將資料存儲到 localStorage，並呼叫 currentUserSubject.next(user) 發送( emit )使用者資料，這個使用者資料也就是 currentUserSubject 實例目前的狀態，可以使用 currentUserSubject.value 取得目前的狀態。另外則用 currentUserSubject.asObservable( ) 可以訂閱信息。</p>
<p>logout( ) 函式則很簡單，清除 localStorage currentUser 的資料，並發射一個 null 值。</p>
<p>最後將這些功能包裝成一個比較簡潔的物件，注意 currentUserValue 屬性是惟讀的。這就是這個 authenticationService 的 API。 authenticationService.currentUser 可以訂閱信息，authenticationService.currentUserValue 可以取得當下的狀態。</p>
<p>在 Vue 網頁還沒完成前，我們可以在瀏覽器 console 測試。但要記得將相關 JavaScript 檔案加入 index.html。</p>
<img src="/2019/09/18/Examples-for-Fullstack-Vue-2/auth.png" title="Express Middleware">

<p>你也可同時觀察 localStorage 的變化。你也可以訂閱它:</p>
<img src="/2019/09/18/Examples-for-Fullstack-Vue-2/auth2.png" title="Express Middleware">

<p>當你開始訂閱時，它馬上會返回當前的狀態; 當我們呼叫 logout( ) 函式，它也馬上有了回應。稍後我們就可看到如何應用在 Vue 中。</p>
<h4 id="User-Service"><a href="#User-Service" class="headerlink" title="User Service"></a>User Service</h4><p>使用者的 Service API 則很單純，這不用多解釋:</p>
<figure class="highlight javascript"><figcaption><span>public/javascripts/services/user.service.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> userService = <span class="function">(<span class="params">(</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; config, requestOptions, handleResponse &#125; = _helpers;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">getAll</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> fetch(<span class="string">`<span class="subst">$&#123;config.apiUrl&#125;</span>/users`</span>, requestOptions.get()).then(</span><br><span class="line">      handleResponse</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">getById</span>(<span class="params">id</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> fetch(<span class="string">`<span class="subst">$&#123;config.apiUrl&#125;</span>/users/<span class="subst">$&#123;id&#125;</span>`</span>, requestOptions.get()).then(</span><br><span class="line">      handleResponse</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    getAll,</span><br><span class="line">    getById</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>

<h4 id="Vue-Router-Navigation-Guards-客戶端路由保護"><a href="#Vue-Router-Navigation-Guards-客戶端路由保護" class="headerlink" title="Vue Router Navigation Guards 客戶端路由保護"></a>Vue Router Navigation Guards 客戶端路由保護</h4><p>現在先來看看如何在 Vue Router 中加入客戶端路由保護。</p>
<p>Vue Router 提供了幾個<a href="https://router.vuejs.org/guide/advanced/navigation-guards.html" target="_blank" rel="noopener">路由防護函式</a>可以讓你在路由器上加上防護(gurad)，有些是全域性的、有些是可以加在單獨路由上、有些則可以加在在組件上的。這裡我們用一個全域性的防護 router.beforeEach( ) 函式。</p>
<figure class="highlight javascript"><figcaption><span>public/router.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> VueRouter(&#123;</span><br><span class="line">  mode: <span class="string">"history"</span>,</span><br><span class="line">  routes: [</span><br><span class="line">    &#123;</span><br><span class="line">      path: <span class="string">"/"</span>,</span><br><span class="line">      name: <span class="string">"home"</span>,</span><br><span class="line">      component: HomePage</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      path: <span class="string">"/account"</span>,</span><br><span class="line">      name: <span class="string">"account"</span>,</span><br><span class="line">      component: AccountPage,</span><br><span class="line">      meta: &#123;</span><br><span class="line">        requiresAuth: <span class="literal">true</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      path: <span class="string">"/user"</span>,</span><br><span class="line">      name: <span class="string">"user"</span>,</span><br><span class="line">      component: UserPage,</span><br><span class="line">      meta: &#123;</span><br><span class="line">        requiresAuth: <span class="literal">true</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      path: <span class="string">"/login"</span>,</span><br><span class="line">      name: <span class="string">"login"</span>,</span><br><span class="line">      component: LoginPage</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      path: <span class="string">"/about"</span>,</span><br><span class="line">      name: <span class="string">"about"</span>,</span><br><span class="line">      component: AboutPage</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      path: <span class="string">"*"</span>,</span><br><span class="line">      component: PageNotFound</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.beforeEach(<span class="function">(<span class="params">to, <span class="keyword">from</span>, next</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> currentUser = authenticationService.currentUserValue;</span><br><span class="line">  <span class="keyword">const</span> requiresAuth = to.matched.some(<span class="function">(<span class="params">record</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> record.meta.requiresAuth;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (requiresAuth &amp;&amp; !currentUser) &#123;</span><br><span class="line">    next(&#123; <span class="attr">path</span>: <span class="string">"/login"</span>, <span class="attr">query</span>: &#123; <span class="attr">returnUrl</span>: to.path &#125; &#125;);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    next();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<ul>
<li><p>第 13、21 行我們在要受保護的路由上加入一個 meta 物件，你可以在 meta 物件上加入任何的資料。這裡我們只設定一個 requiresAuth 屬性，值是 true 時表示這個路由需要使用者登入。沒有設定 meta 物件或 false 則無須登入就可以拜訪此路由。</p>
</li>
<li><p>第 42 行 router.beforeEach( ) 是全域性的路由防護函式，authenticationService.currentUserValue 可以取得目前的登入者。這裡不需要使用 authenticationService.currentUser 訂閱的方式，訂閱未來的狀態變化，只需要取得目前的狀態。</p>
</li>
<li><p>第 44 行，檢查每個路由 meta 物件的 requiresAuth 屬性，看起來較複雜，主要考慮到如果使用巢狀路由，to.mata 所代表的是子組件，若在 /account 上加進 meta 物件，則使用者存取 /account/email 時，受檢查的 meta 物件所代表的是子物件，而不是父物件。要解決這個問題，可以在 to.matched 上進行迭代，其中也會包含父路由。</p>
</li>
<li><p>第 49 行，如果路由需要防護，但尚未登入，則將路由導向 /login 頁面，returnUrl 則可以讓認證成功後，重新導航回原頁面。</p>
</li>
</ul>
<h4 id="App-組件"><a href="#App-組件" class="headerlink" title="App 組件"></a>App 組件</h4><p>現在來看 App 組件的設定。</p>
<figure class="highlight javascript"><figcaption><span>public/App.vue.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> App = &#123;</span><br><span class="line">  name: <span class="string">"App"</span>,</span><br><span class="line">  components: &#123;&#125;,</span><br><span class="line">  template: <span class="string">`</span></span><br><span class="line"><span class="string">  &lt;v-app&gt;</span></span><br><span class="line"><span class="string">    &lt;v-app-bar :clipped-left="$vuetify.breakpoint.lgAndUp" app &gt;</span></span><br><span class="line"><span class="string">      &lt;v-toolbar-title class="headline ml-0 pl-4" &gt;</span></span><br><span class="line"><span class="string">        &lt;v-app-bar-nav-icon @click.stop="drawer = !drawer"&gt;&lt;/v-app-bar-nav-icon&gt;</span></span><br><span class="line"><span class="string">        &lt;span class="hidden-sm-and-down"&gt;Uni-President&lt;/span&gt;</span></span><br><span class="line"><span class="string">      &lt;/v-toolbar-title&gt;</span></span><br><span class="line"><span class="string">      &lt;div class="flex-grow-1"&gt;&lt;/div&gt;</span></span><br><span class="line"><span class="string">      &lt;v-toolbar-items&gt;</span></span><br><span class="line"><span class="string">        &lt;v-btn color="indigo" tile text to="/"&gt;</span></span><br><span class="line"><span class="string">          &lt;v-icon&gt;mdi-home&lt;/v-icon&gt;</span></span><br><span class="line"><span class="string">          &lt;span class="mr-2 green--text text--accent-4 hidden-sm-and-down"&gt;Home&lt;/span&gt;</span></span><br><span class="line"><span class="string">        &lt;/v-btn&gt;</span></span><br><span class="line"><span class="string">        &lt;v-btn color="amber" tile text to="/about"&gt;</span></span><br><span class="line"><span class="string">          &lt;v-icon&gt;mdi-information&lt;/v-icon&gt;</span></span><br><span class="line"><span class="string">          &lt;span class="mr-2 hidden-sm-and-down"&gt;About&lt;/span&gt;</span></span><br><span class="line"><span class="string">        &lt;/v-btn&gt;</span></span><br><span class="line"><span class="string">        &lt;v-menu bottom left&gt;</span></span><br><span class="line"><span class="string">          &lt;template v-slot:activator="&#123; on &#125;"&gt;</span></span><br><span class="line"><span class="string">            &lt;v-btn icon color="teal" v-on="on"&gt;</span></span><br><span class="line"><span class="string">              &lt;v-icon&gt;mdi-dots-vertical&lt;/v-icon&gt;</span></span><br><span class="line"><span class="string">            &lt;/v-btn&gt;</span></span><br><span class="line"><span class="string">          &lt;/template&gt;</span></span><br><span class="line"><span class="string">          &lt;v-list dense&gt;</span></span><br><span class="line"><span class="string">            &lt;v-list-item v-for="item in items" :key="item.title" link :to="item.to"&gt;</span></span><br><span class="line"><span class="string">              &lt;v-list-item-icon&gt;</span></span><br><span class="line"><span class="string">                &lt;v-icon&gt;&#123;&#123; item.icon &#125;&#125;&lt;/v-icon&gt;</span></span><br><span class="line"><span class="string">              &lt;/v-list-item-icon&gt;</span></span><br><span class="line"><span class="string">              &lt;v-list-item-content&gt;</span></span><br><span class="line"><span class="string">                &lt;v-list-item-title&gt;&#123;&#123; item.title &#125;&#125;&lt;/v-list-item-title&gt;</span></span><br><span class="line"><span class="string">              &lt;/v-list-item-content&gt;</span></span><br><span class="line"><span class="string">            &lt;/v-list-item&gt;</span></span><br><span class="line"><span class="string">          &lt;/v-list&gt;</span></span><br><span class="line"><span class="string">        &lt;/v-menu&gt;</span></span><br><span class="line"><span class="string">      &lt;/v-toolbar-items&gt;</span></span><br><span class="line"><span class="string">    &lt;/v-app-bar&gt;</span></span><br><span class="line"><span class="string">    &lt;v-content&gt;</span></span><br><span class="line"><span class="string">      &lt;v-container&gt;</span></span><br><span class="line"><span class="string">        &lt;router-view /&gt;</span></span><br><span class="line"><span class="string">      &lt;/v-container&gt;</span></span><br><span class="line"><span class="string">    &lt;/v-content&gt;</span></span><br><span class="line"><span class="string">    &lt;v-footer app&gt;</span></span><br><span class="line"><span class="string">      &lt;small class="grey--text"&gt;&amp;copy; 2019&lt;/small&gt;</span></span><br><span class="line"><span class="string">    &lt;/v-footer&gt;</span></span><br><span class="line"><span class="string">    &lt;v-navigation-drawer v-model="drawer" :clipped="$vuetify.breakpoint.lgAndUp" app&gt;</span></span><br><span class="line"><span class="string">      &lt;v-list-item&gt;</span></span><br><span class="line"><span class="string">        &lt;v-list-item-avatar&gt;</span></span><br><span class="line"><span class="string">          &lt;v-img src="images/pec_logo.png"&gt;&lt;/v-img&gt;</span></span><br><span class="line"><span class="string">        &lt;/v-list-item-avatar&gt;</span></span><br><span class="line"><span class="string">        &lt;v-list-item-content&gt;</span></span><br><span class="line"><span class="string">          &lt;v-list-item-title class="red--text text--darken-2"&gt;</span></span><br><span class="line"><span class="string">            Uni-President</span></span><br><span class="line"><span class="string">          &lt;/v-list-item-title&gt;</span></span><br><span class="line"><span class="string">        &lt;/v-list-item-content&gt;</span></span><br><span class="line"><span class="string">      &lt;/v-list-item&gt;</span></span><br><span class="line"><span class="string">      &lt;v-divider&gt;&lt;/v-divider&gt;</span></span><br><span class="line"><span class="string">      &lt;v-list dense&gt;</span></span><br><span class="line"><span class="string">        &lt;v-list-item v-for="item in selectedItems" :key="item.title" link :to="item.to"&gt;</span></span><br><span class="line"><span class="string">          &lt;v-list-item-icon&gt;</span></span><br><span class="line"><span class="string">            &lt;v-icon&gt;&#123;&#123; item.icon &#125;&#125;&lt;/v-icon&gt;</span></span><br><span class="line"><span class="string">          &lt;/v-list-item-icon&gt;</span></span><br><span class="line"><span class="string">          &lt;v-list-item-content&gt;</span></span><br><span class="line"><span class="string">            &lt;v-list-item-title&gt;&#123;&#123; item.title &#125;&#125;&lt;/v-list-item-title&gt;</span></span><br><span class="line"><span class="string">          &lt;/v-list-item-content&gt;</span></span><br><span class="line"><span class="string">        &lt;/v-list-item&gt;</span></span><br><span class="line"><span class="string">        &lt;v-divider class="my-3"&gt;&lt;/v-divider&gt;</span></span><br><span class="line"><span class="string">        &lt;v-list-item v-if="!currentUser" link to="/login"&gt;</span></span><br><span class="line"><span class="string">          &lt;v-list-item-icon&gt;</span></span><br><span class="line"><span class="string">            &lt;v-icon&gt;mdi-login&lt;/v-icon&gt;</span></span><br><span class="line"><span class="string">          &lt;/v-list-item-icon&gt;</span></span><br><span class="line"><span class="string">          &lt;v-list-item-content&gt;</span></span><br><span class="line"><span class="string">            &lt;v-list-item-title&gt;Login&lt;/v-list-item-title&gt;</span></span><br><span class="line"><span class="string">          &lt;/v-list-item-content&gt;</span></span><br><span class="line"><span class="string">        &lt;/v-list-item&gt;</span></span><br><span class="line"><span class="string">        &lt;v-list-item v-else @click="logout"&gt;</span></span><br><span class="line"><span class="string">          &lt;v-list-item-icon&gt;</span></span><br><span class="line"><span class="string">            &lt;v-icon&gt;mdi-logout&lt;/v-icon&gt;</span></span><br><span class="line"><span class="string">          &lt;/v-list-item-icon&gt;</span></span><br><span class="line"><span class="string">          &lt;v-list-item-content&gt;</span></span><br><span class="line"><span class="string">            &lt;v-list-item-title&gt;Logout &lt;span class="blue--text text--darken-2"&gt;(&#123;&#123; currentUser &amp;&amp; currentUser.displayName &#125;&#125;)&lt;/span&gt;&lt;/v-list-item-title&gt;</span></span><br><span class="line"><span class="string">          &lt;/v-list-item-content&gt;</span></span><br><span class="line"><span class="string">        &lt;/v-list-item&gt;</span></span><br><span class="line"><span class="string">      &lt;/v-list&gt;</span></span><br><span class="line"><span class="string">    &lt;/v-navigation-drawer&gt;</span></span><br><span class="line"><span class="string">  &lt;/v-app&gt;`</span>,</span><br><span class="line"></span><br><span class="line">  data: <span class="function"><span class="params">()</span> =&gt;</span> (&#123;</span><br><span class="line">    currentUser: <span class="literal">null</span>,</span><br><span class="line">    drawer: <span class="literal">null</span>,</span><br><span class="line">    items: [</span><br><span class="line">      &#123; <span class="attr">title</span>: <span class="string">"Home"</span>, <span class="attr">icon</span>: <span class="string">"mdi-view-dashboard"</span>, <span class="attr">to</span>: <span class="string">"/"</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">title</span>: <span class="string">"About"</span>, <span class="attr">icon</span>: <span class="string">"mdi-forum"</span>, <span class="attr">to</span>: <span class="string">"/about"</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">title</span>: <span class="string">"Account"</span>, <span class="attr">icon</span>: <span class="string">"mdi-account-card-details"</span>, <span class="attr">to</span>: <span class="string">"/account"</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">title</span>: <span class="string">"Not Exists"</span>, <span class="attr">icon</span>: <span class="string">"mdi-forum"</span>, <span class="attr">to</span>: <span class="string">"/not/exists"</span> &#125;</span><br><span class="line">    ],</span><br><span class="line">    adminItems: [</span><br><span class="line">      &#123; <span class="attr">title</span>: <span class="string">"User"</span>, <span class="attr">icon</span>: <span class="string">"mdi-account-card-details"</span>, <span class="attr">to</span>: <span class="string">"/user"</span> &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;),</span><br><span class="line">  computed: &#123;</span><br><span class="line">    selectedItems() &#123;</span><br><span class="line">      <span class="keyword">if</span> (!<span class="keyword">this</span>.currentUser || !<span class="keyword">this</span>.currentUser.isAdmin) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.items;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> [...this.items, ...this.adminItems];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  methods: &#123;</span><br><span class="line">    logout() &#123;</span><br><span class="line">      authenticationService.logout();</span><br><span class="line">      router.push(<span class="string">"/login"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  created() &#123;</span><br><span class="line">    authenticationService.currentUser.subscribe(<span class="function"><span class="params">x</span> =&gt;</span> (<span class="keyword">this</span>.currentUser = x));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>第 117 行當組件創建時，使用身份驗證服務中的 currentUser observable 訂閱信息，這可以馬上取得目前的狀態，也可以訂閱未來的狀態變化。這裡不能使用身份驗證服務中的 currentUserValue，因為 App 組件是我們的根組件，它只會創建一次，直到流覽器關掉這個 App。如果只在創建時取得現值，將無法偵測到身份驗證服務的狀態變化。基本上，當我們不使用訂閱時，應該取消它，但這裡不用擔心取消訂閱的問題，因為這個組件是應用程序的根組件，該組件被銷毀的唯一時間是 App 關閉時，這也會銷毀任何的訂閱。</p>
</li>
<li><p>logout( ) 方法，則會呼叫身份驗證服務中的 logout( )，並重新導向登錄頁面。</p>
</li>
<li><p>第 104 行的 selectedItems ，會判斷如果登入的使用者有管理者身份，會合併導航抽屜一般使用者與管理者的顯示項目。所以只有管理者身份者才會有 /user 的路由連結。</p>
</li>
<li><p>第 70、78 行有 v-if 與 v-else 可以切換不同的 Login 與 Logout 功能。</p>
</li>
</ul>
<h4 id="LoginPage-組件"><a href="#LoginPage-組件" class="headerlink" title="LoginPage 組件"></a>LoginPage 組件</h4><figure class="highlight javascript"><figcaption><span>public/javascripts/views/LoginPage.vue.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> LoginPage = &#123;</span><br><span class="line">  name: <span class="string">"LoginPage"</span>,</span><br><span class="line">  template: <span class="string">`</span></span><br><span class="line"><span class="string">  &lt;v-container class="fill-height" fluid&gt;</span></span><br><span class="line"><span class="string">    &lt;v-row align="center" justify="center"&gt;</span></span><br><span class="line"><span class="string">      &lt;v-col cols="12" sx="12" sm="8" md="4"&gt;</span></span><br><span class="line"><span class="string">        &lt;v-card class="elevation-12"&gt;</span></span><br><span class="line"><span class="string">          &lt;v-toolbar flat &gt;</span></span><br><span class="line"><span class="string">            &lt;v-img src="images/pec_logo.png" max-width="45"&gt;&lt;/v-img&gt;</span></span><br><span class="line"><span class="string">            &lt;v-toolbar-title class="red--text text--darken-2 ml-5"&gt;</span></span><br><span class="line"><span class="string">              Uni-President</span></span><br><span class="line"><span class="string">            &lt;/v-toolbar-title&gt;</span></span><br><span class="line"><span class="string">          &lt;/v-toolbar&gt;</span></span><br><span class="line"><span class="string">          &lt;v-card-text&gt;</span></span><br><span class="line"><span class="string">            &lt;v-form v-model="valid"&gt;</span></span><br><span class="line"><span class="string">              &lt;v-text-field</span></span><br><span class="line"><span class="string">                  v-model="username"</span></span><br><span class="line"><span class="string">                  :rules="[rules.required, rules.min]"</span></span><br><span class="line"><span class="string">                  label="Username"</span></span><br><span class="line"><span class="string">                  name="username"</span></span><br><span class="line"><span class="string">                  prepend-icon="mdi-account"</span></span><br><span class="line"><span class="string">                  hint="Username is required"</span></span><br><span class="line"><span class="string">              &gt;&lt;/v-text-field&gt;</span></span><br><span class="line"><span class="string">              &lt;v-text-field</span></span><br><span class="line"><span class="string">                v-model="password"</span></span><br><span class="line"><span class="string">                prepend-icon="mdi-lock"</span></span><br><span class="line"><span class="string">                :append-icon="show ? 'mdi-eye' : 'mdi-eye-off'"</span></span><br><span class="line"><span class="string">                :rules="[rules.required, rules.min]"</span></span><br><span class="line"><span class="string">                :type="show ? 'text' : 'password'"</span></span><br><span class="line"><span class="string">                name="password"</span></span><br><span class="line"><span class="string">                label="Password"</span></span><br><span class="line"><span class="string">                hint="Password is required"</span></span><br><span class="line"><span class="string">                @click:append="show = !show"</span></span><br><span class="line"><span class="string">              &gt;&lt;/v-text-field&gt;</span></span><br><span class="line"><span class="string">            &lt;/v-form&gt;</span></span><br><span class="line"><span class="string">          &lt;/v-card-text&gt;</span></span><br><span class="line"><span class="string">          &lt;v-card-actions&gt;</span></span><br><span class="line"><span class="string">            &lt;div class="flex-grow-1"&gt;&lt;/div&gt;</span></span><br><span class="line"><span class="string">            &lt;v-btn :disabled="!valid || loading"</span></span><br><span class="line"><span class="string">                   color="blue" block large</span></span><br><span class="line"><span class="string">                   @click="handleSubmit"</span></span><br><span class="line"><span class="string">            &gt;Login&lt;/v-btn&gt;</span></span><br><span class="line"><span class="string">          &lt;/v-card-actions&gt;</span></span><br><span class="line"><span class="string">        &lt;/v-card&gt;</span></span><br><span class="line"><span class="string">      &lt;/v-col&gt;</span></span><br><span class="line"><span class="string">      &lt;v-col cols="12" sx="12" sm="12" md="12"&gt;</span></span><br><span class="line"><span class="string">        &lt;v-alert v-if="error" type="error"&gt; &#123;&#123; error &#125;&#125; &lt;/v-alert&gt;</span></span><br><span class="line"><span class="string">      &lt;/v-col&gt;</span></span><br><span class="line"><span class="string">    &lt;/v-row&gt;</span></span><br><span class="line"><span class="string">  &lt;/v-container&gt;</span></span><br><span class="line"><span class="string">`</span>,</span><br><span class="line">  props: &#123;</span><br><span class="line">    source: <span class="built_in">String</span></span><br><span class="line">  &#125;,</span><br><span class="line">  data: <span class="function"><span class="params">()</span> =&gt;</span> (&#123;</span><br><span class="line">    valid: <span class="literal">true</span>,</span><br><span class="line">    show: <span class="literal">false</span>,</span><br><span class="line">    username: <span class="string">""</span>,</span><br><span class="line">    password: <span class="string">""</span>,</span><br><span class="line">    rules: &#123;</span><br><span class="line">      required: <span class="function"><span class="params">value</span> =&gt;</span> !!value || <span class="string">"Required."</span>,</span><br><span class="line">      min: <span class="function"><span class="params">v</span> =&gt;</span> v.length &gt;= <span class="number">4</span> || <span class="string">"Min 4 characters"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    loading: <span class="literal">false</span>,</span><br><span class="line">    returnUrl: <span class="string">""</span>,</span><br><span class="line">    error: <span class="string">""</span></span><br><span class="line">  &#125;),</span><br><span class="line">  created() &#123;</span><br><span class="line">    <span class="keyword">if</span> (authenticationService.currentUserValue) &#123;</span><br><span class="line">      <span class="keyword">return</span> router.push(<span class="string">"/"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.returnUrl = <span class="keyword">this</span>.$route.query.returnUrl || <span class="string">"/"</span>;</span><br><span class="line">  &#125;,</span><br><span class="line">  methods: &#123;</span><br><span class="line">    handleSubmit(e) &#123;</span><br><span class="line">      <span class="keyword">this</span>.loading = <span class="literal">true</span>;</span><br><span class="line">      authenticationService.login(<span class="keyword">this</span>.username, <span class="keyword">this</span>.password).then(</span><br><span class="line">        user =&gt; router.push(<span class="keyword">this</span>.returnUrl),</span><br><span class="line">        error =&gt; &#123;</span><br><span class="line">          <span class="keyword">this</span>.error = error;</span><br><span class="line">          <span class="keyword">this</span>.loading = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>HTML 部分主要的就是 Vuetify v-form 組件建立的，需要注意的就是它的驗正規則也可以是陣列堆疊式的。</p>
<ul>
<li><p>第 69 行當組件創建時直接抓取身份驗證服務的 currentUserValue 當下的狀態。如果已經登入了，就直接將頁面導向 Home Page。</p>
</li>
<li><p>第 73 行如果是由別的受防護的路由轉過來的，則可以在驗證成功後依據 this.$route.query.returnUrl，重新導回那個路由。</p>
</li>
<li><p>第 76 行 handleSubmit( ) 呼叫身份驗證服務的 login( ) ，認證成功則將頁面導向原頁面或 Home Page。</p>
</li>
</ul>
<h4 id="UserPage-組件"><a href="#UserPage-組件" class="headerlink" title="UserPage 組件"></a>UserPage 組件</h4><p>這個組件只有登入的使用者有管理者身份才會顯示在 App 組件的導航抽屜(navigation-drawer)，但是我們在路由的防護設定只有針對有沒有登入作防護，並沒有針對何種身分作防護，所以如果你已經登入，不管是甚麼身份，仍然可以直接從流覽器上輸入網址 <a href="http://localhost:3000/user" target="_blank" rel="noopener">http://localhost:3000/user</a> 重載拜訪這個組件，所以我們也應該在此組件上再多一層防護。</p>
<p>另外一種選擇則可以在路由器上加上身份的防護，例如，在 meta 物件加上防護資訊:</p>
<figure class="highlight javascript"><figcaption><span>public/router.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  path: <span class="string">"/user"</span>,</span><br><span class="line">  name: <span class="string">"user"</span>,</span><br><span class="line">  component: UserPage,</span><br><span class="line">  meta: &#123;</span><br><span class="line">    requiresRole: <span class="string">'admin'</span> </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>你可以在身份驗證服務的 currentUserValue 取到相關角色 (roles) 的資訊，然後修改 router.beforeEach( ) 路由防護規則。 </p>
<p>這個組件有一個子組件 ListUsers.vue.js 組件，只有有管理者身份者才能看到所有使用者的資料。</p>
<figure class="highlight javascript"><figcaption><span>public/javascripts/components/ListUsers.vue.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">Vue.component(<span class="string">"ListUsers"</span>, &#123;</span><br><span class="line">  template: <span class="string">`</span></span><br><span class="line"><span class="string">  &lt;div&gt;</span></span><br><span class="line"><span class="string">    &lt;div if="currentUser &amp;&amp; currentUser.isAdmin"&gt;</span></span><br><span class="line"><span class="string">      &lt;v-card class="mx-auto" max-width="344" tile &gt;</span></span><br><span class="line"><span class="string">        &lt;v-list dense&gt;</span></span><br><span class="line"><span class="string">          &lt;v-subheader class="title teal--text text--darken-1"&gt;Users&lt;/v-subheader&gt;</span></span><br><span class="line"><span class="string">          &lt;em v-if="users.loading"&gt;Loading users...&lt;/em&gt;</span></span><br><span class="line"><span class="string">          &lt;span v-if="users.error" class="red--text"&gt;ERROR: &#123;&#123; users.error &#125;&#125;&lt;/span&gt;</span></span><br><span class="line"><span class="string">          &lt;v-list-item-group color="primary"&gt;</span></span><br><span class="line"><span class="string">            &lt;v-list-item  v-for="item in users.items" :key="item.displayName" &gt;</span></span><br><span class="line"><span class="string">               &lt;v-list-item-icon&gt;</span></span><br><span class="line"><span class="string">                &lt;v-icon color="blue" v-text="'mdi-account'"&gt;&lt;/v-icon&gt;</span></span><br><span class="line"><span class="string">              &lt;/v-list-item-icon&gt;</span></span><br><span class="line"><span class="string">              &lt;v-list-item-content&gt;</span></span><br><span class="line"><span class="string">                &lt;v-list-item-title v-text="item.displayName"&gt;&lt;/v-list-item-title&gt;</span></span><br><span class="line"><span class="string">              &lt;/v-list-item-content&gt;</span></span><br><span class="line"><span class="string">            &lt;/v-list-item&gt;</span></span><br><span class="line"><span class="string">          &lt;/v-list-item-group&gt;</span></span><br><span class="line"><span class="string">        &lt;/v-list&gt;</span></span><br><span class="line"><span class="string">      &lt;/v-card&gt;</span></span><br><span class="line"><span class="string">    &lt;/div&gt;</span></span><br><span class="line"><span class="string">  &lt;/div&gt;`</span>,</span><br><span class="line"></span><br><span class="line">  data: <span class="function"><span class="params">()</span> =&gt;</span> (&#123;</span><br><span class="line">    currentUser: authenticationService.currentUserValue,</span><br><span class="line">    users: [],</span><br><span class="line">  &#125;),</span><br><span class="line">  created() &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.currentUser &amp;&amp; <span class="keyword">this</span>.currentUser.isAdmin) &#123;</span><br><span class="line">      userService.getAll().then(<span class="function"><span class="params">users</span> =&gt;</span> <span class="keyword">this</span>.users = users);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>除了第 4 行對 HTML 保護外，也在第 30 行對資料作了保護。這裡要提醒一下，看看我在 if 中的測試規則 <strong>if ( this.currentUser &amp;&amp; this.currentUser.isAdmin )</strong> {…} 要對一個物件的屬性作測試，先要測試這個物件是否存在，否則你的臭蟲會抓不完。</p>
<p>以下則是 UserPage 父組件:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> UserPage = &#123;</span><br><span class="line">  name: <span class="string">"UserPage"</span>,</span><br><span class="line">  template: <span class="string">`</span></span><br><span class="line"><span class="string">  &lt;div&gt;</span></span><br><span class="line"><span class="string">    &lt;v-row&gt;</span></span><br><span class="line"><span class="string">      &lt;v-col&gt;</span></span><br><span class="line"><span class="string">        &lt;v-card max-width="344" class="mx-auto"&gt;</span></span><br><span class="line"><span class="string">          &lt;v-card-title&gt;I'm &#123;&#123; currentUser &amp;&amp; currentUser.displayName &#125;&#125;&lt;/v-card-title&gt;</span></span><br><span class="line"><span class="string">          &lt;v-card-text&gt;Some text&lt;/v-card-text&gt;</span></span><br><span class="line"><span class="string">        &lt;/v-card&gt;</span></span><br><span class="line"><span class="string">      &lt;/v-col&gt;</span></span><br><span class="line"><span class="string">      &lt;v-col v-if="currentUser &amp;&amp; currentUser.isAdmin"&gt;</span></span><br><span class="line"><span class="string">        &lt;ListUsers /&gt;</span></span><br><span class="line"><span class="string">      &lt;/v-col&gt;</span></span><br><span class="line"><span class="string">    &lt;/v-row&gt;</span></span><br><span class="line"><span class="string">  &lt;/div&gt;`</span>,</span><br><span class="line">  data: <span class="function"><span class="params">()</span> =&gt;</span> (&#123;</span><br><span class="line">    currentUser: authenticationService.currentUserValue</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>這個組件中有兩個 v-col 元素，一個有身份防護，一個沒有。但是你應該會發覺，在客戶端的這些防護其實都是很脆弱的，客戶端很容易就可被竄改，所以伺服器端的資料防護才是重要。在我們的範例，即使你竄改了客戶端的身份，你仍然無法取得伺服器端 API 的資料，伺服器端的資料保護就依賴在我們的 Token，所以要好好保護你的 Token，至少不要發出一個沒有期限的 Token。資料安全是一個大主題，目前的範例只是一個基本機制。</p>
<p>AccountPage 組件與 UserPage 組件一模一樣。只是在展示不同的身份會有不同的內容。</p>
<p>最後的 index.html 則如下:</p>
<figure class="highlight javascript"><figcaption><span>public/index.html</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">  &lt;link href=<span class="string">"https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900"</span> rel=<span class="string">"stylesheet"</span>&gt;</span><br><span class="line">  &lt;link href=<span class="string">"stylesheets/@mdi/font/css/materialdesignicons.min.css"</span> rel=<span class="string">"stylesheet"</span> /&gt;</span><br><span class="line">  &lt;link href=<span class="string">"stylesheets/vuetify.min.css"</span> rel=<span class="string">"stylesheet"</span> /&gt;</span><br><span class="line">  &lt;meta name=<span class="string">"viewport"</span> content=<span class="string">"width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui"</span>&gt;</span><br><span class="line">  &lt;style&gt;</span><br><span class="line">  [v-cloak] &#123;</span><br><span class="line">    display: none;</span><br><span class="line">  &#125;</span><br><span class="line">&lt;<span class="regexp">/style&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">  &lt;div id=<span class="string">"app"</span> v-cloak&gt;&lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">  &lt;script src="libs/</span>vue.js<span class="string">"&gt;&lt;/script&gt;</span></span><br><span class="line"><span class="string">  &lt;script src="</span>libs/vuetify.js<span class="string">"&gt;&lt;/script&gt;</span></span><br><span class="line"><span class="string">  &lt;script src="</span>libs/vue-router.js<span class="string">"&gt;&lt;/script&gt;</span></span><br><span class="line"><span class="string">  &lt;script src="</span>libs/rxjs.umd.min.js<span class="string">"&gt;&lt;/script&gt;</span></span><br><span class="line"><span class="string">  &lt;script src="</span>javascripts/views/HomePage.vue.js<span class="string">"&gt;&lt;/script&gt;</span></span><br><span class="line"><span class="string">  &lt;script src="</span>javascripts/views/LoginPage.vue.js<span class="string">"&gt;&lt;/script&gt;</span></span><br><span class="line"><span class="string">  &lt;script src="</span>javascripts/views/AboutPage.vue.js<span class="string">"&gt;&lt;/script&gt;</span></span><br><span class="line"><span class="string">  &lt;script src="</span>javascripts/components/ListUsers.vue.js<span class="string">"&gt;&lt;/script&gt;</span></span><br><span class="line"><span class="string">  &lt;script src="</span>javascripts/views/AccountPage.vue.js<span class="string">"&gt;&lt;/script&gt;</span></span><br><span class="line"><span class="string">  &lt;script src="</span>javascripts/views/UserPage.vue.js<span class="string">"&gt;&lt;/script&gt;</span></span><br><span class="line"><span class="string">  &lt;script src="</span>javascripts/views/PageNotFound.vue.js<span class="string">"&gt;&lt;/script&gt;</span></span><br><span class="line"><span class="string">  &lt;script src="</span>javascripts/helpers/helpers.js<span class="string">"&gt;&lt;/script&gt;</span></span><br><span class="line"><span class="string">  &lt;script src="</span>javascripts/services/authentication.service.js<span class="string">"&gt;&lt;/script&gt;</span></span><br><span class="line"><span class="string">  &lt;script src="</span>javascripts/services/user.service.js<span class="string">"&gt;&lt;/script&gt;</span></span><br><span class="line"><span class="string">  &lt;script src="</span>App.vue.js<span class="string">"&gt;&lt;/script&gt;</span></span><br><span class="line"><span class="string">  &lt;script src="</span>router.js<span class="string">"&gt;&lt;/script&gt;</span></span><br><span class="line"><span class="string">  &lt;script src="</span>main.js<span class="string">"&gt;&lt;/script&gt;</span></span><br><span class="line"><span class="string">&lt;/body&gt;</span></span><br><span class="line"><span class="string">&lt;/html&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="祝-身體健康、快樂"><a href="#祝-身體健康、快樂" class="headerlink" title="祝 身體健康、快樂!"></a>祝 身體健康、快樂!</h4>
    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2019/09/09/Examples-for-Fullstack-Vue-1/" rel="prev" title="Fullstack Vue 實作範例 (1)">
      <i class="fa fa-chevron-left"></i> Fullstack Vue 實作範例 (1)
    </a></div>
      <div class="post-nav-item">
    <a href="/2019/10/05/Vue-Fullstack-Sample/" rel="next" title="Vue Fullstack 框架範本">
      Vue Fullstack 框架範本 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目錄
        </li>
        <li class="sidebar-nav-overview">
          本站概要
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#原始碼"><span class="nav-number">1.</span> <span class="nav-text">原始碼</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#實作細節"><span class="nav-number">2.</span> <span class="nav-text">實作細節</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#伺服器端"><span class="nav-number">3.</span> <span class="nav-text">伺服器端</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#HTML5-歷史模式"><span class="nav-number">3.1.</span> <span class="nav-text">HTML5 歷史模式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#伺服器端身份驗證-API"><span class="nav-number">3.2.</span> <span class="nav-text">伺服器端身份驗證 API</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Express-中間件-Middleware"><span class="nav-number">3.3.</span> <span class="nav-text">Express 中間件 (Middleware)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Authorize-middleware"><span class="nav-number">3.4.</span> <span class="nav-text">Authorize middleware</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Users-service"><span class="nav-number">3.5.</span> <span class="nav-text">Users service</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#客戶端-Vue-SPA"><span class="nav-number">3.6.</span> <span class="nav-text">客戶端 Vue SPA</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#客戶端的-REST-API-Services"><span class="nav-number">3.7.</span> <span class="nav-text">客戶端的 REST API Services</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Authentication-Service"><span class="nav-number">3.8.</span> <span class="nav-text">Authentication Service</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#User-Service"><span class="nav-number">3.9.</span> <span class="nav-text">User Service</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Vue-Router-Navigation-Guards-客戶端路由保護"><span class="nav-number">3.10.</span> <span class="nav-text">Vue Router Navigation Guards 客戶端路由保護</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#App-組件"><span class="nav-number">3.11.</span> <span class="nav-text">App 組件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#LoginPage-組件"><span class="nav-number">3.12.</span> <span class="nav-text">LoginPage 組件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#UserPage-組件"><span class="nav-number">3.13.</span> <span class="nav-text">UserPage 組件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#祝-身體健康、快樂"><span class="nav-number">3.14.</span> <span class="nav-text">祝 身體健康、快樂!</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="J.Y. Yang"
      src="/images/1184yang.jpg">
  <p class="site-author-name" itemprop="name">J.Y. Yang</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">62</span>
          <span class="site-state-item-name">文章</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">分類</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/1184yang" title="GitHub → https://github.com/1184yang" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:1184yang@gmail.com" title="E-Mail → mailto:1184yang@gmail.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/1184yang" title="Twitter → https://twitter.com/1184yang" rel="noopener" target="_blank"><i class="fa fa-fw fa-twitter"></i>Twitter</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">J.Y. Yang</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/muse.js"></script>
<script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script>



  




  <script src="/js/local-search.js"></script>












  

  

</body>
</html>
